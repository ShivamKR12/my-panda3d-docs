\doxysection{angular\+Euler\+Integrator.\+cxx}
\hypertarget{angularEulerIntegrator_8cxx_source}{}\label{angularEulerIntegrator_8cxx_source}\index{panda/src/physics/angularEulerIntegrator.cxx@{panda/src/physics/angularEulerIntegrator.cxx}}
\mbox{\hyperlink{angularEulerIntegrator_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{angularEulerIntegrator_8h}{angularEulerIntegrator.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{forceNode_8h}{forceNode.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{physicalNode_8h}{physicalNode.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__physics_8h}{config\_physics.h}}"{}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00022\ AngularEulerIntegrator::}
\DoxyCodeLine{00023\ AngularEulerIntegrator()\ \{}
\DoxyCodeLine{00024\ \}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ AngularEulerIntegrator::}
\DoxyCodeLine{00030\ \string~AngularEulerIntegrator()\ \{}
\DoxyCodeLine{00031\ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00037\ \textcolor{keywordtype}{void}\ AngularEulerIntegrator::}
\DoxyCodeLine{00038\ child\_integrate(\mbox{\hyperlink{classPhysical}{Physical}}\ *physical,}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ AngularForceVector\&\ forces,}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ dt)\ \{}
\DoxyCodeLine{00041\ \ \ \textcolor{comment}{//\ Loop\ through\ each\ object\ in\ the\ set.\ \ This\ processing\ occurs\ in\ O(pf)}}
\DoxyCodeLine{00042\ \ \ \textcolor{comment}{//\ time,\ where\ p\ is\ the\ number\ of\ physical\ objects\ and\ f\ is\ the\ number\ of}}
\DoxyCodeLine{00043\ \ \ \textcolor{comment}{//\ forces.\ \ Unfortunately,\ no\ precomputation\ of\ forces\ can\ occur,\ as\ each}}
\DoxyCodeLine{00044\ \ \ \textcolor{comment}{//\ force\ is\ possibly\ contingent\ on\ such\ things\ as\ the\ position\ and\ velocity}}
\DoxyCodeLine{00045\ \ \ \textcolor{comment}{//\ of\ each\ physicsobject\ in\ the\ set.\ \ Accordingly,\ we\ have\ to\ grunt\ our\ way}}
\DoxyCodeLine{00046\ \ \ \textcolor{comment}{//\ through\ each\ one.\ \ wrt\ caching\ of\ the\ xform\ matrix\ should\ help.}}
\DoxyCodeLine{00047\ \ \ PhysicsObject::Vector::const\_iterator\ current\_object\_iter;}
\DoxyCodeLine{00048\ \ \ current\_object\_iter\ =\ physical-\/>get\_object\_vector().begin();}
\DoxyCodeLine{00049\ \ \ \textcolor{keywordflow}{for}\ (;\ current\_object\_iter\ !=\ physical-\/>get\_object\_vector().end();}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ ++current\_object\_iter)\ \{}
\DoxyCodeLine{00051\ \ \ \ \ \mbox{\hyperlink{classPhysicsObject}{PhysicsObject}}\ *current\_object\ =\ *current\_object\_iter;}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ bail\ out\ if\ this\ object\ doesn't\ exist\ or\ doesn't\ want\ to\ be\ processed.}}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_object\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00056\ \ \ \ \ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_object-\/>get\_active()\ ==\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00060\ \ \ \ \ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \ \ LRotation\ accum\_quat(0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{comment}{//\ set\ up\ the\ traversal\ stuff.}}
\DoxyCodeLine{00065\ \ \ \ \ AngularForceVector::const\_iterator\ f\_cur;}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ LRotation\ f;}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{comment}{//\ global\ forces}}
\DoxyCodeLine{00070\ \ \ \ \ f\_cur\ =\ forces.begin();}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ unsigned\ int\ index\ =\ 0;}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ f\_cur\ !=\ forces.end();\ ++f\_cur)\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \mbox{\hyperlink{classAngularForce}{AngularForce}}\ *cur\_force\ =\ *f\_cur;}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{comment}{//\ make\ sure\ the\ force\ is\ turned\ on.}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cur\_force-\/>get\_active()\ ==\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \ \ \ \ \textcolor{comment}{//\ tally\ it\ into\ the\ accumulation\ quaternion}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ f\ =\ cur\_force-\/>get\_quat(current\_object);}
\DoxyCodeLine{00082\ \ \ \ \ \ \ accum\_quat\ +=\ f;}
\DoxyCodeLine{00083\ \ \ \ \ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ LOrientation\ orientation\ =\ current\_object-\/>get\_orientation();}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{comment}{//\ local\ forces}}
\DoxyCodeLine{00087\ \ \ \ \ f\_cur\ =\ physical-\/>get\_angular\_forces().begin();}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ f\_cur\ !=\ physical-\/>get\_angular\_forces().end();\ ++f\_cur)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \mbox{\hyperlink{classAngularForce}{AngularForce}}\ *cur\_force\ =\ *f\_cur;}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \ \ \textcolor{comment}{//\ make\ sure\ the\ force\ is\ turned\ on.}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cur\_force-\/>get\_active()\ ==\ \textcolor{keyword}{false})\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \ \ f\ =\ cur\_force-\/>get\_quat(current\_object);}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{comment}{//\ tally\ it\ into\ the\ accumulation\ quaternion\ i.e.\ \ orientation\ *\ f\ *}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \textcolor{comment}{//\ orientation.conjugate()}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ accum\_quat\ +=\ orientation.xform(f);}
\DoxyCodeLine{00101\ \ \ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{comment}{//\ apply\ the\ accumulated\ torque\ vector\ to\ the\ object's\ inertial\ tensor.}}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{comment}{//\ this\ matrix\ represents\ how\ much\ force\ the\ object\ 'wants'\ applied\ to\ it}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{comment}{//\ in\ any\ direction,\ among\ other\ things.}}
\DoxyCodeLine{00106\ \ \ \ \ accum\_quat\ =\ LRotation(current\_object-\/>\mbox{\hyperlink{classPhysicsObject_a3192e2674c201e5fdbf865c699ac567b}{get\_inertial\_tensor}}())\ *\ accum\_quat;}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{comment}{//\ derive\ this\ into\ the\ angular\ velocity\ vector.}}
\DoxyCodeLine{00109\ \ \ \ \ LRotation\ rot\_quat\ =\ current\_object-\/>get\_rotation();}
\DoxyCodeLine{00110\ \textcolor{preprocessor}{\ \ \ \ \#if\ 0}}
\DoxyCodeLine{00111\ \ \ \ \ rot\_quat\ +=\ accum\_quat\ *\ dt;}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{if}\ (rot\_quat.normalize())\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ LOrientation\ old\_orientation\ =\ current\_object-\/>get\_orientation();}
\DoxyCodeLine{00115\ \ \ \ \ \ \ LOrientation\ new\_orientation\ =\ old\_orientation\ *\ rot\_quat;}
\DoxyCodeLine{00116\ \ \ \ \ \ \ new\_orientation.normalize();}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \ \ \textcolor{comment}{//\ and\ write\ the\ results\ back.}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ current\_object-\/>set\_orientation(new\_orientation);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ current\_object-\/>set\_rotation(rot\_quat);}
\DoxyCodeLine{00121\ \ \ \ \ \}}
\DoxyCodeLine{00122\ \textcolor{preprocessor}{\ \ \ \ \#else}}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{//\ accum\_quat*=viscosityDamper;\ LOrientation\ orientation\ =}}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ current\_object-\/>get\_orientation();}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{comment}{//\ accum\_quat.normalize();\ x\ =\ x\ +\ v\ *\ t\ +\ 0.5\ *\ a\ *\ t\ *\ t}}
\DoxyCodeLine{00127\ \ \ \ \ orientation\ =\ orientation\ *\ ((rot\_quat\ *\ dt)\ *\ (accum\_quat\ *\ (0.5\ *\ dt\ *\ dt)));}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{comment}{//\ v\ =\ v\ +\ a\ *\ t}}
\DoxyCodeLine{00129\ \ \ \ \ rot\_quat\ =\ rot\_quat\ +\ (accum\_quat\ *\ dt);}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{comment}{//\ if\ (rot\_quat.normalize())\ \{}}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordflow}{if}\ (orientation.normalize()\ \&\&\ rot\_quat.normalize())\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \textcolor{comment}{//\ and\ write\ the\ results\ back.}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ current\_object-\/>set\_orientation(orientation);}
\DoxyCodeLine{00135\ \ \ \ \ \ \ current\_object-\/>set\_rotation(rot\_quat);}
\DoxyCodeLine{00136\ \ \ \ \ \}}
\DoxyCodeLine{00137\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00144\ \textcolor{keywordtype}{void}\ AngularEulerIntegrator::}
\DoxyCodeLine{00145\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00146\ \textcolor{preprocessor}{\ \ \#ifndef\ NDEBUG\ }\textcolor{comment}{//[}}
\DoxyCodeLine{00147\ \ \ out<<\textcolor{stringliteral}{"{}AngularEulerIntegrator\ (id\ "{}}<<\textcolor{keyword}{this}<<\textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{00148\ \textcolor{preprocessor}{\ \ \#endif\ }\textcolor{comment}{//]\ NDEBUG}}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00154\ \textcolor{keywordtype}{void}\ AngularEulerIntegrator::}
\DoxyCodeLine{00155\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00156\ \textcolor{preprocessor}{\ \ \#ifndef\ NDEBUG\ }\textcolor{comment}{//[}}
\DoxyCodeLine{00157\ \ \ out.width(\mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}});\ out<<\textcolor{stringliteral}{"{}"{}};\ out<<\textcolor{stringliteral}{"{}AngularEulerIntegrator:\(\backslash\)n"{}};}
\DoxyCodeLine{00158\ \ \ \mbox{\hyperlink{classAngularIntegrator_a63559e4526497e02fd621f44c20ff337}{AngularIntegrator::write}}(out,\ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}+2);}
\DoxyCodeLine{00159\ \textcolor{preprocessor}{\ \ \#endif\ }\textcolor{comment}{//]\ NDEBUG}}
\DoxyCodeLine{00160\ \}}

\end{DoxyCode}
