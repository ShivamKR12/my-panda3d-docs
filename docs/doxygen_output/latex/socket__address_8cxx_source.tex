\doxysection{socket\+\_\+address.\+cxx}
\hypertarget{socket__address_8cxx_source}{}\label{socket__address_8cxx_source}\index{panda/src/nativenet/socket\_address.cxx@{panda/src/nativenet/socket\_address.cxx}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{socket__address_8h}{socket\_address.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__downloader_8h}{config\_downloader.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{comment}{//\ For\ some\ reason\ in\ msys\ those\ two\ macros\ are\ not\ defined\ correctly\ in\ the}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ header\ file\ ws2tcpip.h}}
\DoxyCodeLine{00019\ \textcolor{comment}{//\ Also,\ those\ lines\ will\ be\ removed\ when\ the\ engine\ change}}
\DoxyCodeLine{00020\ \textcolor{comment}{//\ \_WIN32\_WINNT\ to\ 0x0600}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#ifndef\ AI\_ADDRCONFIG}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#define\ AI\_ADDRCONFIG\ 0x00000400}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00030\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classSocket__Address_a2cf1d05811e7a4d2e70951bc61988c3d}{Socket\_Address::}}}
\DoxyCodeLine{00031\ \mbox{\hyperlink{classSocket__Address_a2cf1d05811e7a4d2e70951bc61988c3d}{set\_host}}(\textcolor{keyword}{const}\ std::string\ \&hostname,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ port)\ \{}
\DoxyCodeLine{00032\ \ \ \textcolor{comment}{//\ hmm\ inet\_addr4\ does\ not\ resolve\ 255.255.255.255\ on\ ME98\ ??\ *\ HACK\ *\ ??}}
\DoxyCodeLine{00033\ \ \ \textcolor{keywordflow}{if}\ (hostname\ ==\ \textcolor{stringliteral}{"{}255.255.255.255"{}})\ \{}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keywordflow}{return}\ set\_broadcast(port);}
\DoxyCodeLine{00035\ \ \ \}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \ \ \textcolor{keyword}{struct\ }addrinfo\ hints,\ *res\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00038\ \ \ memset(\&hints,\ 0,\ \textcolor{keyword}{sizeof}(hints));}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ hints.ai\_flags\ =\ AI\_ADDRCONFIG;}
\DoxyCodeLine{00042\ \ \ hints.ai\_family\ =\ support\_ipv6\ ?\ AF\_UNSPEC\ :\ AF\_INET;}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \textcolor{keywordflow}{if}\ (getaddrinfo(hostname.c\_str(),\ \textcolor{keyword}{nullptr},\ \&hints,\ \&res))\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00046\ \ \ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ nassertr(res-\/>ai\_addrlen\ <=\ \textcolor{keyword}{sizeof}(\_storage),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00049\ \ \ memcpy(\&\_storage,\ res-\/>ai\_addr,\ res-\/>ai\_addrlen);}
\DoxyCodeLine{00050\ \ \ freeaddrinfo(res);}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \_addr4.sin\_port\ =\ htons(port);}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00060\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classSocket__Address_a2cf1d05811e7a4d2e70951bc61988c3d}{Socket\_Address::}}}
\DoxyCodeLine{00061\ \mbox{\hyperlink{classSocket__Address_a2cf1d05811e7a4d2e70951bc61988c3d}{set\_host}}(\textcolor{keyword}{const}\ std::string\ \&hostname)\ \{}
\DoxyCodeLine{00062\ \ \ std::string::size\_type\ pos\ =\ hostname.rfind(\textcolor{charliteral}{':'});}
\DoxyCodeLine{00063\ \ \ \textcolor{keywordflow}{if}\ (pos\ ==\ std::string::npos)\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00065\ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ std::string::size\_type\ host\_begin\ =\ 0;}
\DoxyCodeLine{00068\ \ \ std::string::size\_type\ host\_end\ =\ pos;}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{comment}{//\ Strip\ spaces.}}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{while}\ (host\_begin\ <\ host\_end\ \&\&\ isspace(hostname[host\_begin]))\ \{}
\DoxyCodeLine{00072\ \ \ \ \ ++host\_begin;}
\DoxyCodeLine{00073\ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{keywordflow}{while}\ (host\_begin\ <\ host\_end\ \&\&\ isspace(hostname[host\_end\ -\/\ 1]))\ \{}
\DoxyCodeLine{00076\ \ \ \ \ -\/-\/host\_end;}
\DoxyCodeLine{00077\ \ \ \}}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \textcolor{keywordflow}{if}\ (host\_begin\ <\ host\_end\ \&\&\ hostname[host\_begin]\ ==\ \textcolor{charliteral}{'['})\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{comment}{//\ Looks\ like\ an\ IPv6\ address;\ extract\ from\ the\ brackets.}}
\DoxyCodeLine{00081\ \ \ \ \ host\_begin\ +=\ 1;}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordflow}{if}\ (hostname[host\_end\ -\/\ 1]\ ==\ \textcolor{charliteral}{']'})\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ host\_end\ -\/=\ 1;}
\DoxyCodeLine{00084\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00086\ \ \ \ \ \}}
\DoxyCodeLine{00087\ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ std::string\ host\ =\ hostname.substr(host\_begin,\ host\_end\ -\/\ host\_begin);}
\DoxyCodeLine{00090\ \ \ std::string\ port\ =\ hostname.substr(pos\ +\ 1,\ 100);}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{short}\ port\_dig\ =\ (\textcolor{keywordtype}{unsigned}\ short)atoi(port.c\_str());}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classSocket__Address_a2cf1d05811e7a4d2e70951bc61988c3d}{set\_host}}(host,\ port\_dig);}
\DoxyCodeLine{00094\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00099\ std::string\ \mbox{\hyperlink{classSocket__Address_a5f84fb1918e64fca991cbee6acbc7465}{Socket\_Address::}}}
\DoxyCodeLine{00100\ \mbox{\hyperlink{classSocket__Address_a5f84fb1918e64fca991cbee6acbc7465}{get\_ip}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordtype}{char}\ buf[48];}
\DoxyCodeLine{00102\ \ \ buf[0]\ =\ 0;}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \textcolor{keywordflow}{if}\ (\_storage.ss\_family\ ==\ AF\_INET)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ getnameinfo(\&\_addr,\ \textcolor{keyword}{sizeof}(sockaddr\_in),\ buf,\ \textcolor{keyword}{sizeof}(buf),\ \textcolor{keyword}{nullptr},\ 0,\ NI\_NUMERICHOST);}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_storage.ss\_family\ ==\ AF\_INET6)\ \{}
\DoxyCodeLine{00108\ \ \ \ \ getnameinfo(\&\_addr,\ \textcolor{keyword}{sizeof}(sockaddr\_in6),\ buf,\ \textcolor{keyword}{sizeof}(buf),\ \textcolor{keyword}{nullptr},\ 0,\ NI\_NUMERICHOST);}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00111\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}unsupported\ address\ family"{}});}
\DoxyCodeLine{00112\ \ \ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \textcolor{keywordflow}{return}\ std::string(buf);}
\DoxyCodeLine{00115\ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00121\ std::string\ \mbox{\hyperlink{classSocket__Address_a9736eabe64340ce30fd1b2bfedb75b2e}{Socket\_Address::}}}
\DoxyCodeLine{00122\ \mbox{\hyperlink{classSocket__Address_a9736eabe64340ce30fd1b2bfedb75b2e}{get\_ip\_port}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00123\ \ \ \textcolor{keywordtype}{char}\ buf[100];\ \ \textcolor{comment}{//\ 100\ is\ more\ than\ enough\ for\ any\ ip\ address:port\ combo..}}
\DoxyCodeLine{00124\ \ \ buf[0]\ =\ 0;}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \textcolor{keywordflow}{if}\ (\_storage.ss\_family\ ==\ AF\_INET)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ getnameinfo(\&\_addr,\ \textcolor{keyword}{sizeof}(sockaddr\_in),\ buf,\ \textcolor{keyword}{sizeof}(buf),\ \textcolor{keyword}{nullptr},\ 0,\ NI\_NUMERICHOST);}
\DoxyCodeLine{00128\ \ \ \ \ sprintf(buf\ +\ strlen(buf),\ \textcolor{stringliteral}{"{}:\%hu"{}},\ get\_port());}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_storage.ss\_family\ ==\ AF\_INET6)\ \{}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{comment}{//\ Protect\ the\ IPv6\ address\ within\ square\ brackets.}}
\DoxyCodeLine{00132\ \ \ \ \ buf[0]\ =\ \textcolor{charliteral}{'['};}
\DoxyCodeLine{00133\ \ \ \ \ getnameinfo(\&\_addr,\ \textcolor{keyword}{sizeof}(sockaddr\_in6),\ buf\ +\ 1,\ \textcolor{keyword}{sizeof}(buf)\ -\/\ 1,\ \textcolor{keyword}{nullptr},\ 0,\ NI\_NUMERICHOST);}
\DoxyCodeLine{00134\ \ \ \ \ sprintf(buf\ +\ strlen(buf),\ \textcolor{stringliteral}{"{}]:\%hu"{}},\ get\_port());}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00137\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}unsupported\ address\ family"{}});}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{return}\ std::string(buf);}
\DoxyCodeLine{00141\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00147\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \mbox{\hyperlink{classSocket__Address_a77c247b70def613070abcc69fb8ce429}{Socket\_Address::}}}
\DoxyCodeLine{00148\ \mbox{\hyperlink{classSocket__Address_a77c247b70def613070abcc69fb8ce429}{GetIPAddressRaw}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{if}\ (\_addr.sa\_family\ ==\ AF\_INET)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keywordflow}{return}\ \_addr4.sin\_addr.s\_addr;}
\DoxyCodeLine{00151\ \ \ \}}
\DoxyCodeLine{00152\ \ \ \textcolor{keywordflow}{if}\ (\_addr.sa\_family\ ==\ AF\_INET6)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{comment}{//\ Okay,\ if\ we\ got\ here,\ something\ probably\ went\ wrong,\ but\ let's\ see\ if}}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{comment}{//\ we\ can\ offer\ a\ meaningful\ translation\ for\ mapped\ addresses.}}
\DoxyCodeLine{00155\ \ \ \ \ uint32\_t\ *parts\ =\ (uint32\_t\ *)\&\_addr6.sin6\_addr;}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{if}\ (parts[0]\ ==\ 0\ \&\&\ parts[1]\ ==\ 0\ \&\&\ (parts[2]\ ==\ 0\ ||\ parts[2]\ ==\ htonl(0xffff)))\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parts[2]\ ==\ 0\ \&\&\ parts[3]\ ==\ htonl(1))\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Special\ exception\ for\ localhost.}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0x1000007f;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ parts[3];}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ \ \ \}}
\DoxyCodeLine{00165\ \ \ nassert\_raise(\textcolor{stringliteral}{"{}GetIPAddressRaw()\ can\ only\ be\ called\ on\ an\ IPv4\ address"{}});}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00167\ \}}

\end{DoxyCode}
