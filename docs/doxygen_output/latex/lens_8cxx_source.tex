\doxysection{lens.\+cxx}
\hypertarget{lens_8cxx_source}{}\label{lens_8cxx_source}\index{panda/src/gobj/lens.cxx@{panda/src/gobj/lens.cxx}}
\mbox{\hyperlink{lens_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lens_8h}{lens.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{throw__event_8h}{throw\_event.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{compose__matrix_8h}{compose\_matrix.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{look__at_8h}{look\_at.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomLinestrips_8h}{geomLinestrips.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingHexahedron_8h}{boundingHexahedron.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{plane_8h}{plane.h}}"{}}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00027\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ Lens::\_type\_handle;}
\DoxyCodeLine{00030\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ Lens::CData::\_type\_handle;}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00035\ Lens::}
\DoxyCodeLine{00036\ Lens()\ \{}
\DoxyCodeLine{00037\ \ \ \mbox{\hyperlink{classLens_a2fd119590404fad4e61044e22447018c}{clear}}();}
\DoxyCodeLine{00038\ \}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00043\ Lens::}
\DoxyCodeLine{00044\ Lens(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ \&copy)\ :\ \_cycler(copy.\_cycler)\ \{}
\DoxyCodeLine{00045\ \ \ \textcolor{comment}{//\ We\ don't\ copy\ the\ \_geom\_data.\ \ That's\ unique\ to\ each\ Lens.}}
\DoxyCodeLine{00046\ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00047\ \ \ cdata-\/>\_geom\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00048\ \}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00053\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00054\ operator\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ \&copy)\ \{}
\DoxyCodeLine{00055\ \ \ \_cycler\ =\ copy.\_cycler;}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \textcolor{comment}{//\ We\ don't\ copy\ the\ \_geom\_data.\ \ That's\ unique\ to\ each\ Lens.}}
\DoxyCodeLine{00058\ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00059\ \ \ cdata-\/>\_geom\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00060\ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00066\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a31782e92122d270f84c400cd316f67eb}{Lens::}}}
\DoxyCodeLine{00067\ \mbox{\hyperlink{classLens_a31782e92122d270f84c400cd316f67eb}{set\_coordinate\_system}}(CoordinateSystem\ cs)\ \{}
\DoxyCodeLine{00068\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00069\ \ \ cdata-\/>\_cs\ =\ cs;}
\DoxyCodeLine{00070\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_view\_hpr\ |\ CF\_view\_vector,\ 0);}
\DoxyCodeLine{00071\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00072\ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00077\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a2fd119590404fad4e61044e22447018c}{Lens::}}}
\DoxyCodeLine{00078\ \mbox{\hyperlink{classLens_a2fd119590404fad4e61044e22447018c}{clear}}()\ \{}
\DoxyCodeLine{00079\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00080\ \ \ cdata-\/>clear();}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ do\_set\_interocular\_distance(cdata,\ default\_iod);}
\DoxyCodeLine{00083\ \ \ do\_set\_convergence\_distance(cdata,\ default\_converge);}
\DoxyCodeLine{00084\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00085\ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00098\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_ade951ff84d0b7eb9a787b7178b03924a}{Lens::}}}
\DoxyCodeLine{00099\ \mbox{\hyperlink{classLens_ade951ff84d0b7eb9a787b7178b03924a}{set\_min\_fov}}(PN\_stdfloat\ min\_fov)\ \{}
\DoxyCodeLine{00100\ \ \ nassertv(!cnan(min\_fov));}
\DoxyCodeLine{00101\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00102\ \ \ cdata-\/>\_min\_fov\ =\ min\_fov;}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00106\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_fov\_seq,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_film\_size\_seq);}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_focal\_length\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ focal\ length\ if\ it's\ oldest.}}
\DoxyCodeLine{00110\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_focal\_length\ |\ UF\_vfov\ |\ UF\_hfov,}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_min\_fov);}
\DoxyCodeLine{00112\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ film\ size.}}
\DoxyCodeLine{00114\ \ \ \ \ nassertv(cdata-\/>\_film\_size\_seq\ ==\ 0);}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ we\ save\ the\ aspect\ ratio\ first.}}
\DoxyCodeLine{00117\ \ \ \ \ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{do\_compute\_aspect\_ratio}}(cdata);}
\DoxyCodeLine{00118\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_film\_width\ |\ UF\_film\_height\ |\ UF\_vfov\ |\ UF\_hfov,}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_min\_fov);}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_focal\_length\ |\ CF\_fov\ |\ CF\_film\_size,}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0);}
\DoxyCodeLine{00123\ \ \ \textcolor{comment}{//\ We\ leave\ CF\_fov\ off\ of\ comp\_flags,\ because\ we\ will\ still\ need\ to}}
\DoxyCodeLine{00124\ \ \ \textcolor{comment}{//\ recompute\ the\ vertical\ fov.\ \ It's\ not\ exactly\ the\ same\ as\ hfov\ *}}
\DoxyCodeLine{00125\ \ \ \textcolor{comment}{//\ get\_aspect\_ratio().}}
\DoxyCodeLine{00126\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00127\ \}}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00133\ PN\_stdfloat\ \mbox{\hyperlink{classLens_a329decd2dd6f7d31c62b5bd008979caa}{Lens::}}}
\DoxyCodeLine{00134\ \mbox{\hyperlink{classLens_a329decd2dd6f7d31c62b5bd008979caa}{get\_min\_fov}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00135\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_fov)\ ==\ 0)\ \{}
\DoxyCodeLine{00138\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_fov((\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *)cdata.p());}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_min\_fov;}
\DoxyCodeLine{00141\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00147\ PN\_stdfloat\ \mbox{\hyperlink{classLens_a10289e5644e5dbae91759edf0f0a7fe2}{Lens::}}}
\DoxyCodeLine{00148\ \mbox{\hyperlink{classLens_a10289e5644e5dbae91759edf0f0a7fe2}{get\_default\_near}}()\ \{}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{return}\ default\_near;}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00156\ PN\_stdfloat\ \mbox{\hyperlink{classLens_a17dab5f7ca954124019b7b5a69ecb675}{Lens::}}}
\DoxyCodeLine{00157\ \mbox{\hyperlink{classLens_a17dab5f7ca954124019b7b5a69ecb675}{get\_default\_far}}()\ \{}
\DoxyCodeLine{00158\ \ \ \textcolor{keywordflow}{return}\ default\_far;}
\DoxyCodeLine{00159\ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00167\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00168\ set\_view\_hpr(\textcolor{keyword}{const}\ LVecBase3\ \&view\_hpr)\ \{}
\DoxyCodeLine{00169\ \ \ nassertv(!view\_hpr.is\_nan());}
\DoxyCodeLine{00170\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00171\ \ \ cdata-\/>\_view\_hpr\ =\ view\_hpr;}
\DoxyCodeLine{00172\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_view\_vector\ |\ UF\_view\_mat,}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_view\_hpr);}
\DoxyCodeLine{00174\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_view\_vector,}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_view\_hpr);}
\DoxyCodeLine{00176\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00177\ \}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00182\ \textcolor{keyword}{const}\ LVecBase3\ \&\mbox{\hyperlink{classLens_aeabeceec3a97eba6ea013965b6d6df51}{Lens::}}}
\DoxyCodeLine{00183\ \mbox{\hyperlink{classLens_aeabeceec3a97eba6ea013965b6d6df51}{get\_view\_hpr}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00184\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00185\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_view\_hpr)\ ==\ 0)\ \{}
\DoxyCodeLine{00186\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_view\_hpr((\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *)cdata.p());}
\DoxyCodeLine{00187\ \ \ \}}
\DoxyCodeLine{00188\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_view\_hpr;}
\DoxyCodeLine{00189\ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00197\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00198\ set\_view\_vector(\textcolor{keyword}{const}\ LVector3\ \&view\_vector,\ \textcolor{keyword}{const}\ LVector3\ \&up\_vector)\ \{}
\DoxyCodeLine{00199\ \ \ nassertv(!view\_vector.is\_nan());}
\DoxyCodeLine{00200\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00201\ \ \ cdata-\/>\_view\_vector\ =\ view\_vector;}
\DoxyCodeLine{00202\ \ \ cdata-\/>\_up\_vector\ =\ up\_vector;}
\DoxyCodeLine{00203\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_view\_hpr\ |\ UF\_view\_mat,}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_view\_vector);}
\DoxyCodeLine{00205\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_view\_hpr,}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_view\_vector);}
\DoxyCodeLine{00207\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00208\ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00213\ \textcolor{keyword}{const}\ LVector3\ \&\mbox{\hyperlink{classLens_ae74283649a01f7358f0d6dba47225e77}{Lens::}}}
\DoxyCodeLine{00214\ \mbox{\hyperlink{classLens_ae74283649a01f7358f0d6dba47225e77}{get\_view\_vector}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00215\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_view\_vector)\ ==\ 0)\ \{}
\DoxyCodeLine{00217\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_view\_vector((\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *)cdata.p());}
\DoxyCodeLine{00218\ \ \ \}}
\DoxyCodeLine{00219\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_view\_vector;}
\DoxyCodeLine{00220\ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00226\ \textcolor{keyword}{const}\ LVector3\ \&\mbox{\hyperlink{classLens_a91135db7dfc3b20ba3753b7b674ecf4a}{Lens::}}}
\DoxyCodeLine{00227\ \mbox{\hyperlink{classLens_a91135db7dfc3b20ba3753b7b674ecf4a}{get\_up\_vector}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00228\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00229\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_view\_vector)\ ==\ 0)\ \{}
\DoxyCodeLine{00230\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_view\_vector((\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *)cdata.p());}
\DoxyCodeLine{00231\ \ \ \}}
\DoxyCodeLine{00232\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_up\_vector;}
\DoxyCodeLine{00233\ \}}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00239\ LPoint3\ \mbox{\hyperlink{classLens_a9e0dd414581ea98661d732d158b804f6}{Lens::}}}
\DoxyCodeLine{00240\ \mbox{\hyperlink{classLens_a9e0dd414581ea98661d732d158b804f6}{get\_nodal\_point}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00241\ \ \ \textcolor{keywordflow}{return}\ get\_view\_mat().get\_row3(3);}
\DoxyCodeLine{00242\ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00247\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_abacb64b1930ee20fffa00aae902718ff}{Lens::}}}
\DoxyCodeLine{00248\ \mbox{\hyperlink{classLens_abacb64b1930ee20fffa00aae902718ff}{clear\_view\_mat}}()\ \{}
\DoxyCodeLine{00249\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00250\ \ \ cdata-\/>\_lens\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{00251\ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_view\_vector\ |\ UF\_view\_hpr\ |\ UF\_view\_mat);}
\DoxyCodeLine{00252\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_lens\_mat\_inv\ |\ CF\_view\_hpr\ |\ CF\_view\_vector,}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_lens\_mat);}
\DoxyCodeLine{00256\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00257\ \}}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00271\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a21ba279ed36f3df647b93f249f69f7e5}{Lens::}}}
\DoxyCodeLine{00272\ \mbox{\hyperlink{classLens_a21ba279ed36f3df647b93f249f69f7e5}{set\_keystone}}(\textcolor{keyword}{const}\ LVecBase2\ \&keystone)\ \{}
\DoxyCodeLine{00273\ \ \ nassertv(!keystone.is\_nan());}
\DoxyCodeLine{00274\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00275\ \ \ cdata-\/>\_keystone\ =\ keystone;}
\DoxyCodeLine{00276\ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_keystone);}
\DoxyCodeLine{00277\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_mat\ |\ CF\_film\_mat\_inv,\ 0);}
\DoxyCodeLine{00280\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00281\ \}}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00286\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a5a6f54de797c87fe288ad0125a677f79}{Lens::}}}
\DoxyCodeLine{00287\ \mbox{\hyperlink{classLens_a5a6f54de797c87fe288ad0125a677f79}{clear\_keystone}}()\ \{}
\DoxyCodeLine{00288\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00289\ \ \ cdata-\/>\_keystone.set(0.0f,\ 0.0f);}
\DoxyCodeLine{00290\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_keystone,\ 0);}
\DoxyCodeLine{00291\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_mat\ |\ CF\_film\_mat\_inv,\ 0);}
\DoxyCodeLine{00294\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00295\ \}}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00305\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a23b95821b57fcf428c2d034d8be63c9f}{Lens::}}}
\DoxyCodeLine{00306\ \mbox{\hyperlink{classLens_a23b95821b57fcf428c2d034d8be63c9f}{set\_custom\_film\_mat}}(\textcolor{keyword}{const}\ LMatrix4\ \&custom\_film\_mat)\ \{}
\DoxyCodeLine{00307\ \ \ nassertv(!custom\_film\_mat.is\_nan());}
\DoxyCodeLine{00308\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00309\ \ \ cdata-\/>\_custom\_film\_mat\ =\ custom\_film\_mat;}
\DoxyCodeLine{00310\ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_custom\_film\_mat);}
\DoxyCodeLine{00311\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_mat\ |\ CF\_film\_mat\_inv,\ 0);}
\DoxyCodeLine{00314\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00315\ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00320\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_adb8cfa40e9892c160409e4ef0bda00b7}{Lens::}}}
\DoxyCodeLine{00321\ \mbox{\hyperlink{classLens_adb8cfa40e9892c160409e4ef0bda00b7}{clear\_custom\_film\_mat}}()\ \{}
\DoxyCodeLine{00322\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00323\ \ \ cdata-\/>\_custom\_film\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{00324\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_custom\_film\_mat,\ 0);}
\DoxyCodeLine{00325\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_mat\ |\ CF\_film\_mat\_inv,\ 0);}
\DoxyCodeLine{00328\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00329\ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00374\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a59d152cadbe7ecba4bd0ba0ece8b4ed3}{Lens::}}}
\DoxyCodeLine{00375\ \mbox{\hyperlink{classLens_a59d152cadbe7ecba4bd0ba0ece8b4ed3}{set\_frustum\_from\_corners}}(\textcolor{keyword}{const}\ LVecBase3\ \&ul,\ \textcolor{keyword}{const}\ LVecBase3\ \&ur,}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVecBase3\ \&ll,\ \textcolor{keyword}{const}\ LVecBase3\ \&lr,}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{00378\ \ \ nassertv(!ul.is\_nan()\ \&\&\ !ur.is\_nan()\ \&\&\ !ll.is\_nan()\ \&\&\ !lr.is\_nan());}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00381\ \ \ \textcolor{comment}{//\ We'll\ need\ to\ know\ the\ pre-\/existing\ eyepoint\ translation\ from\ the\ center,}}
\DoxyCodeLine{00382\ \ \ \textcolor{comment}{//\ so\ we\ can\ preserve\ it\ in\ the\ new\ frustum.\ \ This\ is\ usually\ (0,\ 0,\ 0),\ but}}
\DoxyCodeLine{00383\ \ \ \textcolor{comment}{//\ it\ could\ be\ an\ arbitrary\ vector.}}
\DoxyCodeLine{00384\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&lens\_mat\_inv\ =\ do\_get\_lens\_mat\_inv(cdata);}
\DoxyCodeLine{00385\ \ \ LVector3\ eye\_offset;}
\DoxyCodeLine{00386\ \ \ lens\_mat\_inv.get\_row3(eye\_offset,\ 3);}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ \textcolor{comment}{//\ Now\ choose\ the\ viewing\ axis.\ \ If\ FC\_camera\_plane\ is\ specified,\ we'll\ pass}}
\DoxyCodeLine{00389\ \ \ \textcolor{comment}{//\ it\ through\ the\ centroid\ for\ the\ best\ camera\ plane;\ otherwise,\ it's}}
\DoxyCodeLine{00390\ \ \ \textcolor{comment}{//\ perpendicular\ to\ the\ plane\ in\ which\ the\ points\ lie.}}
\DoxyCodeLine{00391\ \ \ LVector3\ view\_vector;}
\DoxyCodeLine{00392\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ FC\_camera\_plane)\ !=\ 0)\ \{}
\DoxyCodeLine{00393\ \ \ \ \ view\_vector\ =\ (ul\ +\ ur\ +\ ll\ +\ lr)\ *\ 0.25;}
\DoxyCodeLine{00394\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00395\ \ \ \ \ LPlane\ plane(ll,\ ul,\ ur);}
\DoxyCodeLine{00396\ \ \ \ \ view\_vector\ =\ plane.get\_normal();}
\DoxyCodeLine{00397\ \ \ \ \ nassertv(!view\_vector.is\_nan()\ \&\&\ view\_vector.length\_squared()\ !=\ 0.0f);}
\DoxyCodeLine{00398\ \ \ \}}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \ \ \textcolor{comment}{//\ Now\ determine\ the\ up\ axis.\ \ If\ FC\_roll\ is\ specified,\ or\ if\ our\ view}}
\DoxyCodeLine{00401\ \ \ \textcolor{comment}{//\ vector\ is\ straight\ up,\ it\ is\ the\ vector\ perpendicular\ to\ both\ the\ viewing}}
\DoxyCodeLine{00402\ \ \ \textcolor{comment}{//\ axis\ and\ the\ top\ line.\ \ Otherwise,\ it\ is\ the\ standard\ up\ axis.}}
\DoxyCodeLine{00403\ \ \ LVector3\ up\_vector\ =\ LVector3::up(cdata-\/>\_cs);}
\DoxyCodeLine{00404\ \ \ \textcolor{keywordflow}{if}\ (view\_vector\ ==\ up\_vector\ ||\ ((flags\ \&\ FC\_roll)\ !=\ 0))\ \{}
\DoxyCodeLine{00405\ \ \ \ \ LVector3\ top\ =\ ul\ -\/\ ur;}
\DoxyCodeLine{00406\ \ \ \ \ up\_vector\ =\ view\_vector.cross(top);}
\DoxyCodeLine{00407\ \ \ \ \ nassertv(!up\_vector.is\_nan()\ \&\&\ up\_vector.length\_squared()\ !=\ 0.0f);}
\DoxyCodeLine{00408\ \ \ \}}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \ \ \textcolor{comment}{//\ Now\ compute\ the\ matrix\ that\ applies\ this\ rotation.}}
\DoxyCodeLine{00411\ \ \ LMatrix4\ rot\_mat;}
\DoxyCodeLine{00412\ \ \ \mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}}(rot\_mat,\ view\_vector,\ up\_vector,\ CS\_zup\_right);}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00414\ \ \ \textcolor{comment}{//\ And\ invert\ it.}}
\DoxyCodeLine{00415\ \ \ LMatrix4\ inv\_rot\_mat;}
\DoxyCodeLine{00416\ \ \ inv\_rot\_mat.invert\_affine\_from(rot\_mat);}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ \textcolor{comment}{//\ Use\ that\ inverse\ matrix\ to\ convert\ the\ four\ corners\ to\ a\ local\ coordinate}}
\DoxyCodeLine{00419\ \ \ \textcolor{comment}{//\ system,\ looking\ down\ the\ Y\ axis.}}
\DoxyCodeLine{00420\ \ \ LPoint3\ cul\ =\ inv\_rot\_mat.xform\_point(ul);}
\DoxyCodeLine{00421\ \ \ LPoint3\ cur\ =\ inv\_rot\_mat.xform\_point(ur);}
\DoxyCodeLine{00422\ \ \ LPoint3\ cll\ =\ inv\_rot\_mat.xform\_point(ll);}
\DoxyCodeLine{00423\ \ \ LPoint3\ clr\ =\ inv\_rot\_mat.xform\_point(lr);}
\DoxyCodeLine{00424\ }
\DoxyCodeLine{00425\ \ \ \textcolor{comment}{//\ Project\ all\ points\ into\ the\ Y\ ==\ 1\ plane,\ so\ we\ can\ do\ 2-\/d\ manipulation}}
\DoxyCodeLine{00426\ \ \ \textcolor{comment}{//\ on\ them.}}
\DoxyCodeLine{00427\ \ \ nassertv(cul[1]\ !=\ 0.0f\ \&\&\ cur[1]\ !=\ 0.0f\ \&\&\ cll[1]\ !=\ 0.0f\ \&\&\ clr[1]\ !=\ 0.0f);}
\DoxyCodeLine{00428\ \ \ cul\ /=\ cul[1];}
\DoxyCodeLine{00429\ \ \ cur\ /=\ cur[1];}
\DoxyCodeLine{00430\ \ \ cll\ /=\ cll[1];}
\DoxyCodeLine{00431\ \ \ clr\ /=\ clr[1];}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \ \ LMatrix4\ shear\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{00434\ \ \ LMatrix4\ inv\_shear\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{00435\ }
\DoxyCodeLine{00436\ \ \ \textcolor{comment}{//\ Now,\ if\ we're\ allowed\ to\ shear\ the\ frustum,\ do\ so.}}
\DoxyCodeLine{00437\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ FC\_shear)\ !=\ 0)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ build\_shear\_mat(shear\_mat,\ cul,\ cur,\ cll,\ clr);}
\DoxyCodeLine{00439\ \ \ \ \ inv\_shear\_mat.invert\_from(shear\_mat);}
\DoxyCodeLine{00440\ \ \ \}}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \ \ \textcolor{comment}{//\ Now\ build\ the\ complete\ view\ matrix.}}
\DoxyCodeLine{00443\ \ \ LMatrix4\ inv\_view\_mat\ =}
\DoxyCodeLine{00444\ \ \ \ \ inv\_rot\_mat\ *}
\DoxyCodeLine{00445\ \ \ \ \ inv\_shear\_mat;}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \ \ \textcolor{comment}{//\ And\ reapply\ the\ eye\ offset\ to\ this\ matrix.}}
\DoxyCodeLine{00448\ \ \ inv\_view\_mat.set\_row(3,\ eye\_offset);}
\DoxyCodeLine{00449\ }
\DoxyCodeLine{00450\ \ \ LMatrix4\ view\_mat;}
\DoxyCodeLine{00451\ \ \ view\_mat.invert\_from(inv\_view\_mat);}
\DoxyCodeLine{00452\ \ \ do\_set\_view\_mat(cdata,\ view\_mat);}
\DoxyCodeLine{00453\ }
\DoxyCodeLine{00454\ \ \ LPoint3\ ful\ =\ inv\_view\_mat.xform\_point(ul);}
\DoxyCodeLine{00455\ \ \ LPoint3\ fur\ =\ inv\_view\_mat.xform\_point(ur);}
\DoxyCodeLine{00456\ \ \ LPoint3\ fll\ =\ inv\_view\_mat.xform\_point(ll);}
\DoxyCodeLine{00457\ \ \ LPoint3\ flr\ =\ inv\_view\_mat.xform\_point(lr);}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \ \ \textcolor{comment}{//\ Normalize\ *these*\ points\ into\ the\ y\ ==\ 1\ plane.}}
\DoxyCodeLine{00460\ \ \ nassertv(ful[1]\ !=\ 0.0f\ \&\&\ fur[1]\ !=\ 0.0f\ \&\&\ fll[1]\ !=\ 0.0f\ \&\&\ flr[1]\ !=\ 0.0f);}
\DoxyCodeLine{00461\ \ \ ful\ /=\ ful[1];}
\DoxyCodeLine{00462\ \ \ fur\ /=\ fur[1];}
\DoxyCodeLine{00463\ \ \ fll\ /=\ fll[1];}
\DoxyCodeLine{00464\ \ \ flr\ /=\ flr[1];}
\DoxyCodeLine{00465\ }
\DoxyCodeLine{00466\ \ \ \textcolor{comment}{//\ Determine\ the\ minimum\ field\ of\ view\ necesary\ to\ cover\ all\ four}}
\DoxyCodeLine{00467\ \ \ \textcolor{comment}{//\ transformed\ points.}}
\DoxyCodeLine{00468\ \ \ PN\_stdfloat\ min\_x\ =\ min(min(ful[0],\ fur[0]),\ min(fll[0],\ flr[0]));}
\DoxyCodeLine{00469\ \ \ PN\_stdfloat\ max\_x\ =\ max(max(ful[0],\ fur[0]),\ max(fll[0],\ flr[0]));}
\DoxyCodeLine{00470\ \ \ PN\_stdfloat\ min\_z\ =\ min(min(ful[2],\ fur[2]),\ min(fll[2],\ flr[2]));}
\DoxyCodeLine{00471\ \ \ PN\_stdfloat\ max\_z\ =\ max(max(ful[2],\ fur[2]),\ max(fll[2],\ flr[2]));}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ PN\_stdfloat\ x\_spread,\ x\_center,\ z\_spread,\ z\_center;}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ FC\_off\_axis)\ !=\ 0)\ \{}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ allowed\ to\ make\ an\ off-\/axis\ projection,\ then\ pick\ the\ best}}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{comment}{//\ center.}}
\DoxyCodeLine{00478\ \ \ \ \ x\_center\ =\ (max\_x\ +\ min\_x)\ *\ 0.5f;}
\DoxyCodeLine{00479\ \ \ \ \ z\_center\ =\ (max\_z\ +\ min\_z)\ *\ 0.5f;}
\DoxyCodeLine{00480\ \ \ \ \ x\_spread\ =\ x\_center\ -\/\ min\_x;}
\DoxyCodeLine{00481\ \ \ \ \ z\_spread\ =\ z\_center\ -\/\ min\_z;}
\DoxyCodeLine{00482\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00483\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ the\ center\ must\ be\ (0,\ 0).}}
\DoxyCodeLine{00484\ \ \ \ \ x\_center\ =\ 0.0f;}
\DoxyCodeLine{00485\ \ \ \ \ z\_center\ =\ 0.0f;}
\DoxyCodeLine{00486\ \ \ \ \ x\_spread\ =\ max(cabs(max\_x),\ cabs(min\_x));}
\DoxyCodeLine{00487\ \ \ \ \ z\_spread\ =\ max(cabs(max\_z),\ cabs(min\_z));}
\DoxyCodeLine{00488\ \ \ \}}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ PN\_stdfloat\ aspect\_ratio\ =\ do\_get\_aspect\_ratio(cdata);}
\DoxyCodeLine{00491\ \ \ nassertv(aspect\_ratio\ !=\ 0.0f);}
\DoxyCodeLine{00492\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ FC\_aspect\_ratio)\ ==\ 0)\ \{}
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{comment}{//\ If\ we\ must\ preserve\ the\ aspect\ ratio,\ then\ the\ x\ and\ z\ spreads\ must\ be}}
\DoxyCodeLine{00494\ \ \ \ \ \textcolor{comment}{//\ adjusted\ to\ match.}}
\DoxyCodeLine{00495\ \ \ \ \ \textcolor{keywordflow}{if}\ (x\_spread\ <\ z\_spread\ *\ aspect\_ratio)\ \{}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \textcolor{comment}{//\ x\_spread\ is\ too\ small.}}
\DoxyCodeLine{00497\ \ \ \ \ \ \ x\_spread\ =\ z\_spread\ *\ aspect\_ratio;}
\DoxyCodeLine{00498\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (z\_spread\ <\ x\_spread\ /\ aspect\_ratio)\ \{}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \textcolor{comment}{//\ z\_spread\ is\ too\ small.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ z\_spread\ =\ x\_spread\ /\ aspect\_ratio;}
\DoxyCodeLine{00501\ \ \ \ \ \}}
\DoxyCodeLine{00502\ \ \ \}}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ PN\_stdfloat\ hfov\ =\ rad\_2\_deg(catan(x\_spread))\ *\ 2.0f;}
\DoxyCodeLine{00505\ \ \ PN\_stdfloat\ vfov\ =\ rad\_2\_deg(catan(z\_spread))\ *\ 2.0f;}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ do\_set\_fov(cdata,\ LVecBase2(hfov,\ vfov));}
\DoxyCodeLine{00508\ }
\DoxyCodeLine{00509\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ FC\_aspect\_ratio)\ ==\ 0)\ \{}
\DoxyCodeLine{00510\ \ \ \ \ \textcolor{comment}{//\ If\ we\ must\ preserve\ the\ aspect\ ratio,\ store\ it\ one\ more\ time.\ \ This\ is}}
\DoxyCodeLine{00511\ \ \ \ \ \textcolor{comment}{//\ mainly\ in\ case\ we\ have\ a\ non-\/perspective\ lens\ with\ a\ funny\ relationship}}
\DoxyCodeLine{00512\ \ \ \ \ \textcolor{comment}{//\ between\ fov\ and\ aspect\ ratio.}}
\DoxyCodeLine{00513\ \ \ \ \ do\_set\_aspect\_ratio(cdata,\ aspect\_ratio);}
\DoxyCodeLine{00514\ \ \ \}}
\DoxyCodeLine{00515\ }
\DoxyCodeLine{00516\ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&film\_size\ =\ do\_get\_film\_size(cdata);}
\DoxyCodeLine{00517\ \ \ nassertv(x\_spread\ !=\ 0.0f\ \&\&\ z\_spread\ !=\ 0.0f);}
\DoxyCodeLine{00518\ \ \ do\_set\_film\_offset(cdata,\ LVecBase2(film\_size[0]\ *\ x\_center\ /\ (x\_spread\ *\ 2.0f),}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ film\_size[1]\ *\ z\_center\ /\ (z\_spread\ *\ 2.0f)));}
\DoxyCodeLine{00520\ \}}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ }
\DoxyCodeLine{00528\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a77c2257227db6a68c021acc291e63dec}{Lens::}}}
\DoxyCodeLine{00529\ \mbox{\hyperlink{classLens_a77c2257227db6a68c021acc291e63dec}{recompute\_all}}()\ \{}
\DoxyCodeLine{00530\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler);}
\DoxyCodeLine{00531\ \ \ cdata-\/>\_comp\_flags\ =\ 0;}
\DoxyCodeLine{00532\ \}}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00539\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a52af0b8777ac289e2168a4e89cf698a3}{Lens::}}}
\DoxyCodeLine{00540\ \mbox{\hyperlink{classLens_a52af0b8777ac289e2168a4e89cf698a3}{is\_linear}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00541\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00542\ \}}
\DoxyCodeLine{00543\ }
\DoxyCodeLine{00548\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a9b5c3be6424a658b880c1744a235e6d2}{Lens::}}}
\DoxyCodeLine{00549\ \mbox{\hyperlink{classLens_a9b5c3be6424a658b880c1744a235e6d2}{is\_perspective}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00550\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00551\ \}}
\DoxyCodeLine{00552\ }
\DoxyCodeLine{00557\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a81e08c8c07fb9d83ef071dc3bb64c895}{Lens::}}}
\DoxyCodeLine{00558\ \mbox{\hyperlink{classLens_a81e08c8c07fb9d83ef071dc3bb64c895}{is\_orthographic}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00559\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00560\ \}}
\DoxyCodeLine{00561\ }
\DoxyCodeLine{00567\ PT(\mbox{\hyperlink{classGeom}{Geom}})\ Lens::}
\DoxyCodeLine{00568\ make\_geometry()\ \{}
\DoxyCodeLine{00569\ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \ \ \textcolor{comment}{//\ The\ default\ behavior\ for\ make\_geometry()\ will\ be\ to\ draw\ a\ hexahedron}}
\DoxyCodeLine{00572\ \ \ \textcolor{comment}{//\ around\ the\ eight\ vertices\ of\ the\ frustum.\ \ If\ the\ lens\ is\ non-\/linear,\ the}}
\DoxyCodeLine{00573\ \ \ \textcolor{comment}{//\ hexahedron\ will\ be\ curved;\ in\ that\ case,\ we'll\ subdivide\ the\ lines\ into}}
\DoxyCodeLine{00574\ \ \ \textcolor{comment}{//\ several\ segments\ to\ get\ an\ approximation\ of\ the\ curve.}}
\DoxyCodeLine{00575\ }
\DoxyCodeLine{00576\ \ \ \textcolor{comment}{//\ First,\ define\ all\ the\ points\ we'll\ use\ in\ this\ Geom.\ \ That's\ one\ point\ at}}
\DoxyCodeLine{00577\ \ \ \textcolor{comment}{//\ each\ corner\ of\ the\ near\ and\ far\ planes\ (and\ possibly\ more\ points\ along}}
\DoxyCodeLine{00578\ \ \ \textcolor{comment}{//\ the\ edges).}}
\DoxyCodeLine{00579\ \ \ \textcolor{keywordtype}{int}\ num\_segments\ =\ do\_define\_geom\_data(cdata);}
\DoxyCodeLine{00580\ \ \ \textcolor{keywordflow}{if}\ (num\_segments\ ==\ 0)\ \{}
\DoxyCodeLine{00581\ \ \ \ \ \textcolor{comment}{//\ Can't\ do\ a\ frustum.}}
\DoxyCodeLine{00582\ \ \ \ \ cdata-\/>\_geom\_data.clear();}
\DoxyCodeLine{00583\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00584\ \ \ \}}
\DoxyCodeLine{00585\ }
\DoxyCodeLine{00586\ \ \ \textcolor{comment}{//\ Now\ string\ together\ the\ line\ segments.}}
\DoxyCodeLine{00587\ \ \ PT(\mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}})\ line\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}}(Geom::UH\_static);}
\DoxyCodeLine{00588\ }
\DoxyCodeLine{00589\ \ \ \textcolor{comment}{//\ Draw\ a\ frame\ around\ the\ near\ plane.}}
\DoxyCodeLine{00590\ \ \ \textcolor{keywordtype}{int}\ i,\ si;}
\DoxyCodeLine{00591\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ 4;\ ++i)\ \{}
\DoxyCodeLine{00592\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <\ num\_segments;\ ++si)\ \{}
\DoxyCodeLine{00593\ \ \ \ \ \ \ line-\/>add\_vertex(i\ *\ 2\ +\ si\ *\ (4\ *\ 2)\ +\ 0);}
\DoxyCodeLine{00594\ \ \ \ \ \}}
\DoxyCodeLine{00595\ \ \ \}}
\DoxyCodeLine{00596\ \ \ line-\/>add\_vertex(0);}
\DoxyCodeLine{00597\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00598\ }
\DoxyCodeLine{00599\ \ \ \textcolor{comment}{//\ Draw\ a\ frame\ around\ the\ far\ plane.}}
\DoxyCodeLine{00600\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ 4;\ ++i)\ \{}
\DoxyCodeLine{00601\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <\ num\_segments;\ ++si)\ \{}
\DoxyCodeLine{00602\ \ \ \ \ \ \ line-\/>add\_vertex(i\ *\ 2\ +\ si\ *\ (4\ *\ 2)\ +\ 1);}
\DoxyCodeLine{00603\ \ \ \ \ \}}
\DoxyCodeLine{00604\ \ \ \}}
\DoxyCodeLine{00605\ \ \ line-\/>add\_vertex(1);}
\DoxyCodeLine{00606\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00608\ \ \ \textcolor{comment}{//\ Draw\ connecting\ lines\ at\ the\ corners.}}
\DoxyCodeLine{00609\ \ \ line-\/>add\_vertex(0\ *\ 2\ +\ 0);}
\DoxyCodeLine{00610\ \ \ line-\/>add\_vertex(0\ *\ 2\ +\ 1);}
\DoxyCodeLine{00611\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00612\ }
\DoxyCodeLine{00613\ \ \ line-\/>add\_vertex(1\ *\ 2\ +\ 0);}
\DoxyCodeLine{00614\ \ \ line-\/>add\_vertex(1\ *\ 2\ +\ 1);}
\DoxyCodeLine{00615\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \ \ line-\/>add\_vertex(2\ *\ 2\ +\ 0);}
\DoxyCodeLine{00618\ \ \ line-\/>add\_vertex(2\ *\ 2\ +\ 1);}
\DoxyCodeLine{00619\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00620\ }
\DoxyCodeLine{00621\ \ \ line-\/>add\_vertex(3\ *\ 2\ +\ 0);}
\DoxyCodeLine{00622\ \ \ line-\/>add\_vertex(3\ *\ 2\ +\ 1);}
\DoxyCodeLine{00623\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00625\ \ \ \textcolor{comment}{//\ And\ one\ more\ line\ for\ the\ viewing\ axis.}}
\DoxyCodeLine{00626\ \ \ line-\/>add\_vertex(num\_segments\ *\ (4\ *\ 2)\ +\ 0);}
\DoxyCodeLine{00627\ \ \ line-\/>add\_vertex(num\_segments\ *\ (4\ *\ 2)\ +\ 1);}
\DoxyCodeLine{00628\ \ \ line-\/>close\_primitive();}
\DoxyCodeLine{00629\ }
\DoxyCodeLine{00630\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(cdata-\/>\_geom\_data);}
\DoxyCodeLine{00631\ \ \ geom-\/>add\_primitive(line);}
\DoxyCodeLine{00632\ }
\DoxyCodeLine{00633\ \ \ \textcolor{keywordflow}{return}\ geom;}
\DoxyCodeLine{00634\ \}}
\DoxyCodeLine{00635\ }
\DoxyCodeLine{00641\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ Lens::}
\DoxyCodeLine{00642\ make\_bounds()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00643\ \ \ CDReader\ cdata(\_cycler);}
\DoxyCodeLine{00644\ }
\DoxyCodeLine{00645\ \ \ \textcolor{comment}{//\ The\ default\ bounding\ volume\ is\ a\ hexahedron\ based\ on\ the\ eight\ corners\ of}}
\DoxyCodeLine{00646\ \ \ \textcolor{comment}{//\ the\ frustum.}}
\DoxyCodeLine{00647\ \ \ LPoint3\ fll,\ flr,\ ful,\ fur;}
\DoxyCodeLine{00648\ \ \ LPoint3\ nll,\ nlr,\ nul,\ nur;}
\DoxyCodeLine{00649\ \ \ LPoint3\ corner;}
\DoxyCodeLine{00650\ }
\DoxyCodeLine{00651\ \ \ \textcolor{comment}{//\ Upper\ left.}}
\DoxyCodeLine{00652\ \ \ corner.set(-\/1.0f,\ 1.0f,\ 0.0f);}
\DoxyCodeLine{00653\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ corner,\ nul,\ ful))\ \{}
\DoxyCodeLine{00654\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00655\ \ \ \}}
\DoxyCodeLine{00656\ }
\DoxyCodeLine{00657\ \ \ \textcolor{comment}{//\ Upper\ right.}}
\DoxyCodeLine{00658\ \ \ corner.set(1.0f,\ 1.0f,\ 0.0f);}
\DoxyCodeLine{00659\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ corner,\ nur,\ fur))\ \{}
\DoxyCodeLine{00660\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00661\ \ \ \}}
\DoxyCodeLine{00662\ }
\DoxyCodeLine{00663\ \ \ \textcolor{comment}{//\ Lower\ right.}}
\DoxyCodeLine{00664\ \ \ corner.set(1.0f,\ -\/1.0f,\ 0.0f);}
\DoxyCodeLine{00665\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ corner,\ nlr,\ flr))\ \{}
\DoxyCodeLine{00666\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00667\ \ \ \}}
\DoxyCodeLine{00668\ }
\DoxyCodeLine{00669\ \ \ \textcolor{comment}{//\ Lower\ left.}}
\DoxyCodeLine{00670\ \ \ corner.set(-\/1.0f,\ -\/1.0f,\ 0.0f);}
\DoxyCodeLine{00671\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ corner,\ nll,\ fll))\ \{}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00673\ \ \ \}}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingHexahedron}{BoundingHexahedron}}(fll,\ flr,\ fur,\ ful,\ nll,\ nlr,\ nur,\ nul);}
\DoxyCodeLine{00676\ \}}
\DoxyCodeLine{00677\ }
\DoxyCodeLine{00681\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00682\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00683\ \ \ out\ <<\ get\_type();}
\DoxyCodeLine{00684\ \}}
\DoxyCodeLine{00685\ }
\DoxyCodeLine{00689\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00690\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00691\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}\ fov\ =\ "{}}\ <<\ get\_fov()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00692\ \}}
\DoxyCodeLine{00693\ }
\DoxyCodeLine{00697\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00698\ do\_set\_film\_size(CData\ *cdata,\ PN\_stdfloat\ width)\ \{}
\DoxyCodeLine{00699\ \ \ nassertv(!cnan(width));}
\DoxyCodeLine{00700\ \ \ cdata-\/>\_film\_size.set(width,\ width\ /\ do\_get\_aspect\_ratio(cdata));}
\DoxyCodeLine{00701\ }
\DoxyCodeLine{00702\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00703\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00704\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_film\_size\_seq,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_fov\_seq);}
\DoxyCodeLine{00705\ }
\DoxyCodeLine{00706\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_fov\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00707\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ fov\ if\ it's\ oldest.}}
\DoxyCodeLine{00708\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_hfov\ |\ UF\_vfov\ |\ UF\_min\_fov\ |\ UF\_film\_height,}
\DoxyCodeLine{00709\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_film\_width);}
\DoxyCodeLine{00710\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00711\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ focal\ length.}}
\DoxyCodeLine{00712\ \ \ \ \ nassertv(cdata-\/>\_focal\_length\_seq\ ==\ 0);}
\DoxyCodeLine{00713\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_focal\_length\ |\ UF\_film\_height,}
\DoxyCodeLine{00714\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_film\_width);}
\DoxyCodeLine{00715\ \ \ \}}
\DoxyCodeLine{00716\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_focal\_length\ |\ CF\_fov,}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_size);}
\DoxyCodeLine{00718\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00719\ \}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00724\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00725\ do\_set\_film\_size(CData\ *cdata,\ \textcolor{keyword}{const}\ LVecBase2\ \&film\_size)\ \{}
\DoxyCodeLine{00726\ \ \ nassertv(!film\_size.is\_nan());}
\DoxyCodeLine{00727\ \ \ cdata-\/>\_film\_size\ =\ film\_size;}
\DoxyCodeLine{00728\ }
\DoxyCodeLine{00729\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00730\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00731\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_film\_size\_seq,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_fov\_seq);}
\DoxyCodeLine{00732\ }
\DoxyCodeLine{00733\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_fov\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ fov\ if\ it's\ oldest.}}
\DoxyCodeLine{00735\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_hfov\ |\ UF\_vfov\ |\ UF\_min\_fov\ |\ UF\_aspect\_ratio,}
\DoxyCodeLine{00736\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_film\_width\ |\ UF\_film\_height);}
\DoxyCodeLine{00737\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00738\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ focal\ length.}}
\DoxyCodeLine{00739\ \ \ \ \ nassertv(cdata-\/>\_focal\_length\_seq\ ==\ 0);}
\DoxyCodeLine{00740\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_focal\_length\ |\ UF\_vfov\ |\ UF\_aspect\_ratio,}
\DoxyCodeLine{00741\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_film\_width\ |\ UF\_film\_height);}
\DoxyCodeLine{00742\ \ \ \}}
\DoxyCodeLine{00743\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_focal\_length\ |\ CF\_fov\ |\ CF\_aspect\_ratio,}
\DoxyCodeLine{00744\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_film\_size);}
\DoxyCodeLine{00745\ }
\DoxyCodeLine{00746\ \ \ \textcolor{comment}{//\ Also,\ the\ user\ has\ implicitly\ specified\ an\ aspect\ ratio.\ \ Make\ it\ stick}}
\DoxyCodeLine{00747\ \ \ \textcolor{comment}{//\ until\ the\ user\ tells\ us\ something\ different.}}
\DoxyCodeLine{00748\ \ \ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{do\_compute\_aspect\_ratio}}(cdata);}
\DoxyCodeLine{00749\ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_aspect\_ratio);}
\DoxyCodeLine{00750\ }
\DoxyCodeLine{00751\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00752\ \}}
\DoxyCodeLine{00753\ }
\DoxyCodeLine{00757\ \textcolor{keyword}{const}\ LVecBase2\ \&Lens::}
\DoxyCodeLine{00758\ do\_get\_film\_size(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00759\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_film\_size)\ ==\ 0)\ \{}
\DoxyCodeLine{00760\ \ \ \ \ \textcolor{comment}{//\ We\ pretend\ this\ is\ a\ const\ method,\ even\ though\ it\ may\ call\ a\ non-\/const}}
\DoxyCodeLine{00761\ \ \ \ \ \textcolor{comment}{//\ method\ to\ recompute\ the\ internal\ values.\ \ We\ can\ do\ this\ because\ this}}
\DoxyCodeLine{00762\ \ \ \ \ \textcolor{comment}{//\ is\ just\ compute-\/on-\/demand.}}
\DoxyCodeLine{00763\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_film\_size((CData\ *)cdata);}
\DoxyCodeLine{00764\ \ \ \}}
\DoxyCodeLine{00765\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_film\_size;}
\DoxyCodeLine{00766\ \}}
\DoxyCodeLine{00767\ }
\DoxyCodeLine{00771\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00772\ do\_set\_focal\_length(CData\ *cdata,\ PN\_stdfloat\ focal\_length)\ \{}
\DoxyCodeLine{00773\ \ \ nassertv(!cnan(focal\_length));}
\DoxyCodeLine{00774\ \ \ cdata-\/>\_focal\_length\ =\ focal\_length;}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00777\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00778\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_film\_size\_seq,\ cdata-\/>\_fov\_seq);}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_film\_size\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00781\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ film\ size\ if\ it's\ oldest.}}
\DoxyCodeLine{00782\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_film\_width\ |\ UF\_film\_height,}
\DoxyCodeLine{00783\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_focal\_length);}
\DoxyCodeLine{00784\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ the\ fov.}}
\DoxyCodeLine{00786\ \ \ \ \ nassertv(cdata-\/>\_fov\_seq\ ==\ 0);}
\DoxyCodeLine{00787\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_hfov\ |\ UF\_vfov\ |\ UF\_min\_fov,}
\DoxyCodeLine{00788\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_focal\_length);}
\DoxyCodeLine{00789\ \ \ \}}
\DoxyCodeLine{00790\ }
\DoxyCodeLine{00791\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_fov\ |\ CF\_film\_size,}
\DoxyCodeLine{00792\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_focal\_length);}
\DoxyCodeLine{00793\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00794\ \}}
\DoxyCodeLine{00795\ }
\DoxyCodeLine{00799\ PN\_stdfloat\ Lens::}
\DoxyCodeLine{00800\ do\_get\_focal\_length(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00801\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_focal\_length)\ ==\ 0)\ \{}
\DoxyCodeLine{00802\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_focal\_length((CData\ *)cdata);}
\DoxyCodeLine{00803\ \ \ \}}
\DoxyCodeLine{00804\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_focal\_length;}
\DoxyCodeLine{00805\ \}}
\DoxyCodeLine{00806\ }
\DoxyCodeLine{00810\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00811\ do\_set\_fov(CData\ *cdata,\ PN\_stdfloat\ hfov)\ \{}
\DoxyCodeLine{00812\ \ \ nassertv(!cnan(hfov));}
\DoxyCodeLine{00813\ \ \ cdata-\/>\_fov[0]\ =\ hfov;}
\DoxyCodeLine{00814\ }
\DoxyCodeLine{00815\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00816\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00817\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_fov\_seq,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_film\_size\_seq);}
\DoxyCodeLine{00818\ }
\DoxyCodeLine{00819\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_focal\_length\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00820\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ focal\ length\ if\ it's\ oldest.}}
\DoxyCodeLine{00821\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_focal\_length\ |\ UF\_vfov\ |\ UF\_min\_fov,}
\DoxyCodeLine{00822\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_hfov);}
\DoxyCodeLine{00823\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00824\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ film\ size.}}
\DoxyCodeLine{00825\ \ \ \ \ nassertv(cdata-\/>\_film\_size\_seq\ ==\ 0);}
\DoxyCodeLine{00826\ }
\DoxyCodeLine{00827\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ we\ save\ the\ aspect\ ratio\ first.}}
\DoxyCodeLine{00828\ \ \ \ \ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{do\_compute\_aspect\_ratio}}(cdata);}
\DoxyCodeLine{00829\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_film\_width\ |\ UF\_film\_height\ |\ UF\_vfov\ |\ UF\_min\_fov,}
\DoxyCodeLine{00830\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_hfov);}
\DoxyCodeLine{00831\ \ \ \}}
\DoxyCodeLine{00832\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_focal\_length\ |\ CF\_fov\ |\ CF\_film\_size,}
\DoxyCodeLine{00833\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0);}
\DoxyCodeLine{00834\ \ \ \textcolor{comment}{//\ We\ leave\ CF\_fov\ off\ of\ comp\_flags,\ because\ we\ will\ still\ need\ to}}
\DoxyCodeLine{00835\ \ \ \textcolor{comment}{//\ recompute\ the\ vertical\ fov.\ \ It's\ not\ exactly\ the\ same\ as\ hfov\ *}}
\DoxyCodeLine{00836\ \ \ \textcolor{comment}{//\ get\_aspect\_ratio().}}
\DoxyCodeLine{00837\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00838\ \}}
\DoxyCodeLine{00839\ }
\DoxyCodeLine{00843\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00844\ do\_set\_fov(CData\ *cdata,\ \textcolor{keyword}{const}\ LVecBase2\ \&fov)\ \{}
\DoxyCodeLine{00845\ \ \ nassertv(!fov.is\_nan());}
\DoxyCodeLine{00846\ \ \ cdata-\/>\_fov\ =\ fov;}
\DoxyCodeLine{00847\ }
\DoxyCodeLine{00848\ \ \ \textcolor{comment}{//\ We\ can't\ specify\ all\ three\ of\ focal\ length,\ fov,\ and\ film\ size.\ \ Throw}}
\DoxyCodeLine{00849\ \ \ \textcolor{comment}{//\ out\ the\ oldest\ one.}}
\DoxyCodeLine{00850\ \ \ do\_resequence\_fov\_triad(cdata,\ cdata-\/>\_fov\_seq,\ cdata-\/>\_focal\_length\_seq,\ cdata-\/>\_film\_size\_seq);}
\DoxyCodeLine{00851\ }
\DoxyCodeLine{00852\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_focal\_length\_seq\ ==\ 0)\ \{}
\DoxyCodeLine{00853\ \ \ \ \ \textcolor{comment}{//\ Throw\ out\ focal\ length\ if\ it's\ oldest.}}
\DoxyCodeLine{00854\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_focal\_length\ |\ UF\_film\_height\ |\ UF\_min\_fov\ |\ UF\_aspect\_ratio,}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_hfov\ |\ UF\_vfov);}
\DoxyCodeLine{00856\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00857\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ throw\ out\ film\ size.}}
\DoxyCodeLine{00858\ \ \ \ \ nassertv(cdata-\/>\_film\_size\_seq\ ==\ 0);}
\DoxyCodeLine{00859\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_film\_width\ |\ UF\_film\_height\ |\ UF\_min\_fov\ |\ UF\_aspect\_ratio,}
\DoxyCodeLine{00860\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_hfov\ |\ UF\_vfov);}
\DoxyCodeLine{00861\ \ \ \}}
\DoxyCodeLine{00862\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_focal\_length\ |\ CF\_film\_size\ |\ CF\_aspect\_ratio,}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_fov);}
\DoxyCodeLine{00864\ }
\DoxyCodeLine{00865\ \ \ \textcolor{comment}{//\ Also,\ the\ user\ has\ implicitly\ specified\ an\ aspect\ ratio.\ \ Make\ it\ stick}}
\DoxyCodeLine{00866\ \ \ \textcolor{comment}{//\ until\ the\ user\ tells\ us\ something\ different.}}
\DoxyCodeLine{00867\ \ \ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{do\_compute\_aspect\_ratio}}(cdata);}
\DoxyCodeLine{00868\ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_aspect\_ratio);}
\DoxyCodeLine{00869\ }
\DoxyCodeLine{00870\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00871\ \}}
\DoxyCodeLine{00872\ }
\DoxyCodeLine{00876\ \textcolor{keyword}{const}\ LVecBase2\ \&Lens::}
\DoxyCodeLine{00877\ do\_get\_fov(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00878\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_fov)\ ==\ 0)\ \{}
\DoxyCodeLine{00879\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_fov((CData\ *)cdata);}
\DoxyCodeLine{00880\ \ \ \}}
\DoxyCodeLine{00881\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_fov;}
\DoxyCodeLine{00882\ \}}
\DoxyCodeLine{00883\ }
\DoxyCodeLine{00887\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{00888\ do\_set\_aspect\_ratio(CData\ *cdata,\ PN\_stdfloat\ aspect\_ratio)\ \{}
\DoxyCodeLine{00889\ \ \ nassertv(!cnan(aspect\_ratio));}
\DoxyCodeLine{00890\ \ \ cdata-\/>\_aspect\_ratio\ =\ aspect\_ratio;}
\DoxyCodeLine{00891\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_film\_height\ |\ UF\_vfov,}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_aspect\_ratio);}
\DoxyCodeLine{00893\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat\ |\ CF\_film\_size\ |\ CF\_fov\ |\ CF\_focal\_length,}
\DoxyCodeLine{00894\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_aspect\_ratio);}
\DoxyCodeLine{00895\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{00896\ \}}
\DoxyCodeLine{00897\ }
\DoxyCodeLine{00901\ PN\_stdfloat\ Lens::}
\DoxyCodeLine{00902\ do\_get\_aspect\_ratio(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00903\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_aspect\_ratio)\ ==\ 0)\ \{}
\DoxyCodeLine{00904\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_aspect\_ratio((CData\ *)cdata);}
\DoxyCodeLine{00905\ \ \ \}}
\DoxyCodeLine{00906\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_aspect\_ratio;}
\DoxyCodeLine{00907\ \}}
\DoxyCodeLine{00908\ }
\DoxyCodeLine{00912\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{00913\ do\_get\_projection\_mat(\textcolor{keyword}{const}\ CData\ *cdata,\ StereoChannel\ channel)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00914\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_projection\_mat)\ ==\ 0)\ \{}
\DoxyCodeLine{00915\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_projection\_mat((CData\ *)cdata);}
\DoxyCodeLine{00916\ \ \ \}}
\DoxyCodeLine{00917\ }
\DoxyCodeLine{00918\ \ \ \textcolor{keywordflow}{switch}\ (channel)\ \{}
\DoxyCodeLine{00919\ \ \ \textcolor{keywordflow}{case}\ SC\_left:}
\DoxyCodeLine{00920\ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat\_left;}
\DoxyCodeLine{00921\ \ \ \textcolor{keywordflow}{case}\ SC\_right:}
\DoxyCodeLine{00922\ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat\_right;}
\DoxyCodeLine{00923\ \ \ \textcolor{keywordflow}{case}\ SC\_mono:}
\DoxyCodeLine{00924\ \ \ \textcolor{keywordflow}{case}\ SC\_stereo:}
\DoxyCodeLine{00925\ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat;}
\DoxyCodeLine{00926\ \ \ \}}
\DoxyCodeLine{00927\ }
\DoxyCodeLine{00928\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat;}
\DoxyCodeLine{00929\ \}}
\DoxyCodeLine{00930\ }
\DoxyCodeLine{00934\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{00935\ do\_get\_projection\_mat\_inv(\textcolor{keyword}{const}\ CData\ *cdata,\ StereoChannel\ stereo\_channel)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00936\ \ \ \textcolor{keywordflow}{switch}\ (stereo\_channel)\ \{}
\DoxyCodeLine{00937\ \ \ \textcolor{keywordflow}{case}\ SC\_left:}
\DoxyCodeLine{00938\ \ \ \ \ \{}
\DoxyCodeLine{00939\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_projection\_mat\_left\_inv)\ ==\ 0)\ \{}
\DoxyCodeLine{00940\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\_left\ =\ do\_get\_projection\_mat(cdata,\ SC\_left);}
\DoxyCodeLine{00941\ \ \ \ \ \ \ \ \ ((CData\ *)cdata)-\/>\_projection\_mat\_left\_inv.invert\_from(projection\_mat\_left);}
\DoxyCodeLine{00942\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_adjust\_comp\_flags((CData\ *)cdata,\ 0,\ CF\_projection\_mat\_left\_inv);}
\DoxyCodeLine{00943\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00944\ \ \ \ \ \}}
\DoxyCodeLine{00945\ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat\_left\_inv;}
\DoxyCodeLine{00946\ }
\DoxyCodeLine{00947\ \ \ \textcolor{keywordflow}{case}\ SC\_right:}
\DoxyCodeLine{00948\ \ \ \ \ \{}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_projection\_mat\_right\_inv)\ ==\ 0)\ \{}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\_right\ =\ do\_get\_projection\_mat(cdata,\ SC\_right);}
\DoxyCodeLine{00951\ \ \ \ \ \ \ \ \ ((CData\ *)cdata)-\/>\_projection\_mat\_right\_inv.invert\_from(projection\_mat\_right);}
\DoxyCodeLine{00952\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_adjust\_comp\_flags((CData\ *)cdata,\ 0,\ CF\_projection\_mat\_right\_inv);}
\DoxyCodeLine{00953\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00954\ \ \ \ \ \}}
\DoxyCodeLine{00955\ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat\_right\_inv;}
\DoxyCodeLine{00956\ }
\DoxyCodeLine{00957\ \ \ \textcolor{keywordflow}{case}\ SC\_mono:}
\DoxyCodeLine{00958\ \ \ \textcolor{keywordflow}{case}\ SC\_stereo:}
\DoxyCodeLine{00959\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00960\ \ \ \}}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_projection\_mat\_inv)\ ==\ 0)\ \{}
\DoxyCodeLine{00963\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\ =\ do\_get\_projection\_mat(cdata);}
\DoxyCodeLine{00964\ \ \ \ \ ((CData\ *)cdata)-\/>\_projection\_mat\_inv.invert\_from(projection\_mat);}
\DoxyCodeLine{00965\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_adjust\_comp\_flags((CData\ *)cdata,\ 0,\ CF\_projection\_mat\_inv);}
\DoxyCodeLine{00966\ \ \ \}}
\DoxyCodeLine{00967\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_projection\_mat\_inv;}
\DoxyCodeLine{00968\ \}}
\DoxyCodeLine{00969\ }
\DoxyCodeLine{00973\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{00974\ do\_get\_film\_mat(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00975\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_film\_mat)\ ==\ 0)\ \{}
\DoxyCodeLine{00976\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_film\_mat((CData\ *)cdata);}
\DoxyCodeLine{00977\ \ \ \}}
\DoxyCodeLine{00978\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_film\_mat;}
\DoxyCodeLine{00979\ \}}
\DoxyCodeLine{00980\ }
\DoxyCodeLine{00984\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{00985\ do\_get\_film\_mat\_inv(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00986\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_film\_mat\_inv)\ ==\ 0)\ \{}
\DoxyCodeLine{00987\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&film\_mat\ =\ do\_get\_film\_mat(cdata);}
\DoxyCodeLine{00988\ \ \ \ \ ((CData\ *)cdata)-\/>\_film\_mat\_inv.invert\_from(film\_mat);}
\DoxyCodeLine{00989\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_adjust\_comp\_flags((CData\ *)cdata,\ 0,\ CF\_film\_mat\_inv);}
\DoxyCodeLine{00990\ \ \ \}}
\DoxyCodeLine{00991\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_film\_mat\_inv;}
\DoxyCodeLine{00992\ \}}
\DoxyCodeLine{00993\ }
\DoxyCodeLine{00997\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{00998\ do\_get\_lens\_mat(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00999\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_lens\_mat)\ ==\ 0)\ \{}
\DoxyCodeLine{01000\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_lens\_mat((CData\ *)cdata);}
\DoxyCodeLine{01001\ \ \ \}}
\DoxyCodeLine{01002\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_lens\_mat;}
\DoxyCodeLine{01003\ \}}
\DoxyCodeLine{01004\ }
\DoxyCodeLine{01008\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{01009\ do\_get\_lens\_mat\_inv(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01010\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_lens\_mat\_inv)\ ==\ 0)\ \{}
\DoxyCodeLine{01011\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&lens\_mat\ =\ do\_get\_lens\_mat(cdata);}
\DoxyCodeLine{01012\ \ \ \ \ ((CData\ *)cdata)-\/>\_lens\_mat\_inv.invert\_from(lens\_mat);}
\DoxyCodeLine{01013\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_adjust\_comp\_flags((CData\ *)cdata,\ 0,\ CF\_lens\_mat\_inv);}
\DoxyCodeLine{01014\ \ \ \}}
\DoxyCodeLine{01015\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_lens\_mat\_inv;}
\DoxyCodeLine{01016\ \}}
\DoxyCodeLine{01017\ }
\DoxyCodeLine{01021\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{01022\ do\_set\_interocular\_distance(CData\ *cdata,\ PN\_stdfloat\ interocular\_distance)\ \{}
\DoxyCodeLine{01023\ \ \ nassertv(!cnan(interocular\_distance));}
\DoxyCodeLine{01024\ \ \ cdata-\/>\_interocular\_distance\ =\ interocular\_distance;}
\DoxyCodeLine{01025\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_interocular\_distance\ ==\ 0.0f)\ \{}
\DoxyCodeLine{01026\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_interocular\_distance,\ 0);}
\DoxyCodeLine{01027\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01028\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_interocular\_distance);}
\DoxyCodeLine{01029\ \ \ \}}
\DoxyCodeLine{01030\ }
\DoxyCodeLine{01031\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat,\ 0);}
\DoxyCodeLine{01032\ \}}
\DoxyCodeLine{01033\ }
\DoxyCodeLine{01037\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{01038\ do\_set\_convergence\_distance(CData\ *cdata,\ PN\_stdfloat\ convergence\_distance)\ \{}
\DoxyCodeLine{01039\ \ \ nassertv(!cnan(convergence\_distance));}
\DoxyCodeLine{01040\ \ \ cdata-\/>\_convergence\_distance\ =\ convergence\_distance;}
\DoxyCodeLine{01041\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_convergence\_distance\ ==\ 0.0f)\ \{}
\DoxyCodeLine{01042\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ UF\_convergence\_distance,\ 0);}
\DoxyCodeLine{01043\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01044\ \ \ \ \ do\_adjust\_user\_flags(cdata,\ 0,\ UF\_convergence\_distance);}
\DoxyCodeLine{01045\ \ \ \}}
\DoxyCodeLine{01046\ }
\DoxyCodeLine{01047\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_mat,\ 0);}
\DoxyCodeLine{01048\ \}}
\DoxyCodeLine{01049\ }
\DoxyCodeLine{01053\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{01054\ do\_set\_view\_mat(CData\ *cdata,\ \textcolor{keyword}{const}\ LMatrix4\ \&view\_mat)\ \{}
\DoxyCodeLine{01055\ \ \ nassertv(!view\_mat.is\_nan());}
\DoxyCodeLine{01056\ \ \ cdata-\/>\_lens\_mat\ =\ view\_mat;}
\DoxyCodeLine{01057\ \ \ do\_adjust\_user\_flags(cdata,\ UF\_view\_vector\ |\ UF\_view\_hpr,}
\DoxyCodeLine{01058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ UF\_view\_mat);}
\DoxyCodeLine{01059\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{01060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv\ |}
\DoxyCodeLine{01061\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_lens\_mat\_inv\ |\ CF\_view\_hpr\ |\ CF\_view\_vector,}
\DoxyCodeLine{01062\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_lens\_mat);}
\DoxyCodeLine{01063\ \ \ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(cdata);}
\DoxyCodeLine{01064\ \}}
\DoxyCodeLine{01065\ }
\DoxyCodeLine{01069\ \textcolor{keyword}{const}\ LMatrix4\ \&Lens::}
\DoxyCodeLine{01070\ do\_get\_view\_mat(\textcolor{keyword}{const}\ CData\ *cdata)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01071\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_lens\_mat)\ ==\ 0)\ \{}
\DoxyCodeLine{01072\ \ \ \ \ ((\mbox{\hyperlink{classLens}{Lens}}\ *)\textcolor{keyword}{this})-\/>do\_compute\_lens\_mat((CData\ *)cdata);}
\DoxyCodeLine{01073\ \ \ \}}
\DoxyCodeLine{01074\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_lens\_mat;}
\DoxyCodeLine{01075\ \}}
\DoxyCodeLine{01076\ }
\DoxyCodeLine{01080\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{Lens::}}}
\DoxyCodeLine{01081\ \mbox{\hyperlink{classLens_afacad54378363480619132e5d7467212}{do\_throw\_change\_event}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01082\ \ \ ++(cdata-\/>\_last\_change);}
\DoxyCodeLine{01083\ }
\DoxyCodeLine{01084\ \ \ \textcolor{keywordflow}{if}\ (!cdata-\/>\_change\_event.empty())\ \{}
\DoxyCodeLine{01085\ \ \ \ \ throw\_event(cdata-\/>\_change\_event,\ \textcolor{keyword}{this});}
\DoxyCodeLine{01086\ \ \ \}}
\DoxyCodeLine{01087\ }
\DoxyCodeLine{01088\ \ \ \textcolor{keywordflow}{if}\ (!cdata-\/>\_geom\_data.is\_null())\ \{}
\DoxyCodeLine{01089\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_geom\_data-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{01090\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ one's\ using\ the\ data\ any\ more\ (there\ are\ no\ references\ to\ it\ other}}
\DoxyCodeLine{01091\ \ \ \ \ \ \ \textcolor{comment}{//\ than\ this\ one),\ so\ don't\ bother\ to\ recompute\ it;\ just\ release\ it.}}
\DoxyCodeLine{01092\ \ \ \ \ \ \ cdata-\/>\_geom\_data.clear();}
\DoxyCodeLine{01093\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01094\ \ \ \ \ \ \ \textcolor{comment}{//\ Someone\ still\ has\ a\ handle\ to\ the\ data,\ so\ recompute\ it\ for\ them.}}
\DoxyCodeLine{01095\ \ \ \ \ \ \ do\_define\_geom\_data(cdata);}
\DoxyCodeLine{01096\ \ \ \ \ \}}
\DoxyCodeLine{01097\ \ \ \}}
\DoxyCodeLine{01098\ \}}
\DoxyCodeLine{01099\ }
\DoxyCodeLine{01111\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{Lens::}}}
\DoxyCodeLine{01112\ \mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata,}
\DoxyCodeLine{01113\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LPoint3\ \&near\_point,\ LPoint3\ \&far\_point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01114\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\_inv\ =\ do\_get\_projection\_mat\_inv(cdata);}
\DoxyCodeLine{01115\ \ \ \{}
\DoxyCodeLine{01116\ \ \ \ \ LVecBase4\ full(point2d[0],\ point2d[1],\ -\/1.0f,\ 1.0f);}
\DoxyCodeLine{01117\ \ \ \ \ full\ =\ projection\_mat\_inv.xform(full);}
\DoxyCodeLine{01118\ }
\DoxyCodeLine{01119\ \ \ \ \ PN\_stdfloat\ recip\_full3\ =\ 1.0\ /\ max((\textcolor{keywordtype}{double})full[3],\ (\textcolor{keywordtype}{double})lens\_far\_limit);}
\DoxyCodeLine{01120\ \ \ \ \ near\_point.set(full[0]\ *\ recip\_full3,}
\DoxyCodeLine{01121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ full[1]\ *\ recip\_full3,}
\DoxyCodeLine{01122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ full[2]\ *\ recip\_full3);}
\DoxyCodeLine{01123\ \ \ \}}
\DoxyCodeLine{01124\ \ \ \{}
\DoxyCodeLine{01125\ \ \ \ \ LVecBase4\ full(point2d[0],\ point2d[1],\ 1.0f,\ 1.0f);}
\DoxyCodeLine{01126\ \ \ \ \ full\ =\ projection\_mat\_inv.xform(full);}
\DoxyCodeLine{01127\ }
\DoxyCodeLine{01128\ \ \ \ \ \textcolor{comment}{//\ We\ can\ truncate\ the\ weight\ factor\ at\ near\ 0.\ \ If\ it\ goes\ too\ close\ to}}
\DoxyCodeLine{01129\ \ \ \ \ \textcolor{comment}{//\ zero,\ or\ becomes\ negative,\ the\ far\ plane\ moves\ out\ past\ infinity\ and}}
\DoxyCodeLine{01130\ \ \ \ \ \textcolor{comment}{//\ comes\ back\ in\ behind\ the\ lens,\ which\ is\ just\ crazy.\ \ Truncating\ it\ to}}
\DoxyCodeLine{01131\ \ \ \ \ \textcolor{comment}{//\ zero\ keeps\ the\ far\ plane\ from\ moving\ too\ far\ out.}}
\DoxyCodeLine{01132\ \ \ \ \ PN\_stdfloat\ recip\_full3\ =\ 1.0\ /\ max((\textcolor{keywordtype}{double})full[3],\ (\textcolor{keywordtype}{double})lens\_far\_limit);}
\DoxyCodeLine{01133\ \ \ \ \ far\_point.set(full[0]\ *\ recip\_full3,}
\DoxyCodeLine{01134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ full[1]\ *\ recip\_full3,}
\DoxyCodeLine{01135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ full[2]\ *\ recip\_full3);}
\DoxyCodeLine{01136\ \ \ \}}
\DoxyCodeLine{01137\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01138\ \}}
\DoxyCodeLine{01139\ }
\DoxyCodeLine{01145\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a33d7829d0a3b7e45affb56fbf5918047}{Lens::}}}
\DoxyCodeLine{01146\ \mbox{\hyperlink{classLens_a33d7829d0a3b7e45affb56fbf5918047}{do\_extrude\_depth}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata,}
\DoxyCodeLine{01147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LPoint3\ \&point3d)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01148\ \ \ LPoint3\ near\_point,\ far\_point;}
\DoxyCodeLine{01149\ \ \ \textcolor{keywordtype}{bool}\ result\ =\ extrude(point2d,\ near\_point,\ far\_point);}
\DoxyCodeLine{01150\ }
\DoxyCodeLine{01151\ \ \ \textcolor{comment}{//\ The\ depth\ point\ is,\ by\ convention,\ in\ the\ range\ -\/1\ to\ 1.\ \ Scale\ this\ to\ 0}}
\DoxyCodeLine{01152\ \ \ \textcolor{comment}{//\ ..\ 1\ for\ the\ linear\ interpolation.}}
\DoxyCodeLine{01153\ \ \ PN\_stdfloat\ t\ =\ point2d[2]\ *\ 0.5\ +\ 0.5;}
\DoxyCodeLine{01154\ \ \ point3d\ =\ near\_point\ +\ (far\_point\ -\/\ near\_point)\ *\ t;}
\DoxyCodeLine{01155\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01156\ \}}
\DoxyCodeLine{01157\ }
\DoxyCodeLine{01162\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a7e9b27f70cc860b3d461a8e4c1889774}{Lens::}}}
\DoxyCodeLine{01163\ \mbox{\hyperlink{classLens_a7e9b27f70cc860b3d461a8e4c1889774}{do\_extrude\_depth\_with\_mat}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata,}
\DoxyCodeLine{01164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LPoint3\ \&point3d)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01165\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\_inv\ =\ do\_get\_projection\_mat\_inv(cdata);}
\DoxyCodeLine{01166\ \ \ point3d\ =\ projection\_mat\_inv.xform\_point\_general(point2d);}
\DoxyCodeLine{01167\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01168\ \}}
\DoxyCodeLine{01169\ }
\DoxyCodeLine{01191\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a5ae7bf7799e8a214caff69bd0a29d2c3}{Lens::}}}
\DoxyCodeLine{01192\ \mbox{\hyperlink{classLens_a5ae7bf7799e8a214caff69bd0a29d2c3}{do\_extrude\_vec}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata,\ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LVector3\ \&vec)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01193\ \ \ vec\ =\ LVector3::forward(cdata-\/>\_cs)\ *\ do\_get\_lens\_mat(cdata);}
\DoxyCodeLine{01194\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01195\ \}}
\DoxyCodeLine{01196\ }
\DoxyCodeLine{01211\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLens_a57b1d90a995ab95069a546914c564cd3}{Lens::}}}
\DoxyCodeLine{01212\ \mbox{\hyperlink{classLens_a57b1d90a995ab95069a546914c564cd3}{do\_project}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata,\ \textcolor{keyword}{const}\ LPoint3\ \&point3d,\ LPoint3\ \&point2d)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01213\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&projection\_mat\ =\ do\_get\_projection\_mat(cdata);}
\DoxyCodeLine{01214\ \ \ LVecBase4\ full(point3d[0],\ point3d[1],\ point3d[2],\ 1.0f);}
\DoxyCodeLine{01215\ \ \ full\ =\ projection\_mat.xform(full);}
\DoxyCodeLine{01216\ \ \ \textcolor{keywordflow}{if}\ (full[3]\ ==\ 0.0f)\ \{}
\DoxyCodeLine{01217\ \ \ \ \ point2d.set(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{01218\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01219\ \ \ \}}
\DoxyCodeLine{01220\ \ \ PN\_stdfloat\ recip\_full3\ =\ 1.0f/full[3];}
\DoxyCodeLine{01221\ \ \ point2d.set(full[0]\ *\ recip\_full3,\ full[1]\ *\ recip\_full3,\ full[2]\ *\ recip\_full3);}
\DoxyCodeLine{01222\ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{01223\ \ \ \ \ (full[3]\ >\ 0.0f)\ \&\&}
\DoxyCodeLine{01224\ \ \ \ \ (point2d[0]\ >=\ -\/1.0f\ -\/\ NEARLY\_ZERO(PN\_stdfloat))\ \&\&\ (point2d[0]\ <=\ 1.0f\ +\ NEARLY\_ZERO(PN\_stdfloat))\ \&\&}
\DoxyCodeLine{01225\ \ \ \ \ (point2d[1]\ >=\ -\/1.0f\ -\/\ NEARLY\_ZERO(PN\_stdfloat))\ \&\&\ (point2d[1]\ <=\ 1.0f\ +\ NEARLY\_ZERO(PN\_stdfloat));}
\DoxyCodeLine{01226\ \}}
\DoxyCodeLine{01227\ }
\DoxyCodeLine{01232\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_af2b19813e4ccd750e4c5043d28375038}{Lens::}}}
\DoxyCodeLine{01233\ \mbox{\hyperlink{classLens_af2b19813e4ccd750e4c5043d28375038}{do\_compute\_film\_size}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01234\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ (UF\_min\_fov\ |\ UF\_focal\_length))\ ==\ (UF\_min\_fov\ |\ UF\_focal\_length))\ \{}
\DoxyCodeLine{01235\ \ \ \ \ \textcolor{comment}{//\ If\ we\ just\ have\ a\ min\ FOV\ and\ a\ focal\ length,\ that\ determines\ the}}
\DoxyCodeLine{01236\ \ \ \ \ \textcolor{comment}{//\ smaller\ of\ the\ two\ film\_sizes,\ and\ the\ larger\ is\ simply\ chosen}}
\DoxyCodeLine{01237\ \ \ \ \ \textcolor{comment}{//\ according\ to\ the\ aspect\ ratio.}}
\DoxyCodeLine{01238\ \ \ \ \ PN\_stdfloat\ fs\ =\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{fov\_to\_film}}(cdata-\/>\_min\_fov,\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01239\ \ \ \ \ nassertv((cdata-\/>\_user\_flags\ \&\ UF\_aspect\_ratio)\ !=\ 0\ ||}
\DoxyCodeLine{01240\ \ \ \ \ \ \ \ \ \ \ \ \ \ (cdata-\/>\_comp\_flags\ \&\ CF\_aspect\_ratio)\ !=\ 0);}
\DoxyCodeLine{01241\ }
\DoxyCodeLine{01242\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_aspect\_ratio\ <\ 1.0f)\ \{}
\DoxyCodeLine{01243\ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ fs\ /\ cdata-\/>\_aspect\_ratio;}
\DoxyCodeLine{01244\ \ \ \ \ \ \ cdata-\/>\_film\_size[0]\ =\ fs;}
\DoxyCodeLine{01245\ }
\DoxyCodeLine{01246\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01247\ \ \ \ \ \ \ cdata-\/>\_film\_size[0]\ =\ fs\ *\ cdata-\/>\_aspect\_ratio;}
\DoxyCodeLine{01248\ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ fs;}
\DoxyCodeLine{01249\ \ \ \ \ \}}
\DoxyCodeLine{01250\ }
\DoxyCodeLine{01251\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01252\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_film\_width)\ ==\ 0)\ \{}
\DoxyCodeLine{01253\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ (UF\_hfov\ |\ UF\_focal\_length))\ ==\ (UF\_hfov\ |\ UF\_focal\_length))\ \{}
\DoxyCodeLine{01254\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[0]\ =\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{fov\_to\_film}}(cdata-\/>\_fov[0],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01255\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01256\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[0]\ =\ 1.0f;}
\DoxyCodeLine{01257\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01258\ \ \ \ \ \}}
\DoxyCodeLine{01259\ }
\DoxyCodeLine{01260\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_film\_height)\ ==\ 0)\ \{}
\DoxyCodeLine{01261\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ (UF\_vfov\ |\ UF\_focal\_length))\ ==\ (UF\_vfov\ |\ UF\_focal\_length))\ \{}
\DoxyCodeLine{01262\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{fov\_to\_film}}(cdata-\/>\_fov[1],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01263\ }
\DoxyCodeLine{01264\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ (UF\_hfov\ |\ UF\_vfov))\ ==\ (UF\_hfov\ |\ UF\_vfov))\ \{}
\DoxyCodeLine{01265\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ focal\ length,\ but\ we\ have\ an\ explicit\ vfov\ and}}
\DoxyCodeLine{01266\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ hfov,\ we\ can\ infer\ the\ focal\ length\ is\ whatever\ makes\ the\ film}}
\DoxyCodeLine{01267\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ width,\ above,\ be\ what\ it\ is.}}
\DoxyCodeLine{01268\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_comp\_flags\ \&\ CF\_focal\_length)\ ==\ 0)\ \{}
\DoxyCodeLine{01269\ \ \ \ \ \ \ \ \ \ \ cdata-\/>\_focal\_length\ =\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{fov\_to\_focal\_length}}(cdata-\/>\_fov[0],\ cdata-\/>\_film\_size[0],\ \textcolor{keyword}{true});}
\DoxyCodeLine{01270\ \ \ \ \ \ \ \ \ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_focal\_length);}
\DoxyCodeLine{01271\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01272\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{fov\_to\_film}}(cdata-\/>\_fov[1],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01273\ }
\DoxyCodeLine{01274\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_aspect\_ratio)\ !=\ 0\ ||}
\DoxyCodeLine{01275\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (cdata-\/>\_comp\_flags\ \&\ CF\_aspect\_ratio)\ !=\ 0)\ \{}
\DoxyCodeLine{01276\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ cdata-\/>\_film\_size[0]\ /\ cdata-\/>\_aspect\_ratio;}
\DoxyCodeLine{01277\ }
\DoxyCodeLine{01278\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01279\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Default\ is\ an\ aspect\ ratio\ of\ 1.}}
\DoxyCodeLine{01280\ \ \ \ \ \ \ \ \ cdata-\/>\_film\_size[1]\ =\ cdata-\/>\_film\_size[0];}
\DoxyCodeLine{01281\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01282\ \ \ \ \ \}}
\DoxyCodeLine{01283\ \ \ \}}
\DoxyCodeLine{01284\ }
\DoxyCodeLine{01285\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_film\_size);}
\DoxyCodeLine{01286\ \}}
\DoxyCodeLine{01287\ }
\DoxyCodeLine{01292\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a03fb4b5e5588d0851a3880401e43b158}{Lens::}}}
\DoxyCodeLine{01293\ \mbox{\hyperlink{classLens_a03fb4b5e5588d0851a3880401e43b158}{do\_compute\_focal\_length}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01294\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_focal\_length)\ ==\ 0)\ \{}
\DoxyCodeLine{01295\ \ \ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&film\_size\ =\ do\_get\_film\_size(cdata);}
\DoxyCodeLine{01296\ \ \ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&fov\ =\ do\_get\_fov(cdata);}
\DoxyCodeLine{01297\ \ \ \ \ cdata-\/>\_focal\_length\ =\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{fov\_to\_focal\_length}}(fov[0],\ film\_size[0],\ \textcolor{keyword}{true});}
\DoxyCodeLine{01298\ \ \ \}}
\DoxyCodeLine{01299\ }
\DoxyCodeLine{01300\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_focal\_length);}
\DoxyCodeLine{01301\ \}}
\DoxyCodeLine{01302\ }
\DoxyCodeLine{01307\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_ad2ed81cce841b7e512dc38f0b28ec3b8}{Lens::}}}
\DoxyCodeLine{01308\ \mbox{\hyperlink{classLens_ad2ed81cce841b7e512dc38f0b28ec3b8}{do\_compute\_fov}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01309\ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&film\_size\ =\ do\_get\_film\_size(cdata);}
\DoxyCodeLine{01310\ }
\DoxyCodeLine{01311\ \ \ \textcolor{keywordtype}{bool}\ got\_hfov\ =\ ((cdata-\/>\_user\_flags\ \&\ UF\_hfov)\ !=\ 0);}
\DoxyCodeLine{01312\ \ \ \textcolor{keywordtype}{bool}\ got\_vfov\ =\ ((cdata-\/>\_user\_flags\ \&\ UF\_vfov)\ !=\ 0);}
\DoxyCodeLine{01313\ \ \ \textcolor{keywordtype}{bool}\ got\_min\_fov\ =\ ((cdata-\/>\_user\_flags\ \&\ UF\_min\_fov)\ !=\ 0);}
\DoxyCodeLine{01314\ }
\DoxyCodeLine{01315\ \ \ \textcolor{keywordflow}{if}\ (!got\_hfov\ \&\&\ !got\_vfov\ \&\&\ !got\_min\_fov)\ \{}
\DoxyCodeLine{01316\ \ \ \ \ \textcolor{comment}{//\ If\ the\ user\ hasn't\ specified\ any\ FOV,\ we\ have\ to\ compute\ it.}}
\DoxyCodeLine{01317\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_focal\_length)\ !=\ 0)\ \{}
\DoxyCodeLine{01318\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ FOV\ is\ determined\ from\ the\ film\ size\ and\ focal\ length.}}
\DoxyCodeLine{01319\ \ \ \ \ \ \ cdata-\/>\_fov[0]\ =\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{film\_to\_fov}}(film\_size[0],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01320\ \ \ \ \ \ \ cdata-\/>\_fov[1]\ =\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{film\_to\_fov}}(film\_size[1],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01321\ \ \ \ \ \ \ got\_hfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01322\ \ \ \ \ \ \ got\_vfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01323\ }
\DoxyCodeLine{01324\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01325\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can't\ compute\ the\ FOV;\ take\ the\ default.}}
\DoxyCodeLine{01326\ \ \ \ \ \ \ cdata-\/>\_min\_fov\ =\ default\_fov;}
\DoxyCodeLine{01327\ \ \ \ \ \ \ got\_min\_fov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01328\ \ \ \ \ \}}
\DoxyCodeLine{01329\ \ \ \}}
\DoxyCodeLine{01330\ }
\DoxyCodeLine{01331\ \ \ \textcolor{keywordflow}{if}\ (got\_min\_fov)\ \{}
\DoxyCodeLine{01332\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ just\ a\ min\_fov,\ use\ it\ to\ derive\ whichever\ fov\ is\ smaller.}}
\DoxyCodeLine{01333\ \ \ \ \ \textcolor{keywordflow}{if}\ (film\_size[0]\ <\ film\_size[1])\ \{}
\DoxyCodeLine{01334\ \ \ \ \ \ \ cdata-\/>\_fov[0]\ =\ cdata-\/>\_min\_fov;}
\DoxyCodeLine{01335\ \ \ \ \ \ \ got\_hfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01336\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01337\ \ \ \ \ \ \ cdata-\/>\_fov[1]\ =\ cdata-\/>\_min\_fov;}
\DoxyCodeLine{01338\ \ \ \ \ \ \ got\_vfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01339\ \ \ \ \ \}}
\DoxyCodeLine{01340\ \ \ \}}
\DoxyCodeLine{01341\ }
\DoxyCodeLine{01342\ \ \ \textcolor{comment}{//\ Now\ compute\ whichever\ fov\ is\ remaining.}}
\DoxyCodeLine{01343\ \ \ \textcolor{keywordflow}{if}\ (!got\_hfov)\ \{}
\DoxyCodeLine{01344\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_focal\_length)\ ==\ 0\ \&\&}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ (cdata-\/>\_comp\_flags\ \&\ CF\_focal\_length)\ ==\ 0)\ \{}
\DoxyCodeLine{01346\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ an\ explicit\ focal\ length,\ we\ can\ infer\ it\ from\ the}}
\DoxyCodeLine{01347\ \ \ \ \ \ \ \textcolor{comment}{//\ above.}}
\DoxyCodeLine{01348\ \ \ \ \ \ \ nassertv(got\_vfov);}
\DoxyCodeLine{01349\ \ \ \ \ \ \ cdata-\/>\_focal\_length\ =\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{fov\_to\_focal\_length}}(cdata-\/>\_fov[1],\ film\_size[1],\ \textcolor{keyword}{true});}
\DoxyCodeLine{01350\ \ \ \ \ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_focal\_length);}
\DoxyCodeLine{01351\ \ \ \ \ \}}
\DoxyCodeLine{01352\ \ \ \ \ cdata-\/>\_fov[0]\ =\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{film\_to\_fov}}(film\_size[0],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01353\ \ \ \ \ got\_hfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01354\ \ \ \}}
\DoxyCodeLine{01355\ }
\DoxyCodeLine{01356\ \ \ \textcolor{keywordflow}{if}\ (!got\_vfov)\ \{}
\DoxyCodeLine{01357\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_focal\_length)\ ==\ 0\ \&\&}
\DoxyCodeLine{01358\ \ \ \ \ \ \ \ \ (cdata-\/>\_comp\_flags\ \&\ CF\_focal\_length)\ ==\ 0)\ \{}
\DoxyCodeLine{01359\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ an\ explicit\ focal\ length,\ we\ can\ infer\ it\ from\ the}}
\DoxyCodeLine{01360\ \ \ \ \ \ \ \textcolor{comment}{//\ above.}}
\DoxyCodeLine{01361\ \ \ \ \ \ \ nassertv(got\_hfov);}
\DoxyCodeLine{01362\ \ \ \ \ \ \ cdata-\/>\_focal\_length\ =\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{fov\_to\_focal\_length}}(cdata-\/>\_fov[0],\ film\_size[0],\ \textcolor{keyword}{true});}
\DoxyCodeLine{01363\ \ \ \ \ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_focal\_length);}
\DoxyCodeLine{01364\ \ \ \ \ \}}
\DoxyCodeLine{01365\ \ \ \ \ cdata-\/>\_fov[1]\ =\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{film\_to\_fov}}(film\_size[1],\ cdata-\/>\_focal\_length,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01366\ \ \ \ \ got\_vfov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01367\ \ \ \}}
\DoxyCodeLine{01368\ }
\DoxyCodeLine{01369\ \ \ \textcolor{keywordflow}{if}\ (!got\_min\_fov)\ \{}
\DoxyCodeLine{01370\ \ \ \ \ cdata-\/>\_min\_fov\ =\ film\_size[0]\ <\ film\_size[1]\ ?\ cdata-\/>\_fov[0]\ :\ cdata-\/>\_fov[1];}
\DoxyCodeLine{01371\ \ \ \ \ got\_min\_fov\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01372\ \ \ \}}
\DoxyCodeLine{01373\ }
\DoxyCodeLine{01374\ \ \ nassertv(got\_hfov\ \&\&\ got\_vfov\ \&\&\ got\_min\_fov);}
\DoxyCodeLine{01375\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_fov);}
\DoxyCodeLine{01376\ \}}
\DoxyCodeLine{01377\ }
\DoxyCodeLine{01382\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{Lens::}}}
\DoxyCodeLine{01383\ \mbox{\hyperlink{classLens_ab8da9de99666852877fc5674df2fdf22}{do\_compute\_aspect\_ratio}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01384\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_aspect\_ratio)\ ==\ 0)\ \{}
\DoxyCodeLine{01385\ \ \ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&film\_size\ =\ do\_get\_film\_size(cdata);}
\DoxyCodeLine{01386\ \ \ \ \ \textcolor{keywordflow}{if}\ (film\_size[1]\ ==\ 0.0f)\ \{}
\DoxyCodeLine{01387\ \ \ \ \ \ \ cdata-\/>\_aspect\_ratio\ =\ 1.0f;}
\DoxyCodeLine{01388\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01389\ \ \ \ \ \ \ cdata-\/>\_aspect\_ratio\ =\ film\_size[0]\ /\ film\_size[1];}
\DoxyCodeLine{01390\ \ \ \ \ \}}
\DoxyCodeLine{01391\ \ \ \}}
\DoxyCodeLine{01392\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_aspect\_ratio);}
\DoxyCodeLine{01393\ \}}
\DoxyCodeLine{01394\ }
\DoxyCodeLine{01398\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a4e189f8a26ebd2e816d30942b70b9cbf}{Lens::}}}
\DoxyCodeLine{01399\ \mbox{\hyperlink{classLens_a4e189f8a26ebd2e816d30942b70b9cbf}{do\_compute\_view\_hpr}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01400\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_view\_hpr)\ ==\ 0)\ \{}
\DoxyCodeLine{01401\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&view\_mat\ =\ do\_get\_view\_mat(cdata);}
\DoxyCodeLine{01402\ \ \ \ \ LVecBase3\ scale,\ shear,\ translate;}
\DoxyCodeLine{01403\ \ \ \ \ \mbox{\hyperlink{compose__matrix__src_8cxx_a499c787e84555f9a09c93f526b7dbc0d}{decompose\_matrix}}(view\_mat,\ scale,\ shear,\ cdata-\/>\_view\_hpr,\ translate,\ cdata-\/>\_cs);}
\DoxyCodeLine{01404\ \ \ \}}
\DoxyCodeLine{01405\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_view\_hpr);}
\DoxyCodeLine{01406\ \}}
\DoxyCodeLine{01407\ }
\DoxyCodeLine{01411\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a9611d8fc684dc3cb123b411f79a4940e}{Lens::}}}
\DoxyCodeLine{01412\ \mbox{\hyperlink{classLens_a9611d8fc684dc3cb123b411f79a4940e}{do\_compute\_view\_vector}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01413\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_view\_vector)\ ==\ 0)\ \{}
\DoxyCodeLine{01414\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&view\_mat\ =\ do\_get\_view\_mat(cdata);}
\DoxyCodeLine{01415\ \ \ \ \ cdata-\/>\_view\_vector\ =\ LVector3::forward(cdata-\/>\_cs)\ *\ view\_mat;}
\DoxyCodeLine{01416\ \ \ \ \ cdata-\/>\_up\_vector\ =\ LVector3::up(cdata-\/>\_cs)\ *\ view\_mat;}
\DoxyCodeLine{01417\ \ \ \}}
\DoxyCodeLine{01418\ \ \ do\_adjust\_comp\_flags(cdata,\ 0,\ CF\_view\_vector);}
\DoxyCodeLine{01419\ \}}
\DoxyCodeLine{01420\ }
\DoxyCodeLine{01425\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a60750bf4b3a6b3840bfc029d8920ba52}{Lens::}}}
\DoxyCodeLine{01426\ \mbox{\hyperlink{classLens_a60750bf4b3a6b3840bfc029d8920ba52}{do\_compute\_projection\_mat}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *lens\_cdata)\ \{}
\DoxyCodeLine{01427\ \ \ \textcolor{comment}{//\ This\ is\ the\ implementation\ used\ by\ non-\/linear\ lenses.\ \ The\ linear\ lenses}}
\DoxyCodeLine{01428\ \ \ \textcolor{comment}{//\ (PerspectiveLens\ and\ OrthographicLens)\ will\ customize\ this\ method}}
\DoxyCodeLine{01429\ \ \ \textcolor{comment}{//\ appropriate\ for\ themselves.}}
\DoxyCodeLine{01430\ }
\DoxyCodeLine{01431\ \ \ \textcolor{comment}{//\ By\ convention,\ the\ coordinate-\/system\ conversion\ is\ baked\ into\ the}}
\DoxyCodeLine{01432\ \ \ \textcolor{comment}{//\ projection\ mat.\ \ Our\ non-\/linear\ lenses\ are\ implemented\ with\ code\ that}}
\DoxyCodeLine{01433\ \ \ \textcolor{comment}{//\ assumes\ CS\_zup\_right,\ so\ we\ bake\ the\ appropriate\ rotation\ in\ here.}}
\DoxyCodeLine{01434\ \ \ CoordinateSystem\ cs\ =\ lens\_cdata-\/>\_cs;}
\DoxyCodeLine{01435\ \ \ \textcolor{keywordflow}{if}\ (cs\ ==\ CS\_default)\ \{}
\DoxyCodeLine{01436\ \ \ \ \ cs\ =\ get\_default\_coordinate\_system();}
\DoxyCodeLine{01437\ \ \ \}}
\DoxyCodeLine{01438\ \ \ lens\_cdata-\/>\_projection\_mat\ =\ LMatrix4::convert\_mat(cs,\ CS\_zup\_right);}
\DoxyCodeLine{01439\ \ \ lens\_cdata-\/>\_projection\_mat\_inv\ =\ LMatrix4::convert\_mat(CS\_zup\_right,\ cs);}
\DoxyCodeLine{01440\ }
\DoxyCodeLine{01441\ \ \ \textcolor{comment}{//\ We\ don't\ apply\ any\ leftright\ offsets\ for\ non-\/linear\ lenses\ by\ default,\ at}}
\DoxyCodeLine{01442\ \ \ \textcolor{comment}{//\ least\ not\ here\ in\ the\ projection\ matrix.}}
\DoxyCodeLine{01443\ \ \ lens\_cdata-\/>\_projection\_mat\_left\ =\ lens\_cdata-\/>\_projection\_mat\_right\ =\ lens\_cdata-\/>\_projection\_mat;}
\DoxyCodeLine{01444\ \ \ lens\_cdata-\/>\_projection\_mat\_left\_inv\ =\ lens\_cdata-\/>\_projection\_mat\_right\_inv\ =\ lens\_cdata-\/>\_projection\_mat\_inv;}
\DoxyCodeLine{01445\ }
\DoxyCodeLine{01446\ \ \ do\_adjust\_comp\_flags(lens\_cdata,\ 0,\ CF\_projection\_mat\ |\ CF\_projection\_mat\_inv\ |}
\DoxyCodeLine{01447\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv);}
\DoxyCodeLine{01448\ \}}
\DoxyCodeLine{01449\ }
\DoxyCodeLine{01454\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a44e7040299882795403421a3a3d2025c}{Lens::}}}
\DoxyCodeLine{01455\ \mbox{\hyperlink{classLens_a44e7040299882795403421a3a3d2025c}{do\_compute\_film\_mat}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01456\ \ \ \textcolor{comment}{//\ The\ lens\ will\ return\ a\ point\ in\ the\ range\ [-\/film\_size2,\ film\_size2]\ in}}
\DoxyCodeLine{01457\ \ \ \textcolor{comment}{//\ each\ dimension.\ \ Convert\ this\ to\ [-\/1,\ 1],\ and\ also\ apply\ the\ offset.}}
\DoxyCodeLine{01458\ }
\DoxyCodeLine{01459\ \ \ \textcolor{comment}{//\ We\ declare\ these\ two\ as\ local\ variables,\ instead\ of\ references,\ to\ work}}
\DoxyCodeLine{01460\ \ \ \textcolor{comment}{//\ around\ a\ VC7\ compiler\ bug.}}
\DoxyCodeLine{01461\ \ \ LVecBase2\ film\_size\ =\ do\_get\_film\_size(cdata);}
\DoxyCodeLine{01462\ \ \ LVector2\ film\_offset\ =\ do\_get\_film\_offset(cdata);}
\DoxyCodeLine{01463\ }
\DoxyCodeLine{01464\ \ \ PN\_stdfloat\ scale\_x\ =\ 2.0f\ /\ film\_size[0];}
\DoxyCodeLine{01465\ \ \ PN\_stdfloat\ scale\_y\ =\ 2.0f\ /\ film\_size[1];}
\DoxyCodeLine{01466\ \ \ cdata-\/>\_film\_mat.set(scale\_x,\ \ \ \ \ \ 0.0f,\ \ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{01467\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ scale\_y,\ \ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{01468\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ \ \ \ 0.0f,\ \ \ 1.0f,\ \ 0.0f,}
\DoxyCodeLine{01469\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/film\_offset[0]\ *\ scale\_x,\ -\/film\_offset[1]\ *\ scale\_y,\ 0.0f,\ \ 1.0f);}
\DoxyCodeLine{01470\ }
\DoxyCodeLine{01471\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_keystone)\ !=\ 0)\ \{}
\DoxyCodeLine{01472\ \ \ \ \ cdata-\/>\_film\_mat\ =\ LMatrix4(1.0f,\ 0.0f,\ cdata-\/>\_keystone[0],\ cdata-\/>\_keystone[0],}
\DoxyCodeLine{01473\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ 1.0f,\ cdata-\/>\_keystone[1],\ cdata-\/>\_keystone[1],}
\DoxyCodeLine{01474\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ 0.0f,\ 1.0f,\ 0.0f,}
\DoxyCodeLine{01475\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ 0.0f,\ 0.0f,\ 1.0f)\ *\ cdata-\/>\_film\_mat;}
\DoxyCodeLine{01476\ \ \ \}}
\DoxyCodeLine{01477\ }
\DoxyCodeLine{01478\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_custom\_film\_mat)\ !=\ 0)\ \{}
\DoxyCodeLine{01479\ \ \ \ \ cdata-\/>\_film\_mat\ =\ cdata-\/>\_film\_mat\ *\ cdata-\/>\_custom\_film\_mat;}
\DoxyCodeLine{01480\ \ \ \}}
\DoxyCodeLine{01481\ }
\DoxyCodeLine{01482\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_film\_mat\_inv,\ CF\_film\_mat);}
\DoxyCodeLine{01483\ \}}
\DoxyCodeLine{01484\ }
\DoxyCodeLine{01489\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_a0565dc79f10a511428e4984755a9e491}{Lens::}}}
\DoxyCodeLine{01490\ \mbox{\hyperlink{classLens_a0565dc79f10a511428e4984755a9e491}{do\_compute\_lens\_mat}}(\mbox{\hyperlink{classLens_1_1CData}{CData}}\ *cdata)\ \{}
\DoxyCodeLine{01491\ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_view\_mat)\ ==\ 0)\ \{}
\DoxyCodeLine{01492\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_view\_hpr)\ !=\ 0)\ \{}
\DoxyCodeLine{01493\ \ \ \ \ \ \ \mbox{\hyperlink{compose__matrix__src_8cxx_aa46bdf9de1e1e04a5e2cdd7af6b39c64}{compose\_matrix}}(cdata-\/>\_lens\_mat,}
\DoxyCodeLine{01494\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LVecBase3(1.0f,\ 1.0f,\ 1.0f),}
\DoxyCodeLine{01495\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LVecBase3(0.0f,\ 0.0f,\ 0.0f),}
\DoxyCodeLine{01496\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cdata-\/>\_view\_hpr,}
\DoxyCodeLine{01497\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LVecBase3(0.0f,\ 0.0f,\ 0.0f),\ cdata-\/>\_cs);}
\DoxyCodeLine{01498\ }
\DoxyCodeLine{01499\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((cdata-\/>\_user\_flags\ \&\ UF\_view\_vector)\ !=\ 0)\ \{}
\DoxyCodeLine{01500\ \ \ \ \ \ \ \mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}}(cdata-\/>\_lens\_mat,\ cdata-\/>\_view\_vector,\ cdata-\/>\_up\_vector,\ cdata-\/>\_cs);}
\DoxyCodeLine{01501\ }
\DoxyCodeLine{01502\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01503\ \ \ \ \ \ \ cdata-\/>\_lens\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{01504\ \ \ \ \ \}}
\DoxyCodeLine{01505\ \ \ \}}
\DoxyCodeLine{01506\ \ \ do\_adjust\_comp\_flags(cdata,\ CF\_lens\_mat\_inv,\ CF\_lens\_mat);}
\DoxyCodeLine{01507\ \}}
\DoxyCodeLine{01508\ }
\DoxyCodeLine{01515\ PN\_stdfloat\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{Lens::}}}
\DoxyCodeLine{01516\ \mbox{\hyperlink{classLens_a3c294b80d234c650ec374d0aa2e69997}{fov\_to\_film}}(PN\_stdfloat,\ PN\_stdfloat,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01517\ \ \ \textcolor{keywordflow}{return}\ 1.0f;}
\DoxyCodeLine{01518\ \}}
\DoxyCodeLine{01519\ }
\DoxyCodeLine{01526\ PN\_stdfloat\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{Lens::}}}
\DoxyCodeLine{01527\ \mbox{\hyperlink{classLens_aa66420646af95a96b9ccedf68f49c9d5}{fov\_to\_focal\_length}}(PN\_stdfloat,\ PN\_stdfloat,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01528\ \ \ \textcolor{keywordflow}{return}\ 1.0f;}
\DoxyCodeLine{01529\ \}}
\DoxyCodeLine{01530\ }
\DoxyCodeLine{01537\ PN\_stdfloat\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{Lens::}}}
\DoxyCodeLine{01538\ \mbox{\hyperlink{classLens_ac83d03fc940e3168760649fd68c44971}{film\_to\_fov}}(PN\_stdfloat,\ PN\_stdfloat,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01539\ \ \ \textcolor{keywordflow}{return}\ default\_fov;}
\DoxyCodeLine{01540\ \}}
\DoxyCodeLine{01541\ }
\DoxyCodeLine{01552\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{01553\ do\_resequence\_fov\_triad(\textcolor{keyword}{const}\ CData\ *cdata,\ \textcolor{keywordtype}{char}\ \&newest,\ \textcolor{keywordtype}{char}\ \&older\_a,\ \textcolor{keywordtype}{char}\ \&older\_b)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01554\ \ \ nassertv(newest\ +\ older\_a\ +\ older\_b\ ==\ 3);}
\DoxyCodeLine{01555\ \ \ \textcolor{keywordflow}{switch}\ (newest)\ \{}
\DoxyCodeLine{01556\ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{01557\ \ \ \ \ newest\ =\ 2;}
\DoxyCodeLine{01558\ \ \ \ \ older\_a-\/-\/;}
\DoxyCodeLine{01559\ \ \ \ \ older\_b-\/-\/;}
\DoxyCodeLine{01560\ \ \ \ \ nassertv(older\_a\ +\ older\_b\ ==\ 1);}
\DoxyCodeLine{01561\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01562\ }
\DoxyCodeLine{01563\ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{01564\ \ \ \ \ newest\ =\ 2;}
\DoxyCodeLine{01565\ \ \ \ \ \textcolor{keywordflow}{if}\ (older\_a\ ==\ 2)\ \{}
\DoxyCodeLine{01566\ \ \ \ \ \ \ nassertv(older\_b\ ==\ 0);}
\DoxyCodeLine{01567\ \ \ \ \ \ \ older\_a\ =\ 1;}
\DoxyCodeLine{01568\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01569\ \ \ \ \ \ \ nassertv(older\_a\ ==\ 0\ \&\&\ older\_b\ ==\ 2);}
\DoxyCodeLine{01570\ \ \ \ \ \ \ older\_b\ =\ 1;}
\DoxyCodeLine{01571\ \ \ \ \ \}}
\DoxyCodeLine{01572\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01573\ }
\DoxyCodeLine{01574\ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{01575\ \ \ \ \ nassertv(older\_a\ +\ older\_b\ ==\ 1);}
\DoxyCodeLine{01576\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01577\ }
\DoxyCodeLine{01578\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01579\ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01580\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ fov\ sequence\ numbers\ in\ lens:\ "{}}}
\DoxyCodeLine{01581\ \ \ \ \ \ \ <<\ (int)newest\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ (\textcolor{keywordtype}{int})older\_a\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ (int)older\_b\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01582\ \ \ \ \ nassertv(\textcolor{keyword}{false});}
\DoxyCodeLine{01583\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01584\ \ \ \}}
\DoxyCodeLine{01585\ }
\DoxyCodeLine{01586\ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01587\ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01588\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Lens.do\_resequence\_fov\_triad():"{}};}
\DoxyCodeLine{01589\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 2;\ i\ >=\ 0;\ -\/-\/i)\ \{}
\DoxyCodeLine{01590\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_fov\_seq\ ==\ i)\ \{}
\DoxyCodeLine{01591\ \ \ \ \ \ \ \ \ gobj\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{01592\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ fov"{}};}
\DoxyCodeLine{01593\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cdata-\/>\_focal\_length\_seq\ ==\ i)\ \{}
\DoxyCodeLine{01594\ \ \ \ \ \ \ \ \ gobj\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{01595\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ focal\_length"{}};}
\DoxyCodeLine{01596\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cdata-\/>\_film\_size\_seq\ ==\ i)\ \{}
\DoxyCodeLine{01597\ \ \ \ \ \ \ \ \ gobj\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{01598\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ film\_size"{}};}
\DoxyCodeLine{01599\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01600\ \ \ \ \ \}}
\DoxyCodeLine{01601\ \ \ \ \ gobj\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{01602\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01603\ \ \ \}}
\DoxyCodeLine{01604\ \}}
\DoxyCodeLine{01605\ }
\DoxyCodeLine{01612\ \textcolor{keywordtype}{int}\ Lens::}
\DoxyCodeLine{01613\ do\_define\_geom\_data(CData\ *cdata)\ \{}
\DoxyCodeLine{01614\ \ \ \textcolor{keywordtype}{int}\ num\_segments\ =\ 1;}
\DoxyCodeLine{01615\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a52af0b8777ac289e2168a4e89cf698a3}{is\_linear}}())\ \{}
\DoxyCodeLine{01616\ \ \ \ \ num\_segments\ =\ lens\_geom\_segments;}
\DoxyCodeLine{01617\ \ \ \}}
\DoxyCodeLine{01618\ }
\DoxyCodeLine{01619\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_geom\_data\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01620\ \ \ \ \ cdata-\/>\_geom\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{01621\ \ \ \ \ \ \ (\textcolor{stringliteral}{"{}lens"{}},\ GeomVertexFormat::get\_v3(),}
\DoxyCodeLine{01622\ \ \ \ \ \ \ \ Geom::UH\_dynamic);}
\DoxyCodeLine{01623\ \ \ \}}
\DoxyCodeLine{01624\ \ \ cdata-\/>\_geom\_data-\/>unclean\_set\_num\_rows(num\_segments\ *\ 8\ +\ 2);}
\DoxyCodeLine{01625\ }
\DoxyCodeLine{01626\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(cdata-\/>\_geom\_data,\ InternalName::get\_vertex());}
\DoxyCodeLine{01627\ \ \ LPoint3\ near\_point,\ far\_point;}
\DoxyCodeLine{01628\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ si\ =\ 0;\ si\ <\ num\_segments;\ si++)\ \{}
\DoxyCodeLine{01629\ \ \ \ \ PN\_stdfloat\ t\ =\ 2.0f\ *\ (PN\_stdfloat)si\ /\ (PN\_stdfloat)num\_segments;}
\DoxyCodeLine{01630\ }
\DoxyCodeLine{01631\ \ \ \ \ \textcolor{comment}{//\ Upper\ left,\ top\ edge.}}
\DoxyCodeLine{01632\ \ \ \ \ LPoint3\ p1(-\/1.0f\ +\ t,\ 1.0f,\ 0.0f);}
\DoxyCodeLine{01633\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ p1,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{01634\ \ \ \ \ \ \ \textcolor{comment}{//\ Hey,\ this\ point\ is\ off\ the\ lens!\ \ Can't\ do\ a\ frustum.}}
\DoxyCodeLine{01635\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01636\ \ \ \ \ \}}
\DoxyCodeLine{01637\ \ \ \ \ vertex.set\_data3(near\_point);}
\DoxyCodeLine{01638\ \ \ \ \ vertex.set\_data3(far\_point);}
\DoxyCodeLine{01639\ }
\DoxyCodeLine{01640\ \ \ \ \ \textcolor{comment}{//\ Upper\ right,\ right\ edge.}}
\DoxyCodeLine{01641\ \ \ \ \ LPoint3\ p2(1.0f,\ 1.0f\ -\/\ t,\ 0.0f);}
\DoxyCodeLine{01642\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ p2,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{01643\ \ \ \ \ \ \ \textcolor{comment}{//\ Hey,\ this\ point\ is\ off\ the\ lens!\ \ Can't\ do\ a\ frustum.}}
\DoxyCodeLine{01644\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01645\ \ \ \ \ \}}
\DoxyCodeLine{01646\ \ \ \ \ vertex.set\_data3(near\_point);}
\DoxyCodeLine{01647\ \ \ \ \ vertex.set\_data3(far\_point);}
\DoxyCodeLine{01648\ }
\DoxyCodeLine{01649\ \ \ \ \ \textcolor{comment}{//\ Lower\ right,\ bottom\ edge.}}
\DoxyCodeLine{01650\ \ \ \ \ LPoint3\ p3(1.0f\ -\/\ t,\ -\/1.0f,\ 0.0f);}
\DoxyCodeLine{01651\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ p3,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{01652\ \ \ \ \ \ \ \textcolor{comment}{//\ Hey,\ this\ point\ is\ off\ the\ lens!\ \ Can't\ do\ a\ frustum.}}
\DoxyCodeLine{01653\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01654\ \ \ \ \ \}}
\DoxyCodeLine{01655\ \ \ \ \ vertex.set\_data3(near\_point);}
\DoxyCodeLine{01656\ \ \ \ \ vertex.set\_data3(far\_point);}
\DoxyCodeLine{01657\ }
\DoxyCodeLine{01658\ \ \ \ \ \textcolor{comment}{//\ Lower\ left,\ left\ edge.}}
\DoxyCodeLine{01659\ \ \ \ \ LPoint3\ p4(-\/1.0f,\ -\/1.0f\ +\ t,\ 0.0f);}
\DoxyCodeLine{01660\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ p4,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{01661\ \ \ \ \ \ \ \textcolor{comment}{//\ Hey,\ this\ point\ is\ off\ the\ lens!\ \ Can't\ do\ a\ frustum.}}
\DoxyCodeLine{01662\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01663\ \ \ \ \ \}}
\DoxyCodeLine{01664\ \ \ \ \ vertex.set\_data3(near\_point);}
\DoxyCodeLine{01665\ \ \ \ \ vertex.set\_data3(far\_point);}
\DoxyCodeLine{01666\ \ \ \}}
\DoxyCodeLine{01667\ }
\DoxyCodeLine{01668\ }
\DoxyCodeLine{01669\ \ \ \textcolor{comment}{//\ Finally,\ add\ one\ more\ pair\ for\ the\ viewing\ axis\ (or\ more\ specifically,}}
\DoxyCodeLine{01670\ \ \ \textcolor{comment}{//\ the\ center\ of\ the\ lens).}}
\DoxyCodeLine{01671\ \ \ LPoint3\ pc(0);}
\DoxyCodeLine{01672\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classLens_a0b896d2c13f5114bfb57a91f28211921}{do\_extrude}}(cdata,\ pc,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{01673\ \ \ \ \ vertex.set\_data3(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{01674\ \ \ \ \ vertex.set\_data3(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{01675\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01676\ \ \ \ \ vertex.set\_data3(near\_point);}
\DoxyCodeLine{01677\ \ \ \ \ vertex.set\_data3(far\_point);}
\DoxyCodeLine{01678\ \ \ \}}
\DoxyCodeLine{01679\ }
\DoxyCodeLine{01680\ \ \ \textcolor{keywordflow}{return}\ num\_segments;}
\DoxyCodeLine{01681\ \}}
\DoxyCodeLine{01682\ }
\DoxyCodeLine{01687\ \textcolor{keywordtype}{void}\ Lens::}
\DoxyCodeLine{01688\ build\_shear\_mat(LMatrix4\ \&shear\_mat,}
\DoxyCodeLine{01689\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&cul,\ \textcolor{keyword}{const}\ LPoint3\ \&cur,}
\DoxyCodeLine{01690\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&cll,\ \textcolor{keyword}{const}\ LPoint3\ \&clr)\ \{}
\DoxyCodeLine{01691\ \ \ \textcolor{comment}{//\ Fit\ a\ parallelogram\ around\ these\ four\ points.}}
\DoxyCodeLine{01692\ }
\DoxyCodeLine{01693\ \ \ \textcolor{comment}{//\ Put\ the\ points\ in\ an\ array\ so\ we\ can\ rotate\ it\ around\ to\ find\ the\ longest}}
\DoxyCodeLine{01694\ \ \ \textcolor{comment}{//\ edge.}}
\DoxyCodeLine{01695\ \ \ LPoint3\ points[4]\ =\ \{}
\DoxyCodeLine{01696\ \ \ \ \ cul,\ cur,\ clr,\ cll}
\DoxyCodeLine{01697\ \ \ \};}
\DoxyCodeLine{01698\ }
\DoxyCodeLine{01699\ \ \ PN\_stdfloat\ max\_edge\_length\ =\ -\/1.0f;}
\DoxyCodeLine{01700\ \ \ \textcolor{keywordtype}{int}\ base\_edge\ =\ -\/1;}
\DoxyCodeLine{01701\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 4;\ i++)\ \{}
\DoxyCodeLine{01702\ \ \ \ \ LVector3\ edge\ =\ points[(i\ +\ 1)\ \%\ 4]\ -\/\ points[i];}
\DoxyCodeLine{01703\ \ \ \ \ PN\_stdfloat\ length\ =\ edge.length\_squared();}
\DoxyCodeLine{01704\ \ \ \ \ \textcolor{keywordflow}{if}\ (length\ >\ max\_edge\_length)\ \{}
\DoxyCodeLine{01705\ \ \ \ \ \ \ base\_edge\ =\ i;}
\DoxyCodeLine{01706\ \ \ \ \ \ \ max\_edge\_length\ =\ length;}
\DoxyCodeLine{01707\ \ \ \ \ \}}
\DoxyCodeLine{01708\ \ \ \}}
\DoxyCodeLine{01709\ }
\DoxyCodeLine{01710\ \ \ \textcolor{keyword}{const}\ LPoint3\ \&base\_origin\ =\ points[base\_edge];}
\DoxyCodeLine{01711\ \ \ LVector3\ base\_vec\ =\ points[(base\_edge\ +\ 1)\ \%\ 4]\ -\/\ base\_origin;}
\DoxyCodeLine{01712\ }
\DoxyCodeLine{01713\ \ \ PN\_stdfloat\ base\_edge\_length\ =\ csqrt(max\_edge\_length);}
\DoxyCodeLine{01714\ }
\DoxyCodeLine{01715\ \ \ \textcolor{comment}{//\ The\ longest\ edge\ is\ the\ base\ of\ our\ parallelogram.\ \ The\ parallel\ edge}}
\DoxyCodeLine{01716\ \ \ \textcolor{comment}{//\ must\ pass\ through\ the\ point\ furthest\ from\ this\ edge.}}
\DoxyCodeLine{01717\ }
\DoxyCodeLine{01718\ \ \ \textcolor{keywordtype}{int}\ a\ =\ (base\_edge\ +\ 2)\ \%\ 4;}
\DoxyCodeLine{01719\ \ \ \textcolor{keywordtype}{int}\ b\ =\ (base\_edge\ +\ 3)\ \%\ 4;}
\DoxyCodeLine{01720\ }
\DoxyCodeLine{01721\ \ \ PN\_stdfloat\ a\_dist\ =\ sqr\_dist\_to\_line(points[a],\ base\_origin,\ base\_vec);}
\DoxyCodeLine{01722\ \ \ PN\_stdfloat\ b\_dist\ =\ sqr\_dist\_to\_line(points[b],\ base\_origin,\ base\_vec);}
\DoxyCodeLine{01723\ }
\DoxyCodeLine{01724\ \ \ \textcolor{keywordtype}{int}\ far\_point;}
\DoxyCodeLine{01725\ \ \ PN\_stdfloat\ dist;}
\DoxyCodeLine{01726\ \ \ \textcolor{keywordflow}{if}\ (a\_dist\ >\ b\_dist)\ \{}
\DoxyCodeLine{01727\ \ \ \ \ far\_point\ =\ a;}
\DoxyCodeLine{01728\ \ \ \ \ dist\ =\ csqrt(a\_dist);}
\DoxyCodeLine{01729\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01730\ \ \ \ \ far\_point\ =\ b;}
\DoxyCodeLine{01731\ \ \ \ \ dist\ =\ csqrt(b\_dist);}
\DoxyCodeLine{01732\ \ \ \}}
\DoxyCodeLine{01733\ }
\DoxyCodeLine{01734\ \ \ \textcolor{comment}{//\ Try\ to\ make\ the\ parallelogram\ as\ nearly\ rectangular\ as\ possible.\ \ How}}
\DoxyCodeLine{01735\ \ \ \textcolor{comment}{//\ suitable\ is\ a\ true\ rectangle?}}
\DoxyCodeLine{01736\ \ \ LVector3\ perpendic\ =\ base\_vec.cross(LVector3(0.0f,\ -\/1.0f,\ 0.0f));}
\DoxyCodeLine{01737\ \ \ perpendic.normalize();}
\DoxyCodeLine{01738\ \ \ perpendic\ *=\ dist;}
\DoxyCodeLine{01739\ \ \ LPoint3\ parallel\_origin\ =\ points[base\_edge]\ +\ perpendic;}
\DoxyCodeLine{01740\ }
\DoxyCodeLine{01741\ \ \ \textcolor{comment}{//\ It\ follows\ that\ far\_point\ is\ on\ the\ line\ passing\ through\ the\ parallel}}
\DoxyCodeLine{01742\ \ \ \textcolor{comment}{//\ edge.\ \ Is\ it\ within\ the\ endpoints?}}
\DoxyCodeLine{01743\ \ \ LVector3\ base\_norm\_vec\ =\ base\_vec\ /\ base\_edge\_length;}
\DoxyCodeLine{01744\ }
\DoxyCodeLine{01745\ \ \ LVector3\ far\_point\_delta\ =\ points[far\_point]\ -\/\ parallel\_origin;}
\DoxyCodeLine{01746\ \ \ PN\_stdfloat\ far\_point\_pos\ =\ far\_point\_delta.dot(base\_norm\_vec);}
\DoxyCodeLine{01747\ }
\DoxyCodeLine{01748\ \ \ \textcolor{keywordflow}{if}\ (far\_point\_pos\ <\ 0.0f)\ \{}
\DoxyCodeLine{01749\ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ slide\ the\ parallel\_origin\ back\ to\ include\ far\_point.}}
\DoxyCodeLine{01750\ \ \ \ \ parallel\_origin\ +=\ base\_norm\_vec\ *\ far\_point\_pos;}
\DoxyCodeLine{01751\ }
\DoxyCodeLine{01752\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (far\_point\_pos\ >\ base\_edge\_length)\ \{}
\DoxyCodeLine{01753\ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ slide\ the\ parallel\_origin\ forward\ to\ include\ far\_point.}}
\DoxyCodeLine{01754\ \ \ \ \ parallel\_origin\ +=\ base\_norm\_vec\ *\ (far\_point\_pos\ -\/\ base\_edge\_length);}
\DoxyCodeLine{01755\ \ \ \}}
\DoxyCodeLine{01756\ }
\DoxyCodeLine{01757\ \ \ \textcolor{comment}{//\ Finally,\ is\ the\ other\ point\ within\ the\ parallelogram?}}
\DoxyCodeLine{01758\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{01759\ \ \ PN\_stdfloat\ Ox\ =\ parallel\_origin[0];}
\DoxyCodeLine{01760\ \ \ PN\_stdfloat\ Oy\ =\ parallel\_origin[2];}
\DoxyCodeLine{01761\ \ \ PN\_stdfloat\ Vx\ =\ base\_vec[0];}
\DoxyCodeLine{01762\ \ \ PN\_stdfloat\ Vy\ =\ base\_vec[2];}
\DoxyCodeLine{01763\ \ \ PN\_stdfloat\ Ax,\ Ay,\ Bx,\ By;}
\DoxyCodeLine{01764\ }
\DoxyCodeLine{01765\ \ \ \textcolor{keywordflow}{if}\ (far\_point\ ==\ a)\ \{}
\DoxyCodeLine{01766\ \ \ \ \ \textcolor{comment}{//\ near\ point\ is\ b}}
\DoxyCodeLine{01767\ \ \ \ \ LVector3\ v\ =\ points[b]\ -\/\ base\_origin;}
\DoxyCodeLine{01768\ \ \ \ \ Ax\ =\ points[b][0];}
\DoxyCodeLine{01769\ \ \ \ \ Ay\ =\ points[b][2];}
\DoxyCodeLine{01770\ \ \ \ \ Bx\ =\ v[0];}
\DoxyCodeLine{01771\ \ \ \ \ By\ =\ v[2];}
\DoxyCodeLine{01772\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01773\ \ \ \ \ \textcolor{comment}{//\ near\ point\ is\ a}}
\DoxyCodeLine{01774\ \ \ \ \ LVector3\ v\ =\ points[a]\ -\/\ (base\_origin\ +\ base\_vec);}
\DoxyCodeLine{01775\ \ \ \ \ Ax\ =\ points[a][0];}
\DoxyCodeLine{01776\ \ \ \ \ Ay\ =\ points[a][2];}
\DoxyCodeLine{01777\ \ \ \ \ Bx\ =\ v[0];}
\DoxyCodeLine{01778\ \ \ \ \ By\ =\ v[2];}
\DoxyCodeLine{01779\ \ \ \}}
\DoxyCodeLine{01780\ \ \ t\ =\ ((Ox\ -\/\ Ax)\ *\ By\ +\ (Ay\ -\/\ Oy)\ *\ Bx)\ /\ (Bx\ *\ Vy\ -\/\ By\ *\ Vx);}
\DoxyCodeLine{01781\ }
\DoxyCodeLine{01782\ \ \ \textcolor{keywordflow}{if}\ (t\ <\ 0.0f)\ \{}
\DoxyCodeLine{01783\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ slide\ the\ parallel\_origin\ back\ to\ include\ the\ near\ point.}}
\DoxyCodeLine{01784\ \ \ \ \ parallel\_origin\ +=\ base\_vec\ *\ t;}
\DoxyCodeLine{01785\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t\ >\ 1.0f)\ \{}
\DoxyCodeLine{01786\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ slide\ the\ parallel\_origin\ forward\ to\ include\ the\ far\ point.}}
\DoxyCodeLine{01787\ \ \ \ \ parallel\_origin\ +=\ base\_vec\ *\ (1.0f\ -\/\ t);}
\DoxyCodeLine{01788\ \ \ \}}
\DoxyCodeLine{01789\ }
\DoxyCodeLine{01790\ \ \ LVector3\ adjacent\_norm\_vec\ =\ parallel\_origin\ -\/\ base\_origin;}
\DoxyCodeLine{01791\ \ \ adjacent\_norm\_vec.normalize();}
\DoxyCodeLine{01792\ }
\DoxyCodeLine{01793\ \ \ \textcolor{comment}{//\ Now\ we've\ defined\ a\ parallelogram\ that\ includes\ all\ four\ points,\ and}}
\DoxyCodeLine{01794\ \ \ \textcolor{comment}{//\ we're\ ready\ to\ build\ a\ shear\ transform.}}
\DoxyCodeLine{01795\ \ \ shear\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{01796\ }
\DoxyCodeLine{01797\ \ \ \textcolor{comment}{//\ The\ edges\ of\ the\ parallelogram\ become\ the\ axes.}}
\DoxyCodeLine{01798\ \ \ \textcolor{keywordflow}{switch}\ (base\_edge)\ \{}
\DoxyCodeLine{01799\ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{01800\ \ \ \ \ \textcolor{comment}{//\ The\ base\_origin\ is\ the\ upper-\/left\ corner.\ \ X\ axis\ is\ base\_norm\_vec,\ Z}}
\DoxyCodeLine{01801\ \ \ \ \ \textcolor{comment}{//\ axis\ is\ -\/adjacent\_norm\_vec.}}
\DoxyCodeLine{01802\ \ \ \ \ shear\_mat.set\_row(0,\ base\_norm\_vec);}
\DoxyCodeLine{01803\ \ \ \ \ shear\_mat.set\_row(2,\ -\/adjacent\_norm\_vec);}
\DoxyCodeLine{01804\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01805\ }
\DoxyCodeLine{01806\ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{01807\ \ \ \ \ \textcolor{comment}{//\ The\ base\_origin\ is\ the\ upper-\/right\ corner.\ \ X\ axis\ is}}
\DoxyCodeLine{01808\ \ \ \ \ \textcolor{comment}{//\ -\/adjacent\_norm\_vec,\ Z\ axis\ is\ -\/base\_norm\_vec.}}
\DoxyCodeLine{01809\ \ \ \ \ shear\_mat.set\_row(0,\ -\/adjacent\_norm\_vec);}
\DoxyCodeLine{01810\ \ \ \ \ shear\_mat.set\_row(2,\ -\/base\_norm\_vec);}
\DoxyCodeLine{01811\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01812\ }
\DoxyCodeLine{01813\ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{01814\ \ \ \ \ \textcolor{comment}{//\ The\ base\_origin\ is\ the\ lower-\/right\ corner.\ \ X\ axis\ is\ -\/base\_norm\_vec,\ Z}}
\DoxyCodeLine{01815\ \ \ \ \ \textcolor{comment}{//\ axis\ is\ adjacent\_norm\_vec.}}
\DoxyCodeLine{01816\ \ \ \ \ shear\_mat.set\_row(0,\ -\/base\_norm\_vec);}
\DoxyCodeLine{01817\ \ \ \ \ shear\_mat.set\_row(2,\ adjacent\_norm\_vec);}
\DoxyCodeLine{01818\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01819\ }
\DoxyCodeLine{01820\ \ \ \textcolor{keywordflow}{case}\ 3:}
\DoxyCodeLine{01821\ \ \ \ \ \textcolor{comment}{//\ The\ base\_origin\ is\ the\ lower-\/left\ corner.\ \ X\ axis\ is\ adjacent\_norm\_vec,}}
\DoxyCodeLine{01822\ \ \ \ \ \textcolor{comment}{//\ Z\ axis\ is\ base\_norm\_vec.}}
\DoxyCodeLine{01823\ \ \ \ \ shear\_mat.set\_row(0,\ adjacent\_norm\_vec);}
\DoxyCodeLine{01824\ \ \ \ \ shear\_mat.set\_row(2,\ base\_norm\_vec);}
\DoxyCodeLine{01825\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01826\ }
\DoxyCodeLine{01827\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01828\ \ \ \ \ nassertv(\textcolor{keyword}{false});}
\DoxyCodeLine{01829\ \ \ \}}
\DoxyCodeLine{01830\ \}}
\DoxyCodeLine{01831\ }
\DoxyCodeLine{01836\ PN\_stdfloat\ Lens::}
\DoxyCodeLine{01837\ sqr\_dist\_to\_line(\textcolor{keyword}{const}\ LPoint3\ \&point,\ \textcolor{keyword}{const}\ LPoint3\ \&origin,}
\DoxyCodeLine{01838\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVector3\ \&vec)\ \{}
\DoxyCodeLine{01839\ \ \ LVector3\ norm\ =\ vec;}
\DoxyCodeLine{01840\ \ \ norm.normalize();}
\DoxyCodeLine{01841\ \ \ LVector3\ d\ =\ point\ -\/\ origin;}
\DoxyCodeLine{01842\ \ \ PN\_stdfloat\ hyp\_2\ =\ d.length\_squared();}
\DoxyCodeLine{01843\ \ \ PN\_stdfloat\ leg\ =\ d.dot(norm);}
\DoxyCodeLine{01844\ \ \ \textcolor{keywordflow}{return}\ hyp\_2\ -\/\ leg\ *\ leg;}
\DoxyCodeLine{01845\ \}}
\DoxyCodeLine{01846\ }
\DoxyCodeLine{01851\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_ac17b372136493015bff58d2421f7d4d7}{Lens::}}}
\DoxyCodeLine{01852\ \mbox{\hyperlink{classLens_ac17b372136493015bff58d2421f7d4d7}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{01853\ \ \ TypedWritable::write\_datagram(manager,\ dg);}
\DoxyCodeLine{01854\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{01855\ \}}
\DoxyCodeLine{01856\ }
\DoxyCodeLine{01861\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_ae07466afe50a236e96da1445c515ba95}{Lens::}}}
\DoxyCodeLine{01862\ \mbox{\hyperlink{classLens_ae07466afe50a236e96da1445c515ba95}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01863\ \ \ \mbox{\hyperlink{classTypedWritable_a3ad6cc1cd23bc3783d83edb3302bb43c}{TypedWritable::fillin}}(scan,\ manager);}
\DoxyCodeLine{01864\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{01865\ \}}
\DoxyCodeLine{01866\ }
\DoxyCodeLine{01870\ Lens::CData::}
\DoxyCodeLine{01871\ CData()\ \{}
\DoxyCodeLine{01872\ \ \ clear();}
\DoxyCodeLine{01873\ \}}
\DoxyCodeLine{01874\ }
\DoxyCodeLine{01878\ Lens::CData::}
\DoxyCodeLine{01879\ CData(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{Lens::CData}}\ \&copy)\ \{}
\DoxyCodeLine{01880\ \ \ \_change\_event\ =\ copy.\_change\_event;}
\DoxyCodeLine{01881\ \ \ \_cs\ =\ copy.\_cs;}
\DoxyCodeLine{01882\ \ \ \_film\_size\ =\ copy.\_film\_size;}
\DoxyCodeLine{01883\ \ \ \_film\_offset\ =\ copy.\_film\_offset;}
\DoxyCodeLine{01884\ \ \ \_focal\_length\ =\ copy.\_focal\_length;}
\DoxyCodeLine{01885\ \ \ \_fov\ =\ copy.\_fov;}
\DoxyCodeLine{01886\ \ \ \_min\_fov\ =\ copy.\_min\_fov;}
\DoxyCodeLine{01887\ \ \ \_aspect\_ratio\ =\ copy.\_aspect\_ratio;}
\DoxyCodeLine{01888\ \ \ \_near\_distance\ =\ copy.\_near\_distance;}
\DoxyCodeLine{01889\ \ \ \_far\_distance\ =\ copy.\_far\_distance;}
\DoxyCodeLine{01890\ }
\DoxyCodeLine{01891\ \ \ \_view\_hpr\ =\ copy.\_view\_hpr;}
\DoxyCodeLine{01892\ \ \ \_view\_vector\ =\ copy.\_view\_vector;}
\DoxyCodeLine{01893\ \ \ \_interocular\_distance\ =\ copy.\_interocular\_distance;}
\DoxyCodeLine{01894\ \ \ \_convergence\_distance\ =\ copy.\_convergence\_distance;}
\DoxyCodeLine{01895\ \ \ \_keystone\ =\ copy.\_keystone;}
\DoxyCodeLine{01896\ }
\DoxyCodeLine{01897\ \ \ \textcolor{comment}{//\ This\ matrix\ might\ have\ been\ explicitly\ set\ by\ the\ user\ (if\ UF\_view\_mat\ is}}
\DoxyCodeLine{01898\ \ \ \textcolor{comment}{//\ applied),\ so\ we\ must\ preserve\ it.\ \ Other\ matrices\ are\ implicitly}}
\DoxyCodeLine{01899\ \ \ \textcolor{comment}{//\ computed.}}
\DoxyCodeLine{01900\ \ \ \_lens\_mat\ =\ copy.\_lens\_mat;}
\DoxyCodeLine{01901\ }
\DoxyCodeLine{01902\ \ \ \_user\_flags\ =\ copy.\_user\_flags;}
\DoxyCodeLine{01903\ \ \ \_comp\_flags\ =\ 0;}
\DoxyCodeLine{01904\ }
\DoxyCodeLine{01905\ \ \ \_focal\_length\_seq\ =\ copy.\_focal\_length\_seq;}
\DoxyCodeLine{01906\ \ \ \_fov\_seq\ =\ copy.\_fov\_seq;}
\DoxyCodeLine{01907\ \ \ \_film\_size\_seq\ =\ copy.\_film\_size\_seq;}
\DoxyCodeLine{01908\ }
\DoxyCodeLine{01909\ \ \ \_geom\_data\ =\ copy.\_geom\_data;}
\DoxyCodeLine{01910\ \}}
\DoxyCodeLine{01911\ }
\DoxyCodeLine{01915\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *Lens::CData::}
\DoxyCodeLine{01916\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01917\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{01918\ \}}
\DoxyCodeLine{01919\ }
\DoxyCodeLine{01924\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_1_1CData_a2c2cae7189a84f560bdd31a80ddfddb6}{Lens::CData::}}}
\DoxyCodeLine{01925\ \mbox{\hyperlink{classLens_1_1CData_a2c2cae7189a84f560bdd31a80ddfddb6}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01926\ \ \ dg.add\_string(\_change\_event);}
\DoxyCodeLine{01927\ \ \ dg.add\_uint8((\textcolor{keywordtype}{int})\_cs);}
\DoxyCodeLine{01928\ \ \ \_film\_size.write\_datagram(dg);}
\DoxyCodeLine{01929\ \ \ \_film\_offset.write\_datagram(dg);}
\DoxyCodeLine{01930\ \ \ dg.add\_stdfloat(\_focal\_length);}
\DoxyCodeLine{01931\ \ \ \_fov.write\_datagram(dg);}
\DoxyCodeLine{01932\ \ \ dg.add\_stdfloat(\_aspect\_ratio);}
\DoxyCodeLine{01933\ \ \ dg.add\_stdfloat(\_near\_distance);}
\DoxyCodeLine{01934\ \ \ dg.add\_stdfloat(\_far\_distance);}
\DoxyCodeLine{01935\ \ \ dg.add\_uint16(\_user\_flags);}
\DoxyCodeLine{01936\ }
\DoxyCodeLine{01937\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ <\ 41)\ \{}
\DoxyCodeLine{01938\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01939\ \ \ \}}
\DoxyCodeLine{01940\ }
\DoxyCodeLine{01941\ \ \ dg.add\_stdfloat(\_min\_fov);}
\DoxyCodeLine{01942\ \ \ dg.add\_stdfloat(\_interocular\_distance);}
\DoxyCodeLine{01943\ \ \ dg.add\_stdfloat(\_convergence\_distance);}
\DoxyCodeLine{01944\ }
\DoxyCodeLine{01945\ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_hpr)\ \{}
\DoxyCodeLine{01946\ \ \ \ \ \_view\_hpr.write\_datagram(dg);}
\DoxyCodeLine{01947\ \ \ \}}
\DoxyCodeLine{01948\ }
\DoxyCodeLine{01949\ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_vector)\ \{}
\DoxyCodeLine{01950\ \ \ \ \ \_view\_vector.write\_datagram(dg);}
\DoxyCodeLine{01951\ \ \ \ \ \_up\_vector.write\_datagram(dg);}
\DoxyCodeLine{01952\ \ \ \}}
\DoxyCodeLine{01953\ }
\DoxyCodeLine{01954\ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_mat)\ \{}
\DoxyCodeLine{01955\ \ \ \ \ \_lens\_mat.write\_datagram(dg);}
\DoxyCodeLine{01956\ \ \ \}}
\DoxyCodeLine{01957\ }
\DoxyCodeLine{01958\ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_keystone)\ \{}
\DoxyCodeLine{01959\ \ \ \ \ \_keystone.write\_datagram(dg);}
\DoxyCodeLine{01960\ \ \ \}}
\DoxyCodeLine{01961\ }
\DoxyCodeLine{01962\ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_custom\_film\_mat)\ \{}
\DoxyCodeLine{01963\ \ \ \ \ \_custom\_film\_mat.write\_datagram(dg);}
\DoxyCodeLine{01964\ \ \ \}}
\DoxyCodeLine{01965\ \}}
\DoxyCodeLine{01966\ }
\DoxyCodeLine{01971\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLens_1_1CData_a321d741fa781638c3b8f9ca890934b58}{Lens::CData::}}}
\DoxyCodeLine{01972\ \mbox{\hyperlink{classLens_1_1CData_a321d741fa781638c3b8f9ca890934b58}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01973\ \ \ \_change\_event\ =\ scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}();}
\DoxyCodeLine{01974\ \ \ \_cs\ =\ (CoordinateSystem)scan.get\_uint8();}
\DoxyCodeLine{01975\ \ \ \_film\_size.read\_datagram(scan);}
\DoxyCodeLine{01976\ \ \ \_film\_offset.read\_datagram(scan);}
\DoxyCodeLine{01977\ \ \ \_focal\_length\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01978\ \ \ \_fov.read\_datagram(scan);}
\DoxyCodeLine{01979\ \ \ \_aspect\_ratio\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01980\ \ \ \_near\_distance\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01981\ \ \ \_far\_distance\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01982\ \ \ \_user\_flags\ =\ scan.get\_uint16();}
\DoxyCodeLine{01983\ }
\DoxyCodeLine{01984\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 41)\ \{}
\DoxyCodeLine{01985\ \ \ \ \ \_min\_fov\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01986\ \ \ \ \ \_interocular\_distance\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01987\ \ \ \ \ \_convergence\_distance\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01988\ }
\DoxyCodeLine{01989\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_hpr)\ \{}
\DoxyCodeLine{01990\ \ \ \ \ \ \ \_view\_hpr.read\_datagram(scan);}
\DoxyCodeLine{01991\ \ \ \ \ \}}
\DoxyCodeLine{01992\ }
\DoxyCodeLine{01993\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_vector)\ \{}
\DoxyCodeLine{01994\ \ \ \ \ \ \ \_view\_vector.read\_datagram(scan);}
\DoxyCodeLine{01995\ \ \ \ \ \ \ \_up\_vector.read\_datagram(scan);}
\DoxyCodeLine{01996\ \ \ \ \ \}}
\DoxyCodeLine{01997\ }
\DoxyCodeLine{01998\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_view\_mat)\ \{}
\DoxyCodeLine{01999\ \ \ \ \ \ \ \_lens\_mat.read\_datagram(scan);}
\DoxyCodeLine{02000\ \ \ \ \ \}}
\DoxyCodeLine{02001\ }
\DoxyCodeLine{02002\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_keystone)\ \{}
\DoxyCodeLine{02003\ \ \ \ \ \ \ \_keystone.read\_datagram(scan);}
\DoxyCodeLine{02004\ \ \ \ \ \}}
\DoxyCodeLine{02005\ }
\DoxyCodeLine{02006\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_user\_flags\ \&\ UF\_custom\_film\_mat)\ \{}
\DoxyCodeLine{02007\ \ \ \ \ \ \ \_custom\_film\_mat.read\_datagram(scan);}
\DoxyCodeLine{02008\ \ \ \ \ \}}
\DoxyCodeLine{02009\ \ \ \}}
\DoxyCodeLine{02010\ }
\DoxyCodeLine{02011\ \ \ \_comp\_flags\ =\ 0;}
\DoxyCodeLine{02012\ \}}
\DoxyCodeLine{02013\ }
\DoxyCodeLine{02017\ \textcolor{keywordtype}{void}\ Lens::CData::}
\DoxyCodeLine{02018\ clear()\ \{}
\DoxyCodeLine{02019\ \ \ \_change\_event\ =\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{02020\ \ \ \_cs\ =\ CS\_default;}
\DoxyCodeLine{02021\ \ \ \_film\_size.set(1.0f,\ 1.0f);}
\DoxyCodeLine{02022\ \ \ \_film\_offset.set(0.0f,\ 0.0f);}
\DoxyCodeLine{02023\ \ \ \_focal\_length\ =\ 1.0f;}
\DoxyCodeLine{02024\ \ \ \_fov.set(default\_fov,\ default\_fov);}
\DoxyCodeLine{02025\ \ \ \_aspect\_ratio\ =\ 1.0f;}
\DoxyCodeLine{02026\ \ \ \_near\_distance\ =\ default\_near;}
\DoxyCodeLine{02027\ \ \ \_far\_distance\ =\ default\_far;}
\DoxyCodeLine{02028\ \ \ \_view\_hpr.set(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{02029\ \ \ \_view\_vector.set(0.0f,\ 1.0f,\ 0.0f);}
\DoxyCodeLine{02030\ \ \ \_up\_vector.set(0.0f,\ 0.0f,\ 1.0f);}
\DoxyCodeLine{02031\ \ \ \_keystone.set(0.0f,\ 0.0f);}
\DoxyCodeLine{02032\ \ \ \_custom\_film\_mat\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{02033\ }
\DoxyCodeLine{02034\ \ \ \_user\_flags\ =\ 0;}
\DoxyCodeLine{02035\ \ \ \_comp\_flags\ =\ CF\_fov;}
\DoxyCodeLine{02036\ }
\DoxyCodeLine{02037\ \ \ \_interocular\_distance\ =\ 0.0;}
\DoxyCodeLine{02038\ \ \ \_convergence\_distance\ =\ 0.0;}
\DoxyCodeLine{02039\ }
\DoxyCodeLine{02040\ \ \ \textcolor{keywordflow}{if}\ (default\_keystone.has\_value())\ \{}
\DoxyCodeLine{02041\ \ \ \ \ \_keystone.set(default\_keystone[0],\ default\_keystone[1]);}
\DoxyCodeLine{02042\ \ \ \ \ \_user\_flags\ |=\ UF\_keystone;}
\DoxyCodeLine{02043\ \ \ \}}
\DoxyCodeLine{02044\ }
\DoxyCodeLine{02045\ \ \ \textcolor{comment}{//\ Assign\ an\ initial\ arbitrary\ sequence\ to\ these\ three.}}
\DoxyCodeLine{02046\ \ \ \_film\_size\_seq\ =\ 0;}
\DoxyCodeLine{02047\ \ \ \_focal\_length\_seq\ =\ 1;}
\DoxyCodeLine{02048\ \ \ \_fov\_seq\ =\ 2;}
\DoxyCodeLine{02049\ \}}

\end{DoxyCode}
