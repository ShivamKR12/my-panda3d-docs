\doxysection{rope\+Node.\+cxx}
\hypertarget{ropeNode_8cxx_source}{}\label{ropeNode_8cxx_source}\index{panda/src/parametrics/ropeNode.cxx@{panda/src/parametrics/ropeNode.cxx}}
\mbox{\hyperlink{ropeNode_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ropeNode_8h}{ropeNode.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullableObject_8h}{cullableObject.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullHandler_8h}{cullHandler.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderModeAttrib_8h}{renderModeAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{colorAttrib_8h}{colorAttrib.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomLines_8h}{geomLines.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTristrips_8h}{geomTristrips.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ RopeNode::\_type\_handle;}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ RopeNode::\_rope\_node\_pcollector(\textcolor{stringliteral}{"{}*:RopeNode"{}});}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00040\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *RopeNode::CData::}
\DoxyCodeLine{00041\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00042\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00049\ \textcolor{keywordtype}{void}\ RopeNode::CData::}
\DoxyCodeLine{00050\ write\_datagram(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *writer,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00051\ \ \ \textcolor{comment}{//\ For\ now,\ we\ write\ a\ NULL\ pointer.\ \ Eventually\ we\ will\ write\ out\ the}}
\DoxyCodeLine{00052\ \ \ \textcolor{comment}{//\ NurbsCurveEvaluator\ pointer.}}
\DoxyCodeLine{00053\ \ \ writer-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00060\ \textcolor{keywordtype}{void}\ RopeNode::CData::}
\DoxyCodeLine{00061\ fillin(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *reader)\ \{}
\DoxyCodeLine{00062\ \ \ \textcolor{comment}{//\ For\ now,\ we\ skip\ over\ the\ NULL\ pointer\ that\ we\ wrote\ out.}}
\DoxyCodeLine{00063\ \ \ reader-\/>\mbox{\hyperlink{classBamReader_a63c44ae63b95a3ddcce8b42ff80ccec7}{skip\_pointer}}(scan);}
\DoxyCodeLine{00064\ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00069\ RopeNode::}
\DoxyCodeLine{00070\ RopeNode(\textcolor{keyword}{const}\ std::string\ \&name)\ :}
\DoxyCodeLine{00071\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(name)}
\DoxyCodeLine{00072\ \{}
\DoxyCodeLine{00073\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00074\ \ \ set\_renderable();}
\DoxyCodeLine{00075\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00080\ RopeNode::}
\DoxyCodeLine{00081\ RopeNode(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRopeNode}{RopeNode}}\ \&copy)\ :}
\DoxyCodeLine{00082\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(copy),}
\DoxyCodeLine{00083\ \ \ \_cycler(copy.\_cycler)}
\DoxyCodeLine{00084\ \{}
\DoxyCodeLine{00085\ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00092\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classRopeNode_aec335d266c8a2cec70a5cd2973bd88b8}{RopeNode::}}}
\DoxyCodeLine{00093\ \mbox{\hyperlink{classRopeNode_aec335d266c8a2cec70a5cd2973bd88b8}{make\_copy}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classRopeNode}{RopeNode}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00095\ \}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00102\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classRopeNode_a57184c3e348df9fc2882a6056f014002}{RopeNode::}}}
\DoxyCodeLine{00103\ \mbox{\hyperlink{classRopeNode_a57184c3e348df9fc2882a6056f014002}{safe\_to\_transform}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00104\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00105\ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00125\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classRopeNode_a1db13e647e8e997820982678e22f9295}{RopeNode::}}}
\DoxyCodeLine{00126\ \mbox{\hyperlink{classRopeNode_a1db13e647e8e997820982678e22f9295}{cull\_callback}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data)\ \{}
\DoxyCodeLine{00127\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{00128\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_rope\_node\_pcollector);}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \textcolor{comment}{//\ Create\ some\ geometry\ on-\/the-\/fly\ to\ render\ the\ rope.}}
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{if}\ (get\_num\_subdiv()\ >\ 0)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \mbox{\hyperlink{classNurbsCurveEvaluator}{NurbsCurveEvaluator}}\ *curve\ =\ get\_curve();}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{if}\ (curve\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}})\ result;}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_matrix())\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ result\ =\ curve-\/>evaluate(data.get\_node\_path(),\ get\_matrix());}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ result\ =\ curve-\/>evaluate(data.get\_node\_path());}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result-\/>get\_num\_segments()\ >\ 0)\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (get\_render\_mode())\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ RM\_thread:}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ render\_thread(trav,\ data,\ result);}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ RM\_tape:}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ render\_tape(trav,\ data,\ result);}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ RM\_billboard:}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ render\_billboard(trav,\ data,\ result);}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ RM\_tube:}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ render\_tube(trav,\ data,\ result);}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00160\ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00164\ \}}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00169\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00170\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00171\ \ \ PandaNode::output(out);}
\DoxyCodeLine{00172\ \ \ \mbox{\hyperlink{classNurbsCurveEvaluator}{NurbsCurveEvaluator}}\ *curve\ =\ get\_curve();}
\DoxyCodeLine{00173\ \ \ \textcolor{keywordflow}{if}\ (curve\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00174\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *curve;}
\DoxyCodeLine{00175\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00176\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ (no\ curve)"{}};}
\DoxyCodeLine{00177\ \ \ \}}
\DoxyCodeLine{00178\ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00183\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00184\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00185\ \ \ PandaNode::write(out,\ indent\_level);}
\DoxyCodeLine{00186\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ *get\_curve()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00187\ \}}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00194\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classRopeNode_a42103bd94fb1f85dd67b1870af64ed94}{RopeNode::}}}
\DoxyCodeLine{00195\ \mbox{\hyperlink{classRopeNode_a42103bd94fb1f85dd67b1870af64ed94}{reset\_bound}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&rel\_to)\ \{}
\DoxyCodeLine{00196\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00197\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00198\ \ \ do\_recompute\_bounds(rel\_to,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00199\ \ \ mark\_internal\_bounds\_stale(current\_thread);}
\DoxyCodeLine{00200\ \}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00207\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classRopeNode_a19adb069b035d2473b7ab609325adc15}{RopeNode::}}}
\DoxyCodeLine{00208\ \mbox{\hyperlink{classRopeNode_a19adb069b035d2473b7ab609325adc15}{compute\_internal\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&internal\_bounds,}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \&internal\_vertices,}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00212\ \ \ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ bounds\ =}
\DoxyCodeLine{00213\ \ \ \ \ do\_recompute\_bounds(\mbox{\hyperlink{classNodePath}{NodePath}}((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this}),\ pipeline\_stage,}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ internal\_bounds\ =\ bounds;}
\DoxyCodeLine{00217\ \ \ internal\_vertices\ =\ 0;\ \ \textcolor{comment}{//\ TODO-\/-\/estimate\ this\ better.}}
\DoxyCodeLine{00218\ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00224\ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ RopeNode::}
\DoxyCodeLine{00225\ get\_format(\textcolor{keywordtype}{bool}\ support\_normals)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00226\ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}}
\DoxyCodeLine{00227\ \ \ \ \ (InternalName::get\_vertex(),\ 3,\ Geom::NT\_stdfloat,}
\DoxyCodeLine{00228\ \ \ \ \ \ Geom::C\_point);}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \textcolor{keywordflow}{if}\ (support\_normals\ \&\&\ get\_normal\_mode()\ ==\ NM\_vertex)\ \{}
\DoxyCodeLine{00231\ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00232\ \ \ \ \ \ \ (InternalName::get\_normal(),\ 3,\ Geom::NT\_stdfloat,}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ Geom::C\_normal);}
\DoxyCodeLine{00234\ \ \ \}}
\DoxyCodeLine{00235\ \ \ \textcolor{keywordflow}{if}\ (get\_use\_vertex\_color())\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \textcolor{keywordflow}{if}\ (vertex\_colors\_prefer\_packed)\ \{}
\DoxyCodeLine{00237\ \ \ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ (InternalName::get\_color(),\ 1,\ Geom::NT\_packed\_dabc,}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ Geom::C\_color);}
\DoxyCodeLine{00240\ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00242\ \ \ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ (InternalName::get\_color(),\ 4,\ Geom::NT\_uint8,}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ Geom::C\_color);}
\DoxyCodeLine{00245\ \ \ \ \ \}}
\DoxyCodeLine{00246\ \ \ \}}
\DoxyCodeLine{00247\ \ \ \textcolor{keywordflow}{if}\ (get\_uv\_mode()\ !=\ UV\_none)\ \{}
\DoxyCodeLine{00248\ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00249\ \ \ \ \ \ \ (InternalName::get\_texcoord(),\ 2,\ Geom::NT\_stdfloat,}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ Geom::C\_texcoord);}
\DoxyCodeLine{00251\ \ \ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{keywordflow}{return}\ GeomVertexFormat::register\_format(array\_format);}
\DoxyCodeLine{00254\ \}}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00259\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ RopeNode::}
\DoxyCodeLine{00260\ do\_recompute\_bounds(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&rel\_to,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00262\ \ \ \textcolor{comment}{//\ TODO:\ fix\ the\ bounds\ so\ that\ it\ properly\ reflects\ the\ indicated\ pipeline}}
\DoxyCodeLine{00263\ \ \ \textcolor{comment}{//\ stage.\ \ At\ the\ moment,\ we\ cheat\ and\ get\ some\ of\ the\ properties\ from\ the}}
\DoxyCodeLine{00264\ \ \ \textcolor{comment}{//\ current\ pipeline\ stage,\ the\ lazy\ way.}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \textcolor{comment}{//\ First,\ get\ ourselves\ a\ fresh,\ empty\ bounding\ volume.}}
\DoxyCodeLine{00267\ \ \ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ bound\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00269\ \ \ \mbox{\hyperlink{classNurbsCurveEvaluator}{NurbsCurveEvaluator}}\ *curve\ =\ get\_curve();}
\DoxyCodeLine{00270\ \ \ \textcolor{keywordflow}{if}\ (curve\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \mbox{\hyperlink{classpvector}{NurbsCurveEvaluator::Vert3Array}}\ verts;}
\DoxyCodeLine{00272\ \ \ \ \ get\_curve()-\/>get\_vertices(verts,\ rel\_to);}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_matrix())\ \{}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \textcolor{comment}{//\ And\ then\ apply\ the\ indicated\ matrix.}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&mat\ =\ get\_matrix();}
\DoxyCodeLine{00277\ \ \ \ \ \ \ NurbsCurveEvaluator::Vert3Array::iterator\ vi;}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (vi\ =\ verts.begin();\ vi\ !=\ verts.end();\ ++vi)\ \{}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ (*vi)\ =\ LPoint3(*vi)\ *\ mat;}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00281\ \ \ \ \ \}}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00283\ \ \ \ \ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *gbv;}
\DoxyCodeLine{00284\ \ \ \ \ DCAST\_INTO\_R(gbv,\ bound,\ bound);}
\DoxyCodeLine{00285\ \ \ \ \ gbv-\/>around(\&verts[0],\ \&verts[0]\ +\ verts.size());}
\DoxyCodeLine{00286\ \ \ \}}
\DoxyCodeLine{00287\ \ \ \textcolor{keywordflow}{return}\ bound;}
\DoxyCodeLine{00288\ \}}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00300\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00301\ render\_thread(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00303\ \ \ CurveSegments\ curve\_segments;}
\DoxyCodeLine{00304\ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts\ =\ get\_connected\_segments(curve\_segments,\ result);}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{comment}{//\ Now\ we\ have\ stored\ one\ or\ more\ sequences\ of\ vertices\ down\ the\ thread.}}
\DoxyCodeLine{00307\ \ \ \textcolor{comment}{//\ These\ map\ directly\ to\ primitive\ vertices.}}
\DoxyCodeLine{00308\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00309\ \ \ \ \ (\textcolor{stringliteral}{"{}rope"{}},\ get\_format(\textcolor{keyword}{false}),\ Geom::UH\_stream);}
\DoxyCodeLine{00310\ \ \ compute\_thread\_vertices(vdata,\ curve\_segments,\ num\_curve\_verts);}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00312\ \ \ \textcolor{comment}{//\ We\ use\ GeomLines\ instead\ of\ GeomLinestrips,\ since\ that\ can\ more\ easily\ be}}
\DoxyCodeLine{00313\ \ \ \textcolor{comment}{//\ rendered\ directly.}}
\DoxyCodeLine{00314\ \ \ PT(\mbox{\hyperlink{classGeomLines}{GeomLines}})\ lines\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomLines}{GeomLines}}(Geom::UH\_stream);}
\DoxyCodeLine{00315\ \ \ lines-\/>reserve\_num\_vertices((num\_curve\_verts\ -\/\ 1)\ *\ 2);}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ vi\ =\ 0;\ vi\ <\ num\_curve\_verts\ -\/\ 1;\ ++vi)\ \{}
\DoxyCodeLine{00318\ \ \ \ \ lines-\/>add\_vertex(vi);}
\DoxyCodeLine{00319\ \ \ \ \ lines-\/>add\_vertex(vi\ +\ 1);}
\DoxyCodeLine{00320\ \ \ \ \ lines-\/>close\_primitive();}
\DoxyCodeLine{00321\ \ \ \}}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00324\ \ \ geom-\/>add\_primitive(lines);}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ thick\ =\ RenderModeAttrib::make(RenderModeAttrib::M\_unchanged,\ get\_thickness());}
\DoxyCodeLine{00327\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state-\/>add\_attrib(thick);}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{if}\ (get\_use\_vertex\_color())\ \{}
\DoxyCodeLine{00329\ \ \ \ \ state\ =\ state-\/>add\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00330\ \ \ \}}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(\mbox{\hyperlink{classCullableObject}{CullableObject}}(}
\DoxyCodeLine{00333\ \ \ \ \ std::move(geom),\ std::move(state),\ data.get\_internal\_transform(trav)),\ trav);}
\DoxyCodeLine{00334\ \}}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00343\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00344\ render\_tape(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00346\ \ \ CurveSegments\ curve\_segments;}
\DoxyCodeLine{00347\ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts\ =\ get\_connected\_segments(curve\_segments,\ result);}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \textcolor{comment}{//\ Now\ we\ have\ stored\ one\ or\ more\ sequences\ of\ vertices\ down\ the\ center}}
\DoxyCodeLine{00350\ \ \ \textcolor{comment}{//\ strips.\ \ Go\ back\ through\ and\ calculate\ the\ vertices\ on\ either\ side.}}
\DoxyCodeLine{00351\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00352\ \ \ \ \ (\textcolor{stringliteral}{"{}rope"{}},\ get\_format(\textcolor{keyword}{false}),\ Geom::UH\_stream);}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \ \ compute\_billboard\_vertices(vdata,\ -\/get\_tube\_up(),}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ curve\_segments,\ num\_curve\_verts,\ result);}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \textcolor{comment}{//\ Since\ this\ will\ be\ a\ nonindexed\ primitive,\ no\ need\ to\ pre-\/reserve\ the}}
\DoxyCodeLine{00358\ \ \ \textcolor{comment}{//\ number\ of\ vertices.}}
\DoxyCodeLine{00359\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_stream);}
\DoxyCodeLine{00360\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00361\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \ \ \ \ strip-\/>add\_next\_vertices(segment.size()\ *\ 2);}
\DoxyCodeLine{00365\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00366\ \ \ \}}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00369\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state;}
\DoxyCodeLine{00372\ \ \ \textcolor{keywordflow}{if}\ (get\_use\_vertex\_color())\ \{}
\DoxyCodeLine{00373\ \ \ \ \ state\ =\ state-\/>add\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00374\ \ \ \}}
\DoxyCodeLine{00375\ }
\DoxyCodeLine{00376\ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(\mbox{\hyperlink{classCullableObject}{CullableObject}}(}
\DoxyCodeLine{00377\ \ \ \ \ std::move(geom),\ std::move(state),\ data.get\_internal\_transform(trav)),\ trav);}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00387\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00388\ render\_billboard(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00390\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *net\_transform\ =\ data.get\_net\_transform(trav);}
\DoxyCodeLine{00391\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *camera\_transform\ =\ trav-\/>get\_camera\_transform();}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ rel\_transform\ =}
\DoxyCodeLine{00394\ \ \ \ \ net\_transform-\/>invert\_compose(camera\_transform);}
\DoxyCodeLine{00395\ \ \ LVector3\ camera\_vec\ =\ LVector3::forward()\ *\ rel\_transform-\/>get\_mat();}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ CurveSegments\ curve\_segments;}
\DoxyCodeLine{00398\ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts\ =\ get\_connected\_segments(curve\_segments,\ result);}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \ \ \textcolor{comment}{//\ Now\ we\ have\ stored\ one\ or\ more\ sequences\ of\ vertices\ down\ the\ center}}
\DoxyCodeLine{00401\ \ \ \textcolor{comment}{//\ strips.\ \ Go\ back\ through\ and\ calculate\ the\ vertices\ on\ either\ side.}}
\DoxyCodeLine{00402\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00403\ \ \ \ \ (\textcolor{stringliteral}{"{}rope"{}},\ get\_format(\textcolor{keyword}{false}),\ Geom::UH\_stream);}
\DoxyCodeLine{00404\ }
\DoxyCodeLine{00405\ \ \ compute\_billboard\_vertices(vdata,\ camera\_vec,}
\DoxyCodeLine{00406\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ curve\_segments,\ num\_curve\_verts,\ result);}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \textcolor{comment}{//\ Since\ this\ will\ be\ a\ nonindexed\ primitive,\ no\ need\ to\ pre-\/reserve\ the}}
\DoxyCodeLine{00409\ \ \ \textcolor{comment}{//\ number\ of\ vertices.}}
\DoxyCodeLine{00410\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_stream);}
\DoxyCodeLine{00411\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00412\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00413\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \ \ strip-\/>add\_next\_vertices(segment.size()\ *\ 2);}
\DoxyCodeLine{00416\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00417\ \ \ \}}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00420\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state;}
\DoxyCodeLine{00423\ \ \ \textcolor{keywordflow}{if}\ (get\_use\_vertex\_color())\ \{}
\DoxyCodeLine{00424\ \ \ \ \ state\ =\ state-\/>add\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00425\ \ \ \}}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(\mbox{\hyperlink{classCullableObject}{CullableObject}}(}
\DoxyCodeLine{00428\ \ \ \ \ std::move(geom),\ std::move(state),\ data.get\_internal\_transform(trav)),\ trav);}
\DoxyCodeLine{00429\ \}}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00438\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00439\ render\_tube(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00441\ \ \ CurveSegments\ curve\_segments;}
\DoxyCodeLine{00442\ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts\ =\ get\_connected\_segments(curve\_segments,\ result);}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00444\ \ \ \textcolor{comment}{//\ Now,\ we\ build\ up\ a\ table\ of\ vertices,\ in\ a\ series\ of\ rings\ around\ the}}
\DoxyCodeLine{00445\ \ \ \textcolor{comment}{//\ circumference\ of\ the\ tube.}}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \ \ \textcolor{keywordtype}{int}\ num\_slices\ =\ get\_num\_slices();}
\DoxyCodeLine{00448\ \ \ \textcolor{keywordtype}{int}\ num\_verts\_per\_slice;}
\DoxyCodeLine{00449\ }
\DoxyCodeLine{00450\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00451\ \ \ \ \ (\textcolor{stringliteral}{"{}rope"{}},\ get\_format(\textcolor{keyword}{true}),\ Geom::UH\_stream);}
\DoxyCodeLine{00452\ }
\DoxyCodeLine{00453\ \ \ compute\_tube\_vertices(vdata,\ num\_verts\_per\_slice,}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ curve\_segments,\ num\_curve\_verts,\ result);}
\DoxyCodeLine{00455\ }
\DoxyCodeLine{00456\ \ \ \textcolor{comment}{//\ Finally,\ go\ through\ and\ build\ up\ the\ index\ array,\ to\ tie\ all\ the\ triangle}}
\DoxyCodeLine{00457\ \ \ \textcolor{comment}{//\ strips\ together.\ \ This\ is\ difficult\ to\ pre-\/calculate\ the\ number\ of}}
\DoxyCodeLine{00458\ \ \ \textcolor{comment}{//\ vertices\ we'll\ use,\ so\ we'll\ just\ let\ it\ dynamically\ allocate.}}
\DoxyCodeLine{00459\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_stream);}
\DoxyCodeLine{00460\ \ \ \textcolor{keywordtype}{int}\ vi\ =\ 0;}
\DoxyCodeLine{00461\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00462\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00465\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ s\ =\ 0;\ s\ <\ num\_slices;\ ++s)\ \{}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ s1\ =\ (s\ +\ 1)\ \%\ num\_verts\_per\_slice;}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00468\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ j\ =\ 0;\ j\ <\ segment.size();\ ++j)\ \{}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \ \ strip-\/>add\_vertex((vi\ +\ j)\ *\ num\_verts\_per\_slice\ +\ s);}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \ \ strip-\/>add\_vertex((vi\ +\ j)\ *\ num\_verts\_per\_slice\ +\ s1);}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00474\ \ \ \ \ \}}
\DoxyCodeLine{00475\ \ \ \ \ vi\ +=\ (int)segment.size();}
\DoxyCodeLine{00476\ \ \ \}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00479\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00480\ }
\DoxyCodeLine{00481\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state;}
\DoxyCodeLine{00482\ \ \ \textcolor{keywordflow}{if}\ (get\_use\_vertex\_color())\ \{}
\DoxyCodeLine{00483\ \ \ \ \ state\ =\ state-\/>add\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00484\ \ \ \}}
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(\mbox{\hyperlink{classCullableObject}{CullableObject}}(}
\DoxyCodeLine{00487\ \ \ \ \ std::move(geom),\ std::move(state),\ data.get\_internal\_transform(trav)),\ trav);}
\DoxyCodeLine{00488\ \}}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00501\ \textcolor{keywordtype}{int}\ RopeNode::}
\DoxyCodeLine{00502\ get\_connected\_segments(\mbox{\hyperlink{classpvector}{RopeNode::CurveSegments}}\ \&curve\_segments,}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00504\ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts\ =\ 0;}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ \ \ \textcolor{keywordtype}{int}\ num\_verts\ =\ get\_num\_subdiv()\ +\ 1;}
\DoxyCodeLine{00507\ \ \ \textcolor{keywordtype}{int}\ num\_segments\ =\ result-\/>get\_num\_segments();}
\DoxyCodeLine{00508\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_color\ =\ get\_use\_vertex\_color();}
\DoxyCodeLine{00509\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_thickness\ =\ get\_use\_vertex\_thickness();}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ \ \ CurveSegment\ *curve\_segment\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00512\ \ \ LPoint3\ last\_point;}
\DoxyCodeLine{00513\ }
\DoxyCodeLine{00514\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ segment\ =\ 0;\ segment\ <\ num\_segments;\ ++segment)\ \{}
\DoxyCodeLine{00515\ \ \ \ \ LPoint3\ point;}
\DoxyCodeLine{00516\ \ \ \ \ result-\/>eval\_segment\_point(segment,\ 0.0f,\ point);}
\DoxyCodeLine{00517\ }
\DoxyCodeLine{00518\ \ \ \ \ \textcolor{comment}{//\ We\ need\ a\ bit\ more\ relaxed\ threshold\ to\ prevent\ breaks\ between}}
\DoxyCodeLine{00519\ \ \ \ \ \textcolor{comment}{//\ segments,\ see\ GitHub\ issue\ \#1325.}}
\DoxyCodeLine{00520\ \textcolor{preprocessor}{\#ifdef\ STDFLOAT\_DOUBLE}}
\DoxyCodeLine{00521\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ threshold\ =\ 1.0e-\/8;}
\DoxyCodeLine{00522\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00523\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}\ threshold\ =\ 1.0e-\/4f;}
\DoxyCodeLine{00524\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{keywordflow}{if}\ (curve\_segment\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ !point.almost\_equal(last\_point,\ threshold))\ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ first\ point\ of\ this\ segment\ is\ different\ from\ the\ last\ point}}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \textcolor{comment}{//\ of\ the\ previous\ segment,\ end\ the\ previous\ segment\ and\ begin\ a\ new}}
\DoxyCodeLine{00530\ \ \ \ \ \ \ \textcolor{comment}{//\ one.}}
\DoxyCodeLine{00531\ \ \ \ \ \ \ curve\_segments.push\_back(CurveSegment());}
\DoxyCodeLine{00532\ \ \ \ \ \ \ curve\_segment\ =\ \&curve\_segments.back();}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \ \ \ \ \ \ CurveVertex\ vtx;}
\DoxyCodeLine{00535\ \ \ \ \ \ \ vtx.\_p\ =\ point;}
\DoxyCodeLine{00536\ \ \ \ \ \ \ vtx.\_t\ =\ result-\/>get\_segment\_t(segment,\ 0.0f);}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_color)\ \{}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \ \ result-\/>eval\_segment\_extended\_points(segment,\ 0.0f,}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_vertex\_color\_dimension(),}
\DoxyCodeLine{00540\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&vtx.\_c[0],\ 4);}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_thickness)\ \{}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ vtx.\_thickness\ =}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ \ \ result-\/>eval\_segment\_extended\_point(segment,\ 0.0f,}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_vertex\_thickness\_dimension());}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00547\ }
\DoxyCodeLine{00548\ \ \ \ \ \ \ curve\_segment-\/>push\_back(vtx);}
\DoxyCodeLine{00549\ \ \ \ \ \ \ ++num\_curve\_verts;}
\DoxyCodeLine{00550\ \ \ \ \ \}}
\DoxyCodeLine{00551\ }
\DoxyCodeLine{00552\ \ \ \ \ \textcolor{comment}{//\ Store\ all\ the\ remaining\ points\ in\ this\ segment.}}
\DoxyCodeLine{00553\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 1;\ i\ <\ num\_verts;\ ++i)\ \{}
\DoxyCodeLine{00554\ \ \ \ \ \ \ PN\_stdfloat\ t\ =\ (PN\_stdfloat)i\ /\ (PN\_stdfloat)(num\_verts\ -\/\ 1);}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ \ \ \ \ \ \ CurveVertex\ vtx;}
\DoxyCodeLine{00557\ \ \ \ \ \ \ result-\/>eval\_segment\_point(segment,\ t,\ vtx.\_p);}
\DoxyCodeLine{00558\ \ \ \ \ \ \ vtx.\_t\ =\ result-\/>get\_segment\_t(segment,\ t);}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_color)\ \{}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ result-\/>eval\_segment\_extended\_points(segment,\ t,}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_vertex\_color\_dimension(),}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&vtx.\_c[0],\ 4);}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_thickness)\ \{}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ vtx.\_thickness\ =}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \ \ result-\/>eval\_segment\_extended\_point(segment,\ t,}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_vertex\_thickness\_dimension());}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ \ \ \ \ curve\_segment-\/>push\_back(vtx);}
\DoxyCodeLine{00571\ \ \ \ \ \ \ ++num\_curve\_verts;}
\DoxyCodeLine{00572\ }
\DoxyCodeLine{00573\ \ \ \ \ \ \ last\_point\ =\ vtx.\_p;}
\DoxyCodeLine{00574\ \ \ \ \ \}}
\DoxyCodeLine{00575\ \ \ \}}
\DoxyCodeLine{00576\ }
\DoxyCodeLine{00577\ \ \ \textcolor{keywordflow}{return}\ num\_curve\_verts;}
\DoxyCodeLine{00578\ \}}
\DoxyCodeLine{00579\ }
\DoxyCodeLine{00584\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00585\ compute\_thread\_vertices(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}\ *vdata,}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{RopeNode::CurveSegments}}\ \&curve\_segments,}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00588\ \ \ vdata-\/>set\_num\_rows(num\_curve\_verts);}
\DoxyCodeLine{00589\ }
\DoxyCodeLine{00590\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00591\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ \mbox{\hyperlink{structcolor}{color}}(vdata,\ InternalName::get\_color());}
\DoxyCodeLine{00592\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ texcoord(vdata,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00593\ }
\DoxyCodeLine{00594\ \ \ UVMode\ uv\_mode\ =\ get\_uv\_mode();}
\DoxyCodeLine{00595\ \ \ PN\_stdfloat\ uv\_scale\ =\ get\_uv\_scale();}
\DoxyCodeLine{00596\ \ \ \textcolor{keywordtype}{bool}\ u\_dominant\ =\ get\_uv\_direction();}
\DoxyCodeLine{00597\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_color\ =\ get\_use\_vertex\_color();}
\DoxyCodeLine{00598\ }
\DoxyCodeLine{00599\ \ \ PN\_stdfloat\ dist\ =\ 0.0f;}
\DoxyCodeLine{00600\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00601\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00602\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00603\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ j\ =\ 0;\ j\ <\ segment.size();\ ++j)\ \{}
\DoxyCodeLine{00604\ \ \ \ \ \ \ vertex.add\_data3(segment[j].\_p);}
\DoxyCodeLine{00605\ }
\DoxyCodeLine{00606\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_color)\ \{}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structcolor}{color}}.add\_data4(segment[j].\_c);}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00609\ }
\DoxyCodeLine{00610\ \ \ \ \ \ \ PN\_stdfloat\ uv\_t\ =\ compute\_uv\_t(dist,\ uv\_mode,\ uv\_scale,\ segment,\ j);}
\DoxyCodeLine{00611\ }
\DoxyCodeLine{00612\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (uv\_mode\ !=\ UV\_none)\ \{}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (u\_dominant)\ \{}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(uv\_t,\ 0.0f);}
\DoxyCodeLine{00615\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(0.0f,\ uv\_t);}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00619\ \ \ \ \ \}}
\DoxyCodeLine{00620\ \ \ \}}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ \ \ nassertv(vdata-\/>get\_num\_rows()\ ==\ num\_curve\_verts);}
\DoxyCodeLine{00623\ \}}
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00629\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00630\ compute\_billboard\_vertices(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}\ *vdata,}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVector3\ \&camera\_vec,}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{RopeNode::CurveSegments}}\ \&curve\_segments,}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts,}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00635\ \ \ \textcolor{keywordtype}{int}\ expected\_num\_verts\ =\ num\_curve\_verts\ *\ 2;}
\DoxyCodeLine{00636\ \ \ vdata-\/>set\_num\_rows(expected\_num\_verts);}
\DoxyCodeLine{00637\ }
\DoxyCodeLine{00638\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00639\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ \mbox{\hyperlink{structcolor}{color}}(vdata,\ InternalName::get\_color());}
\DoxyCodeLine{00640\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ texcoord(vdata,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00642\ \ \ PN\_stdfloat\ thickness\ =\ get\_thickness();}
\DoxyCodeLine{00643\ \ \ PN\_stdfloat\ overall\_radius\ =\ thickness\ *\ 0.5f;}
\DoxyCodeLine{00644\ \ \ PN\_stdfloat\ radius\ =\ overall\_radius;}
\DoxyCodeLine{00645\ \ \ UVMode\ uv\_mode\ =\ get\_uv\_mode();}
\DoxyCodeLine{00646\ \ \ PN\_stdfloat\ uv\_scale\ =\ get\_uv\_scale();}
\DoxyCodeLine{00647\ \ \ \textcolor{keywordtype}{bool}\ u\_dominant\ =\ get\_uv\_direction();}
\DoxyCodeLine{00648\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_color\ =\ get\_use\_vertex\_color();}
\DoxyCodeLine{00649\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_thickness\ =\ get\_use\_vertex\_thickness();}
\DoxyCodeLine{00650\ }
\DoxyCodeLine{00651\ \ \ PN\_stdfloat\ dist\ =\ 0.0f;}
\DoxyCodeLine{00652\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00653\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00654\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00655\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ j\ =\ 0;\ j\ <\ segment.size();\ ++j)\ \{}
\DoxyCodeLine{00656\ \ \ \ \ \ \ LVector3\ tangent;}
\DoxyCodeLine{00657\ \ \ \ \ \ \ compute\_tangent(tangent,\ segment,\ j,\ result);}
\DoxyCodeLine{00658\ }
\DoxyCodeLine{00659\ \ \ \ \ \ \ LVector3\ norm\ =\ cross(tangent,\ camera\_vec);}
\DoxyCodeLine{00660\ \ \ \ \ \ \ norm.normalize();}
\DoxyCodeLine{00661\ }
\DoxyCodeLine{00662\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_thickness)\ \{}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ radius\ =\ overall\_radius\ *\ segment[j].\_thickness;}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00665\ }
\DoxyCodeLine{00666\ \ \ \ \ \ \ vertex.add\_data3(segment[j].\_p\ +\ norm\ *\ radius);}
\DoxyCodeLine{00667\ \ \ \ \ \ \ vertex.add\_data3(segment[j].\_p\ -\/\ norm\ *\ radius);}
\DoxyCodeLine{00668\ }
\DoxyCodeLine{00669\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_color)\ \{}
\DoxyCodeLine{00670\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structcolor}{color}}.add\_data4(segment[j].\_c);}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structcolor}{color}}.add\_data4(segment[j].\_c);}
\DoxyCodeLine{00672\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00673\ }
\DoxyCodeLine{00674\ \ \ \ \ \ \ PN\_stdfloat\ uv\_t\ =\ compute\_uv\_t(dist,\ uv\_mode,\ uv\_scale,\ segment,\ j);}
\DoxyCodeLine{00675\ }
\DoxyCodeLine{00676\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (uv\_mode\ !=\ UV\_none)\ \{}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (u\_dominant)\ \{}
\DoxyCodeLine{00678\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(uv\_t,\ 1.0f);}
\DoxyCodeLine{00679\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(uv\_t,\ 0.0f);}
\DoxyCodeLine{00680\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00681\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(1.0f,\ uv\_t);}
\DoxyCodeLine{00682\ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(0.0f,\ uv\_t);}
\DoxyCodeLine{00683\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00684\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00685\ \ \ \ \ \}}
\DoxyCodeLine{00686\ \ \ \}}
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00688\ \ \ nassertv(vdata-\/>get\_num\_rows()\ ==\ expected\_num\_verts);}
\DoxyCodeLine{00689\ \}}
\DoxyCodeLine{00690\ }
\DoxyCodeLine{00695\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00696\ compute\_tube\_vertices(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}\ *vdata,}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \&num\_verts\_per\_slice,}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{RopeNode::CurveSegments}}\ \&curve\_segments,}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_curve\_verts,}
\DoxyCodeLine{00700\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00701\ \ \ \textcolor{keywordtype}{int}\ num\_slices\ =\ get\_num\_slices();}
\DoxyCodeLine{00702\ \ \ num\_verts\_per\_slice\ =\ num\_slices;}
\DoxyCodeLine{00703\ }
\DoxyCodeLine{00704\ \ \ PN\_stdfloat\ thickness\ =\ get\_thickness();}
\DoxyCodeLine{00705\ \ \ PN\_stdfloat\ overall\_radius\ =\ thickness\ *\ 0.5f;}
\DoxyCodeLine{00706\ \ \ PN\_stdfloat\ radius\ =\ overall\_radius;}
\DoxyCodeLine{00707\ \ \ UVMode\ uv\_mode\ =\ get\_uv\_mode();}
\DoxyCodeLine{00708\ \ \ PN\_stdfloat\ uv\_scale\ =\ get\_uv\_scale();}
\DoxyCodeLine{00709\ \ \ \textcolor{keywordtype}{bool}\ u\_dominant\ =\ get\_uv\_direction();}
\DoxyCodeLine{00710\ \ \ NormalMode\ normal\_mode\ =\ get\_normal\_mode();}
\DoxyCodeLine{00711\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_color\ =\ get\_use\_vertex\_color();}
\DoxyCodeLine{00712\ \ \ \textcolor{keywordtype}{bool}\ use\_vertex\_thickness\ =\ get\_use\_vertex\_thickness();}
\DoxyCodeLine{00713\ }
\DoxyCodeLine{00714\ \ \ \textcolor{comment}{//\ If\ we\ are\ generating\ UV's,\ we\ will\ need\ to\ duplicate\ the\ vertices\ along}}
\DoxyCodeLine{00715\ \ \ \textcolor{comment}{//\ the\ seam\ so\ that\ the\ UV's\ go\ through\ the\ whole\ range\ of\ 0..1\ instead\ of}}
\DoxyCodeLine{00716\ \ \ \textcolor{comment}{//\ reflecting\ in\ the\ last\ polygon\ before\ the\ seam.}}
\DoxyCodeLine{00717\ \ \ \textcolor{keywordflow}{if}\ (uv\_mode\ !=\ UV\_none)\ \{}
\DoxyCodeLine{00718\ \ \ \ \ ++num\_verts\_per\_slice;}
\DoxyCodeLine{00719\ \ \ \}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00721\ \ \ \textcolor{keywordtype}{int}\ expected\_num\_verts\ =\ num\_curve\_verts\ *\ num\_verts\_per\_slice;}
\DoxyCodeLine{00722\ \ \ vdata-\/>set\_num\_rows(expected\_num\_verts);}
\DoxyCodeLine{00723\ }
\DoxyCodeLine{00724\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00725\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ normal(vdata,\ InternalName::get\_normal());}
\DoxyCodeLine{00726\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ \mbox{\hyperlink{structcolor}{color}}(vdata,\ InternalName::get\_color());}
\DoxyCodeLine{00727\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ texcoord(vdata,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00728\ }
\DoxyCodeLine{00729\ \ \ LVector3\ up\ =\ get\_tube\_up();}
\DoxyCodeLine{00730\ }
\DoxyCodeLine{00731\ \ \ PN\_stdfloat\ dist\ =\ 0.0f;}
\DoxyCodeLine{00732\ \ \ CurveSegments::const\_iterator\ si;}
\DoxyCodeLine{00733\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ curve\_segments.begin();\ si\ !=\ curve\_segments.end();\ ++si)\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \textcolor{keyword}{const}\ CurveSegment\ \&segment\ =\ (*si);}
\DoxyCodeLine{00735\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ j\ =\ 0;\ j\ <\ segment.size();\ ++j)\ \{}
\DoxyCodeLine{00736\ \ \ \ \ \ \ LVector3\ tangent;}
\DoxyCodeLine{00737\ \ \ \ \ \ \ compute\_tangent(tangent,\ segment,\ j,\ result);}
\DoxyCodeLine{00738\ }
\DoxyCodeLine{00739\ \ \ \ \ \ \ LVector3\ norm\ =\ cross(tangent,\ up);}
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \ \ \ \ \ \ \textcolor{comment}{//\ In\ case\ the\ tangent\ is\ linear\ dependent\ on\ the\ up\ vector,\ we\ might}}
\DoxyCodeLine{00742\ \ \ \ \ \ \ \textcolor{comment}{//\ get\ invalid\ results,\ so\ check\ that}}
\DoxyCodeLine{00743\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(norm.length\_squared()))\ \{}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00745\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(tangent.get\_y())\ \&\&\ IS\_NEARLY\_ZERO(tangent.get\_z()))\ \{}
\DoxyCodeLine{00746\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Vector\ is\ linear\ dependent\ on\ (1,\ 0,\ 0),\ use\ (0,\ 1,\ 0)\ as\ base}}
\DoxyCodeLine{00747\ \ \ \ \ \ \ \ \ \ \ norm\ =\ cross(tangent,\ LVector3(0,\ 1,\ 0));}
\DoxyCodeLine{00748\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00749\ \ \ \ \ \ \ \ \ \ \ norm\ =\ cross(tangent,\ LVector3(1,\ 0,\ 0));}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00751\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00752\ }
\DoxyCodeLine{00753\ \ \ \ \ \ \ norm.normalize();}
\DoxyCodeLine{00754\ \ \ \ \ \ \ up\ =\ cross(norm,\ tangent);}
\DoxyCodeLine{00755\ }
\DoxyCodeLine{00756\ \ \ \ \ \ \ LMatrix3\ rotate\ =\ LMatrix3::rotate\_mat(360.0f\ /\ (PN\_stdfloat)num\_slices,}
\DoxyCodeLine{00757\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tangent);}
\DoxyCodeLine{00758\ }
\DoxyCodeLine{00759\ \ \ \ \ \ \ PN\_stdfloat\ uv\_t\ =\ compute\_uv\_t(dist,\ uv\_mode,\ uv\_scale,\ segment,\ j);}
\DoxyCodeLine{00760\ }
\DoxyCodeLine{00761\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ s\ =\ 0;\ s\ <\ num\_verts\_per\_slice;\ ++s)\ \{}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_thickness)\ \{}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \ \ \ \ radius\ =\ overall\_radius\ *\ segment[j].\_thickness;}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00765\ }
\DoxyCodeLine{00766\ \ \ \ \ \ \ \ \ vertex.add\_data3(segment[j].\_p\ +\ norm\ *\ radius);}
\DoxyCodeLine{00767\ }
\DoxyCodeLine{00768\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (normal\_mode\ ==\ NM\_vertex)\ \{}
\DoxyCodeLine{00769\ \ \ \ \ \ \ \ \ \ \ normal.add\_data3(norm);}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00771\ }
\DoxyCodeLine{00772\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_vertex\_color)\ \{}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structcolor}{color}}.add\_data4(segment[j].\_c);}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ norm\ =\ norm\ *\ rotate;}
\DoxyCodeLine{00777\ }
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (uv\_mode\ !=\ UV\_none)\ \{}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ uv\_s\ =\ (PN\_stdfloat)s\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00780\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (u\_dominant)\ \{}
\DoxyCodeLine{00781\ \ \ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(uv\_t,\ uv\_s);}
\DoxyCodeLine{00782\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00783\ \ \ \ \ \ \ \ \ \ \ \ \ texcoord.add\_data2(uv\_s,\ uv\_t);}
\DoxyCodeLine{00784\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00785\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00786\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00787\ \ \ \ \ \}}
\DoxyCodeLine{00788\ \ \ \}}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \ \ nassertv(vdata-\/>get\_num\_rows()\ ==\ expected\_num\_verts);}
\DoxyCodeLine{00791\ \}}
\DoxyCodeLine{00792\ }
\DoxyCodeLine{00796\ \textcolor{keywordtype}{void}\ RopeNode::}
\DoxyCodeLine{00797\ compute\_tangent(LVector3\ \&tangent,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{RopeNode::CurveSegment}}\ \&segment,}
\DoxyCodeLine{00798\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ j,\ \mbox{\hyperlink{classNurbsCurveResult}{NurbsCurveResult}}\ *result)\ \{}
\DoxyCodeLine{00799\ \ \ \textcolor{comment}{//\ First,\ try\ to\ evaluate\ the\ tangent\ at\ the\ curve.\ \ This\ gives\ better}}
\DoxyCodeLine{00800\ \ \ \textcolor{comment}{//\ results\ at\ the\ ends\ at\ the\ endpoints\ where\ the\ tangent\ does\ not\ go\ to}}
\DoxyCodeLine{00801\ \ \ \textcolor{comment}{//\ zero.}}
\DoxyCodeLine{00802\ }
\DoxyCodeLine{00803\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00804\ \textcolor{comment}{\ \ \ \ Actually,\ on\ second\ thought\ this\ looks\ terrible.}}
\DoxyCodeLine{00805\ \textcolor{comment}{}}
\DoxyCodeLine{00806\ \textcolor{comment}{\ \ if\ (result-\/>eval\_tangent(segment[j].\_t,\ tangent))\ \{}}
\DoxyCodeLine{00807\ \textcolor{comment}{\ \ \ \ if\ (!tangent.almost\_equal(LVector3::zero()))\ \{}}
\DoxyCodeLine{00808\ \textcolor{comment}{\ \ \ \ \ \ return;}}
\DoxyCodeLine{00809\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00810\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00811\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00812\ }
\DoxyCodeLine{00813\ \ \ \textcolor{comment}{//\ If\ that\ failed\ (or\ produced\ a\ zero\ tangent),\ then\ derive\ the\ tangent\ from}}
\DoxyCodeLine{00814\ \ \ \textcolor{comment}{//\ the\ neighboring\ points\ instead.}}
\DoxyCodeLine{00815\ \ \ \textcolor{keywordflow}{if}\ (j\ ==\ 0)\ \{}
\DoxyCodeLine{00816\ \ \ \ \ tangent\ =\ segment[j\ +\ 1].\_p\ -\/\ segment[j].\_p;}
\DoxyCodeLine{00817\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (j\ ==\ segment.size()\ -\/\ 1)\ \{}
\DoxyCodeLine{00818\ \ \ \ \ tangent\ =\ segment[j].\_p\ -\/\ segment[j\ -\/\ 1].\_p;}
\DoxyCodeLine{00819\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00820\ \ \ \ \ tangent\ =\ segment[j\ +\ 1].\_p\ -\/\ segment[j\ -\/\ 1].\_p;}
\DoxyCodeLine{00821\ \ \ \}}
\DoxyCodeLine{00822\ }
\DoxyCodeLine{00823\ \ \ \textcolor{comment}{//\ Avoid\ empty\ tangents,\ these\ lead\ to\ crashes.\ \ Instead,\ use\ an\ arbitrary}}
\DoxyCodeLine{00824\ \ \ \textcolor{comment}{//\ tangent.}}
\DoxyCodeLine{00825\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(tangent.length\_squared()))\ \{}
\DoxyCodeLine{00826\ \ \ \ \ tangent.set(0,\ 0,\ 1);}
\DoxyCodeLine{00827\ \ \ \}}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \}}
\DoxyCodeLine{00830\ }
\DoxyCodeLine{00835\ PN\_stdfloat\ RopeNode::}
\DoxyCodeLine{00836\ compute\_uv\_t(PN\_stdfloat\ \&dist,\ \textcolor{keyword}{const}\ RopeNode::UVMode\ \&uv\_mode,}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ uv\_scale,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{RopeNode::CurveSegment}}\ \&segment,}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ j)\ \{}
\DoxyCodeLine{00839\ \ \ \textcolor{keywordflow}{switch}\ (uv\_mode)\ \{}
\DoxyCodeLine{00840\ \ \ \textcolor{keywordflow}{case}\ UV\_none:}
\DoxyCodeLine{00841\ \ \ \ \ \textcolor{keywordflow}{return}\ 0.0f;}
\DoxyCodeLine{00842\ }
\DoxyCodeLine{00843\ \ \ \textcolor{keywordflow}{case}\ UV\_parametric:}
\DoxyCodeLine{00844\ \ \ \ \ \textcolor{keywordflow}{return}\ segment[j].\_t\ *\ uv\_scale;}
\DoxyCodeLine{00845\ }
\DoxyCodeLine{00846\ \ \ \textcolor{keywordflow}{case}\ UV\_distance:}
\DoxyCodeLine{00847\ \ \ \ \ \textcolor{keywordflow}{if}\ (j\ !=\ 0)\ \{}
\DoxyCodeLine{00848\ \ \ \ \ \ \ LVector3\ vec\ =\ segment[j].\_p\ -\/\ segment[j\ -\/\ 1].\_p;}
\DoxyCodeLine{00849\ \ \ \ \ \ \ dist\ +=\ vec.length();}
\DoxyCodeLine{00850\ \ \ \ \ \}}
\DoxyCodeLine{00851\ \ \ \ \ \textcolor{keywordflow}{return}\ dist\ *\ uv\_scale;}
\DoxyCodeLine{00852\ }
\DoxyCodeLine{00853\ \ \ \textcolor{keywordflow}{case}\ UV\_distance2:}
\DoxyCodeLine{00854\ \ \ \ \ \textcolor{keywordflow}{if}\ (j\ !=\ 0)\ \{}
\DoxyCodeLine{00855\ \ \ \ \ \ \ LVector3\ vec\ =\ segment[j].\_p\ -\/\ segment[j\ -\/\ 1].\_p;}
\DoxyCodeLine{00856\ \ \ \ \ \ \ dist\ +=\ vec.length\_squared();}
\DoxyCodeLine{00857\ \ \ \ \ \}}
\DoxyCodeLine{00858\ \ \ \ \ \textcolor{keywordflow}{return}\ dist\ *\ uv\_scale;}
\DoxyCodeLine{00859\ \ \ \}}
\DoxyCodeLine{00860\ }
\DoxyCodeLine{00861\ \ \ \textcolor{keywordflow}{return}\ 0.0f;}
\DoxyCodeLine{00862\ \}}
\DoxyCodeLine{00863\ }
\DoxyCodeLine{00867\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classRopeNode_aacfd04f49822534bc5593b27fadcaf2a}{RopeNode::}}}
\DoxyCodeLine{00868\ \mbox{\hyperlink{classRopeNode_aacfd04f49822534bc5593b27fadcaf2a}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00869\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classRopeNode_a834717519098cf90d39ccaef80c5f0d8}{make\_from\_bam}});}
\DoxyCodeLine{00870\ \}}
\DoxyCodeLine{00871\ }
\DoxyCodeLine{00876\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classRopeNode_ae3bbdb8bdca6248e66c13c62568eeb73}{RopeNode::}}}
\DoxyCodeLine{00877\ \mbox{\hyperlink{classRopeNode_ae3bbdb8bdca6248e66c13c62568eeb73}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00878\ \ \ \mbox{\hyperlink{classPandaNode_ae9b3055297ade9bbf4a3b4dfc77e4506}{PandaNode::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00879\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{00880\ \}}
\DoxyCodeLine{00881\ }
\DoxyCodeLine{00887\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classRopeNode_a834717519098cf90d39ccaef80c5f0d8}{RopeNode::}}}
\DoxyCodeLine{00888\ \mbox{\hyperlink{classRopeNode_a834717519098cf90d39ccaef80c5f0d8}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00889\ \ \ \mbox{\hyperlink{classRopeNode}{RopeNode}}\ *node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classRopeNode}{RopeNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00890\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00891\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00892\ }
\DoxyCodeLine{00893\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00894\ \ \ node-\/>\mbox{\hyperlink{classRopeNode_a6899499c27e2fb4cb0bf1d5580e0b72d}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00895\ }
\DoxyCodeLine{00896\ \ \ \textcolor{keywordflow}{return}\ node;}
\DoxyCodeLine{00897\ \}}
\DoxyCodeLine{00898\ }
\DoxyCodeLine{00903\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classRopeNode_a6899499c27e2fb4cb0bf1d5580e0b72d}{RopeNode::}}}
\DoxyCodeLine{00904\ \mbox{\hyperlink{classRopeNode_a6899499c27e2fb4cb0bf1d5580e0b72d}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00905\ \ \ \mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{PandaNode::fillin}}(scan,\ manager);}
\DoxyCodeLine{00906\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{00907\ \}}

\end{DoxyCode}
