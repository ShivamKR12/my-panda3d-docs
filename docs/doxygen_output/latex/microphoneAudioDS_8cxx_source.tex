\doxysection{microphone\+Audio\+DS.\+cxx}
\hypertarget{microphoneAudioDS_8cxx_source}{}\label{microphoneAudioDS_8cxx_source}\index{panda/src/movies/microphoneAudioDS.cxx@{panda/src/movies/microphoneAudioDS.cxx}}
\mbox{\hyperlink{microphoneAudioDS_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifdef\ HAVE\_DIRECTCAM}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#ifndef\ WIN32\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#define\ WIN32\_LEAN\_AND\_MEAN\ 1}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#undef\ Configure}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{windows_8h}{windows.h}}>}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{mmsystem_8h}{mmsystem.h}}>}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{class\ }MicrophoneAudioDS\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classMicrophoneAudio}{MicrophoneAudio}}\ \{}
\DoxyCodeLine{00035\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00036\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ find\_all\_microphones\_ds();}
\DoxyCodeLine{00037\ \ \ \textcolor{keyword}{friend}\ \textcolor{keywordtype}{void}\ find\_all\_microphones\_ds();}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00040\ \ \ \textcolor{keyword}{virtual}\ PT(\mbox{\hyperlink{classMovieAudioCursor}{MovieAudioCursor}})\ open();}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \textcolor{keywordtype}{int}\ \_device\_id;}
\DoxyCodeLine{00043\ \ \ \textcolor{keywordtype}{int}\ \_manufacturer\_id;}
\DoxyCodeLine{00044\ \ \ \textcolor{keywordtype}{int}\ \_product\_id;}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \textcolor{keyword}{struct\ }AudioBuf\ \{}
\DoxyCodeLine{00047\ \ \ \ \ HGLOBAL\ \ \ \_storage\_gh;}
\DoxyCodeLine{00048\ \ \ \ \ HGLOBAL\ \ \ \_header\_gh;}
\DoxyCodeLine{00049\ \ \ \ \ LPSTR\ \ \ \ \ \_storage;}
\DoxyCodeLine{00050\ \ \ \ \ LPWAVEHDR\ \_header;}
\DoxyCodeLine{00051\ \ \ \};}
\DoxyCodeLine{00052\ \ \ \textcolor{keyword}{typedef}\ pvector\ <AudioBuf>\ AudioBuffers;}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ delete\_buffers(AudioBuffers\ \&buffers);}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }MicrophoneAudioCursorDS;}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00059\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_class\_type()\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{return}\ \_type\_handle;}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ init\_type()\ \{}
\DoxyCodeLine{00063\ \ \ \ \ MicrophoneAudio::init\_type();}
\DoxyCodeLine{00064\ \ \ \ \ \mbox{\hyperlink{register__type_8h_a54fc7cae2908ec9e8da7174a8d027735}{register\_type}}(\_type\_handle,\ \textcolor{stringliteral}{"{}MicrophoneAudioDS"{}},}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MicrophoneAudio::get\_class\_type());}
\DoxyCodeLine{00066\ \ \ \}}
\DoxyCodeLine{00067\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_type()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordflow}{return}\ get\_class\_type();}
\DoxyCodeLine{00069\ \ \ \}}
\DoxyCodeLine{00070\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ force\_init\_type()\ \{init\_type();\ \textcolor{keywordflow}{return}\ get\_class\_type();\}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00073\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ \_type\_handle;}
\DoxyCodeLine{00074\ \};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ MicrophoneAudioDS::\_type\_handle;}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00082\ \textcolor{keyword}{class\ }MicrophoneAudioCursorDS\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classMovieAudioCursor}{MovieAudioCursor}}}
\DoxyCodeLine{00083\ \{}
\DoxyCodeLine{00084\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00085\ \ \ \textcolor{keyword}{typedef}\ MicrophoneAudioDS::AudioBuffers\ AudioBuffers;}
\DoxyCodeLine{00086\ \ \ MicrophoneAudioCursorDS(MicrophoneAudioDS\ *src,\ AudioBuffers\ \&bufs,\ HWAVEIN\ hwav);}
\DoxyCodeLine{00087\ \ \ \textcolor{keyword}{virtual}\ \string~MicrophoneAudioCursorDS();}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ AudioBuffers\ \_buffers;}
\DoxyCodeLine{00090\ \ \ HWAVEIN\ \_hwavein;}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{int}\ \_samples\_per\_buffer;}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00094\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ read\_samples(\textcolor{keywordtype}{int}\ n,\ int16\_t\ *data);}
\DoxyCodeLine{00095\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ ready()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordtype}{void}\ cleanup();}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ HWAVEIN\ \_handle;}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \_next;\ \ \ \ \textcolor{comment}{//\ Which\ buffer\ is\ the\ next\ one\ to\ read\ from.}}
\DoxyCodeLine{00102\ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \_offset;\ \ \textcolor{comment}{//\ How\ many\ samples\ to\ skip\ in\ the\ buffer.}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00105\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_class\_type()\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordflow}{return}\ \_type\_handle;}
\DoxyCodeLine{00107\ \ \ \}}
\DoxyCodeLine{00108\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ init\_type()\ \{}
\DoxyCodeLine{00109\ \ \ \ \ MovieAudioCursor::init\_type();}
\DoxyCodeLine{00110\ \ \ \ \ \mbox{\hyperlink{register__type_8h_a54fc7cae2908ec9e8da7174a8d027735}{register\_type}}(\_type\_handle,\ \textcolor{stringliteral}{"{}MicrophoneAudioCursorDS"{}},}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MovieAudioCursor::get\_class\_type());}
\DoxyCodeLine{00112\ \ \ \}}
\DoxyCodeLine{00113\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_type()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{keywordflow}{return}\ get\_class\_type();}
\DoxyCodeLine{00115\ \ \ \}}
\DoxyCodeLine{00116\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ force\_init\_type()\ \{init\_type();\ \textcolor{keywordflow}{return}\ get\_class\_type();\}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00119\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ \_type\_handle;}
\DoxyCodeLine{00120\ \};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ MicrophoneAudioCursorDS::\_type\_handle;}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00128\ \textcolor{keywordtype}{void}\ MicrophoneAudioDS::}
\DoxyCodeLine{00129\ find\_all\_microphones\_ds()\ \{}
\DoxyCodeLine{00130\ \ \ MMRESULT\ stat;}
\DoxyCodeLine{00131\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ freqs[]\ =\ \{\ 11025,\ 22050,\ 44100,\ 48000,\ 0\ \};}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{keywordtype}{int}\ ndevs\ =\ waveInGetNumDevs();}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<ndevs;\ i++)\ \{}
\DoxyCodeLine{00135\ \ \ \ \ WAVEINCAPS\ caps;}
\DoxyCodeLine{00136\ \ \ \ \ stat\ =\ waveInGetDevCaps(i,\ \&caps,\ \textcolor{keyword}{sizeof}(caps));}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ !=\ MMSYSERR\_NOERROR)\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ chan=1;\ chan<=2;\ chan++)\ \{}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ fselect=0;\ freqs[fselect];\ fselect++)\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ WAVEFORMATEX\ format;}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ freq\ =\ freqs[fselect];}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ format.wFormatTag\ =\ WAVE\_FORMAT\_PCM;}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ format.nChannels\ =\ chan;}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ format.nSamplesPerSec\ =\ freq;}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ format.nAvgBytesPerSec\ =\ freq\ *\ chan\ *\ 2;}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ format.nBlockAlign\ =\ 2\ *\ chan;}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ format.wBitsPerSample\ =\ 16;}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ format.cbSize\ =\ 0;}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ stat\ =\ waveInOpen(\textcolor{keyword}{nullptr},\ i,\ \&format,\ 0,\ 0,\ WAVE\_FORMAT\_QUERY);}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ ==\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ PT(MicrophoneAudioDS)\ p\ =\ \textcolor{keyword}{new}\ MicrophoneAudioDS();}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}}\ name;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ name\ <<\ \textcolor{stringliteral}{"{}WaveIn:\ "{}}\ <<\ caps.szPname\ <<\ \textcolor{stringliteral}{"{}\ Chan:"{}}\ <<\ chan\ <<\ \textcolor{stringliteral}{"{}\ HZ:"{}}\ <<\ freq;}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ p-\/>set\_name(name.str());}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ p-\/>\_device\_id\ =\ i;}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ p-\/>\_manufacturer\_id\ =\ caps.wMid;}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ p-\/>\_product\_id\ =\ caps.wPid;}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ p-\/>\_rate\ =\ freq;}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ p-\/>\_channels\ =\ chan;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \_all\_microphones.push\_back((MicrophoneAudioDS*)p);}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ \ \ \}}
\DoxyCodeLine{00165\ \}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \textcolor{keywordtype}{void}\ find\_all\_microphones\_ds()\ \{}
\DoxyCodeLine{00168\ \ \ MicrophoneAudioDS::init\_type();}
\DoxyCodeLine{00169\ \ \ \textcolor{comment}{//\ MicrophoneAudioCursorDS::init\_type();}}
\DoxyCodeLine{00170\ \ \ MicrophoneAudioDS::find\_all\_microphones\_ds();}
\DoxyCodeLine{00171\ \}}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00176\ \textcolor{keywordtype}{void}\ MicrophoneAudioDS::}
\DoxyCodeLine{00177\ delete\_buffers(AudioBuffers\ \&buffers)\ \{}
\DoxyCodeLine{00178\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<(int)buffers.size();\ i++)\ \{}
\DoxyCodeLine{00179\ \ \ \ \ AudioBuf\ \&buf\ =\ buffers[i];}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keywordflow}{if}\ (buf.\_header\_gh)\ \{}
\DoxyCodeLine{00181\ \ \ \ \ \ \ GlobalUnlock(buf.\_header\_gh);}
\DoxyCodeLine{00182\ \ \ \ \ \ \ GlobalFree(buf.\_header\_gh);}
\DoxyCodeLine{00183\ \ \ \ \ \}}
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordflow}{if}\ (buf.\_storage\_gh)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ GlobalUnlock(buf.\_storage\_gh);}
\DoxyCodeLine{00186\ \ \ \ \ \ \ GlobalFree(buf.\_storage\_gh);}
\DoxyCodeLine{00187\ \ \ \ \ \}}
\DoxyCodeLine{00188\ \ \ \}}
\DoxyCodeLine{00189\ \ \ buffers.clear();}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00195\ PT(\mbox{\hyperlink{classMovieAudioCursor}{MovieAudioCursor}})\ MicrophoneAudioDS::}
\DoxyCodeLine{00196\ open()\ \{}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \textcolor{comment}{//\ Allocate\ the\ buffers.\ \ 64\ buffers,\ not\ quite\ 120\ sec\ each.}}
\DoxyCodeLine{00199\ \ \ \textcolor{keywordtype}{int}\ samples;}
\DoxyCodeLine{00200\ \ \ \textcolor{keywordflow}{switch}\ (\_rate)\ \{}
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{case}\ 11025:\ samples=512;\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{case}\ 22050:\ samples=1024;\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00203\ \ \ \textcolor{keywordflow}{case}\ 44100:\ samples=2048;\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ \ \ \textcolor{keywordtype}{int}\ bytes\ =\ \_channels\ *\ samples\ *\ 2;}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \textcolor{keywordtype}{bool}\ failed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00208\ \ \ AudioBuffers\ buffers;}
\DoxyCodeLine{00209\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<64;\ i++)\ \{}
\DoxyCodeLine{00210\ \ \ \ \ AudioBuf\ buf;}
\DoxyCodeLine{00211\ \ \ \ \ buf.\_storage\_gh\ =\ 0;}
\DoxyCodeLine{00212\ \ \ \ \ buf.\_header\_gh\ =\ 0;}
\DoxyCodeLine{00213\ \ \ \ \ buf.\_storage\ =\ 0;}
\DoxyCodeLine{00214\ \ \ \ \ buf.\_header\ =\ 0;}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \ \ buf.\_storage\_gh\ =\ GlobalAlloc(GMEM\_MOVEABLE\ |\ GMEM\_SHARE,\ bytes);}
\DoxyCodeLine{00217\ \ \ \ \ buf.\_header\_gh\ =\ GlobalAlloc(GMEM\_MOVEABLE\ |\ GMEM\_SHARE,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keywordflow}{if}\ (buf.\_storage\_gh\ !=\ 0)\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ buf.\_storage\ =\ (LPSTR)GlobalLock(buf.\_storage\_gh);}
\DoxyCodeLine{00220\ \ \ \ \ \}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{keywordflow}{if}\ (buf.\_header\_gh\ !=\ 0)\ \{}
\DoxyCodeLine{00222\ \ \ \ \ \ \ buf.\_header\ =\ (LPWAVEHDR)GlobalLock(buf.\_header\_gh);}
\DoxyCodeLine{00223\ \ \ \ \ \}}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keywordflow}{if}\ (buf.\_storage\ \&\&\ buf.\_header)\ \{}
\DoxyCodeLine{00225\ \ \ \ \ \ \ ZeroMemory(buf.\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00226\ \ \ \ \ \ \ buf.\_header-\/>lpData\ =\ buf.\_storage;}
\DoxyCodeLine{00227\ \ \ \ \ \ \ buf.\_header-\/>dwBufferLength\ =\ bytes;}
\DoxyCodeLine{00228\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \ \ failed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00230\ \ \ \ \ \}}
\DoxyCodeLine{00231\ \ \ \ \ buffers.push\_back(buf);}
\DoxyCodeLine{00232\ \ \ \ \ \textcolor{keywordflow}{if}\ (failed)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00233\ \ \ \}}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ \textcolor{keywordflow}{if}\ (failed)\ \{}
\DoxyCodeLine{00236\ \ \ \ \ delete\_buffers(buffers);}
\DoxyCodeLine{00237\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}Could\ not\ allocate\ audio\ input\ buffers."{}});}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00239\ \ \ \}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ WAVEFORMATEX\ format;}
\DoxyCodeLine{00242\ \ \ format.wFormatTag\ =\ WAVE\_FORMAT\_PCM;}
\DoxyCodeLine{00243\ \ \ format.nChannels\ =\ \_channels;}
\DoxyCodeLine{00244\ \ \ format.nSamplesPerSec\ =\ \_rate;}
\DoxyCodeLine{00245\ \ \ format.nAvgBytesPerSec\ =\ \_rate\ *\ \_channels\ *\ 2;}
\DoxyCodeLine{00246\ \ \ format.nBlockAlign\ =\ 2\ *\ \_channels;}
\DoxyCodeLine{00247\ \ \ format.wBitsPerSample\ =\ 16;}
\DoxyCodeLine{00248\ \ \ format.cbSize\ =\ 0;}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ \ \ HWAVEIN\ hwav;}
\DoxyCodeLine{00251\ \ \ MMRESULT\ stat\ =\ waveInOpen(\&hwav,\ \_device\_id,\ \&format,\ 0,\ 0,\ CALLBACK\_NULL);}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{keywordflow}{if}\ (stat\ !=\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00254\ \ \ \ \ delete\_buffers(buffers);}
\DoxyCodeLine{00255\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}Could\ not\ open\ audio\ input\ device."{}});}
\DoxyCodeLine{00256\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00257\ \ \ \}}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<(int)buffers.size();\ i++)\ \{}
\DoxyCodeLine{00260\ \ \ \ \ stat\ =\ waveInPrepareHeader(hwav,\ buffers[i].\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ ==\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00262\ \ \ \ \ \ \ stat\ =\ waveInAddBuffer(hwav,\ buffers[i].\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00263\ \ \ \ \ \}}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ !=\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00265\ \ \ \ \ \ \ waveInClose(hwav);}
\DoxyCodeLine{00266\ \ \ \ \ \ \ delete\_buffers(buffers);}
\DoxyCodeLine{00267\ \ \ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}Could\ not\ queue\ buffers\ for\ audio\ input\ device."{}});}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00269\ \ \ \ \ \}}
\DoxyCodeLine{00270\ \ \ \}}
\DoxyCodeLine{00271\ \ \ stat\ =\ waveInStart(hwav);}
\DoxyCodeLine{00272\ \ \ \textcolor{keywordflow}{if}\ (stat\ !=\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ waveInClose(hwav);}
\DoxyCodeLine{00274\ \ \ \ \ delete\_buffers(buffers);}
\DoxyCodeLine{00275\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}Could\ not\ start\ recording\ on\ input\ device."{}});}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00277\ \ \ \}}
\DoxyCodeLine{00278\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ MicrophoneAudioCursorDS(\textcolor{keyword}{this},\ buffers,\ hwav);}
\DoxyCodeLine{00279\ \}}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00284\ MicrophoneAudioCursorDS::}
\DoxyCodeLine{00285\ MicrophoneAudioCursorDS(MicrophoneAudioDS\ *src,\ AudioBuffers\ \&bufs,\ HWAVEIN\ hwav)\ :}
\DoxyCodeLine{00286\ \ \ \mbox{\hyperlink{classMovieAudioCursor}{MovieAudioCursor}}(src),}
\DoxyCodeLine{00287\ \ \ \_buffers(bufs),}
\DoxyCodeLine{00288\ \ \ \_handle(hwav),}
\DoxyCodeLine{00289\ \ \ \_next(0),}
\DoxyCodeLine{00290\ \ \ \_offset(0)}
\DoxyCodeLine{00291\ \{}
\DoxyCodeLine{00292\ \ \ \_audio\_rate\ =\ src-\/>get\_rate();}
\DoxyCodeLine{00293\ \ \ \_audio\_channels\ =\ src-\/>get\_channels();}
\DoxyCodeLine{00294\ \ \ \_length\ =\ 1.0E10;}
\DoxyCodeLine{00295\ \ \ \_can\_seek\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00296\ \ \ \_can\_seek\_fast\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00297\ \ \ \_aborted\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00298\ \ \ \_samples\_per\_buffer\ =\ bufs[0].\_header-\/>dwBufferLength\ /\ (2\ *\ \_audio\_channels);}
\DoxyCodeLine{00299\ \}}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00304\ \textcolor{keywordtype}{void}\ MicrophoneAudioCursorDS::}
\DoxyCodeLine{00305\ cleanup()\ \{}
\DoxyCodeLine{00306\ \ \ \textcolor{keywordflow}{if}\ (\_handle)\ \{}
\DoxyCodeLine{00307\ \ \ \ \ waveInClose(\_handle);}
\DoxyCodeLine{00308\ \ \ \ \ \_handle\ =\ 0;}
\DoxyCodeLine{00309\ \ \ \}}
\DoxyCodeLine{00310\ \ \ MicrophoneAudioDS::delete\_buffers(\_buffers);}
\DoxyCodeLine{00311\ \ \ \_next\ =\ 0;}
\DoxyCodeLine{00312\ \ \ \_offset\ =\ 0;}
\DoxyCodeLine{00313\ \}}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00318\ MicrophoneAudioCursorDS::}
\DoxyCodeLine{00319\ \string~MicrophoneAudioCursorDS()\ \{}
\DoxyCodeLine{00320\ \ \ cleanup();}
\DoxyCodeLine{00321\ \}}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00326\ \textcolor{keywordtype}{int}\ MicrophoneAudioCursorDS::}
\DoxyCodeLine{00327\ read\_samples(\textcolor{keywordtype}{int}\ n,\ int16\_t\ *data)\ \{}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordtype}{int}\ orign\ =\ n;}
\DoxyCodeLine{00329\ \ \ \textcolor{keywordflow}{if}\ (\_handle)\ \{}
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keywordflow}{while}\ (1)\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ \_next\ \%\ \_buffers.size();}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((\_buffers[index].\_header-\/>dwFlags\ \&\ WHDR\_DONE)==0)\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \ \ \ \ \ \ \textcolor{comment}{//\ Find\ start\ of\ data\ in\ buffer.}}
\DoxyCodeLine{00337\ \ \ \ \ \ \ int16\_t\ *src\ =\ (int16\_t*)(\_buffers[index].\_storage);}
\DoxyCodeLine{00338\ \ \ \ \ \ \ src\ +=\ (\_offset\ *\ \_audio\_channels);}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \ \ \ \ \textcolor{comment}{//\ Decide\ how\ many\ samples\ to\ extract\ from\ this\ buffer.}}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ samples\ =\ \_samples\_per\_buffer;}
\DoxyCodeLine{00342\ \ \ \ \ \ \ samples\ -\/=\ \_offset;}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (samples\ >\ n)\ samples\ =\ n;}
\DoxyCodeLine{00344\ }
\DoxyCodeLine{00345\ \ \ \ \ \ \ \textcolor{comment}{//\ Copy\ data\ to\ output\ buffer.}}
\DoxyCodeLine{00346\ \ \ \ \ \ \ memcpy(data,\ src,\ samples\ *\ 2\ *\ \_audio\_channels);}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \ \ \ \ \textcolor{comment}{//\ Advance\ pointers.}}
\DoxyCodeLine{00349\ \ \ \ \ \ \ data\ +=\ samples\ *\ \_audio\_channels;}
\DoxyCodeLine{00350\ \ \ \ \ \ \ n\ -\/=\ samples;}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \_offset\ +=\ samples;}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \_samples\_read\ +=\ samples;}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_offset\ !=\ \_samples\_per\_buffer)\ \{}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \_buffers[index].\_header-\/>dwFlags\ \&=\ \string~(WHDR\_DONE);}
\DoxyCodeLine{00357\ \ \ \ \ \ \ MMRESULT\ stat\ =\ waveInUnprepareHeader(\_handle,\ \_buffers[index].\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ ==\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ stat\ =\ waveInPrepareHeader(\_handle,\ \_buffers[index].\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ ==\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ stat\ =\ waveInAddBuffer(\_handle,\ \_buffers[index].\_header,\ \textcolor{keyword}{sizeof}(WAVEHDR));}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stat\ !=\ MMSYSERR\_NOERROR)\ \{}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ movies\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Could\ not\ requeue\ audio\ buffers,\ closing\ microphone.\(\backslash\)n"{}};}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ cleanup();}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \_next\ +=\ 1;}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \_offset\ =\ 0;}
\DoxyCodeLine{00371\ \ \ \ \ \}}
\DoxyCodeLine{00372\ \ \ \}}
\DoxyCodeLine{00373\ \ \ \textcolor{keywordflow}{if}\ (n\ >\ 0)\ \{}
\DoxyCodeLine{00374\ \ \ \ \ memcpy(data,\ 0,\ n*2*\_audio\_channels);}
\DoxyCodeLine{00375\ \ \ \}}
\DoxyCodeLine{00376\ \ \ \textcolor{keywordflow}{return}\ orign\ -\/\ n;}
\DoxyCodeLine{00377\ \}}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00382\ \textcolor{keywordtype}{int}\ MicrophoneAudioCursorDS::}
\DoxyCodeLine{00383\ ready()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordflow}{if}\ (\_handle\ ==\ 0)\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00385\ \ \ \textcolor{keywordtype}{int}\ total\ =\ 0;}
\DoxyCodeLine{00386\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<(int)\_buffers.size();\ i++)\ \{}
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ (\_next\ +\ i)\ \%\ (\_buffers.size());}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{if}\ ((\_buffers[index].\_header-\/>dwFlags\ \&\ WHDR\_DONE)==0)\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00390\ \ \ \ \ \}}
\DoxyCodeLine{00391\ \ \ \ \ total\ +=\ \_samples\_per\_buffer;}
\DoxyCodeLine{00392\ \ \ \}}
\DoxyCodeLine{00393\ \ \ total\ -\/=\ \_offset;}
\DoxyCodeLine{00394\ \ \ \textcolor{keywordflow}{return}\ total;}
\DoxyCodeLine{00395\ \}}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_DIRECTSHOW}}

\end{DoxyCode}
