\doxysection{render\+State\+\_\+ext.\+cxx}
\hypertarget{renderState__ext_8cxx_source}{}\label{renderState__ext_8cxx_source}\index{panda/src/pgraph/renderState\_ext.cxx@{panda/src/pgraph/renderState\_ext.cxx}}
\mbox{\hyperlink{renderState__ext_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState__ext_8h}{renderState\_ext.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ HAVE\_PYTHON}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00021\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ \mbox{\hyperlink{classExtension}{Extension<RenderState>::}}}
\DoxyCodeLine{00022\ \mbox{\hyperlink{classExtension}{make}}(PyObject\ *args,\ PyObject\ *kwds)\ \{}
\DoxyCodeLine{00023\ \ \ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_RenderAttrib;}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \ \ Py\_ssize\_t\ num\_attribs\ =\ PyTuple\_GET\_SIZE(args);}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \ \ \textcolor{comment}{//\ Check\ for\ the\ override\ keyword\ argument.}}
\DoxyCodeLine{00028\ \ \ PyObject\ *py\_override\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00029\ \ \ \textcolor{keywordflow}{if}\ (kwds\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ PyDict\_GET\_SIZE(kwds)\ >\ 0)\ \{}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{keywordflow}{if}\ (PyDict\_GET\_SIZE(kwds)\ >\ 1)\ \{}
\DoxyCodeLine{00031\ \ \ \ \ \ \ Dtool\_Raise\_TypeError(\textcolor{stringliteral}{"{}RenderState.make()\ received\ an\ unexpected\ keyword\ argument"{}});}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00033\ \ \ \ \ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ PyObject\ *key;}
\DoxyCodeLine{00036\ \ \ \ \ Py\_ssize\_t\ ppos\ =\ 0;}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keywordflow}{if}\ (!PyDict\_Next(kwds,\ \&ppos,\ \&key,\ \&py\_override))\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00039\ \ \ \ \ \}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{comment}{//\ We\ got\ the\ item,\ we\ just\ need\ to\ make\ sure\ that\ it\ had\ the\ right\ key.}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordflow}{if}\ (!PyUnicode\_CheckExact(key)\ ||\ PyUnicode\_CompareWithASCIIString(key,\ \textcolor{stringliteral}{"{}override"{}})\ !=\ 0)\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \ \ Dtool\_Raise\_TypeError(\textcolor{stringliteral}{"{}RenderState.make()\ received\ an\ unexpected\ keyword\ argument"{}});}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00045\ \ \ \ \ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{if}\ (!PyLong\_Check(py\_override))\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ Dtool\_Raise\_TypeError(\textcolor{stringliteral}{"{}RenderState.make()\ override\ argument\ should\ be\ int"{}});}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_attribs\ >\ 1\ \&\&\ PyLong\_Check(PyTuple\_GET\_ITEM(args,\ num\_attribs\ -\/\ 1)))\ \{}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ It\ was\ specified\ as\ last\ positional\ argument.}}
\DoxyCodeLine{00054\ \ \ \ \ py\_override\ =\ PyTuple\_GET\_ITEM(args,\ -\/-\/num\_attribs);}
\DoxyCodeLine{00055\ \ \ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \textcolor{keywordtype}{int}\ \textcolor{keyword}{override}\ =\ 0;}
\DoxyCodeLine{00058\ \ \ \textcolor{keywordflow}{if}\ (py\_override\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keyword}{override}\ =\ PyLong\_AsInt(py\_override);}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{override}\ ==\ -\/1\ \&\&\ PyErr\_Occurred())\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00062\ \ \ \ \ \}}
\DoxyCodeLine{00063\ \ \ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderAttrib}{RenderAttrib}}\ **attribs\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderAttrib}{RenderAttrib}}\ **)alloca(\textcolor{keyword}{sizeof}(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}}\ *)\ *\ num\_attribs);}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordflow}{for}\ (Py\_ssize\_t\ i\ =\ 0;\ i\ <\ num\_attribs;\ ++i)\ \{}
\DoxyCodeLine{00067\ \ \ \ \ PyObject\ *arg\ =\ PyTuple\_GET\_ITEM(args,\ i);}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordflow}{if}\ (!DtoolInstance\_GetPointer(arg,\ attribs[i],\ Dtool\_RenderAttrib))\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ Dtool\_Raise\_ArgTypeError(arg,\ i,\ \textcolor{stringliteral}{"{}RenderState.make"{}},\ \textcolor{stringliteral}{"{}RenderAttrib"{}});}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00071\ \ \ \ \ \}}
\DoxyCodeLine{00072\ \ \ \}}
\DoxyCodeLine{00073\ \ \ \textcolor{keywordflow}{return}\ RenderState::make(attribs,\ num\_attribs,\ \textcolor{keyword}{override});}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00087\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<RenderState>::}}}
\DoxyCodeLine{00088\ \mbox{\hyperlink{classExtension}{get\_composition\_cache}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00089\ \ \ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_RenderState;}
\DoxyCodeLine{00090\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(*RenderState::\_states\_lock);}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{size\_t}\ cache\_size\ =\ \_this-\/>\_composition\_cache.get\_num\_entries();}
\DoxyCodeLine{00092\ \ \ PyObject\ *list\ =\ PyList\_New(cache\_size);}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ cache\_size;\ ++i)\ \{}
\DoxyCodeLine{00095\ \ \ \ \ PyObject\ *tuple\ =\ PyTuple\_New(2);}
\DoxyCodeLine{00096\ \ \ \ \ PyObject\ *a,\ *b;}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *source\ =\ \_this-\/>\_composition\_cache.get\_key(i);}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keywordflow}{if}\ (source\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ a\ =\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00100\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \ \ source-\/>ref();}
\DoxyCodeLine{00102\ \ \ \ \ \ \ a\ =\ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)source,\ Dtool\_RenderState,}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ source-\/>get\_type\_index());}
\DoxyCodeLine{00104\ \ \ \ \ \}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *result\ =\ \_this-\/>\_composition\_cache.get\_data(i).\_result;}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ b\ =\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00108\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ result-\/>ref();}
\DoxyCodeLine{00110\ \ \ \ \ \ \ b\ =\ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)result,\ Dtool\_RenderState,}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ result-\/>get\_type\_index());}
\DoxyCodeLine{00112\ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ PyTuple\_SET\_ITEM(tuple,\ 0,\ a);}
\DoxyCodeLine{00114\ \ \ \ \ PyTuple\_SET\_ITEM(tuple,\ 1,\ b);}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \ \ PyList\_SET\_ITEM(list,\ i,\ tuple);}
\DoxyCodeLine{00117\ \ \ \}}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \textcolor{keywordflow}{return}\ list;}
\DoxyCodeLine{00120\ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00133\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<RenderState>::}}}
\DoxyCodeLine{00134\ \mbox{\hyperlink{classExtension}{get\_invert\_composition\_cache}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00135\ \ \ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_RenderState;}
\DoxyCodeLine{00136\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(*RenderState::\_states\_lock);}
\DoxyCodeLine{00137\ \ \ \textcolor{keywordtype}{size\_t}\ cache\_size\ =\ \_this-\/>\_invert\_composition\_cache.get\_num\_entries();}
\DoxyCodeLine{00138\ \ \ PyObject\ *list\ =\ PyList\_New(cache\_size);}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ cache\_size;\ ++i)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ PyObject\ *tuple\ =\ PyTuple\_New(2);}
\DoxyCodeLine{00142\ \ \ \ \ PyObject\ *a,\ *b;}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *source\ =\ \_this-\/>\_invert\_composition\_cache.get\_key(i);}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{keywordflow}{if}\ (source\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ a\ =\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00146\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ source-\/>ref();}
\DoxyCodeLine{00148\ \ \ \ \ \ \ a\ =\ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)source,\ Dtool\_RenderState,}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ source-\/>get\_type\_index());}
\DoxyCodeLine{00150\ \ \ \ \ \}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *result\ =\ \_this-\/>\_invert\_composition\_cache.get\_data(i).\_result;}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ b\ =\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00154\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00155\ \ \ \ \ \ \ result-\/>ref();}
\DoxyCodeLine{00156\ \ \ \ \ \ \ b\ =\ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)result,\ Dtool\_RenderState,}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ result-\/>get\_type\_index());}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ PyTuple\_SET\_ITEM(tuple,\ 0,\ a);}
\DoxyCodeLine{00160\ \ \ \ \ PyTuple\_SET\_ITEM(tuple,\ 1,\ b);}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ PyList\_SET\_ITEM(list,\ i,\ tuple);}
\DoxyCodeLine{00163\ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \textcolor{keywordflow}{return}\ list;}
\DoxyCodeLine{00166\ \}}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00172\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<RenderState>::}}}
\DoxyCodeLine{00173\ \mbox{\hyperlink{classExtension}{get\_states}}()\ \{}
\DoxyCodeLine{00174\ \ \ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_RenderState;}
\DoxyCodeLine{00175\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(*RenderState::\_states\_lock);}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \textcolor{keywordtype}{size\_t}\ num\_states\ =\ RenderState::\_states.get\_num\_entries();}
\DoxyCodeLine{00178\ \ \ PyObject\ *list\ =\ PyList\_New(num\_states);}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordtype}{size\_t}\ i\ =\ 0;}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ \textcolor{keywordtype}{size\_t}\ size\ =\ RenderState::\_states.get\_num\_entries();}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ si\ =\ 0;\ si\ <\ size;\ ++si)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state\ =\ RenderState::\_states.get\_key(si);}
\DoxyCodeLine{00184\ \ \ \ \ state-\/>ref();}
\DoxyCodeLine{00185\ \ \ \ \ PyObject\ *a\ =}
\DoxyCodeLine{00186\ \ \ \ \ \ \ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)state,\ Dtool\_RenderState,}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ state-\/>get\_type\_index());}
\DoxyCodeLine{00188\ \ \ \ \ nassertr(i\ <\ num\_states,\ list);}
\DoxyCodeLine{00189\ \ \ \ \ PyList\_SET\_ITEM(list,\ i,\ a);}
\DoxyCodeLine{00190\ \ \ \ \ ++i;}
\DoxyCodeLine{00191\ \ \ \}}
\DoxyCodeLine{00192\ \ \ nassertr(i\ ==\ num\_states,\ list);}
\DoxyCodeLine{00193\ \ \ \textcolor{keywordflow}{return}\ list;}
\DoxyCodeLine{00194\ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00200\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<RenderState>::}}}
\DoxyCodeLine{00201\ \mbox{\hyperlink{classExtension}{get\_unused\_states}}()\ \{}
\DoxyCodeLine{00202\ \ \ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_RenderState;}
\DoxyCodeLine{00203\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(*RenderState::\_states\_lock);}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ PyObject\ *list\ =\ PyList\_New(0);}
\DoxyCodeLine{00206\ \ \ \textcolor{keywordtype}{size\_t}\ size\ =\ RenderState::\_states.get\_num\_entries();}
\DoxyCodeLine{00207\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ si\ =\ 0;\ si\ <\ size;\ ++si)\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state\ =\ RenderState::\_states.get\_key(si);}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keywordflow}{if}\ (state-\/>get\_cache\_ref\_count()\ ==\ state-\/>get\_ref\_count())\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \ \ state-\/>ref();}
\DoxyCodeLine{00211\ \ \ \ \ \ \ PyObject\ *a\ =}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)state,\ Dtool\_RenderState,}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{true},\ state-\/>get\_type\_index());}
\DoxyCodeLine{00214\ \ \ \ \ \ \ PyList\_Append(list,\ a);}
\DoxyCodeLine{00215\ \ \ \ \ \ \ Py\_DECREF(a);}
\DoxyCodeLine{00216\ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \}}
\DoxyCodeLine{00218\ \ \ \textcolor{keywordflow}{return}\ list;}
\DoxyCodeLine{00219\ \}}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00221\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_PYTHON}}

\end{DoxyCode}
