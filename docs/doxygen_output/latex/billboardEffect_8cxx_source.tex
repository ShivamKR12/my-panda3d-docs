\doxysection{billboard\+Effect.\+cxx}
\hypertarget{billboardEffect_8cxx_source}{}\label{billboardEffect_8cxx_source}\index{panda/src/pgraph/billboardEffect.cxx@{panda/src/pgraph/billboardEffect.cxx}}
\mbox{\hyperlink{billboardEffect_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{billboardEffect_8h}{billboardEffect.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePath_8h}{nodePath.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{look__at_8h}{look\_at.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ BillboardEffect::\_type\_handle;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ CPT(\mbox{\hyperlink{classRenderEffect}{RenderEffect}})\ BillboardEffect::}
\DoxyCodeLine{00030\ make(\textcolor{keyword}{const}\ LVector3\ \&up\_vector,\ \textcolor{keywordtype}{bool}\ eye\_relative,}
\DoxyCodeLine{00031\ \ \ \ \ \ \textcolor{keywordtype}{bool}\ axial\_rotate,\ PN\_stdfloat\ offset,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&\mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}},}
\DoxyCodeLine{00032\ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&look\_at\_point,\ \textcolor{keywordtype}{bool}\ fixed\_depth)\ \{}
\DoxyCodeLine{00033\ \ \ \mbox{\hyperlink{classBillboardEffect}{BillboardEffect}}\ *effect\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBillboardEffect}{BillboardEffect}};}
\DoxyCodeLine{00034\ \ \ effect-\/>\_up\_vector\ =\ up\_vector;}
\DoxyCodeLine{00035\ \ \ effect-\/>\_eye\_relative\ =\ eye\_relative;}
\DoxyCodeLine{00036\ \ \ effect-\/>\_axial\_rotate\ =\ axial\_rotate;}
\DoxyCodeLine{00037\ \ \ effect-\/>\_offset\ =\ offset;}
\DoxyCodeLine{00038\ \ \ effect-\/>\_look\_at\ =\ \mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}};}
\DoxyCodeLine{00039\ \ \ effect-\/>\_look\_at\_point\ =\ look\_at\_point;}
\DoxyCodeLine{00040\ \ \ effect-\/>\_fixed\_depth\ =\ fixed\_depth;}
\DoxyCodeLine{00041\ \ \ effect-\/>\_off\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00042\ \ \ \textcolor{keywordflow}{return}\ return\_new(effect);}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00049\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classBillboardEffect_aef4bdd231ed6abcfb31d13524ab2a38a}{BillboardEffect::}}}
\DoxyCodeLine{00050\ \mbox{\hyperlink{classBillboardEffect_aef4bdd231ed6abcfb31d13524ab2a38a}{safe\_to\_transform}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00052\ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00059\ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ BillboardEffect::}
\DoxyCodeLine{00060\ prepare\_flatten\_transform(\textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *net\_transform)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00061\ \ \ \textcolor{comment}{//\ We\ don't\ want\ any\ flatten\ operation\ to\ rotate\ the\ billboarded\ node,\ since}}
\DoxyCodeLine{00062\ \ \ \textcolor{comment}{//\ the\ billboard\ effect\ should\ eat\ any\ rotation\ that\ comes\ in\ from\ above.}}
\DoxyCodeLine{00063\ \ \ \textcolor{keywordflow}{return}\ net\_transform-\/>set\_hpr(LVecBase3(0,\ 0,\ 0));}
\DoxyCodeLine{00064\ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00069\ \textcolor{keywordtype}{void}\ BillboardEffect::}
\DoxyCodeLine{00070\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00071\ \ \ out\ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}:"{}};}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{if}\ (is\_off())\ \{}
\DoxyCodeLine{00073\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}(off)"{}};}
\DoxyCodeLine{00074\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_axial\_rotate)\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}(axis"{}};}
\DoxyCodeLine{00077\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}(point"{}};}
\DoxyCodeLine{00079\ \ \ \ \ \}}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_up\_vector.almost\_equal(LVector3::up()))\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ up\ "{}}\ <<\ \_up\_vector;}
\DoxyCodeLine{00082\ \ \ \ \ \}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_eye\_relative)\ \{}
\DoxyCodeLine{00084\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ eye"{}};}
\DoxyCodeLine{00085\ \ \ \ \ \}}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_fixed\_depth)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ depth\ "{}}\ <<\ -\/\_offset;}
\DoxyCodeLine{00088\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_offset\ !=\ 0.0f)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ offset\ "{}}\ <<\ \_offset;}
\DoxyCodeLine{00090\ \ \ \ \ \}}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_look\_at.is\_empty())\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ look\ at\ "{}}\ <<\ \_look\_at;}
\DoxyCodeLine{00093\ \ \ \ \ \}}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_look\_at\_point.almost\_equal(LPoint3(0.0f,\ 0.0f,\ 0.0f)))\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ look\ at\ point\ "{}}\ <<\ \_look\_at\_point;}
\DoxyCodeLine{00096\ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{00098\ \ \ \}}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00106\ \textcolor{keywordtype}{bool}\ BillboardEffect::}
\DoxyCodeLine{00107\ has\_cull\_callback()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00108\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00109\ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00123\ \textcolor{keywordtype}{void}\ BillboardEffect::}
\DoxyCodeLine{00124\ cull\_callback(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ \&node\_transform,}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00127\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ modelview\_transform\ =\ data.get\_modelview\_transform(trav);}
\DoxyCodeLine{00128\ \ \ \textcolor{keywordflow}{if}\ (modelview\_transform-\/>is\_singular())\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ under\ a\ singular\ transform,\ never\ mind.}}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00131\ \ \ \}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{comment}{//\ Since\ the\ "{}modelview"{}\ transform\ from\ the\ cull\ traverser\ already\ includes}}
\DoxyCodeLine{00134\ \ \ \textcolor{comment}{//\ the\ inverse\ camera\ transform,\ the\ camera\ transform\ is\ identity.}}
\DoxyCodeLine{00135\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ camera\_transform\ =\ TransformState::make\_identity();}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//\ But\ if\ we're\ rotating\ to\ face\ something\ other\ than\ the\ camera,\ we\ have\ to}}
\DoxyCodeLine{00138\ \ \ \textcolor{comment}{//\ compute\ the\ "{}camera"{}\ transform\ to\ compensate\ for\ that.}}
\DoxyCodeLine{00139\ \ \ \textcolor{keywordflow}{if}\ (!\_look\_at.is\_empty())\ \{}
\DoxyCodeLine{00140\ \ \ \ \ camera\_transform\ =\ trav-\/>get\_camera\_transform()-\/>invert\_compose(\_look\_at.get\_net\_transform());}
\DoxyCodeLine{00141\ \ \ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \textcolor{keywordflow}{if}\ (data.\_instances\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00144\ \ \ \ \ compute\_billboard(node\_transform,\ modelview\_transform,\ camera\_transform);}
\DoxyCodeLine{00145\ \ \ \}}
\DoxyCodeLine{00146\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ billboard\ effect\ for\ every\ instance\ individually.}}
\DoxyCodeLine{00148\ \ \ \ \ \mbox{\hyperlink{classInstanceList}{InstanceList}}\ *instances\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classInstanceList}{InstanceList}}(*data.\_instances);}
\DoxyCodeLine{00149\ \ \ \ \ data.\_instances\ =\ instances;}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classInstanceList_1_1Instance}{InstanceList::Instance}}\ \&instance\ :\ *instances)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ inst\_node\_transform\ =\ node\_transform;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ inst\_modelview\_transform\ =\ modelview\_transform-\/>compose(instance.get\_transform());}
\DoxyCodeLine{00154\ \ \ \ \ \ \ compute\_billboard(inst\_node\_transform,\ inst\_modelview\_transform,\ camera\_transform);}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \ \ \ \ instance.set\_transform(instance.get\_transform()-\/>compose(inst\_node\_transform));}
\DoxyCodeLine{00157\ \ \ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ We've\ already\ applied\ this\ onto\ the\ instances.}}
\DoxyCodeLine{00160\ \ \ \ \ node\_transform\ =\ TransformState::make\_identity();}
\DoxyCodeLine{00161\ \ \ \}}
\DoxyCodeLine{00162\ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00169\ \textcolor{keywordtype}{bool}\ BillboardEffect::}
\DoxyCodeLine{00170\ has\_adjust\_transform()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{//\ A\ BillboardEffect\ can\ only\ affect\ the\ net\ transform\ when\ it\ is\ to\ a}}
\DoxyCodeLine{00172\ \ \ \textcolor{comment}{//\ particular\ node.\ \ A\ billboard\ to\ a\ camera\ is\ camera-\/dependent,\ of\ course,}}
\DoxyCodeLine{00173\ \ \ \textcolor{comment}{//\ so\ it\ has\ no\ effect\ in\ the\ absence\ of\ any\ particular\ camera\ viewing\ it.}}
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{return}\ !\_look\_at.is\_empty();}
\DoxyCodeLine{00175\ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00185\ \textcolor{keywordtype}{void}\ BillboardEffect::}
\DoxyCodeLine{00186\ adjust\_transform(CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ \&net\_transform,}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ \&node\_transform,}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00189\ \ \ \textcolor{comment}{//\ A\ BillboardEffect\ can\ only\ affect\ the\ net\ transform\ when\ it\ is\ to\ a}}
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ particular\ node.\ \ A\ billboard\ to\ a\ camera\ is\ camera-\/dependent,\ of\ course,}}
\DoxyCodeLine{00191\ \ \ \textcolor{comment}{//\ so\ it\ has\ no\ effect\ in\ the\ absence\ of\ any\ particular\ camera\ viewing\ it.}}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{if}\ (\_look\_at.is\_empty())\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00194\ \ \ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ camera\_transform\ =\ \_look\_at.get\_net\_transform();}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ compute\_billboard(node\_transform,\ net\_transform,\ camera\_transform);}
\DoxyCodeLine{00199\ \}}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00214\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classBillboardEffect_aec2f6384c0eb4d4e941643d081763c7d}{BillboardEffect::}}}
\DoxyCodeLine{00215\ \mbox{\hyperlink{classBillboardEffect_aec2f6384c0eb4d4e941643d081763c7d}{compare\_to\_impl}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderEffect}{RenderEffect}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00216\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBillboardEffect}{BillboardEffect}}\ *ta;}
\DoxyCodeLine{00217\ \ \ DCAST\_INTO\_R(ta,\ other,\ 0);}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \textcolor{keywordflow}{if}\ (\_axial\_rotate\ !=\ ta-\/>\_axial\_rotate)\ \{}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_axial\_rotate\ -\/\ (int)ta-\/>\_axial\_rotate;}
\DoxyCodeLine{00221\ \ \ \}}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordflow}{if}\ (\_eye\_relative\ !=\ ta-\/>\_eye\_relative)\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_eye\_relative\ -\/\ (int)ta-\/>\_eye\_relative;}
\DoxyCodeLine{00224\ \ \ \}}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{if}\ (\_fixed\_depth\ !=\ ta-\/>\_fixed\_depth)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_fixed\_depth\ -\/\ (int)ta-\/>\_fixed\_depth;}
\DoxyCodeLine{00227\ \ \ \}}
\DoxyCodeLine{00228\ \ \ \textcolor{keywordflow}{if}\ (\_offset\ !=\ ta-\/>\_offset)\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keywordflow}{return}\ \_offset\ <\ ta-\/>\_offset\ ?\ -\/1\ :\ 1;}
\DoxyCodeLine{00230\ \ \ \}}
\DoxyCodeLine{00231\ \ \ \textcolor{keywordtype}{int}\ compare\ =\ \_up\_vector.compare\_to(ta-\/>\_up\_vector);}
\DoxyCodeLine{00232\ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00234\ \ \ \}}
\DoxyCodeLine{00235\ \ \ compare\ =\ \_look\_at.compare\_to(ta-\/>\_look\_at);}
\DoxyCodeLine{00236\ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00238\ \ \ \}}
\DoxyCodeLine{00239\ \ \ compare\ =\ \_look\_at\_point.compare\_to(ta-\/>\_look\_at\_point);}
\DoxyCodeLine{00240\ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00242\ \ \ \}}
\DoxyCodeLine{00243\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00244\ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00252\ \textcolor{keywordtype}{void}\ BillboardEffect::}
\DoxyCodeLine{00253\ compute\_billboard(CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ \&node\_transform,}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *net\_transform,}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *camera\_transform)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00256\ \ \ \textcolor{comment}{//\ First,\ extract\ out\ just\ the\ translation\ component\ of\ the\ node's\ local}}
\DoxyCodeLine{00257\ \ \ \textcolor{comment}{//\ transform.\ \ This\ gets\ applied\ to\ the\ net\ transform,\ to\ compute\ the\ look-\/}}
\DoxyCodeLine{00258\ \ \ \textcolor{comment}{//\ at\ direction\ properly.}}
\DoxyCodeLine{00259\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ translate\ =\ TransformState::make\_pos(node\_transform-\/>get\_pos());}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \textcolor{comment}{//\ And\ then\ the\ translation\ gets\ removed\ from\ the\ node,\ but\ we\ keep\ its}}
\DoxyCodeLine{00262\ \ \ \textcolor{comment}{//\ rotation\ etc.,\ which\ gets\ applied\ after\ the\ billboard\ operation.}}
\DoxyCodeLine{00263\ \ \ node\_transform\ =\ node\_transform-\/>set\_pos(LPoint3(0.0f,\ 0.0f,\ 0.0f));}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ rel\_transform\ =}
\DoxyCodeLine{00266\ \ \ \ \ net\_transform-\/>compose(translate)-\/>invert\_compose(camera\_transform);}
\DoxyCodeLine{00267\ \ \ \textcolor{keywordflow}{if}\ (!rel\_transform-\/>has\_mat())\ \{}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{comment}{//\ Never\ mind.}}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00270\ \ \ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&rel\_mat\ =\ rel\_transform-\/>get\_mat();}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \textcolor{comment}{//\ Determine\ the\ look\_at\ point\ in\ the\ camera\ space.}}
\DoxyCodeLine{00275\ \ \ LVector3\ camera\_pos,\ up;}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \ \ \textcolor{comment}{//\ If\ this\ is\ an\ eye-\/relative\ Billboard,\ then\ (a)\ the\ up\ vector\ is\ relative}}
\DoxyCodeLine{00278\ \ \ \textcolor{comment}{//\ to\ the\ camera,\ not\ to\ the\ world,\ and\ (b)\ the\ look\ direction\ is\ towards}}
\DoxyCodeLine{00279\ \ \ \textcolor{comment}{//\ the\ plane\ that\ contains\ the\ camera,\ perpendicular\ to\ the\ forward}}
\DoxyCodeLine{00280\ \ \ \textcolor{comment}{//\ direction,\ not\ directly\ to\ the\ camera.}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \textcolor{keywordflow}{if}\ (\_eye\_relative)\ \{}
\DoxyCodeLine{00283\ \ \ \ \ up\ =\ \_up\_vector\ *\ rel\_mat;}
\DoxyCodeLine{00284\ \ \ \ \ camera\_pos\ =\ LVector3::forward()\ *\ rel\_mat;}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00287\ \ \ \ \ up\ =\ \_up\_vector;}
\DoxyCodeLine{00288\ \ \ \ \ camera\_pos\ =\ -\/(\_look\_at\_point\ *\ rel\_mat);}
\DoxyCodeLine{00289\ \ \ \}}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00291\ \ \ \textcolor{comment}{//\ Now\ determine\ the\ rotation\ matrix\ for\ the\ Billboard.}}
\DoxyCodeLine{00292\ \ \ LMatrix4\ rotate;}
\DoxyCodeLine{00293\ \ \ \textcolor{keywordflow}{if}\ (\_axial\_rotate)\ \{}
\DoxyCodeLine{00294\ \ \ \ \ \mbox{\hyperlink{look__at__src_8cxx_ac85e6acfd9c43c312f32372c6105549a}{heads\_up}}(rotate,\ camera\_pos,\ up);}
\DoxyCodeLine{00295\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00296\ \ \ \ \ look\_at(rotate,\ camera\_pos,\ up);}
\DoxyCodeLine{00297\ \ \ \}}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00299\ \ \ \textcolor{comment}{//\ Also\ slide\ the\ billboard\ geometry\ towards\ the\ camera\ according\ to\ the}}
\DoxyCodeLine{00300\ \ \ \textcolor{comment}{//\ offset\ factor.}}
\DoxyCodeLine{00301\ \ \ \textcolor{keywordflow}{if}\ (\_offset\ !=\ 0.0f\ ||\ \_fixed\_depth)\ \{}
\DoxyCodeLine{00302\ \ \ \ \ LVector3\ translate(rel\_mat(3,\ 0),\ rel\_mat(3,\ 1),\ rel\_mat(3,\ 2));}
\DoxyCodeLine{00303\ \ \ \ \ LPoint3\ pos;}
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_fixed\_depth)\ \{}
\DoxyCodeLine{00305\ \ \ \ \ \ \ pos\ =\ translate\ /\ rel\_mat(3,\ 3);}
\DoxyCodeLine{00306\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ pos.fill(0.0f);}
\DoxyCodeLine{00308\ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \ \ translate.normalize();}
\DoxyCodeLine{00310\ \ \ \ \ translate\ *=\ \_offset;}
\DoxyCodeLine{00311\ \ \ \ \ rotate.set\_row(3,\ pos\ +\ translate);}
\DoxyCodeLine{00312\ \ \ \}}
\DoxyCodeLine{00313\ }
\DoxyCodeLine{00314\ \ \ node\_transform\ =\ translate-\/>compose(TransformState::make\_mat(rotate))-\/>compose(node\_transform);}
\DoxyCodeLine{00315\ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00320\ \textcolor{keywordtype}{void}\ BillboardEffect::}
\DoxyCodeLine{00321\ register\_with\_read\_factory()\ \{}
\DoxyCodeLine{00322\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classBillboardEffect_aad0046b56e69812194e88aac7d762757}{make\_from\_bam}});}
\DoxyCodeLine{00323\ \}}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00329\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classBillboardEffect_a975b457eb062904ffcf8fadfd62d82c9}{BillboardEffect::}}}
\DoxyCodeLine{00330\ \mbox{\hyperlink{classBillboardEffect_a975b457eb062904ffcf8fadfd62d82c9}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00331\ \ \ \mbox{\hyperlink{classRenderEffect_adfcb8f46697627c2144df4aa93dfa62c}{RenderEffect::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ dg.add\_bool(\_off);}
\DoxyCodeLine{00334\ \ \ \_up\_vector.write\_datagram(dg);}
\DoxyCodeLine{00335\ \ \ dg.add\_bool(\_eye\_relative);}
\DoxyCodeLine{00336\ \ \ dg.add\_bool(\_axial\_rotate);}
\DoxyCodeLine{00337\ \ \ dg.add\_stdfloat(\_offset);}
\DoxyCodeLine{00338\ \ \ \_look\_at\_point.write\_datagram(dg);}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 43)\ \{}
\DoxyCodeLine{00341\ \ \ \ \ \_look\_at.\mbox{\hyperlink{classNodePath_af7c19931d23f86dab9de3c64850b180f}{write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00342\ \ \ \ \ dg.add\_bool(\_fixed\_depth);}
\DoxyCodeLine{00343\ \ \ \}}
\DoxyCodeLine{00344\ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00350\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classBillboardEffect_a1bfa07fe953c210c3c7a13d7100b0bb4}{BillboardEffect::}}}
\DoxyCodeLine{00351\ \mbox{\hyperlink{classBillboardEffect_a1bfa07fe953c210c3c7a13d7100b0bb4}{complete\_pointers}}(\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00352\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ \mbox{\hyperlink{classTypedWritable_addc29bb978851cacca2196f8a1f35014}{RenderEffect::complete\_pointers}}(p\_list,\ manager);}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 43)\ \{}
\DoxyCodeLine{00355\ \ \ \ \ pi\ +=\ \_look\_at.\mbox{\hyperlink{classNodePath_a7668ffdd889f20ec62c2c5dd8b87c350}{complete\_pointers}}(p\_list\ +\ pi,\ manager);}
\DoxyCodeLine{00356\ \ \ \}}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{00359\ \}}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00366\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classBillboardEffect_aad0046b56e69812194e88aac7d762757}{BillboardEffect::}}}
\DoxyCodeLine{00367\ \mbox{\hyperlink{classBillboardEffect_aad0046b56e69812194e88aac7d762757}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00368\ \ \ \mbox{\hyperlink{classBillboardEffect}{BillboardEffect}}\ *effect\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBillboardEffect}{BillboardEffect}};}
\DoxyCodeLine{00369\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00370\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00373\ \ \ effect-\/>\mbox{\hyperlink{classBillboardEffect_a8c5b2017a66cad1040b6af266dd8592a}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{return}\ effect;}
\DoxyCodeLine{00376\ \}}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00382\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classBillboardEffect_a8c5b2017a66cad1040b6af266dd8592a}{BillboardEffect::}}}
\DoxyCodeLine{00383\ \mbox{\hyperlink{classBillboardEffect_a8c5b2017a66cad1040b6af266dd8592a}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00384\ \ \ \mbox{\hyperlink{classRenderEffect_a5176dd32b3b8a868bd68bf4aa77944bf}{RenderEffect::fillin}}(scan,\ manager);}
\DoxyCodeLine{00385\ }
\DoxyCodeLine{00386\ \ \ \_off\ =\ scan.get\_bool();}
\DoxyCodeLine{00387\ \ \ \_up\_vector.read\_datagram(scan);}
\DoxyCodeLine{00388\ \ \ \_eye\_relative\ =\ scan.get\_bool();}
\DoxyCodeLine{00389\ \ \ \_axial\_rotate\ =\ scan.get\_bool();}
\DoxyCodeLine{00390\ \ \ \_offset\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{00391\ \ \ \_look\_at\_point.read\_datagram(scan);}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 43)\ \{}
\DoxyCodeLine{00394\ \ \ \ \ \_look\_at.\mbox{\hyperlink{classNodePath_a4df73e7daf4f8f14964f00debe20108d}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00395\ \ \ \ \ \_fixed\_depth\ =\ scan.get\_bool();}
\DoxyCodeLine{00396\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00397\ \ \ \ \ \_fixed\_depth\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00398\ \ \ \}}
\DoxyCodeLine{00399\ \}}

\end{DoxyCode}
