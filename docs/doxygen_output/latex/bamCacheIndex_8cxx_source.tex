\doxysection{bam\+Cache\+Index.\+cxx}
\hypertarget{bamCacheIndex_8cxx_source}{}\label{bamCacheIndex_8cxx_source}\index{panda/src/putil/bamCacheIndex.cxx@{panda/src/putil/bamCacheIndex.cxx}}
\mbox{\hyperlink{bamCacheIndex_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamCacheIndex_8h}{bamCacheIndex.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__putil_8h}{config\_putil.h}}"{}}\ \textcolor{comment}{//\ util\_cat}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ BamCacheIndex::\_type\_handle;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00027\ BamCacheIndex::}
\DoxyCodeLine{00028\ \string~BamCacheIndex()\ \{}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00030\ \ \ \textcolor{comment}{//\ We\ need\ to\ "{}empty"{}\ the\ linked\ list\ to\ make\ the\ LinkedListNode\ destructors}}
\DoxyCodeLine{00031\ \ \ \textcolor{comment}{//\ happy.}}
\DoxyCodeLine{00032\ \ \ release\_records();}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00034\ \}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00039\ \textcolor{keywordtype}{void}\ BamCacheIndex::}
\DoxyCodeLine{00040\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00041\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)}
\DoxyCodeLine{00042\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}BamCacheIndex,\ "{}}\ <<\ \_records.size()\ <<\ \textcolor{stringliteral}{"{}\ records:\(\backslash\)n"{}};}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ Records::const\_iterator\ ri;}
\DoxyCodeLine{00045\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_records.begin();\ ri\ !=\ \_records.end();\ ++ri)\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record\ =\ (*ri).second;}
\DoxyCodeLine{00047\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)}
\DoxyCodeLine{00048\ \ \ \ \ \ \ <<\ std::setw(10)\ <<\ record-\/>\_record\_size\ <<\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ <<\ record-\/>get\_cache\_filename()\ <<\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{00050\ \ \ \ \ \ \ <<\ record-\/>get\_source\_pathname()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00053\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)}
\DoxyCodeLine{00054\ \ \ \ \ <<\ std::setw(12)\ <<\ \_cache\_size\ <<\ \textcolor{stringliteral}{"{}\ bytes\ total\(\backslash\)n"{}};}
\DoxyCodeLine{00055\ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00061\ \textcolor{keywordtype}{void}\ BamCacheIndex::}
\DoxyCodeLine{00062\ process\_new\_records()\ \{}
\DoxyCodeLine{00063\ \ \ nassertv(\_cache\_size\ ==\ 0);}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \textcolor{comment}{//\ Fill\ up\ a\ vector\ so\ we\ can\ sort\ the\ records\ into\ order\ by\ access\ time.}}
\DoxyCodeLine{00066\ \ \ RecordVector\ rv;}
\DoxyCodeLine{00067\ \ \ rv.reserve(\_records.size());}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ Records::const\_iterator\ ri;}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_records.begin();\ ri\ !=\ \_records.end();\ ++ri)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record\ =\ (*ri).second;}
\DoxyCodeLine{00072\ \ \ \ \ \_cache\_size\ +=\ record-\/>\_record\_size;}
\DoxyCodeLine{00073\ \ \ \ \ rv.push\_back(record);}
\DoxyCodeLine{00074\ \ \ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ sort(rv.begin(),\ rv.end(),\ BamCacheRecord::SortByAccessTime());}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \textcolor{comment}{//\ Now\ put\ them\ into\ the\ linked\ list.}}
\DoxyCodeLine{00079\ \ \ RecordVector::const\_iterator\ rvi;}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{for}\ (rvi\ =\ rv.begin();\ rvi\ !=\ rv.end();\ ++rvi)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record\ =\ *rvi;}
\DoxyCodeLine{00082\ \ \ \ \ record-\/>insert\_before(\textcolor{keyword}{this});}
\DoxyCodeLine{00083\ \ \ \}}
\DoxyCodeLine{00084\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00092\ \textcolor{keywordtype}{void}\ BamCacheIndex::}
\DoxyCodeLine{00093\ release\_records()\ \{}
\DoxyCodeLine{00094\ \ \ Records::const\_iterator\ ri;}
\DoxyCodeLine{00095\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_records.begin();\ ri\ !=\ \_records.end();\ ++ri)\ \{}
\DoxyCodeLine{00096\ \ \ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record\ =\ (*ri).second;}
\DoxyCodeLine{00097\ \ \ \ \ record-\/>\_next\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00098\ \ \ \ \ record-\/>\_prev\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ \ \ \_next\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00101\ \ \ \_prev\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00102\ \ \ \_cache\_size\ =\ 0;}
\DoxyCodeLine{00103\ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00109\ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ BamCacheIndex::}
\DoxyCodeLine{00110\ evict\_old\_file()\ \{}
\DoxyCodeLine{00111\ \ \ \textcolor{keywordflow}{if}\ (\_next\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{comment}{//\ Nothing\ in\ the\ cache.}}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00114\ \ \ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \textcolor{comment}{//\ The\ first\ record\ in\ the\ linked\ list\ is\ the\ least-\/recently-\/used\ one.}}
\DoxyCodeLine{00117\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record\ =\ (\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *)\_next;}
\DoxyCodeLine{00118\ \ \ \textcolor{keywordtype}{bool}\ removed\ =\ remove\_record(record-\/>get\_source\_pathname());}
\DoxyCodeLine{00119\ \ \ nassertr(removed,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{keywordflow}{return}\ record;}
\DoxyCodeLine{00122\ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00130\ \textcolor{keywordtype}{bool}\ BamCacheIndex::}
\DoxyCodeLine{00131\ add\_record(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record)\ \{}
\DoxyCodeLine{00132\ \ \ std::pair<Records::iterator,\ bool>\ result\ =}
\DoxyCodeLine{00133\ \ \ \ \ \_records.insert(Records::value\_type(record-\/>get\_source\_pathname(),\ record));}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{if}\ (!result.second)\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{//\ We\ already\ had\ a\ record\ for\ this\ filename;\ it\ gets\ replaced.}}
\DoxyCodeLine{00136\ \ \ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *orig\_record\ =\ (*result.first).second;}
\DoxyCodeLine{00137\ \ \ \ \ orig\_record-\/>remove\_from\_list();}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordflow}{if}\ (*orig\_record\ ==\ *record)\ \{}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \textcolor{comment}{//\ Well,\ never\ mind.\ \ The\ record\ hasn't\ changed.}}
\DoxyCodeLine{00140\ \ \ \ \ \ \ orig\_record-\/>insert\_before(\textcolor{keyword}{this});}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00142\ \ \ \ \ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ \ \ \_cache\_size\ -\/=\ orig\_record-\/>\_record\_size;}
\DoxyCodeLine{00145\ \ \ \ \ (*result.first).second\ =\ record;}
\DoxyCodeLine{00146\ \ \ \}}
\DoxyCodeLine{00147\ \ \ record-\/>insert\_before(\textcolor{keyword}{this});}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \_cache\_size\ +=\ record-\/>\_record\_size;}
\DoxyCodeLine{00150\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00151\ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00158\ \textcolor{keywordtype}{bool}\ BamCacheIndex::}
\DoxyCodeLine{00159\ remove\_record(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&source\_pathname)\ \{}
\DoxyCodeLine{00160\ \ \ Records::iterator\ ri\ =\ \_records.find(source\_pathname);}
\DoxyCodeLine{00161\ \ \ \textcolor{keywordflow}{if}\ (ri\ ==\ \_records.end())\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ No\ entry\ for\ this\ record;\ no\ problem.}}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00164\ \ \ \}}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}}\ *record\ =\ (*ri).second;}
\DoxyCodeLine{00167\ \ \ record-\/>remove\_from\_list();}
\DoxyCodeLine{00168\ \ \ \_cache\_size\ -\/=\ record-\/>\_record\_size;}
\DoxyCodeLine{00169\ \ \ \_records.erase(ri);}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00171\ \}}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00176\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classBamCacheIndex_ae8193f3b687ce4f5c46cff52aa706722}{BamCacheIndex::}}}
\DoxyCodeLine{00177\ \mbox{\hyperlink{classBamCacheIndex_ae8193f3b687ce4f5c46cff52aa706722}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00178\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classBamCacheIndex_a88c961216d6bfa3713c43103cb960f26}{make\_from\_bam}});}
\DoxyCodeLine{00179\ \}}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00185\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classBamCacheIndex_abccb9ed4fc250f5a2540e23afa9a8606}{BamCacheIndex::}}}
\DoxyCodeLine{00186\ \mbox{\hyperlink{classBamCacheIndex_abccb9ed4fc250f5a2540e23afa9a8606}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00187\ \ \ TypedWritable::write\_datagram(manager,\ dg);}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ dg.add\_uint32(\_records.size());}
\DoxyCodeLine{00190\ \ \ Records::const\_iterator\ ri;}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_records.begin();\ ri\ !=\ \_records.end();\ ++ri)\ \{}
\DoxyCodeLine{00192\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ (*ri).second);}
\DoxyCodeLine{00193\ \ \ \}}
\DoxyCodeLine{00194\ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00201\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classBamCacheIndex_a88c961216d6bfa3713c43103cb960f26}{BamCacheIndex::}}}
\DoxyCodeLine{00202\ \mbox{\hyperlink{classBamCacheIndex_a88c961216d6bfa3713c43103cb960f26}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00203\ \ \ \mbox{\hyperlink{classBamCacheIndex}{BamCacheIndex}}\ *\textcolor{keywordtype}{object}\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBamCacheIndex}{BamCacheIndex}};}
\DoxyCodeLine{00204\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00205\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordtype}{object}-\/>fillin(scan,\ manager);}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{return}\ object;}
\DoxyCodeLine{00211\ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00217\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classBamCacheIndex_abd68eac17f86a3559c604ec59e215fe5}{BamCacheIndex::}}}
\DoxyCodeLine{00218\ \mbox{\hyperlink{classBamCacheIndex_abd68eac17f86a3559c604ec59e215fe5}{complete\_pointers}}(\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00219\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ \mbox{\hyperlink{classTypedWritable_addc29bb978851cacca2196f8a1f35014}{TypedWritable::complete\_pointers}}(p\_list,\ manager);}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00221\ \ \ RecordVector::iterator\ vi;}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordflow}{for}\ (vi\ =\ \_record\_vector.begin();\ vi\ !=\ \_record\_vector.end();\ ++vi)\ \{}
\DoxyCodeLine{00223\ \ \ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record\ =\ DCAST(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}},\ p\_list[pi++]);}
\DoxyCodeLine{00224\ \ \ \ \ (*vi)\ =\ record;}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordtype}{bool}\ inserted\ =\ \_records.insert(Records::value\_type(record-\/>get\_source\_pathname(),\ record)).second;}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keywordflow}{if}\ (!inserted)\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \ \ util\_cat.info()}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Multiple\ cache\ files\ defining\ "{}}\ <<\ record-\/>get\_source\_pathname()}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ in\ index.\(\backslash\)n"{}};}
\DoxyCodeLine{00231\ \ \ \ \ \}}
\DoxyCodeLine{00232\ \ \ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \_record\_vector.clear();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ process\_new\_records();}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{00239\ \}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00245\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classBamCacheIndex_a3b4d9e860e9bea6f14a76b48529c98c0}{BamCacheIndex::}}}
\DoxyCodeLine{00246\ \mbox{\hyperlink{classBamCacheIndex_a3b4d9e860e9bea6f14a76b48529c98c0}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00247\ \ \ \mbox{\hyperlink{classTypedWritable_a3ad6cc1cd23bc3783d83edb3302bb43c}{TypedWritable::fillin}}(scan,\ manager);}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \textcolor{keywordtype}{int}\ num\_records\ =\ scan.get\_uint32();}
\DoxyCodeLine{00250\ \ \ \_record\_vector.reserve(num\_records);}
\DoxyCodeLine{00251\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_records;\ ++i)\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \_record\_vector.push\_back(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00253\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{00254\ \ \ \}}
\DoxyCodeLine{00255\ \}}

\end{DoxyCode}
