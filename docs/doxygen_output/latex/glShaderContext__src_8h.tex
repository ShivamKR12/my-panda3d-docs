\doxysection{panda/src/glstuff/gl\+Shader\+Context\+\_\+src.h File Reference}
\hypertarget{glShaderContext__src_8h}{}\label{glShaderContext__src_8h}\index{panda/src/glstuff/glShaderContext\_src.h@{panda/src/glstuff/glShaderContext\_src.h}}
{\ttfamily \#include "{}pandabase.\+h"{}}\newline
{\ttfamily \#include "{}string\+\_\+utils.\+h"{}}\newline
{\ttfamily \#include "{}internal\+Name.\+h"{}}\newline
{\ttfamily \#include "{}shader.\+h"{}}\newline
{\ttfamily \#include "{}shader\+Context.\+h"{}}\newline
{\ttfamily \#include "{}deleted\+Chain.\+h"{}}\newline
{\ttfamily \#include "{}param\+Texture.\+h"{}}\newline
{\ttfamily \#include "{}small\+\_\+vector.\+h"{}}\newline
{\ttfamily \#include "{}gl\+Shader\+Context\+\_\+src.\+I"{}}\newline
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
class \mbox{\hyperlink{glShaderContext__src_8h_a5d80c89177c7be4d5db8cf1ac18fad77}{CLP}} (\mbox{\hyperlink{classGraphicsStateGuardian}{Graphics\+State\+Guardian}})
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
PANDA 3D SOFTWARE Copyright (c) Carnegie Mellon University. All rights reserved.

All use of this software is subject to the terms of the revised BSD license. You should have received a copy of this license along with this source code in a file named "{}\+LICENSE."{}

\begin{DoxyAuthor}{Author}
jyelon 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2005-\/09-\/01 
\end{DoxyDate}


\doxysubsection{Function Documentation}
\Hypertarget{glShaderContext__src_8h_a5d80c89177c7be4d5db8cf1ac18fad77}\label{glShaderContext__src_8h_a5d80c89177c7be4d5db8cf1ac18fad77} 
\index{glShaderContext\_src.h@{glShaderContext\_src.h}!CLP@{CLP}}
\index{CLP@{CLP}!glShaderContext\_src.h@{glShaderContext\_src.h}}
\doxysubsubsection{\texorpdfstring{CLP()}{CLP()}}
{\footnotesize\ttfamily class CLP (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classGraphicsStateGuardian}{Graphics\+State\+Guardian}}}]{ }\end{DoxyParamCaption})}

This is called by the GL if an error occurs, if gl\+\_\+debug has been enabled (and the driver supports the GL\+\_\+\+ARB\+\_\+debug\+\_\+output extension).

Resets all internal state as if the gsg were newly created.

Force the graphics card to finish drawing before returning. !!!!!\+HACK WARNING!!!! glfinish does not actually wait for the graphics card to finish drawing only for draw calls to finish. Thus flip may not happene immediately. Instead we read a single pixel from the framebuffer. This forces the graphics card to finish drawing the frame before returning.

Clears the framebuffer within the current \doxylink{classDisplayRegion}{Display\+Region}, according to the flags indicated by the given \doxylink{classDrawableRegion}{Drawable\+Region} object.

This does not set the \doxylink{classDisplayRegion}{Display\+Region} first. You should call prepare\+\_\+display\+\_\+region() to specify the region you wish the clear operation to apply to.

Prepare a display region for rendering (set up scissor region and viewport)

Resets any non-\/standard graphics state that might give a callback apoplexy. Some drivers require that the graphics state be restored to neutral before performing certain operations. In Open\+GL, for instance, this closes any open vertex buffers.

Makes the current lens (whichever lens was most recently specified with set\+\_\+scene()) active, so that it will transform future rendered geometry. Normally this is only called from the draw process, and usually it is called by set\+\_\+scene().

The return value is true if the lens is acceptable, false if it is not.

Called before each frame is rendered, to allow the GSG a chance to do any internal cleanup before beginning the frame.

The return value is true if successful (in which case the frame will be drawn and end\+\_\+frame() will be called later), or false if unsuccessful (in which case nothing will be drawn and end\+\_\+frame() will not be called).

Called between begin\+\_\+frame() and end\+\_\+frame() to mark the beginning of drawing commands for a "{}scene"{} (usually a particular \doxylink{classDisplayRegion}{Display\+Region}) within a frame. All 3-\/D drawing commands, except the clear operation, must be enclosed within begin\+\_\+scene() .. end\+\_\+scene().

The return value is true if successful (in which case the scene will be drawn and end\+\_\+scene() will be called later), or false if unsuccessful (in which case nothing will be drawn and end\+\_\+scene() will not be called).

Called between begin\+\_\+frame() and end\+\_\+frame() to mark the end of drawing commands for a "{}scene"{} (usually a particular \doxylink{classDisplayRegion}{Display\+Region}) within a frame. All 3-\/D drawing commands, except the clear operation, must be enclosed within begin\+\_\+scene() .. end\+\_\+scene().

Called after each frame is rendered, to allow the GSG a chance to do any internal cleanup after rendering the frame, and before the window flips.

Gets the timer query results for the given frame and sends them to the PStats server.

Called before a sequence of draw\+\_\+primitive() functions are called, this should prepare the vertex data for rendering. It returns true if the vertices are ok, false to abort this group of primitives.

Ensures the vertex and array buffers are no longer bound. Some graphics drivers crash if these are left bound indiscriminantly.

Updates the vertex format used by the shader. This is still an experimental feature.

Draws a series of disconnected triangles.

Draws a series of disconnected triangles with adjacency information.

Draws a series of triangle strips.

Draws a series of triangle strips with adjacency information.

Draws a series of triangle fans.

Draws a series of "{}patches"{}, which can only be processed by a tessellation shader.

Draws a series of disconnected line segments.

Draws a series of disconnected line segments with adjacency information.

Draws a series of line strips.

Draws a series of line strips with adjacency information.

Draws a series of disconnected points.

Called after a sequence of draw\+\_\+primitive() functions are called, this should do whatever cleanup is appropriate.

Issues the given memory barriers, and clears the list of textures marked as incoherent for the given bits.

Creates whatever structures the GSG requires to represent the texture internally, and returns a newly-\/allocated \doxylink{classTextureContext}{Texture\+Context} object with this data. It is the responsibility of the calling function to later call release\+\_\+texture() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a texture. Instead, call Texture\+::prepare().

Ensures that the current \doxylink{classTexture}{Texture} data is refreshed onto the GSG. This means updating the texture properties and/or re-\/uploading the texture image, if necessary. This should only be called within the draw thread.

If force is true, this function will not return until the texture has been fully uploaded. If force is false, the function may choose to upload a simple version of the texture instead, if the texture is not fully resident (and if get\+\_\+incomplete\+\_\+render() is true).

Frees the GL resources previously allocated for the texture. This function should never be called directly; instead, call \doxylink{classTexture_aa2b01d0895bb0772c4831f01d2c954ea}{Texture\+::release()} (or simply let the \doxylink{classTexture}{Texture} destruct).

Frees the GL resources previously allocated for the textures. This function should never be called directly; instead, call \doxylink{classTexture_aa2b01d0895bb0772c4831f01d2c954ea}{Texture\+::release()} (or simply let the \doxylink{classTexture}{Texture} destruct).

This method should only be called by the \doxylink{classGraphicsEngine}{Graphics\+Engine}. Do not call it directly; call Graphics\+Engine\+::extract\+\_\+texture\+\_\+data() instead.

This method will be called in the draw thread to download the texture memory\textquotesingle{}s image into its ram\+\_\+image value. It returns true on success, false otherwise.

Creates whatever structures the GSG requires to represent the sampler state internally, and returns a newly-\/allocated \doxylink{classSamplerContext}{Sampler\+Context} object with this data. It is the responsibility of the calling function to later call release\+\_\+sampler() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a sampler object. Instead, call Sampler\+State\+::prepare().

Frees the GL resources previously allocated for the sampler. This function should never be called directly; instead, call Sampler\+State\+::release().

Creates a new retained-\/mode representation of the given geom, and returns a newly-\/allocated \doxylink{classGeomContext}{Geom\+Context} pointer to reference it. It is the responsibility of the calling function to later call release\+\_\+geom() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a geom. Instead, call \doxylink{classGeom_a0bf675037d2a13dfefa176d7c2be0486}{Geom\+::prepare()}.

Frees the GL resources previously allocated for the geom. This function should never be called directly; instead, call \doxylink{classGeom_a4a2094ebeac0db8b75c22a6ce1c53d3f}{Geom\+::release()} (or simply let the \doxylink{classGeom}{Geom} destruct).

This is intended to be called only from the GLGeom\+Context destructor. It saves the indicated display list index in the list to be deleted at the end of the frame.

Creates a new buffer for client access. It is bound when this returns. If persistent mapping is possible, mapped\+\_\+ptr will be filled in with a pointer to the mapped data.

Called when the given buffer, as returned by bind\+\_\+new\+\_\+client\+\_\+buffer, is no longer needed.

Creates a new retained-\/mode representation of the given data, and returns a newly-\/allocated \doxylink{classVertexBufferContext}{Vertex\+Buffer\+Context} pointer to reference it. It is the responsibility of the calling function to later call release\+\_\+vertex\+\_\+buffer() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a buffer. Instead, call \doxylink{classGeom_a0bf675037d2a13dfefa176d7c2be0486}{Geom\+::prepare()}.

Makes sure that the data in the vertex buffer is up-\/to-\/date. This may bind it to the GL\+\_\+\+ARRAY\+\_\+\+BUFFER binding point if necessary.

Frees the GL resources previously allocated for the data. This function should never be called directly; instead, call Data\+::release() (or simply let the Data destruct).

Internal function to bind a buffer object for the indicated data array, if appropriate, or to unbind a buffer object if it should be rendered from client memory.

If the buffer object is bound, this function sets client\+\_\+pointer to NULL (representing the start of the buffer object in server memory); if the buffer object is not bound, this function sets client\+\_\+pointer the pointer to the data array in client memory, that is, the data array passed in.

If force is not true, the function may return false indicating the data is not currently available.

Creates a new retained-\/mode representation of the given data, and returns a newly-\/allocated \doxylink{classIndexBufferContext}{Index\+Buffer\+Context} pointer to reference it. It is the responsibility of the calling function to later call release\+\_\+index\+\_\+buffer() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a buffer. Instead, call \doxylink{classGeom_a0bf675037d2a13dfefa176d7c2be0486}{Geom\+::prepare()}.

Makes the data the currently available data for rendering.

Internal function to bind a buffer object for the indicated primitive\textquotesingle{}s index list, if appropriate, or to unbind a buffer object if it should be rendered from client memory.

If the buffer object is bound, this function sets client\+\_\+pointer to NULL (representing the start of the buffer object in server memory); if the buffer object is not bound, this function sets client\+\_\+pointer to to the data array in client memory, that is, the data array passed in.

If force is not true, the function may return false indicating the data is not currently available.

Creates a new retained-\/mode representation of the given data, and returns a newly-\/allocated \doxylink{classBufferContext}{Buffer\+Context} pointer to reference it. It is the responsibility of the calling function to later call release\+\_\+shader\+\_\+buffer() with this same pointer (which will also delete the pointer).

This function should not be called directly to prepare a buffer. Instead, call \doxylink{classShaderBuffer_a81aa24bb98712ad55c9db017e8d8ad1e}{Shader\+Buffer\+::prepare()}.

This method should only be called by the \doxylink{classGraphicsEngine}{Graphics\+Engine}. Do not call it directly; call Graphics\+Engine\+::extract\+\_\+texture\+\_\+data() instead.

This method will be called in the draw thread to download the buffer\textquotesingle{}s current contents synchronously.

Begins a new occlusion query. After this call, you may call begin\+\_\+draw\+\_\+primitives() and draw\+\_\+triangles()/draw\+\_\+whatever() repeatedly. Eventually, you should call end\+\_\+occlusion\+\_\+query() before the end of the frame; that will return a new \doxylink{classOcclusionQueryContext}{Occlusion\+Query\+Context} object that will tell you how many pixels represented by the bracketed geometry passed the depth test.

It is not valid to call begin\+\_\+occlusion\+\_\+query() between another begin\+\_\+occlusion\+\_\+query() .. end\+\_\+occlusion\+\_\+query() sequence.

Adds a timer query to the command stream, associated with the given PStats collector index.

A latency query is a special type of timer query that measures the difference between CPU time and GPU time, ie. how far the GPU is behind in processing the commands being generated by the CPU right now.

Dispatches a currently bound compute shader using the given work group counts.

Copy the pixels within the indicated display region from the framebuffer into texture memory.

If z \texorpdfstring{$>$}{>} -\/1, it is the cube map index or layer index into which to copy.

Copy the pixels within the indicated display region from the framebuffer into system memory, not texture memory. Returns true on success, false on failure.

This completely redefines the ram image of the indicated texture.

Sends the indicated transform matrix to the graphics API to be applied to future vertices.

This transform is the internal\+\_\+transform, already converted into the GSG\textquotesingle{}s internal coordinate system.

Called when the current \doxylink{classShaderAttrib}{Shader\+Attrib} state has changed.

Issues the logic operation attribute to the GL.

Creates a depth buffer for shadow mapping. A derived GSG can override this if it knows that a particular buffer type works best for shadow rendering.

Calls gl\+Flush(). Returns the result of gl\+Get\+Error(). The internal implementation of report\+\_\+errors(). Don\textquotesingle{}t call this function; use report\+\_\+errors() instead. The return value is true if everything is ok, or false if we should shut down.

Returns an error string for an Open\+GL error code.

Outputs the result of gl\+Get\+String() on the indicated tag. The output string is returned.

Queries the runtime version of Open\+GL in use.

Queries the supported GLSL version.

Separates the string returned by GL\+\_\+\+EXTENSIONS (or glx or wgl extensions) into its individual tokens and saves them in the \+\_\+extensions member.

This may be redefined by a derived class (e.\+g. glx or wgl) to get whatever further extensions strings may be appropriate to that interface, in addition to the GL extension strings return by gl\+Get\+String().

Outputs the list of GL extensions to notify, if debug mode is enabled. Returns the pointer to the GL extension function with the indicated name, or NULL if the function is not available.

This is the virtual implementation of get\+\_\+extension\+\_\+func(). Each API-\/ specific GL implementation will map this method to the appropriate API call to retrieve the extension function pointer. Returns NULL if the function is not available.

Sets up the gl\+Draw\+Buffer to render into the buffer indicated by the \doxylink{classRenderBuffer}{Render\+Buffer} object. This only sets up the color and aux bits; it does not affect the depth, stencil, accum layers.

Sets up the gl\+Read\+Buffer to render into the buffer indicated by the \doxylink{classRenderBuffer}{Render\+Buffer} object. This only sets up the color bits; it does not affect the depth, stencil, accum layers.

Maps from the \doxylink{classGeom}{Geom}\textquotesingle{}s internal numeric type symbols to GL\textquotesingle{}s.

Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s texture type symbols to GL\textquotesingle{}s. Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s internal wrap mode symbols to GL\textquotesingle{}s. Maps from the GL\textquotesingle{}s internal wrap mode symbols to Panda\textquotesingle{}s.

Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s internal filter type symbols to GL\textquotesingle{}s.

Maps from the GL\textquotesingle{}s internal filter type symbols to Panda\textquotesingle{}s.

Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s internal Component\+Type symbols to GL\textquotesingle{}s.

Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s Format symbols to GL\textquotesingle{}s. Maps from the \doxylink{classTexture}{Texture}\textquotesingle{}s Format symbols to a suitable internal format for GL textures. Returns true if the indicated GL minfilter type represents a mipmap format, false otherwise.

Returns true if the indicated GL internal format represents a compressed texture format, false otherwise.

Maps from the texture stage\textquotesingle{}s mode types to the corresponding Open\+GL ids

Maps from the texture stage\textquotesingle{}s Combine\+Mode types to the corresponding Open\+GL ids

Maps from the texture stage\textquotesingle{}s Combine\+Source types to the corresponding Open\+GL ids Maps from the texture stage\textquotesingle{}s Combine\+Operand types to the corresponding Open\+GL ids

Maps from Color\+Blend\+Attrib\+::\+Mode to gl\+Blend\+Equation value.

Maps from Color\+Blend\+Attrib\+::\+Operand to gl\+Blend\+Func value.

Maps from Usage\+Hint to the GL symbol.

Returns a string describing an compression format.

Returns the value that that should be issued as the light\textquotesingle{}s color, as scaled by the current value of \+\_\+light\+\_\+color\+\_\+scale, in the case of color\+\_\+scale\+\_\+via\+\_\+lighting. Called by clear\+\_\+state\+\_\+and\+\_\+transform() to ensure that the current modelview and projection matrices are properly loaded in the graphics state, after a callback might have mucked them up.

Simultaneously resets the render state and the transform state.

This transform specified is the "{}internal"{} net transform, already converted into the GSG\textquotesingle{}s internal coordinate space by composing it to get\+\_\+cs\+\_\+transform(). (Previously, this used to be the "{}external"{} net transform, with the assumption that that GSG would convert it internally, but that is no longer the case.)

Special case\+: if (state==NULL), then the target state is already stored in \+\_\+target.

Frees some memory that was explicitly allocated within the glgsg.

Returns a Cg context for this GSG. This is called by set\+\_\+state\+\_\+and\+\_\+transform() when the texture state has changed.

Applies a white dummy texture. This is useful to bind to a texture slot when a texture is missing. Also binds the default sampler to the unit.

Returns a white dummy texture. This is useful to bind to a texture slot when a texture is missing.

This is a special function that loads the usage textures in gl-\/show-\/ texture-\/usage mode, instead of loading the actual used textures.

If the indicated stage\+\_\+index is \texorpdfstring{$>$}{>}= 0, then it is the particular texture that is shown. Otherwise, the textures are rotated through based on show\+\_\+texture\+\_\+usage\+\_\+index.

Uploads a special "{}usage"{} texture intended to be applied only in gl-\/show-\/ texture-\/usage mode, to reveal where texture memory is being spent.

Specifies the texture parameters. Returns true if the texture may need to be reloaded. Pass non-\/\+NULL sampler argument to use different sampler settings.

Updates Open\+GL with the current information for this texture, and makes it the current texture available for rendering.

The texture needs to have valid storage, call update\+\_\+texture() first.

Updates Open\+GL with the current information for this sampler, and makes it the current sampler available for rendering. Use NULL to unbind the sampler.

If the GSG doesn\textquotesingle{}t support sampler objects, the sampler settings are applied to the given texture context instead.

Uploads the entire texture image to Open\+GL, including all pages.

It does not need to be currently bound.

The return value is true if successful, or false if the texture has no image.

Loads a texture image, or one page of a cube map image, from system RAM to texture memory.

Performs the actual Open\+GL call to update the texture data for the given mipmap level (be sure to subtract the mipmap\+\_\+bias before passing it in).

If full\+\_\+reload is true, recreates the texture storage, otherwise subloads into the existing texture storage. A texture storage with undefined contents can be created by setting image\+\_\+ptr to nullptr, in which case compressed must be false.

Returns true if this texture format was supported, false otherwise.

Causes mipmaps to be generated for an uploaded texture.

This is used as a standin for upload\+\_\+texture when the texture in question is unavailable (e.\+g. it hasn\textquotesingle{}t yet been loaded from disk). Until the texture image itself becomes available, we will render the texture\textquotesingle{}s "{}simple"{} image--a sharply reduced version of the same texture.

Asks Open\+GL how much texture memory is consumed by the indicated texture (which is also the currently-\/selected texture).

Checks the list of resident texture objects to see if any have recently been evicted.

The internal implementation of extract\+\_\+texture\+\_\+data(), given an already-\/ created \doxylink{classTextureContext}{Texture\+Context}.

Assumes that the texture is already bound.

Called from extract\+\_\+texture\+\_\+data(), this gets just the image array for a particular mipmap level (or for the base image).

Internally sets the point size parameters after any of the properties have changed that might affect this. Returns true if this particular GSG supports the specified Cg \doxylink{classShader}{Shader} Profile. Binds a framebuffer object.

Set stencil render states.

Maps a buffer for reading. May be temporarily bound to the given target.

Maps a buffer as write-\/only, discarding the previous contents. If create\+\_\+storage is true, allocates new storage for the buffer. May use the given target to temporarily bind the buffer, if DSA is not supported.

Inserts a fence into the command stream.

Checks which fences are finished and processes those.

Adds a job to the queue to be processed later while the context is bound, useful for calling from other threads.

Processes any pending jobs from the queue. If wait is true, waits for at least one job if the queue is empty.

May only be called on the draw thread. 