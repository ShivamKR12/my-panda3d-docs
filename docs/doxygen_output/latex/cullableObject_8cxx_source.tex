\doxysection{cullable\+Object.\+cxx}
\hypertarget{cullableObject_8cxx_source}{}\label{cullableObject_8cxx_source}\index{panda/src/pgraph/cullableObject.cxx@{panda/src/pgraph/cullableObject.cxx}}
\mbox{\hyperlink{cullableObject_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullableObject_8h}{cullableObject.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightAttrib_8h}{lightAttrib.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePath_8h}{nodePath.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{colorAttrib_8h}{colorAttrib.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texGenAttrib_8h}{texGenAttrib.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{textureAttrib_8h}{textureAttrib.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{shaderAttrib_8h}{shaderAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clockObject_8h}{clockObject.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sceneSetup_8h}{sceneSetup.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lens_8h}{lens.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{stateMunger_8h}{stateMunger.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexReader_8h}{geomVertexReader.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTriangles_8h}{geomTriangles.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{light_8h}{light.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightMutexHolder_8h}{lightMutexHolder.h}}"{}}}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \mbox{\hyperlink{classpmap}{CullableObject::FormatMap}}\ CullableObject::\_format\_map;}
\DoxyCodeLine{00035\ \mbox{\hyperlink{classLightMutex}{LightMutex}}\ CullableObject::\_format\_lock;}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_pcollector(\textcolor{stringliteral}{"{}*:Munge"{}});}
\DoxyCodeLine{00038\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_geom\_pcollector(\textcolor{stringliteral}{"{}*:Munge:Geom"{}});}
\DoxyCodeLine{00039\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_sprites\_pcollector(\textcolor{stringliteral}{"{}*:Munge:Sprites"{}});}
\DoxyCodeLine{00040\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_sprites\_verts\_pcollector(\textcolor{stringliteral}{"{}*:Munge:Sprites:Verts"{}});}
\DoxyCodeLine{00041\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_sprites\_prims\_pcollector(\textcolor{stringliteral}{"{}*:Munge:Sprites:Prims"{}});}
\DoxyCodeLine{00042\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_munge\_instances\_pcollector(\textcolor{stringliteral}{"{}*:Munge:Instances"{}});}
\DoxyCodeLine{00043\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CullableObject::\_sw\_sprites\_pcollector(\textcolor{stringliteral}{"{}SW\ Sprites"{}});}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CullableObject::\_type\_handle;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00054\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCullableObject_a2543ec74cb51fc26d54bfd27f2f0cc59}{CullableObject::}}}
\DoxyCodeLine{00055\ \mbox{\hyperlink{classCullableObject_a2543ec74cb51fc26d54bfd27f2f0cc59}{munge\_geom}}(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *munger,}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *traverser,\ \textcolor{keywordtype}{bool}\ force)\ \{}
\DoxyCodeLine{00057\ \ \ nassertr(munger\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ traverser-\/>get\_current\_thread();}
\DoxyCodeLine{00060\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_munge\_pcollector,\ current\_thread);}
\DoxyCodeLine{00061\ \ \ \textcolor{keywordflow}{if}\ (\_geom\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg\ =\ traverser-\/>get\_gsg();}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{int}\ gsg\_bits\ =\ gsg-\/>get\_supported\_geom\_rendering();}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordflow}{if}\ (!hardware\_point\_sprites)\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ support\ for\ hardware\ point\ sprites\ or\ perspective-\/scaled\ points\ is}}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \textcolor{comment}{//\ disabled,\ we\ don't\ allow\ the\ GSG\ to\ tell\ us\ it\ supports\ them.}}
\DoxyCodeLine{00067\ \ \ \ \ \ \ gsg\_bits\ \&=\ \string~(Geom::GR\_point\_perspective\ |\ Geom::GR\_point\_sprite);}
\DoxyCodeLine{00068\ \ \ \ \ \}}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keywordflow}{if}\ (!hardware\_points)\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ hardware-\/points\ is\ off,\ we\ don't\ allow\ any\ kind\ of\ point}}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \textcolor{comment}{//\ rendering,\ except\ plain\ old\ one-\/pixel\ points;}}
\DoxyCodeLine{00072\ \ \ \ \ \ \ gsg\_bits\ \&=\ \string~(Geom::GR\_point\_bits\ \&\ \mbox{\hyperlink{classGeom}{\string~Geom}}::GR\_point);}
\DoxyCodeLine{00073\ \ \ \ \ \}}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{int}\ geom\_rendering;}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordtype}{int}\ unsupported\_bits;}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \ \ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomPipelineReader}{GeomPipelineReader}}\ geom\_reader(\_geom,\ current\_thread);}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \_munged\_data\ =\ geom\_reader.get\_vertex\_data();}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#ifdef\ \_DEBUG}}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexDataPipelineReader}{GeomVertexDataPipelineReader}}\ data\_reader(\_munged\_data,\ current\_thread);}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ data\_reader.check\_array\_readers();}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ nassertr(geom\_reader.check\_valid(\&data\_reader),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ \_DEBUG}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \ \ \ \ geom\_rendering\ =\ geom\_reader.get\_geom\_rendering();}
\DoxyCodeLine{00090\ \ \ \ \ \ \ geom\_rendering\ =\ \_state-\/>get\_geom\_rendering(geom\_rendering);}
\DoxyCodeLine{00091\ \ \ \ \ \ \ geom\_rendering\ =\ \_internal\_transform-\/>get\_geom\_rendering(geom\_rendering);}
\DoxyCodeLine{00092\ \ \ \ \ \ \ unsupported\_bits\ =\ geom\_rendering\ \&\ \string~gsg\_bits;}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unsupported\_bits\ \&\ Geom::GR\_per\_point\_size)\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ a\ shader\ that\ processes\ the\ point\ size,\ we\ can\ assume\ it}}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ does\ the\ right\ thing.}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *sattr;}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state-\/>get\_attrib(sattr)\ \&\&\ sattr-\/>get\_flag(ShaderAttrib::F\_shader\_point\_size))\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ unsupported\_bits\ \&=\ \mbox{\hyperlink{classGeom}{\string~Geom}}::GR\_per\_point\_size;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_rendering\ \&\ Geom::GR\_point\_bits)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_reader.get\_primitive\_type()\ !=\ Geom::PT\_points)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (singular\_points\ ||}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (unsupported\_bits\ \&\ Geom::GR\_render\_mode\_point)\ !=\ 0)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Isolate\ the\ points\ so\ there's\ no\ unneeded\ overlap.}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \_geom\ =\ \_geom-\/>make\_points();}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (unsupported\_bits\ \&\ Geom::GR\_render\_mode\_wireframe)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_reader.get\_primitive\_type()\ !=\ Geom::PT\_lines)\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \_geom\ =\ \_geom-\/>make\_lines();}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00117\ \ \ \ \ \}}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_point\_bits)\ !=\ 0)\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ GSG\ doesn't\ support\ rendering\ these\ fancy\ points\ directly;\ we}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \textcolor{comment}{//\ have\ to\ render\ them\ in\ software\ instead.\ \ Munge\ them\ into\ quads.}}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ will\ replace\ the\ \_geom\ and\ \_munged\_data,\ and\ might\ also\ replace}}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \textcolor{comment}{//\ \_state.}}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}munge\_points\_to\_quads()\ for\ geometry\ with\ bits:\ "{}}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ <<\ std::hex\ <<\ geom\_rendering\ <<\ \textcolor{stringliteral}{"{},\ unsupported:\ "{}}}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ <<\ (unsupported\_bits\ \&\ Geom::GR\_point\_bits)\ <<\ std::dec\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!munge\_points\_to\_quads(traverser,\ force))\ \{}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{//\ Now\ invoke\ the\ munger\ to\ ensure\ the\ resulting\ geometry\ is\ in\ a\ GSG-\/}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{comment}{//\ friendly\ form.}}
\DoxyCodeLine{00137\ \ \ \ \ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_munge\_geom\_pcollector,\ current\_thread);}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!munger-\/>\mbox{\hyperlink{classGeomMunger_a737e22598517a47a514941afcbb09e86}{munge\_geom}}(\_geom,\ \_munged\_data,\ force,\ current\_thread))\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00142\ \ \ \ \ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ prepared\ it\ for\ skinning\ via\ the\ shader\ generator,\ mark\ a}}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{comment}{//\ flag\ on\ the\ state\ so\ that\ the\ shader\ generator\ will\ do\ this.\ \ We\ should}}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ probably\ find\ a\ cleaner\ way\ to\ do\ this.}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *sattr;}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state-\/>get\_attrib(sattr)\ \&\&\ sattr-\/>auto\_shader())\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexDataPipelineReader}{GeomVertexDataPipelineReader}}\ data\_reader(\_munged\_data,\ current\_thread);}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data\_reader.get\_format()-\/>get\_animation().get\_animation\_type()\ ==\ Geom::AT\_hardware)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ RenderState::make(}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}},\ ShaderAttrib::make())-\/>set\_flag(ShaderAttrib::F\_hardware\_skinning,\ \textcolor{keyword}{true}));}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \_state\ =\ \_state-\/>compose(state);}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \ \ \ \ gsg-\/>ensure\_generated\_shader(\_state);}
\DoxyCodeLine{00157\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ may\ need\ to\ munge\ the\ state\ for\ the\ fixed-\/function\ pipeline.}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \mbox{\hyperlink{classStateMunger}{StateMunger}}\ *state\_munger\ =\ (\mbox{\hyperlink{classStateMunger}{StateMunger}}\ *)munger;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (state\_munger-\/>should\_munge\_state())\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \_state\ =\ state\_munger-\/>munge\_state(\_state);}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ If\ there\ is\ any\ animation\ left\ in\ the\ vertex\ data\ after\ it\ has\ been}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ munged-\/-\/that\ is,\ we\ couldn't\ arrange\ to\ handle\ the\ animation\ in}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ hardware-\/-\/then\ we\ have\ to\ calculate\ that\ animation\ now.}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{keywordtype}{bool}\ cpu\_animated\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ animated\_vertices\ =}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \_munged\_data-\/>animate\_vertices(force,\ current\_thread);}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordflow}{if}\ (animated\_vertices\ !=\ \_munged\_data)\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \ \ cpu\_animated\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00174\ \ \ \ \ \ \ std::swap(\_munged\_data,\ animated\_vertices);}
\DoxyCodeLine{00175\ \ \ \ \ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keywordflow}{if}\ (sattr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_instances\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ sattr-\/>get\_flag(ShaderAttrib::F\_hardware\_instancing))\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ are\ under\ an\ InstancedNode,\ and\ the\ shader\ implements\ hardware.}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Munge\ the\ instance\ list\ into\ the\ vertex\ data.}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ munge\_instances(current\_thread);}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \_num\_instances\ =\ \_instances-\/>size();}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \_instances\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No,\ use\ the\ instance\ count\ from\ the\ ShaderAttrib.}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ count\ =\ sattr-\/>get\_instance\_count();}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \_num\_instances\ =\ (count\ >\ 0)\ ?\ (\textcolor{keywordtype}{size\_t})count\ :\ 1;}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00190\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \_num\_instances\ =\ 1;}
\DoxyCodeLine{00192\ \ \ \ \ \}}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordflow}{if}\ (show\_vertex\_animation)\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexDataPipelineReader}{GeomVertexDataPipelineReader}}\ data\_reader(\_munged\_data,\ current\_thread);}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ hardware\_animated\ =\ (data\_reader.get\_format()-\/>get\_animation().get\_animation\_type()\ ==\ Geom::AT\_hardware);}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cpu\_animated\ ||\ hardware\_animated)\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ These\ vertices\ were\ animated,\ so\ flash\ them\ red\ or\ blue.}}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ flash\_rate\ =\ 1.0;\ \ \textcolor{comment}{//\ 1\ state\ change\ per\ second}}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ cycle\ =\ (int)(ClockObject::get\_global\_clock()-\/>get\_frame\_time()\ *\ flash\_rate);}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((cycle\ \&\ 1)\ ==\ 0)\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \_state\ =\ cpu\_animated\ ?\ get\_flash\_cpu\_state()\ :\ get\_flash\_hardware\_state();}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00206\ \ \ \ \ \}}
\DoxyCodeLine{00207\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00208\ \ \ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00211\ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00216\ \textcolor{keywordtype}{void}\ CullableObject::}
\DoxyCodeLine{00217\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00218\ \ \ \textcolor{keywordflow}{if}\ (\_geom\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00219\ \ \ \ \ out\ <<\ *\_geom;}
\DoxyCodeLine{00220\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00221\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}(null)"{}};}
\DoxyCodeLine{00222\ \ \ \}}
\DoxyCodeLine{00223\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00229\ \textcolor{keywordtype}{void}\ CullableObject::}
\DoxyCodeLine{00230\ munge\_instances(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00231\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_munge\_instances\_pcollector,\ current\_thread);}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ instanced\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}(*\_munged\_data);}
\DoxyCodeLine{00234\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *array\_format\ =\ \mbox{\hyperlink{classGeomVertexArrayFormat_ab687f6b5cdcc1ec07dd96bb0b2e555fd}{GeomVertexArrayFormat::get\_instance\_array\_format}}();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ CPT(\mbox{\hyperlink{classGeomVertexArrayData}{GeomVertexArrayData}})\ new\_array\ =\ \_instances-\/>get\_array\_data(array\_format);}
\DoxyCodeLine{00237\ \ \ instanced\_data-\/>insert\_array((\textcolor{keywordtype}{size\_t})-\/1,\ new\_array);}
\DoxyCodeLine{00238\ \ \ \_munged\_data\ =\ instanced\_data;}
\DoxyCodeLine{00239\ \}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00247\ \textcolor{keywordtype}{bool}\ CullableObject::}
\DoxyCodeLine{00248\ munge\_points\_to\_quads(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *traverser,\ \textcolor{keywordtype}{bool}\ force)\ \{}
\DoxyCodeLine{00249\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ traverser-\/>get\_current\_thread();}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ \textcolor{comment}{//\ Better\ get\ the\ animated\ vertices,\ in\ case\ we're\ showing\ sprites\ on\ an}}
\DoxyCodeLine{00252\ \ \ \textcolor{comment}{//\ animated\ model\ for\ some\ reason.}}
\DoxyCodeLine{00253\ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ source\_data\ =}
\DoxyCodeLine{00254\ \ \ \ \ \_munged\_data-\/>animate\_vertices(force,\ current\_thread);}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \textcolor{keywordflow}{if}\ (!force\ \&\&\ !source\_data-\/>request\_resident())\ \{}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00258\ \ \ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \mbox{\hyperlink{classGeomVertexDataPipelineReader}{GeomVertexDataPipelineReader}}\ reader(source\_data,\ current\_thread);}
\DoxyCodeLine{00261\ \ \ reader.check\_array\_readers();}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_munge\_sprites\_pcollector,\ current\_thread);}
\DoxyCodeLine{00264\ \ \ \_sw\_sprites\_pcollector.add\_level(reader.get\_num\_rows());}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg\ =\ traverser-\/>get\_gsg();}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ vertex(\&reader,\ InternalName::get\_vertex());}
\DoxyCodeLine{00269\ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ normal(\&reader,\ InternalName::get\_normal());}
\DoxyCodeLine{00270\ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ rotate(\&reader,\ InternalName::get\_rotate());}
\DoxyCodeLine{00271\ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ size(\&reader,\ InternalName::get\_size());}
\DoxyCodeLine{00272\ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ aspect\_ratio(\&reader,\ InternalName::get\_aspect\_ratio());}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \textcolor{keywordtype}{bool}\ has\_normal\ =\ (normal.has\_column());}
\DoxyCodeLine{00275\ \ \ \textcolor{keywordtype}{bool}\ has\_color\ =\ (reader.has\_column(InternalName::get\_color()));}
\DoxyCodeLine{00276\ \ \ \textcolor{keywordtype}{bool}\ has\_texcoord\ =\ (reader.has\_column(InternalName::get\_texcoord()));}
\DoxyCodeLine{00277\ \ \ \textcolor{keywordtype}{bool}\ has\_rotate\ =\ (rotate.has\_column());}
\DoxyCodeLine{00278\ \ \ \textcolor{keywordtype}{bool}\ has\_size\ =\ (size.has\_column());}
\DoxyCodeLine{00279\ \ \ \textcolor{keywordtype}{bool}\ has\_aspect\_ratio\ =\ (aspect\_ratio.has\_column());}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \textcolor{keywordtype}{bool}\ sprite\_texcoord\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00282\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTexGenAttrib}{TexGenAttrib}}\ *tex\_gen\ =\ DCAST(\mbox{\hyperlink{classTexGenAttrib}{TexGenAttrib}},\ \_state-\/>get\_attrib(TexGenAttrib::get\_class\_slot()));}
\DoxyCodeLine{00283\ \ \ \textcolor{keywordflow}{if}\ (tex\_gen\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\_gen-\/>get\_mode(TextureStage::get\_default())\ ==\ TexGenAttrib::M\_point\_sprite)\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \ \ sprite\_texcoord\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \ \ \ \ \textcolor{comment}{//\ Turn\ off\ the\ TexGenAttrib,\ since\ we\ don't\ want\ it\ now.}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \_state\ =\ \_state-\/>set\_attrib(tex\_gen-\/>remove\_stage(TextureStage::get\_default()));}
\DoxyCodeLine{00289\ \ \ \ \ \}}
\DoxyCodeLine{00290\ \ \ \}}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ PN\_stdfloat\ point\_size\ =\ 1;}
\DoxyCodeLine{00293\ \ \ \textcolor{keywordtype}{bool}\ perspective\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00294\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderModeAttrib}{RenderModeAttrib}}\ *render\_mode\ =\ DCAST(\mbox{\hyperlink{classRenderModeAttrib}{RenderModeAttrib}},\ \_state-\/>get\_attrib(RenderModeAttrib::get\_class\_slot()));}
\DoxyCodeLine{00295\ \ \ \textcolor{keywordflow}{if}\ (render\_mode\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00296\ \ \ \ \ point\_size\ =\ render\_mode-\/>get\_thickness();}
\DoxyCodeLine{00297\ \ \ \ \ perspective\ =\ render\_mode-\/>get\_perspective();}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{keywordflow}{if}\ (render\_mode-\/>get\_mode()\ !=\ RenderModeAttrib::M\_filled\_flat)\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \textcolor{comment}{//\ Render\ the\ new\ polygons\ with\ M\_filled\_flat,\ for\ a\ slight\ performance}}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \textcolor{comment}{//\ advantage\ when\ software\ rendering.}}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \_state\ =\ \_state-\/>set\_attrib(RenderModeAttrib::make(RenderModeAttrib::M\_filled\_flat));}
\DoxyCodeLine{00303\ \ \ \ \ \}}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{comment}{//\ Get\ the\ vertex\ format\ of\ the\ newly\ created\ geometry.}}
\DoxyCodeLine{00307\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ new\_format;}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \{}
\DoxyCodeLine{00310\ \ \ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_format\_lock);}
\DoxyCodeLine{00311\ \ \ \ \ SourceFormat\ sformat(reader.get\_format(),\ sprite\_texcoord);}
\DoxyCodeLine{00312\ \ \ \ \ FormatMap::iterator\ fmi\ =\ \_format\_map.find(sformat);}
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{keywordflow}{if}\ (fmi\ !=\ \_format\_map.end())\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ new\_format\ =\ (*fmi).second;}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ construct\ the\ format\ now.}}
\DoxyCodeLine{00318\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ new\_array\_format;}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sformat.\_retransform\_sprites)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ With\ retransform\_sprites\ in\ effect,\ we\ will\ be\ sending\ ordinary\ 3-\/D}}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ points\ to\ the\ graphics\ API.}}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ new\_array\_format\ =}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}(InternalName::get\_vertex(),\ 3,}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Geom::NT\_stdfloat,}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Geom::C\_point);}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Without\ retransform\_sprites,\ we\ will\ be\ sending\ 4-\/component\ clip-\/}}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ space\ points.}}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ new\_array\_format\ =}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}(InternalName::get\_vertex(),\ 4,}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Geom::NT\_stdfloat,}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Geom::C\_clip\_point);}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_normal)\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *c\ =\ reader.get\_format()-\/>get\_normal\_column();}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \ \ (InternalName::get\_normal(),\ c-\/>get\_num\_components(),}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \ c-\/>get\_numeric\_type(),\ c-\/>get\_contents());}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_color)\ \{}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *c\ =\ reader.get\_format()-\/>get\_color\_column();}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \ \ (InternalName::get\_color(),\ c-\/>get\_num\_components(),}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ c-\/>get\_numeric\_type(),\ c-\/>get\_contents());}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sprite\_texcoord)\ \{}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \ \ (InternalName::get\_texcoord(),\ 2,}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \ \ \ Geom::NT\_stdfloat,}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \ \ \ Geom::C\_texcoord);}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00352\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (has\_texcoord)\ \{}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *c\ =\ reader.get\_format()-\/>get\_column(InternalName::get\_texcoord());}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ (InternalName::get\_texcoord(),\ c-\/>get\_num\_components(),}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \ \ \ c-\/>get\_numeric\_type(),\ c-\/>get\_contents());}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \ \ \ \ \textcolor{comment}{//\ Go\ through\ the\ other\ columns\ and\ copy\ them\ from\ the\ original.}}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ai\ =\ 0;\ ai\ <\ sformat.\_format-\/>get\_num\_arrays();\ ++ai)\ \{}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *aformat\ =\ sformat.\_format-\/>get\_array(ai);}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ci\ =\ 0;\ ci\ <\ (size\_t)aformat-\/>get\_num\_columns();\ ++ci)\ \{}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *column\ =\ aformat-\/>get\_column(ci);}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ column-\/>\mbox{\hyperlink{classInternalName_a9fd35ab9c168d1b4e3dcb6822086ae61}{get\_name}}();}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (name\ !=\ InternalName::get\_vertex()\ \&\&}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_normal()\ \&\&}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_color()\ \&\&}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_texcoord()\ \&\&}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_rotate()\ \&\&}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_size()\ \&\&}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ !=\ InternalName::get\_aspect\_ratio())\ \{}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column(name,}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ column-\/>get\_num\_components(),\ column-\/>get\_numeric\_type(),}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ column-\/>get\_contents());}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00379\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \ \ \ \ \ \ new\_format\ =\ GeomVertexFormat::register\_format(new\_array\_format);}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \_format\_map[sformat]\ =\ new\_format;}
\DoxyCodeLine{00383\ \ \ \ \ \}}
\DoxyCodeLine{00384\ \ \ \}}
\DoxyCodeLine{00385\ }
\DoxyCodeLine{00386\ \ \ CoordinateSystem\ internal\_cs\ =\ gsg-\/>get\_internal\_coordinate\_system();}
\DoxyCodeLine{00387\ \ \ LMatrix4\ internal\ =\ \_internal\_transform-\/>get\_mat();}
\DoxyCodeLine{00388\ \ \ PN\_stdfloat\ scale\ =\ \_internal\_transform-\/>get\_scale()[1];}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \ \ \mbox{\hyperlink{classSceneSetup}{SceneSetup}}\ *scene\ =\ traverser-\/>get\_scene();}
\DoxyCodeLine{00391\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens\ =\ scene-\/>get\_lens();}
\DoxyCodeLine{00392\ \ \ LMatrix4\ projection\ =}
\DoxyCodeLine{00393\ \ \ \ \ LMatrix4::convert\_mat(internal\_cs,\ lens-\/>get\_coordinate\_system())\ *}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ lens-\/>get\_projection\_mat();}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \textcolor{keywordtype}{int}\ viewport\_width\ =\ scene-\/>get\_viewport\_width();}
\DoxyCodeLine{00397\ \ \ \textcolor{keywordtype}{int}\ viewport\_height\ =\ scene-\/>get\_viewport\_height();}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \ \ \textcolor{comment}{//\ We\ need\ a\ standard\ projection\ matrix,\ in\ a\ known\ coordinate\ system,\ to}}
\DoxyCodeLine{00400\ \ \ \textcolor{comment}{//\ compute\ the\ perspective\ height.}}
\DoxyCodeLine{00401\ \ \ LMatrix4\ height\_projection;}
\DoxyCodeLine{00402\ \ \ \textcolor{keywordflow}{if}\ (perspective)\ \{}
\DoxyCodeLine{00403\ \ \ \ \ height\_projection\ =}
\DoxyCodeLine{00404\ \ \ \ \ \ \ LMatrix4::convert\_mat(CS\_yup\_right,\ lens-\/>get\_coordinate\_system())\ *}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ lens-\/>get\_projection\_mat();}
\DoxyCodeLine{00406\ \ \ \}}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ LMatrix4\ render\_transform\ =\ internal\ *\ projection;}
\DoxyCodeLine{00409\ \ \ LMatrix4\ inv\_render\_transform;}
\DoxyCodeLine{00410\ \ \ inv\_render\_transform.invert\_from(render\_transform);}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00412\ \ \ \textcolor{comment}{//\ Now\ convert\ all\ of\ the\ vertices\ in\ the\ GeomVertexData\ to\ quads.\ \ We}}
\DoxyCodeLine{00413\ \ \ \textcolor{comment}{//\ always\ convert\ all\ the\ vertices,\ assuming\ all\ the\ vertices\ are\ referenced}}
\DoxyCodeLine{00414\ \ \ \textcolor{comment}{//\ by\ GeomPrimitives,\ because\ we\ want\ to\ optimize\ for\ the\ most\ common\ case.}}
\DoxyCodeLine{00415\ \ \ \textcolor{keywordtype}{int}\ orig\_verts\ =\ reader.get\_num\_rows();}
\DoxyCodeLine{00416\ \ \ \textcolor{keywordtype}{int}\ new\_verts\ =\ 4\ *\ orig\_verts;\ \ \ \ \ \ \ \ \textcolor{comment}{//\ each\ vertex\ becomes\ four.}}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ new\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00419\ \ \ \ \ (source\_data-\/>get\_name(),\ new\_format,\ Geom::UH\_stream);}
\DoxyCodeLine{00420\ \ \ new\_data-\/>unclean\_set\_num\_rows(new\_verts);}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ new\_vertex(new\_data,\ InternalName::get\_vertex());}
\DoxyCodeLine{00423\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ new\_normal(new\_data,\ InternalName::get\_normal());}
\DoxyCodeLine{00424\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ new\_texcoord(new\_data,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ nassertr(new\_vertex.has\_column(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00427\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *write\_ptr\ =\ new\_vertex.get\_array\_handle()-\/>get\_write\_pointer();}
\DoxyCodeLine{00428\ }
\DoxyCodeLine{00429\ \ \ \textcolor{comment}{//\ Collect\ all\ other\ columns\ that\ we\ just\ need\ to\ copy\ the\ data\ of.}}
\DoxyCodeLine{00430\ \ \ \textcolor{keyword}{struct\ }CopyOp\ \{}
\DoxyCodeLine{00431\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *\_to\_pointer;}
\DoxyCodeLine{00432\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *\_from\_pointer;}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \_num\_bytes;}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \_from\_stride;}
\DoxyCodeLine{00435\ \ \ \};}
\DoxyCodeLine{00436\ \ \ \mbox{\hyperlink{classpvector}{pvector<CopyOp>}}\ copies;}
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *aformat\ =\ new\_format-\/>get\_array(0);}
\DoxyCodeLine{00439\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ci\ =\ 0;\ ci\ <\ (size\_t)aformat-\/>get\_num\_columns();\ ++ci)\ \{}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *column\ =\ aformat-\/>get\_column(ci);}
\DoxyCodeLine{00441\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ column-\/>\mbox{\hyperlink{classInternalName_a9fd35ab9c168d1b4e3dcb6822086ae61}{get\_name}}();}
\DoxyCodeLine{00442\ \ \ \ \ \textcolor{keywordflow}{if}\ (name\ !=\ InternalName::get\_vertex()\ \&\&}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ (retransform\_sprites\ ||\ name\ !=\ InternalName::get\_normal())\ \&\&}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ (!sprite\_texcoord\ ||\ name\ !=\ InternalName::get\_texcoord()))\ \{}
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00446\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ source\_array;}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *source\_column;}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (reader.get\_format()-\/>get\_array\_info(name,\ source\_array,\ source\_column))\ \{}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ CopyOp\ copy;}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ copy.\_to\_pointer\ =\ write\_ptr\ +\ (size\_t)column-\/>get\_start();}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ copy.\_from\_pointer\ =\ reader.get\_array\_reader(source\_array)-\/>get\_read\_pointer(\textcolor{keyword}{true})\ +\ (size\_t)source\_column-\/>get\_start();}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ copy.\_num\_bytes\ =\ (size\_t)column-\/>get\_total\_bytes();}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ copy.\_from\_stride\ =\ reader.get\_format()-\/>get\_array(source\_array)-\/>get\_stride();}
\DoxyCodeLine{00454\ }
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!copies.empty()\ \&\&}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \ \ \ \ (copy.\_to\_pointer\ ==\ copies.back().\_to\_pointer\ +\ copies.back().\_num\_bytes)\ \&\&}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \ \ \ \ (copy.\_from\_pointer\ ==\ copies.back().\_from\_pointer\ +\ copies.back().\_num\_bytes))\ \{}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Merge\ with\ previous.}}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ copies.back().\_num\_bytes\ +=\ copy.\_num\_bytes;}
\DoxyCodeLine{00460\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \ \ \ \ copies.push\_back(copy);}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00464\ \ \ \ \ \}}
\DoxyCodeLine{00465\ \ \ \}}
\DoxyCodeLine{00466\ \ \ \textcolor{keywordtype}{size\_t}\ to\_stride\ =\ aformat-\/>get\_stride();}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00468\ \ \ \textcolor{comment}{//\ We'll\ keep\ an\ array\ of\ all\ of\ the\ points'\ eye-\/space\ coordinates,\ and}}
\DoxyCodeLine{00469\ \ \ \textcolor{comment}{//\ their\ distance\ from\ the\ camera,\ so\ we\ can\ sort\ the\ points\ for\ each}}
\DoxyCodeLine{00470\ \ \ \textcolor{comment}{//\ primitive,\ below.}}
\DoxyCodeLine{00471\ \ \ PointData\ *points;}
\DoxyCodeLine{00472\ \ \ \{}
\DoxyCodeLine{00473\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ t2(\_munge\_sprites\_verts\_pcollector,\ current\_thread);}
\DoxyCodeLine{00474\ \ \ \ \ points\ =\ (PointData\ *)alloca(orig\_verts\ *\ \textcolor{keyword}{sizeof}(PointData));}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{keywordtype}{int}\ vi\ =\ 0;}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{keywordflow}{while}\ (!vertex.is\_at\_end())\ \{}
\DoxyCodeLine{00477\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ point\ in\ eye-\/space\ coordinates.}}
\DoxyCodeLine{00478\ \ \ \ \ \ \ LPoint3\ eye\ =\ internal.xform\_point(vertex.get\_data3());}
\DoxyCodeLine{00479\ \ \ \ \ \ \ PN\_stdfloat\ dist\ =\ gsg-\/>compute\_distance\_to(eye);}
\DoxyCodeLine{00480\ \ \ \ \ \ \ points[vi].\_dist\ =\ dist;}
\DoxyCodeLine{00481\ }
\DoxyCodeLine{00482\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ in\ clip\ coordinates.}}
\DoxyCodeLine{00483\ \ \ \ \ \ \ LPoint4\ p4\ =\ LPoint4(eye[0],\ eye[1],\ eye[2],\ 1.0f)\ *\ projection;}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_size)\ \{}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ point\_size\ =\ size.get\_data1();}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \ \ \ \ \ \ PN\_stdfloat\ scale\_y\ =\ point\_size;}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (perspective)\ \{}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Perspective-\/sized\ points.\ \ Here\ point\_size\ is\ the\ point's\ height\ in}}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 3-\/d\ units.\ \ To\ arrange\ that,\ we\ need\ to\ figure\ out\ the\ appropriate}}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ scaling\ factor\ based\ on\ the\ current\ viewport\ and\ projection\ matrix.}}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ LVector3\ height(0.0f,\ point\_size\ *\ scale,\ scale);}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ height\ =\ height\ *\ height\_projection;}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ scale\_y\ =\ height[1]\ *\ viewport\_height;}
\DoxyCodeLine{00497\ }
\DoxyCodeLine{00498\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ should\ then\ divide\ the\ radius\ by\ the\ distance\ from\ the\ camera}}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ plane,\ to\ emulate\ the\ glPointParameters()\ behavior.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!lens-\/>\mbox{\hyperlink{classLens_a81e08c8c07fb9d83ef071dc3bb64c895}{is\_orthographic}}())\ \{}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ \ scale\_y\ /=\ dist;}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00505\ \ \ \ \ \ \ \textcolor{comment}{//\ Also\ factor\ in\ the\ homogeneous\ scale\ for\ being\ in\ clip\ coordinates}}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \textcolor{comment}{//\ still.}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ scale\_y\ *=\ p4[3];}
\DoxyCodeLine{00508\ }
\DoxyCodeLine{00509\ \ \ \ \ \ \ PN\_stdfloat\ scale\_x\ =\ scale\_y;}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_aspect\_ratio)\ \{}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ scale\_x\ *=\ aspect\_ratio.get\_data1();}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00513\ }
\DoxyCodeLine{00514\ \ \ \ \ \ \ \textcolor{comment}{//\ Define\ the\ first\ two\ corners\ based\ on\ the\ scales\ in\ X\ and\ Y.}}
\DoxyCodeLine{00515\ \ \ \ \ \ \ LPoint2\ c0(scale\_x,\ scale\_y);}
\DoxyCodeLine{00516\ \ \ \ \ \ \ LPoint2\ c1(-\/scale\_x,\ scale\_y);}
\DoxyCodeLine{00517\ }
\DoxyCodeLine{00518\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_rotate)\ \{}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ a\ rotate\ factor,\ apply\ it\ to\ those\ two\ corners.}}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ PN\_stdfloat\ r\ =\ rotate.get\_data1();}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ LMatrix3\ mat\ =\ LMatrix3::rotate\_mat(r);}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ c0\ =\ c0\ *\ mat;}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ c1\ =\ c1\ *\ mat;}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \ \ \ \ \ \ \textcolor{comment}{//\ Finally,\ scale\ the\ corners\ in\ their\ newly-\/rotated\ position,\ to}}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \textcolor{comment}{//\ compensate\ for\ the\ aspect\ ratio\ of\ the\ viewport.}}
\DoxyCodeLine{00528\ \ \ \ \ \ \ PN\_stdfloat\ rx\ =\ 1.0f\ /\ viewport\_width;}
\DoxyCodeLine{00529\ \ \ \ \ \ \ PN\_stdfloat\ ry\ =\ 1.0f\ /\ viewport\_height;}
\DoxyCodeLine{00530\ \ \ \ \ \ \ c0.set(c0[0]\ *\ rx,\ c0[1]\ *\ ry);}
\DoxyCodeLine{00531\ \ \ \ \ \ \ c1.set(c1[0]\ *\ rx,\ c1[1]\ *\ ry);}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00533\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (retransform\_sprites)\ \{}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ With\ retransform\_sprites\ in\ effect,\ we\ must\ reconvert\ the\ resulting}}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ quad\ back\ into\ the\ original\ 3-\/D\ space.}}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(inv\_render\_transform.xform(LPoint4(p4[0]\ +\ c0[0],\ p4[1]\ +\ c0[1],\ p4[2],\ p4[3])));}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(inv\_render\_transform.xform(LPoint4(p4[0]\ +\ c1[0],\ p4[1]\ +\ c1[1],\ p4[2],\ p4[3])));}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(inv\_render\_transform.xform(LPoint4(p4[0]\ -\/\ c1[0],\ p4[1]\ -\/\ c1[1],\ p4[2],\ p4[3])));}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(inv\_render\_transform.xform(LPoint4(p4[0]\ -\/\ c0[0],\ p4[1]\ -\/\ c0[1],\ p4[2],\ p4[3])));}
\DoxyCodeLine{00540\ }
\DoxyCodeLine{00541\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Without\ retransform\_sprites,\ we\ can\ simply\ load\ the\ clip-\/space}}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ coordinates.}}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(p4[0]\ +\ c0[0],\ p4[1]\ +\ c0[1],\ p4[2],\ p4[3]);}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(p4[0]\ +\ c1[0],\ p4[1]\ +\ c1[1],\ p4[2],\ p4[3]);}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(p4[0]\ -\/\ c1[0],\ p4[1]\ -\/\ c1[1],\ p4[2],\ p4[3]);}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \ \ new\_vertex.set\_data4(p4[0]\ -\/\ c0[0],\ p4[1]\ -\/\ c0[1],\ p4[2],\ p4[3]);}
\DoxyCodeLine{00548\ }
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_normal)\ \{}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ transform\ the\ normals\ to\ clip-\/space\ too,\ then.}}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \ \ \ \ LNormal\ c\ =\ render\_transform.xform\_vec(normal.get\_data3());}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \ \ new\_normal.set\_data3(c);}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ \ \ new\_normal.set\_data3(c);}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \ \ \ \ new\_normal.set\_data3(c);}
\DoxyCodeLine{00555\ \ \ \ \ \ \ \ \ \ \ new\_normal.set\_data3(c);}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sprite\_texcoord)\ \{}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ new\_texcoord.set\_data2(1.0f,\ 0.0f);}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ new\_texcoord.set\_data2(0.0f,\ 0.0f);}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ new\_texcoord.set\_data2(1.0f,\ 1.0f);}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ new\_texcoord.set\_data2(0.0f,\ 1.0f);}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00564\ }
\DoxyCodeLine{00565\ \ \ \ \ \ \ \textcolor{comment}{//\ Other\ columns\ are\ simply\ duplicated\ for\ each\ vertex.}}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (CopyOp\ \&copy\ :\ copies)\ \{}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ memcpy(copy.\_to\_pointer,\ copy.\_from\_pointer,\ copy.\_num\_bytes);}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ copy.\_to\_pointer\ +=\ to\_stride;}
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ memcpy(copy.\_to\_pointer,\ copy.\_from\_pointer,\ copy.\_num\_bytes);}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \ \ copy.\_to\_pointer\ +=\ to\_stride;}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \ \ memcpy(copy.\_to\_pointer,\ copy.\_from\_pointer,\ copy.\_num\_bytes);}
\DoxyCodeLine{00572\ \ \ \ \ \ \ \ \ copy.\_to\_pointer\ +=\ to\_stride;}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \ \ memcpy(copy.\_to\_pointer,\ copy.\_from\_pointer,\ copy.\_num\_bytes);}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ copy.\_to\_pointer\ +=\ to\_stride;}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ copy.\_from\_pointer\ +=\ copy.\_from\_stride;}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \ \ \ \ \ \ ++vi;}
\DoxyCodeLine{00579\ \ \ \ \ \}}
\DoxyCodeLine{00580\ }
\DoxyCodeLine{00581\ \ \ \ \ nassertr(vi\ ==\ orig\_verts,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00582\ \ \ \ \ nassertr(new\_data-\/>get\_num\_rows()\ ==\ new\_verts,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00583\ \ \ \}}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \ \ \textcolor{comment}{//\ Determine\ the\ format\ we\ should\ use\ to\ store\ the\ indices.\ \ Don't\ choose}}
\DoxyCodeLine{00586\ \ \ \textcolor{comment}{//\ NT\_uint8,\ as\ Direct3D\ 9\ doesn't\ support\ it.}}
\DoxyCodeLine{00587\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *new\_prim\_format\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00588\ \ \ \textcolor{keywordflow}{if}\ (new\_verts\ <\ 0xffff)\ \{}
\DoxyCodeLine{00589\ \ \ \ \ new\_prim\_format\ =\ \mbox{\hyperlink{classGeomPrimitive_aa8818119d9462988be8fac641255d312}{GeomPrimitive::get\_index\_format}}(GeomEnums::NT\_uint16);}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00592\ \ \ \ \ new\_prim\_format\ =\ \mbox{\hyperlink{classGeomPrimitive_aa8818119d9462988be8fac641255d312}{GeomPrimitive::get\_index\_format}}(GeomEnums::NT\_uint32);}
\DoxyCodeLine{00593\ \ \ \}}
\DoxyCodeLine{00594\ }
\DoxyCodeLine{00595\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ new\_geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(new\_data);}
\DoxyCodeLine{00596\ }
\DoxyCodeLine{00597\ \ \ \textcolor{comment}{//\ Replace\ each\ primitive\ in\ the\ Geom\ (it's\ presumably\ a\ GeomPoints}}
\DoxyCodeLine{00598\ \ \ \textcolor{comment}{//\ primitive,\ although\ it\ might\ be\ some\ other\ kind\ of\ primitive\ if\ we\ got}}
\DoxyCodeLine{00599\ \ \ \textcolor{comment}{//\ here\ because\ RenderModeAttrib::M\_point\ is\ enabled)\ with\ a\ new\ primitive}}
\DoxyCodeLine{00600\ \ \ \textcolor{comment}{//\ that\ replaces\ each\ vertex\ with\ a\ quad\ of\ the\ appropriate\ scale\ and}}
\DoxyCodeLine{00601\ \ \ \textcolor{comment}{//\ orientation.}}
\DoxyCodeLine{00602\ }
\DoxyCodeLine{00603\ \ \ \textcolor{comment}{//\ BUG:\ if\ we're\ rendering\ polygons\ in\ M\_point\ mode\ with\ a\ CullFaceAttrib\ in}}
\DoxyCodeLine{00604\ \ \ \textcolor{comment}{//\ effect,\ we\ won't\ actually\ apply\ the\ CullFaceAttrib\ but\ will\ always\ render}}
\DoxyCodeLine{00605\ \ \ \textcolor{comment}{//\ all\ of\ the\ vertices\ of\ the\ polygons.\ \ This\ is\ certainly\ a\ bug,\ but\ a\ very}}
\DoxyCodeLine{00606\ \ \ \textcolor{comment}{//\ minor\ one;\ and\ in\ order\ to\ fix\ it\ we'd\ have\ to\ do\ the\ face\ culling}}
\DoxyCodeLine{00607\ \ \ \textcolor{comment}{//\ ourselves-\/-\/not\ sure\ if\ it's\ worth\ it.}}
\DoxyCodeLine{00608\ }
\DoxyCodeLine{00609\ \ \ \{}
\DoxyCodeLine{00610\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ t3(\_munge\_sprites\_prims\_pcollector,\ current\_thread);}
\DoxyCodeLine{00611\ \ \ \ \ \mbox{\hyperlink{classGeomPipelineReader}{GeomPipelineReader}}\ geom\_reader(\_geom,\ current\_thread);}
\DoxyCodeLine{00612\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_primitives\ =\ geom\_reader.get\_num\_primitives();}
\DoxyCodeLine{00613\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ pi\ =\ 0;\ pi\ <\ num\_primitives;\ ++pi)\ \{}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomPrimitive}{GeomPrimitive}}\ *primitive\ =\ geom\_reader.get\_primitive(pi);}
\DoxyCodeLine{00615\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (primitive-\/>get\_num\_vertices()\ !=\ 0)\ \{}
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Extract\ out\ the\ list\ of\ vertices\ referenced\ by\ the\ primitive.}}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_vertices\ =\ primitive-\/>get\_num\_vertices();}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ *vertices\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ *)alloca(num\_vertices\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}));}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ *vertices\_end\ =\ vertices\ +\ num\_vertices;}
\DoxyCodeLine{00620\ }
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (primitive-\/>is\_indexed())\ \{}
\DoxyCodeLine{00622\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Indexed\ case.}}
\DoxyCodeLine{00623\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ index(primitive-\/>get\_vertices(),\ 0,\ current\_thread);}
\DoxyCodeLine{00624\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ *vi\ =\ vertices;\ vi\ !=\ vertices\_end;\ ++vi)\ \{}
\DoxyCodeLine{00625\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ v\ =\ index.get\_data1i();}
\DoxyCodeLine{00626\ \ \ \ \ \ \ \ \ \ \ \ \ nassertr(v\ <\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int})orig\_verts,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \ \ \ \ (*vi)\ =\ v;}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Nonindexed\ case.}}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ first\_vertex\ =\ primitive-\/>get\_first\_vertex();}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_vertices;\ ++i)\ \{}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ v\ =\ i\ +\ first\_vertex;}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ nassertr(v\ <\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int})orig\_verts,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \ \ \ \ vertices[i]\ =\ v;}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00638\ }
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ sort\ the\ points\ in\ order\ from\ back-\/to-\/front\ so\ they\ will\ render}}
\DoxyCodeLine{00640\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ properly\ with\ transparency,\ at\ least\ with\ each\ other.}}
\DoxyCodeLine{00641\ \ \ \ \ \ \ \ \ std::sort(vertices,\ vertices\_end,\ SortPoints(points));}
\DoxyCodeLine{00642\ }
\DoxyCodeLine{00643\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Go\ through\ the\ points,\ now\ in\ sorted\ order,\ and\ generate\ a\ pair\ of}}
\DoxyCodeLine{00644\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ triangles\ for\ each\ one.\ \ We\ generate\ indexed\ triangles\ instead\ of}}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ two-\/triangle\ strips,\ since\ this\ seems\ to\ be\ generally\ faster\ on\ PC}}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ hardware\ (otherwise,\ we'd\ have\ to\ nearly\ double\ the\ vertices\ to}}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ stitch\ all\ the\ little\ triangle\ strips\ together).}}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomPrimitive}{GeomPrimitive}})\ new\_primitive\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTriangles}{GeomTriangles}}(Geom::UH\_stream);}
\DoxyCodeLine{00649\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ new\_prim\_verts\ =\ 6\ *\ num\_vertices;\ \ \textcolor{comment}{//\ two\ triangles\ per\ point.}}
\DoxyCodeLine{00650\ }
\DoxyCodeLine{00651\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayData}{GeomVertexArrayData}})\ new\_index}
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ \ \ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayData}{GeomVertexArrayData}}(new\_prim\_format,\ GeomEnums::UH\_stream);}
\DoxyCodeLine{00653\ \ \ \ \ \ \ \ \ new\_index-\/>unclean\_set\_num\_rows(new\_prim\_verts);}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00655\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ index(new\_index,\ 0);}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \ \ nassertr(index.has\_column(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ *vi\ =\ vertices;\ vi\ !=\ vertices\_end;\ ++vi)\ \{}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ new\_vi\ =\ (*vi)\ *\ 4;}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ \ \ nassertr(index.get\_write\_row()\ +\ 6\ <=\ new\_prim\_verts,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi);}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi\ +\ 1);}
\DoxyCodeLine{00662\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi\ +\ 2);}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi\ +\ 2);}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi\ +\ 1);}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \ \ \ \ index.set\_data1i(new\_vi\ +\ 3);}
\DoxyCodeLine{00666\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \ \ new\_primitive-\/>set\_vertices(new\_index,\ new\_prim\_verts);}
\DoxyCodeLine{00668\ }
\DoxyCodeLine{00669\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ min\_vi\ =\ primitive-\/>get\_min\_vertex();}
\DoxyCodeLine{00670\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ max\_vi\ =\ primitive-\/>get\_max\_vertex();}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ new\_primitive-\/>set\_minmax(min\_vi\ *\ 4,\ max\_vi\ *\ 4\ +\ 3,\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00672\ }
\DoxyCodeLine{00673\ \ \ \ \ \ \ \ \ new\_geom-\/>add\_primitive(new\_primitive);}
\DoxyCodeLine{00674\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00675\ \ \ \ \ \}}
\DoxyCodeLine{00676\ \ \ \}}
\DoxyCodeLine{00677\ }
\DoxyCodeLine{00678\ \ \ \_geom\ =\ new\_geom.p();}
\DoxyCodeLine{00679\ \ \ \_munged\_data\ =\ std::move(new\_data);}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00682\ \}}
\DoxyCodeLine{00683\ }
\DoxyCodeLine{00688\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ CullableObject::}
\DoxyCodeLine{00689\ get\_flash\_cpu\_state()\ \{}
\DoxyCodeLine{00690\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ LColor\ flash\_cpu\_color(0.8f,\ 0.2,\ 0.2,\ 1.0f);}
\DoxyCodeLine{00691\ }
\DoxyCodeLine{00692\ \ \ \textcolor{comment}{//\ Once\ someone\ asks\ for\ this\ pointer,\ we\ hold\ its\ reference\ count\ and\ never}}
\DoxyCodeLine{00693\ \ \ \textcolor{comment}{//\ free\ it.}}
\DoxyCodeLine{00694\ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ flash\_cpu\_state\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00695\ \ \ \textcolor{keywordflow}{if}\ (flash\_cpu\_state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00696\ \ \ \ \ flash\_cpu\_state\ =\ RenderState::make}
\DoxyCodeLine{00697\ \ \ \ \ \ \ (LightAttrib::make\_all\_off(),}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ TextureAttrib::make\_off(),}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ ColorAttrib::make\_flat(flash\_cpu\_color));}
\DoxyCodeLine{00700\ \ \ \}}
\DoxyCodeLine{00701\ }
\DoxyCodeLine{00702\ \ \ \textcolor{keywordflow}{return}\ flash\_cpu\_state;}
\DoxyCodeLine{00703\ \}}
\DoxyCodeLine{00704\ }
\DoxyCodeLine{00709\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ CullableObject::}
\DoxyCodeLine{00710\ get\_flash\_hardware\_state()\ \{}
\DoxyCodeLine{00711\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ LColor\ flash\_hardware\_color(0.2,\ 0.2,\ 0.8,\ 1.0);}
\DoxyCodeLine{00712\ }
\DoxyCodeLine{00713\ \ \ \textcolor{comment}{//\ Once\ someone\ asks\ for\ this\ pointer,\ we\ hold\ its\ reference\ count\ and\ never}}
\DoxyCodeLine{00714\ \ \ \textcolor{comment}{//\ free\ it.}}
\DoxyCodeLine{00715\ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ flash\_hardware\_state\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00716\ \ \ \textcolor{keywordflow}{if}\ (flash\_hardware\_state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00717\ \ \ \ \ flash\_hardware\_state\ =\ RenderState::make}
\DoxyCodeLine{00718\ \ \ \ \ \ \ (LightAttrib::make\_all\_off(),}
\DoxyCodeLine{00719\ \ \ \ \ \ \ \ TextureAttrib::make\_off(),}
\DoxyCodeLine{00720\ \ \ \ \ \ \ \ ColorAttrib::make\_flat(flash\_hardware\_color));}
\DoxyCodeLine{00721\ \ \ \}}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00723\ \ \ \textcolor{keywordflow}{return}\ flash\_hardware\_state;}
\DoxyCodeLine{00724\ \}}
\DoxyCodeLine{00725\ }
\DoxyCodeLine{00729\ CullableObject::SourceFormat::}
\DoxyCodeLine{00730\ SourceFormat(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}\ *format,\ \textcolor{keywordtype}{bool}\ sprite\_texcoord)\ :}
\DoxyCodeLine{00731\ \ \ \_format(format),}
\DoxyCodeLine{00732\ \ \ \_sprite\_texcoord(sprite\_texcoord)}
\DoxyCodeLine{00733\ \{}
\DoxyCodeLine{00734\ \ \ \_retransform\_sprites\ =\ retransform\_sprites;}
\DoxyCodeLine{00735\ \}}

\end{DoxyCode}
