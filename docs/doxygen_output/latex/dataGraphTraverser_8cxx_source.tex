\doxysection{data\+Graph\+Traverser.\+cxx}
\hypertarget{dataGraphTraverser_8cxx_source}{}\label{dataGraphTraverser_8cxx_source}\index{panda/src/dgraph/dataGraphTraverser.cxx@{panda/src/dgraph/dataGraphTraverser.cxx}}
\mbox{\hyperlink{dataGraphTraverser_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dataGraphTraverser_8h}{dataGraphTraverser.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dataNode_8h}{dataNode.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__dgraph_8h}{config\_dgraph.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dcast_8h}{dcast.h}}"{}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00024\ \textcolor{keywordtype}{void}\ DataGraphTraverser::CollectedData::}
\DoxyCodeLine{00025\ set\_data(\textcolor{keywordtype}{int}\ parent\_index,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}\ \&data)\ \{}
\DoxyCodeLine{00026\ \ \ \textcolor{keywordflow}{if}\ ((\textcolor{keywordtype}{int})\_data.size()\ <=\ parent\_index)\ \{}
\DoxyCodeLine{00027\ \ \ \ \ \_data.reserve(parent\_index\ +\ 1);}
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keywordflow}{while}\ ((\textcolor{keywordtype}{int})\_data.size()\ <=\ parent\_index)\ \{}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \_data.push\_back(\mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}());}
\DoxyCodeLine{00030\ \ \ \ \ \}}
\DoxyCodeLine{00031\ \ \ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ nassertv(parent\_index\ >=\ 0\ \&\&\ parent\_index\ <\ (\textcolor{keywordtype}{int})\_data.size());}
\DoxyCodeLine{00034\ \ \ \_data[parent\_index]\ =\ data;}
\DoxyCodeLine{00035\ \}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00040\ DataGraphTraverser::}
\DoxyCodeLine{00041\ DataGraphTraverser(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ :\ \_current\_thread(current\_thread)\ \{}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00047\ DataGraphTraverser::}
\DoxyCodeLine{00048\ \string~DataGraphTraverser()\ \{}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ \textcolor{keywordtype}{void}\ DataGraphTraverser::}
\DoxyCodeLine{00055\ traverse(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node)\ \{}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordflow}{if}\ (node-\/>is\_of\_type(DataNode::get\_class\_type()))\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{classDataNode}{DataNode}}\ *data\_node\ =\ DCAST(\mbox{\hyperlink{classDataNode}{DataNode}},\ node);}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{comment}{//\ We\ must\ start\ the\ traversal\ at\ the\ root\ of\ the\ graph.}}
\DoxyCodeLine{00059\ \ \ \ \ nassertv(data\_node-\/>get\_num\_parents(\_current\_thread)\ ==\ 0);}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \ \ r\_transmit(data\_node,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00064\ \ \ \ \ traverse\_below(node,\ \mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}());}
\DoxyCodeLine{00065\ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ collect\_leftovers();}
\DoxyCodeLine{00068\ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00075\ \textcolor{keywordtype}{void}\ DataGraphTraverser::}
\DoxyCodeLine{00076\ traverse\_below(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}\ \&output)\ \{}
\DoxyCodeLine{00077\ \ \ PandaNode::Children\ cr\ =\ node-\/>get\_children(\_current\_thread);}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ cr.get\_num\_children();}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ cr.get\_child(i);}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordflow}{if}\ (child\_node-\/>is\_of\_type(DataNode::get\_class\_type()))\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \mbox{\hyperlink{classDataNode}{DataNode}}\ *data\_node\ =\ DCAST(\mbox{\hyperlink{classDataNode}{DataNode}},\ child\_node);}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ it's\ a\ DataNode-\/type\ child,\ we\ need\ to\ pass\ it\ the\ data.\ \ Maybe\ it}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \textcolor{comment}{//\ has\ only\ one\ parent,\ and\ can\ accept\ the\ data\ immediately.}}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ data\_node-\/>get\_num\_parents(\_current\_thread);}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_parents\ ==\ 1)\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ easy,\ common\ case:\ only\ one\ parent.\ \ We\ make\ our\ output\ into\ a}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ one-\/element\ array\ of\ inputs\ by\ turning\ it\ into\ a\ pointer.}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ r\_transmit(data\_node,\ \&output);}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ A\ more\ difficult\ case:\ multiple\ parents.\ \ We\ must\ collect\ instances}}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ together,\ meaning\ we\ must\ hold\ onto\ this\ node\ until\ we\ have\ reached}}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ it\ through\ all\ paths.}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ CollectedData\ \&collected\_data\ =\ \_multipass\_data[data\_node];}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ data\_node-\/>find\_parent(node,\ \_current\_thread);}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ nassertv(parent\_index\ !=\ -\/1);}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ collected\_data.set\_data(parent\_index,\ output);}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ collected\_data.\_num\_parents++;}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ nassertv(collected\_data.\_num\_parents\ <=\ num\_parents);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (collected\_data.\_num\_parents\ ==\ num\_parents)\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ we've\ got\ all\ the\ data;\ go\ into\ the\ child.}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ r\_transmit(data\_node,\ \&collected\_data.\_data[0]);}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \_multipass\_data.erase(data\_node);}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00108\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ child\ node\ is\ not\ a\ DataNode-\/type\ child.\ \ We\ continue\ the}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \textcolor{comment}{//\ traversal,\ but\ data\ does\ not\ pass\ through\ this\ node,\ and\ instances}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \textcolor{comment}{//\ are\ not\ collected\ together.\ \ (Although\ we\ appear\ to\ be\ passing\ the}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{comment}{//\ data\ through\ here,\ it\ doesn't\ do\ any\ good\ anyway,\ since\ the\ child}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \textcolor{comment}{//\ nodes\ of\ this\ node\ will\ not\ know\ how\ to\ interpret\ the\ data\ from\ a}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{comment}{//\ non-\/DataNode\ parent.)}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ traverse\_below(child\_node,\ output);}
\DoxyCodeLine{00116\ \ \ \ \ \}}
\DoxyCodeLine{00117\ \ \ \}}
\DoxyCodeLine{00118\ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00125\ \textcolor{keywordtype}{void}\ DataGraphTraverser::}
\DoxyCodeLine{00126\ collect\_leftovers()\ \{}
\DoxyCodeLine{00127\ \ \ \textcolor{keywordflow}{while}\ (!\_multipass\_data.empty())\ \{}
\DoxyCodeLine{00128\ \ \ \ \ MultipassData::iterator\ mi\ =\ \_multipass\_data.begin();}
\DoxyCodeLine{00129\ \ \ \ \ \mbox{\hyperlink{classDataNode}{DataNode}}\ *data\_node\ =\ (*mi).first;}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keyword}{const}\ CollectedData\ \&collected\_data\ =\ (*mi).second;}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ dgraph\_cat.warning()}
\DoxyCodeLine{00133\ \ \ \ \ \ \ <<\ *data\_node\ <<\ \textcolor{stringliteral}{"{}\ improperly\ parented\ partly\ outside\ of\ data\ graph.\(\backslash\)n"{}};}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ r\_transmit(data\_node,\ \&collected\_data.\_data[0]);}
\DoxyCodeLine{00136\ \ \ \ \ \_multipass\_data.erase(mi);}
\DoxyCodeLine{00137\ \ \ \}}
\DoxyCodeLine{00138\ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00145\ \textcolor{keywordtype}{void}\ DataGraphTraverser::}
\DoxyCodeLine{00146\ r\_transmit(\mbox{\hyperlink{classDataNode}{DataNode}}\ *data\_node,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}\ inputs[])\ \{}
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{classDataNodeTransmit}{DataNodeTransmit}}\ output;}
\DoxyCodeLine{00148\ \ \ output.reserve(data\_node-\/>get\_num\_outputs());}
\DoxyCodeLine{00149\ \ \ data\_node-\/>\mbox{\hyperlink{classDataNode_ad40cc8b6f609c1a2584cea990525aee7}{transmit\_data}}(\textcolor{keyword}{this},\ inputs,\ output);}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ traverse\_below(data\_node,\ output);}
\DoxyCodeLine{00152\ \}}

\end{DoxyCode}
