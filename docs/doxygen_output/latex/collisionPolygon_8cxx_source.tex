\doxysection{collision\+Polygon.\+cxx}
\hypertarget{collisionPolygon_8cxx_source}{}\label{collisionPolygon_8cxx_source}\index{panda/src/collide/collisionPolygon.cxx@{panda/src/collide/collisionPolygon.cxx}}
\mbox{\hyperlink{collisionPolygon_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionPolygon_8h}{collisionPolygon.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionHandler_8h}{collisionHandler.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionEntry_8h}{collisionEntry.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSphere_8h}{collisionSphere.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionCapsule_8h}{collisionCapsule.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionLine_8h}{collisionLine.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionRay_8h}{collisionRay.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSegment_8h}{collisionSegment.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionParabola_8h}{collisionParabola.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__collide_8h}{config\_collide.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingBox_8h}{boundingBox.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pointerToArray_8h}{pointerToArray.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{transformState_8h}{transformState.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clipPlaneAttrib_8h}{clipPlaneAttrib.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nearly__zero_8h}{nearly\_zero.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTrifans_8h}{geomTrifans.h}}"{}}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomLinestrips_8h}{geomLinestrips.h}}"{}}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{epvector_8h}{epvector.h}}"{}}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00047\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionPolygon::\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionPolygon"{}});}
\DoxyCodeLine{00050\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionPolygon::\_test\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionPolygon"{}});}
\DoxyCodeLine{00051\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CollisionPolygon::\_type\_handle;}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00056\ CollisionPolygon::}
\DoxyCodeLine{00057\ CollisionPolygon(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ \&copy)\ :}
\DoxyCodeLine{00058\ \ \ \mbox{\hyperlink{classCollisionPlane}{CollisionPlane}}(copy),}
\DoxyCodeLine{00059\ \ \ \_points(copy.\_points),}
\DoxyCodeLine{00060\ \ \ \_to\_2d\_mat(copy.\_to\_2d\_mat)}
\DoxyCodeLine{00061\ \{}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00067\ \mbox{\hyperlink{classCollisionSolid}{CollisionSolid}}\ *CollisionPolygon::}
\DoxyCodeLine{00068\ make\_copy()\ \{}
\DoxyCodeLine{00069\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00070\ \}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00077\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionPolygon_a110103e56df1def1daf08ac4b79697c9}{CollisionPolygon::}}}
\DoxyCodeLine{00078\ \mbox{\hyperlink{classCollisionPolygon_a110103e56df1def1daf08ac4b79697c9}{verify\_points}}(\textcolor{keyword}{const}\ LPoint3\ \&a,\ \textcolor{keyword}{const}\ LPoint3\ \&b,\ \textcolor{keyword}{const}\ LPoint3\ \&c)\ \{}
\DoxyCodeLine{00079\ \ \ \textcolor{comment}{//\ First,\ check\ for\ repeated\ or\ invalid\ points.}}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (a.is\_nan()\ ||\ b.is\_nan()\ ||\ c.is\_nan()\ ||\ a\ ==\ b\ ||\ b\ ==\ c\ ||\ a\ ==\ c)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00082\ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \textcolor{comment}{//\ Check\ that\ the\ vectors\ ab\ and\ ac\ are\ not\ colinear.}}
\DoxyCodeLine{00085\ \ \ LVector3\ normal\ =\ ::cross(b\ -\/\ a,\ c\ -\/\ a);}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordflow}{return}\ normal.length\_squared()\ !=\ (PN\_stdfloat)0.0f;}
\DoxyCodeLine{00087\ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00098\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionPolygon_a110103e56df1def1daf08ac4b79697c9}{CollisionPolygon::}}}
\DoxyCodeLine{00099\ \mbox{\hyperlink{classCollisionPolygon_a110103e56df1def1daf08ac4b79697c9}{verify\_points}}(\textcolor{keyword}{const}\ LPoint3\ *begin,\ \textcolor{keyword}{const}\ LPoint3\ *end)\ \{}
\DoxyCodeLine{00100\ \ \ \textcolor{keywordtype}{int}\ num\_points\ =\ end\ -\/\ begin;}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordflow}{if}\ (num\_points\ <\ 3)\ \{}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00103\ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{keywordtype}{bool}\ all\_ok\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \textcolor{comment}{//\ First,\ check\ for\ repeated\ or\ invalid\ points.}}
\DoxyCodeLine{00108\ \ \ \textcolor{keyword}{const}\ LPoint3\ *pi;}
\DoxyCodeLine{00109\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ begin;\ pi\ !=\ end\ \&\&\ all\_ok;\ ++pi)\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*pi).is\_nan())\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \ \ all\_ok\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00112\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ no\ points\ are\ repeated.}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *pj;}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (pj\ =\ begin;\ pj\ !=\ pi\ \&\&\ all\_ok;\ ++pj)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*pj)\ ==\ (*pi))\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ all\_ok\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordflow}{if}\ (all\_ok)\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ plane\ to\ determine\ the\ planarity\ of\ the\ first\ three\ points\ (or}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{//\ the\ first\ two\ points\ and\ the\ nth\ point\ thereafter,\ in\ case\ the\ first}}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{comment}{//\ three\ points\ happen\ to\ be\ collinear).}}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{bool}\ got\_normal\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 2;\ i\ <\ num\_points\ \&\&\ !got\_normal;\ i++)\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \ \ LPlane\ plane(begin[0],\ begin[1],\ begin[i]);}
\DoxyCodeLine{00130\ \ \ \ \ \ \ LVector3\ normal\ =\ plane.get\_normal();}
\DoxyCodeLine{00131\ \ \ \ \ \ \ PN\_stdfloat\ normal\_length\ =\ normal.length();}
\DoxyCodeLine{00132\ \ \ \ \ \ \ got\_normal\ =\ IS\_THRESHOLD\_EQUAL(normal\_length,\ 1.0f,\ 0.001f);}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_normal)\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ all\_ok\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00137\ \ \ \ \ \}}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{return}\ all\_ok;}
\DoxyCodeLine{00141\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00147\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionPolygon_acce7c2cd413d58cc88cd02e570496966}{CollisionPolygon::}}}
\DoxyCodeLine{00148\ \mbox{\hyperlink{classCollisionPolygon_acce7c2cd413d58cc88cd02e570496966}{is\_valid}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{return}\ (\_points.size()\ >=\ 3);}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00156\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionPolygon_a719a2b4cd6169c9bbe45c89fe54167bb}{CollisionPolygon::}}}
\DoxyCodeLine{00157\ \mbox{\hyperlink{classCollisionPolygon_a719a2b4cd6169c9bbe45c89fe54167bb}{is\_concave}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00158\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ It's\ not\ even\ a\ valid\ polygon.}}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00161\ \ \ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ LPoint2\ p0\ =\ \_points[0].\_p;}
\DoxyCodeLine{00164\ \ \ LPoint2\ p1\ =\ \_points[1].\_p;}
\DoxyCodeLine{00165\ \ \ PN\_stdfloat\ dx1\ =\ p1[0]\ -\/\ p0[0];}
\DoxyCodeLine{00166\ \ \ PN\_stdfloat\ dy1\ =\ p1[1]\ -\/\ p0[1];}
\DoxyCodeLine{00167\ \ \ p0\ =\ p1;}
\DoxyCodeLine{00168\ \ \ p1\ =\ \_points[2].\_p;}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ PN\_stdfloat\ dx2\ =\ p1[0]\ -\/\ p0[0];}
\DoxyCodeLine{00171\ \ \ PN\_stdfloat\ dy2\ =\ p1[1]\ -\/\ p0[1];}
\DoxyCodeLine{00172\ \ \ \textcolor{keywordtype}{int}\ asum\ =\ ((dx1\ *\ dy2\ -\/\ dx2\ *\ dy1\ >=\ 0.0f)\ ?\ 1\ :\ 0);}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ \_points.size()\ -\/\ 1;\ i++)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ p0\ =\ p1;}
\DoxyCodeLine{00176\ \ \ \ \ p1\ =\ \_points[(i+3)\ \%\ \_points.size()].\_p;}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \ \ dx1\ =\ dx2;}
\DoxyCodeLine{00179\ \ \ \ \ dy1\ =\ dy2;}
\DoxyCodeLine{00180\ \ \ \ \ dx2\ =\ p1[0]\ -\/\ p0[0];}
\DoxyCodeLine{00181\ \ \ \ \ dy2\ =\ p1[1]\ -\/\ p0[1];}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{keywordtype}{int}\ csum\ =\ ((dx1\ *\ dy2\ -\/\ dx2\ *\ dy1\ >=\ 0.0f)\ ?\ 1\ :\ 0);}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordflow}{if}\ (csum\ \string^\ asum)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \textcolor{comment}{//\ Oops,\ the\ polygon\ is\ concave.}}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00187\ \ \ \ \ \}}
\DoxyCodeLine{00188\ \ \ \}}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ The\ polygon\ is\ safely\ convex.}}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00192\ \}}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00197\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionPolygon_a7a879234861671a0767395e92829db1f}{CollisionPolygon::}}}
\DoxyCodeLine{00198\ \mbox{\hyperlink{classCollisionPolygon_a7a879234861671a0767395e92829db1f}{xform}}(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\ \{}
\DoxyCodeLine{00199\ \ \ \textcolor{comment}{//\ We\ need\ to\ convert\ all\ the\ vertices\ to\ 3-\/d\ for\ this\ operation,\ and\ then}}
\DoxyCodeLine{00200\ \ \ \textcolor{comment}{//\ convert\ them\ back.\ \ Hopefully\ we\ won't\ lose\ too\ much\ precision\ during\ all}}
\DoxyCodeLine{00201\ \ \ \textcolor{comment}{//\ of\ this.}}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_spam())\ \{}
\DoxyCodeLine{00204\ \ \ \ \ collide\_cat.spam()}
\DoxyCodeLine{00205\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}CollisionPolygon\ transformed\ by:\(\backslash\)n"{}};}
\DoxyCodeLine{00206\ \ \ \ \ mat.write(collide\_cat.spam(\textcolor{keyword}{false}),\ 2);}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_points.empty())\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \ \ collide\_cat.spam(\textcolor{keyword}{false})}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ (no\ points)\(\backslash\)n"{}};}
\DoxyCodeLine{00210\ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \textcolor{keywordflow}{if}\ (!\_points.empty())\ \{}
\DoxyCodeLine{00214\ \ \ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00215\ \ \ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \ \ epvector<LPoint3>\ verts;}
\DoxyCodeLine{00218\ \ \ \ \ verts.reserve(\_points.size());}
\DoxyCodeLine{00219\ \ \ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_points.begin();\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ verts.push\_back(to\_3d((*pi).\_p,\ to\_3d\_mat)\ *\ mat);}
\DoxyCodeLine{00222\ \ \ \ \ \}}
\DoxyCodeLine{00223\ }
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *verts\_begin\ =\ \&verts[0];}
\DoxyCodeLine{00225\ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *verts\_end\ =\ verts\_begin\ +\ verts.size();}
\DoxyCodeLine{00226\ \ \ \ \ setup\_points(verts\_begin,\ verts\_end);}
\DoxyCodeLine{00227\ \ \ \}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ CollisionSolid::xform(mat);}
\DoxyCodeLine{00230\ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00237\ LPoint3\ \mbox{\hyperlink{classCollisionPlane_a26bb9a1929893372db0257345f7ea1fd}{CollisionPolygon::}}}
\DoxyCodeLine{00238\ \mbox{\hyperlink{classCollisionPlane_a26bb9a1929893372db0257345f7ea1fd}{get\_collision\_origin}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00239\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00240\ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ LPoint2\ median\ =\ \_points[0].\_p;}
\DoxyCodeLine{00243\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ n\ =\ 1;\ n\ <\ (int)\_points.size();\ n++)\ \{}
\DoxyCodeLine{00244\ \ \ \ \ median\ +=\ \_points[n].\_p;}
\DoxyCodeLine{00245\ \ \ \}}
\DoxyCodeLine{00246\ \ \ median\ /=\ \_points.size();}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \ \ \textcolor{keywordflow}{return}\ to\_3d(median,\ to\_3d\_mat);}
\DoxyCodeLine{00249\ \}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00256\ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ CollisionPolygon::}
\DoxyCodeLine{00257\ get\_viz(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data,}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ bounds\_only)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00259\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ DCAST(\mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}},\ data.\_state-\/>get\_attrib(ClipPlaneAttrib::get\_class\_slot()));}
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (cpa\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ Fortunately,\ the\ polygon\ is\ not\ clipped.\ \ This\ is\ the\ normal,\ easy}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{comment}{//\ case.}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{keywordflow}{return}\ CollisionSolid::get\_viz(trav,\ data,\ bounds\_only);}
\DoxyCodeLine{00264\ \ \ \}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00267\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00268\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}drawing\ polygon\ with\ clip\ plane\ "{}}\ <<\ *cpa\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00269\ \ \ \}}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \textcolor{comment}{//\ The\ polygon\ is\ clipped.\ \ We\ need\ to\ render\ it\ clipped.\ \ We\ could\ just}}
\DoxyCodeLine{00272\ \ \ \textcolor{comment}{//\ turn\ on\ the\ ClipPlaneAttrib\ state\ and\ render\ the\ full\ polygon,\ letting}}
\DoxyCodeLine{00273\ \ \ \textcolor{comment}{//\ the\ hardware\ do\ the\ clipping,\ but\ we\ get\ fancy\ and\ clip\ it\ by\ hand}}
\DoxyCodeLine{00274\ \ \ \textcolor{comment}{//\ instead,\ just\ to\ prove\ that\ our\ clipping\ algorithm\ works\ properly.\ \ This}}
\DoxyCodeLine{00275\ \ \ \textcolor{comment}{//\ does\ require\ some\ more\ dynamic\ work.}}
\DoxyCodeLine{00276\ \ \ Points\ new\_points;}
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ data.get\_net\_transform(trav)))\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane;\ just\ draw\ the\ original\ polygon.}}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordflow}{return}\ CollisionSolid::get\_viz(trav,\ data,\ bounds\_only);}
\DoxyCodeLine{00280\ \ \ \}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \textcolor{keywordflow}{if}\ (new\_points.empty())\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ in\ front\ of\ the\ clip\ plane;\ draw\ nothing.}}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00285\ \ \ \}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \textcolor{comment}{//\ Draw\ the\ clipped\ polygon.}}
\DoxyCodeLine{00288\ \ \ PT(\mbox{\hyperlink{classGeomNode}{GeomNode}})\ viz\_geom\_node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}viz"{}});}
\DoxyCodeLine{00289\ \ \ PT(\mbox{\hyperlink{classGeomNode}{GeomNode}})\ bounds\_viz\_geom\_node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}bounds\_viz"{}});}
\DoxyCodeLine{00290\ \ \ draw\_polygon(viz\_geom\_node,\ bounds\_viz\_geom\_node,\ new\_points);}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \textcolor{keywordflow}{if}\ (bounds\_only)\ \{}
\DoxyCodeLine{00293\ \ \ \ \ \textcolor{keywordflow}{return}\ bounds\_viz\_geom\_node;}
\DoxyCodeLine{00294\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00295\ \ \ \ \ \textcolor{keywordflow}{return}\ viz\_geom\_node;}
\DoxyCodeLine{00296\ \ \ \}}
\DoxyCodeLine{00297\ \}}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00303\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionPolygon_afbc2d1e25548a1835072f5e1f46eff9b}{CollisionPolygon::}}}
\DoxyCodeLine{00304\ \mbox{\hyperlink{classCollisionPolygon_afbc2d1e25548a1835072f5e1f46eff9b}{get\_volume\_pcollector}}()\ \{}
\DoxyCodeLine{00305\ \ \ \textcolor{keywordflow}{return}\ \_volume\_pcollector;}
\DoxyCodeLine{00306\ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00312\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionPolygon_a4288dcda462cf10e4c35aed9109ae882}{CollisionPolygon::}}}
\DoxyCodeLine{00313\ \mbox{\hyperlink{classCollisionPolygon_a4288dcda462cf10e4c35aed9109ae882}{get\_test\_pcollector}}()\ \{}
\DoxyCodeLine{00314\ \ \ \textcolor{keywordflow}{return}\ \_test\_pcollector;}
\DoxyCodeLine{00315\ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00320\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{00321\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00322\ \ \ out\ <<\ \textcolor{stringliteral}{"{}cpolygon,\ ("{}}\ <<\ get\_plane()}
\DoxyCodeLine{00323\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}),\ "{}}\ <<\ \_points.size()\ <<\ \textcolor{stringliteral}{"{}\ vertices"{}};}
\DoxyCodeLine{00324\ \}}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00329\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{00330\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00331\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ (*this)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00332\ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{00333\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_points.begin();\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{00334\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ (*pi).\_p\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00335\ \ \ \}}
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00338\ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00339\ \ \ out\ <<\ \textcolor{stringliteral}{"{}In\ 3-\/d\ space:\(\backslash\)n"{}};}
\DoxyCodeLine{00340\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_points.begin();\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{00341\ \ \ \ \ LVertex\ vert\ =\ to\_3d((*pi).\_p,\ to\_3d\_mat);}
\DoxyCodeLine{00342\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ vert\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00343\ \ \ \}}
\DoxyCodeLine{00344\ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00349\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ CollisionPolygon::}
\DoxyCodeLine{00350\ compute\_internal\_bounds()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00351\ \ \ \textcolor{keywordflow}{if}\ (\_points.empty())\ \{}
\DoxyCodeLine{00352\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}};}
\DoxyCodeLine{00353\ \ \ \}}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00355\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00356\ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ Points::const\_iterator\ pi\ =\ \_points.begin();}
\DoxyCodeLine{00359\ \ \ LPoint3\ p\ =\ to\_3d((*pi).\_p,\ to\_3d\_mat);}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ LPoint3\ x\ =\ p;}
\DoxyCodeLine{00362\ \ \ LPoint3\ n\ =\ p;}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \ \ \textcolor{keywordflow}{for}\ (++pi;\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{00365\ \ \ \ \ p\ =\ to\_3d((*pi).\_p,\ to\_3d\_mat);}
\DoxyCodeLine{00366\ }
\DoxyCodeLine{00367\ \ \ \ \ n.set(min(n[0],\ p[0]),}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ min(n[1],\ p[1]),}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \ \ min(n[2],\ p[2]));}
\DoxyCodeLine{00370\ \ \ \ \ x.set(max(x[0],\ p[0]),}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \ \ max(x[1],\ p[1]),}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \ \ max(x[2],\ p[2]));}
\DoxyCodeLine{00373\ \ \ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}}(n,\ x);}
\DoxyCodeLine{00376\ \}}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00382\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{00383\ test\_intersection\_from\_sphere(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00386\ \ \ \}}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}\ *sphere;}
\DoxyCodeLine{00389\ \ \ DCAST\_INTO\_R(sphere,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_space\ =\ entry.get\_wrt\_space();}
\DoxyCodeLine{00392\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_prev\_space\ =\ entry.get\_wrt\_prev\_space();}
\DoxyCodeLine{00393\ }
\DoxyCodeLine{00394\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ wrt\_space-\/>get\_mat();}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ LPoint3\ orig\_center\ =\ sphere-\/>get\_center()\ *\ wrt\_mat;}
\DoxyCodeLine{00397\ \ \ LPoint3\ from\_center\ =\ orig\_center;}
\DoxyCodeLine{00398\ \ \ \textcolor{keywordtype}{bool}\ moved\_from\_center\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00399\ \ \ PN\_stdfloat\ t\ =\ 1.0f;}
\DoxyCodeLine{00400\ \ \ LPoint3\ contact\_point(from\_center);}
\DoxyCodeLine{00401\ \ \ PN\_stdfloat\ actual\_t\ =\ 1.0f;}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00403\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00404\ \ \ \ \ LVector3(sphere-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00405\ \ \ PN\_stdfloat\ from\_radius\_2\ =\ from\_radius\_v.length\_squared();}
\DoxyCodeLine{00406\ \ \ PN\_stdfloat\ from\_radius\ =\ csqrt(from\_radius\_2);}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \textcolor{keywordflow}{if}\ (wrt\_prev\_space\ !=\ wrt\_space)\ \{}
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ a\ delta\ between\ the\ previous\ position\ and\ the\ current}}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{comment}{//\ position,\ we\ use\ that\ to\ determine\ some\ more\ properties\ of\ the}}
\DoxyCodeLine{00411\ \ \ \ \ \textcolor{comment}{//\ collision.}}
\DoxyCodeLine{00412\ \ \ \ \ LPoint3\ b\ =\ from\_center;}
\DoxyCodeLine{00413\ \ \ \ \ LPoint3\ a\ =\ sphere-\/>get\_center()\ *\ wrt\_prev\_space-\/>get\_mat();}
\DoxyCodeLine{00414\ \ \ \ \ LVector3\ delta\ =\ b\ -\/\ a;}
\DoxyCodeLine{00415\ }
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{comment}{//\ First,\ there\ is\ no\ collision\ if\ the\ "{}from"{}\ object\ is\ definitely\ moving}}
\DoxyCodeLine{00417\ \ \ \ \ \textcolor{comment}{//\ in\ the\ same\ direction\ as\ the\ plane's\ normal.}}
\DoxyCodeLine{00418\ \ \ \ \ PN\_stdfloat\ dot\ =\ delta.dot(get\_normal());}
\DoxyCodeLine{00419\ \ \ \ \ \textcolor{keywordflow}{if}\ (dot\ >\ 0.1f)\ \{}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00421\ \ \ \ \ \}}
\DoxyCodeLine{00422\ }
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(dot))\ \{}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we're\ moving\ parallel\ to\ the\ plane,\ the\ sphere\ is\ tested\ at\ its}}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \textcolor{comment}{//\ final\ point.\ \ Leave\ it\ as\ it\ is.}}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00428\ \textcolor{comment}{/*}}
\DoxyCodeLine{00429\ \textcolor{comment}{\ *\ Otherwise,\ we're\ moving\ into\ the\ plane;\ the\ sphere\ is\ tested\ at\ the\ point}}
\DoxyCodeLine{00430\ \textcolor{comment}{\ *\ along\ its\ path\ that\ is\ closest\ to\ intersecting\ the\ plane.\ \ This\ may\ be\ the}}
\DoxyCodeLine{00431\ \textcolor{comment}{\ *\ actual\ intersection\ point,\ or\ it\ may\ be\ the\ starting\ point\ or\ the\ final}}
\DoxyCodeLine{00432\ \textcolor{comment}{\ *\ point.\ \ dot\ is\ equal\ to\ the\ (negative)\ magnitude\ of\ 'delta'\ along\ the}}
\DoxyCodeLine{00433\ \textcolor{comment}{\ *\ direction\ of\ the\ plane\ normal\ t\ =\ ratio\ of\ (distance\ from\ start\ pos\ to}}
\DoxyCodeLine{00434\ \textcolor{comment}{\ *\ plane)\ to\ (distance\ from\ start\ pos\ to\ end\ pos),\ along\ axis\ of\ plane\ normal}}
\DoxyCodeLine{00435\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00436\ \ \ \ \ \ \ PN\_stdfloat\ dist\_to\_p\ =\ dist\_to\_plane(a);}
\DoxyCodeLine{00437\ \ \ \ \ \ \ t\ =\ (dist\_to\_p\ /\ -\/dot);}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00439\ \ \ \ \ \ \ \textcolor{comment}{//\ also\ compute\ the\ actual\ contact\ point\ and\ time\ of\ contact\ for}}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \textcolor{comment}{//\ handlers\ that\ need\ it}}
\DoxyCodeLine{00441\ \ \ \ \ \ \ actual\_t\ =\ ((dist\_to\_p\ -\/\ from\_radius)\ /\ -\/dot);}
\DoxyCodeLine{00442\ \ \ \ \ \ \ actual\_t\ =\ min((PN\_stdfloat)1.0,\ max((PN\_stdfloat)0.0,\ actual\_t));}
\DoxyCodeLine{00443\ \ \ \ \ \ \ contact\_point\ =\ a\ +\ (actual\_t\ *\ delta);}
\DoxyCodeLine{00444\ }
\DoxyCodeLine{00445\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ >=\ 1.0f)\ \{}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Leave\ it\ where\ it\ is.}}
\DoxyCodeLine{00447\ }
\DoxyCodeLine{00448\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t\ <\ 0.0f)\ \{}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ from\_center\ =\ a;}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ moved\_from\_center\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ from\_center\ =\ a\ +\ t\ *\ delta;}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ moved\_from\_center\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00456\ \ \ \ \ \}}
\DoxyCodeLine{00457\ \ \ \}}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ sphere-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00460\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00461\ \ \ \textcolor{keywordflow}{if}\ (!IS\_THRESHOLD\_EQUAL(normal.length\_squared(),\ 1.0f,\ 0.001))\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_info())\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ collide\_cat.info()}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}polygon\ within\ "{}}\ <<\ entry.get\_into\_node\_path()}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ has\ normal\ "{}}\ <<\ normal\ <<\ \textcolor{stringliteral}{"{}\ of\ length\ "{}}\ <<\ normal.length()}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00467\ \ \ \ \ \}}
\DoxyCodeLine{00468\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00469\ \ \ \}}
\DoxyCodeLine{00470\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00471\ }
\DoxyCodeLine{00472\ \ \ \textcolor{comment}{//\ The\ nearest\ point\ within\ the\ plane\ to\ our\ center\ is\ the\ intersection\ of}}
\DoxyCodeLine{00473\ \ \ \textcolor{comment}{//\ the\ line\ (center,\ center\ -\/\ normal)\ with\ the\ plane.}}
\DoxyCodeLine{00474\ \ \ PN\_stdfloat\ dist;}
\DoxyCodeLine{00475\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(dist,\ from\_center,\ -\/get\_normal()))\ \{}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{comment}{//\ No\ intersection\ with\ plane?\ \ This\ means\ the\ plane's\ effective\ normal}}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{comment}{//\ was\ within\ the\ plane\ itself.\ \ A\ useless\ polygon.}}
\DoxyCodeLine{00478\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00479\ \ \ \}}
\DoxyCodeLine{00480\ }
\DoxyCodeLine{00481\ \ \ \textcolor{keywordflow}{if}\ (dist\ >\ from\_radius\ ||\ dist\ <\ -\/from\_radius)\ \{}
\DoxyCodeLine{00482\ \ \ \ \ \textcolor{comment}{//\ No\ intersection\ with\ the\ plane.}}
\DoxyCodeLine{00483\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00484\ \ \ \}}
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \ \ LPoint2\ p\ =\ to\_2d(from\_center\ -\/\ dist\ *\ get\_normal());}
\DoxyCodeLine{00487\ \ \ LPoint2\ edge\_p;}
\DoxyCodeLine{00488\ \ \ PN\_stdfloat\ edge\_dist\ =\ 0.0f;}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ entry.get\_into\_clip\_planes();}
\DoxyCodeLine{00491\ \ \ \textcolor{keywordflow}{if}\ (cpa\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00492\ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ clip\ plane;\ apply\ it.}}
\DoxyCodeLine{00493\ \ \ \ \ Points\ new\_points;}
\DoxyCodeLine{00494\ \ \ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ entry.get\_into\_node\_path().get\_net\_transform()))\ \{}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane;\ just\ do\ the\ default\ test.}}
\DoxyCodeLine{00496\ \ \ \ \ \ \ edge\_dist\ =\ dist\_to\_polygon(p,\ edge\_p,\ \_points);}
\DoxyCodeLine{00497\ }
\DoxyCodeLine{00498\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (new\_points.empty())\ \{}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ polygon\ is\ completely\ clipped.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00501\ }
\DoxyCodeLine{00502\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \textcolor{comment}{//\ Test\ against\ the\ clipped\ polygon.}}
\DoxyCodeLine{00504\ \ \ \ \ \ \ edge\_dist\ =\ dist\_to\_polygon(p,\ edge\_p,\ new\_points);}
\DoxyCodeLine{00505\ \ \ \ \ \}}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00508\ \ \ \ \ \textcolor{comment}{//\ No\ clip\ plane\ is\ in\ effect.\ \ Do\ the\ default\ test.}}
\DoxyCodeLine{00509\ \ \ \ \ edge\_dist\ =\ dist\_to\_polygon(p,\ edge\_p,\ \_points);}
\DoxyCodeLine{00510\ \ \ \}}
\DoxyCodeLine{00511\ }
\DoxyCodeLine{00512\ \ \ \textcolor{comment}{//\ Now\ we\ have\ edge\_dist,\ which\ is\ the\ distance\ from\ the\ sphere\ center\ to}}
\DoxyCodeLine{00513\ \ \ \textcolor{comment}{//\ the\ nearest\ edge\ of\ the\ polygon,\ within\ the\ polygon's\ plane.}}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\ >\ from\_radius)\ \{}
\DoxyCodeLine{00516\ \ \ \ \ \textcolor{comment}{//\ No\ intersection;\ the\ circle\ is\ outside\ the\ polygon.}}
\DoxyCodeLine{00517\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00518\ \ \ \}}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ \ \ \textcolor{comment}{//\ The\ sphere\ appears\ to\ intersect\ the\ polygon.\ \ If\ the\ edge\ is\ less\ than}}
\DoxyCodeLine{00521\ \ \ \textcolor{comment}{//\ from\_radius\ away,\ the\ sphere\ may\ be\ resting\ on\ an\ edge\ of\ the\ polygon.}}
\DoxyCodeLine{00522\ \ \ \textcolor{comment}{//\ Determine\ how\ far\ the\ center\ of\ the\ sphere\ must\ remain\ from\ the\ plane,}}
\DoxyCodeLine{00523\ \ \ \textcolor{comment}{//\ based\ on\ its\ distance\ from\ the\ nearest\ edge.}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \ \ PN\_stdfloat\ max\_dist\ =\ from\_radius;}
\DoxyCodeLine{00526\ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\ >=\ 0.0f)\ \{}
\DoxyCodeLine{00527\ \ \ \ \ PN\_stdfloat\ max\_dist\_2\ =\ max(from\_radius\_2\ -\/\ edge\_dist\ *\ edge\_dist,\ (PN\_stdfloat)0.0);}
\DoxyCodeLine{00528\ \ \ \ \ max\_dist\ =\ csqrt(max\_dist\_2);}
\DoxyCodeLine{00529\ \ \ \}}
\DoxyCodeLine{00530\ }
\DoxyCodeLine{00531\ \ \ \textcolor{keywordflow}{if}\ (dist\ >\ max\_dist\ ||\ -\/dist\ >\ max\_dist)\ \{}
\DoxyCodeLine{00532\ \ \ \ \ \textcolor{comment}{//\ There's\ no\ intersection:\ the\ sphere\ is\ hanging\ above\ or\ under\ the\ edge.}}
\DoxyCodeLine{00533\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00534\ \ \ \}}
\DoxyCodeLine{00535\ }
\DoxyCodeLine{00536\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00537\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00538\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00539\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00540\ \ \ \}}
\DoxyCodeLine{00541\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00542\ }
\DoxyCodeLine{00543\ \ \ PN\_stdfloat\ into\_depth\ =\ max\_dist\ -\/\ dist;}
\DoxyCodeLine{00544\ \ \ \textcolor{keywordflow}{if}\ (moved\_from\_center)\ \{}
\DoxyCodeLine{00545\ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ base\ the\ depth\ of\ intersection\ on\ the\ sphere's\ final\ resting}}
\DoxyCodeLine{00546\ \ \ \ \ \textcolor{comment}{//\ point,\ not\ the\ point\ from\ which\ we\ tested\ the\ intersection.}}
\DoxyCodeLine{00547\ \ \ \ \ PN\_stdfloat\ orig\_dist;}
\DoxyCodeLine{00548\ \ \ \ \ get\_plane().intersects\_line(orig\_dist,\ orig\_center,\ -\/normal);}
\DoxyCodeLine{00549\ \ \ \ \ into\_depth\ =\ max\_dist\ -\/\ orig\_dist;}
\DoxyCodeLine{00550\ \ \ \}}
\DoxyCodeLine{00551\ }
\DoxyCodeLine{00552\ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\ >=\ 0.0f)\ \{}
\DoxyCodeLine{00553\ \ \ \ \ \textcolor{comment}{//\ If\ colliding\ with\ an\ edge,\ we\ take\ the\ point\ on\ the\ edge.}}
\DoxyCodeLine{00554\ \ \ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00555\ \ \ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00556\ }
\DoxyCodeLine{00557\ \ \ \ \ LPoint3\ surface\_point\ =\ to\_3d(edge\_p,\ to\_3d\_mat);}
\DoxyCodeLine{00558\ \ \ \ \ new\_entry-\/>set\_surface\_point(surface\_point);}
\DoxyCodeLine{00559\ \ \ \ \ new\_entry-\/>set\_interior\_point(surface\_point\ -\/\ normal\ *\ into\_depth);}
\DoxyCodeLine{00560\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00561\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ use\ the\ projection\ of\ the\ center\ onto\ the\ polygon.}}
\DoxyCodeLine{00562\ \ \ \ \ new\_entry-\/>set\_surface\_point(from\_center\ -\/\ normal\ *\ dist);}
\DoxyCodeLine{00563\ \ \ \ \ new\_entry-\/>set\_interior\_point(from\_center\ -\/\ normal\ *\ (dist\ +\ into\_depth));}
\DoxyCodeLine{00564\ \ \ \}}
\DoxyCodeLine{00565\ }
\DoxyCodeLine{00566\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00567\ \ \ new\_entry-\/>set\_contact\_pos(contact\_point);}
\DoxyCodeLine{00568\ \ \ new\_entry-\/>set\_contact\_normal(get\_normal());}
\DoxyCodeLine{00569\ \ \ new\_entry-\/>set\_t(actual\_t);}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00572\ \}}
\DoxyCodeLine{00573\ }
\DoxyCodeLine{00578\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{00579\ test\_intersection\_from\_line(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00580\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00581\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00582\ \ \ \}}
\DoxyCodeLine{00583\ }
\DoxyCodeLine{00584\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionLine}{CollisionLine}}\ *line;}
\DoxyCodeLine{00585\ \ \ DCAST\_INTO\_R(line,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00586\ }
\DoxyCodeLine{00587\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00588\ }
\DoxyCodeLine{00589\ \ \ LPoint3\ from\_origin\ =\ line-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00590\ \ \ LVector3\ from\_direction\ =\ line-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00591\ }
\DoxyCodeLine{00592\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{00593\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(t,\ from\_origin,\ from\_direction))\ \{}
\DoxyCodeLine{00594\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00595\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00596\ \ \ \}}
\DoxyCodeLine{00597\ }
\DoxyCodeLine{00598\ \ \ LPoint3\ plane\_point\ =\ from\_origin\ +\ t\ *\ from\_direction;}
\DoxyCodeLine{00599\ \ \ LPoint2\ p\ =\ to\_2d(plane\_point);}
\DoxyCodeLine{00600\ }
\DoxyCodeLine{00601\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ entry.get\_into\_clip\_planes();}
\DoxyCodeLine{00602\ \ \ \textcolor{keywordflow}{if}\ (cpa\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00603\ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ clip\ plane;\ apply\ it.}}
\DoxyCodeLine{00604\ \ \ \ \ Points\ new\_points;}
\DoxyCodeLine{00605\ \ \ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ entry.get\_into\_node\_path().get\_net\_transform()))\ \{}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane.}}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00610\ }
\DoxyCodeLine{00611\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00615\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ new\_points))\ \{}
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00618\ \ \ \ \ \}}
\DoxyCodeLine{00619\ }
\DoxyCodeLine{00620\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00621\ \ \ \ \ \textcolor{comment}{//\ No\ clip\ plane\ is\ in\ effect.\ \ Do\ the\ default\ test.}}
\DoxyCodeLine{00622\ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00623\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00624\ \ \ \ \ \}}
\DoxyCodeLine{00625\ \ \ \}}
\DoxyCodeLine{00626\ }
\DoxyCodeLine{00627\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00628\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00629\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00630\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00631\ \ \ \}}
\DoxyCodeLine{00632\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00633\ }
\DoxyCodeLine{00634\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ line-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00635\ }
\DoxyCodeLine{00636\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00637\ \ \ new\_entry-\/>set\_surface\_point(plane\_point);}
\DoxyCodeLine{00638\ }
\DoxyCodeLine{00639\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00640\ \}}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00646\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{00647\ test\_intersection\_from\_ray(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00648\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00649\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00650\ \ \ \}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionRay}{CollisionRay}}\ *ray;}
\DoxyCodeLine{00653\ \ \ DCAST\_INTO\_R(ray,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00655\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00656\ }
\DoxyCodeLine{00657\ \ \ LPoint3\ from\_origin\ =\ ray-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00658\ \ \ LVector3\ from\_direction\ =\ ray-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{00661\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(t,\ from\_origin,\ from\_direction))\ \{}
\DoxyCodeLine{00662\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00663\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00664\ \ \ \}}
\DoxyCodeLine{00665\ }
\DoxyCodeLine{00666\ \ \ \textcolor{keywordflow}{if}\ (t\ <\ 0.0f)\ \{}
\DoxyCodeLine{00667\ \ \ \ \ \textcolor{comment}{//\ The\ intersection\ point\ is\ before\ the\ start\ of\ the\ ray.}}
\DoxyCodeLine{00668\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00669\ \ \ \}}
\DoxyCodeLine{00670\ }
\DoxyCodeLine{00671\ \ \ LPoint3\ plane\_point\ =\ from\_origin\ +\ t\ *\ from\_direction;}
\DoxyCodeLine{00672\ \ \ LPoint2\ p\ =\ to\_2d(plane\_point);}
\DoxyCodeLine{00673\ }
\DoxyCodeLine{00674\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ entry.get\_into\_clip\_planes();}
\DoxyCodeLine{00675\ \ \ \textcolor{keywordflow}{if}\ (cpa\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00676\ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ clip\ plane;\ apply\ it.}}
\DoxyCodeLine{00677\ \ \ \ \ Points\ new\_points;}
\DoxyCodeLine{00678\ \ \ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ entry.get\_into\_node\_path().get\_net\_transform()))\ \{}
\DoxyCodeLine{00679\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane.}}
\DoxyCodeLine{00680\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00681\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00682\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00683\ }
\DoxyCodeLine{00684\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00686\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00687\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ new\_points))\ \{}
\DoxyCodeLine{00689\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00690\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00691\ \ \ \ \ \}}
\DoxyCodeLine{00692\ }
\DoxyCodeLine{00693\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00694\ \ \ \ \ \textcolor{comment}{//\ No\ clip\ plane\ is\ in\ effect.\ \ Do\ the\ default\ test.}}
\DoxyCodeLine{00695\ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00696\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00697\ \ \ \ \ \}}
\DoxyCodeLine{00698\ \ \ \}}
\DoxyCodeLine{00699\ }
\DoxyCodeLine{00700\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00701\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00702\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00703\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00704\ \ \ \}}
\DoxyCodeLine{00705\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ ray-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00708\ }
\DoxyCodeLine{00709\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00710\ \ \ new\_entry-\/>set\_surface\_point(plane\_point);}
\DoxyCodeLine{00711\ }
\DoxyCodeLine{00712\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00713\ \}}
\DoxyCodeLine{00714\ }
\DoxyCodeLine{00719\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{00720\ test\_intersection\_from\_segment(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00721\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00722\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00723\ \ \ \}}
\DoxyCodeLine{00724\ }
\DoxyCodeLine{00725\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSegment}{CollisionSegment}}\ *segment;}
\DoxyCodeLine{00726\ \ \ DCAST\_INTO\_R(segment,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00727\ }
\DoxyCodeLine{00728\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00730\ \ \ LPoint3\ from\_a\ =\ segment-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00731\ \ \ LPoint3\ from\_b\ =\ segment-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00732\ \ \ LPoint3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00733\ }
\DoxyCodeLine{00734\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{00735\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(t,\ from\_a,\ from\_direction))\ \{}
\DoxyCodeLine{00736\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00737\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00738\ \ \ \}}
\DoxyCodeLine{00739\ }
\DoxyCodeLine{00740\ \ \ \textcolor{keywordflow}{if}\ (t\ <\ 0.0f\ ||\ t\ >\ 1.0f)\ \{}
\DoxyCodeLine{00741\ \ \ \ \ \textcolor{comment}{//\ The\ intersection\ point\ is\ before\ the\ start\ of\ the\ segment\ or\ after\ the}}
\DoxyCodeLine{00742\ \ \ \ \ \textcolor{comment}{//\ end\ of\ the\ segment.}}
\DoxyCodeLine{00743\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00744\ \ \ \}}
\DoxyCodeLine{00745\ }
\DoxyCodeLine{00746\ \ \ LPoint3\ plane\_point\ =\ from\_a\ +\ t\ *\ from\_direction;}
\DoxyCodeLine{00747\ \ \ LPoint2\ p\ =\ to\_2d(plane\_point);}
\DoxyCodeLine{00748\ }
\DoxyCodeLine{00749\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ entry.get\_into\_clip\_planes();}
\DoxyCodeLine{00750\ \ \ \textcolor{keywordflow}{if}\ (cpa\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00751\ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ clip\ plane;\ apply\ it.}}
\DoxyCodeLine{00752\ \ \ \ \ Points\ new\_points;}
\DoxyCodeLine{00753\ \ \ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ entry.get\_into\_node\_path().get\_net\_transform()))\ \{}
\DoxyCodeLine{00754\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane.}}
\DoxyCodeLine{00755\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00756\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00757\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00758\ }
\DoxyCodeLine{00759\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{00761\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ new\_points))\ \{}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00766\ \ \ \ \ \}}
\DoxyCodeLine{00767\ }
\DoxyCodeLine{00768\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00769\ \ \ \ \ \textcolor{comment}{//\ No\ clip\ plane\ is\ in\ effect.\ \ Do\ the\ default\ test.}}
\DoxyCodeLine{00770\ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00772\ \ \ \ \ \}}
\DoxyCodeLine{00773\ \ \ \}}
\DoxyCodeLine{00774\ }
\DoxyCodeLine{00775\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00776\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00777\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00778\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00779\ \ \ \}}
\DoxyCodeLine{00780\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00781\ }
\DoxyCodeLine{00782\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ segment-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00783\ }
\DoxyCodeLine{00784\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00785\ \ \ new\_entry-\/>set\_surface\_point(plane\_point);}
\DoxyCodeLine{00786\ }
\DoxyCodeLine{00787\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00788\ \}}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00793\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{00794\ test\_intersection\_from\_capsule(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00795\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}\ *capsule;}
\DoxyCodeLine{00796\ \ \ DCAST\_INTO\_R(capsule,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00797\ }
\DoxyCodeLine{00798\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_space\ =\ entry.get\_wrt\_space();}
\DoxyCodeLine{00799\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ wrt\_space-\/>get\_mat();}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00801\ \ \ LPoint3\ from\_a\ =\ capsule-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00802\ \ \ LPoint3\ from\_b\ =\ capsule-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00803\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00804\ \ \ \ \ LVector3(capsule-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00805\ \ \ PN\_stdfloat\ from\_radius\_2\ =\ from\_radius\_v.length\_squared();}
\DoxyCodeLine{00806\ \ \ PN\_stdfloat\ from\_radius\ =\ csqrt(from\_radius\_2);}
\DoxyCodeLine{00807\ }
\DoxyCodeLine{00808\ \ \ PN\_stdfloat\ dist\_a\ =\ get\_plane().dist\_to\_plane(from\_a);}
\DoxyCodeLine{00809\ \ \ PN\_stdfloat\ dist\_b\ =\ get\_plane().dist\_to\_plane(from\_b);}
\DoxyCodeLine{00810\ }
\DoxyCodeLine{00811\ \ \ \textcolor{comment}{//\ Some\ early-\/outs\ (optional)}}
\DoxyCodeLine{00812\ \ \ \textcolor{keywordflow}{if}\ (dist\_a\ >=\ from\_radius\ \&\&\ dist\_b\ >=\ from\_radius)\ \{}
\DoxyCodeLine{00813\ \ \ \ \ \textcolor{comment}{//\ Entirely\ in\ front\ of\ the\ plane\ means\ no\ intersection.}}
\DoxyCodeLine{00814\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00815\ \ \ \}}
\DoxyCodeLine{00816\ }
\DoxyCodeLine{00817\ \ \ \textcolor{keywordflow}{if}\ (dist\_a\ <=\ -\/from\_radius\ \&\&\ dist\_b\ <=\ -\/from\_radius)\ \{}
\DoxyCodeLine{00818\ \ \ \ \ \textcolor{comment}{//\ Entirely\ behind\ the\ plane\ also\ means\ no\ intersection.\ \ But\ perhaps\ the}}
\DoxyCodeLine{00819\ \ \ \ \ \textcolor{comment}{//\ capsule\ travelled\ through\ the\ plane?}}
\DoxyCodeLine{00820\ \ \ \ \ \textcolor{keywordflow}{if}\ (!entry.get\_respect\_prev\_transform())\ \{}
\DoxyCodeLine{00821\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00822\ \ \ \ \ \}}
\DoxyCodeLine{00823\ }
\DoxyCodeLine{00824\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_prev\_space\ =\ entry.get\_wrt\_prev\_space();}
\DoxyCodeLine{00825\ \ \ \ \ \textcolor{keywordflow}{if}\ (wrt\_prev\_space\ ==\ wrt\_space)\ \{}
\DoxyCodeLine{00826\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00827\ \ \ \ \ \}}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{comment}{//\ Note\ that\ we\ only\ check\ for\ a\ sphere\ at\ the\ center,\ since\ we\ don't}}
\DoxyCodeLine{00830\ \ \ \ \ \textcolor{comment}{//\ know\ whether\ the\ capsule\ has\ undergone\ any\ rotation.}}
\DoxyCodeLine{00831\ \ \ \ \ LPoint3\ from\_center\ =\ LPoint3((from\_a\ +\ from\_b)\ *\ 0.5f)\ *\ \_to\_2d\_mat;}
\DoxyCodeLine{00832\ \ \ \ \ LPoint3\ prev\_center\ =}
\DoxyCodeLine{00833\ \ \ \ \ \ \ (LPoint3((capsule-\/>get\_point\_a()\ +\ capsule-\/>get\_point\_b())\ *\ 0.5f)\ *}
\DoxyCodeLine{00834\ \ \ \ \ \ \ \ wrt\_prev\_space-\/>get\_mat())\ *\ \_to\_2d\_mat;}
\DoxyCodeLine{00835\ }
\DoxyCodeLine{00836\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_center[1]\ >\ 0)\ \{}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ center\ didn't\ pass\ through\ the\ polygon.}}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00839\ \ \ \ \ \}}
\DoxyCodeLine{00840\ }
\DoxyCodeLine{00841\ \ \ \ \ \textcolor{comment}{//\ Determine\ the\ intersection\ of\ the\ sphere\ with\ the\ polygon.}}
\DoxyCodeLine{00842\ \ \ \ \ \textcolor{comment}{//\ This\ isn't\ actually\ the\ right\ point\ to\ test\ for\ correct\ edge\ behavior,}}
\DoxyCodeLine{00843\ \ \ \ \ \textcolor{comment}{//\ since\ this\ may\ miss\ the\ sphere\ if\ it\ grazes\ the\ edge\ at\ a\ very\ shallow}}
\DoxyCodeLine{00844\ \ \ \ \ \textcolor{comment}{//\ angle,\ but\ the\ prev-\/transform\ test\ isn't\ intended\ to\ be\ perfect\ anyway.}}
\DoxyCodeLine{00845\ \ \ \ \ PN\_stdfloat\ t\ =\ from\_center[1]\ /\ (from\_center[1]\ -\/\ prev\_center[1]);}
\DoxyCodeLine{00846\ \ \ \ \ LPoint2\ p(}
\DoxyCodeLine{00847\ \ \ \ \ \ \ prev\_center[0]\ *\ t\ +\ from\_center[0]\ *\ (1.0f\ -\/\ t),}
\DoxyCodeLine{00848\ \ \ \ \ \ \ prev\_center[2]\ *\ t\ +\ from\_center[2]\ *\ (1.0f\ -\/\ t));}
\DoxyCodeLine{00849\ \ \ \ \ LPoint2\ edge\_p(p);}
\DoxyCodeLine{00850\ \ \ \ \ PN\_stdfloat\ edge\_dist\ =\ dist\_to\_polygon(p,\ edge\_p,\ \_points);}
\DoxyCodeLine{00851\ \ \ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\ >=\ 0\ \&\&\ edge\_dist\ *\ edge\_dist\ >\ from\_radius\_2)\ \{}
\DoxyCodeLine{00852\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00853\ \ \ \ \ \}}
\DoxyCodeLine{00854\ }
\DoxyCodeLine{00855\ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00856\ \ \ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00858\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00859\ \ \ \ \ \}}
\DoxyCodeLine{00860\ \ \ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00861\ \ \ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ capsule-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00862\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00863\ }
\DoxyCodeLine{00864\ \ \ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00865\ \ \ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00866\ }
\DoxyCodeLine{00867\ \ \ \ \ LPoint3\ deepest\ =\ (dist\_a\ <\ dist\_b\ ?\ from\_a\ :\ from\_b);}
\DoxyCodeLine{00868\ \ \ \ \ new\_entry-\/>set\_surface\_point(to\_3d(edge\_p,\ to\_3d\_mat));}
\DoxyCodeLine{00869\ \ \ \ \ new\_entry-\/>set\_interior\_point(deepest\ -\/\ get\_normal()\ *\ from\_radius);}
\DoxyCodeLine{00870\ }
\DoxyCodeLine{00871\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00872\ \ \ \}}
\DoxyCodeLine{00873\ }
\DoxyCodeLine{00874\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{00875\ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{00876\ }
\DoxyCodeLine{00877\ \ \ \textcolor{comment}{//\ Find\ the\ intersection\ point\ between\ the\ capsule's\ axis\ and\ the\ plane.}}
\DoxyCodeLine{00878\ \ \ LPoint3\ intersect\_3d;}
\DoxyCodeLine{00879\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(intersect\_3d,\ from\_a,\ from\_b))\ \{}
\DoxyCodeLine{00880\ \ \ \ \ \textcolor{comment}{//\ Completely\ parallel.\ \ Take\ an\ arbitrary\ point\ along\ the\ capsule\ axis.}}
\DoxyCodeLine{00881\ \ \ \ \ intersect\_3d\ =\ (from\_a\ +\ from\_b)\ *\ 0.5f;}
\DoxyCodeLine{00882\ \ \ \}}
\DoxyCodeLine{00883\ }
\DoxyCodeLine{00884\ \ \ \textcolor{comment}{//\ Find\ the\ closest\ point\ on\ the\ polygon\ to\ this\ intersection\ point.}}
\DoxyCodeLine{00885\ \ \ LPoint2\ intersect\_2d\ =\ to\_2d(intersect\_3d);}
\DoxyCodeLine{00886\ \ \ LPoint2\ closest\_p\_2d\ =\ intersect\_2d;}
\DoxyCodeLine{00887\ \ \ PN\_stdfloat\ best\_dist\_2\ =\ -\/1;}
\DoxyCodeLine{00888\ }
\DoxyCodeLine{00889\ \ \ \textcolor{keywordtype}{size\_t}\ num\_points\ =\ \_points.size();}
\DoxyCodeLine{00890\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_points;\ ++i)\ \{}
\DoxyCodeLine{00891\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p1\ =\ \_points[i].\_p;}
\DoxyCodeLine{00892\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p2\ =\ \_points[(i\ +\ 1)\ \%\ num\_points].\_p;}
\DoxyCodeLine{00893\ }
\DoxyCodeLine{00894\ \ \ \ \ \textcolor{comment}{//\ Is\ the\ intersection\ outside\ the\ polygon?}}
\DoxyCodeLine{00895\ \ \ \ \ LVector2\ v\ =\ intersect\_2d\ -\/\ p1;}
\DoxyCodeLine{00896\ \ \ \ \ LVector2\ pv\ =\ p2\ -\/\ p1;}
\DoxyCodeLine{00897\ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_right(v,\ pv))\ \{}
\DoxyCodeLine{00898\ \ \ \ \ \ \ PN\_stdfloat\ t\ =\ v.dot(pv)\ /\ pv.length\_squared();}
\DoxyCodeLine{00899\ \ \ \ \ \ \ t\ =\ max(min(t,\ (PN\_stdfloat)1),\ (PN\_stdfloat)0);}
\DoxyCodeLine{00900\ }
\DoxyCodeLine{00901\ \ \ \ \ \ \ LPoint2\ p\ =\ p1\ +\ pv\ *\ t;}
\DoxyCodeLine{00902\ \ \ \ \ \ \ PN\_stdfloat\ d\ =\ (p\ -\/\ intersect\_2d).length\_squared();}
\DoxyCodeLine{00903\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (best\_dist\_2\ <\ 0\ ||\ d\ <\ best\_dist\_2)\ \{}
\DoxyCodeLine{00904\ \ \ \ \ \ \ \ \ closest\_p\_2d\ =\ p;}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \ \ best\_dist\_2\ =\ d;}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00907\ \ \ \ \ \}}
\DoxyCodeLine{00908\ \ \ \}}
\DoxyCodeLine{00909\ }
\DoxyCodeLine{00910\ \ \ LPoint3\ closest\_p\_3d\ =\ to\_3d(closest\_p\_2d,\ to\_3d\_mat);}
\DoxyCodeLine{00911\ }
\DoxyCodeLine{00912\ \ \ \textcolor{comment}{//\ Now\ find\ the\ closest\ point\ on\ the\ capsule\ axis\ to\ this\ point.}}
\DoxyCodeLine{00913\ \ \ LVector3\ from\_v\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00914\ }
\DoxyCodeLine{00915\ \ \ PN\_stdfloat\ t\ =\ (closest\_p\_3d\ -\/\ from\_a).dot(from\_v)\ /\ from\_v.length\_squared();}
\DoxyCodeLine{00916\ \ \ LPoint3\ ref\_point\_3d\ =\ from\_a\ +\ from\_v\ *\ max(min(t,\ (PN\_stdfloat)1),\ (PN\_stdfloat)0);}
\DoxyCodeLine{00917\ }
\DoxyCodeLine{00918\ \ \ \textcolor{comment}{//\ Okay,\ now\ we\ have\ a\ point\ to\ apply\ the\ sphere\ test\ on.}}
\DoxyCodeLine{00919\ }
\DoxyCodeLine{00920\ \ \ \textcolor{comment}{//\ The\ nearest\ point\ within\ the\ plane\ to\ our\ reference\ is\ the\ intersection\ of}}
\DoxyCodeLine{00921\ \ \ \textcolor{comment}{//\ the\ line\ (reference,\ reference\ -\/\ normal)\ with\ the\ plane.}}
\DoxyCodeLine{00922\ \ \ PN\_stdfloat\ dist;}
\DoxyCodeLine{00923\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_line(dist,\ ref\_point\_3d,\ -\/get\_normal()))\ \{}
\DoxyCodeLine{00924\ \ \ \ \ \textcolor{comment}{//\ No\ intersection\ with\ plane?\ \ This\ means\ the\ plane's\ effective\ normal}}
\DoxyCodeLine{00925\ \ \ \ \ \textcolor{comment}{//\ was\ within\ the\ plane\ itself.\ \ A\ useless\ polygon.}}
\DoxyCodeLine{00926\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00927\ \ \ \}}
\DoxyCodeLine{00928\ }
\DoxyCodeLine{00929\ \ \ \textcolor{keywordflow}{if}\ (dist\ >\ from\_radius\ ||\ dist\ <\ -\/from\_radius)\ \{}
\DoxyCodeLine{00930\ \ \ \ \ \textcolor{comment}{//\ No\ intersection\ with\ the\ plane.}}
\DoxyCodeLine{00931\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00932\ \ \ \}}
\DoxyCodeLine{00933\ }
\DoxyCodeLine{00934\ \ \ LPoint2\ ref\_point\_2d\ =\ to\_2d(ref\_point\_3d);}
\DoxyCodeLine{00935\ \ \ LPoint2\ surface\_point\_2d\ =\ ref\_point\_2d;}
\DoxyCodeLine{00936\ \ \ PN\_stdfloat\ edge\_dist\_2\ =\ -\/1;}
\DoxyCodeLine{00937\ }
\DoxyCodeLine{00938\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_points;\ ++i)\ \{}
\DoxyCodeLine{00939\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p1\ =\ \_points[i].\_p;}
\DoxyCodeLine{00940\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p2\ =\ \_points[(i\ +\ 1)\ \%\ num\_points].\_p;}
\DoxyCodeLine{00941\ }
\DoxyCodeLine{00942\ \ \ \ \ \textcolor{comment}{//\ Is\ the\ intersection\ outside\ the\ polygon?}}
\DoxyCodeLine{00943\ \ \ \ \ LVector2\ v\ =\ ref\_point\_2d\ -\/\ p1;}
\DoxyCodeLine{00944\ \ \ \ \ LVector2\ pv\ =\ p2\ -\/\ p1;}
\DoxyCodeLine{00945\ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_right(v,\ pv))\ \{}
\DoxyCodeLine{00946\ \ \ \ \ \ \ PN\_stdfloat\ t\ =\ v.dot(pv)\ /\ pv.length\_squared();}
\DoxyCodeLine{00947\ \ \ \ \ \ \ t\ =\ max(min(t,\ (PN\_stdfloat)1),\ (PN\_stdfloat)0);}
\DoxyCodeLine{00948\ }
\DoxyCodeLine{00949\ \ \ \ \ \ \ LPoint2\ p\ =\ p1\ +\ pv\ *\ t;}
\DoxyCodeLine{00950\ \ \ \ \ \ \ PN\_stdfloat\ d\ =\ (p\ -\/\ ref\_point\_2d).length\_squared();}
\DoxyCodeLine{00951\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\_2\ <\ 0\ ||\ d\ <\ edge\_dist\_2)\ \{}
\DoxyCodeLine{00952\ \ \ \ \ \ \ \ \ surface\_point\_2d\ =\ p;}
\DoxyCodeLine{00953\ \ \ \ \ \ \ \ \ edge\_dist\_2\ =\ d;}
\DoxyCodeLine{00954\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00955\ \ \ \ \ \}}
\DoxyCodeLine{00956\ \ \ \}}
\DoxyCodeLine{00957\ }
\DoxyCodeLine{00958\ \ \ \textcolor{comment}{//\ Now\ we\ have\ edge\_dist\_2,\ which\ is\ the\ square\ of\ the\ distance\ from\ the}}
\DoxyCodeLine{00959\ \ \ \textcolor{comment}{//\ reference\ point\ to\ the\ nearest\ edge\ of\ the\ polygon,\ within\ the\ polygon's}}
\DoxyCodeLine{00960\ \ \ \textcolor{comment}{//\ plane.}}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\_2\ >\ from\_radius\_2)\ \{}
\DoxyCodeLine{00963\ \ \ \ \ \textcolor{comment}{//\ No\ intersection;\ the\ circle\ is\ outside\ the\ polygon.}}
\DoxyCodeLine{00964\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00965\ \ \ \}}
\DoxyCodeLine{00966\ }
\DoxyCodeLine{00967\ \ \ \textcolor{comment}{//\ The\ sphere\ appears\ to\ intersect\ the\ polygon.\ \ If\ the\ edge\ is\ less\ than}}
\DoxyCodeLine{00968\ \ \ \textcolor{comment}{//\ from\_radius\ away,\ the\ sphere\ may\ be\ resting\ on\ an\ edge\ of\ the\ polygon.}}
\DoxyCodeLine{00969\ \ \ \textcolor{comment}{//\ Determine\ how\ far\ the\ center\ of\ the\ sphere\ must\ remain\ from\ the\ plane,}}
\DoxyCodeLine{00970\ \ \ \textcolor{comment}{//\ based\ on\ its\ distance\ from\ the\ nearest\ edge.}}
\DoxyCodeLine{00971\ }
\DoxyCodeLine{00972\ \ \ PN\_stdfloat\ max\_dist\ =\ from\_radius;}
\DoxyCodeLine{00973\ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\_2\ >=\ 0.0f)\ \{}
\DoxyCodeLine{00974\ \ \ \ \ PN\_stdfloat\ max\_dist\_2\ =\ max(from\_radius\_2\ -\/\ edge\_dist\_2,\ (PN\_stdfloat)0.0);}
\DoxyCodeLine{00975\ \ \ \ \ max\_dist\ =\ csqrt(max\_dist\_2);}
\DoxyCodeLine{00976\ \ \ \}}
\DoxyCodeLine{00977\ }
\DoxyCodeLine{00978\ \ \ \textcolor{keywordflow}{if}\ (dist\ >\ max\_dist\ ||\ -\/dist\ >\ max\_dist)\ \{}
\DoxyCodeLine{00979\ \ \ \ \ \textcolor{comment}{//\ There's\ no\ intersection:\ the\ sphere\ is\ hanging\ above\ or\ under\ the\ edge.}}
\DoxyCodeLine{00980\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00981\ \ \ \}}
\DoxyCodeLine{00982\ }
\DoxyCodeLine{00983\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00984\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00985\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00986\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00987\ \ \ \}}
\DoxyCodeLine{00988\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00989\ }
\DoxyCodeLine{00990\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ capsule-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{00991\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00992\ }
\DoxyCodeLine{00993\ \ \ \textcolor{keywordflow}{if}\ ((dist\_a\ <\ 0\ ||\ dist\_b\ <\ 0)\ \&\&\ !IS\_NEARLY\_EQUAL(dist\_a,\ dist\_b))\ \{}
\DoxyCodeLine{00994\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ report\ the\ deepest\ point\ below\ the\ polygon\ as\ the\ interior}}
\DoxyCodeLine{00995\ \ \ \ \ \textcolor{comment}{//\ point\ so\ that\ the\ pusher\ will\ completely\ push\ it\ out.}}
\DoxyCodeLine{00996\ \ \ \ \ LPoint3\ deepest\_3d\ =\ (dist\_a\ <\ dist\_b)\ ?\ from\_a\ :\ from\_b;}
\DoxyCodeLine{00997\ \ \ \ \ LPoint2\ deepest\_2d\ =\ to\_2d(deepest\_3d);}
\DoxyCodeLine{00998\ \ \ \ \ surface\_point\_2d\ =\ deepest\_2d;}
\DoxyCodeLine{00999\ \ \ \ \ PN\_stdfloat\ best\_dist\_2\ =\ -\/1;}
\DoxyCodeLine{01000\ }
\DoxyCodeLine{01001\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_points;\ ++i)\ \{}
\DoxyCodeLine{01002\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p1\ =\ \_points[i].\_p;}
\DoxyCodeLine{01003\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&p2\ =\ \_points[(i\ +\ 1)\ \%\ num\_points].\_p;}
\DoxyCodeLine{01004\ }
\DoxyCodeLine{01005\ \ \ \ \ \ \ \textcolor{comment}{//\ Is\ the\ deepest\ point\ outside\ the\ polygon?}}
\DoxyCodeLine{01006\ \ \ \ \ \ \ LVector2\ v\ =\ deepest\_2d\ -\/\ p1;}
\DoxyCodeLine{01007\ \ \ \ \ \ \ LVector2\ pv\ =\ p2\ -\/\ p1;}
\DoxyCodeLine{01008\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_right(v,\ pv))\ \{}
\DoxyCodeLine{01009\ \ \ \ \ \ \ \ \ PN\_stdfloat\ t\ =\ v.dot(pv)\ /\ pv.length\_squared();}
\DoxyCodeLine{01010\ \ \ \ \ \ \ \ \ t\ =\ max(min(t,\ (PN\_stdfloat)1),\ (PN\_stdfloat)0);}
\DoxyCodeLine{01011\ }
\DoxyCodeLine{01012\ \ \ \ \ \ \ \ \ LPoint2\ p\ =\ p1\ +\ pv\ *\ t;}
\DoxyCodeLine{01013\ \ \ \ \ \ \ \ \ PN\_stdfloat\ d\ =\ (p\ -\/\ deepest\_2d).length\_squared();}
\DoxyCodeLine{01014\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (best\_dist\_2\ <\ 0\ ||\ d\ <\ best\_dist\_2)\ \{}
\DoxyCodeLine{01015\ \ \ \ \ \ \ \ \ \ \ surface\_point\_2d\ =\ p;}
\DoxyCodeLine{01016\ \ \ \ \ \ \ \ \ \ \ best\_dist\_2\ =\ d;}
\DoxyCodeLine{01017\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01018\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01019\ \ \ \ \ \}}
\DoxyCodeLine{01020\ }
\DoxyCodeLine{01021\ \ \ \ \ \textcolor{keywordflow}{if}\ (best\_dist\_2\ <\ 0)\ \{}
\DoxyCodeLine{01022\ \ \ \ \ \ \ \textcolor{comment}{//\ Deepest\ point\ is\ completely\ within\ the\ polygon,\ easy\ case.}}
\DoxyCodeLine{01023\ \ \ \ \ \ \ new\_entry-\/>set\_surface\_point(deepest\_3d\ -\/\ normal\ *\ min(dist\_a,\ dist\_b));}
\DoxyCodeLine{01024\ \ \ \ \ \ \ new\_entry-\/>set\_interior\_point(deepest\_3d\ -\/\ normal\ *\ from\_radius);}
\DoxyCodeLine{01025\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{01026\ \ \ \ \ \}}
\DoxyCodeLine{01027\ \ \ \}}
\DoxyCodeLine{01028\ }
\DoxyCodeLine{01029\ \ \ \textcolor{comment}{//\ Colliding\ with\ an\ edge,\ use\ the\ sphere\ test\ results.}}
\DoxyCodeLine{01030\ \ \ LPoint3\ surface\_point\ =\ to\_3d(surface\_point\_2d,\ to\_3d\_mat);}
\DoxyCodeLine{01031\ \ \ LPoint3\ interior\_point\ =\ ref\_point\_3d\ -\/\ normal\ *\ max\_dist;}
\DoxyCodeLine{01032\ \ \ new\_entry-\/>set\_surface\_point(surface\_point);}
\DoxyCodeLine{01033\ \ \ new\_entry-\/>set\_interior\_point((interior\_point\ -\/\ surface\_point).project(normal)\ +\ surface\_point);}
\DoxyCodeLine{01034\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{01035\ \}}
\DoxyCodeLine{01036\ }
\DoxyCodeLine{01041\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{01042\ test\_intersection\_from\_parabola(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01043\ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{01044\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01045\ \ \ \}}
\DoxyCodeLine{01046\ }
\DoxyCodeLine{01047\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionParabola}{CollisionParabola}}\ *parabola;}
\DoxyCodeLine{01048\ \ \ DCAST\_INTO\_R(parabola,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01049\ }
\DoxyCodeLine{01050\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{01051\ }
\DoxyCodeLine{01052\ \ \ \textcolor{comment}{//\ Convert\ the\ parabola\ into\ local\ coordinate\ space.}}
\DoxyCodeLine{01053\ \ \ LParabola\ local\_p(parabola-\/>get\_parabola());}
\DoxyCodeLine{01054\ \ \ local\_p.xform(wrt\_mat);}
\DoxyCodeLine{01055\ }
\DoxyCodeLine{01056\ \ \ PN\_stdfloat\ t1,\ t2;}
\DoxyCodeLine{01057\ \ \ \textcolor{keywordflow}{if}\ (!get\_plane().intersects\_parabola(t1,\ t2,\ local\_p))\ \{}
\DoxyCodeLine{01058\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{01059\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01060\ \ \ \}}
\DoxyCodeLine{01061\ }
\DoxyCodeLine{01062\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{01063\ \ \ \textcolor{keywordflow}{if}\ (t1\ >=\ parabola-\/>get\_t1()\ \&\&\ t1\ <=\ parabola-\/>get\_t2())\ \{}
\DoxyCodeLine{01064\ \ \ \ \ \textcolor{keywordflow}{if}\ (t2\ >=\ parabola-\/>get\_t1()\ \&\&\ t2\ <=\ parabola-\/>get\_t2())\ \{}
\DoxyCodeLine{01065\ \ \ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ within\ our\ segment\ of\ the\ parabola.}}
\DoxyCodeLine{01066\ \ \ \ \ \ \ \textcolor{comment}{//\ Choose\ the\ first\ of\ the\ two.}}
\DoxyCodeLine{01067\ \ \ \ \ \ \ t\ =\ min(t1,\ t2);}
\DoxyCodeLine{01068\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01069\ \ \ \ \ \ \ \textcolor{comment}{//\ Only\ t1\ is\ within\ our\ segment.}}
\DoxyCodeLine{01070\ \ \ \ \ \ \ t\ =\ t1;}
\DoxyCodeLine{01071\ \ \ \ \ \}}
\DoxyCodeLine{01072\ }
\DoxyCodeLine{01073\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t2\ >=\ parabola-\/>get\_t1()\ \&\&\ t2\ <=\ parabola-\/>get\_t2())\ \{}
\DoxyCodeLine{01074\ \ \ \ \ \textcolor{comment}{//\ Only\ t2\ is\ within\ our\ segment.}}
\DoxyCodeLine{01075\ \ \ \ \ t\ =\ t2;}
\DoxyCodeLine{01076\ }
\DoxyCodeLine{01077\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01078\ \ \ \ \ \textcolor{comment}{//\ Neither\ intersection\ point\ is\ within\ our\ segment.}}
\DoxyCodeLine{01079\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01080\ \ \ \}}
\DoxyCodeLine{01081\ }
\DoxyCodeLine{01082\ \ \ LPoint3\ plane\_point\ =\ local\_p.calc\_point(t);}
\DoxyCodeLine{01083\ \ \ LPoint2\ p\ =\ to\_2d(plane\_point);}
\DoxyCodeLine{01084\ }
\DoxyCodeLine{01085\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa\ =\ entry.get\_into\_clip\_planes();}
\DoxyCodeLine{01086\ \ \ \textcolor{keywordflow}{if}\ (cpa\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01087\ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ clip\ plane;\ apply\ it.}}
\DoxyCodeLine{01088\ \ \ \ \ Points\ new\_points;}
\DoxyCodeLine{01089\ \ \ \ \ \textcolor{keywordflow}{if}\ (apply\_clip\_plane(new\_points,\ cpa,\ entry.get\_into\_node\_path().get\_net\_transform()))\ \{}
\DoxyCodeLine{01090\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ points\ are\ behind\ the\ clip\ plane.}}
\DoxyCodeLine{01091\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{01092\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01093\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01094\ }
\DoxyCodeLine{01095\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01096\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_points.size()\ <\ 3)\ \{}
\DoxyCodeLine{01097\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01098\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01099\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ new\_points))\ \{}
\DoxyCodeLine{01100\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01102\ \ \ \ \ \}}
\DoxyCodeLine{01103\ }
\DoxyCodeLine{01104\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01105\ \ \ \ \ \textcolor{comment}{//\ No\ clip\ plane\ is\ in\ effect.\ \ Do\ the\ default\ test.}}
\DoxyCodeLine{01106\ \ \ \ \ \textcolor{keywordflow}{if}\ (!point\_is\_inside(p,\ \_points))\ \{}
\DoxyCodeLine{01107\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01108\ \ \ \ \ \}}
\DoxyCodeLine{01109\ \ \ \}}
\DoxyCodeLine{01110\ }
\DoxyCodeLine{01111\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{01112\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{01113\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{01114\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01115\ \ \ \}}
\DoxyCodeLine{01116\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{01117\ }
\DoxyCodeLine{01118\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ parabola-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{01119\ }
\DoxyCodeLine{01120\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{01121\ \ \ new\_entry-\/>set\_surface\_point(plane\_point);}
\DoxyCodeLine{01122\ }
\DoxyCodeLine{01123\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{01124\ \}}
\DoxyCodeLine{01125\ }
\DoxyCodeLine{01130\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionPolygon::}
\DoxyCodeLine{01131\ test\_intersection\_from\_box(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01132\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionBox}{CollisionBox}}\ *box;}
\DoxyCodeLine{01133\ \ \ DCAST\_INTO\_R(box,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01134\ }
\DoxyCodeLine{01135\ \ \ \textcolor{comment}{//\ To\ make\ things\ easier,\ transform\ the\ box\ into\ the\ coordinate\ space\ of\ the}}
\DoxyCodeLine{01136\ \ \ \textcolor{comment}{//\ plane.}}
\DoxyCodeLine{01137\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_space\ =\ entry.get\_wrt\_space();}
\DoxyCodeLine{01138\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ wrt\_space-\/>get\_mat();}
\DoxyCodeLine{01139\ \ \ LMatrix4\ plane\_mat\ =\ wrt\_mat\ *\ \_to\_2d\_mat;}
\DoxyCodeLine{01140\ }
\DoxyCodeLine{01141\ \ \ LPoint3\ from\_center\ =\ box-\/>get\_center()\ *\ plane\_mat;}
\DoxyCodeLine{01142\ \ \ LVector3\ from\_extents\ =\ box-\/>get\_dimensions()\ *\ 0.5f;}
\DoxyCodeLine{01143\ }
\DoxyCodeLine{01144\ \ \ \textcolor{comment}{//\ Determine\ the\ basis\ vectors\ describing\ the\ box.}}
\DoxyCodeLine{01145\ \ \ LVecBase3\ box\_x\ =\ plane\_mat.get\_row3(0)\ *\ from\_extents[0];}
\DoxyCodeLine{01146\ \ \ LVecBase3\ box\_y\ =\ plane\_mat.get\_row3(1)\ *\ from\_extents[1];}
\DoxyCodeLine{01147\ \ \ LVecBase3\ box\_z\ =\ plane\_mat.get\_row3(2)\ *\ from\_extents[2];}
\DoxyCodeLine{01148\ }
\DoxyCodeLine{01149\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry;}
\DoxyCodeLine{01150\ }
\DoxyCodeLine{01151\ \ \ \textcolor{comment}{//\ Is\ there\ a\ separating\ axis\ between\ the\ plane\ and\ the\ box?}}
\DoxyCodeLine{01152\ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center[1])\ <=\ cabs(box\_x[1])\ +\ cabs(box\_y[1])\ +\ cabs(box\_z[1]))\ \{}
\DoxyCodeLine{01153\ \ \ \ \ \textcolor{comment}{//\ No,\ there\ isn't.\ \ Now\ do\ the\ same\ test\ for\ each\ of\ the\ box'\ primary\ axes.}}
\DoxyCodeLine{01154\ \ \ \ \ PN\_stdfloat\ r1,\ center,\ r2;}
\DoxyCodeLine{01155\ }
\DoxyCodeLine{01156\ \ \ \ \ r1\ =\ cabs(box\_x.dot(box\_x))\ +\ cabs(box\_y.dot(box\_x))\ +\ cabs(box\_z.dot(box\_x));}
\DoxyCodeLine{01157\ \ \ \ \ project(box\_x,\ center,\ r2);}
\DoxyCodeLine{01158\ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(box\_x)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01159\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01160\ \ \ \ \ \}}
\DoxyCodeLine{01161\ }
\DoxyCodeLine{01162\ \ \ \ \ r1\ =\ cabs(box\_x.dot(box\_y))\ +\ cabs(box\_y.dot(box\_y))\ +\ cabs(box\_z.dot(box\_y));}
\DoxyCodeLine{01163\ \ \ \ \ project(box\_y,\ center,\ r2);}
\DoxyCodeLine{01164\ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(box\_y)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01165\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01166\ \ \ \ \ \}}
\DoxyCodeLine{01167\ }
\DoxyCodeLine{01168\ \ \ \ \ r1\ =\ cabs(box\_x.dot(box\_z))\ +\ cabs(box\_y.dot(box\_z))\ +\ cabs(box\_z.dot(box\_z));}
\DoxyCodeLine{01169\ \ \ \ \ project(box\_z,\ center,\ r2);}
\DoxyCodeLine{01170\ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(box\_z)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01171\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01172\ \ \ \ \ \}}
\DoxyCodeLine{01173\ }
\DoxyCodeLine{01174\ \ \ \ \ \textcolor{comment}{//\ Now\ do\ the\ same\ check\ for\ the\ cross\ products\ between\ the\ box\ axes\ and\ the}}
\DoxyCodeLine{01175\ \ \ \ \ \textcolor{comment}{//\ polygon\ edges.}}
\DoxyCodeLine{01176\ \ \ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{01177\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_points.begin();\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{01178\ \ \ \ \ \ \ \textcolor{keyword}{const}\ PointDef\ \&pd\ =\ *pi;}
\DoxyCodeLine{01179\ \ \ \ \ \ \ LVector3\ axis;}
\DoxyCodeLine{01180\ }
\DoxyCodeLine{01181\ \ \ \ \ \ \ axis.set(-\/box\_x[1]\ *\ pd.\_v[1],}
\DoxyCodeLine{01182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_x[0]\ *\ pd.\_v[1]\ -\/\ box\_x[2]\ *\ pd.\_v[0],}
\DoxyCodeLine{01183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_x[1]\ *\ pd.\_v[0]);}
\DoxyCodeLine{01184\ \ \ \ \ \ \ r1\ =\ cabs(box\_x.dot(axis))\ +\ cabs(box\_y.dot(axis))\ +\ cabs(box\_z.dot(axis));}
\DoxyCodeLine{01185\ \ \ \ \ \ \ project(axis,\ center,\ r2);}
\DoxyCodeLine{01186\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(axis)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01187\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01188\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01189\ }
\DoxyCodeLine{01190\ \ \ \ \ \ \ axis.set(-\/box\_y[1]\ *\ pd.\_v[1],}
\DoxyCodeLine{01191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_y[0]\ *\ pd.\_v[1]\ -\/\ box\_y[2]\ *\ pd.\_v[0],}
\DoxyCodeLine{01192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_y[1]\ *\ pd.\_v[0]);}
\DoxyCodeLine{01193\ \ \ \ \ \ \ r1\ =\ cabs(box\_x.dot(axis))\ +\ cabs(box\_y.dot(axis))\ +\ cabs(box\_z.dot(axis));}
\DoxyCodeLine{01194\ \ \ \ \ \ \ project(axis,\ center,\ r2);}
\DoxyCodeLine{01195\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(axis)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01196\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01197\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01198\ }
\DoxyCodeLine{01199\ \ \ \ \ \ \ axis.set(-\/box\_z[1]\ *\ pd.\_v[1],}
\DoxyCodeLine{01200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_z[0]\ *\ pd.\_v[1]\ -\/\ box\_z[2]\ *\ pd.\_v[0],}
\DoxyCodeLine{01201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ box\_z[1]\ *\ pd.\_v[0]);}
\DoxyCodeLine{01202\ \ \ \ \ \ \ r1\ =\ cabs(box\_x.dot(axis))\ +\ cabs(box\_y.dot(axis))\ +\ cabs(box\_z.dot(axis));}
\DoxyCodeLine{01203\ \ \ \ \ \ \ project(axis,\ center,\ r2);}
\DoxyCodeLine{01204\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cabs(from\_center.dot(axis)\ -\/\ center)\ >\ r1\ +\ r2)\ \{}
\DoxyCodeLine{01205\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01206\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01207\ \ \ \ \ \}}
\DoxyCodeLine{01208\ }
\DoxyCodeLine{01209\ \ \ \ \ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{01210\ \ \ \}}
\DoxyCodeLine{01211\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01212\ \ \ \ \ \textcolor{comment}{//\ There\ is\ a\ separating\ axis.\ \ No\ collision,\ but\ the\ box\ may\ have\ moved}}
\DoxyCodeLine{01213\ \ \ \ \ \textcolor{comment}{//\ through\ the\ polygon\ since\ the\ last\ frame.}}
\DoxyCodeLine{01214\ \ \ \ \ \textcolor{keywordflow}{if}\ (from\_center[1]\ <\ 0.0f\ ||\ !entry.get\_respect\_prev\_transform())\ \{}
\DoxyCodeLine{01215\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01216\ \ \ \ \ \}}
\DoxyCodeLine{01217\ }
\DoxyCodeLine{01218\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_prev\_space\ =\ entry.get\_wrt\_prev\_space();}
\DoxyCodeLine{01219\ \ \ \ \ \textcolor{keywordflow}{if}\ (wrt\_prev\_space\ ==\ wrt\_space)\ \{}
\DoxyCodeLine{01220\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01221\ \ \ \ \ \}}
\DoxyCodeLine{01222\ }
\DoxyCodeLine{01223\ \ \ \ \ \textcolor{comment}{//\ Did\ the\ center\ travel\ into\ the\ plane\ of\ the\ polygon?}}
\DoxyCodeLine{01224\ \ \ \ \ LPoint3\ prev\_center\ =\ box-\/>get\_center()\ *\ (wrt\_prev\_space-\/>get\_mat()\ *\ \_to\_2d\_mat);}
\DoxyCodeLine{01225\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_center[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{01226\ \ \ \ \ \ \ \textcolor{comment}{//\ Nope,\ it\ did\ not.}}
\DoxyCodeLine{01227\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01228\ \ \ \ \ \}}
\DoxyCodeLine{01229\ }
\DoxyCodeLine{01230\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ know\ how\ much\ the\ box\ has\ been\ rotated\ in\ the\ meantime,\ so\ we}}
\DoxyCodeLine{01231\ \ \ \ \ \textcolor{comment}{//\ test\ a\ circle\ that\ we\ know\ fits\ inside\ the\ box,\ positioned\ at\ the\ box}}
\DoxyCodeLine{01232\ \ \ \ \ \textcolor{comment}{//\ center\ as\ it\ was\ going\ through\ the\ plane.}}
\DoxyCodeLine{01233\ \ \ \ \ PN\_stdfloat\ t\ =\ from\_center[1]\ /\ (from\_center[1]\ -\/\ prev\_center[1]);}
\DoxyCodeLine{01234\ \ \ \ \ LPoint2\ p(}
\DoxyCodeLine{01235\ \ \ \ \ \ \ prev\_center[0]\ *\ t\ +\ from\_center[0]\ *\ (1.0f\ -\/\ t),}
\DoxyCodeLine{01236\ \ \ \ \ \ \ prev\_center[2]\ *\ t\ +\ from\_center[2]\ *\ (1.0f\ -\/\ t));}
\DoxyCodeLine{01237\ \ \ \ \ LPoint2\ edge\_p(p);}
\DoxyCodeLine{01238\ \ \ \ \ PN\_stdfloat\ edge\_dist\ =\ dist\_to\_polygon(p,\ edge\_p,\ \_points);}
\DoxyCodeLine{01239\ \ \ \ \ \textcolor{keywordflow}{if}\ (edge\_dist\ >\ from\_extents[0]\ ||}
\DoxyCodeLine{01240\ \ \ \ \ \ \ \ \ edge\_dist\ >\ from\_extents[1]\ ||}
\DoxyCodeLine{01241\ \ \ \ \ \ \ \ \ edge\_dist\ >\ from\_extents[2])\ \{}
\DoxyCodeLine{01242\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01243\ \ \ \ \ \}}
\DoxyCodeLine{01244\ }
\DoxyCodeLine{01245\ \ \ \ \ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{01246\ }
\DoxyCodeLine{01247\ \ \ \ \ \textcolor{comment}{//\ This\ is\ not\ quite\ correct\ but\ close\ enough.}}
\DoxyCodeLine{01248\ \ \ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{01249\ \ \ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{01250\ \ \ \ \ new\_entry-\/>set\_surface\_point(to\_3d(edge\_p,\ to\_3d\_mat));}
\DoxyCodeLine{01251\ \ \ \}}
\DoxyCodeLine{01252\ }
\DoxyCodeLine{01253\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{01254\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{01255\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{01256\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01257\ \ \ \}}
\DoxyCodeLine{01258\ }
\DoxyCodeLine{01259\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ box-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ get\_normal();}
\DoxyCodeLine{01260\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{01261\ }
\DoxyCodeLine{01262\ \ \ \textcolor{comment}{//\ Determine\ which\ point\ on\ the\ cube\ will\ be\ the\ interior\ point.\ \ This\ is}}
\DoxyCodeLine{01263\ \ \ \textcolor{comment}{//\ the\ calculation\ that\ is\ also\ used\ for\ the\ plane,\ which\ is\ not\ perfectly}}
\DoxyCodeLine{01264\ \ \ \textcolor{comment}{//\ applicable,\ but\ I\ suppose\ it's\ better\ than\ nothing.}}
\DoxyCodeLine{01265\ \ \ \textcolor{keyword}{const}\ PN\_stdfloat\ nearly\_zero\ =\ get\_nearly\_zero\_value((PN\_stdfloat)0);}
\DoxyCodeLine{01266\ \ \ LPoint3\ interior\_point\ =\ box-\/>get\_center()\ *\ wrt\_mat\ +}
\DoxyCodeLine{01267\ \ \ \ \ wrt\_mat.get\_row3(0)\ *\ from\_extents[0]\ *\ ((box\_x[1]\ >\ nearly\_zero)\ -\/\ (box\_x[1]\ <\ -\/nearly\_zero))\ +}
\DoxyCodeLine{01268\ \ \ \ \ wrt\_mat.get\_row3(1)\ *\ from\_extents[1]\ *\ ((box\_y[1]\ >\ nearly\_zero)\ -\/\ (box\_y[1]\ <\ -\/nearly\_zero))\ +}
\DoxyCodeLine{01269\ \ \ \ \ wrt\_mat.get\_row3(2)\ *\ from\_extents[2]\ *\ ((box\_z[1]\ >\ nearly\_zero)\ -\/\ (box\_z[1]\ <\ -\/nearly\_zero));}
\DoxyCodeLine{01270\ }
\DoxyCodeLine{01271\ \ \ new\_entry-\/>set\_interior\_point(interior\_point);}
\DoxyCodeLine{01272\ }
\DoxyCodeLine{01273\ \ \ \textcolor{comment}{//\ The\ surface\ point\ is\ the\ interior\ point\ projected\ onto\ the\ plane.}}
\DoxyCodeLine{01274\ \ \ \textcolor{keywordflow}{if}\ (!new\_entry-\/>has\_surface\_point())\ \{}
\DoxyCodeLine{01275\ \ \ \ \ new\_entry-\/>set\_surface\_point(get\_plane().project(interior\_point));}
\DoxyCodeLine{01276\ \ \ \}}
\DoxyCodeLine{01277\ }
\DoxyCodeLine{01278\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{01279\ \}}
\DoxyCodeLine{01280\ }
\DoxyCodeLine{01285\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionPolygon_ac9a7c6284bec590a19f6f39336836bbf}{CollisionPolygon::}}}
\DoxyCodeLine{01286\ \mbox{\hyperlink{classCollisionPolygon_ac9a7c6284bec590a19f6f39336836bbf}{fill\_viz\_geom}}()\ \{}
\DoxyCodeLine{01287\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{01288\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{01289\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Recomputing\ viz\ for\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01290\ \ \ \}}
\DoxyCodeLine{01291\ \ \ nassertv(\_viz\_geom\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_bounds\_viz\_geom\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01292\ \ \ draw\_polygon(\_viz\_geom,\ \_bounds\_viz\_geom,\ \_points);}
\DoxyCodeLine{01293\ \}}
\DoxyCodeLine{01294\ }
\DoxyCodeLine{01303\ PN\_stdfloat\ CollisionPolygon::}
\DoxyCodeLine{01304\ dist\_to\_line\_segment(\textcolor{keyword}{const}\ LPoint2\ \&p,}
\DoxyCodeLine{01305\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&f,\ \textcolor{keyword}{const}\ LPoint2\ \&t,}
\DoxyCodeLine{01306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVector2\ \&v)\ \{}
\DoxyCodeLine{01307\ \ \ LVector2\ v1\ =\ (p\ -\/\ f);}
\DoxyCodeLine{01308\ \ \ PN\_stdfloat\ d\ =\ (v1[0]\ *\ v[1]\ -\/\ v1[1]\ *\ v[0]);}
\DoxyCodeLine{01309\ \ \ \textcolor{keywordflow}{if}\ (d\ <\ 0.0f)\ \{}
\DoxyCodeLine{01310\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01311\ \ \ \}}
\DoxyCodeLine{01312\ }
\DoxyCodeLine{01313\ \ \ \textcolor{comment}{//\ Compute\ the\ nearest\ point\ on\ the\ line.}}
\DoxyCodeLine{01314\ \ \ LPoint2\ q\ =\ p\ +\ LVector2(-\/v[1],\ v[0])\ *\ d;}
\DoxyCodeLine{01315\ }
\DoxyCodeLine{01316\ \ \ \textcolor{comment}{//\ Now\ constrain\ that\ point\ to\ the\ line\ segment.}}
\DoxyCodeLine{01317\ \ \ \textcolor{keywordflow}{if}\ (v[0]\ >\ 0.0f)\ \{}
\DoxyCodeLine{01318\ \ \ \ \ \textcolor{comment}{//\ X+}}
\DoxyCodeLine{01319\ \ \ \ \ \textcolor{keywordflow}{if}\ (v[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{01320\ \ \ \ \ \ \ \textcolor{comment}{//\ Y+}}
\DoxyCodeLine{01321\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (v[0]\ >\ v[1])\ \{}
\DoxyCodeLine{01322\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ X-\/dominant.}}
\DoxyCodeLine{01323\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[0]\ <\ f[0])\ \{}
\DoxyCodeLine{01324\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01325\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[0]\ >\ t[0])\ \{}
\DoxyCodeLine{01326\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01327\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01328\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01329\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01330\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01331\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/dominant.}}
\DoxyCodeLine{01332\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[1]\ <\ f[1])\ \{}
\DoxyCodeLine{01333\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01334\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[1]\ >\ t[1])\ \{}
\DoxyCodeLine{01335\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01336\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01337\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01338\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01339\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01340\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/}}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (v[0]\ >\ -\/v[1])\ \{}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ X-\/dominant.}}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[0]\ <\ f[0])\ \{}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01346\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[0]\ >\ t[0])\ \{}
\DoxyCodeLine{01347\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01348\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01349\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01350\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01351\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01352\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/dominant.}}
\DoxyCodeLine{01353\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[1]\ >\ f[1])\ \{}
\DoxyCodeLine{01354\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01355\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[1]\ <\ t[1])\ \{}
\DoxyCodeLine{01356\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01357\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01358\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01359\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01360\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01361\ \ \ \ \ \}}
\DoxyCodeLine{01362\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01363\ \ \ \ \ \textcolor{comment}{//\ X-\/}}
\DoxyCodeLine{01364\ \ \ \ \ \textcolor{keywordflow}{if}\ (v[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{01365\ \ \ \ \ \ \ \textcolor{comment}{//\ Y+}}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/v[0]\ >\ v[1])\ \{}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ X-\/dominant.}}
\DoxyCodeLine{01368\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[0]\ >\ f[0])\ \{}
\DoxyCodeLine{01369\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[0]\ <\ t[0])\ \{}
\DoxyCodeLine{01371\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01372\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01373\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01374\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01375\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01376\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/dominant.}}
\DoxyCodeLine{01377\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[1]\ <\ f[1])\ \{}
\DoxyCodeLine{01378\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01379\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[1]\ >\ t[1])\ \{}
\DoxyCodeLine{01380\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01381\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01382\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01383\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01384\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01385\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01386\ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/}}
\DoxyCodeLine{01387\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/v[0]\ >\ -\/v[1])\ \{}
\DoxyCodeLine{01388\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ X-\/dominant.}}
\DoxyCodeLine{01389\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[0]\ >\ f[0])\ \{}
\DoxyCodeLine{01390\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01391\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[0]\ <\ t[0])\ \{}
\DoxyCodeLine{01392\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01393\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01394\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01395\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01396\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01397\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Y-\/dominant.}}
\DoxyCodeLine{01398\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (q[1]\ >\ f[1])\ \{}
\DoxyCodeLine{01399\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ f).length();}
\DoxyCodeLine{01400\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{if}\ (q[1]\ <\ t[1])\ \{}
\DoxyCodeLine{01401\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (p\ -\/\ t).length();}
\DoxyCodeLine{01402\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01403\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{01404\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01405\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01406\ \ \ \ \ \}}
\DoxyCodeLine{01407\ \ \ \}}
\DoxyCodeLine{01408\ \}}
\DoxyCodeLine{01409\ }
\DoxyCodeLine{01410\ }
\DoxyCodeLine{01415\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{01416\ compute\_vectors(Points\ \&points)\ \{}
\DoxyCodeLine{01417\ \ \ \textcolor{keywordtype}{size\_t}\ num\_points\ =\ points.size();}
\DoxyCodeLine{01418\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_points;\ i++)\ \{}
\DoxyCodeLine{01419\ \ \ \ \ points[i].\_v\ =\ points[(i\ +\ 1)\ \%\ num\_points].\_p\ -\/\ points[i].\_p;}
\DoxyCodeLine{01420\ \ \ \ \ points[i].\_v.normalize();}
\DoxyCodeLine{01421\ \ \ \}}
\DoxyCodeLine{01422\ \}}
\DoxyCodeLine{01423\ }
\DoxyCodeLine{01428\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{01429\ draw\_polygon(\mbox{\hyperlink{classGeomNode}{GeomNode}}\ *viz\_geom\_node,\ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *bounds\_viz\_geom\_node,}
\DoxyCodeLine{01430\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&points)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01431\ \ \ \textcolor{keywordflow}{if}\ (points.size()\ <\ 3)\ \{}
\DoxyCodeLine{01432\ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{01433\ \ \ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{01434\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}(Degenerate\ poly,\ ignoring.)\(\backslash\)n"{}};}
\DoxyCodeLine{01435\ \ \ \ \ \}}
\DoxyCodeLine{01436\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01437\ \ \ \}}
\DoxyCodeLine{01438\ }
\DoxyCodeLine{01439\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{01440\ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{01441\ }
\DoxyCodeLine{01442\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{01443\ \ \ \ \ (\textcolor{stringliteral}{"{}collision"{}},\ GeomVertexFormat::get\_v3(),}
\DoxyCodeLine{01444\ \ \ \ \ \ Geom::UH\_static);}
\DoxyCodeLine{01445\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{01446\ }
\DoxyCodeLine{01447\ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{01448\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ points.begin();\ pi\ !=\ points.end();\ ++pi)\ \{}
\DoxyCodeLine{01449\ \ \ \ \ vertex.add\_data3(to\_3d((*pi).\_p,\ to\_3d\_mat));}
\DoxyCodeLine{01450\ \ \ \}}
\DoxyCodeLine{01451\ }
\DoxyCodeLine{01452\ \ \ PT(\mbox{\hyperlink{classGeomTrifans}{GeomTrifans}})\ body\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTrifans}{GeomTrifans}}(Geom::UH\_static);}
\DoxyCodeLine{01453\ \ \ body-\/>add\_consecutive\_vertices(0,\ points.size());}
\DoxyCodeLine{01454\ \ \ body-\/>close\_primitive();}
\DoxyCodeLine{01455\ }
\DoxyCodeLine{01456\ \ \ PT(\mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}})\ border\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}}(Geom::UH\_static);}
\DoxyCodeLine{01457\ \ \ border-\/>add\_consecutive\_vertices(0,\ points.size());}
\DoxyCodeLine{01458\ \ \ border-\/>add\_vertex(0);}
\DoxyCodeLine{01459\ \ \ border-\/>close\_primitive();}
\DoxyCodeLine{01460\ }
\DoxyCodeLine{01461\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom1\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{01462\ \ \ geom1-\/>add\_primitive(body);}
\DoxyCodeLine{01463\ }
\DoxyCodeLine{01464\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom2\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{01465\ \ \ geom2-\/>add\_primitive(border);}
\DoxyCodeLine{01466\ }
\DoxyCodeLine{01467\ \ \ viz\_geom\_node-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom1,\ ((\mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ *)\textcolor{keyword}{this})-\/>get\_solid\_viz\_state());}
\DoxyCodeLine{01468\ \ \ viz\_geom\_node-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom2,\ ((\mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ *)\textcolor{keyword}{this})-\/>get\_wireframe\_viz\_state());}
\DoxyCodeLine{01469\ }
\DoxyCodeLine{01470\ \ \ bounds\_viz\_geom\_node-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom1,\ ((\mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ *)\textcolor{keyword}{this})-\/>get\_solid\_bounds\_viz\_state());}
\DoxyCodeLine{01471\ \ \ bounds\_viz\_geom\_node-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom2,\ ((\mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ *)\textcolor{keyword}{this})-\/>get\_wireframe\_bounds\_viz\_state());}
\DoxyCodeLine{01472\ \}}
\DoxyCodeLine{01473\ }
\DoxyCodeLine{01474\ }
\DoxyCodeLine{01479\ \textcolor{keywordtype}{bool}\ CollisionPolygon::}
\DoxyCodeLine{01480\ point\_is\_inside(\textcolor{keyword}{const}\ LPoint2\ \&p,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&points)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01481\ \ \ \textcolor{comment}{//\ We\ insist\ that\ the\ polygon\ be\ convex.\ \ This\ makes\ things\ a\ bit\ simpler.}}
\DoxyCodeLine{01482\ }
\DoxyCodeLine{01483\ \ \ \textcolor{comment}{//\ In\ the\ case\ of\ a\ convex\ polygon,\ defined\ with\ points\ in\ counterclockwise}}
\DoxyCodeLine{01484\ \ \ \textcolor{comment}{//\ order,\ a\ point\ is\ interior\ to\ the\ polygon\ iff\ the\ point\ is\ not\ right\ of}}
\DoxyCodeLine{01485\ \ \ \textcolor{comment}{//\ each\ of\ the\ edges.}}
\DoxyCodeLine{01486\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ (int)points.size()\ -\/\ 1;\ i++)\ \{}
\DoxyCodeLine{01487\ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_right(p\ -\/\ points[i].\_p,\ points[i+1].\_p\ -\/\ points[i].\_p))\ \{}
\DoxyCodeLine{01488\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01489\ \ \ \ \ \}}
\DoxyCodeLine{01490\ \ \ \}}
\DoxyCodeLine{01491\ \ \ \textcolor{keywordflow}{if}\ (is\_right(p\ -\/\ points[points.size()\ -\/\ 1].\_p,}
\DoxyCodeLine{01492\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ points[0].\_p\ -\/\ points[points.size()\ -\/\ 1].\_p))\ \{}
\DoxyCodeLine{01493\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01494\ \ \ \}}
\DoxyCodeLine{01495\ }
\DoxyCodeLine{01496\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01497\ \}}
\DoxyCodeLine{01498\ }
\DoxyCodeLine{01507\ PN\_stdfloat\ CollisionPolygon::}
\DoxyCodeLine{01508\ dist\_to\_polygon(\textcolor{keyword}{const}\ LPoint2\ \&p,\ LPoint2\ \&edge\_p,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&points)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01509\ }
\DoxyCodeLine{01510\ \ \ \textcolor{comment}{//\ We\ know\ that\ that\ the\ polygon\ is\ convex\ and\ is\ defined\ with\ the\ points\ in}}
\DoxyCodeLine{01511\ \ \ \textcolor{comment}{//\ counterclockwise\ order.\ \ Therefore,\ we\ simply\ compare\ the\ signed\ distance}}
\DoxyCodeLine{01512\ \ \ \textcolor{comment}{//\ to\ each\ line\ segment;\ we\ ignore\ any\ negative\ values,\ and\ take\ the\ minimum}}
\DoxyCodeLine{01513\ \ \ \textcolor{comment}{//\ of\ all\ the\ positive\ values.}}
\DoxyCodeLine{01514\ }
\DoxyCodeLine{01515\ \ \ \textcolor{comment}{//\ If\ all\ values\ are\ negative,\ the\ point\ is\ within\ the\ polygon;\ we\ therefore}}
\DoxyCodeLine{01516\ \ \ \textcolor{comment}{//\ return\ an\ arbitrary\ negative\ result.}}
\DoxyCodeLine{01517\ }
\DoxyCodeLine{01518\ \ \ \textcolor{keywordtype}{bool}\ got\_dist\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01519\ \ \ PN\_stdfloat\ best\_dist\ =\ -\/1.0f;}
\DoxyCodeLine{01520\ \ \ \textcolor{keywordtype}{size\_t}\ best\_i;}
\DoxyCodeLine{01521\ }
\DoxyCodeLine{01522\ \ \ \textcolor{keywordtype}{size\_t}\ num\_points\ =\ points.size();}
\DoxyCodeLine{01523\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_points\ -\/\ 1;\ ++i)\ \{}
\DoxyCodeLine{01524\ \ \ \ \ PN\_stdfloat\ d\ =\ dist\_to\_line\_segment(p,\ points[i].\_p,\ points[i\ +\ 1].\_p,}
\DoxyCodeLine{01525\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ points[i].\_v);}
\DoxyCodeLine{01526\ \ \ \ \ \textcolor{keywordflow}{if}\ (d\ >=\ 0.0f)\ \{}
\DoxyCodeLine{01527\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_dist\ ||\ d\ <\ best\_dist)\ \{}
\DoxyCodeLine{01528\ \ \ \ \ \ \ \ \ best\_dist\ =\ d;}
\DoxyCodeLine{01529\ \ \ \ \ \ \ \ \ got\_dist\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01530\ \ \ \ \ \ \ \ \ best\_i\ =\ i;}
\DoxyCodeLine{01531\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01532\ \ \ \ \ \}}
\DoxyCodeLine{01533\ \ \ \}}
\DoxyCodeLine{01534\ }
\DoxyCodeLine{01535\ \ \ PN\_stdfloat\ d\ =\ dist\_to\_line\_segment(p,\ points[num\_points\ -\/\ 1].\_p,\ points[0].\_p,}
\DoxyCodeLine{01536\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ points[num\_points\ -\/\ 1].\_v);}
\DoxyCodeLine{01537\ \ \ \textcolor{keywordflow}{if}\ (d\ >=\ 0.0f)\ \{}
\DoxyCodeLine{01538\ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_dist\ ||\ d\ <\ best\_dist)\ \{}
\DoxyCodeLine{01539\ \ \ \ \ \ \ best\_dist\ =\ d;}
\DoxyCodeLine{01540\ \ \ \ \ \ \ got\_dist\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01541\ \ \ \ \ \ \ best\_i\ =\ num\_points\ -\/\ 1;}
\DoxyCodeLine{01542\ \ \ \ \ \}}
\DoxyCodeLine{01543\ \ \ \}}
\DoxyCodeLine{01544\ }
\DoxyCodeLine{01545\ \ \ \textcolor{keywordflow}{if}\ (got\_dist)\ \{}
\DoxyCodeLine{01546\ \ \ \ \ \textcolor{comment}{//\ Project\ the\ point\ onto\ the\ best\ line,\ so\ that\ we\ can\ confine\ it\ to\ the}}
\DoxyCodeLine{01547\ \ \ \ \ \textcolor{comment}{//\ line\ segment.}}
\DoxyCodeLine{01548\ \ \ \ \ LPoint2\ best\_p\ =\ points[best\_i].\_p;}
\DoxyCodeLine{01549\ \ \ \ \ LPoint2\ next\_p\ =\ points[(best\_i\ +\ 1)\ \%\ points.size()].\_p;}
\DoxyCodeLine{01550\ \ \ \ \ LVector2\ segment\ =\ next\_p\ -\/\ best\_p;}
\DoxyCodeLine{01551\ \ \ \ \ PN\_stdfloat\ t\ =\ (p\ -\/\ best\_p).dot(segment)\ /\ segment.length\_squared();}
\DoxyCodeLine{01552\ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ <=\ 0.0f)\ \{}
\DoxyCodeLine{01553\ \ \ \ \ \ \ edge\_p\ =\ best\_p;}
\DoxyCodeLine{01554\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t\ >=\ 1.0f)\ \{}
\DoxyCodeLine{01555\ \ \ \ \ \ \ edge\_p\ =\ next\_p;}
\DoxyCodeLine{01556\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01557\ \ \ \ \ \ \ LVector2\ v(points[best\_i].\_v[1],\ -\/points[best\_i].\_v[0]);}
\DoxyCodeLine{01558\ \ \ \ \ \ \ edge\_p\ =\ p\ -\/\ v\ *\ best\_dist;}
\DoxyCodeLine{01559\ \ \ \ \ \}}
\DoxyCodeLine{01560\ \ \ \}}
\DoxyCodeLine{01561\ }
\DoxyCodeLine{01562\ \ \ \textcolor{keywordflow}{return}\ best\_dist;}
\DoxyCodeLine{01563\ \}}
\DoxyCodeLine{01564\ }
\DoxyCodeLine{01569\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{01570\ project(\textcolor{keyword}{const}\ LVector3\ \&axis,\ PN\_stdfloat\ \&center,\ PN\_stdfloat\ \&extent)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01571\ \ \ PN\_stdfloat\ begin,\ end;}
\DoxyCodeLine{01572\ }
\DoxyCodeLine{01573\ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{01574\ \ \ pi\ =\ \_points.begin();}
\DoxyCodeLine{01575\ }
\DoxyCodeLine{01576\ \ \ \textcolor{keyword}{const}\ LPoint2\ \&point\ =\ (*pi).\_p;}
\DoxyCodeLine{01577\ \ \ begin\ =\ point[0]\ *\ axis[0]\ +\ point[1]\ *\ axis[2];}
\DoxyCodeLine{01578\ \ \ end\ =\ begin;}
\DoxyCodeLine{01579\ }
\DoxyCodeLine{01580\ \ \ \textcolor{keywordflow}{for}\ (;\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{01581\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&point\ =\ (*pi).\_p;}
\DoxyCodeLine{01582\ }
\DoxyCodeLine{01583\ \ \ \ \ PN\_stdfloat\ t\ =\ point[0]\ *\ axis[0]\ +\ point[1]\ *\ axis[2];}
\DoxyCodeLine{01584\ \ \ \ \ begin\ =\ min(begin,\ t);}
\DoxyCodeLine{01585\ \ \ \ \ end\ =\ max(end,\ t);}
\DoxyCodeLine{01586\ \ \ \}}
\DoxyCodeLine{01587\ }
\DoxyCodeLine{01588\ \ \ center\ =\ (end\ +\ begin)\ *\ 0.5f;}
\DoxyCodeLine{01589\ \ \ extent\ =\ cabs((end\ -\/\ begin)\ *\ 0.5f);}
\DoxyCodeLine{01590\ \}}
\DoxyCodeLine{01591\ }
\DoxyCodeLine{01595\ \textcolor{keywordtype}{void}\ CollisionPolygon::}
\DoxyCodeLine{01596\ setup\_points(\textcolor{keyword}{const}\ LPoint3\ *begin,\ \textcolor{keyword}{const}\ LPoint3\ *end)\ \{}
\DoxyCodeLine{01597\ \ \ \textcolor{keywordtype}{int}\ num\_points\ =\ end\ -\/\ begin;}
\DoxyCodeLine{01598\ \ \ nassertv(num\_points\ >=\ 3);}
\DoxyCodeLine{01599\ }
\DoxyCodeLine{01600\ \ \ \_points.clear();}
\DoxyCodeLine{01601\ }
\DoxyCodeLine{01602\ \ \ \textcolor{comment}{//\ Tell\ the\ base\ CollisionPlane\ class\ what\ its\ plane\ will\ be.\ \ To\ do\ this,}}
\DoxyCodeLine{01603\ \ \ \textcolor{comment}{//\ we\ must\ first\ compute\ the\ polygon\ normal.}}
\DoxyCodeLine{01604\ \ \ LVector3\ normal\ =\ LVector3::zero();}
\DoxyCodeLine{01605\ }
\DoxyCodeLine{01606\ \ \ \textcolor{comment}{//\ Project\ the\ polygon\ into\ each\ of\ the\ three\ major\ planes\ and\ calculate\ the}}
\DoxyCodeLine{01607\ \ \ \textcolor{comment}{//\ area\ of\ each\ 2-\/d\ projection.\ \ This\ becomes\ the\ polygon\ normal.\ \ This}}
\DoxyCodeLine{01608\ \ \ \textcolor{comment}{//\ works\ because\ the\ ratio\ between\ these\ different\ areas\ corresponds\ to\ the}}
\DoxyCodeLine{01609\ \ \ \textcolor{comment}{//\ angle\ at\ which\ the\ polygon\ is\ tilted\ toward\ each\ plane.}}
\DoxyCodeLine{01610\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_points;\ i++)\ \{}
\DoxyCodeLine{01611\ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&p0\ =\ begin[i];}
\DoxyCodeLine{01612\ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&p1\ =\ begin[(i\ +\ 1)\ \%\ num\_points];}
\DoxyCodeLine{01613\ \ \ \ \ normal[0]\ +=\ p0[1]\ *\ p1[2]\ -\/\ p0[2]\ *\ p1[1];}
\DoxyCodeLine{01614\ \ \ \ \ normal[1]\ +=\ p0[2]\ *\ p1[0]\ -\/\ p0[0]\ *\ p1[2];}
\DoxyCodeLine{01615\ \ \ \ \ normal[2]\ +=\ p0[0]\ *\ p1[1]\ -\/\ p0[1]\ *\ p1[0];}
\DoxyCodeLine{01616\ \ \ \}}
\DoxyCodeLine{01617\ }
\DoxyCodeLine{01618\ \ \ \textcolor{keywordflow}{if}\ (normal.length\_squared()\ ==\ 0.0f)\ \{}
\DoxyCodeLine{01619\ \ \ \ \ \textcolor{comment}{//\ The\ polygon\ has\ no\ area.}}
\DoxyCodeLine{01620\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01621\ \ \ \}}
\DoxyCodeLine{01622\ }
\DoxyCodeLine{01623\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{01624\ \ \ \textcolor{comment}{//\ Make\ sure\ all\ the\ source\ points\ are\ good.}}
\DoxyCodeLine{01625\ \ \ \{}
\DoxyCodeLine{01626\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionPolygon_a110103e56df1def1daf08ac4b79697c9}{verify\_points}}(begin,\ end))\ \{}
\DoxyCodeLine{01627\ \ \ \ \ \ \ collide\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Invalid\ points\ in\ CollisionPolygon:\(\backslash\)n"{}};}
\DoxyCodeLine{01628\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *pi;}
\DoxyCodeLine{01629\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ begin;\ pi\ !=\ end;\ ++pi)\ \{}
\DoxyCodeLine{01630\ \ \ \ \ \ \ \ \ collide\_cat.error(\textcolor{keyword}{false})\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ (*pi)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01631\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01632\ \ \ \ \ \ \ collide\_cat.error(\textcolor{keyword}{false})}
\DoxyCodeLine{01633\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ normal\ "{}}\ <<\ normal\ <<\ \textcolor{stringliteral}{"{}\ with\ length\ "{}}\ <<\ normal.length()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01634\ }
\DoxyCodeLine{01635\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01636\ \ \ \ \ \}}
\DoxyCodeLine{01637\ \ \ \}}
\DoxyCodeLine{01638\ }
\DoxyCodeLine{01639\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_spam())\ \{}
\DoxyCodeLine{01640\ \ \ \ \ collide\_cat.spam()}
\DoxyCodeLine{01641\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}CollisionPolygon\ defined\ with\ "{}}\ <<\ num\_points\ <<\ \textcolor{stringliteral}{"{}\ vertices:\(\backslash\)n"{}};}
\DoxyCodeLine{01642\ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *pi;}
\DoxyCodeLine{01643\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ begin;\ pi\ !=\ end;\ ++pi)\ \{}
\DoxyCodeLine{01644\ \ \ \ \ \ \ collide\_cat.spam(\textcolor{keyword}{false})\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ (*pi)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01645\ \ \ \ \ \}}
\DoxyCodeLine{01646\ \ \ \}}
\DoxyCodeLine{01647\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01648\ }
\DoxyCodeLine{01649\ \ \ set\_plane(LPlane(normal,\ begin[0]));}
\DoxyCodeLine{01650\ }
\DoxyCodeLine{01651\ \ \ \textcolor{comment}{//\ Construct\ a\ matrix\ that\ rotates\ the\ points\ from\ the\ (X,0,Z)\ plane\ into}}
\DoxyCodeLine{01652\ \ \ \textcolor{comment}{//\ the\ 3-\/d\ plane.}}
\DoxyCodeLine{01653\ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{01654\ \ \ calc\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{01655\ }
\DoxyCodeLine{01656\ \ \ \textcolor{comment}{//\ And\ the\ inverse\ matrix\ rotates\ points\ from\ 3-\/d\ space\ into\ the\ 2-\/d\ plane.}}
\DoxyCodeLine{01657\ \ \ \_to\_2d\_mat.invert\_from(to\_3d\_mat);}
\DoxyCodeLine{01658\ }
\DoxyCodeLine{01659\ \ \ \textcolor{comment}{//\ Now\ project\ all\ of\ the\ points\ onto\ the\ 2-\/d\ plane.}}
\DoxyCodeLine{01660\ }
\DoxyCodeLine{01661\ \ \ \textcolor{keyword}{const}\ LPoint3\ *pi;}
\DoxyCodeLine{01662\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ begin;\ pi\ !=\ end;\ ++pi)\ \{}
\DoxyCodeLine{01663\ \ \ \ \ LPoint3\ point\ =\ (*pi)\ *\ \_to\_2d\_mat;}
\DoxyCodeLine{01664\ \ \ \ \ \_points.push\_back(PointDef(point[0],\ point[2]));}
\DoxyCodeLine{01665\ \ \ \}}
\DoxyCodeLine{01666\ }
\DoxyCodeLine{01667\ \ \ nassertv(\_points.size()\ >=\ 3);}
\DoxyCodeLine{01668\ }
\DoxyCodeLine{01669\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{01670\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{01671\ \textcolor{comment}{\ \ //\ Now\ make\ sure\ the\ points\ define\ a\ convex\ polygon.}}
\DoxyCodeLine{01672\ \textcolor{comment}{\ \ if\ (is\_concave())\ \{}}
\DoxyCodeLine{01673\ \textcolor{comment}{\ \ \ \ collide\_cat.error()\ <<\ "{}Invalid\ concave\ CollisionPolygon\ defined:\(\backslash\)n"{};}}
\DoxyCodeLine{01674\ \textcolor{comment}{\ \ \ \ const\ LPoint3\ *pi;}}
\DoxyCodeLine{01675\ \textcolor{comment}{\ \ \ \ for\ (pi\ =\ begin;\ pi\ !=\ end;\ ++pi)\ \{}}
\DoxyCodeLine{01676\ \textcolor{comment}{\ \ \ \ \ \ collide\_cat.error(false)\ <<\ "{}\ \ "{}\ <<\ (*pi)\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{01677\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{01678\ \textcolor{comment}{\ \ \ \ collide\_cat.error(false)}}
\DoxyCodeLine{01679\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{}\ \ normal\ "{}\ <<\ normal\ <<\ "{}\ with\ length\ "{}\ <<\ normal.length()\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{01680\ \textcolor{comment}{\ \ \ \ \_points.clear();}}
\DoxyCodeLine{01681\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{01682\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{01683\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01684\ }
\DoxyCodeLine{01685\ \ \ compute\_vectors(\_points);}
\DoxyCodeLine{01686\ \}}
\DoxyCodeLine{01687\ }
\DoxyCodeLine{01696\ \textcolor{keywordtype}{bool}\ CollisionPolygon::}
\DoxyCodeLine{01697\ clip\_polygon(\mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&new\_points,}
\DoxyCodeLine{01698\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&source\_points,}
\DoxyCodeLine{01699\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPlane\ \&plane)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01700\ \ \ new\_points.clear();}
\DoxyCodeLine{01701\ \ \ \textcolor{keywordflow}{if}\ (source\_points.empty())\ \{}
\DoxyCodeLine{01702\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01703\ \ \ \}}
\DoxyCodeLine{01704\ }
\DoxyCodeLine{01705\ \ \ LPoint3\ from3d;}
\DoxyCodeLine{01706\ \ \ LVector3\ delta3d;}
\DoxyCodeLine{01707\ \ \ \textcolor{keywordflow}{if}\ (!plane.intersects\_plane(from3d,\ delta3d,\ get\_plane()))\ \{}
\DoxyCodeLine{01708\ \ \ \ \ \textcolor{comment}{//\ The\ clipping\ plane\ is\ parallel\ to\ the\ polygon.\ \ The\ polygon\ is\ either}}
\DoxyCodeLine{01709\ \ \ \ \ \textcolor{comment}{//\ all\ in\ or\ all\ out.}}
\DoxyCodeLine{01710\ \ \ \ \ \textcolor{keywordflow}{if}\ (plane.dist\_to\_plane(get\_plane().get\_point())\ <\ 0.0)\ \{}
\DoxyCodeLine{01711\ \ \ \ \ \ \ \textcolor{comment}{//\ A\ point\ within\ the\ polygon\ is\ behind\ the\ clipping\ plane:\ the\ polygon}}
\DoxyCodeLine{01712\ \ \ \ \ \ \ \textcolor{comment}{//\ is\ all\ in.}}
\DoxyCodeLine{01713\ \ \ \ \ \ \ new\_points\ =\ source\_points;}
\DoxyCodeLine{01714\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01715\ \ \ \ \ \}}
\DoxyCodeLine{01716\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01717\ \ \ \}}
\DoxyCodeLine{01718\ }
\DoxyCodeLine{01719\ \ \ \textcolor{comment}{//\ Project\ the\ line\ of\ intersection\ into\ the\ 2-\/d\ plane.\ \ Now\ we\ have\ a\ 2-\/d}}
\DoxyCodeLine{01720\ \ \ \textcolor{comment}{//\ clipping\ line.}}
\DoxyCodeLine{01721\ \ \ LPoint2\ from2d\ =\ to\_2d(from3d);}
\DoxyCodeLine{01722\ \ \ LVector2\ delta2d\ =\ to\_2d(delta3d);}
\DoxyCodeLine{01723\ }
\DoxyCodeLine{01724\ \ \ PN\_stdfloat\ a\ =\ -\/delta2d[1];}
\DoxyCodeLine{01725\ \ \ PN\_stdfloat\ b\ =\ delta2d[0];}
\DoxyCodeLine{01726\ \ \ PN\_stdfloat\ c\ =\ from2d[0]\ *\ delta2d[1]\ -\/\ from2d[1]\ *\ delta2d[0];}
\DoxyCodeLine{01727\ }
\DoxyCodeLine{01728\ \ \ \textcolor{comment}{//\ Now\ walk\ through\ the\ points.\ \ Any\ point\ on\ the\ left\ of\ our\ line\ gets}}
\DoxyCodeLine{01729\ \ \ \textcolor{comment}{//\ removed,\ and\ the\ line\ segment\ clipped\ at\ the\ point\ of\ intersection.}}
\DoxyCodeLine{01730\ }
\DoxyCodeLine{01731\ \ \ \textcolor{comment}{//\ We\ might\ increase\ the\ number\ of\ vertices\ by\ as\ many\ as\ 1,\ if\ the\ plane}}
\DoxyCodeLine{01732\ \ \ \textcolor{comment}{//\ clips\ off\ exactly\ one\ corner.\ \ (We\ might\ also\ decrease\ the\ number\ of}}
\DoxyCodeLine{01733\ \ \ \textcolor{comment}{//\ vertices,\ or\ keep\ them\ the\ same\ number.)}}
\DoxyCodeLine{01734\ \ \ new\_points.reserve(source\_points.size()\ +\ 1);}
\DoxyCodeLine{01735\ }
\DoxyCodeLine{01736\ \ \ LPoint2\ last\_point\ =\ source\_points.back().\_p;}
\DoxyCodeLine{01737\ \ \ \textcolor{keywordtype}{bool}\ last\_is\_in\ =\ !is\_right(last\_point\ -\/\ from2d,\ delta2d);}
\DoxyCodeLine{01738\ \ \ \textcolor{keywordtype}{bool}\ all\_in\ =\ last\_is\_in;}
\DoxyCodeLine{01739\ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{01740\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ source\_points.begin();\ pi\ !=\ source\_points.end();\ ++pi)\ \{}
\DoxyCodeLine{01741\ \ \ \ \ \textcolor{keyword}{const}\ LPoint2\ \&this\_point\ =\ (*pi).\_p;}
\DoxyCodeLine{01742\ \ \ \ \ \textcolor{keywordtype}{bool}\ this\_is\_in\ =\ !is\_right(this\_point\ -\/\ from2d,\ delta2d);}
\DoxyCodeLine{01743\ }
\DoxyCodeLine{01744\ \ \ \ \ \textcolor{comment}{//\ There\ appears\ to\ be\ a\ compiler\ bug\ in\ gcc\ 4.0:\ we\ need\ to\ extract\ this}}
\DoxyCodeLine{01745\ \ \ \ \ \textcolor{comment}{//\ comparison\ outside\ of\ the\ if\ statement.}}
\DoxyCodeLine{01746\ \ \ \ \ \textcolor{keywordtype}{bool}\ crossed\_over\ =\ (this\_is\_in\ !=\ last\_is\_in);}
\DoxyCodeLine{01747\ \ \ \ \ \textcolor{keywordflow}{if}\ (crossed\_over)\ \{}
\DoxyCodeLine{01748\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ just\ crossed\ over\ the\ clipping\ line.\ \ Find\ the\ point\ of}}
\DoxyCodeLine{01749\ \ \ \ \ \ \ \textcolor{comment}{//\ intersection.}}
\DoxyCodeLine{01750\ \ \ \ \ \ \ LVector2\ d\ =\ this\_point\ -\/\ last\_point;}
\DoxyCodeLine{01751\ \ \ \ \ \ \ PN\_stdfloat\ denom\ =\ (a\ *\ d[0]\ +\ b\ *\ d[1]);}
\DoxyCodeLine{01752\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (denom\ !=\ 0.0)\ \{}
\DoxyCodeLine{01753\ \ \ \ \ \ \ \ \ PN\_stdfloat\ t\ =\ -\/(a\ *\ last\_point[0]\ +\ b\ *\ last\_point[1]\ +\ c)\ /\ denom;}
\DoxyCodeLine{01754\ \ \ \ \ \ \ \ \ LPoint2\ p\ =\ last\_point\ +\ t\ *\ d;}
\DoxyCodeLine{01755\ }
\DoxyCodeLine{01756\ \ \ \ \ \ \ \ \ new\_points.push\_back(PointDef(p[0],\ p[1]));}
\DoxyCodeLine{01757\ \ \ \ \ \ \ \ \ last\_is\_in\ =\ this\_is\_in;}
\DoxyCodeLine{01758\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01759\ \ \ \ \ \}}
\DoxyCodeLine{01760\ }
\DoxyCodeLine{01761\ \ \ \ \ \textcolor{keywordflow}{if}\ (this\_is\_in)\ \{}
\DoxyCodeLine{01762\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ are\ behind\ the\ clipping\ line.\ \ Keep\ the\ point.}}
\DoxyCodeLine{01763\ \ \ \ \ \ \ new\_points.push\_back(PointDef(this\_point[0],\ this\_point[1]));}
\DoxyCodeLine{01764\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01765\ \ \ \ \ \ \ all\_in\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01766\ \ \ \ \ \}}
\DoxyCodeLine{01767\ }
\DoxyCodeLine{01768\ \ \ \ \ last\_point\ =\ this\_point;}
\DoxyCodeLine{01769\ \ \ \}}
\DoxyCodeLine{01770\ }
\DoxyCodeLine{01771\ \ \ \textcolor{keywordflow}{return}\ all\_in;}
\DoxyCodeLine{01772\ \}}
\DoxyCodeLine{01773\ }
\DoxyCodeLine{01781\ \textcolor{keywordtype}{bool}\ CollisionPolygon::}
\DoxyCodeLine{01782\ apply\_clip\_plane(\mbox{\hyperlink{classpvector}{CollisionPolygon::Points}}\ \&new\_points,}
\DoxyCodeLine{01783\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *cpa,}
\DoxyCodeLine{01784\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *net\_transform)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01785\ \ \ \textcolor{keywordtype}{bool}\ all\_in\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01786\ }
\DoxyCodeLine{01787\ \ \ \textcolor{keywordtype}{int}\ num\_planes\ =\ cpa-\/>get\_num\_on\_planes();}
\DoxyCodeLine{01788\ \ \ \textcolor{keywordtype}{bool}\ first\_plane\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01789\ }
\DoxyCodeLine{01790\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_planes;\ i++)\ \{}
\DoxyCodeLine{01791\ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ plane\_path\ =\ cpa-\/>get\_on\_plane(i);}
\DoxyCodeLine{01792\ \ \ \ \ \mbox{\hyperlink{classPlaneNode}{PlaneNode}}\ *plane\_node\ =\ DCAST(\mbox{\hyperlink{classPlaneNode}{PlaneNode}},\ plane\_path.node());}
\DoxyCodeLine{01793\ \ \ \ \ \textcolor{keywordflow}{if}\ ((plane\_node-\/>get\_clip\_effect()\ \&\ PlaneNode::CE\_collision)\ !=\ 0)\ \{}
\DoxyCodeLine{01794\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ new\_transform\ =}
\DoxyCodeLine{01795\ \ \ \ \ \ \ \ \ net\_transform-\/>invert\_compose(plane\_path.get\_net\_transform());}
\DoxyCodeLine{01796\ }
\DoxyCodeLine{01797\ \ \ \ \ \ \ LPlane\ plane\ =\ plane\_node-\/>get\_plane()\ *\ new\_transform-\/>get\_mat();}
\DoxyCodeLine{01798\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_plane)\ \{}
\DoxyCodeLine{01799\ \ \ \ \ \ \ \ \ first\_plane\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01800\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!clip\_polygon(new\_points,\ \_points,\ plane))\ \{}
\DoxyCodeLine{01801\ \ \ \ \ \ \ \ \ \ \ all\_in\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01802\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01803\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01804\ \ \ \ \ \ \ \ \ Points\ last\_points;}
\DoxyCodeLine{01805\ \ \ \ \ \ \ \ \ last\_points.swap(new\_points);}
\DoxyCodeLine{01806\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!clip\_polygon(new\_points,\ last\_points,\ plane))\ \{}
\DoxyCodeLine{01807\ \ \ \ \ \ \ \ \ \ \ all\_in\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01808\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01809\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01810\ \ \ \ \ \}}
\DoxyCodeLine{01811\ \ \ \}}
\DoxyCodeLine{01812\ }
\DoxyCodeLine{01813\ \ \ \textcolor{keywordflow}{if}\ (!all\_in)\ \{}
\DoxyCodeLine{01814\ \ \ \ \ compute\_vectors(new\_points);}
\DoxyCodeLine{01815\ \ \ \}}
\DoxyCodeLine{01816\ }
\DoxyCodeLine{01817\ \ \ \textcolor{keywordflow}{return}\ all\_in;}
\DoxyCodeLine{01818\ \}}
\DoxyCodeLine{01819\ }
\DoxyCodeLine{01824\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionPolygon_a3aa0cad78ad07e397e70d7e3a673e1e9}{CollisionPolygon::}}}
\DoxyCodeLine{01825\ \mbox{\hyperlink{classCollisionPolygon_a3aa0cad78ad07e397e70d7e3a673e1e9}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&me)\ \{}
\DoxyCodeLine{01826\ \ \ \mbox{\hyperlink{classCollisionPlane_a7b6ea9211bb77eb978189449fd16b83a}{CollisionPlane::write\_datagram}}(manager,\ me);}
\DoxyCodeLine{01827\ \ \ me.add\_uint16(\_points.size());}
\DoxyCodeLine{01828\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ \_points.size();\ i++)\ \{}
\DoxyCodeLine{01829\ \ \ \ \ \_points[i].\_p.write\_datagram(me);}
\DoxyCodeLine{01830\ \ \ \ \ \_points[i].\_v.write\_datagram(me);}
\DoxyCodeLine{01831\ \ \ \}}
\DoxyCodeLine{01832\ \ \ \_to\_2d\_mat.write\_datagram(me);}
\DoxyCodeLine{01833\ \}}
\DoxyCodeLine{01834\ }
\DoxyCodeLine{01840\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionPolygon_a619f1a8ff00ef42c711cc4dc875fe0b8}{CollisionPolygon::}}}
\DoxyCodeLine{01841\ \mbox{\hyperlink{classCollisionPolygon_a619f1a8ff00ef42c711cc4dc875fe0b8}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01842\ \ \ \mbox{\hyperlink{classCollisionPlane_a5a9be948bf1aa142f8d0096eafef0fb0}{CollisionPlane::fillin}}(scan,\ manager);}
\DoxyCodeLine{01843\ }
\DoxyCodeLine{01844\ \ \ \textcolor{keywordtype}{size\_t}\ size\ =\ scan.get\_uint16();}
\DoxyCodeLine{01845\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ size;\ i++)\ \{}
\DoxyCodeLine{01846\ \ \ \ \ LPoint2\ p;}
\DoxyCodeLine{01847\ \ \ \ \ LVector2\ v;}
\DoxyCodeLine{01848\ \ \ \ \ p.read\_datagram(scan);}
\DoxyCodeLine{01849\ \ \ \ \ v.read\_datagram(scan);}
\DoxyCodeLine{01850\ \ \ \ \ \_points.push\_back(PointDef(p,\ v));}
\DoxyCodeLine{01851\ \ \ \}}
\DoxyCodeLine{01852\ \ \ \_to\_2d\_mat.read\_datagram(scan);}
\DoxyCodeLine{01853\ }
\DoxyCodeLine{01854\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ <\ 13)\ \{}
\DoxyCodeLine{01855\ \ \ \ \ \textcolor{comment}{//\ Before\ bam\ version\ 6.13,\ we\ were\ inadvertently\ storing\ CollisionPolygon}}
\DoxyCodeLine{01856\ \ \ \ \ \textcolor{comment}{//\ vertices\ clockwise,\ instead\ of\ counter-\/clockwise.\ \ Correct\ that\ by\ re-\/}}
\DoxyCodeLine{01857\ \ \ \ \ \textcolor{comment}{//\ projecting.}}
\DoxyCodeLine{01858\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_points.size()\ >=\ 3)\ \{}
\DoxyCodeLine{01859\ \ \ \ \ \ \ LMatrix4\ to\_3d\_mat;}
\DoxyCodeLine{01860\ \ \ \ \ \ \ rederive\_to\_3d\_mat(to\_3d\_mat);}
\DoxyCodeLine{01861\ }
\DoxyCodeLine{01862\ \ \ \ \ \ \ epvector<LPoint3>\ verts;}
\DoxyCodeLine{01863\ \ \ \ \ \ \ verts.reserve(\_points.size());}
\DoxyCodeLine{01864\ \ \ \ \ \ \ Points::const\_iterator\ pi;}
\DoxyCodeLine{01865\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_points.begin();\ pi\ !=\ \_points.end();\ ++pi)\ \{}
\DoxyCodeLine{01866\ \ \ \ \ \ \ \ \ verts.push\_back(to\_3d((*pi).\_p,\ to\_3d\_mat));}
\DoxyCodeLine{01867\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01868\ }
\DoxyCodeLine{01869\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *verts\_begin\ =\ \&verts[0];}
\DoxyCodeLine{01870\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ *verts\_end\ =\ verts\_begin\ +\ verts.size();}
\DoxyCodeLine{01871\ \ \ \ \ \ \ setup\_points(verts\_begin,\ verts\_end);}
\DoxyCodeLine{01872\ \ \ \ \ \}}
\DoxyCodeLine{01873\ \ \ \}}
\DoxyCodeLine{01874\ \}}
\DoxyCodeLine{01875\ }
\DoxyCodeLine{01876\ }
\DoxyCodeLine{01880\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classCollisionPolygon_ad4b35d4d2ba7081dbe292469d9cfa4ee}{CollisionPolygon::}}}
\DoxyCodeLine{01881\ \mbox{\hyperlink{classCollisionPolygon_ad4b35d4d2ba7081dbe292469d9cfa4ee}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{01882\ \ \ \mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}}\ *me\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionPolygon}{CollisionPolygon}};}
\DoxyCodeLine{01883\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{01884\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{01885\ }
\DoxyCodeLine{01886\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{01887\ \ \ me-\/>\mbox{\hyperlink{classCollisionPolygon_a619f1a8ff00ef42c711cc4dc875fe0b8}{fillin}}(scan,\ manager);}
\DoxyCodeLine{01888\ \ \ \textcolor{keywordflow}{return}\ me;}
\DoxyCodeLine{01889\ \}}
\DoxyCodeLine{01890\ }
\DoxyCodeLine{01894\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionPolygon_a62b160aef98b486ea50de44d4e5def39}{CollisionPolygon::}}}
\DoxyCodeLine{01895\ \mbox{\hyperlink{classCollisionPolygon_a62b160aef98b486ea50de44d4e5def39}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{01896\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classCollisionPolygon_ad4b35d4d2ba7081dbe292469d9cfa4ee}{make\_from\_bam}});}
\DoxyCodeLine{01897\ \}}

\end{DoxyCode}
