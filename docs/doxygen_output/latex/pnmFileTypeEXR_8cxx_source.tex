\doxysection{pnm\+File\+Type\+EXR.\+cxx}
\hypertarget{pnmFileTypeEXR_8cxx_source}{}\label{pnmFileTypeEXR_8cxx_source}\index{panda/src/pnmimagetypes/pnmFileTypeEXR.cxx@{panda/src/pnmimagetypes/pnmFileTypeEXR.cxx}}
\mbox{\hyperlink{pnmFileTypeEXR_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeEXR_8h}{pnmFileTypeEXR.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ HAVE\_OPENEXR}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pnmimagetypes_8h}{config\_pnmimagetypes.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeRegistry_8h}{pnmFileTypeRegistry.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pfmFile_8h}{pfmFile.h}}"{}}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <ImfOutputFile.h>}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <ImfChannelList.h>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ <ImfVersion.h>}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ <ImfIO.h>}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ <ImfFrameBuffer.h>}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ <ImfHeader.h>}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ <ImathBox.h>}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#ifndef\ IMATH\_NAMESPACE}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#define\ IMATH\_NAMESPACE\ Imath}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00038\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00039\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PNMFileTypeEXR::\_type\_handle;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\ \textcolor{keyword}{const}\ extensions\_exr[]\ =\ \{}
\DoxyCodeLine{00044\ \ \ \textcolor{stringliteral}{"{}exr"{}}}
\DoxyCodeLine{00045\ \};}
\DoxyCodeLine{00046\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_extensions\_exr\ =\ \textcolor{keyword}{sizeof}(extensions\_exr)\ /\ \textcolor{keyword}{sizeof}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *);}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{comment}{//\ A\ wrapper\ class\ to\ map\ OpenEXR's\ OStream\ class\ onto\ std::ostream.}}
\DoxyCodeLine{00049\ \textcolor{keyword}{class\ }ImfStdOstream\ :\ \textcolor{keyword}{public}\ IMF::OStream\ \{}
\DoxyCodeLine{00050\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00051\ \ \ ImfStdOstream(std::ostream\ \&strm)\ :\ IMF::OStream(\textcolor{stringliteral}{"{}ostream"{}}),\ \_strm(strm)\ \{\}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ write(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ c[\textcolor{comment}{/*n*/}],\ \textcolor{keywordtype}{int}\ n)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \_strm.write(c,\ n);}
\DoxyCodeLine{00055\ \ \ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#if\ OPENEXR\_VERSION\_MAJOR\ >=\ 3}}
\DoxyCodeLine{00058\ \ \ \textcolor{keyword}{virtual}\ uint64\_t\ tellp()\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordflow}{return}\ \_strm.tellp();}
\DoxyCodeLine{00060\ \ \ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ seekp(uint64\_t\ pos)\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \_strm.seekp(pos);}
\DoxyCodeLine{00064\ \ \ \}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00066\ \ \ \textcolor{keyword}{virtual}\ IMF::Int64\ tellp()\ \{}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordflow}{return}\ \_strm.tellp();}
\DoxyCodeLine{00068\ \ \ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ seekp(IMF::Int64\ pos)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \_strm.seekp(pos);}
\DoxyCodeLine{00072\ \ \ \}}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00076\ \ \ std::ostream\ \&\_strm;}
\DoxyCodeLine{00077\ \};}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{comment}{//\ A\ wrapper\ class\ to\ map\ OpenEXR's\ IStream\ class\ onto\ std::istream.}}
\DoxyCodeLine{00080\ \textcolor{keyword}{class\ }ImfStdIstream\ :\ \textcolor{keyword}{public}\ IMF::IStream\ \{}
\DoxyCodeLine{00081\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00082\ \ \ ImfStdIstream(std::istream\ \&strm,\ \textcolor{keyword}{const}\ std::string\ \&magic\_number)\ :\ IMF::IStream(\textcolor{stringliteral}{"{}istream"{}}),\ \_strm(strm)\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ Start\ by\ putting\ back\ the\ magic\ number.}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{for}\ (std::string::const\_reverse\_iterator\ mi\ =\ magic\_number.rbegin();}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ mi\ !=\ magic\_number.rend();}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ mi++)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \_strm.putback(*mi);}
\DoxyCodeLine{00088\ \ \ \ \ \}}
\DoxyCodeLine{00089\ \ \ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ isMemoryMapped\ ()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00093\ \ \ \}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ read\ (\textcolor{keywordtype}{char}\ c[\textcolor{comment}{/*n*/}],\ \textcolor{keywordtype}{int}\ n)\ \{}
\DoxyCodeLine{00096\ \ \ \ \ \_strm.read(c,\ n);}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_strm.gcount()\ !=\ n)\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::exception();}
\DoxyCodeLine{00099\ \ \ \ \ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordtype}{bool}\ not\_eof\ =\ !\_strm.eof();}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordflow}{return}\ not\_eof;}
\DoxyCodeLine{00103\ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \textcolor{preprocessor}{\#if\ OPENEXR\_VERSION\_MAJOR\ >=\ 3}}
\DoxyCodeLine{00106\ \ \ \textcolor{keyword}{virtual}\ uint64\_t\ tellg()\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordflow}{return}\ \_strm.tellg();}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ seekg(uint64\_t\ pos)\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \_strm.seekg(pos);}
\DoxyCodeLine{00112\ \ \ \}}
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00114\ \ \ \textcolor{keyword}{virtual}\ IMF::Int64\ tellg()\ \{}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordflow}{return}\ \_strm.tellg();}
\DoxyCodeLine{00116\ \ \ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ seekg(IMF::Int64\ pos)\ \{}
\DoxyCodeLine{00119\ \ \ \ \ \_strm.seekg(pos);}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ clear()\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \_strm.clear();}
\DoxyCodeLine{00125\ \ \ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00128\ \ \ std::istream\ \&\_strm;}
\DoxyCodeLine{00129\ \};}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ PNMFileTypeEXR::}
\DoxyCodeLine{00132\ PNMFileTypeEXR()\ \{}
\DoxyCodeLine{00133\ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00138\ \textcolor{keywordtype}{string}\ PNMFileTypeEXR::}
\DoxyCodeLine{00139\ get\_name()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}OpenEXR"{}};}
\DoxyCodeLine{00141\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00147\ \textcolor{keywordtype}{int}\ PNMFileTypeEXR::}
\DoxyCodeLine{00148\ get\_num\_extensions()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{return}\ num\_extensions\_exr;}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00156\ \textcolor{keywordtype}{string}\ PNMFileTypeEXR::}
\DoxyCodeLine{00157\ get\_extension(\textcolor{keywordtype}{int}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00158\ \ \ nassertr(n\ >=\ 0\ \&\&\ n\ <\ num\_extensions\_exr,\ \textcolor{keywordtype}{string}());}
\DoxyCodeLine{00159\ \ \ \textcolor{keywordflow}{return}\ extensions\_exr[n];}
\DoxyCodeLine{00160\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00166\ \textcolor{keywordtype}{string}\ PNMFileTypeEXR::}
\DoxyCodeLine{00167\ get\_suggested\_extension()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00168\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}exr"{}};}
\DoxyCodeLine{00169\ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00175\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::}
\DoxyCodeLine{00176\ has\_magic\_number()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00178\ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00185\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::}
\DoxyCodeLine{00186\ matches\_magic\_number(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&magic\_number)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00187\ \ \ nassertr(magic\_number.size()\ >=\ 2,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{if}\ (magic\_number.size()\ >=\ 4)\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ already\ read\ all\ four\ bytes,\ use\ the\ built-\/in}}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{comment}{//\ function\ to\ check\ them.}}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{keywordflow}{return}\ IMF::isImfMagic(magic\_number.data());}
\DoxyCodeLine{00193\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ check\ only\ the\ first\ two\ bytes\ and\ call\ it\ good\ enough.}}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordflow}{return}\ magic\_number[0]\ ==\ ((IMF::MAGIC\ >>\ \ 0)\ \&\ 0x00ff)\ \&\&}
\DoxyCodeLine{00196\ \ \ \ \ \ \ magic\_number[1]\ ==\ ((IMF::MAGIC\ >>\ \ 8)\ \&\ 0x00ff);}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ \}}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00205\ \mbox{\hyperlink{classPNMReader}{PNMReader}}\ *PNMFileTypeEXR::}
\DoxyCodeLine{00206\ make\_reader(istream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&magic\_number)\ \{}
\DoxyCodeLine{00207\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ Reader(\textcolor{keyword}{this},\ file,\ owns\_file,\ magic\_number);}
\DoxyCodeLine{00208\ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00215\ \mbox{\hyperlink{classPNMWriter}{PNMWriter}}\ *PNMFileTypeEXR::}
\DoxyCodeLine{00216\ make\_writer(ostream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file)\ \{}
\DoxyCodeLine{00217\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ Writer(\textcolor{keyword}{this},\ file,\ owns\_file);}
\DoxyCodeLine{00218\ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00223\ PNMFileTypeEXR::Reader::}
\DoxyCodeLine{00224\ Reader(\mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type,\ istream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,\ \textcolor{keywordtype}{string}\ magic\_number)\ :}
\DoxyCodeLine{00225\ \ \ \mbox{\hyperlink{classPNMReader}{PNMReader}}(type,\ file,\ owns\_file),}
\DoxyCodeLine{00226\ \ \ \_strm(new\ ImfStdIstream(*\_file,\ magic\_number)),}
\DoxyCodeLine{00227\ \ \ \_imf\_file(*\_strm)}
\DoxyCodeLine{00228\ \{}
\DoxyCodeLine{00229\ \ \ \textcolor{keyword}{const}\ IMF::Header\ \&header\ =\ \_imf\_file.header();}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ \ \ IMATH\_NAMESPACE::Box2i\ dw\ =\ header.dataWindow();}
\DoxyCodeLine{00232\ \ \ \_x\_size\ =\ dw.max.x\ -\/\ dw.min.x\ +\ 1;}
\DoxyCodeLine{00233\ \ \ \_y\_size\ =\ dw.max.y\ -\/\ dw.min.y\ +\ 1;}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ \textcolor{comment}{//\ Find\ the\ channels\ we\ care\ about,\ and\ ensure\ they're\ placed\ in\ the}}
\DoxyCodeLine{00236\ \ \ \textcolor{comment}{//\ correct\ order.}}
\DoxyCodeLine{00237\ \ \ \_channel\_names.clear();}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \textcolor{keyword}{const}\ IMF::ChannelList\ \&channels\ =\ header.channels();}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ \textcolor{comment}{//\ Note:\ including\ Y\ in\ this\ list\ allows\ us\ to\ handle\ grayscale\ or}}
\DoxyCodeLine{00242\ \ \ \textcolor{comment}{//\ grayscale/alpha\ images\ correctly,\ but\ also\ incorrectly\ detects}}
\DoxyCodeLine{00243\ \ \ \textcolor{comment}{//\ luminance/chroma\ images\ as\ grayscale\ only.\ \ However,\ these\ kind}}
\DoxyCodeLine{00244\ \ \ \textcolor{comment}{//\ of\ images\ are\ a\ pain\ to\ handle\ anyway,\ so\ maybe\ that's\ OK.}}
\DoxyCodeLine{00245\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *possible\_channel\_names[]\ =\ \{\ \textcolor{stringliteral}{"{}R"{}},\ \textcolor{stringliteral}{"{}G"{}},\ \textcolor{stringliteral}{"{}B"{}},\ \textcolor{stringliteral}{"{}Y"{}},\ \textcolor{stringliteral}{"{}A"{}},\ \textcolor{keyword}{nullptr}\ \};}
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ **pni\ =\ possible\_channel\_names;\ *pni\ !=\ \textcolor{keyword}{nullptr};\ ++pni)\ \{}
\DoxyCodeLine{00247\ \ \ \ \ std::string\ name\ =\ *pni;}
\DoxyCodeLine{00248\ \ \ \ \ IMF::ChannelList::ConstIterator\ ci\ =\ channels.find(name.c\_str());}
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ channels.end())\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \textcolor{comment}{//\ Found\ a\ match.}}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (name\ ==\ \textcolor{stringliteral}{"{}Y"{}}\ \&\&\ !\_channel\_names.empty())\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Y\ is\ luminance\ or\ grayscale.\ \ Ignore\ Y\ if\ there\ are}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ already\ any\ RGB\ channels.}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \_channel\_names.push\_back(name);}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00257\ \ \ \ \ \}}
\DoxyCodeLine{00258\ \ \ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (\_channel\_names.empty())\ \{}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ Didn't\ find\ any\ channel\ names\ that\ match\ R,\ G,\ B,\ A,\ so\ just}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{comment}{//\ ask\ for\ RGB\ anyway\ and\ trust\ the\ OpenEXR\ library\ to\ do\ the}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ right\ thing.\ \ Actually,\ it\ just\ fills\ them\ with\ black,\ but}}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{comment}{//\ whatever.}}
\DoxyCodeLine{00265\ \ \ \ \ \_channel\_names.push\_back(\textcolor{stringliteral}{"{}R"{}});}
\DoxyCodeLine{00266\ \ \ \ \ \_channel\_names.push\_back(\textcolor{stringliteral}{"{}G"{}});}
\DoxyCodeLine{00267\ \ \ \ \ \_channel\_names.push\_back(\textcolor{stringliteral}{"{}B"{}});}
\DoxyCodeLine{00268\ \ \ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ \_num\_channels\ =\ (int)\_channel\_names.size();}
\DoxyCodeLine{00271\ \ \ \textcolor{keywordflow}{if}\ (\_num\_channels\ ==\ 0\ ||\ \_num\_channels\ >\ 4)\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \_is\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00273\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00274\ \ \ \}}
\DoxyCodeLine{00275\ \ \ \textcolor{comment}{//\ We\ read\ all\ OpenEXR\ files\ to\ floating-\/point,\ even\ UINT\ type,\ so}}
\DoxyCodeLine{00276\ \ \ \textcolor{comment}{//\ \_maxval\ doesn't\ matter.\ \ But\ we\ set\ it\ anyway.}}
\DoxyCodeLine{00277\ \ \ \_maxval\ =\ 65535;}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00280\ \}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00285\ PNMFileTypeEXR::Reader::}
\DoxyCodeLine{00286\ \string~Reader()\ \{}
\DoxyCodeLine{00287\ \ \ \textcolor{keyword}{delete}\ \_strm;}
\DoxyCodeLine{00288\ \}}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00295\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::Reader::}
\DoxyCodeLine{00296\ is\_floating\_point()\ \{}
\DoxyCodeLine{00297\ \ \ \textcolor{comment}{//\ We\ read\ everything\ to\ floating-\/point,\ since\ even\ the\ UINT\ type\ is}}
\DoxyCodeLine{00298\ \ \ \textcolor{comment}{//\ 32\ bits,\ more\ fidelity\ than\ we\ can\ represent\ in\ our\ 16-\/bit}}
\DoxyCodeLine{00299\ \ \ \textcolor{comment}{//\ PNMImage.}}
\DoxyCodeLine{00300\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00301\ \}}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00307\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::Reader::}
\DoxyCodeLine{00308\ read\_pfm(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm)\ \{}
\DoxyCodeLine{00309\ \ \ pfm.clear(\_x\_size,\ \_y\_size,\ \_num\_channels);}
\DoxyCodeLine{00310\ \ \ vector\_float\ table;}
\DoxyCodeLine{00311\ \ \ pfm.swap\_table(table);}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00313\ \ \ PN\_float32\ *table\_data\ =\ table.data();}
\DoxyCodeLine{00314\ \ \ \textcolor{keywordtype}{size\_t}\ x\_stride\ =\ \textcolor{keyword}{sizeof}(PN\_float32)\ *\ pfm.get\_num\_channels();}
\DoxyCodeLine{00315\ \ \ \textcolor{keywordtype}{size\_t}\ y\_stride\ =\ x\_stride\ *\ pfm.get\_x\_size();}
\DoxyCodeLine{00316\ \ \ nassertr(y\_stride\ *\ pfm.get\_y\_size()\ <=\ table.size()\ *\ \textcolor{keyword}{sizeof}(PN\_float32),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00317\ }
\DoxyCodeLine{00318\ \ \ \textcolor{keyword}{const}\ IMF::Header\ \&header\ =\ \_imf\_file.header();}
\DoxyCodeLine{00319\ \ \ IMATH\_NAMESPACE::Box2i\ dw\ =\ header.dataWindow();}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ IMF::FrameBuffer\ frameBuffer;}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ ci\ =\ 0;\ ci\ <\ pfm.get\_num\_channels();\ ++ci)\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordtype}{char}\ *base\ =\ (\textcolor{keywordtype}{char}\ *)(table\_data\ -\/\ (dw.min.x\ +\ dw.min.y\ *\ pfm.get\_x\_size())\ *\ pfm.get\_num\_channels()\ +\ ci);}
\DoxyCodeLine{00324\ \ \ \ \ frameBuffer.insert(\_channel\_names[ci].c\_str(),}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ IMF::Slice(IMF::FLOAT,\ base,\ x\_stride,\ y\_stride,}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,\ 1,\ 0.0));}
\DoxyCodeLine{00327\ \ \ \}}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \ \ \_imf\_file.setFrameBuffer(frameBuffer);}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{00332\ \ \ \ \ \_imf\_file.readPixels(dw.min.y,\ dw.max.y);}
\DoxyCodeLine{00333\ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ std::exception\ \&exc)\ \{}
\DoxyCodeLine{00334\ \ \ \ \ pnmimage\_exr\_cat.error()}
\DoxyCodeLine{00335\ \ \ \ \ \ \ <<\ exc.what()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00337\ \ \ \}}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ pfm.swap\_table(table);}
\DoxyCodeLine{00340\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00341\ \}}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00352\ \textcolor{keywordtype}{int}\ PNMFileTypeEXR::Reader::}
\DoxyCodeLine{00353\ read\_data(\mbox{\hyperlink{structpixel}{xel}}\ *array,\ xelval\ *alpha)\ \{}
\DoxyCodeLine{00354\ \ \ \textcolor{comment}{//\ This\ should\ never\ come\ here,\ since\ we\ always\ read\ to}}
\DoxyCodeLine{00355\ \ \ \textcolor{comment}{//\ floating-\/point\ data.}}
\DoxyCodeLine{00356\ \ \ nassertr(\textcolor{keyword}{false},\ 0);}
\DoxyCodeLine{00357\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00358\ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00363\ PNMFileTypeEXR::Writer::}
\DoxyCodeLine{00364\ Writer(\mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type,\ ostream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file)\ :}
\DoxyCodeLine{00365\ \ \ \mbox{\hyperlink{classPNMWriter}{PNMWriter}}(type,\ file,\ owns\_file)}
\DoxyCodeLine{00366\ \{}
\DoxyCodeLine{00367\ \}}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00374\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::Writer::}
\DoxyCodeLine{00375\ supports\_floating\_point()\ \{}
\DoxyCodeLine{00376\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00377\ \}}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00384\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::Writer::}
\DoxyCodeLine{00385\ supports\_integer()\ \{}
\DoxyCodeLine{00386\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00387\ \}}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00393\ \textcolor{keywordtype}{bool}\ PNMFileTypeEXR::Writer::}
\DoxyCodeLine{00394\ write\_pfm(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm)\ \{}
\DoxyCodeLine{00395\ \ \ \textcolor{keyword}{const}\ vector\_float\ \&table\ =\ pfm.get\_table();}
\DoxyCodeLine{00396\ \ \ \textcolor{keyword}{const}\ PN\_float32\ *table\_data\ =\ table.data();}
\DoxyCodeLine{00397\ \ \ \textcolor{keywordtype}{size\_t}\ x\_stride\ =\ \textcolor{keyword}{sizeof}(PN\_float32)\ *\ pfm.get\_num\_channels();}
\DoxyCodeLine{00398\ \ \ \textcolor{keywordtype}{size\_t}\ y\_stride\ =\ x\_stride\ *\ pfm.get\_x\_size();}
\DoxyCodeLine{00399\ \ \ nassertr(y\_stride\ *\ pfm.get\_y\_size()\ <=\ table.size()\ *\ \textcolor{keyword}{sizeof}(PN\_float32),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00400\ }
\DoxyCodeLine{00401\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *channel\_names\_1[]\ =\ \{\ \textcolor{stringliteral}{"{}G"{}}\ \};}
\DoxyCodeLine{00402\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *channel\_names\_2[]\ =\ \{\ \textcolor{stringliteral}{"{}G"{}},\ \textcolor{stringliteral}{"{}A"{}}\ \};}
\DoxyCodeLine{00403\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *channel\_names\_3[]\ =\ \{\ \textcolor{stringliteral}{"{}R"{}},\ \textcolor{stringliteral}{"{}G"{}},\ \textcolor{stringliteral}{"{}B"{}}\ \};}
\DoxyCodeLine{00404\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *channel\_names\_4[]\ =\ \{\ \textcolor{stringliteral}{"{}R"{}},\ \textcolor{stringliteral}{"{}G"{}},\ \textcolor{stringliteral}{"{}B"{}},\ \textcolor{stringliteral}{"{}A"{}}\ \};}
\DoxyCodeLine{00405\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ **channel\_names\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \ \ \textcolor{keywordflow}{switch}\ (pfm.get\_num\_channels())\ \{}
\DoxyCodeLine{00408\ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{00409\ \ \ \ \ channel\_names\ =\ channel\_names\_1;}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00412\ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{00413\ \ \ \ \ channel\_names\ =\ channel\_names\_2;}
\DoxyCodeLine{00414\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00415\ }
\DoxyCodeLine{00416\ \ \ \textcolor{keywordflow}{case}\ 3:}
\DoxyCodeLine{00417\ \ \ \ \ channel\_names\ =\ channel\_names\_3;}
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \textcolor{keywordflow}{case}\ 4:}
\DoxyCodeLine{00421\ \ \ \ \ channel\_names\ =\ channel\_names\_4;}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00423\ }
\DoxyCodeLine{00424\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00426\ \ \ \};}
\DoxyCodeLine{00427\ }
\DoxyCodeLine{00428\ \ \ IMF::Header\ header(pfm.get\_x\_size(),\ pfm.get\_y\_size());}
\DoxyCodeLine{00429\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ ci\ =\ 0;\ ci\ <\ pfm.get\_num\_channels();\ ++ci)\ \{}
\DoxyCodeLine{00430\ \ \ \ \ header.channels().insert(channel\_names[ci],\ IMF::Channel(IMF::FLOAT));}
\DoxyCodeLine{00431\ \ \ \}}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \ \ IMF::FrameBuffer\ frameBuffer;}
\DoxyCodeLine{00434\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ ci\ =\ 0;\ ci\ <\ pfm.get\_num\_channels();\ ++ci)\ \{}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *base\ =\ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *)(table\_data\ +\ ci);}
\DoxyCodeLine{00436\ \ \ \ \ frameBuffer.insert(channel\_names[ci],}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ IMF::Slice(IMF::FLOAT,\ (\textcolor{keywordtype}{char}\ *)base,\ x\_stride,\ y\_stride));}
\DoxyCodeLine{00438\ \ \ \}}
\DoxyCodeLine{00439\ }
\DoxyCodeLine{00440\ \ \ ImfStdOstream\ strm(*\_file);}
\DoxyCodeLine{00441\ \ \ IMF::OutputFile\ file(strm,\ header);}
\DoxyCodeLine{00442\ \ \ file.setFrameBuffer(frameBuffer);}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00444\ \ \ \textcolor{keywordflow}{try}\ \{}
\DoxyCodeLine{00445\ \ \ \ \ file.writePixels(pfm.get\_y\_size());}
\DoxyCodeLine{00446\ \ \ \}\ \textcolor{keywordflow}{catch}\ (\textcolor{keyword}{const}\ std::exception\ \&exc)\ \{}
\DoxyCodeLine{00447\ \ \ \ \ pnmimage\_exr\_cat.error()}
\DoxyCodeLine{00448\ \ \ \ \ \ \ <<\ exc.what()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00450\ \ \ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00453\ \}}
\DoxyCodeLine{00454\ }
\DoxyCodeLine{00471\ \textcolor{keywordtype}{int}\ PNMFileTypeEXR::Writer::}
\DoxyCodeLine{00472\ write\_data(\mbox{\hyperlink{structpixel}{xel}}\ *array,\ xelval\ *alpha)\ \{}
\DoxyCodeLine{00473\ \ \ \textcolor{comment}{//\ This\ should\ never\ come\ here,\ since\ we\ always\ write\ to}}
\DoxyCodeLine{00474\ \ \ \textcolor{comment}{//\ floating-\/point\ data.}}
\DoxyCodeLine{00475\ \ \ nassertr(\textcolor{keyword}{false},\ 0);}
\DoxyCodeLine{00476\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00477\ \}}
\DoxyCodeLine{00478\ }
\DoxyCodeLine{00482\ \textcolor{keywordtype}{void}\ PNMFileTypeEXR::}
\DoxyCodeLine{00483\ register\_with\_read\_factory()\ \{}
\DoxyCodeLine{00484\ \ \ BamReader::get\_factory()-\/>}
\DoxyCodeLine{00485\ \ \ \ \ register\_factory(get\_class\_type(),\ make\_from\_bam);}
\DoxyCodeLine{00486\ \}}
\DoxyCodeLine{00487\ }
\DoxyCodeLine{00496\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *PNMFileTypeEXR::}
\DoxyCodeLine{00497\ make\_from\_bam(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00498\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classPNMFileTypeRegistry_a83617b215ff0b0482e86e463b43f22cf}{PNMFileTypeRegistry::get\_global\_ptr}}()-\/>\mbox{\hyperlink{classPNMFileTypeRegistry_a77cfb63495edef614b8ebf0c0d501843}{get\_type\_by\_handle}}(get\_class\_type());}
\DoxyCodeLine{00499\ \}}
\DoxyCodeLine{00500\ }
\DoxyCodeLine{00501\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_OPENEXR}}

\end{DoxyCode}
