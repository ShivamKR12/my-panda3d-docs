\doxysection{pipeline\+Cycler\+True\+Impl.\+cxx}
\hypertarget{pipelineCyclerTrueImpl_8cxx_source}{}\label{pipelineCyclerTrueImpl_8cxx_source}\index{panda/src/pipeline/pipelineCyclerTrueImpl.cxx@{panda/src/pipeline/pipelineCyclerTrueImpl.cxx}}
\mbox{\hyperlink{pipelineCyclerTrueImpl_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pipelineCyclerTrueImpl_8h}{pipelineCyclerTrueImpl.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ THREADED\_PIPELINE}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pipeline_8h}{config\_pipeline.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pipeline_8h}{pipeline.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00024\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00025\ PipelineCyclerTrueImpl(\mbox{\hyperlink{classCycleData}{CycleData}}\ *initial\_data,\ \mbox{\hyperlink{classPipeline}{Pipeline}}\ *pipeline)\ :}
\DoxyCodeLine{00026\ \ \ \_pipeline(pipeline),}
\DoxyCodeLine{00027\ \ \ \_lock(this)}
\DoxyCodeLine{00028\ \{}
\DoxyCodeLine{00029\ \ \ clear\_dirty();}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \textcolor{keywordflow}{if}\ (\_pipeline\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00032\ \ \ \ \ \_pipeline\ =\ Pipeline::get\_render\_pipeline();}
\DoxyCodeLine{00033\ \ \ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ \_pipeline-\/>get\_num\_stages();}
\DoxyCodeLine{00036\ \ \ \textcolor{keywordflow}{if}\ (num\_stages\ ==\ 1)\ \{}
\DoxyCodeLine{00037\ \ \ \ \ \_single\_data.\_cdata\ =\ initial\_data;}
\DoxyCodeLine{00038\ \ \ \ \ \_data\ =\ \&\_single\_data;}
\DoxyCodeLine{00039\ \ \ \}}
\DoxyCodeLine{00040\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00041\ \ \ \ \ \_data\ =\ \textcolor{keyword}{new}\ CycleDataNode[num\_stages];}
\DoxyCodeLine{00042\ \ \ \ \ \_data[0].\_num\_stages\ =\ num\_stages;}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \_data[i].\_cdata\ =\ initial\_data;}
\DoxyCodeLine{00046\ \ \ \ \ \}}
\DoxyCodeLine{00047\ \ \ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \_pipeline-\/>add\_cycler(\textcolor{keyword}{this});}
\DoxyCodeLine{00050\ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00055\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00056\ PipelineCyclerTrueImpl(\textcolor{keyword}{const}\ PipelineCyclerTrueImpl\ \&copy)\ :}
\DoxyCodeLine{00057\ \ \ \_pipeline(copy.\_pipeline),}
\DoxyCodeLine{00058\ \ \ \_lock(this)}
\DoxyCodeLine{00059\ \{}
\DoxyCodeLine{00060\ \ \ clear\_dirty();}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00063\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder2(copy.\_lock);}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ \_pipeline-\/>get\_num\_stages();}
\DoxyCodeLine{00066\ \ \ nassertv(num\_stages\ ==\ copy.get\_num\_stages());}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{keywordflow}{if}\ (num\_stages\ ==\ 1)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \_single\_data.\_cdata\ =\ copy.\_single\_data.\_cdata-\/>make\_copy();}
\DoxyCodeLine{00070\ \ \ \ \ \_data\ =\ \&\_single\_data;}
\DoxyCodeLine{00071\ \ \ \}}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \_data\ =\ \textcolor{keyword}{new}\ CycleDataNode[num\_stages];}
\DoxyCodeLine{00074\ \ \ \ \ \_data[0].\_num\_stages\ =\ num\_stages;}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{comment}{//\ It's\ no\ longer\ critically\ important\ that\ we\ preserve\ pointerwise}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{comment}{//\ equivalence\ between\ different\ stages\ in\ the\ copy,\ but\ it\ doesn't\ cost}}
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{comment}{//\ much\ and\ might\ be\ a\ little\ more\ efficient,\ so\ we\ do\ it\ anyway.}}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classpmap}{pmap}}<\mbox{\hyperlink{classCycleData}{CycleData}}\ *,\ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ >\ Pointers;}
\DoxyCodeLine{00080\ \ \ \ \ Pointers\ pointers;}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ \&new\_pt\ =\ pointers[copy.\_data[i].\_cdata];}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_pt\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ new\_pt\ =\ copy.\_data[i].\_cdata-\/>make\_copy();}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \_data[i].\_cdata\ =\ new\_pt.p();}
\DoxyCodeLine{00088\ \ \ \ \ \}}
\DoxyCodeLine{00089\ \ \ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \_pipeline-\/>add\_cycler(\textcolor{keyword}{this},\ copy.is\_dirty());}
\DoxyCodeLine{00092\ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00097\ \textcolor{keywordtype}{void}\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00098\ operator\ =\ (\textcolor{keyword}{const}\ PipelineCyclerTrueImpl\ \&copy)\ \{}
\DoxyCodeLine{00099\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder1(\_lock);}
\DoxyCodeLine{00100\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder2(copy.\_lock);}
\DoxyCodeLine{00101\ \ \ nassertv(get\_parent\_type()\ ==\ copy.get\_parent\_type());}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{keywordflow}{if}\ (\_data\ ==\ \&\_single\_data)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \_single\_data.\_cdata\ =\ copy.\_single\_data.\_cdata-\/>make\_copy();}
\DoxyCodeLine{00105\ \ \ \ \ nassertv(!copy.is\_dirty());}
\DoxyCodeLine{00106\ \ \ \}}
\DoxyCodeLine{00107\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ \_data[0].\_num\_stages;}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classpmap}{pmap}}<\mbox{\hyperlink{classCycleData}{CycleData}}\ *,\ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ >\ Pointers;}
\DoxyCodeLine{00111\ \ \ \ \ Pointers\ pointers;}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ \&new\_pt\ =\ pointers[copy.\_data[i].\_cdata];}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_pt\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ new\_pt\ =\ copy.\_data[i].\_cdata-\/>make\_copy();}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \_data[i].\_cdata\ =\ new\_pt.p();}
\DoxyCodeLine{00119\ \ \ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{keywordflow}{if}\ (copy.is\_dirty()\ \&\&\ !is\_dirty())\ \{}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \_pipeline-\/>add\_dirty\_cycler(\textcolor{keyword}{this});}
\DoxyCodeLine{00123\ \ \ \ \ \}}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00130\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00131\ \string~PipelineCyclerTrueImpl()\ \{}
\DoxyCodeLine{00132\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \_pipeline-\/>remove\_cycler(\textcolor{keyword}{this});}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \textcolor{keywordflow}{if}\ (\_data\ !=\ \&\_single\_data)\ \{}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keyword}{delete}[]\ \_data;}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ \ \ \_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00140\ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00148\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *PipelineCyclerTrueImpl::}
\DoxyCodeLine{00149\ write\_stage(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00150\ \ \ \_lock.acquire(current\_thread);}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \textcolor{preprocessor}{\#ifdef\ \_DEBUG}}
\DoxyCodeLine{00153\ \ \ nassertd(pipeline\_stage\ >=\ 0\ \&\&\ pipeline\_stage\ <\ get\_num\_stages())\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \_lock.release();}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00156\ \ \ \}}
\DoxyCodeLine{00157\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \mbox{\hyperlink{classCycleData}{CycleData}}\ *old\_data\ =\ \_data[pipeline\_stage].\_cdata;}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ \textcolor{comment}{//\ We\ only\ perform\ copy-\/on-\/write\ if\ this\ is\ the\ first\ CycleData\ requested}}
\DoxyCodeLine{00162\ \ \ \textcolor{comment}{//\ for\ write\ mode\ from\ this\ thread.\ \ (We\ will\ never\ have\ outstanding\ writes}}
\DoxyCodeLine{00163\ \ \ \textcolor{comment}{//\ for\ multiple\ threads,\ because\ we\ hold\ the\ CyclerMutex\ during\ the\ entire}}
\DoxyCodeLine{00164\ \ \ \textcolor{comment}{//\ lifetime\ of\ write()\ ..\ release()).}}
\DoxyCodeLine{00165\ \ \ \textcolor{keywordflow}{if}\ (\_data[pipeline\_stage].\_writes\_outstanding\ ==\ 0)\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ Only\ the\ node\ reference\ count\ is\ considered\ an\ important\ count\ for}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ copy-\/on-\/write\ purposes.\ \ A\ standard\ reference\ of\ other\ than\ 1\ just}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ means\ that\ some\ code\ (other\ that\ the\ PipelineCycler)\ has\ a\ pointer,}}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{comment}{//\ which\ is\ safe\ to\ modify.}}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keywordflow}{if}\ (old\_data-\/>get\_node\_ref\_count()\ !=\ 1)\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \textcolor{comment}{//\ Copy-\/on-\/write.}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \_data[pipeline\_stage].\_cdata\ =\ old\_data-\/>make\_copy();}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pipeline\_cat.is\_debug())\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ pipeline\_cat.debug()}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Copy-\/on-\/write\ a:\ "{}}\ <<\ old\_data\ <<\ \textcolor{stringliteral}{"{}\ becomes\ "{}}}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ <<\ \_data[pipeline\_stage].\_cdata\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ nassertr(false,\ NULL);}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ we\ have\ differences\ between\ some\ of\ the\ data\ pointers,\ so\ we're}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \textcolor{comment}{//\ "{}dirty"{}.\ \ Mark\ it\ so.}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!is\_dirty()\ \&\&\ \_data\ !=\ \&\_single\_data)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \_pipeline-\/>add\_dirty\_cycler(\textcolor{keyword}{this});}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00185\ \ \ \ \ \}}
\DoxyCodeLine{00186\ \ \ \}}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ ++(\_data[pipeline\_stage].\_writes\_outstanding);}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{return}\ \_data[pipeline\_stage].\_cdata;}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00196\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *PipelineCyclerTrueImpl::}
\DoxyCodeLine{00197\ write\_stage\_upstream(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \textcolor{keywordtype}{bool}\ force\_to\_0,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00198\ \ \ \_lock.acquire(current\_thread);}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \textcolor{preprocessor}{\#ifdef\ \_DEBUG}}
\DoxyCodeLine{00201\ \ \ nassertd(pipeline\_stage\ >=\ 0\ \&\&\ pipeline\_stage\ <\ get\_num\_stages())\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \_lock.release();}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \mbox{\hyperlink{classCycleData}{CycleData}}\ *old\_data\ =\ \_data[pipeline\_stage].\_cdata;}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \textcolor{keywordflow}{if}\ (old\_data-\/>get\_ref\_count()\ !=\ 1\ ||\ force\_to\_0)\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ Count\ the\ number\ of\ references\ before\ the\ current\ stage,\ and\ the\ number}}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{comment}{//\ of\ references\ remaining\ other\ than\ those.}}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordtype}{int}\ external\_count\ =\ old\_data-\/>get\_ref\_count()\ -\/\ 1;}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordtype}{int}\ k\ =\ pipeline\_stage\ -\/\ 1;}
\DoxyCodeLine{00214\ \ \ \ \ \textcolor{keywordflow}{while}\ (k\ >=\ 0\ \&\&\ \_data[k].\_cdata\ ==\ old\_data)\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ -\/-\/k;}
\DoxyCodeLine{00216\ \ \ \ \ \ \ -\/-\/external\_count;}
\DoxyCodeLine{00217\ \ \ \ \ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{comment}{//\ We\ only\ perform\ copy-\/on-\/write\ if\ this\ is\ the\ first\ CycleData\ requested}}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{comment}{//\ for\ write\ mode\ from\ this\ thread.\ \ (We\ will\ never\ have\ outstanding}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{//\ writes\ for\ multiple\ threads,\ because\ we\ hold\ the\ CyclerMutex\ during\ the}}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{comment}{//\ entire\ lifetime\ of\ write()\ ..\ release()).}}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordflow}{if}\ (external\_count\ >\ 0\ \&\&\ \_data[pipeline\_stage].\_writes\_outstanding\ ==\ 0)\ \{}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \textcolor{comment}{//\ There\ are\ references\ other\ than\ the\ ones\ before\ this\ stage\ in\ the}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \textcolor{comment}{//\ pipeline;\ perform\ a\ copy-\/on-\/write.}}
\DoxyCodeLine{00226\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ new\_data\ =\ old\_data-\/>make\_copy();}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pipeline\_cat.is\_debug())\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ pipeline\_cat.debug()}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Copy-\/on-\/write\ b:\ "{}}\ <<\ old\_data\ <<\ \textcolor{stringliteral}{"{}\ becomes\ "{}}}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ <<\ new\_data\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ nassertr(false,\ NULL);}}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \ \ k\ =\ pipeline\_stage\ -\/\ 1;}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (k\ >=\ 0\ \&\&\ (\_data[k].\_cdata\ ==\ old\_data\ ||\ force\_to\_0))\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ nassertr(\_data[k].\_writes\_outstanding\ ==\ 0,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \_data[k].\_cdata\ =\ new\_data.p();}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ -\/-\/k;}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ \ \ \ \ \_data[pipeline\_stage].\_cdata\ =\ new\_data;}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (k\ >=\ 0\ ||\ pipeline\_stage\ +\ 1\ <\ get\_num\_stages())\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ we\ have\ differences\ between\ some\ of\ the\ data\ pointers,\ which}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ makes\ us\ "{}dirty"{}.}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!is\_dirty())\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \_pipeline-\/>add\_dirty\_cycler(\textcolor{keyword}{this});}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00250\ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (k\ >=\ 0\ \&\&\ force\_to\_0)\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \textcolor{comment}{//\ There\ are\ no\ external\ pointers,\ so\ no\ need\ to\ copy-\/on-\/write,\ but\ the}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \textcolor{comment}{//\ current\ pointer\ doesn't\ go\ all\ the\ way\ back.\ \ Make\ it\ do\ so.}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (k\ >=\ 0)\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ nassertr(\_data[k].\_writes\_outstanding\ ==\ 0,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \_data[k].\_cdata\ =\ old\_data;}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ -\/-\/k;}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00259\ \ \ \ \ \}}
\DoxyCodeLine{00260\ \ \ \}}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \ \ ++(\_data[pipeline\_stage].\_writes\_outstanding);}
\DoxyCodeLine{00263\ \ \ \textcolor{keywordflow}{return}\ \_data[pipeline\_stage].\_cdata;}
\DoxyCodeLine{00264\ \}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00280\ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00281\ cycle()\ \{}
\DoxyCodeLine{00282\ \ \ \textcolor{comment}{//\ This\ trick\ moves\ an\ NPT\ into\ a\ PT\ without\ unnecessarily\ incrementing\ and}}
\DoxyCodeLine{00283\ \ \ \textcolor{comment}{//\ subsequently\ decrementing\ the\ regular\ reference\ count.}}
\DoxyCodeLine{00284\ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ get\_num\_stages();}
\DoxyCodeLine{00285\ \ \ PT(\mbox{\hyperlink{classCycleData}{CycleData}})\ last\_val;}
\DoxyCodeLine{00286\ \ \ last\_val.swap(\_data[num\_stages\ -\/\ 1].\_cdata);}
\DoxyCodeLine{00287\ \ \ last\_val-\/>node\_unref\_only();}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ nassertr(\_lock.debug\_is\_locked(),\ last\_val);}
\DoxyCodeLine{00290\ \ \ nassertr(is\_dirty(),\ last\_val);}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00293\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ num\_stages\ -\/\ 1;\ i\ >\ 0;\ -\/-\/i)\ \{}
\DoxyCodeLine{00294\ \ \ \ \ nassertr(\_data[i].\_writes\_outstanding\ ==\ 0,\ last\_val);}
\DoxyCodeLine{00295\ \ \ \ \ \_data[i].\_cdata\ =\ \_data[i\ -\/\ 1].\_cdata;}
\DoxyCodeLine{00296\ \ \ \}}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 1;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_data[i].\_cdata\ !=\ \_data[i\ -\/\ 1].\_cdata)\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \textcolor{comment}{//\ Still\ dirty.}}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ last\_val;}
\DoxyCodeLine{00302\ \ \ \ \ \}}
\DoxyCodeLine{00303\ \ \ \}}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \ \ \textcolor{comment}{//\ No\ longer\ dirty.}}
\DoxyCodeLine{00306\ \ \ clear\_dirty();}
\DoxyCodeLine{00307\ \ \ \textcolor{keywordflow}{return}\ last\_val;}
\DoxyCodeLine{00308\ \}}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00314\ \textcolor{keywordtype}{void}\ PipelineCyclerTrueImpl::}
\DoxyCodeLine{00315\ set\_num\_stages(\textcolor{keywordtype}{int}\ num\_stages)\ \{}
\DoxyCodeLine{00316\ \ \ nassertv(\_lock.debug\_is\_locked());}
\DoxyCodeLine{00317\ }
\DoxyCodeLine{00318\ \ \ \textcolor{keywordflow}{if}\ (\_data\ ==\ \&\_single\_data)\ \{}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{comment}{//\ We've\ got\ only\ 1\ stage.\ \ Allocate\ an\ array.}}
\DoxyCodeLine{00320\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_stages\ >\ 1)\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \ \ nassertv(\_single\_data.\_writes\_outstanding\ ==\ 0);}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ \ \ \ \ CycleDataNode\ *new\_data\ =\ \textcolor{keyword}{new}\ CycleDataNode[num\_stages];}
\DoxyCodeLine{00324\ \ \ \ \ \ \ new\_data[0].\_num\_stages\ =\ num\_stages;}
\DoxyCodeLine{00325\ \ \ \ \ \ \ new\_data[0].\_cdata\ =\ std::move(\_single\_data.\_cdata);}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \_single\_data.\_cdata.clear();}
\DoxyCodeLine{00327\ }
\DoxyCodeLine{00328\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 1;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ new\_data[i].\_cdata\ =\ new\_data[0].\_cdata;}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \_data\ =\ new\_data;}
\DoxyCodeLine{00332\ \ \ \ \ \}}
\DoxyCodeLine{00333\ \ \ \}}
\DoxyCodeLine{00334\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_stages\ ==\ 1)\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \textcolor{comment}{//\ Deallocate\ the\ array,\ since\ we're\ back\ to\ one\ stage.}}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_data\ !=\ \&\_single\_data)\ \{}
\DoxyCodeLine{00337\ \ \ \ \ \ \ nassertv(\_data[0].\_writes\_outstanding\ ==\ 0);}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \_single\_data.\_cdata\ =\ std::move(\_data[0].\_cdata);}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \_data\ =\ \&\_single\_data;}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \textcolor{keyword}{delete}[]\ \_data;}
\DoxyCodeLine{00341\ \ \ \ \ \}}
\DoxyCodeLine{00342\ \ \ \}}
\DoxyCodeLine{00343\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_stages\ <=\ \_data[0].\_num\_stages)\ \{}
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{comment}{//\ Don't\ bother\ to\ reallocate\ the\ array\ smaller;\ we\ just\ won't\ use\ the}}
\DoxyCodeLine{00345\ \ \ \ \ \textcolor{comment}{//\ rest\ of\ the\ array.}}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{keywordtype}{int}\ old\_stages\ =\ \_data[0].\_num\_stages;}
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ old\_stages;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00348\ \ \ \ \ \ \ nassertv(\_data[i].\_writes\_outstanding\ ==\ 0);}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \_data[i].\_cdata.clear();}
\DoxyCodeLine{00350\ \ \ \ \ \}}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00352\ \ \ \ \ \_data[0].\_num\_stages\ =\ num\_stages;}
\DoxyCodeLine{00353\ \ \ \}}
\DoxyCodeLine{00354\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{comment}{//\ To\ increase\ the\ array,\ we\ must\ reallocate\ it\ larger.}}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordtype}{int}\ old\_stages\ =\ \_data[0].\_num\_stages;}
\DoxyCodeLine{00357\ \ \ \ \ CycleDataNode\ *new\_data\ =\ \textcolor{keyword}{new}\ CycleDataNode[num\_stages];}
\DoxyCodeLine{00358\ \ \ \ \ new\_data[0].\_num\_stages\ =\ num\_stages;}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ old\_stages;\ ++i)\ \{}
\DoxyCodeLine{00362\ \ \ \ \ \ \ nassertv(\_data[i].\_writes\_outstanding\ ==\ 0);}
\DoxyCodeLine{00363\ \ \ \ \ \ \ new\_data[i].\_cdata\ =\ \_data[i].\_cdata;}
\DoxyCodeLine{00364\ \ \ \ \ \}}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ old\_stages;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \ \ new\_data[i].\_cdata\ =\ \_data[old\_stages\ -\/\ 1].\_cdata;}
\DoxyCodeLine{00367\ \ \ \ \ \}}
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keyword}{delete}[]\ \_data;}
\DoxyCodeLine{00369\ \ \ \ \ \_data\ =\ new\_data;}
\DoxyCodeLine{00370\ \ \ \}}
\DoxyCodeLine{00371\ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \textcolor{preprocessor}{\#ifdef\ DEBUG\_THREADS}}
\DoxyCodeLine{00377\ \textcolor{keywordtype}{void}\ PipelineCyclerTrueImpl::CyclerMutex::}
\DoxyCodeLine{00378\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00379\ \ \ out\ <<\ \textcolor{stringliteral}{"{}CyclerMutex\ "{}};}
\DoxyCodeLine{00380\ \ \ \_cycler-\/>cheat()-\/>output(out);}
\DoxyCodeLine{00381\ \}}
\DoxyCodeLine{00382\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DEBUG\_THREADS}}
\DoxyCodeLine{00383\ }
\DoxyCodeLine{00384\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ THREADED\_PIPELINE}}

\end{DoxyCode}
