\doxysection{material\+Pool.\+cxx}
\hypertarget{materialPool_8cxx_source}{}\label{materialPool_8cxx_source}\index{panda/src/gobj/materialPool.cxx@{panda/src/gobj/materialPool.cxx}}
\mbox{\hyperlink{materialPool_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{materialPool_8h}{materialPool.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightMutexHolder_8h}{lightMutexHolder.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \mbox{\hyperlink{classMaterialPool}{MaterialPool}}\ *MaterialPool::\_global\_ptr\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00024\ \textcolor{keywordtype}{void}\ MaterialPool::}
\DoxyCodeLine{00025\ write(std::ostream\ \&out)\ \{}
\DoxyCodeLine{00026\ \ \ get\_global\_ptr()-\/>ns\_list\_contents(out);}
\DoxyCodeLine{00027\ \}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00032\ \mbox{\hyperlink{classMaterial}{Material}}\ *MaterialPool::}
\DoxyCodeLine{00033\ ns\_get\_material(\mbox{\hyperlink{classMaterial}{Material}}\ *temp)\ \{}
\DoxyCodeLine{00034\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ CPT(\mbox{\hyperlink{classMaterial}{Material}})\ cpttemp\ =\ temp;}
\DoxyCodeLine{00037\ \ \ Materials::iterator\ mi\ =\ \_materials.find(cpttemp);}
\DoxyCodeLine{00038\ \ \ \textcolor{keywordflow}{if}\ (mi\ ==\ \_materials.end())\ \{}
\DoxyCodeLine{00039\ \ \ \ \ mi\ =\ \_materials.insert(Materials::value\_type(\textcolor{keyword}{new}\ \mbox{\hyperlink{classMaterial}{Material}}(*temp),\ temp)).first;}
\DoxyCodeLine{00040\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keywordflow}{if}\ (*(*mi).first\ !=\ *(*mi).second)\ \{}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ pointer\ no\ longer\ matches\ its\ original\ value.\ \ Save\ a\ new\ one.}}
\DoxyCodeLine{00043\ \ \ \ \ \ \ (*mi).second\ =\ temp;}
\DoxyCodeLine{00044\ \ \ \ \ \}}
\DoxyCodeLine{00045\ \ \ \}}
\DoxyCodeLine{00046\ \ \ \textcolor{keywordflow}{return}\ (*mi).second;}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00052\ \textcolor{keywordtype}{void}\ MaterialPool::}
\DoxyCodeLine{00053\ ns\_release\_material(\mbox{\hyperlink{classMaterial}{Material}}\ *temp)\ \{}
\DoxyCodeLine{00054\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ CPT(\mbox{\hyperlink{classMaterial}{Material}})\ cpttemp\ =\ temp;}
\DoxyCodeLine{00057\ \ \ \_materials.erase(cpttemp);}
\DoxyCodeLine{00058\ \}}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00063\ \textcolor{keywordtype}{void}\ MaterialPool::}
\DoxyCodeLine{00064\ ns\_release\_all\_materials()\ \{}
\DoxyCodeLine{00065\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \_materials.clear();}
\DoxyCodeLine{00068\ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00073\ \textcolor{keywordtype}{int}\ MaterialPool::}
\DoxyCodeLine{00074\ ns\_garbage\_collect()\ \{}
\DoxyCodeLine{00075\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \textcolor{keywordtype}{int}\ num\_released\ =\ 0;}
\DoxyCodeLine{00078\ \ \ Materials\ new\_set;}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ Materials::iterator\ mi;}
\DoxyCodeLine{00081\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_materials.begin();\ mi\ !=\ \_materials.end();\ ++mi)\ \{}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classMaterial}{Material}}\ *mat1\ =\ (*mi).first;}
\DoxyCodeLine{00083\ \ \ \ \ \mbox{\hyperlink{classMaterial}{Material}}\ *mat2\ =\ (*mi).second;}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*mat1)\ !=\ (*mat2)\ ||\ mat2-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Releasing\ "{}}\ <<\ *mat1\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ ++num\_released;}
\DoxyCodeLine{00090\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ new\_set.insert(new\_set.end(),\ *mi);}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00093\ \ \ \}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \_materials.swap(new\_set);}
\DoxyCodeLine{00096\ \ \ \textcolor{keywordflow}{return}\ num\_released;}
\DoxyCodeLine{00097\ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00102\ \textcolor{keywordtype}{void}\ MaterialPool::}
\DoxyCodeLine{00103\ ns\_list\_contents(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00104\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ out\ <<\ \_materials.size()\ <<\ \textcolor{stringliteral}{"{}\ materials:\(\backslash\)n"{}};}
\DoxyCodeLine{00107\ \ \ Materials::const\_iterator\ mi;}
\DoxyCodeLine{00108\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_materials.begin();\ mi\ !=\ \_materials.end();\ ++mi)\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classMaterial}{Material}}\ *mat1\ =\ (*mi).first;}
\DoxyCodeLine{00110\ \ \ \ \ \mbox{\hyperlink{classMaterial}{Material}}\ *mat2\ =\ (*mi).second;}
\DoxyCodeLine{00111\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ *mat1}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ (count\ =\ "{}}\ <<\ mat2-\/>get\_ref\_count()\ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{00113\ \ \ \}}
\DoxyCodeLine{00114\ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00120\ \mbox{\hyperlink{classMaterialPool}{MaterialPool}}\ *MaterialPool::}
\DoxyCodeLine{00121\ get\_global\_ptr()\ \{}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classMaterialPool}{MaterialPool}};}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00126\ \}}

\end{DoxyCode}
