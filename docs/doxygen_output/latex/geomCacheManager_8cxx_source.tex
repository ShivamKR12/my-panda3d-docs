\doxysection{geom\+Cache\+Manager.\+cxx}
\hypertarget{geomCacheManager_8cxx_source}{}\label{geomCacheManager_8cxx_source}\index{panda/src/gobj/geomCacheManager.cxx@{panda/src/gobj/geomCacheManager.cxx}}
\mbox{\hyperlink{geomCacheManager_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomCacheManager_8h}{geomCacheManager.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomCacheEntry_8h}{geomCacheEntry.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomMunger_8h}{geomMunger.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightMutexHolder_8h}{lightMutexHolder.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightReMutexHolder_8h}{lightReMutexHolder.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clockObject_8h}{clockObject.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \mbox{\hyperlink{classGeomCacheManager}{GeomCacheManager}}\ *GeomCacheManager::\_global\_ptr\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GeomCacheManager::\_geom\_cache\_size\_pcollector(\textcolor{stringliteral}{"{}Geom\ cache\ size"{}});}
\DoxyCodeLine{00024\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GeomCacheManager::\_geom\_cache\_active\_pcollector(\textcolor{stringliteral}{"{}Geom\ cache\ size:Active"{}});}
\DoxyCodeLine{00025\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GeomCacheManager::\_geom\_cache\_record\_pcollector(\textcolor{stringliteral}{"{}Geom\ cache\ operations:record"{}});}
\DoxyCodeLine{00026\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GeomCacheManager::\_geom\_cache\_erase\_pcollector(\textcolor{stringliteral}{"{}Geom\ cache\ operations:erase"{}});}
\DoxyCodeLine{00027\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GeomCacheManager::\_geom\_cache\_evict\_pcollector(\textcolor{stringliteral}{"{}Geom\ cache\ operations:evict"{}});}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00032\ GeomCacheManager::}
\DoxyCodeLine{00033\ GeomCacheManager()\ :}
\DoxyCodeLine{00034\ \ \ \_lock(\textcolor{stringliteral}{"{}GeomCacheManager"{}}),}
\DoxyCodeLine{00035\ \ \ \_total\_size(0)}
\DoxyCodeLine{00036\ \{}
\DoxyCodeLine{00037\ \ \ \textcolor{comment}{//\ We\ deliberately\ hang\ on\ to\ this\ pointer\ forever.}}
\DoxyCodeLine{00038\ \ \ \_list\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomCacheEntry}{GeomCacheEntry}};}
\DoxyCodeLine{00039\ \ \ \_list-\/>ref();}
\DoxyCodeLine{00040\ \ \ \_list-\/>\_next\ =\ \_list;}
\DoxyCodeLine{00041\ \ \ \_list-\/>\_prev\ =\ \_list;}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00047\ GeomCacheManager::}
\DoxyCodeLine{00048\ \string~GeomCacheManager()\ \{}
\DoxyCodeLine{00049\ \ \ \textcolor{comment}{//\ Shouldn't\ be\ deleting\ this\ global\ object.}}
\DoxyCodeLine{00050\ \ \ nassert\_raise(\textcolor{stringliteral}{"{}attempt\ to\ delete\ GeomCacheManager"{}});}
\DoxyCodeLine{00051\ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00056\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomCacheManager_a0d4a83f6a8d9924bd3e7a514abf8c7c0}{GeomCacheManager::}}}
\DoxyCodeLine{00057\ \mbox{\hyperlink{classGeomCacheManager_a0d4a83f6a8d9924bd3e7a514abf8c7c0}{flush}}()\ \{}
\DoxyCodeLine{00058\ \ \ \textcolor{comment}{//\ Prevent\ deadlock}}
\DoxyCodeLine{00059\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ registry\_holder(GeomMunger::get\_registry()-\/>\_registry\_lock);}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00062\ \ \ evict\_old\_entries(0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00063\ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00068\ \mbox{\hyperlink{classGeomCacheManager}{GeomCacheManager}}\ *\mbox{\hyperlink{classGeomCacheManager_a75c282f685f34ef0dfb0d51987a58ac7}{GeomCacheManager::}}}
\DoxyCodeLine{00069\ \mbox{\hyperlink{classGeomCacheManager_a75c282f685f34ef0dfb0d51987a58ac7}{get\_global\_ptr}}()\ \{}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomCacheManager}{GeomCacheManager}};}
\DoxyCodeLine{00072\ \ \ \}}
\DoxyCodeLine{00073\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00081\ \textcolor{keywordtype}{void}\ GeomCacheManager::}
\DoxyCodeLine{00082\ evict\_old\_entries(\textcolor{keywordtype}{int}\ max\_size,\ \textcolor{keywordtype}{bool}\ keep\_current)\ \{}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordtype}{int}\ current\_frame\ =\ ClockObject::get\_global\_clock()-\/>get\_frame\_count();}
\DoxyCodeLine{00084\ \ \ \textcolor{keywordtype}{int}\ min\_frames\ =\ geom\_cache\_min\_frames;}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \textcolor{keywordflow}{while}\ (\_total\_size\ >\ max\_size)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ PT(\mbox{\hyperlink{classGeomCacheEntry}{GeomCacheEntry}})\ entry\ =\ \_list-\/>\_next;}
\DoxyCodeLine{00088\ \ \ \ \ nassertv(entry\ !=\ \_list);}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{if}\ (keep\_current\ \&\&\ current\_frame\ -\/\ entry-\/>\_last\_frame\_used\ <\ min\_frames)\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \textcolor{comment}{//\ Never\ mind,\ this\ one\ is\ too\ new.}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Oldest\ element\ in\ cache\ is\ "{}}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ <<\ current\_frame\ -\/\ entry-\/>\_last\_frame\_used}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ frames;\ keeping\ cache\ at\ "{}}\ <<\ \_total\_size\ <<\ \textcolor{stringliteral}{"{}\ entries.\(\backslash\)n"{}};}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00099\ \ \ \ \ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \ \ entry-\/>unref();}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}cache\ total\_size\ =\ "{}}\ <<\ \_total\_size\ <<\ \textcolor{stringliteral}{"{}\ entries,\ max\_size\ =\ "{}}}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ <<\ max\_size\ <<\ \textcolor{stringliteral}{"{},\ removing\ "{}}\ <<\ *entry\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00107\ \ \ \ \ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ entry-\/>evict\_callback();}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordflow}{if}\ (PStatClient::is\_connected())\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (entry-\/>\_last\_frame\_used\ ==\ current\_frame)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ GeomCacheManager::\_geom\_cache\_active\_pcollector.sub\_level(1);}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00115\ \ \ \ \ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ -\/-\/\_total\_size;}
\DoxyCodeLine{00118\ \ \ \ \ entry-\/>remove\_from\_list();}
\DoxyCodeLine{00119\ \ \ \ \ \_geom\_cache\_evict\_pcollector.add\_level(1);}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ \ \ \_geom\_cache\_size\_pcollector.set\_level(\_total\_size);}
\DoxyCodeLine{00122\ \}}

\end{DoxyCode}
