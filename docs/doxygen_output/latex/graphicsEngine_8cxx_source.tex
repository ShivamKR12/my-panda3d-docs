\doxysection{graphics\+Engine.\+cxx}
\hypertarget{graphicsEngine_8cxx_source}{}\label{graphicsEngine_8cxx_source}\index{panda/src/display/graphicsEngine.cxx@{panda/src/display/graphicsEngine.cxx}}
\mbox{\hyperlink{graphicsEngine_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsEngine_8h}{graphicsEngine.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsPipe_8h}{graphicsPipe.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{parasiteBuffer_8h}{parasiteBuffer.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__display_8h}{config\_display.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pipeline_8h}{pipeline.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{drawCullHandler_8h}{drawCullHandler.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{binCullHandler_8h}{binCullHandler.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullResult_8h}{cullResult.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clockObject_8h}{clockObject.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatGPUTimer_8h}{pStatGPUTimer.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatClient_8h}{pStatClient.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatCollector_8h}{pStatCollector.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mutexHolder_8h}{mutexHolder.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{reMutexHolder_8h}{reMutexHolder.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightReMutexHolder_8h}{lightReMutexHolder.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullFaceAttrib_8h}{cullFaceAttrib.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{string__utils_8h}{string\_utils.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomCacheManager_8h}{geomCacheManager.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{transformState_8h}{transformState.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{thread_8h}{thread.h}}"{}}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pipeline_8h}{pipeline.h}}"{}}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{throw__event_8h}{throw\_event.h}}"{}}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamCache_8h}{bamCache.h}}"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullableObject_8h}{cullableObject.h}}"{}}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexArrayData_8h}{geomVertexArrayData.h}}"{}}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vertexDataSaveFile_8h}{vertexDataSaveFile.h}}"{}}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vertexDataBook_8h}{vertexDataBook.h}}"{}}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vertexDataPage_8h}{vertexDataPage.h}}"{}}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pgraph_8h}{config\_pgraph.h}}"{}}}
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{displayRegionCullCallbackData_8h}{displayRegionCullCallbackData.h}}"{}}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{displayRegionDrawCallbackData_8h}{displayRegionDrawCallbackData.h}}"{}}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{callbackGraphicsWindow_8h}{callbackGraphicsWindow.h}}"{}}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{depthTestAttrib_8h}{depthTestAttrib.h}}"{}}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{unionBoundingVolume_8h}{unionBoundingVolume.h}}"{}}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)\ \&\&\ defined(HAVE\_THREADS)\ \&\&\ defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00054\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{winInputDeviceManager_8h}{winInputDeviceManager.h}}"{}}}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)}}
\DoxyCodeLine{00058\ \textcolor{preprocessor}{\ \ \#define\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\ \ \#include\ <winsock2.h>}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\ \ \#include\ <wtypes.h>}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\ \ \#undef\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\ \ \#include\ <sys/time.h>}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \textcolor{preprocessor}{\#ifdef\ \_\_APPLE\_\_}}
\DoxyCodeLine{00067\ \textcolor{keyword}{extern}\ \textcolor{stringliteral}{"{}C"{}}\ \{}
\DoxyCodeLine{00068\ \ \ \textcolor{keywordtype}{void}\ *objc\_autoreleasePoolPush();}
\DoxyCodeLine{00069\ \ \ \textcolor{keywordtype}{void}\ objc\_autoreleasePoolPop(\textcolor{keywordtype}{void}\ *);}
\DoxyCodeLine{00070\ \};}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ PT(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}})\ GraphicsEngine::\_global\_ptr;}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_wait\_pcollector(\textcolor{stringliteral}{"{}Wait:Thread\ sync"{}});}
\DoxyCodeLine{00078\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cycle\_pcollector(\textcolor{stringliteral}{"{}App:Cycle"{}});}
\DoxyCodeLine{00079\ \textcolor{comment}{//PStatCollector\ GraphicsEngine::\_app\_pcollector("{}App:Show\ code:General"{});}}
\DoxyCodeLine{00080\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_render\_frame\_pcollector(\textcolor{stringliteral}{"{}App:render\_frame"{}});}
\DoxyCodeLine{00081\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_yield\_pcollector(\textcolor{stringliteral}{"{}App:Yield"{}});}
\DoxyCodeLine{00082\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cull\_pcollector(\textcolor{stringliteral}{"{}Cull"{}});}
\DoxyCodeLine{00083\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cull\_setup\_pcollector(\textcolor{stringliteral}{"{}Cull:Setup"{}});}
\DoxyCodeLine{00084\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cull\_sort\_pcollector(\textcolor{stringliteral}{"{}Cull:Sort"{}});}
\DoxyCodeLine{00085\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_draw\_pcollector(\textcolor{stringliteral}{"{}Draw"{}});}
\DoxyCodeLine{00086\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_sync\_pcollector(\textcolor{stringliteral}{"{}Draw:Sync"{}});}
\DoxyCodeLine{00087\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_flip\_pcollector(\textcolor{stringliteral}{"{}Wait:Flip"{}});}
\DoxyCodeLine{00088\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_transform\_states\_pcollector(\textcolor{stringliteral}{"{}TransformStates"{}});}
\DoxyCodeLine{00089\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_transform\_states\_unused\_pcollector(\textcolor{stringliteral}{"{}TransformStates:Unused"{}});}
\DoxyCodeLine{00090\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_render\_states\_pcollector(\textcolor{stringliteral}{"{}RenderStates"{}});}
\DoxyCodeLine{00091\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_render\_states\_unused\_pcollector(\textcolor{stringliteral}{"{}RenderStates:Unused"{}});}
\DoxyCodeLine{00092\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cyclers\_pcollector(\textcolor{stringliteral}{"{}PipelineCyclers"{}});}
\DoxyCodeLine{00093\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_dirty\_cyclers\_pcollector(\textcolor{stringliteral}{"{}PipelineCyclers:Dirty"{}});}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_sw\_sprites\_pcollector(\textcolor{stringliteral}{"{}SW\ Sprites"{}});}
\DoxyCodeLine{00097\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_small\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Small"{}});}
\DoxyCodeLine{00098\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_independent\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Independent"{}});}
\DoxyCodeLine{00099\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_pending\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Pending"{}});}
\DoxyCodeLine{00100\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_resident\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Resident"{}});}
\DoxyCodeLine{00101\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_compressed\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Compressed"{}});}
\DoxyCodeLine{00102\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_unused\_disk\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Disk:Unused"{}});}
\DoxyCodeLine{00103\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_vertex\_data\_used\_disk\_pcollector(\textcolor{stringliteral}{"{}Vertex\ Data:Disk:Used"{}});}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \textcolor{comment}{//\ These\ are\ counted\ independently\ by\ the\ collision\ system;\ we\ redefine\ them}}
\DoxyCodeLine{00106\ \textcolor{comment}{//\ here\ so\ we\ can\ reset\ them\ at\ each\ frame.}}
\DoxyCodeLine{00107\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_cnode\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionNode"{}});}
\DoxyCodeLine{00108\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_gnode\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:GeomNode"{}});}
\DoxyCodeLine{00109\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_geom\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:Geom"{}});}
\DoxyCodeLine{00110\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_node\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:PandaNode"{}});}
\DoxyCodeLine{00111\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionSolid"{}});}
\DoxyCodeLine{00112\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionSolid"{}});}
\DoxyCodeLine{00113\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_polygon\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionPolygon"{}});}
\DoxyCodeLine{00114\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_polygon\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionPolygon"{}});}
\DoxyCodeLine{00115\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_plane\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionPlane"{}});}
\DoxyCodeLine{00116\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_plane\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionPlane"{}});}
\DoxyCodeLine{00117\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_sphere\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionSphere"{}});}
\DoxyCodeLine{00118\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_sphere\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionSphere"{}});}
\DoxyCodeLine{00119\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_box\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionBox"{}});}
\DoxyCodeLine{00120\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_box\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionBox"{}});}
\DoxyCodeLine{00121\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_capsule\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionCapsule"{}});}
\DoxyCodeLine{00122\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_capsule\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionCapsule"{}});}
\DoxyCodeLine{00123\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_inv\_sphere\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionInvSphere"{}});}
\DoxyCodeLine{00124\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_inv\_sphere\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionInvSphere"{}});}
\DoxyCodeLine{00125\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_volume\_geom\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionGeom"{}});}
\DoxyCodeLine{00126\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_test\_geom\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionGeom"{}});}
\DoxyCodeLine{00127\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_occlusion\_untested\_pcollector(\textcolor{stringliteral}{"{}Occlusion\ results:Not\ tested"{}});}
\DoxyCodeLine{00128\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_occlusion\_passed\_pcollector(\textcolor{stringliteral}{"{}Occlusion\ results:Visible"{}});}
\DoxyCodeLine{00129\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_occlusion\_failed\_pcollector(\textcolor{stringliteral}{"{}Occlusion\ results:Occluded"{}});}
\DoxyCodeLine{00130\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ GraphicsEngine::\_occlusion\_tests\_pcollector(\textcolor{stringliteral}{"{}Occlusion\ tests"{}});}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \textcolor{comment}{//\ This\ is\ used\ to\ keep\ track\ of\ which\ scenes\ we\ have\ already\ culled.}}
\DoxyCodeLine{00133\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structCullKey}{CullKey}}\ \{}
\DoxyCodeLine{00134\ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *\_gsg;}
\DoxyCodeLine{00135\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ \_camera;}
\DoxyCodeLine{00136\ \ \ \textcolor{keywordtype}{int}\ \_lens\_index;}
\DoxyCodeLine{00137\ \};}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ INLINE\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ operator\ <\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{structCullKey}{CullKey}}\ \&a,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{structCullKey}{CullKey}}\ \&b)\ \{}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{if}\ (a.\_gsg\ !=\ b.\_gsg)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{return}\ a.\_gsg\ <\ b.\_gsg;}
\DoxyCodeLine{00142\ \ \ \}}
\DoxyCodeLine{00143\ \ \ \textcolor{keywordflow}{if}\ (a.\_camera\ !=\ b.\_camera)\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{keywordflow}{return}\ a.\_camera\ <\ b.\_camera;}
\DoxyCodeLine{00145\ \ \ \}}
\DoxyCodeLine{00146\ \ \ \textcolor{keywordflow}{return}\ a.\_lens\_index\ <\ b.\_lens\_index;}
\DoxyCodeLine{00147\ \}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00154\ GraphicsEngine::}
\DoxyCodeLine{00155\ GraphicsEngine(\mbox{\hyperlink{classClockObject}{ClockObject}}\ *clock,\ \mbox{\hyperlink{classPipeline}{Pipeline}}\ *pipeline)\ :}
\DoxyCodeLine{00156\ \ \ \_pipeline(pipeline),}
\DoxyCodeLine{00157\ \ \ \_clock(clock),}
\DoxyCodeLine{00158\ \ \ \_app(\textcolor{stringliteral}{"{}app"{}}),}
\DoxyCodeLine{00159\ \ \ \_lock(\textcolor{stringliteral}{"{}GraphicsEngine::\_lock"{}}),}
\DoxyCodeLine{00160\ \ \ \_loaded\_textures\_lock(\textcolor{stringliteral}{"{}GraphicsEngine::\_loaded\_textures\_lock"{}})}
\DoxyCodeLine{00161\ \{}
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{if}\ (\_pipeline\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \_pipeline\ =\ Pipeline::get\_render\_pipeline();}
\DoxyCodeLine{00164\ \ \ \}}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \_windows\_sorted\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00167\ \ \ \_window\_sort\_index\ =\ 0;}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ set\_threading\_model(\mbox{\hyperlink{classGraphicsThreadingModel}{GraphicsThreadingModel}}(threading\_model));}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{if}\ (!\_threading\_model.is\_default())\ \{}
\DoxyCodeLine{00171\ \ \ \ \ display\_cat.info()}
\DoxyCodeLine{00172\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Using\ threading\ model\ "{}}\ <<\ \_threading\_model\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00173\ \ \ \}}
\DoxyCodeLine{00174\ \ \ \_auto\_flip\ =\ auto\_flip;}
\DoxyCodeLine{00175\ \ \ \_portal\_enabled\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00176\ \ \ \_flip\_state\ =\ FS\_flip;}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \_singular\_warning\_last\_frame\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00179\ \ \ \_singular\_warning\_this\_frame\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00180\ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00186\ GraphicsEngine::}
\DoxyCodeLine{00187\ \string~GraphicsEngine()\ \{}
\DoxyCodeLine{00188\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{00189\ \ \ \textcolor{comment}{//if\ (\_app\_pcollector.is\_started())\ \{}}
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ \ \_app\_pcollector.stop();}}
\DoxyCodeLine{00191\ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{00192\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ remove\_all\_windows();}
\DoxyCodeLine{00195\ \}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00202\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{00203\ set\_threading\_model(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGraphicsThreadingModel}{GraphicsThreadingModel}}\ \&threading\_model)\ \{}
\DoxyCodeLine{00204\ \ \ \textcolor{keywordflow}{if}\ (!Thread::is\_threading\_supported())\ \{}
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{keywordflow}{if}\ (!threading\_model.is\_single\_threaded())\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Threading\ model\ "{}}\ <<\ threading\_model}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ requested\ but\ threading\ is\ not\ available.\ \ Ignoring.\(\backslash\)n"{}};}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00210\ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \textcolor{preprocessor}{\#ifndef\ THREADED\_PIPELINE}}
\DoxyCodeLine{00214\ \ \ \textcolor{keywordflow}{if}\ (!threading\_model.is\_single\_threaded())\ \{}
\DoxyCodeLine{00215\ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{00216\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Threading\ model\ "{}}\ <<\ threading\_model}
\DoxyCodeLine{00217\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ requested\ but\ multithreaded\ render\ pipelines\ not\ enabled\ in\ build.\(\backslash\)n"{}};}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keywordflow}{if}\ (!allow\_nonpipeline\_threads)\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Ignoring\ requested\ threading\ model.\(\backslash\)n"{}};}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00222\ \ \ \ \ \}}
\DoxyCodeLine{00223\ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{00224\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Danger!\ \ Creating\ requested\ render\ threads\ anyway!\(\backslash\)n"{}};}
\DoxyCodeLine{00225\ \ \ \}}
\DoxyCodeLine{00226\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ THREADED\_PIPELINE}}
\DoxyCodeLine{00227\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00228\ \ \ \_threading\_model\ =\ threading\_model;}
\DoxyCodeLine{00229\ \}}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00235\ \mbox{\hyperlink{classGraphicsThreadingModel}{GraphicsThreadingModel}}\ GraphicsEngine::}
\DoxyCodeLine{00236\ get\_threading\_model()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00237\ \ \ \mbox{\hyperlink{classGraphicsThreadingModel}{GraphicsThreadingModel}}\ result;}
\DoxyCodeLine{00238\ \ \ \{}
\DoxyCodeLine{00239\ \ \ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00240\ \ \ \ \ result\ =\ \_threading\_model;}
\DoxyCodeLine{00241\ \ \ \}}
\DoxyCodeLine{00242\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00243\ \}}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \textcolor{comment}{//\ THIS\ IS\ THE\ OLD\ CODE\ FOR\ make\_gsg\ PT(GraphicsStateGuardian)\ gsg\ =}}
\DoxyCodeLine{00246\ \textcolor{comment}{//\ pipe-\/>make\_gsg(properties,\ share\_with);}}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00261\ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *GraphicsEngine::}
\DoxyCodeLine{00262\ make\_output(\mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}}\ *pipe,}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name,\ \textcolor{keywordtype}{int}\ sort,}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFrameBufferProperties}{FrameBufferProperties}}\ \&fb\_prop,}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classWindowProperties}{WindowProperties}}\ \&win\_prop,}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags,}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *host)\ \{}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \textcolor{comment}{/*}}
\DoxyCodeLine{00271\ \textcolor{comment}{\ *\ The\ code\ here\ is\ tricky\ because\ the\ gsg\ that\ is\ passed\ in\ might\ be\ in\ the}}
\DoxyCodeLine{00272\ \textcolor{comment}{\ *\ uninitialized\ state.\ \ As\ a\ result,\ pipe::make\_output\ may\ not\ be\ able\ to}}
\DoxyCodeLine{00273\ \textcolor{comment}{\ *\ tell\ which\ DirectX\ capabilities\ or\ OpenGL\ extensions\ are\ supported\ and}}
\DoxyCodeLine{00274\ \textcolor{comment}{\ *\ which\ are\ not.\ \ Worse\ yet,\ it\ can't\ query\ the\ API,\ because\ that\ can\ only\ be}}
\DoxyCodeLine{00275\ \textcolor{comment}{\ *\ done\ from\ the\ draw\ thread,\ and\ this\ is\ the\ app\ thread.\ \ So\ here's\ the}}
\DoxyCodeLine{00276\ \textcolor{comment}{\ *\ workaround:\ this\ routine\ calls\ pipe::make\_output,\ which\ returns\ a\ "{}non-\/}}
\DoxyCodeLine{00277\ \textcolor{comment}{\ *\ certified"{}\ window.\ \ That\ means\ that\ the\ pipe\ doesn't\ promise\ that\ the\ draw}}
\DoxyCodeLine{00278\ \textcolor{comment}{\ *\ thread\ will\ actually\ succeed\ in\ initializing\ the\ window.\ \ This\ routine\ then}}
\DoxyCodeLine{00279\ \textcolor{comment}{\ *\ calls\ open\_windows,\ which\ attempts\ to\ initialize\ the\ window.\ \ If}}
\DoxyCodeLine{00280\ \textcolor{comment}{\ *\ open\_windows\ fails\ to\ initialize\ the\ window,\ then\ this\ routine\ will\ ask}}
\DoxyCodeLine{00281\ \textcolor{comment}{\ *\ pipe::make\_output\ to\ try\ again,\ this\ time\ using\ a\ different\ set\ of\ OpenGL}}
\DoxyCodeLine{00282\ \textcolor{comment}{\ *\ extensions\ or\ DirectX\ capabilities.\ \ \ This\ is\ what\ the\ "{}retry"{}\ parameter\ to}}
\DoxyCodeLine{00283\ \textcolor{comment}{\ *\ pipe::make\_output\ is\ for\ -\/\ it\ specifies,\ in\ an\ abstract\ manner,\ which\ set}}
\DoxyCodeLine{00284\ \textcolor{comment}{\ *\ of\ capabiltiesextensions\ to\ try.\ \ The\ only\ problem\ with\ this\ design\ is\ that}}
\DoxyCodeLine{00285\ \textcolor{comment}{\ *\ it\ requires\ the\ engine\ to\ call\ open\_windows,\ which\ is\ slow.\ \ To\ make\ things}}
\DoxyCodeLine{00286\ \textcolor{comment}{\ *\ faster,\ the\ pipe\ can\ choose\ to\ "{}precertify"{}\ its\ creations.\ \ If\ it\ chooses}}
\DoxyCodeLine{00287\ \textcolor{comment}{\ *\ to\ do\ so,\ this\ is\ a\ guarantee\ that\ the\ windows\ it\ returns\ will\ not\ fail\ in}}
\DoxyCodeLine{00288\ \textcolor{comment}{\ *\ open\_windows.\ \ However,\ most\ graphics\ pipes\ will\ only\ precertify\ if\ you}}
\DoxyCodeLine{00289\ \textcolor{comment}{\ *\ pass\ them\ an\ already-\/initialized\ gsg.\ \ Long\ story\ short,\ if\ you\ want}}
\DoxyCodeLine{00290\ \textcolor{comment}{\ *\ make\_output\ to\ be\ fast,\ use\ an\ already-\/initialized\ gsg.}}
\DoxyCodeLine{00291\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \ \ \textcolor{comment}{//\ Simplify\ the\ input\ parameters.}}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ 0,\ y\_size\ =\ 0;}
\DoxyCodeLine{00296\ \ \ \textcolor{keywordflow}{if}\ (win\_prop.has\_size())\ \{}
\DoxyCodeLine{00297\ \ \ \ \ x\_size\ =\ win\_prop.get\_x\_size();}
\DoxyCodeLine{00298\ \ \ \ \ y\_size\ =\ win\_prop.get\_y\_size();}
\DoxyCodeLine{00299\ \ \ \}}
\DoxyCodeLine{00300\ \ \ \textcolor{keywordflow}{if}\ ((x\_size\ ==\ 0)\&\&(y\_size\ ==\ 0))\ \{}
\DoxyCodeLine{00301\ \ \ \ \ flags\ |=\ GraphicsPipe::BF\_size\_track\_host;}
\DoxyCodeLine{00302\ \ \ \}}
\DoxyCodeLine{00303\ \ \ \textcolor{keywordflow}{if}\ (host\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00304\ \ \ \ \ host\ =\ host-\/>\mbox{\hyperlink{classGraphicsOutput_a9f426f4eafec2f5fc6d207a0828bab5d}{get\_host}}();}
\DoxyCodeLine{00305\ \ \ \}}
\DoxyCodeLine{00306\ }
\DoxyCodeLine{00307\ \ \ \textcolor{comment}{//\ If\ a\ gsg\ or\ host\ was\ supplied,\ and\ either\ is\ not\ yet\ initialized,\ then}}
\DoxyCodeLine{00308\ \ \ \textcolor{comment}{//\ call\ open\_windows\ to\ get\ both\ ready.\ \ If\ that\ fails,\ give\ up\ on\ using\ the}}
\DoxyCodeLine{00309\ \ \ \textcolor{comment}{//\ supplied\ gsg\ and\ host.}}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00311\ \ \ \textcolor{keywordflow}{if}\ (host\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((!gsg-\/>is\_valid())||(gsg-\/>needs\_reset()))\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ open\_windows();}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((!gsg-\/>is\_valid())||(gsg-\/>needs\_reset()))\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ gsg\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00319\ \ \ \ \ \}}
\DoxyCodeLine{00320\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keywordflow}{if}\ ((host-\/>get\_gsg()==\textcolor{keyword}{nullptr})||}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ (!host-\/>is\_valid())||}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ (!host-\/>get\_gsg()-\/>is\_valid())||}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ (host-\/>get\_gsg()-\/>needs\_reset()))\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \ \ open\_windows();}
\DoxyCodeLine{00326\ \ \ \ \ \}}
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keywordflow}{if}\ ((host-\/>get\_gsg()==\textcolor{keyword}{nullptr})||}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ (!host-\/>is\_valid())||}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ (!host-\/>get\_gsg()-\/>is\_valid())||}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ (host-\/>get\_gsg()-\/>needs\_reset()))\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \ \ host\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00332\ \ \ \ \ \ \ gsg\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00333\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00334\ \ \ \ \ \ \ gsg\ =\ host-\/>get\_gsg();}
\DoxyCodeLine{00335\ \ \ \ \ \}}
\DoxyCodeLine{00336\ \ \ \}}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \textcolor{comment}{//\ Sanity\ check\ everything.}}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ nassertr(pipe\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00341\ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00342\ \ \ \ \ nassertr(pipe\ ==\ gsg-\/>get\_pipe(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{comment}{//nassertr(this\ ==\ gsg-\/>get\_engine(),\ nullptr);}}
\DoxyCodeLine{00344\ \ \ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \textcolor{comment}{//\ Are\ we\ really\ asking\ for\ a\ callback\ window?}}
\DoxyCodeLine{00347\ \ \ \textcolor{keywordflow}{if}\ ((flags\ \&\ GraphicsPipe::BF\_require\_callback\_window)!=0)\ \{}
\DoxyCodeLine{00348\ \ \ \ \ PT(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}})\ this\_gsg\ =\ gsg;}
\DoxyCodeLine{00349\ \ \ \ \ \textcolor{keywordflow}{if}\ (this\_gsg\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ already\ have\ a\ GSG,\ we\ have\ to\ ask\ the\ pipe\ to\ make\ a\ new}}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \textcolor{comment}{//\ one,\ unencumbered\ by\ window\ dressing.}}
\DoxyCodeLine{00352\ \ \ \ \ \ \ this\_gsg\ =\ pipe-\/>make\_callback\_gsg(\textcolor{keyword}{this});}
\DoxyCodeLine{00353\ \ \ \ \ \}}
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{keywordflow}{if}\ (this\_gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \mbox{\hyperlink{classCallbackGraphicsWindow}{CallbackGraphicsWindow}}\ *window\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCallbackGraphicsWindow}{CallbackGraphicsWindow}}(\textcolor{keyword}{this},\ pipe,\ name,\ fb\_prop,\ win\_prop,\ flags,\ this\_gsg);}
\DoxyCodeLine{00356\ \ \ \ \ \ \ window-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00357\ \ \ \ \ \ \ do\_add\_window(window);}
\DoxyCodeLine{00358\ \ \ \ \ \ \ do\_add\_gsg(window-\/>get\_gsg(),\ pipe);}
\DoxyCodeLine{00359\ \ \ \ \ \ \ display\_cat.info()\ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ CallbackGraphicsWindow\(\backslash\)n"{}};}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ window;}
\DoxyCodeLine{00361\ \ \ \ \ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ \ \ \textcolor{comment}{//\ Couldn't\ make\ a\ callback\ window,\ because\ the\ pipe\ wouldn't\ make\ an}}
\DoxyCodeLine{00364\ \ \ \ \ \textcolor{comment}{//\ unencumbered\ GSG.}}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00366\ \ \ \}}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \textcolor{comment}{//\ Determine\ if\ a\ parasite\ buffer\ meets\ the\ user's\ specs.}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \textcolor{keywordtype}{bool}\ can\_use\_parasite\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00371\ \ \ \textcolor{keywordflow}{if}\ ((host\ !=\ \textcolor{keyword}{nullptr})\&\&}
\DoxyCodeLine{00372\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_require\_window)==0)\&\&}
\DoxyCodeLine{00373\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_require\_callback\_window)==0)\&\&}
\DoxyCodeLine{00374\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_refuse\_parasite)==0)\&\&}
\DoxyCodeLine{00375\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_can\_bind\_color)==0)\&\&}
\DoxyCodeLine{00376\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_can\_bind\_every)==0)\&\&}
\DoxyCodeLine{00377\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_rtt\_cumulative)==0)\&\&}
\DoxyCodeLine{00378\ \ \ \ \ \ \ ((flags\&GraphicsPipe::BF\_can\_bind\_layered)==0))\ \{}
\DoxyCodeLine{00379\ \ \ \ \ \textcolor{keywordflow}{if}\ ((flags\&GraphicsPipe::BF\_fb\_props\_optional)\ ||}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ (host-\/>get\_fb\_properties().subsumes(fb\_prop)))\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \ \ can\_use\_parasite\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00382\ \ \ \ \ \}}
\DoxyCodeLine{00383\ \ \ \}}
\DoxyCodeLine{00384\ }
\DoxyCodeLine{00385\ \ \ \textcolor{comment}{//\ If\ parasite\ buffers\ are\ preferred,\ then\ try\ a\ parasite\ first.\ \ Even\ if}}
\DoxyCodeLine{00386\ \ \ \textcolor{comment}{//\ prefer-\/parasite-\/buffer\ is\ set,\ parasites\ are\ not\ preferred\ if\ the\ host}}
\DoxyCodeLine{00387\ \ \ \textcolor{comment}{//\ window\ is\ too\ small,\ or\ if\ the\ host\ window\ does\ not\ have\ the\ requested}}
\DoxyCodeLine{00388\ \ \ \textcolor{comment}{//\ properties.}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \ \ \textcolor{keywordflow}{if}\ ((prefer\_parasite\_buffer)\ \&\&}
\DoxyCodeLine{00391\ \ \ \ \ \ \ (can\_use\_parasite)\ \&\&}
\DoxyCodeLine{00392\ \ \ \ \ \ \ (x\_size\ <=\ host-\/>get\_x\_size())\&\&}
\DoxyCodeLine{00393\ \ \ \ \ \ \ (y\_size\ <=\ host-\/>get\_y\_size())\&\&}
\DoxyCodeLine{00394\ \ \ \ \ \ \ (host-\/>get\_fb\_properties().subsumes(fb\_prop)))\ \{}
\DoxyCodeLine{00395\ \ \ \ \ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}\ *buffer\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}(host,\ name,\ x\_size,\ y\_size,\ flags);}
\DoxyCodeLine{00396\ \ \ \ \ buffer-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00397\ \ \ \ \ do\_add\_window(buffer);}
\DoxyCodeLine{00398\ \ \ \ \ do\_add\_gsg(host-\/>get\_gsg(),\ pipe);}
\DoxyCodeLine{00399\ \ \ \ \ display\_cat.info()\ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ ParasiteBuffer\(\backslash\)n"{}};}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{keywordflow}{return}\ buffer;}
\DoxyCodeLine{00401\ \ \ \}}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00403\ \ \ \textcolor{comment}{//\ If\ force-\/parasite-\/buffer\ is\ set,\ we\ create\ a\ parasite\ buffer\ even\ if\ it's}}
\DoxyCodeLine{00404\ \ \ \textcolor{comment}{//\ less\ than\ ideal.\ \ You\ might\ set\ this\ if\ you\ really\ don't\ trust\ your}}
\DoxyCodeLine{00405\ \ \ \textcolor{comment}{//\ graphics\ driver's\ support\ for\ offscreen\ buffers.}}
\DoxyCodeLine{00406\ \ \ \textcolor{keywordflow}{if}\ (force\_parasite\_buffer\ \&\&\ can\_use\_parasite)\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}\ *buffer\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}(host,\ name,\ x\_size,\ y\_size,\ flags);}
\DoxyCodeLine{00408\ \ \ \ \ buffer-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00409\ \ \ \ \ do\_add\_window(buffer);}
\DoxyCodeLine{00410\ \ \ \ \ do\_add\_gsg(host-\/>get\_gsg(),\ pipe);}
\DoxyCodeLine{00411\ \ \ \ \ display\_cat.info()\ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ ParasiteBuffer\(\backslash\)n"{}};}
\DoxyCodeLine{00412\ \ \ \ \ \textcolor{keywordflow}{return}\ buffer;}
\DoxyCodeLine{00413\ \ \ \}}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \textcolor{comment}{//\ Ask\ the\ pipe\ to\ create\ a\ window.}}
\DoxyCodeLine{00416\ }
\DoxyCodeLine{00417\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ retry=0;\ retry<10;\ retry++)\ \{}
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{keywordtype}{bool}\ precertify\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00419\ \ \ \ \ PT(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}})\ window\ =}
\DoxyCodeLine{00420\ \ \ \ \ \ \ pipe-\/>make\_output(name,\ fb\_prop,\ win\_prop,\ flags,\ \textcolor{keyword}{this},\ gsg,\ host,\ retry,\ precertify);}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{keywordflow}{if}\ (window\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00422\ \ \ \ \ \ \ window-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (precertify\ \&\&\ gsg\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ window-\/>get\_gsg()\ ==\ gsg)\ \{}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ do\_add\_window(window);}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \ \ display\_cat.info()}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ "{}}\ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ window;}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00429\ \ \ \ \ \ \ do\_add\_window(window);}
\DoxyCodeLine{00430\ \ \ \ \ \ \ open\_windows();}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (window-\/>is\_valid())\ \{}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ display\_cat.info()}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ "{}}\ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (window-\/>get\_fb\_properties().subsumes(fb\_prop))\ \{}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ window;}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (flags\ \&\ GraphicsPipe::BF\_fb\_props\_optional)\ \{}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}FrameBufferProperties\ available\ less\ than\ requested.\(\backslash\)n"{}};}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \ \ \ \ display\_cat.warning(\textcolor{keyword}{false})}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ requested:\ "{}}\ <<\ fb\_prop\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}}}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ got:\ "{}}\ <<\ window-\/>get\_fb\_properties()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ window;}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ get\ requested\ FrameBufferProperties;\ abandoning\ window.\(\backslash\)n"{}};}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ \ \ display\_cat.error(\textcolor{keyword}{false})}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ requested:\ "{}}\ <<\ fb\_prop\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}}}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ got:\ "{}}\ <<\ window-\/>get\_fb\_properties()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ display\_cat.info()}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \ \ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\ wouldn't\ open;\ abandoning.\(\backslash\)n"{}};}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ display\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ requested:\ "{}}\ <<\ fb\_prop\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ good;\ delete\ the\ window\ and\ keep\ trying.}}
\DoxyCodeLine{00460\ \ \ \ \ \ \ remove\_window(window);}
\DoxyCodeLine{00461\ \ \ \ \ \}}
\DoxyCodeLine{00462\ \ \ \}}
\DoxyCodeLine{00463\ }
\DoxyCodeLine{00464\ \ \ \textcolor{comment}{//\ Parasite\ buffers\ were\ not\ preferred,\ but\ the\ pipe\ could\ not\ create\ a}}
\DoxyCodeLine{00465\ \ \ \textcolor{comment}{//\ window\ to\ the\ user's\ specs.\ \ Try\ a\ parasite\ as\ a\ last\ hope.}}
\DoxyCodeLine{00466\ }
\DoxyCodeLine{00467\ \ \ \textcolor{keywordflow}{if}\ (can\_use\_parasite)\ \{}
\DoxyCodeLine{00468\ \ \ \ \ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}\ *buffer\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classParasiteBuffer}{ParasiteBuffer}}(host,\ name,\ x\_size,\ y\_size,\ flags);}
\DoxyCodeLine{00469\ \ \ \ \ buffer-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00470\ \ \ \ \ do\_add\_window(buffer);}
\DoxyCodeLine{00471\ \ \ \ \ do\_add\_gsg(host-\/>get\_gsg(),\ pipe);}
\DoxyCodeLine{00472\ \ \ \ \ display\_cat.info()\ <<\ \textcolor{stringliteral}{"{}Created\ output\ of\ type\ ParasiteBuffer\(\backslash\)n"{}};}
\DoxyCodeLine{00473\ \ \ \ \ \textcolor{keywordflow}{return}\ buffer;}
\DoxyCodeLine{00474\ \ \ \}}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \ \ \textcolor{comment}{//\ Could\ not\ create\ a\ window\ to\ the\ user's\ specs.}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00479\ \}}
\DoxyCodeLine{00480\ }
\DoxyCodeLine{00493\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{00494\ add\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window,\ \textcolor{keywordtype}{int}\ sort)\ \{}
\DoxyCodeLine{00495\ \ \ nassertr(window\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00496\ \ \ nassertr(\textcolor{keyword}{this}\ ==\ window-\/>get\_engine(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00497\ }
\DoxyCodeLine{00498\ \ \ window-\/>\_sort\ =\ sort;}
\DoxyCodeLine{00499\ \ \ do\_add\_window(window);}
\DoxyCodeLine{00500\ }
\DoxyCodeLine{00501\ \ \ display\_cat.info()}
\DoxyCodeLine{00502\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Added\ output\ of\ type\ "{}}\ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00505\ \}}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00524\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{00525\ remove\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window)\ \{}
\DoxyCodeLine{00526\ \ \ nassertr(window\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00527\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00528\ }
\DoxyCodeLine{00529\ \ \ \textcolor{comment}{//\ First,\ make\ sure\ we\ know\ what\ this\ window\ is.}}
\DoxyCodeLine{00530\ \ \ PT(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}})\ ptwin\ =\ window;}
\DoxyCodeLine{00531\ \ \ \textcolor{keywordtype}{size\_t}\ count;}
\DoxyCodeLine{00532\ \ \ \{}
\DoxyCodeLine{00533\ \ \ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{00534\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_windows\_sorted)\ \{}
\DoxyCodeLine{00535\ \ \ \ \ \ \ do\_resort\_windows();}
\DoxyCodeLine{00536\ \ \ \ \ \}}
\DoxyCodeLine{00537\ \ \ \ \ count\ =\ \_windows.erase(ptwin);}
\DoxyCodeLine{00538\ \ \ \}}
\DoxyCodeLine{00539\ }
\DoxyCodeLine{00540\ \ \ \textcolor{comment}{//\ Also\ check\ whether\ it\ is\ in\ \_new\_windows.}}
\DoxyCodeLine{00541\ \ \ \{}
\DoxyCodeLine{00542\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ new\_windows\_holder(\_new\_windows\_lock,\ current\_thread);}
\DoxyCodeLine{00543\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ old\_size\ =\ \_new\_windows.size();}
\DoxyCodeLine{00544\ \ \ \ \ \_new\_windows.erase(std::remove(\_new\_windows.begin(),\ \_new\_windows.end(),\ ptwin),\ \_new\_windows.end());}
\DoxyCodeLine{00545\ \ \ \ \ \textcolor{keywordflow}{if}\ (count\ ==\ 0\ \&\&\ \_new\_windows.size()\ <\ old\_size)\ \{}
\DoxyCodeLine{00546\ \ \ \ \ \ \ count\ =\ 1;}
\DoxyCodeLine{00547\ \ \ \ \ \}}
\DoxyCodeLine{00548\ \ \ \}}
\DoxyCodeLine{00549\ }
\DoxyCodeLine{00550\ \ \ \textcolor{keywordflow}{if}\ (count\ ==\ 0)\ \{}
\DoxyCodeLine{00551\ \ \ \ \ \textcolor{comment}{//\ Never\ heard\ of\ this\ window.\ \ Do\ nothing.}}
\DoxyCodeLine{00552\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00553\ \ \ \}}
\DoxyCodeLine{00554\ }
\DoxyCodeLine{00555\ \ \ do\_remove\_window(window,\ current\_thread);}
\DoxyCodeLine{00556\ }
\DoxyCodeLine{00557\ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ window-\/>get\_gsg();}
\DoxyCodeLine{00558\ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00559\ \ \ \ \ \mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *pgo\ =\ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a0bd3956b368e215ca2b75cfb20da7dfd}{get\_prepared\_objects}}();}
\DoxyCodeLine{00560\ \ \ \ \ \textcolor{keywordflow}{if}\ (pgo\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ to\ see\ if\ any\ other\ still-\/active\ windows\ share\ this\ context.}}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ any\_common\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \{}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_windows.begin();\ wi\ !=\ \_windows.end()\ \&\&\ !any\_common;\ ++wi)\ \{}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg2\ =\ (*wi)-\/>\mbox{\hyperlink{classGraphicsStateGuardianBase_aa5cb7468a2b7974197fca2c5dbe654fe}{get\_gsg}}();}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg2\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gsg2-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a0bd3956b368e215ca2b75cfb20da7dfd}{get\_prepared\_objects}}()\ ==\ pgo)\ \{}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \ \ \ \ \ \ any\_common\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00572\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!any\_common)\ \{}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ no\ windows\ still\ use\ this\ context,\ release\ all\ textures,\ etc.}}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ do\ this\ in\ case\ there\ is\ a\ floating\ pointer\ somewhere\ keeping}}
\DoxyCodeLine{00577\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ GSG\ from\ destructing\ when\ its\ window\ goes\ away.\ \ A\ leaked\ GSG}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ pointer\ is\ bad\ enough,\ but\ there's\ no\ reason\ we\ also\ need\ to\ keep}}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ around\ all\ of\ the\ objects\ allocated\ on\ graphics\ memory.}}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \ \ pgo-\/>release\_all();}
\DoxyCodeLine{00581\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00582\ \ \ \ \ \}}
\DoxyCodeLine{00583\ \ \ \}}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \ \ nassertr(count\ ==\ 1,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00586\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00587\ \}}
\DoxyCodeLine{00588\ }
\DoxyCodeLine{00593\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{00594\ remove\_all\_windows()\ \{}
\DoxyCodeLine{00595\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00596\ }
\DoxyCodeLine{00597\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{00598\ }
\DoxyCodeLine{00599\ \ \ \textcolor{comment}{//\ Let's\ move\ the\ \_windows\ vector\ into\ a\ local\ copy\ first,\ and\ walk\ through}}
\DoxyCodeLine{00600\ \ \ \textcolor{comment}{//\ that\ local\ copy,\ just\ in\ case\ someone\ we\ call\ during\ the\ loop\ attempts\ to}}
\DoxyCodeLine{00601\ \ \ \textcolor{comment}{//\ modify\ \_windows.\ \ I\ don't\ know\ what\ code\ would\ be\ doing\ this,\ but\ it}}
\DoxyCodeLine{00602\ \ \ \textcolor{comment}{//\ appeared\ to\ be\ happening,\ and\ this\ worked\ around\ it.}}
\DoxyCodeLine{00603\ \ \ Windows\ old\_windows;}
\DoxyCodeLine{00604\ \ \ old\_windows.swap(\_windows);}
\DoxyCodeLine{00605\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ :\ old\_windows)\ \{}
\DoxyCodeLine{00606\ \ \ \ \ nassertv(win\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00607\ \ \ \ \ do\_remove\_window(win,\ current\_thread);}
\DoxyCodeLine{00608\ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>\mbox{\hyperlink{classGraphicsStateGuardianBase_aa5cb7468a2b7974197fca2c5dbe654fe}{get\_gsg}}();}
\DoxyCodeLine{00609\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00610\ \ \ \ \ \ \ gsg-\/>release\_all();}
\DoxyCodeLine{00611\ \ \ \ \ \}}
\DoxyCodeLine{00612\ \ \ \}}
\DoxyCodeLine{00613\ }
\DoxyCodeLine{00614\ \ \ \{}
\DoxyCodeLine{00615\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ new\_windows\_holder(\_new\_windows\_lock,\ current\_thread);}
\DoxyCodeLine{00616\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ :\ \_new\_windows)\ \{}
\DoxyCodeLine{00617\ \ \ \ \ \ \ nassertv(win\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00618\ \ \ \ \ \ \ do\_remove\_window(win,\ current\_thread);}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>\mbox{\hyperlink{classGraphicsStateGuardianBase_aa5cb7468a2b7974197fca2c5dbe654fe}{get\_gsg}}();}
\DoxyCodeLine{00620\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ gsg-\/>release\_all();}
\DoxyCodeLine{00622\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00623\ \ \ \ \ \}}
\DoxyCodeLine{00624\ \ \ \ \ \_new\_windows.clear();}
\DoxyCodeLine{00625\ \ \ \}}
\DoxyCodeLine{00626\ }
\DoxyCodeLine{00627\ \ \ \_app.do\_close(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{00628\ \ \ \_app.do\_pending(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{00629\ \ \ terminate\_threads(current\_thread);}
\DoxyCodeLine{00630\ }
\DoxyCodeLine{00631\ \ \ \textcolor{comment}{//\ It\ seems\ a\ safe\ assumption\ that\ we're\ about\ to\ exit\ the\ application\ or}}
\DoxyCodeLine{00632\ \ \ \textcolor{comment}{//\ otherwise\ shut\ down\ Panda.\ \ Although\ it's\ a\ bit\ of\ a\ hack,\ since\ it's\ not}}
\DoxyCodeLine{00633\ \ \ \textcolor{comment}{//\ really\ related\ to\ removing\ windows,\ this\ would\ nevertheless\ be\ a\ fine}}
\DoxyCodeLine{00634\ \ \ \textcolor{comment}{//\ time\ to\ ensure\ the\ model\ cache\ (if\ any)\ has\ been\ flushed\ to\ disk.}}
\DoxyCodeLine{00635\ \ \ BamCache::flush\_global\_index();}
\DoxyCodeLine{00636\ }
\DoxyCodeLine{00637\ \ \ \textcolor{comment}{//\ And,\ hey,\ let's\ stop\ the\ vertex\ paging\ threads,\ if\ any.}}
\DoxyCodeLine{00638\ \ \ VertexDataPage::stop\_threads();}
\DoxyCodeLine{00639\ }
\DoxyCodeLine{00640\ \ \ \textcolor{comment}{//\ Stopping\ the\ tasks\ means\ we\ have\ to\ release\ the\ Python\ GIL\ while}}
\DoxyCodeLine{00641\ \ \ \textcolor{comment}{//\ this\ method\ runs\ (hence\ it\ is\ marked\ BLOCKING),\ so\ that\ any}}
\DoxyCodeLine{00642\ \ \ \textcolor{comment}{//\ Python\ tasks\ on\ other\ threads\ won't\ deadlock\ grabbing\ the\ GIL.}}
\DoxyCodeLine{00643\ \ \ AsyncTaskManager::get\_global\_ptr()-\/>stop\_threads();}
\DoxyCodeLine{00644\ }
\DoxyCodeLine{00645\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{00646\ \ \ PStatClient::get\_global\_pstats()-\/>disconnect();}
\DoxyCodeLine{00647\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)\ \&\&\ defined(HAVE\_THREADS)\ \&\&\ defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00650\ \ \ \textcolor{comment}{//\ Send\ a\ message\ to\ the\ input\ message\ pump\ asking\ it\ to\ shut\ itself\ down.}}
\DoxyCodeLine{00651\ \ \ \textcolor{comment}{//\ If\ we\ don't\ do\ that,\ the\ next\ call\ will\ deadlock.}}
\DoxyCodeLine{00652\ \ \ WinInputDeviceManager::stop\_thread();}
\DoxyCodeLine{00653\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00655\ \ \ \textcolor{comment}{//\ Well,\ and\ why\ not\ clean\ up\ all\ threads\ here?}}
\DoxyCodeLine{00656\ \ \ Thread::prepare\_for\_exit();}
\DoxyCodeLine{00657\ \}}
\DoxyCodeLine{00658\ }
\DoxyCodeLine{00664\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{00665\ reset\_all\_windows(\textcolor{keywordtype}{bool}\ swapchain)\ \{}
\DoxyCodeLine{00666\ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{00667\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_windows.begin();\ wi\ !=\ \_windows.end();\ ++wi)\ \{}
\DoxyCodeLine{00668\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{00669\ \ \ \ \ \textcolor{comment}{//\ if\ (win-\/>is\_active())}}
\DoxyCodeLine{00670\ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a9eb942071e2b60dd0c8e66a49d67685c}{reset\_window}}(swapchain);}
\DoxyCodeLine{00671\ \ \ \}}
\DoxyCodeLine{00672\ \}}
\DoxyCodeLine{00673\ }
\DoxyCodeLine{00678\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{00679\ is\_empty()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00680\ \ \ \textcolor{keywordflow}{return}\ \_windows.empty();}
\DoxyCodeLine{00681\ \}}
\DoxyCodeLine{00682\ }
\DoxyCodeLine{00686\ \textcolor{keywordtype}{int}\ GraphicsEngine::}
\DoxyCodeLine{00687\ get\_num\_windows()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00688\ \ \ \textcolor{keywordflow}{return}\ \_windows.size();}
\DoxyCodeLine{00689\ \}}
\DoxyCodeLine{00690\ }
\DoxyCodeLine{00694\ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *GraphicsEngine::}
\DoxyCodeLine{00695\ get\_window(\textcolor{keywordtype}{int}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00696\ \ \ nassertr(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})\_windows.size(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00697\ }
\DoxyCodeLine{00698\ \ \ \textcolor{keywordflow}{if}\ (!\_windows\_sorted)\ \{}
\DoxyCodeLine{00699\ \ \ \ \ ((\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *)\textcolor{keyword}{this})-\/>do\_resort\_windows();}
\DoxyCodeLine{00700\ \ \ \}}
\DoxyCodeLine{00701\ \ \ \textcolor{keywordflow}{return}\ \_windows[n];}
\DoxyCodeLine{00702\ \}}
\DoxyCodeLine{00703\ }
\DoxyCodeLine{00708\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{00709\ render\_frame()\ \{}
\DoxyCodeLine{00710\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00711\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ public\_holder(\_public\_lock);}
\DoxyCodeLine{00712\ }
\DoxyCodeLine{00713\ \ \ \textcolor{comment}{//\ Since\ this\ gets\ called\ every\ frame,\ we\ should\ take\ advantage\ of\ the}}
\DoxyCodeLine{00714\ \ \ \textcolor{comment}{//\ opportunity\ to\ flush\ the\ cache\ if\ necessary.}}
\DoxyCodeLine{00715\ \ \ BamCache::consider\_flush\_global\_index();}
\DoxyCodeLine{00716\ }
\DoxyCodeLine{00717\ \ \ \textcolor{comment}{//\ Anything\ that\ happens\ outside\ of\ GraphicsEngine::render\_frame()\ is\ deemed}}
\DoxyCodeLine{00718\ \ \ \textcolor{comment}{//\ to\ be\ App.}}
\DoxyCodeLine{00719\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{00720\ \ \ \_render\_frame\_pcollector.start();}
\DoxyCodeLine{00721\ \ \ \textcolor{comment}{//if\ (\_app\_pcollector.is\_started())\ \{}}
\DoxyCodeLine{00722\ \ \ \textcolor{comment}{//\ \ \_app\_pcollector.stop();}}
\DoxyCodeLine{00723\ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{00724\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00725\ }
\DoxyCodeLine{00726\ \ \ \textcolor{comment}{//\ Make\ sure\ our\ buffers\ and\ windows\ are\ fully\ realized\ before\ we\ render\ a}}
\DoxyCodeLine{00727\ \ \ \textcolor{comment}{//\ frame.\ \ We\ do\ this\ particularly\ to\ realize\ our\ offscreen\ buffers,\ so}}
\DoxyCodeLine{00728\ \ \ \textcolor{comment}{//\ that\ we\ don't\ render\ a\ frame\ before\ the\ offscreen\ buffers\ are\ ready}}
\DoxyCodeLine{00729\ \ \ \textcolor{comment}{//\ (which\ might\ result\ in\ a\ frame\ going\ by\ without\ some\ textures\ having}}
\DoxyCodeLine{00730\ \ \ \textcolor{comment}{//\ been\ rendered).}}
\DoxyCodeLine{00731\ \ \ open\_windows();}
\DoxyCodeLine{00732\ }
\DoxyCodeLine{00733\ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{00734\ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{00735\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}render\_frame()\ -\/\ frame\ "{}}\ <<\ \_clock-\/>get\_frame\_count()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00736\ \ \ \}}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \{}
\DoxyCodeLine{00739\ \ \ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_windows\_sorted)\ \{}
\DoxyCodeLine{00742\ \ \ \ \ \ \ do\_resort\_windows();}
\DoxyCodeLine{00743\ \ \ \ \ \}}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00745\ \ \ \ \ \textcolor{keywordflow}{if}\ (sync\_flip\ \&\&\ \_flip\_state\ !=\ FS\_flip)\ \{}
\DoxyCodeLine{00746\ \ \ \ \ \ \ do\_flip\_frame(current\_thread);}
\DoxyCodeLine{00747\ \ \ \ \ \}}
\DoxyCodeLine{00748\ }
\DoxyCodeLine{00749\ \ \ \ \ \textcolor{comment}{//\ Are\ any\ of\ the\ windows\ ready\ to\ be\ deleted?}}
\DoxyCodeLine{00750\ \ \ \ \ Windows\ new\_windows;}
\DoxyCodeLine{00751\ \ \ \ \ new\_windows.reserve(\_windows.size());}
\DoxyCodeLine{00752\ \ \ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{00753\ \ \ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_windows.begin();\ wi\ !=\ \_windows.end();\ ++wi)\ \{}
\DoxyCodeLine{00754\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{00755\ \ \ \ \ \ \ nassertv(win\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00756\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a5b7fd5e7eba6d10faa8f44271ab381e7}{get\_delete\_flag}}())\ \{}
\DoxyCodeLine{00757\ \ \ \ \ \ \ \ \ do\_remove\_window(win,\ current\_thread);}
\DoxyCodeLine{00758\ }
\DoxyCodeLine{00759\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \ \ new\_windows.push\_back(win);}
\DoxyCodeLine{00761\ }
\DoxyCodeLine{00762\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Let's\ calculate\ each\ scene's\ bounding\ volume\ here\ in\ App,\ before\ we}}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cycle\ the\ pipeline.\ \ The\ cull\ traversal\ will\ calculate\ it\ anyway,}}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ but\ if\ we\ calculate\ it\ in\ App\ first\ before\ it\ gets\ calculated\ in}}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ Cull\ thread,\ it\ will\ be\ more\ likely\ to\ stick\ for\ subsequent}}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ frames,\ so\ we\ won't\ have\ to\ recompute\ it\ each\ frame.}}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_drs\ =\ win-\/>get\_num\_active\_display\_regions();}
\DoxyCodeLine{00768\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_drs;\ ++i)\ \{}
\DoxyCodeLine{00769\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDisplayRegion}{DisplayRegion}})\ dr\ =\ win-\/>get\_active\_display\_region(i);}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ camera\_np\ =\ dr-\/>get\_camera(current\_thread);}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!camera\_np.is\_empty())\ \{}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCamera}{Camera}}\ *camera\ =\ DCAST(\mbox{\hyperlink{classCamera}{Camera}},\ camera\_np.node());}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ scene\ =\ camera-\/>get\_scene();}
\DoxyCodeLine{00775\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (scene.is\_empty())\ \{}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scene\ =\ camera\_np.get\_top(current\_thread);}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!scene.is\_empty())\ \{}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scene.get\_bounds(current\_thread);}
\DoxyCodeLine{00780\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00781\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00782\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00783\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00784\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00785\ \ \ \ \ \}}
\DoxyCodeLine{00786\ \ \ \ \ \_windows\ =\ std::move(new\_windows);}
\DoxyCodeLine{00787\ }
\DoxyCodeLine{00788\ \ \ \ \ \textcolor{comment}{//\ Go\ ahead\ and\ release\ any\ textures'\ ram\ images\ for\ textures\ that\ were}}
\DoxyCodeLine{00789\ \ \ \ \ \textcolor{comment}{//\ drawn\ in\ the\ previous\ frame.}}
\DoxyCodeLine{00790\ \ \ \ \ \{}
\DoxyCodeLine{00791\ \ \ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder2(\_loaded\_textures\_lock);}
\DoxyCodeLine{00792\ \ \ \ \ \ \ LoadedTextures::iterator\ lti;}
\DoxyCodeLine{00793\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (lti\ =\ \_loaded\_textures.begin();\ lti\ !=\ \_loaded\_textures.end();\ ++lti)\ \{}
\DoxyCodeLine{00794\ \ \ \ \ \ \ \ \ LoadedTexture\ \&lt\ =\ (*lti);}
\DoxyCodeLine{00795\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lt.\_tex-\/>get\_image\_modified()\ ==\ lt.\_image\_modified)\ \{}
\DoxyCodeLine{00796\ \ \ \ \ \ \ \ \ \ \ lt.\_tex-\/>texture\_uploaded();}
\DoxyCodeLine{00797\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00798\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00799\ \ \ \ \ \ \ \_loaded\_textures.clear();}
\DoxyCodeLine{00800\ \ \ \ \ \}}
\DoxyCodeLine{00801\ }
\DoxyCodeLine{00802\ \ \ \ \ \textcolor{comment}{//\ Now\ it's\ time\ to\ do\ any\ drawing\ from\ the\ main\ frame-\/-\/after\ all\ of\ the}}
\DoxyCodeLine{00803\ \ \ \ \ \textcolor{comment}{//\ App\ code\ has\ executed,\ but\ before\ we\ begin\ the\ next\ frame.}}
\DoxyCodeLine{00804\ \ \ \ \ \_app.do\_frame(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{00805\ }
\DoxyCodeLine{00806\ \ \ \ \ \textcolor{comment}{//\ Grab\ each\ thread's\ mutex\ again\ after\ all\ windows\ have\ flipped,\ and\ wait}}
\DoxyCodeLine{00807\ \ \ \ \ \textcolor{comment}{//\ for\ the\ thread\ to\ finish.}}
\DoxyCodeLine{00808\ \ \ \ \ \{}
\DoxyCodeLine{00809\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_wait\_pcollector,\ current\_thread);}
\DoxyCodeLine{00810\ \ \ \ \ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{00811\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{00812\ \ \ \ \ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{00813\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{00814\ }
\DoxyCodeLine{00815\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (thread-\/>\_thread\_state\ !=\ TS\_wait)\ \{}
\DoxyCodeLine{00816\ \ \ \ \ \ \ \ \ \ \ thread-\/>\_cv\_done.wait();}
\DoxyCodeLine{00817\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00818\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00819\ \ \ \ \ \}}
\DoxyCodeLine{00820\ }
\DoxyCodeLine{00821\ \textcolor{preprocessor}{\#if\ defined(THREADED\_PIPELINE)\ \&\&\ defined(DO\_PSTATS)}}
\DoxyCodeLine{00822\ \ \ \ \ \_cyclers\_pcollector.set\_level(\_pipeline-\/>get\_num\_cyclers());}
\DoxyCodeLine{00823\ \ \ \ \ \_dirty\_cyclers\_pcollector.set\_level(\_pipeline-\/>get\_num\_dirty\_cyclers());}
\DoxyCodeLine{00824\ }
\DoxyCodeLine{00825\ \textcolor{preprocessor}{\#ifdef\ DEBUG\_THREADS}}
\DoxyCodeLine{00826\ \ \ \ \ \textcolor{keywordflow}{if}\ (PStatClient::is\_connected())\ \{}
\DoxyCodeLine{00827\ \ \ \ \ \ \ \_pipeline-\/>iterate\_all\_cycler\_types(pstats\_count\_cycler\_type,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00828\ \ \ \ \ \ \ \_pipeline-\/>iterate\_dirty\_cycler\_types(pstats\_count\_dirty\_cycler\_type,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00829\ \ \ \ \ \}}
\DoxyCodeLine{00830\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DEBUG\_THREADS}}
\DoxyCodeLine{00831\ }
\DoxyCodeLine{00832\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ THREADED\_PIPELINE\ \&\&\ DO\_PSTATS}}
\DoxyCodeLine{00833\ }
\DoxyCodeLine{00834\ \ \ \ \ GeomCacheManager::flush\_level();}
\DoxyCodeLine{00835\ \ \ \ \ CullTraverser::flush\_level();}
\DoxyCodeLine{00836\ \ \ \ \ RenderState::flush\_level();}
\DoxyCodeLine{00837\ \ \ \ \ TransformState::flush\_level();}
\DoxyCodeLine{00838\ \ \ \ \ CullableObject::flush\_level();}
\DoxyCodeLine{00839\ }
\DoxyCodeLine{00840\ \ \ \ \ \textcolor{comment}{//\ Now\ cycle\ the\ pipeline\ and\ officially\ begin\ the\ next\ frame.}}
\DoxyCodeLine{00841\ \textcolor{preprocessor}{\#ifdef\ THREADED\_PIPELINE}}
\DoxyCodeLine{00842\ \ \ \ \ \{}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cycle\_pcollector,\ current\_thread);}
\DoxyCodeLine{00844\ \ \ \ \ \ \ \_pipeline-\/>\mbox{\hyperlink{classPipeline_a574b58695fd3ff4419870dae4ac3cca6}{cycle}}();}
\DoxyCodeLine{00845\ \ \ \ \ \}}
\DoxyCodeLine{00846\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ THREADED\_PIPELINE}}
\DoxyCodeLine{00847\ }
\DoxyCodeLine{00848\ \ \ \ \ \_clock-\/>tick(current\_thread);}
\DoxyCodeLine{00849\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_clock-\/>check\_errors(current\_thread))\ \{}
\DoxyCodeLine{00850\ \ \ \ \ \ \ throw\_event(\textcolor{stringliteral}{"{}clock\_error"{}});}
\DoxyCodeLine{00851\ \ \ \ \ \}}
\DoxyCodeLine{00852\ }
\DoxyCodeLine{00853\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{00854\ \ \ \ \ PStatClient::main\_tick();}
\DoxyCodeLine{00855\ }
\DoxyCodeLine{00856\ \ \ \ \ \textcolor{comment}{//\ Reset\ our\ pcollectors\ that\ track\ data\ across\ the\ frame.}}
\DoxyCodeLine{00857\ \ \ \ \ CullTraverser::\_nodes\_pcollector.clear\_level();}
\DoxyCodeLine{00858\ \ \ \ \ CullTraverser::\_geom\_nodes\_pcollector.clear\_level();}
\DoxyCodeLine{00859\ \ \ \ \ CullTraverser::\_pgui\_nodes\_pcollector.clear\_level();}
\DoxyCodeLine{00860\ \ \ \ \ CullTraverser::\_geoms\_pcollector.clear\_level();}
\DoxyCodeLine{00861\ \ \ \ \ GeomCacheManager::\_geom\_cache\_active\_pcollector.clear\_level();}
\DoxyCodeLine{00862\ \ \ \ \ GeomCacheManager::\_geom\_cache\_record\_pcollector.clear\_level();}
\DoxyCodeLine{00863\ \ \ \ \ GeomCacheManager::\_geom\_cache\_erase\_pcollector.clear\_level();}
\DoxyCodeLine{00864\ \ \ \ \ GeomCacheManager::\_geom\_cache\_evict\_pcollector.clear\_level();}
\DoxyCodeLine{00865\ }
\DoxyCodeLine{00866\ \ \ \ \ GraphicsStateGuardian::init\_frame\_pstats();}
\DoxyCodeLine{00867\ }
\DoxyCodeLine{00868\ \ \ \ \ \_transform\_states\_pcollector.set\_level(TransformState::get\_num\_states());}
\DoxyCodeLine{00869\ \ \ \ \ \_render\_states\_pcollector.set\_level(\mbox{\hyperlink{classRenderState_a3c8813da0ccebbb7d0c125321060fc1c}{RenderState::get\_num\_states}}());}
\DoxyCodeLine{00870\ \ \ \ \ \textcolor{keywordflow}{if}\ (pstats\_unused\_states)\ \{}
\DoxyCodeLine{00871\ \ \ \ \ \ \ \_transform\_states\_unused\_pcollector.set\_level(TransformState::get\_num\_unused\_states());}
\DoxyCodeLine{00872\ \ \ \ \ \ \ \_render\_states\_unused\_pcollector.set\_level(\mbox{\hyperlink{classRenderState_af8a17d991b13e65ae667adeb1a08b2da}{RenderState::get\_num\_unused\_states}}());}
\DoxyCodeLine{00873\ \ \ \ \ \}}
\DoxyCodeLine{00874\ }
\DoxyCodeLine{00875\ \ \ \ \ \_sw\_sprites\_pcollector.clear\_level();}
\DoxyCodeLine{00876\ }
\DoxyCodeLine{00877\ \ \ \ \ \_cnode\_volume\_pcollector.clear\_level();}
\DoxyCodeLine{00878\ \ \ \ \ \_gnode\_volume\_pcollector.clear\_level();}
\DoxyCodeLine{00879\ \ \ \ \ \_geom\_volume\_pcollector.clear\_level();}
\DoxyCodeLine{00880\ \ \ \ \ \_node\_volume\_pcollector.clear\_level();}
\DoxyCodeLine{00881\ \ \ \ \ \_volume\_pcollector.clear\_level();}
\DoxyCodeLine{00882\ \ \ \ \ \_test\_pcollector.clear\_level();}
\DoxyCodeLine{00883\ \ \ \ \ \_volume\_polygon\_pcollector.clear\_level();}
\DoxyCodeLine{00884\ \ \ \ \ \_test\_polygon\_pcollector.clear\_level();}
\DoxyCodeLine{00885\ \ \ \ \ \_volume\_plane\_pcollector.clear\_level();}
\DoxyCodeLine{00886\ \ \ \ \ \_test\_plane\_pcollector.clear\_level();}
\DoxyCodeLine{00887\ \ \ \ \ \_volume\_sphere\_pcollector.clear\_level();}
\DoxyCodeLine{00888\ \ \ \ \ \_test\_sphere\_pcollector.clear\_level();}
\DoxyCodeLine{00889\ \ \ \ \ \_volume\_box\_pcollector.clear\_level();}
\DoxyCodeLine{00890\ \ \ \ \ \_test\_box\_pcollector.clear\_level();}
\DoxyCodeLine{00891\ \ \ \ \ \_volume\_capsule\_pcollector.clear\_level();}
\DoxyCodeLine{00892\ \ \ \ \ \_test\_capsule\_pcollector.clear\_level();}
\DoxyCodeLine{00893\ \ \ \ \ \_volume\_inv\_sphere\_pcollector.clear\_level();}
\DoxyCodeLine{00894\ \ \ \ \ \_test\_inv\_sphere\_pcollector.clear\_level();}
\DoxyCodeLine{00895\ \ \ \ \ \_volume\_geom\_pcollector.clear\_level();}
\DoxyCodeLine{00896\ \ \ \ \ \_test\_geom\_pcollector.clear\_level();}
\DoxyCodeLine{00897\ \ \ \ \ \_occlusion\_untested\_pcollector.clear\_level();}
\DoxyCodeLine{00898\ \ \ \ \ \_occlusion\_passed\_pcollector.clear\_level();}
\DoxyCodeLine{00899\ \ \ \ \ \_occlusion\_failed\_pcollector.clear\_level();}
\DoxyCodeLine{00900\ \ \ \ \ \_occlusion\_tests\_pcollector.clear\_level();}
\DoxyCodeLine{00901\ }
\DoxyCodeLine{00902\ \ \ \ \ \textcolor{keywordflow}{if}\ (PStatClient::is\_connected())\ \{}
\DoxyCodeLine{00903\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ small\_buf\ =\ GeomVertexArrayData::get\_small\_lru()-\/>get\_total\_size();}
\DoxyCodeLine{00904\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ independent\ =\ GeomVertexArrayData::get\_independent\_lru()-\/>get\_total\_size();}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ resident\ =\ VertexDataPage::get\_global\_lru(VertexDataPage::RC\_resident)-\/>get\_total\_size();}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ compressed\ =\ VertexDataPage::get\_global\_lru(VertexDataPage::RC\_compressed)-\/>get\_total\_size();}
\DoxyCodeLine{00907\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ pending\ =\ VertexDataPage::get\_pending\_lru()-\/>get\_total\_size();}
\DoxyCodeLine{00908\ }
\DoxyCodeLine{00909\ \ \ \ \ \ \ \mbox{\hyperlink{classVertexDataSaveFile}{VertexDataSaveFile}}\ *save\_file\ =\ VertexDataPage::get\_save\_file();}
\DoxyCodeLine{00910\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ total\_disk\ =\ save\_file-\/>get\_total\_file\_size();}
\DoxyCodeLine{00911\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ used\_disk\ =\ save\_file-\/>get\_used\_file\_size();}
\DoxyCodeLine{00912\ }
\DoxyCodeLine{00913\ \ \ \ \ \ \ \_vertex\_data\_small\_pcollector.set\_level(small\_buf);}
\DoxyCodeLine{00914\ \ \ \ \ \ \ \_vertex\_data\_independent\_pcollector.set\_level(independent);}
\DoxyCodeLine{00915\ \ \ \ \ \ \ \_vertex\_data\_pending\_pcollector.set\_level(pending);}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \_vertex\_data\_resident\_pcollector.set\_level(resident);}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \_vertex\_data\_compressed\_pcollector.set\_level(compressed);}
\DoxyCodeLine{00918\ \ \ \ \ \ \ \_vertex\_data\_unused\_disk\_pcollector.set\_level(total\_disk\ -\/\ used\_disk);}
\DoxyCodeLine{00919\ \ \ \ \ \ \ \_vertex\_data\_used\_disk\_pcollector.set\_level(used\_disk);}
\DoxyCodeLine{00920\ \ \ \ \ \}}
\DoxyCodeLine{00921\ }
\DoxyCodeLine{00922\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DO\_PSTATS}}
\DoxyCodeLine{00923\ }
\DoxyCodeLine{00924\ \ \ \ \ \mbox{\hyperlink{classGeomVertexArrayData_aeb17a2fb51993bddef3eb745b667593a}{GeomVertexArrayData::lru\_epoch}}();}
\DoxyCodeLine{00925\ }
\DoxyCodeLine{00926\ \ \ \ \ \textcolor{comment}{//\ Now\ signal\ all\ of\ our\ threads\ to\ begin\ their\ next\ frame.}}
\DoxyCodeLine{00927\ \ \ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{00928\ \ \ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{00929\ \ \ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (thread-\/>\_thread\_state\ ==\ TS\_wait)\ \{}
\DoxyCodeLine{00931\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Release\ before\ notifying,\ otherwise\ the\ other\ thread\ will\ wake\ up}}
\DoxyCodeLine{00932\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ get\ blocked\ on\ the\ mutex\ straight\ away.}}
\DoxyCodeLine{00933\ \ \ \ \ \ \ \ \ thread-\/>\_thread\_state\ =\ TS\_do\_frame;}
\DoxyCodeLine{00934\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{00935\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_start.notify();}
\DoxyCodeLine{00936\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00937\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00939\ \ \ \ \ \}}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00941\ \ \ \ \ \textcolor{comment}{//\ Some\ threads\ may\ still\ be\ drawing,\ so\ indicate\ that\ we\ have\ to\ wait\ for}}
\DoxyCodeLine{00942\ \ \ \ \ \textcolor{comment}{//\ those\ threads\ before\ we\ can\ flip.}}
\DoxyCodeLine{00943\ \ \ \ \ \_flip\_state\ =\ \_auto\_flip\ ?\ FS\_flip\ :\ FS\_draw;}
\DoxyCodeLine{00944\ \ \ \}}
\DoxyCodeLine{00945\ }
\DoxyCodeLine{00946\ \ \ \textcolor{comment}{//\ Now\ the\ lock\ is\ released.}}
\DoxyCodeLine{00947\ }
\DoxyCodeLine{00948\ \ \ \textcolor{keywordflow}{if}\ (yield\_timeslice)\ \{}
\DoxyCodeLine{00949\ \ \ \ \ \textcolor{comment}{//\ Nap\ for\ a\ moment\ to\ yield\ the\ timeslice,\ to\ be\ polite\ to\ other\ running}}
\DoxyCodeLine{00950\ \ \ \ \ \textcolor{comment}{//\ applications.}}
\DoxyCodeLine{00951\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_yield\_pcollector,\ current\_thread);}
\DoxyCodeLine{00952\ \ \ \ \ Thread::force\_yield();}
\DoxyCodeLine{00953\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!Thread::is\_true\_threads())\ \{}
\DoxyCodeLine{00954\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_yield\_pcollector,\ current\_thread);}
\DoxyCodeLine{00955\ \ \ \ \ Thread::consider\_yield();}
\DoxyCodeLine{00956\ \ \ \}}
\DoxyCodeLine{00957\ }
\DoxyCodeLine{00958\ \ \ \textcolor{comment}{//\ Anything\ that\ happens\ outside\ of\ GraphicsEngine::render\_frame()\ is\ deemed}}
\DoxyCodeLine{00959\ \ \ \textcolor{comment}{//\ to\ be\ App.}}
\DoxyCodeLine{00960\ \ \ \textcolor{comment}{//\_app\_pcollector.start();}}
\DoxyCodeLine{00961\ \ \ \_render\_frame\_pcollector.stop();}
\DoxyCodeLine{00962\ \}}
\DoxyCodeLine{00963\ }
\DoxyCodeLine{00964\ }
\DoxyCodeLine{00972\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{00973\ open\_windows()\ \{}
\DoxyCodeLine{00974\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00975\ }
\DoxyCodeLine{00976\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{00977\ }
\DoxyCodeLine{00978\ \ \ NewWindows\ new\_windows;}
\DoxyCodeLine{00979\ \ \ \{}
\DoxyCodeLine{00980\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ new\_windows\_holder(\_new\_windows\_lock,\ current\_thread);}
\DoxyCodeLine{00981\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_new\_windows.empty())\ \{}
\DoxyCodeLine{00982\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00983\ \ \ \ \ \}}
\DoxyCodeLine{00984\ }
\DoxyCodeLine{00985\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ it\ =\ \_new\_windows.begin();\ it\ !=\ \_new\_windows.end();\ ++it)\ \{}
\DoxyCodeLine{00986\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window\ =\ *it;}
\DoxyCodeLine{00987\ }
\DoxyCodeLine{00988\ \ \ \ \ \ \ WindowRenderer\ *cull\ =}
\DoxyCodeLine{00989\ \ \ \ \ \ \ \ \ get\_window\_renderer(\_threading\_model.get\_cull\_name(),}
\DoxyCodeLine{00990\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_threading\_model.get\_cull\_stage());}
\DoxyCodeLine{00991\ \ \ \ \ \ \ WindowRenderer\ *draw\ =}
\DoxyCodeLine{00992\ \ \ \ \ \ \ \ \ get\_window\_renderer(\_threading\_model.get\_draw\_name(),}
\DoxyCodeLine{00993\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_threading\_model.get\_draw\_stage());}
\DoxyCodeLine{00994\ }
\DoxyCodeLine{00995\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_threading\_model.get\_cull\_sorting())\ \{}
\DoxyCodeLine{00996\ \ \ \ \ \ \ \ \ cull-\/>add\_window(cull-\/>\_cull,\ window);}
\DoxyCodeLine{00997\ \ \ \ \ \ \ \ \ draw-\/>add\_window(draw-\/>\_draw,\ window);}
\DoxyCodeLine{00998\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00999\ \ \ \ \ \ \ \ \ cull-\/>add\_window(cull-\/>\_cdraw,\ window);}
\DoxyCodeLine{01000\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01001\ }
\DoxyCodeLine{01002\ \ \ \ \ \ \ \textcolor{comment}{//\ Ask\ the\ pipe\ which\ thread\ it\ prefers\ to\ run\ its\ windowing\ commands\ in}}
\DoxyCodeLine{01003\ \ \ \ \ \ \ \textcolor{comment}{//\ (the\ "{}window\ thread"{}).\ \ This\ is\ the\ thread\ that\ handles\ the\ commands}}
\DoxyCodeLine{01004\ \ \ \ \ \ \ \textcolor{comment}{//\ to\ open,\ resize,\ etc.\ \ the\ window.\ \ X\ requires\ this\ to\ be\ done\ in\ the}}
\DoxyCodeLine{01005\ \ \ \ \ \ \ \textcolor{comment}{//\ app\ thread\ (along\ with\ all\ the\ other\ windows,\ since\ X\ is\ strictly}}
\DoxyCodeLine{01006\ \ \ \ \ \ \ \textcolor{comment}{//\ single-\/threaded),\ but\ Windows\ requires\ this\ to\ be\ done\ in\ draw}}
\DoxyCodeLine{01007\ \ \ \ \ \ \ \textcolor{comment}{//\ (because\ once\ an\ OpenGL\ context\ has\ been\ bound\ in\ a\ given\ thread,\ it}}
\DoxyCodeLine{01008\ \ \ \ \ \ \ \textcolor{comment}{//\ cannot\ subsequently\ be\ bound\ in\ any\ other\ thread,\ and\ we\ have\ to\ bind}}
\DoxyCodeLine{01009\ \ \ \ \ \ \ \textcolor{comment}{//\ a\ context\ in\ open\_window()).}}
\DoxyCodeLine{01010\ }
\DoxyCodeLine{01011\ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (window-\/>get\_pipe()-\/>\mbox{\hyperlink{classGraphicsPipe_abbe124415f61205f3fcca027079ecee4}{get\_preferred\_window\_thread}}())\ \{}
\DoxyCodeLine{01012\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ GraphicsPipe::PWT\_app:}
\DoxyCodeLine{01013\ \ \ \ \ \ \ \ \ \_app.add\_window(\_app.\_window,\ window);}
\DoxyCodeLine{01014\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01015\ }
\DoxyCodeLine{01016\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ GraphicsPipe::PWT\_draw:}
\DoxyCodeLine{01017\ \ \ \ \ \ \ \ \ draw-\/>add\_window(draw-\/>\_window,\ window);}
\DoxyCodeLine{01018\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01019\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01020\ }
\DoxyCodeLine{01021\ \ \ \ \ \ \ \_windows.push\_back(window);}
\DoxyCodeLine{01022\ \ \ \ \ \}}
\DoxyCodeLine{01023\ }
\DoxyCodeLine{01024\ \ \ \ \ \textcolor{comment}{//\ Steal\ the\ list,\ since\ remove\_window()\ may\ remove\ from\ \_new\_windows.}}
\DoxyCodeLine{01025\ \ \ \ \ new\_windows\ =\ std::move(\_new\_windows);}
\DoxyCodeLine{01026\ \ \ \}}
\DoxyCodeLine{01027\ }
\DoxyCodeLine{01028\ \ \ do\_resort\_windows();}
\DoxyCodeLine{01029\ }
\DoxyCodeLine{01030\ \ \ \textcolor{comment}{//\ We\ do\ it\ twice,\ to\ allow\ both\ cull\ and\ draw\ to\ process\ the\ window.}}
\DoxyCodeLine{01031\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 2;\ ++i)\ \{}
\DoxyCodeLine{01032\ \ \ \ \ \_app.do\_windows(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{01033\ \ \ \ \ \_app.do\_pending(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{01034\ }
\DoxyCodeLine{01035\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_wait\_pcollector,\ current\_thread);}
\DoxyCodeLine{01036\ \ \ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{01037\ \ \ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{01038\ \ \ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{01039\ \ \ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{01040\ }
\DoxyCodeLine{01041\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (thread-\/>\_thread\_state\ !=\ TS\_wait)\ \{}
\DoxyCodeLine{01042\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_done.wait();}
\DoxyCodeLine{01043\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01044\ }
\DoxyCodeLine{01045\ \ \ \ \ \ \ thread-\/>\_thread\_state\ =\ TS\_do\_windows;}
\DoxyCodeLine{01046\ \ \ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{01047\ \ \ \ \ \ \ thread-\/>\_cv\_start.notify();}
\DoxyCodeLine{01048\ \ \ \ \ \}}
\DoxyCodeLine{01049\ \ \ \}}
\DoxyCodeLine{01050\ }
\DoxyCodeLine{01051\ \ \ \textcolor{comment}{//\ Now\ go\ through\ the\ list\ again\ to\ check\ whether\ they\ opened\ successfully.}}
\DoxyCodeLine{01052\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ it\ =\ new\_windows.begin();\ it\ !=\ new\_windows.end();\ ++it)\ \{}
\DoxyCodeLine{01053\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window\ =\ *it;}
\DoxyCodeLine{01054\ \ \ \ \ \textcolor{keywordflow}{if}\ (window-\/>is\_valid())\ \{}
\DoxyCodeLine{01055\ \ \ \ \ \ \ do\_add\_gsg(window-\/>get\_gsg(),\ window-\/>get\_pipe());}
\DoxyCodeLine{01056\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01057\ \ \ \ \ \ \ remove\_window(window);}
\DoxyCodeLine{01058\ \ \ \ \ \}}
\DoxyCodeLine{01059\ \ \ \}}
\DoxyCodeLine{01060\ \}}
\DoxyCodeLine{01061\ }
\DoxyCodeLine{01068\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01069\ sync\_frame()\ \{}
\DoxyCodeLine{01070\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01071\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{01072\ }
\DoxyCodeLine{01073\ \ \ \textcolor{keywordflow}{if}\ (\_flip\_state\ ==\ FS\_draw)\ \{}
\DoxyCodeLine{01074\ \ \ \ \ do\_sync\_frame(current\_thread);}
\DoxyCodeLine{01075\ \ \ \}}
\DoxyCodeLine{01076\ \}}
\DoxyCodeLine{01077\ }
\DoxyCodeLine{01078\ }
\DoxyCodeLine{01089\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01090\ ready\_flip()\ \{}
\DoxyCodeLine{01091\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01092\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{01093\ }
\DoxyCodeLine{01094\ \ \ \textcolor{keywordflow}{if}\ (\_flip\_state\ ==\ FS\_draw)\ \{}
\DoxyCodeLine{01095\ \ \ \ \ do\_ready\_flip(current\_thread);}
\DoxyCodeLine{01096\ \ \ \}}
\DoxyCodeLine{01097\ \}}
\DoxyCodeLine{01098\ }
\DoxyCodeLine{01104\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01105\ flip\_frame()\ \{}
\DoxyCodeLine{01106\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01107\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{01108\ }
\DoxyCodeLine{01109\ \ \ \textcolor{keywordflow}{if}\ (\_flip\_state\ !=\ FS\_flip)\ \{}
\DoxyCodeLine{01110\ \ \ \ \ do\_flip\_frame(current\_thread);}
\DoxyCodeLine{01111\ \ \ \}}
\DoxyCodeLine{01112\ \}}
\DoxyCodeLine{01113\ }
\DoxyCodeLine{01135\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{01136\ extract\_texture\_data(\mbox{\hyperlink{classTexture}{Texture}}\ *tex,\ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg)\ \{}
\DoxyCodeLine{01137\ \ \ \textcolor{keywordflow}{return}\ run\_on\_draw\_thread([=]\ ()\ \{}
\DoxyCodeLine{01138\ \ \ \ \ \textcolor{keywordflow}{return}\ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a87865e9af34a69f2e2473a53d504dce7}{extract\_texture\_data}}(tex);}
\DoxyCodeLine{01139\ \ \ \});}
\DoxyCodeLine{01140\ \}}
\DoxyCodeLine{01141\ }
\DoxyCodeLine{01152\ vector\_uchar\ GraphicsEngine::}
\DoxyCodeLine{01153\ extract\_shader\_buffer\_data(\mbox{\hyperlink{classShaderBuffer}{ShaderBuffer}}\ *buffer,\ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg)\ \{}
\DoxyCodeLine{01154\ \ \ \textcolor{keywordflow}{return}\ run\_on\_draw\_thread([=]\ ()\ \{}
\DoxyCodeLine{01155\ \ \ \ \ vector\_uchar\ data;}
\DoxyCodeLine{01156\ \ \ \ \ \textcolor{keywordflow}{if}\ (!gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a1e84a2e3c8890331ec544b22dc366fb6}{extract\_shader\_buffer\_data}}(buffer,\ data))\ \{}
\DoxyCodeLine{01157\ \ \ \ \ \ \ data.clear();}
\DoxyCodeLine{01158\ \ \ \ \ \}}
\DoxyCodeLine{01159\ \ \ \ \ \textcolor{keywordflow}{return}\ data;}
\DoxyCodeLine{01160\ \ \ \});}
\DoxyCodeLine{01161\ \}}
\DoxyCodeLine{01162\ }
\DoxyCodeLine{01176\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01177\ dispatch\_compute(\textcolor{keyword}{const}\ LVecBase3i\ \&work\_groups,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state,\ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg)\ \{}
\DoxyCodeLine{01178\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *sattr;}
\DoxyCodeLine{01179\ \ \ DCAST\_INTO\_V(sattr,\ state-\/>get\_attrib(ShaderAttrib::get\_class\_slot()));}
\DoxyCodeLine{01180\ }
\DoxyCodeLine{01181\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShader}{Shader}}\ *shader\ =\ sattr-\/>get\_shader();}
\DoxyCodeLine{01182\ \ \ nassertv(shader\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01183\ \ \ nassertv(gsg\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01184\ }
\DoxyCodeLine{01185\ \ \ run\_on\_draw\_thread([=]\ ()\ \{}
\DoxyCodeLine{01186\ \ \ \ \ gsg-\/>push\_group\_marker(std::string(\textcolor{stringliteral}{"{}Compute\ "{}})\ +\ shader-\/>get\_filename(Shader::ST\_compute).get\_basename());}
\DoxyCodeLine{01187\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ad6f69fb763c86c69eca984c49c92c36a}{set\_state\_and\_transform}}(state,\ TransformState::make\_identity());}
\DoxyCodeLine{01188\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_af6e96ce92a72e870ea50f426875c2a94}{dispatch\_compute}}(work\_groups[0],\ work\_groups[1],\ work\_groups[2]);}
\DoxyCodeLine{01189\ \ \ \ \ gsg-\/>pop\_group\_marker();}
\DoxyCodeLine{01190\ \ \ \});}
\DoxyCodeLine{01191\ \}}
\DoxyCodeLine{01192\ }
\DoxyCodeLine{01196\ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *GraphicsEngine::}
\DoxyCodeLine{01197\ get\_global\_ptr()\ \{}
\DoxyCodeLine{01198\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01199\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}};}
\DoxyCodeLine{01200\ \ \ \ \ \mbox{\hyperlink{classPandaNode_abfb6c991ee1f3e11c332dcad9db8849f}{PandaNode::set\_scene\_root\_func}}(\&scene\_root\_func);}
\DoxyCodeLine{01201\ \ \ \}}
\DoxyCodeLine{01202\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{01203\ \}}
\DoxyCodeLine{01204\ }
\DoxyCodeLine{01213\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGraphicsEngine_ac68a5c48416a5e3217516e7355cd501d}{GraphicsEngine::}}}
\DoxyCodeLine{01214\ \mbox{\hyperlink{classGraphicsEngine_ac68a5c48416a5e3217516e7355cd501d}{texture\_uploaded}}(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ \{}
\DoxyCodeLine{01215\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_loaded\_textures\_lock);}
\DoxyCodeLine{01216\ \ \ \textcolor{comment}{//\ We\ defer\ this\ until\ the\ end\ of\ the\ frame;\ multiple\ GSG's\ might\ be}}
\DoxyCodeLine{01217\ \ \ \textcolor{comment}{//\ rendering\ the\ texture\ within\ the\ same\ frame,\ and\ we\ don't\ want\ to\ dump}}
\DoxyCodeLine{01218\ \ \ \textcolor{comment}{//\ the\ texture\ image\ until\ they've\ all\ had\ a\ chance\ at\ it.}}
\DoxyCodeLine{01219\ \ \ \_loaded\_textures.push\_back(LoadedTexture());}
\DoxyCodeLine{01220\ \ \ LoadedTexture\ \&lt\ =\ \_loaded\_textures.back();}
\DoxyCodeLine{01221\ \ \ lt.\_tex\ =\ tex;}
\DoxyCodeLine{01222\ \ \ lt.\_image\_modified\ =\ tex-\/>get\_image\_modified();}
\DoxyCodeLine{01223\ \textcolor{comment}{//\ Usually\ only\ called\ by\ DisplayRegion::do\_cull.}}
\DoxyCodeLine{01224\ \}}
\DoxyCodeLine{01225\ }
\DoxyCodeLine{01229\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGraphicsEngine_afdad59b9fa2cefe17e03b7aa05e3e37b}{GraphicsEngine::}}}
\DoxyCodeLine{01230\ \mbox{\hyperlink{classGraphicsEngine_afdad59b9fa2cefe17e03b7aa05e3e37b}{do\_cull}}(\mbox{\hyperlink{classCullHandler}{CullHandler}}\ *cull\_handler,\ \mbox{\hyperlink{classSceneSetup}{SceneSetup}}\ *scene\_setup,}
\DoxyCodeLine{01231\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01232\ \ \ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *dr\ =\ scene\_setup-\/>get\_display\_region();}
\DoxyCodeLine{01233\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(dr-\/>get\_cull\_region\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01234\ }
\DoxyCodeLine{01235\ \ \ \mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav\ =\ dr-\/>\mbox{\hyperlink{classDisplayRegion_aeaa570131d593c3eabd3c13a91163150}{get\_cull\_traverser}}();}
\DoxyCodeLine{01236\ \ \ trav-\/>set\_cull\_handler(cull\_handler);}
\DoxyCodeLine{01237\ \ \ trav-\/>set\_scene(scene\_setup,\ gsg,\ dr-\/>get\_incomplete\_render());}
\DoxyCodeLine{01238\ \ \ trav-\/>traverse(scene\_setup-\/>get\_scene\_root());}
\DoxyCodeLine{01239\ \ \ trav-\/>end\_traverse();}
\DoxyCodeLine{01240\ \}}
\DoxyCodeLine{01241\ }
\DoxyCodeLine{01242\ }
\DoxyCodeLine{01247\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{01248\ scene\_root\_func(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node)\ \{}
\DoxyCodeLine{01249\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr-\/>is\_scene\_root(node);}
\DoxyCodeLine{01250\ \}}
\DoxyCodeLine{01251\ }
\DoxyCodeLine{01256\ \textcolor{keywordtype}{bool}\ GraphicsEngine::}
\DoxyCodeLine{01257\ is\_scene\_root(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node)\ \{}
\DoxyCodeLine{01258\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01259\ }
\DoxyCodeLine{01260\ \ \ Windows::const\_iterator\ wi;}
\DoxyCodeLine{01261\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_windows.begin();\ wi\ !=\ \_windows.end();\ ++wi)\ \{}
\DoxyCodeLine{01262\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{01263\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a95095b8c8c7b7b8ecf7c84062c0e3520}{is\_active}}()\ \&\&\ win-\/>get\_gsg()-\/>is\_active())\ \{}
\DoxyCodeLine{01264\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_display\_regions\ =\ win-\/>get\_num\_active\_display\_regions();}
\DoxyCodeLine{01265\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_display\_regions;\ i++)\ \{}
\DoxyCodeLine{01266\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDisplayRegion}{DisplayRegion}})\ dr\ =\ win-\/>get\_active\_display\_region(i);}
\DoxyCodeLine{01267\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01268\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ camera\ =\ dr-\/>get\_camera();}
\DoxyCodeLine{01269\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (camera.is\_empty())\ \{}
\DoxyCodeLine{01270\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01271\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01272\ }
\DoxyCodeLine{01273\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCamera}{Camera}}\ *camera\_node;}
\DoxyCodeLine{01274\ \ \ \ \ \ \ \ \ \ \ DCAST\_INTO\_R(camera\_node,\ camera.node(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{01275\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!camera\_node-\/>is\_active())\ \{}
\DoxyCodeLine{01276\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01277\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01278\ }
\DoxyCodeLine{01279\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ scene\_root\ =\ camera\_node-\/>get\_scene();}
\DoxyCodeLine{01280\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (scene\_root.is\_empty())\ \{}
\DoxyCodeLine{01281\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ explicit\ scene\ specified,\ use\ whatever\ scene\ the}}
\DoxyCodeLine{01282\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ camera\ is\ parented\ within.\ \ This\ is\ the\ normal\ and\ preferred}}
\DoxyCodeLine{01283\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ case;\ the\ use\ of\ an\ explicit\ scene\ is\ now\ deprecated.}}
\DoxyCodeLine{01284\ \ \ \ \ \ \ \ \ \ \ \ \ scene\_root\ =\ camera.get\_top(current\_thread);}
\DoxyCodeLine{01285\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01286\ }
\DoxyCodeLine{01287\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (scene\_root.node()\ ==\ node)\ \{}
\DoxyCodeLine{01288\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01289\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01290\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01291\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01292\ \ \ \ \ \}}
\DoxyCodeLine{01293\ \ \ \}}
\DoxyCodeLine{01294\ }
\DoxyCodeLine{01295\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01296\ \}}
\DoxyCodeLine{01297\ }
\DoxyCodeLine{01304\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01305\ set\_window\_sort(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window,\ \textcolor{keywordtype}{int}\ sort)\ \{}
\DoxyCodeLine{01306\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01307\ \ \ window-\/>\_sort\ =\ sort;}
\DoxyCodeLine{01308\ \ \ \_windows\_sorted\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01309\ \}}
\DoxyCodeLine{01310\ }
\DoxyCodeLine{01317\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01318\ cull\_and\_draw\_together(\mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ wlist,}
\DoxyCodeLine{01319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01320\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cull\_pcollector,\ current\_thread);}
\DoxyCodeLine{01321\ }
\DoxyCodeLine{01322\ \ \ \textcolor{keywordtype}{size\_t}\ wlist\_size\ =\ wlist.size();}
\DoxyCodeLine{01323\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ wi\ =\ 0;\ wi\ <\ wlist\_size;\ ++wi)\ \{}
\DoxyCodeLine{01324\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ wlist[wi];}
\DoxyCodeLine{01325\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a95095b8c8c7b7b8ecf7c84062c0e3520}{is\_active}}()\ \&\&\ win-\/>get\_gsg()-\/>is\_active())\ \{}
\DoxyCodeLine{01326\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>flip\_ready())\ \{}
\DoxyCodeLine{01327\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01328\ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01329\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Flipping\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01330\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01331\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01332\ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a2406222f6dd4df14b3e2c4c5ac8c1001}{begin\_flip}}();}
\DoxyCodeLine{01333\ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a593a9030f0b90ee588b1006df9aee604}{end\_flip}}();}
\DoxyCodeLine{01334\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01335\ }
\DoxyCodeLine{01336\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a82bbfa980adaaa4abcdaa8c567182db1}{begin\_frame}}(GraphicsOutput::FM\_render,\ current\_thread))\ \{}
\DoxyCodeLine{01337\ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_ab5cedbe18daea18e79c0167dac2d0bd1}{copy\_async\_screenshot}}();}
\DoxyCodeLine{01338\ }
\DoxyCodeLine{01339\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classDrawableRegion_a7cf04a992ac977ba7d706c81871ed1b5}{is\_any\_clear\_active}}())\ \{}
\DoxyCodeLine{01340\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>get\_gsg();}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ win-\/>get\_clear\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \ \ \ \ gsg-\/>push\_group\_marker(\textcolor{stringliteral}{"{}Clear"{}});}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_aead3c39332275a61c14928bf3b63ba5c}{clear}}(current\_thread);}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \ \ gsg-\/>pop\_group\_marker();}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01346\ }
\DoxyCodeLine{01347\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01348\ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01349\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Culling\ and\ drawing\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01350\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01351\ }
\DoxyCodeLine{01352\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_display\_regions\ =\ win-\/>get\_num\_active\_display\_regions();}
\DoxyCodeLine{01353\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_display\_regions;\ i++)\ \{}
\DoxyCodeLine{01354\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDisplayRegion}{DisplayRegion}})\ dr\ =\ win-\/>get\_active\_display\_region(i);}
\DoxyCodeLine{01355\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01356\ \ \ \ \ \ \ \ \ \ \ \ \ cull\_and\_draw\_together(win,\ dr,\ current\_thread);}
\DoxyCodeLine{01357\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01358\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01359\ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a51bf142d4d882476b8a089581474dd0f}{end\_frame}}(GraphicsOutput::FM\_render,\ current\_thread);}
\DoxyCodeLine{01360\ }
\DoxyCodeLine{01361\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_auto\_flip)\ \{}
\DoxyCodeLine{01362\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>flip\_ready())\ \{}
\DoxyCodeLine{01363\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01364\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01365\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Flipping\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01368\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a2406222f6dd4df14b3e2c4c5ac8c1001}{begin\_flip}}();}
\DoxyCodeLine{01369\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a593a9030f0b90ee588b1006df9aee604}{end\_flip}}();}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01371\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01372\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01373\ \ \ \ \ \}}
\DoxyCodeLine{01374\ \ \ \}}
\DoxyCodeLine{01375\ \}}
\DoxyCodeLine{01376\ }
\DoxyCodeLine{01380\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01381\ cull\_and\_draw\_together(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win,\ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *dr,}
\DoxyCodeLine{01382\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01383\ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>get\_gsg();}
\DoxyCodeLine{01384\ \ \ nassertv(gsg\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01385\ }
\DoxyCodeLine{01386\ \ \ gsg-\/>push\_group\_marker(dr-\/>get\_debug\_name());}
\DoxyCodeLine{01387\ }
\DoxyCodeLine{01388\ \ \ PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ scene\_setup;}
\DoxyCodeLine{01389\ }
\DoxyCodeLine{01390\ \ \ \{}
\DoxyCodeLine{01391\ \ \ \ \ \mbox{\hyperlink{classDisplayRegionPipelineReader}{DisplayRegionPipelineReader}}\ dr\_reader(dr,\ current\_thread);}
\DoxyCodeLine{01392\ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a5ebecf1b66237530202157017494c026}{change\_scenes}}(\&dr\_reader);}
\DoxyCodeLine{01393\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a60bb06c5987b92bc39591d4a27bea4ab}{prepare\_display\_region}}(\&dr\_reader);}
\DoxyCodeLine{01394\ }
\DoxyCodeLine{01395\ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\_reader.is\_any\_clear\_active())\ \{}
\DoxyCodeLine{01396\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ win-\/>get\_clear\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01397\ \ \ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ae2c8994262a8a36ce73c20faf0cc813a}{clear}}(dr);}
\DoxyCodeLine{01398\ \ \ \ \ \}}
\DoxyCodeLine{01399\ }
\DoxyCodeLine{01400\ \ \ \ \ scene\_setup\ =\ setup\_scene(gsg,\ \&dr\_reader);}
\DoxyCodeLine{01401\ \ \ \}}
\DoxyCodeLine{01402\ }
\DoxyCodeLine{01403\ \ \ \textcolor{keywordflow}{if}\ (scene\_setup\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01404\ \ \ \ \ \textcolor{comment}{//\ Never\ mind.}}
\DoxyCodeLine{01405\ }
\DoxyCodeLine{01406\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (dr-\/>\mbox{\hyperlink{classDisplayRegion_ab5ec04c0765e71a669b52a3b01d2629a}{is\_stereo}}())\ \{}
\DoxyCodeLine{01407\ \ \ \ \ \textcolor{comment}{//\ Don't\ draw\ stereo\ DisplayRegions\ directly.}}
\DoxyCodeLine{01408\ }
\DoxyCodeLine{01409\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a24396aa9a8df4057bce0ddb5bbfb41dc}{set\_scene}}(scene\_setup))\ \{}
\DoxyCodeLine{01410\ \ \ \ \ \textcolor{comment}{//\ The\ scene\ or\ lens\ is\ inappropriate\ somehow.}}
\DoxyCodeLine{01411\ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{01412\ \ \ \ \ \ \ <<\ gsg-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\ cannot\ render\ scene\ with\ specified\ lens.\(\backslash\)n"{}};}
\DoxyCodeLine{01413\ }
\DoxyCodeLine{01414\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01415\ \ \ \ \ \mbox{\hyperlink{classDrawCullHandler}{DrawCullHandler}}\ cull\_handler(gsg);}
\DoxyCodeLine{01416\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg-\/>begin\_scene())\ \{}
\DoxyCodeLine{01417\ \ \ \ \ \ \ \mbox{\hyperlink{classCallbackObject}{CallbackObject}}\ *cbobj\ =\ dr-\/>get\_cull\_callback();}
\DoxyCodeLine{01418\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cbobj\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01419\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Issue\ the\ cull\ callback\ on\ this\ DisplayRegion.}}
\DoxyCodeLine{01420\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDisplayRegionCullCallbackData}{DisplayRegionCullCallbackData}}\ cbdata(\&cull\_handler,\ scene\_setup);}
\DoxyCodeLine{01421\ \ \ \ \ \ \ \ \ cbobj-\/>\mbox{\hyperlink{classCallbackObject_a373ebcf6f5fd83bbb5f578f309b61717}{do\_callback}}(\&cbdata);}
\DoxyCodeLine{01422\ }
\DoxyCodeLine{01423\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ callback\ has\ taken\ care\ of\ the\ culling.}}
\DoxyCodeLine{01424\ }
\DoxyCodeLine{01425\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01426\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Perform\ the\ cull\ normally.}}
\DoxyCodeLine{01427\ \ \ \ \ \ \ \ \ dr-\/>\mbox{\hyperlink{classDisplayRegion_a89d404a8bf4e69302699671adcf776f5}{do\_cull}}(\&cull\_handler,\ scene\_setup,\ gsg,\ current\_thread);}
\DoxyCodeLine{01428\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01429\ }
\DoxyCodeLine{01430\ \ \ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ab8d7bc997a78e7a442fcdb920cce0af4}{end\_scene}}();}
\DoxyCodeLine{01431\ \ \ \ \ \}}
\DoxyCodeLine{01432\ \ \ \}}
\DoxyCodeLine{01433\ }
\DoxyCodeLine{01434\ \ \ gsg-\/>pop\_group\_marker();}
\DoxyCodeLine{01435\ \}}
\DoxyCodeLine{01436\ }
\DoxyCodeLine{01442\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01443\ cull\_to\_bins(\mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01444\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cull\_pcollector,\ current\_thread);}
\DoxyCodeLine{01445\ }
\DoxyCodeLine{01446\ \ \ \_singular\_warning\_last\_frame\ =\ \_singular\_warning\_this\_frame;}
\DoxyCodeLine{01447\ \ \ \_singular\_warning\_this\_frame\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01448\ }
\DoxyCodeLine{01449\ \ \ \textcolor{comment}{//\ Keep\ track\ of\ the\ cameras\ we\ have\ already\ used\ in\ this\ thread\ to\ render}}
\DoxyCodeLine{01450\ \ \ \textcolor{comment}{//\ DisplayRegions.}}
\DoxyCodeLine{01451\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classpmap}{pmap<CullKey,\ DisplayRegion\ *>}}\ AlreadyCulled;}
\DoxyCodeLine{01452\ \ \ AlreadyCulled\ already\_culled;}
\DoxyCodeLine{01453\ }
\DoxyCodeLine{01454\ \ \ \textcolor{comment}{//\ We\ cull\ shadow\ passes\ last;\ whether\ we\ cull\ them\ depends\ on\ whether\ their}}
\DoxyCodeLine{01455\ \ \ \textcolor{comment}{//\ respective\ frusta\ are\ in\ view\ of\ a\ "{}normal"{}\ camera.}}
\DoxyCodeLine{01456\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})>\ shadow\_passes;}
\DoxyCodeLine{01457\ \ \ \mbox{\hyperlink{classpmap}{pmap<NodePath,\ UnionBoundingVolume>}}\ non\_shadow\_bounds;}
\DoxyCodeLine{01458\ }
\DoxyCodeLine{01459\ \ \ \textcolor{keywordtype}{size\_t}\ wlist\_size\ =\ wlist.size();}
\DoxyCodeLine{01460\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ wi\ =\ 0;\ wi\ <\ wlist\_size;\ ++wi)\ \{}
\DoxyCodeLine{01461\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ wlist[wi];}
\DoxyCodeLine{01462\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a95095b8c8c7b7b8ecf7c84062c0e3520}{is\_active}}()\ \&\&\ win-\/>get\_gsg()-\/>is\_active())\ \{}
\DoxyCodeLine{01463\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01464\ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01465\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Culling\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01466\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01467\ }
\DoxyCodeLine{01468\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>get\_gsg();}
\DoxyCodeLine{01469\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(win-\/>get\_cull\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01470\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_display\_regions\ =\ win-\/>get\_num\_active\_display\_regions();}
\DoxyCodeLine{01471\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_display\_regions;\ ++i)\ \{}
\DoxyCodeLine{01472\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDisplayRegion}{DisplayRegion}})\ dr\ =\ win-\/>get\_active\_display\_region(i);}
\DoxyCodeLine{01473\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01474\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ scene\_setup;}
\DoxyCodeLine{01475\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classCullResult}{CullResult}})\ cull\_result;}
\DoxyCodeLine{01476\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structCullKey}{CullKey}}\ key;}
\DoxyCodeLine{01477\ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01478\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cull\_setup\_pcollector,\ current\_thread);}
\DoxyCodeLine{01479\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDisplayRegionPipelineReader}{DisplayRegionPipelineReader}}\ dr\_reader(dr,\ current\_thread);}
\DoxyCodeLine{01480\ \ \ \ \ \ \ \ \ \ \ \ \ scene\_setup\ =\ setup\_scene(gsg,\ \&dr\_reader);}
\DoxyCodeLine{01481\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (scene\_setup\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01482\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01483\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01484\ }
\DoxyCodeLine{01485\ \ \ \ \ \ \ \ \ \ \ \ \ key.\_gsg\ =\ gsg;}
\DoxyCodeLine{01486\ \ \ \ \ \ \ \ \ \ \ \ \ key.\_camera\ =\ dr\_reader.get\_camera();}
\DoxyCodeLine{01487\ \ \ \ \ \ \ \ \ \ \ \ \ key.\_lens\_index\ =\ dr\_reader.get\_lens\_index();}
\DoxyCodeLine{01488\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01489\ }
\DoxyCodeLine{01490\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ this\ is\ a\ shadow\ pass,\ postpone\ culling\ it\ until\ we've\ culled}}
\DoxyCodeLine{01491\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ all\ the\ other\ passes,\ and\ collected\ their\ bounding\ volumes.}}
\DoxyCodeLine{01492\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classLight}{Light}}\ *light\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01493\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!key.\_camera.is\_empty())\ \{}
\DoxyCodeLine{01494\ \ \ \ \ \ \ \ \ \ \ \ \ light\ =\ key.\_camera.node()-\/>as\_light();}
\DoxyCodeLine{01495\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01496\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (light\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01497\ \ \ \ \ \ \ \ \ \ \ \ \ shadow\_passes.push\_back(std::move(scene\_setup));}
\DoxyCodeLine{01498\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01499\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01500\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!shadow\_passes.empty())\ \{}
\DoxyCodeLine{01501\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ scene\_root\ =\ scene\_setup-\/>get\_scene\_root();}
\DoxyCodeLine{01502\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *gbv\ =\ scene\_setup-\/>get\_view\_frustum();}
\DoxyCodeLine{01503\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classUnionBoundingVolume}{UnionBoundingVolume}}\ \&bounds\ =\ non\_shadow\_bounds[scene\_root];}
\DoxyCodeLine{01504\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gbv\ ==\ \textcolor{keyword}{nullptr}\ ||\ gbv-\/>is\_infinite())\ \{}
\DoxyCodeLine{01505\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ bounds.set\_infinite();}
\DoxyCodeLine{01506\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01507\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ bounds.\mbox{\hyperlink{classUnionBoundingVolume_aa460b74667bd3812ca2f3cec11250a44}{add\_component}}(gbv);}
\DoxyCodeLine{01508\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01509\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01510\ }
\DoxyCodeLine{01511\ \ \ \ \ \ \ \ \ \ \ AlreadyCulled::iterator\ aci\ =\ already\_culled.insert(AlreadyCulled::value\_type(std::move(key),\ \textcolor{keyword}{nullptr})).first;}
\DoxyCodeLine{01512\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*aci).second\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01513\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ not\ used\ this\ camera\ already\ in\ this\ thread.\ \ Perform}}
\DoxyCodeLine{01514\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ cull\ operation.}}
\DoxyCodeLine{01515\ \ \ \ \ \ \ \ \ \ \ \ \ cull\_result\ =\ dr-\/>get\_cull\_result(current\_thread);}
\DoxyCodeLine{01516\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cull\_result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01517\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cull\_result\ =\ cull\_result-\/>make\_next();}
\DoxyCodeLine{01518\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01519\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ DisplayRegion\ has\ no\ cull\ results;\ draw\ it.}}
\DoxyCodeLine{01520\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cull\_result\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullResult}{CullResult}}(gsg,\ dr-\/>get\_draw\_region\_pcollector());}
\DoxyCodeLine{01521\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01522\ \ \ \ \ \ \ \ \ \ \ \ \ (*aci).second\ =\ dr;}
\DoxyCodeLine{01523\ \ \ \ \ \ \ \ \ \ \ \ \ cull\_to\_bins(win,\ gsg,\ dr,\ scene\_setup,\ cull\_result,\ current\_thread);}
\DoxyCodeLine{01524\ }
\DoxyCodeLine{01525\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01526\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ already\ culled\ a\ scene\ using\ this\ camera\ in\ this}}
\DoxyCodeLine{01527\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thread,\ and\ now\ we're\ being\ asked\ to\ cull\ another\ scene\ using}}
\DoxyCodeLine{01528\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ same\ camera.\ \ (Maybe\ this\ represents\ two\ different}}
\DoxyCodeLine{01529\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ DisplayRegions\ for\ the\ left\ and\ right\ channels\ of\ a\ stereo}}
\DoxyCodeLine{01530\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ image.)\ \ Of\ course,\ the\ cull\ result\ will\ be\ the\ same,\ so\ just}}
\DoxyCodeLine{01531\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ the\ result\ from\ the\ other\ DisplayRegion.}}
\DoxyCodeLine{01532\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *other\_dr\ =\ (*aci).second;}
\DoxyCodeLine{01533\ \ \ \ \ \ \ \ \ \ \ \ \ cull\_result\ =\ other\_dr-\/>get\_cull\_result(current\_thread);}
\DoxyCodeLine{01534\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01535\ }
\DoxyCodeLine{01536\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Save\ the\ results\ for\ next\ frame.}}
\DoxyCodeLine{01537\ \ \ \ \ \ \ \ \ \ \ dr-\/>set\_cull\_result(std::move(cull\_result),\ std::move(scene\_setup),\ current\_thread);}
\DoxyCodeLine{01538\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01539\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01540\ \ \ \ \ \}}
\DoxyCodeLine{01541\ \ \ \}}
\DoxyCodeLine{01542\ }
\DoxyCodeLine{01543\ \ \ \textcolor{comment}{//\ Now\ cull\ all\ the\ shadow\ passes\ if\ their\ cull\ bounds\ are\ in\ view.}}
\DoxyCodeLine{01544\ \ \ \textcolor{comment}{//\ We\ don't\ bother\ checking\ the\ AlreadyCulled\ list,\ because\ we\ know\ there\ is}}
\DoxyCodeLine{01545\ \ \ \textcolor{comment}{//\ only\ one\ output\ per\ GSG+light\ combination.}}
\DoxyCodeLine{01546\ \ \ \textcolor{keywordflow}{for}\ (PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ \&scene\_setup\ :\ shadow\_passes)\ \{}
\DoxyCodeLine{01547\ \ \ \ \ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *dr\ =\ scene\_setup-\/>get\_display\_region();}
\DoxyCodeLine{01548\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ dr-\/>get\_window();}
\DoxyCodeLine{01549\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(win-\/>get\_cull\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01550\ }
\DoxyCodeLine{01551\ \ \ \ \ PT(\mbox{\hyperlink{classCullResult}{CullResult}})\ cull\_result;}
\DoxyCodeLine{01552\ }
\DoxyCodeLine{01553\ \ \ \ \ \textcolor{comment}{//\ Are\ the\ cull\ bounds\ in\ view\ of\ another\ camera?}}
\DoxyCodeLine{01554\ \ \ \ \ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *frustum\ =\ scene\_setup-\/>get\_view\_frustum();}
\DoxyCodeLine{01555\ \ \ \ \ \textcolor{keywordflow}{if}\ (frustum\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{01556\ \ \ \ \ \ \ \ \ non\_shadow\_bounds[scene\_setup-\/>get\_scene\_root()].contains(frustum))\ \{}
\DoxyCodeLine{01557\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>get\_gsg();}
\DoxyCodeLine{01558\ \ \ \ \ \ \ cull\_result\ =\ dr-\/>get\_cull\_result(current\_thread);}
\DoxyCodeLine{01559\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cull\_result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01560\ \ \ \ \ \ \ \ \ cull\_result\ =\ cull\_result-\/>make\_next();}
\DoxyCodeLine{01561\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01562\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ DisplayRegion\ has\ no\ cull\ results;\ draw\ it.}}
\DoxyCodeLine{01563\ \ \ \ \ \ \ \ \ cull\_result\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullResult}{CullResult}}(gsg,\ dr-\/>get\_draw\_region\_pcollector());}
\DoxyCodeLine{01564\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01565\ \ \ \ \ \ \ cull\_to\_bins(win,\ gsg,\ dr,\ scene\_setup,\ cull\_result,\ current\_thread);}
\DoxyCodeLine{01566\ \ \ \ \ \}}
\DoxyCodeLine{01567\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01568\ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01569\ \ \ \ \ \ \ \ \ <<\ *scene\_setup-\/>get\_camera\_node()}
\DoxyCodeLine{01570\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ frustum\ is\ not\ in\ view,\ skipping\ shadow\ pass\(\backslash\)n"{}};}
\DoxyCodeLine{01571\ \ \ \ \ \}}
\DoxyCodeLine{01572\ }
\DoxyCodeLine{01573\ \ \ \ \ \textcolor{comment}{//\ Even\ save\ the\ results\ if\ null,\ to\ tell\ the\ draw\ pass\ that\ we\ don't\ want}}
\DoxyCodeLine{01574\ \ \ \ \ \textcolor{comment}{//\ to\ draw\ this\ at\ all.}}
\DoxyCodeLine{01575\ \ \ \ \ dr-\/>set\_cull\_result(std::move(cull\_result),\ std::move(scene\_setup),\ current\_thread);}
\DoxyCodeLine{01576\ \ \ \}}
\DoxyCodeLine{01577\ \}}
\DoxyCodeLine{01578\ }
\DoxyCodeLine{01582\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01583\ cull\_to\_bins(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win,\ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,}
\DoxyCodeLine{01584\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *dr,\ \mbox{\hyperlink{classSceneSetup}{SceneSetup}}\ *scene\_setup,}
\DoxyCodeLine{01585\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCullResult}{CullResult}}\ *cull\_result,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01586\ }
\DoxyCodeLine{01587\ \ \ \mbox{\hyperlink{classBinCullHandler}{BinCullHandler}}\ cull\_handler(cull\_result);}
\DoxyCodeLine{01588\ \ \ \mbox{\hyperlink{classCallbackObject}{CallbackObject}}\ *cbobj\ =\ dr-\/>get\_cull\_callback();}
\DoxyCodeLine{01589\ \ \ \textcolor{keywordflow}{if}\ (cbobj\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01590\ \ \ \ \ \textcolor{comment}{//\ Issue\ the\ cull\ callback\ on\ this\ DisplayRegion.}}
\DoxyCodeLine{01591\ \ \ \ \ \mbox{\hyperlink{classDisplayRegionCullCallbackData}{DisplayRegionCullCallbackData}}\ cbdata(\&cull\_handler,\ scene\_setup);}
\DoxyCodeLine{01592\ \ \ \ \ cbobj-\/>\mbox{\hyperlink{classCallbackObject_a373ebcf6f5fd83bbb5f578f309b61717}{do\_callback}}(\&cbdata);}
\DoxyCodeLine{01593\ }
\DoxyCodeLine{01594\ \ \ \ \ \textcolor{comment}{//\ The\ callback\ has\ taken\ care\ of\ the\ culling.}}
\DoxyCodeLine{01595\ }
\DoxyCodeLine{01596\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01597\ \ \ \ \ \textcolor{comment}{//\ Perform\ the\ cull\ normally.}}
\DoxyCodeLine{01598\ \ \ \ \ dr-\/>\mbox{\hyperlink{classDisplayRegion_a89d404a8bf4e69302699671adcf776f5}{do\_cull}}(\&cull\_handler,\ scene\_setup,\ gsg,\ current\_thread);}
\DoxyCodeLine{01599\ \ \ \}}
\DoxyCodeLine{01600\ }
\DoxyCodeLine{01601\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cull\_sort\_pcollector,\ current\_thread);}
\DoxyCodeLine{01602\ \ \ cull\_result-\/>\mbox{\hyperlink{classCullResult_ae5621d083685766970ac29ad49e85dc8}{finish\_cull}}(scene\_setup,\ current\_thread);}
\DoxyCodeLine{01603\ \}}
\DoxyCodeLine{01604\ }
\DoxyCodeLine{01610\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01611\ draw\_bins(\textcolor{keyword}{const}\ \mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ \&wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01612\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_draw\_pcollector,\ current\_thread);}
\DoxyCodeLine{01613\ }
\DoxyCodeLine{01614\ \ \ nassertv(wlist.verify\_list());}
\DoxyCodeLine{01615\ }
\DoxyCodeLine{01616\ \ \ \textcolor{keywordtype}{size\_t}\ wlist\_size\ =\ wlist.size();}
\DoxyCodeLine{01617\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ wi\ =\ 0;\ wi\ <\ wlist\_size;\ ++wi)\ \{}
\DoxyCodeLine{01618\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ wlist[wi];}
\DoxyCodeLine{01619\ }
\DoxyCodeLine{01620\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a95095b8c8c7b7b8ecf7c84062c0e3520}{is\_active}}())\ \{}
\DoxyCodeLine{01621\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ win-\/>get\_gsg();}
\DoxyCodeLine{01622\ }
\DoxyCodeLine{01623\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *host\ =\ win-\/>\mbox{\hyperlink{classGraphicsOutput_a9f426f4eafec2f5fc6d207a0828bab5d}{get\_host}}();}
\DoxyCodeLine{01624\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (host-\/>flip\_ready())\ \{}
\DoxyCodeLine{01625\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01626\ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01627\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Flipping\ window\ "{}}\ <<\ host-\/>get\_name()}
\DoxyCodeLine{01628\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ before\ drawing\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01629\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01630\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01631\ \ \ \ \ \ \ \ \ host-\/>\mbox{\hyperlink{classGraphicsOutput_a2406222f6dd4df14b3e2c4c5ac8c1001}{begin\_flip}}();}
\DoxyCodeLine{01632\ \ \ \ \ \ \ \ \ host-\/>\mbox{\hyperlink{classGraphicsOutput_a593a9030f0b90ee588b1006df9aee604}{end\_flip}}();}
\DoxyCodeLine{01633\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01634\ }
\DoxyCodeLine{01635\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a82bbfa980adaaa4abcdaa8c567182db1}{begin\_frame}}(GraphicsOutput::FM\_render,\ current\_thread))\ \{}
\DoxyCodeLine{01636\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ place\ this\ collector\ inside\ begin\_frame,\ because\ we\ need}}
\DoxyCodeLine{01637\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ a\ current\ context\ for\ PStatGPUTimer\ to\ work.}}
\DoxyCodeLine{01638\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01639\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ win-\/>get\_draw\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01640\ }
\DoxyCodeLine{01641\ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_ab5cedbe18daea18e79c0167dac2d0bd1}{copy\_async\_screenshot}}();}
\DoxyCodeLine{01642\ }
\DoxyCodeLine{01643\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classDrawableRegion_a7cf04a992ac977ba7d706c81871ed1b5}{is\_any\_clear\_active}}())\ \{}
\DoxyCodeLine{01644\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ win-\/>get\_clear\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{01645\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>get\_gsg()-\/>push\_group\_marker(\textcolor{stringliteral}{"{}Clear"{}});}
\DoxyCodeLine{01646\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_aead3c39332275a61c14928bf3b63ba5c}{clear}}(current\_thread);}
\DoxyCodeLine{01647\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>get\_gsg()-\/>pop\_group\_marker();}
\DoxyCodeLine{01648\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01649\ }
\DoxyCodeLine{01650\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01651\ \ \ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01652\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Drawing\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01653\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01654\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_display\_regions\ =\ win-\/>get\_num\_active\_display\_regions();}
\DoxyCodeLine{01655\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_display\_regions;\ ++i)\ \{}
\DoxyCodeLine{01656\ \ \ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDisplayRegion}{DisplayRegion}})\ dr\ =\ win-\/>get\_active\_display\_region(i);}
\DoxyCodeLine{01657\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01658\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ do\_draw(win,\ gsg,\ dr,\ current\_thread);}
\DoxyCodeLine{01659\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01660\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01661\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01662\ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a51bf142d4d882476b8a089581474dd0f}{end\_frame}}(GraphicsOutput::FM\_render,\ current\_thread);}
\DoxyCodeLine{01663\ }
\DoxyCodeLine{01664\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_auto\_flip)\ \{}
\DoxyCodeLine{01665\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>flip\_ready())\ \{}
\DoxyCodeLine{01666\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01667\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01668\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Flipping\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01669\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01670\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ \_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01671\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a2406222f6dd4df14b3e2c4c5ac8c1001}{begin\_flip}}();}
\DoxyCodeLine{01672\ \ \ \ \ \ \ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a593a9030f0b90ee588b1006df9aee604}{end\_flip}}();}
\DoxyCodeLine{01673\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01674\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01675\ }
\DoxyCodeLine{01676\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01677\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01678\ \ \ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01679\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Not\ drawing\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01680\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01681\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01682\ }
\DoxyCodeLine{01683\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01684\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01685\ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01686\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\ is\ inactive\(\backslash\)n"{}};}
\DoxyCodeLine{01687\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01688\ \ \ \ \ \}}
\DoxyCodeLine{01689\ \ \ \}}
\DoxyCodeLine{01690\ \}}
\DoxyCodeLine{01691\ }
\DoxyCodeLine{01696\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01697\ make\_contexts(\textcolor{keyword}{const}\ \mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ \&wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01698\ \ \ Windows::const\_iterator\ wi;}
\DoxyCodeLine{01699\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ wlist.begin();\ wi\ !=\ wlist.end();\ ++wi)\ \{}
\DoxyCodeLine{01700\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{01701\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>\mbox{\hyperlink{classGraphicsOutput_a82bbfa980adaaa4abcdaa8c567182db1}{begin\_frame}}(GraphicsOutput::FM\_refresh,\ current\_thread))\ \{}
\DoxyCodeLine{01702\ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a51bf142d4d882476b8a089581474dd0f}{end\_frame}}(GraphicsOutput::FM\_refresh,\ current\_thread);}
\DoxyCodeLine{01703\ \ \ \ \ \}}
\DoxyCodeLine{01704\ \ \ \}}
\DoxyCodeLine{01705\ \}}
\DoxyCodeLine{01706\ }
\DoxyCodeLine{01712\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01713\ process\_events(\textcolor{keyword}{const}\ \mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ \&wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01714\ \ \ \textcolor{comment}{//\ We're\ not\ using\ a\ vector\ iterator\ here,\ since\ it's\ possible\ that\ the}}
\DoxyCodeLine{01715\ \ \ \textcolor{comment}{//\ window\ list\ changes\ in\ an\ event,\ which\ would\ invalidate\ the\ iterator\ and}}
\DoxyCodeLine{01716\ \ \ \textcolor{comment}{//\ cause\ a\ crash.}}
\DoxyCodeLine{01717\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ wlist.size();\ ++i)\ \{}
\DoxyCodeLine{01718\ \ \ \ \ wlist[i]-\/>process\_events();}
\DoxyCodeLine{01719\ \ \ \}}
\DoxyCodeLine{01720\ \}}
\DoxyCodeLine{01721\ }
\DoxyCodeLine{01727\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01728\ flip\_windows(\textcolor{keyword}{const}\ \mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ \&wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01729\ \ \ \textcolor{keywordtype}{size\_t}\ num\_windows\ =\ wlist.size();}
\DoxyCodeLine{01730\ \ \ \textcolor{keywordtype}{size\_t}\ warray\_size\ =\ num\_windows\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *);}
\DoxyCodeLine{01731\ \ \ \textcolor{keywordtype}{size\_t}\ warray\_count\ =\ 0;}
\DoxyCodeLine{01732\ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ **warray\ =\ (\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ **)alloca(warray\_size);}
\DoxyCodeLine{01733\ }
\DoxyCodeLine{01734\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01735\ }
\DoxyCodeLine{01736\ \ \ \textcolor{keywordtype}{size\_t}\ i;}
\DoxyCodeLine{01737\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_windows;\ ++i)\ \{}
\DoxyCodeLine{01738\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ wlist[i];}
\DoxyCodeLine{01739\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>flip\_ready())\ \{}
\DoxyCodeLine{01740\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{01741\ \ \ \ \ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{01742\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Flipping\ window\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01743\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01744\ }
\DoxyCodeLine{01745\ \ \ \ \ \ \ nassertv(warray\_count\ <\ num\_windows);}
\DoxyCodeLine{01746\ \ \ \ \ \ \ warray[warray\_count]\ =\ win;}
\DoxyCodeLine{01747\ \ \ \ \ \ \ ++warray\_count;}
\DoxyCodeLine{01748\ }
\DoxyCodeLine{01749\ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a2406222f6dd4df14b3e2c4c5ac8c1001}{begin\_flip}}();}
\DoxyCodeLine{01750\ \ \ \ \ \}}
\DoxyCodeLine{01751\ \ \ \}}
\DoxyCodeLine{01752\ }
\DoxyCodeLine{01753\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ warray\_count;\ ++i)\ \{}
\DoxyCodeLine{01754\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ warray[i];}
\DoxyCodeLine{01755\ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a593a9030f0b90ee588b1006df9aee604}{end\_flip}}();}
\DoxyCodeLine{01756\ \ \ \}}
\DoxyCodeLine{01757\ \}}
\DoxyCodeLine{01758\ }
\DoxyCodeLine{01764\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01765\ ready\_flip\_windows(\textcolor{keyword}{const}\ \mbox{\hyperlink{classov__set}{GraphicsEngine::Windows}}\ \&wlist,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01766\ \ \ Windows::const\_iterator\ wi;}
\DoxyCodeLine{01767\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ wlist.begin();\ wi\ !=\ wlist.end();\ ++wi)\ \{}
\DoxyCodeLine{01768\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{01769\ \ \ \ \ \textcolor{keywordflow}{if}\ (win-\/>flip\_ready())\ \{}
\DoxyCodeLine{01770\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01771\ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a0319f5e31d729371b20b8ecd6b74c2a8}{ready\_flip}}();}
\DoxyCodeLine{01772\ \ \ \ \ \}}
\DoxyCodeLine{01773\ \ \ \}}
\DoxyCodeLine{01774\ \}}
\DoxyCodeLine{01775\ }
\DoxyCodeLine{01780\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01781\ do\_sync\_frame(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01782\ \ \ nassertv(\_lock.debug\_is\_locked());}
\DoxyCodeLine{01783\ }
\DoxyCodeLine{01784\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{01785\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_sync\_pcollector,\ current\_thread);}
\DoxyCodeLine{01786\ }
\DoxyCodeLine{01787\ \ \ nassertv(\_flip\_state\ ==\ FS\_draw);}
\DoxyCodeLine{01788\ }
\DoxyCodeLine{01789\ \ \ \textcolor{comment}{//\ Wait\ for\ all\ the\ threads\ to\ finish\ their\ current\ frame.\ \ Grabbing\ and}}
\DoxyCodeLine{01790\ \ \ \textcolor{comment}{//\ releasing\ the\ mutex\ should\ achieve\ that.}}
\DoxyCodeLine{01791\ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{01792\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{01793\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{01794\ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{01795\ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{01796\ \ \ \}}
\DoxyCodeLine{01797\ }
\DoxyCodeLine{01798\ \ \ \_flip\_state\ =\ FS\_sync;}
\DoxyCodeLine{01799\ \}}
\DoxyCodeLine{01800\ }
\DoxyCodeLine{01805\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01806\ do\_ready\_flip(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01807\ \ \ nassertv(\_lock.debug\_is\_locked());}
\DoxyCodeLine{01808\ }
\DoxyCodeLine{01809\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{01810\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_sync\_pcollector,\ current\_thread);}
\DoxyCodeLine{01811\ }
\DoxyCodeLine{01812\ \ \ nassertv(\_flip\_state\ ==\ FS\_draw);}
\DoxyCodeLine{01813\ }
\DoxyCodeLine{01814\ \ \ \textcolor{comment}{//\ Wait\ for\ all\ the\ threads\ to\ finish\ their\ current\ frame.\ \ Grabbing\ and}}
\DoxyCodeLine{01815\ \ \ \textcolor{comment}{//\ releasing\ the\ mutex\ should\ achieve\ that.}}
\DoxyCodeLine{01816\ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{01817\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{01818\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{01819\ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{01820\ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{01821\ \ \ \}}
\DoxyCodeLine{01822\ \ \ \_app.do\_ready\_flip(\textcolor{keyword}{this},current\_thread);}
\DoxyCodeLine{01823\ \ \ \_flip\_state\ =\ FS\_sync;}
\DoxyCodeLine{01824\ \}}
\DoxyCodeLine{01825\ }
\DoxyCodeLine{01830\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{01831\ do\_flip\_frame(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01832\ \ \ nassertv(\_lock.debug\_is\_locked());}
\DoxyCodeLine{01833\ }
\DoxyCodeLine{01834\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{01835\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_flip\_pcollector,\ current\_thread);}
\DoxyCodeLine{01836\ }
\DoxyCodeLine{01837\ \ \ nassertv(\_flip\_state\ ==\ FS\_draw\ ||\ \_flip\_state\ ==\ FS\_sync);}
\DoxyCodeLine{01838\ }
\DoxyCodeLine{01839\ \ \ \textcolor{comment}{//\ First,\ wait\ for\ all\ the\ threads\ to\ finish\ their\ current\ frame,\ if}}
\DoxyCodeLine{01840\ \ \ \textcolor{comment}{//\ necessary.\ \ Grabbing\ the\ mutex\ (and\ waiting\ for\ TS\_wait)\ should\ achieve}}
\DoxyCodeLine{01841\ \ \ \textcolor{comment}{//\ that.}}
\DoxyCodeLine{01842\ \ \ \{}
\DoxyCodeLine{01843\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_wait\_pcollector,\ current\_thread);}
\DoxyCodeLine{01844\ \ \ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{01845\ \ \ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{01846\ \ \ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{01847\ \ \ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{01848\ }
\DoxyCodeLine{01849\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (thread-\/>\_thread\_state\ !=\ TS\_wait)\ \{}
\DoxyCodeLine{01850\ \ \ \ \ \ \ \ \ thread-\/>\_cv\_done.wait();}
\DoxyCodeLine{01851\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01852\ \ \ \ \ \}}
\DoxyCodeLine{01853\ \ \ \}}
\DoxyCodeLine{01854\ }
\DoxyCodeLine{01855\ \ \ \textcolor{comment}{//\ Now\ signal\ all\ of\ our\ threads\ to\ flip\ the\ windows.}}
\DoxyCodeLine{01856\ \ \ \_app.do\_flip(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{01857\ }
\DoxyCodeLine{01858\ \ \ \{}
\DoxyCodeLine{01859\ \ \ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{01860\ \ \ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{01861\ \ \ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{01862\ \ \ \ \ \ \ nassertv(thread-\/>\_thread\_state\ ==\ TS\_wait);}
\DoxyCodeLine{01863\ \ \ \ \ \ \ thread-\/>\_thread\_state\ =\ TS\_do\_flip;}
\DoxyCodeLine{01864\ \ \ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{01865\ \ \ \ \ \ \ thread-\/>\_cv\_start.notify();}
\DoxyCodeLine{01866\ \ \ \ \ \}}
\DoxyCodeLine{01867\ \ \ \}}
\DoxyCodeLine{01868\ }
\DoxyCodeLine{01869\ \ \ \_flip\_state\ =\ FS\_flip;}
\DoxyCodeLine{01870\ \}}
\DoxyCodeLine{01871\ }
\DoxyCodeLine{01877\ PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ GraphicsEngine::}
\DoxyCodeLine{01878\ setup\_scene(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,\ \mbox{\hyperlink{classDisplayRegionPipelineReader}{DisplayRegionPipelineReader}}\ *dr)\ \{}
\DoxyCodeLine{01879\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ dr-\/>get\_current\_thread();}
\DoxyCodeLine{01880\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_cull\_setup\_pcollector,\ current\_thread);}
\DoxyCodeLine{01881\ }
\DoxyCodeLine{01882\ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window\ =\ dr-\/>get\_window();}
\DoxyCodeLine{01883\ \ \ \textcolor{comment}{//\ The\ window\ pointer\ shouldn't\ be\ NULL,\ since\ we\ presumably\ got\ to\ this}}
\DoxyCodeLine{01884\ \ \ \textcolor{comment}{//\ particular\ DisplayRegion\ by\ walking\ through\ a\ list\ on\ a\ window.}}
\DoxyCodeLine{01885\ \ \ nassertr(window\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01886\ }
\DoxyCodeLine{01887\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ camera\ =\ dr-\/>get\_camera();}
\DoxyCodeLine{01888\ \ \ \textcolor{keywordflow}{if}\ (camera.is\_empty())\ \{}
\DoxyCodeLine{01889\ \ \ \ \ \textcolor{comment}{//\ No\ camera,\ no\ draw.}}
\DoxyCodeLine{01890\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01891\ \ \ \}}
\DoxyCodeLine{01892\ }
\DoxyCodeLine{01893\ \ \ \mbox{\hyperlink{classCamera}{Camera}}\ *camera\_node;}
\DoxyCodeLine{01894\ \ \ DCAST\_INTO\_R(camera\_node,\ camera.node(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01895\ }
\DoxyCodeLine{01896\ \ \ \textcolor{keywordflow}{if}\ (!camera\_node-\/>is\_active())\ \{}
\DoxyCodeLine{01897\ \ \ \ \ \textcolor{comment}{//\ Camera\ inactive,\ no\ draw.}}
\DoxyCodeLine{01898\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01899\ \ \ \}}
\DoxyCodeLine{01900\ \ \ camera\_node-\/>\mbox{\hyperlink{classCamera_acdd65620653880e3ff280e5726139dc2}{cleanup\_aux\_scene\_data}}(current\_thread);}
\DoxyCodeLine{01901\ }
\DoxyCodeLine{01902\ \ \ \textcolor{keywordtype}{int}\ lens\_index\ =\ dr-\/>get\_lens\_index();}
\DoxyCodeLine{01903\ \ \ \mbox{\hyperlink{classLens}{Lens}}\ *lens\ =\ camera\_node-\/>get\_lens(lens\_index);}
\DoxyCodeLine{01904\ \ \ \textcolor{keywordflow}{if}\ (lens\ ==\ \textcolor{keyword}{nullptr}\ ||\ !camera\_node-\/>get\_lens\_active(lens\_index))\ \{}
\DoxyCodeLine{01905\ \ \ \ \ \textcolor{comment}{//\ No\ lens,\ no\ draw.}}
\DoxyCodeLine{01906\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01907\ \ \ \}}
\DoxyCodeLine{01908\ }
\DoxyCodeLine{01909\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ scene\_root\ =\ camera\_node-\/>get\_scene();}
\DoxyCodeLine{01910\ \ \ \textcolor{keywordflow}{if}\ (scene\_root.is\_empty())\ \{}
\DoxyCodeLine{01911\ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ explicit\ scene\ specified,\ use\ whatever\ scene\ the\ camera}}
\DoxyCodeLine{01912\ \ \ \ \ \textcolor{comment}{//\ is\ parented\ within.\ \ This\ is\ the\ normal\ and\ preferred\ case;\ the\ use\ of}}
\DoxyCodeLine{01913\ \ \ \ \ \textcolor{comment}{//\ an\ explicit\ scene\ is\ now\ deprecated.}}
\DoxyCodeLine{01914\ \ \ \ \ scene\_root\ =\ camera.get\_top(current\_thread);}
\DoxyCodeLine{01915\ \ \ \}}
\DoxyCodeLine{01916\ }
\DoxyCodeLine{01917\ \ \ PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ scene\_setup\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classSceneSetup}{SceneSetup}};}
\DoxyCodeLine{01918\ }
\DoxyCodeLine{01919\ \ \ \textcolor{comment}{//\ We\ will\ need\ both\ the\ camera\ transform\ (the\ net\ transform\ to\ the\ camera}}
\DoxyCodeLine{01920\ \ \ \textcolor{comment}{//\ from\ the\ scene)\ and\ the\ world\ transform\ (the\ camera\ transform\ inverse,\ or}}
\DoxyCodeLine{01921\ \ \ \textcolor{comment}{//\ the\ net\ transform\ to\ the\ scene\ from\ the\ camera).\ \ These\ are\ actually}}
\DoxyCodeLine{01922\ \ \ \textcolor{comment}{//\ defined\ from\ the\ parent\ of\ the\ scene\_root,\ because\ the\ scene\_root's\ own}}
\DoxyCodeLine{01923\ \ \ \textcolor{comment}{//\ transform\ is\ immediately\ applied\ to\ these\ during\ rendering.\ \ (Normally,}}
\DoxyCodeLine{01924\ \ \ \textcolor{comment}{//\ the\ parent\ of\ the\ scene\_root\ is\ the\ empty\ NodePath,\ although\ it\ need\ not}}
\DoxyCodeLine{01925\ \ \ \textcolor{comment}{//\ be.)}}
\DoxyCodeLine{01926\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ scene\_parent\ =\ scene\_root.get\_parent(current\_thread);}
\DoxyCodeLine{01927\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ camera\_transform\ =\ camera.get\_transform(scene\_parent,\ current\_thread);}
\DoxyCodeLine{01928\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ world\_transform\ =\ scene\_parent.get\_transform(camera,\ current\_thread);}
\DoxyCodeLine{01929\ }
\DoxyCodeLine{01930\ \ \ \textcolor{keywordflow}{if}\ (camera\_transform-\/>is\_invalid())\ \{}
\DoxyCodeLine{01931\ \ \ \ \ \textcolor{comment}{//\ There\ must\ be\ a\ singular\ transform\ over\ the\ scene.}}
\DoxyCodeLine{01932\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_singular\_warning\_last\_frame)\ \{}
\DoxyCodeLine{01933\ \ \ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{01934\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Scene\ "{}}\ <<\ scene\_root\ <<\ \textcolor{stringliteral}{"{}\ has\ net\ scale\ ("{}}}
\DoxyCodeLine{01935\ \ \ \ \ \ \ \ \ <<\ scene\_root.get\_scale(\mbox{\hyperlink{classNodePath}{NodePath}}())\ <<\ \textcolor{stringliteral}{"{});\ cannot\ render.\(\backslash\)n"{}};}
\DoxyCodeLine{01936\ \ \ \ \ \ \ \_singular\_warning\_this\_frame\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01937\ \ \ \ \ \}}
\DoxyCodeLine{01938\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01939\ \ \ \}}
\DoxyCodeLine{01940\ }
\DoxyCodeLine{01941\ \ \ \textcolor{keywordflow}{if}\ (world\_transform-\/>is\_invalid())\ \{}
\DoxyCodeLine{01942\ \ \ \ \ \textcolor{comment}{//\ There\ must\ be\ a\ singular\ transform\ over\ the\ camera.}}
\DoxyCodeLine{01943\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_singular\_warning\_last\_frame)\ \{}
\DoxyCodeLine{01944\ \ \ \ \ \ \ display\_cat.warning()}
\DoxyCodeLine{01945\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Camera\ "{}}\ <<\ camera\ <<\ \textcolor{stringliteral}{"{}\ has\ net\ scale\ ("{}}}
\DoxyCodeLine{01946\ \ \ \ \ \ \ \ \ <<\ camera.get\_scale(\mbox{\hyperlink{classNodePath}{NodePath}}())\ <<\ \textcolor{stringliteral}{"{});\ cannot\ render.\(\backslash\)n"{}};}
\DoxyCodeLine{01947\ \ \ \ \ \}}
\DoxyCodeLine{01948\ \ \ \ \ \_singular\_warning\_this\_frame\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01949\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01950\ \ \ \}}
\DoxyCodeLine{01951\ }
\DoxyCodeLine{01952\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ initial\_state\ =\ camera\_node-\/>get\_initial\_state();}
\DoxyCodeLine{01953\ }
\DoxyCodeLine{01954\ \ \ \textcolor{keywordflow}{if}\ (window-\/>get\_inverted())\ \{}
\DoxyCodeLine{01955\ \ \ \ \ \textcolor{comment}{//\ If\ the\ window\ is\ to\ be\ inverted,\ we\ must\ set\ the\ inverted\ flag\ on\ the}}
\DoxyCodeLine{01956\ \ \ \ \ \textcolor{comment}{//\ SceneSetup\ object,\ so\ that\ the\ GSG\ will\ be\ able\ to\ invert\ the}}
\DoxyCodeLine{01957\ \ \ \ \ \textcolor{comment}{//\ projection\ matrix\ at\ the\ last\ minute.}}
\DoxyCodeLine{01958\ \ \ \ \ scene\_setup-\/>set\_inverted(\textcolor{keyword}{true});}
\DoxyCodeLine{01959\ }
\DoxyCodeLine{01960\ \ \ \ \ \textcolor{comment}{//\ This\ also\ means\ we\ need\ to\ globally\ invert\ the\ sense\ of\ polygon\ vertex}}
\DoxyCodeLine{01961\ \ \ \ \ \textcolor{comment}{//\ ordering.}}
\DoxyCodeLine{01962\ \ \ \ \ initial\_state\ =\ initial\_state-\/>compose(get\_invert\_polygon\_state());}
\DoxyCodeLine{01963\ \ \ \}}
\DoxyCodeLine{01964\ }
\DoxyCodeLine{01965\ \ \ scene\_setup-\/>set\_display\_region(dr-\/>get\_object());}
\DoxyCodeLine{01966\ \ \ scene\_setup-\/>set\_viewport\_size(dr-\/>get\_pixel\_width(),\ dr-\/>get\_pixel\_height());}
\DoxyCodeLine{01967\ \ \ scene\_setup-\/>set\_scene\_root(scene\_root);}
\DoxyCodeLine{01968\ \ \ scene\_setup-\/>set\_camera\_path(camera);}
\DoxyCodeLine{01969\ \ \ scene\_setup-\/>set\_camera\_node(camera\_node);}
\DoxyCodeLine{01970\ \ \ scene\_setup-\/>set\_lens(lens);}
\DoxyCodeLine{01971\ \ \ scene\_setup-\/>set\_initial\_state(initial\_state);}
\DoxyCodeLine{01972\ \ \ scene\_setup-\/>set\_camera\_transform(camera\_transform);}
\DoxyCodeLine{01973\ \ \ scene\_setup-\/>set\_world\_transform(world\_transform);}
\DoxyCodeLine{01974\ }
\DoxyCodeLine{01975\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ cs\_transform\ =\ gsg-\/>get\_cs\_transform\_for(lens-\/>get\_coordinate\_system());}
\DoxyCodeLine{01976\ \ \ scene\_setup-\/>set\_cs\_transform(cs\_transform);}
\DoxyCodeLine{01977\ }
\DoxyCodeLine{01978\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ cs\_world\_transform\ =\ cs\_transform-\/>compose(world\_transform);}
\DoxyCodeLine{01979\ \ \ scene\_setup-\/>set\_cs\_world\_transform(cs\_world\_transform);}
\DoxyCodeLine{01980\ }
\DoxyCodeLine{01981\ \ \ \textcolor{keywordflow}{if}\ (view\_frustum\_cull)\ \{}
\DoxyCodeLine{01982\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ to\ be\ performing\ view-\/frustum\ culling,\ determine\ the\ bounding}}
\DoxyCodeLine{01983\ \ \ \ \ \textcolor{comment}{//\ volume\ associated\ with\ the\ current\ viewing\ frustum.}}
\DoxyCodeLine{01984\ }
\DoxyCodeLine{01985\ \ \ \ \ \textcolor{comment}{//\ First,\ we\ have\ to\ get\ the\ current\ viewing\ frustum,\ which\ comes\ from\ the}}
\DoxyCodeLine{01986\ \ \ \ \ \textcolor{comment}{//\ lens.}}
\DoxyCodeLine{01987\ \ \ \ \ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ bv\ =\ scene\_setup-\/>get\_cull\_bounds();}
\DoxyCodeLine{01988\ }
\DoxyCodeLine{01989\ \ \ \ \ \textcolor{keywordflow}{if}\ (bv\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ !bv-\/>is\_infinite()\ \&\&}
\DoxyCodeLine{01990\ \ \ \ \ \ \ \ \ bv-\/>as\_geometric\_bounding\_volume()\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01991\ \ \ \ \ \ \ \textcolor{comment}{//\ Transform\ it\ into\ the\ appropriate\ coordinate\ space.}}
\DoxyCodeLine{01992\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}})\ local\_frustum;}
\DoxyCodeLine{01993\ \ \ \ \ \ \ local\_frustum\ =\ bv-\/>make\_copy()-\/>as\_geometric\_bounding\_volume();}
\DoxyCodeLine{01994\ \ \ \ \ \ \ nassertr(!local\_frustum.is\_null(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01995\ }
\DoxyCodeLine{01996\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ cull\_center\_transform\ =}
\DoxyCodeLine{01997\ \ \ \ \ \ \ \ \ scene\_setup-\/>get\_cull\_center().get\_transform(scene\_parent,\ current\_thread);}
\DoxyCodeLine{01998\ \ \ \ \ \ \ local\_frustum-\/>xform(cull\_center\_transform-\/>get\_mat());}
\DoxyCodeLine{01999\ }
\DoxyCodeLine{02000\ \ \ \ \ \ \ scene\_setup-\/>set\_view\_frustum(local\_frustum);}
\DoxyCodeLine{02001\ \ \ \ \ \}}
\DoxyCodeLine{02002\ \ \ \}}
\DoxyCodeLine{02003\ }
\DoxyCodeLine{02004\ \ \ \textcolor{keywordflow}{return}\ scene\_setup;}
\DoxyCodeLine{02005\ \}}
\DoxyCodeLine{02006\ }
\DoxyCodeLine{02010\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02011\ do\_draw(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win,\ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,\ \mbox{\hyperlink{classDisplayRegion}{DisplayRegion}}\ *dr,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02012\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{02013\ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ dr-\/>get\_draw\_region\_pcollector(),\ current\_thread);}
\DoxyCodeLine{02014\ }
\DoxyCodeLine{02015\ \ \ gsg-\/>push\_group\_marker(dr-\/>get\_debug\_name());}
\DoxyCodeLine{02016\ }
\DoxyCodeLine{02017\ \ \ PT(\mbox{\hyperlink{classCullResult}{CullResult}})\ cull\_result;}
\DoxyCodeLine{02018\ \ \ PT(\mbox{\hyperlink{classSceneSetup}{SceneSetup}})\ scene\_setup;}
\DoxyCodeLine{02019\ \ \ \{}
\DoxyCodeLine{02020\ \ \ \ \ \mbox{\hyperlink{classCycleDataReader}{DisplayRegion::CDCullReader}}\ cdata(dr-\/>\_cycler\_cull,\ current\_thread);}
\DoxyCodeLine{02021\ \ \ \ \ cull\_result\ =\ cdata-\/>\_cull\_result;}
\DoxyCodeLine{02022\ \ \ \ \ scene\_setup\ =\ cdata-\/>\_scene\_setup;}
\DoxyCodeLine{02023\ \ \ \}}
\DoxyCodeLine{02024\ }
\DoxyCodeLine{02025\ \ \ \mbox{\hyperlink{classCallbackObject}{CallbackObject}}\ *cbobj;}
\DoxyCodeLine{02026\ }
\DoxyCodeLine{02027\ \ \ \{}
\DoxyCodeLine{02028\ \ \ \ \ \mbox{\hyperlink{classDisplayRegionPipelineReader}{DisplayRegionPipelineReader}}\ dr\_reader(dr,\ current\_thread);}
\DoxyCodeLine{02029\ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_a5ebecf1b66237530202157017494c026}{change\_scenes}}(\&dr\_reader);}
\DoxyCodeLine{02030\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a60bb06c5987b92bc39591d4a27bea4ab}{prepare\_display\_region}}(\&dr\_reader);}
\DoxyCodeLine{02031\ \ \ \ \ \textcolor{keywordflow}{if}\ (dr\_reader.is\_any\_clear\_active())\ \{}
\DoxyCodeLine{02032\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatGPUTimer}{PStatGPUTimer}}\ timer(gsg,\ win-\/>get\_clear\_window\_pcollector(),\ current\_thread);}
\DoxyCodeLine{02033\ \ \ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ae2c8994262a8a36ce73c20faf0cc813a}{clear}}(dr\_reader.get\_object());}
\DoxyCodeLine{02034\ \ \ \ \ \}}
\DoxyCodeLine{02035\ }
\DoxyCodeLine{02036\ \ \ \ \ cbobj\ =\ dr\_reader.get\_draw\_callback();}
\DoxyCodeLine{02037\ \ \ \}}
\DoxyCodeLine{02038\ }
\DoxyCodeLine{02039\ \ \ \textcolor{keywordflow}{if}\ (cbobj\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02040\ \ \ \ \ \textcolor{comment}{//\ Issue\ the\ draw\ callback\ on\ this\ DisplayRegion.}}
\DoxyCodeLine{02041\ }
\DoxyCodeLine{02042\ \ \ \ \ \textcolor{comment}{//\ Set\ the\ GSG\ to\ the\ initial\ state.\ \ We\ disable\ depth\ testing\ since\ that}}
\DoxyCodeLine{02043\ \ \ \ \ \textcolor{comment}{//\ is\ the\ default\ OpenGL\ state,\ and\ some\ libraries\ (eg.\ Kivy)\ expect\ that.}}
\DoxyCodeLine{02044\ \ \ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ RenderState::make(}
\DoxyCodeLine{02045\ \ \ \ \ \ \ DepthTestAttrib::make(DepthTestAttrib::M\_none));}
\DoxyCodeLine{02046\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a14782c6df90846e9461abf43bfc52e36}{clear\_before\_callback}}();}
\DoxyCodeLine{02047\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ad6f69fb763c86c69eca984c49c92c36a}{set\_state\_and\_transform}}(state,\ TransformState::make\_identity());}
\DoxyCodeLine{02048\ }
\DoxyCodeLine{02049\ \ \ \ \ \mbox{\hyperlink{classDisplayRegionDrawCallbackData}{DisplayRegionDrawCallbackData}}\ cbdata(cull\_result,\ scene\_setup);}
\DoxyCodeLine{02050\ \ \ \ \ cbobj-\/>\mbox{\hyperlink{classCallbackObject_a373ebcf6f5fd83bbb5f578f309b61717}{do\_callback}}(\&cbdata);}
\DoxyCodeLine{02051\ }
\DoxyCodeLine{02052\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ trust\ the\ state\ the\ callback\ may\ have\ left\ us\ in.}}
\DoxyCodeLine{02053\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a5765d9a3a172b3dc26c1d4487c0da72d}{clear\_state\_and\_transform}}();}
\DoxyCodeLine{02054\ }
\DoxyCodeLine{02055\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cull\_result\ ==\ \textcolor{keyword}{nullptr}\ ||\ scene\_setup\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02056\ \ \ \ \ \textcolor{comment}{//\ Nothing\ to\ see\ here.}}
\DoxyCodeLine{02057\ }
\DoxyCodeLine{02058\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (dr-\/>\mbox{\hyperlink{classDisplayRegion_ab5ec04c0765e71a669b52a3b01d2629a}{is\_stereo}}())\ \{}
\DoxyCodeLine{02059\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ actually\ draw\ the\ stereo\ DisplayRegions.\ \ These\ are\ just}}
\DoxyCodeLine{02060\ \ \ \ \ \textcolor{comment}{//\ placeholders;\ we\ draw\ the\ individual\ left\ and\ right\ eyes\ instead.\ \ (We}}
\DoxyCodeLine{02061\ \ \ \ \ \textcolor{comment}{//\ might\ still\ clear\ the\ stereo\ DisplayRegions,\ though,\ since\ it's}}
\DoxyCodeLine{02062\ \ \ \ \ \textcolor{comment}{//\ probably\ faster\ to\ clear\ right\ and\ left\ channels\ in\ one\ pass,\ than\ to}}
\DoxyCodeLine{02063\ \ \ \ \ \textcolor{comment}{//\ clear\ them\ in\ two\ separate\ passes.)}}
\DoxyCodeLine{02064\ }
\DoxyCodeLine{02065\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a24396aa9a8df4057bce0ddb5bbfb41dc}{set\_scene}}(scene\_setup))\ \{}
\DoxyCodeLine{02066\ \ \ \ \ \textcolor{comment}{//\ The\ scene\ or\ lens\ is\ inappropriate\ somehow.}}
\DoxyCodeLine{02067\ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{02068\ \ \ \ \ \ \ <<\ gsg-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\ cannot\ render\ scene\ with\ specified\ lens.\(\backslash\)n"{}};}
\DoxyCodeLine{02069\ }
\DoxyCodeLine{02070\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02071\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg-\/>begin\_scene())\ \{}
\DoxyCodeLine{02072\ \ \ \ \ \ \ cull\_result-\/>\mbox{\hyperlink{classCullResult_a72f91e62781ba0a7dc45eea631febfac}{draw}}(current\_thread);}
\DoxyCodeLine{02073\ \ \ \ \ \ \ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ab8d7bc997a78e7a442fcdb920cce0af4}{end\_scene}}();}
\DoxyCodeLine{02074\ \ \ \ \ \}}
\DoxyCodeLine{02075\ \ \ \}}
\DoxyCodeLine{02076\ }
\DoxyCodeLine{02077\ \ \ gsg-\/>pop\_group\_marker();}
\DoxyCodeLine{02078\ \}}
\DoxyCodeLine{02079\ }
\DoxyCodeLine{02085\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02086\ do\_add\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window)\ \{}
\DoxyCodeLine{02087\ \ \ nassertv(window\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02088\ }
\DoxyCodeLine{02089\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_new\_windows\_lock);}
\DoxyCodeLine{02090\ \ \ nassertv(window-\/>get\_engine()\ ==\ \textcolor{keyword}{this});}
\DoxyCodeLine{02091\ }
\DoxyCodeLine{02092\ \ \ \textcolor{comment}{//\ We\ have\ a\ special\ counter\ that\ is\ unique\ per\ window\ that\ allows\ us\ to}}
\DoxyCodeLine{02093\ \ \ \textcolor{comment}{//\ assure\ that\ recently-\/added\ windows\ end\ up\ on\ the\ end\ of\ the\ list.}}
\DoxyCodeLine{02094\ \ \ window-\/>\_internal\_sort\_index\ =\ \_window\_sort\_index;}
\DoxyCodeLine{02095\ \ \ ++\_window\_sort\_index;}
\DoxyCodeLine{02096\ }
\DoxyCodeLine{02097\ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_debug())\ \{}
\DoxyCodeLine{02098\ \ \ \ \ display\_cat.debug()}
\DoxyCodeLine{02099\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Created\ "{}}\ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ (\textcolor{keywordtype}{void}\ *)window\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02100\ \ \ \}}
\DoxyCodeLine{02101\ }
\DoxyCodeLine{02102\ \ \ window-\/>\mbox{\hyperlink{classGraphicsOutput_ae397e7f8a1d0b5f00100c66ecf10f905}{request\_open}}();}
\DoxyCodeLine{02103\ \ \ \_new\_windows.push\_back(window);}
\DoxyCodeLine{02104\ \}}
\DoxyCodeLine{02105\ }
\DoxyCodeLine{02111\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02112\ do\_add\_gsg(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,\ \mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}}\ *pipe)\ \{}
\DoxyCodeLine{02113\ \ \ nassertv(gsg\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02114\ }
\DoxyCodeLine{02115\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{02116\ \ \ nassertv(gsg-\/>get\_pipe()\ ==\ pipe\ \&\&\ gsg-\/>\mbox{\hyperlink{classGraphicsStateGuardian_a2b3e8a71b60c6a512f7f200655290150}{get\_engine}}()\ ==\ \textcolor{keyword}{this});}
\DoxyCodeLine{02117\ \ \ gsg-\/>\_threading\_model\ =\ \_threading\_model;}
\DoxyCodeLine{02118\ \ \ \textcolor{keywordflow}{if}\ (!\_default\_loader.is\_null())\ \{}
\DoxyCodeLine{02119\ \ \ \ \ gsg-\/>set\_loader(\_default\_loader);}
\DoxyCodeLine{02120\ \ \ \}}
\DoxyCodeLine{02121\ }
\DoxyCodeLine{02122\ \ \ auto\_adjust\_capabilities(gsg);}
\DoxyCodeLine{02123\ }
\DoxyCodeLine{02124\ \ \ WindowRenderer\ *draw\ =}
\DoxyCodeLine{02125\ \ \ \ \ get\_window\_renderer(\_threading\_model.get\_draw\_name(),}
\DoxyCodeLine{02126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_threading\_model.get\_draw\_stage());}
\DoxyCodeLine{02127\ }
\DoxyCodeLine{02128\ \ \ draw-\/>add\_gsg(gsg);}
\DoxyCodeLine{02129\ \}}
\DoxyCodeLine{02130\ }
\DoxyCodeLine{02136\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02137\ do\_remove\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02138\ \ \ nassertv(window\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02139\ \ \ PT(\mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}})\ pipe\ =\ window-\/>get\_pipe();}
\DoxyCodeLine{02140\ \ \ window-\/>\mbox{\hyperlink{classGraphicsOutput_a3df842abab4180feb42e929f712e234b}{clear\_pipe}}();}
\DoxyCodeLine{02141\ }
\DoxyCodeLine{02142\ \ \ \textcolor{keywordflow}{if}\ (!\_windows\_sorted)\ \{}
\DoxyCodeLine{02143\ \ \ \ \ do\_resort\_windows();}
\DoxyCodeLine{02144\ \ \ \}}
\DoxyCodeLine{02145\ }
\DoxyCodeLine{02146\ \ \ \textcolor{comment}{//\ Now\ remove\ the\ window\ from\ all\ threads\ that\ know\ about\ it.}}
\DoxyCodeLine{02147\ \ \ \_app.remove\_window(window);}
\DoxyCodeLine{02148\ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{02149\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{02150\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{02151\ \ \ \ \ thread-\/>remove\_window(window);}
\DoxyCodeLine{02152\ \ \ \}}
\DoxyCodeLine{02153\ }
\DoxyCodeLine{02154\ \ \ \textcolor{comment}{//\ If\ the\ window\ happened\ to\ be\ controlled\ by\ the\ app\ thread,\ we\ might\ as}}
\DoxyCodeLine{02155\ \ \ \textcolor{comment}{//\ well\ close\ it\ now\ rather\ than\ waiting\ for\ next\ frame.}}
\DoxyCodeLine{02156\ \ \ \_app.do\_pending(\textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{02157\ }
\DoxyCodeLine{02158\ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_debug())\ \{}
\DoxyCodeLine{02159\ \ \ \ \ display\_cat.debug()}
\DoxyCodeLine{02160\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Removed\ "{}}\ <<\ window-\/>get\_type()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ (\textcolor{keywordtype}{void}\ *)window\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02161\ \ \ \}}
\DoxyCodeLine{02162\ \}}
\DoxyCodeLine{02163\ }
\DoxyCodeLine{02168\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02169\ do\_resort\_windows()\ \{}
\DoxyCodeLine{02170\ \ \ \_windows\_sorted\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02171\ }
\DoxyCodeLine{02172\ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_spam())\ \{}
\DoxyCodeLine{02173\ \ \ \ \ display\_cat.spam()}
\DoxyCodeLine{02174\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Re-\/sorting\ window\ list.\(\backslash\)n"{}};}
\DoxyCodeLine{02175\ \ \ \}}
\DoxyCodeLine{02176\ }
\DoxyCodeLine{02177\ \ \ \_app.resort\_windows();}
\DoxyCodeLine{02178\ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{02179\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{02180\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{02181\ \ \ \ \ thread-\/>resort\_windows();}
\DoxyCodeLine{02182\ \ \ \}}
\DoxyCodeLine{02183\ }
\DoxyCodeLine{02184\ \ \ \_windows.sort();}
\DoxyCodeLine{02185\ \}}
\DoxyCodeLine{02186\ }
\DoxyCodeLine{02207\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02208\ auto\_adjust\_capabilities(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg)\ \{}
\DoxyCodeLine{02209\ }
\DoxyCodeLine{02210\ \textcolor{comment}{/*}}
\DoxyCodeLine{02211\ \textcolor{comment}{\ *\ The\ rule\ we\ use\ when\ auto-\/reconfiguring\ is\ as\ follows.\ \ The\ global}}
\DoxyCodeLine{02212\ \textcolor{comment}{\ *\ capabilities\ must\ initially\ be\ set\ to\ conservative\ values.\ \ When\ the\ first}}
\DoxyCodeLine{02213\ \textcolor{comment}{\ *\ GSG\ comes\ into\ existence,\ its\ capabilities\ will\ be\ checked,\ and\ the\ global}}
\DoxyCodeLine{02214\ \textcolor{comment}{\ *\ capabilities\ may\ be\ elevated\ to\ more\ aggressive\ values.\ \ At\ first\ glance,}}
\DoxyCodeLine{02215\ \textcolor{comment}{\ *\ this\ might\ seem\ backward,\ and\ it\ might\ seem\ better\ to\ do\ it\ the\ other\ way:}}
\DoxyCodeLine{02216\ \textcolor{comment}{\ *\ start\ with\ all\ global\ capabilities\ aggressively\ set,\ and\ then\ disable}}
\DoxyCodeLine{02217\ \textcolor{comment}{\ *\ capabilities\ when\ you\ discover\ a\ gsg\ that\ doesn't\ support\ them.\ \ However,}}
\DoxyCodeLine{02218\ \textcolor{comment}{\ *\ that\ approach\ doesn't\ work,\ because\ once\ a\ global\ capability\ is\ enabled,}}
\DoxyCodeLine{02219\ \textcolor{comment}{\ *\ there\ is\ no\ going\ back.\ \ If\ textures\_power\_2\ has\ ever\ been\ set\ to\ 'none',}}
\DoxyCodeLine{02220\ \textcolor{comment}{\ *\ there\ may\ be\ NPOT\ textures\ already\ floating\ about\ the\ system.\ \ Ie,\ it's\ too}}
\DoxyCodeLine{02221\ \textcolor{comment}{\ *\ late:\ you\ can't\ turn\ these\ global\ capability\ flags\ off,\ once\ they've\ been}}
\DoxyCodeLine{02222\ \textcolor{comment}{\ *\ turned\ on.\ \ That's\ why\ we\ have\ to\ start\ with\ conservative\ settings,\ and}}
\DoxyCodeLine{02223\ \textcolor{comment}{\ *\ then\ elevate\ those\ settings\ to\ more\ aggressive\ values\ later\ when\ we're}}
\DoxyCodeLine{02224\ \textcolor{comment}{\ *\ fairly\ sure\ it's\ OK\ to\ do\ so.\ \ For\ each\ global\ capability,\ we\ must:\ 1.\ Make}}
\DoxyCodeLine{02225\ \textcolor{comment}{\ *\ sure\ the\ initial\ setting\ is\ conservative.\ \ 2.\ Possibly\ elevate\ to\ a\ more}}
\DoxyCodeLine{02226\ \textcolor{comment}{\ *\ aggressive\ value.\ \ 3.\ Check\ that\ we\ haven't\ over-\/elevated.}}
\DoxyCodeLine{02227\ \textcolor{comment}{\ */}}
\DoxyCodeLine{02228\ }
\DoxyCodeLine{02229\ \ \ \textcolor{keywordflow}{if}\ (textures\_auto\_power\_2\ \&\&\ (textures\_power\_2\ ==\ ATS\_none))\ \{}
\DoxyCodeLine{02230\ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{02231\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ panda\ config\ file:\ if\ you\ set\ the\ config-\/variable\(\backslash\)n"{}}}
\DoxyCodeLine{02232\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}textures\_auto\_power\_2\ to\ true,\ you\ must\ set\ the\ config-\/variable"{}}}
\DoxyCodeLine{02233\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}textures\_power\_2\ to\ 'up'\ or\ 'down'.\(\backslash\)n"{}};}
\DoxyCodeLine{02234\ \ \ \ \ textures\_power\_2\ =\ ATS\_down;\ \textcolor{comment}{//\ Not\ a\ fix.\ \ Just\ suppresses\ further\ error\ messages.}}
\DoxyCodeLine{02235\ \ \ \}}
\DoxyCodeLine{02236\ }
\DoxyCodeLine{02237\ \ \ \textcolor{keywordflow}{if}\ (textures\_auto\_power\_2\ \&\&\ !Texture::has\_textures\_power\_2())\ \{}
\DoxyCodeLine{02238\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg-\/>get\_supports\_tex\_non\_pow2())\ \{}
\DoxyCodeLine{02239\ \ \ \ \ \ \ Texture::set\_textures\_power\_2(ATS\_none);}
\DoxyCodeLine{02240\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02241\ \ \ \ \ \ \ Texture::set\_textures\_power\_2(textures\_power\_2);}
\DoxyCodeLine{02242\ \ \ \ \ \}}
\DoxyCodeLine{02243\ \ \ \}}
\DoxyCodeLine{02244\ }
\DoxyCodeLine{02245\ \ \ \textcolor{keywordflow}{if}\ ((Texture::get\_textures\_power\_2()\ ==\ ATS\_none)\ \&\&}
\DoxyCodeLine{02246\ \ \ \ \ \ \ (!gsg-\/>get\_supports\_tex\_non\_pow2()))\ \{}
\DoxyCodeLine{02247\ }
\DoxyCodeLine{02248\ \ \ \ \ \textcolor{comment}{//\ Overaggressive\ configuration\ detected}}
\DoxyCodeLine{02249\ }
\DoxyCodeLine{02250\ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{02251\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}The\ 'textures\_power\_2'\ configuration\ is\ set\ to\ 'none',\ meaning\ \(\backslash\)n"{}}}
\DoxyCodeLine{02252\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}that\ non-\/power-\/of-\/two\ texture\ support\ is\ required,\ but\ the\ video\ \(\backslash\)n"{}}}
\DoxyCodeLine{02253\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}driver\ I'm\ trying\ to\ use\ does\ not\ support\ non-\/power-\/of-\/two\ textures.\(\backslash\)n"{}};}
\DoxyCodeLine{02254\ }
\DoxyCodeLine{02255\ \ \ \ \ \textcolor{keywordflow}{if}\ (textures\_power\_2\ !=\ ATS\_none)\ \{}
\DoxyCodeLine{02256\ \ \ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{02257\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}The\ 'none'\ did\ not\ come\ from\ the\ config\ file.\ \ In\ other\ words,\(\backslash\)n"{}}}
\DoxyCodeLine{02258\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}the\ variable\ 'textures\_power\_2'\ was\ altered\ procedurally.\(\backslash\)n"{}};}
\DoxyCodeLine{02259\ }
\DoxyCodeLine{02260\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (textures\_auto\_power\_2)\ \{}
\DoxyCodeLine{02261\ \ \ \ \ \ \ \ \ display\_cat.error()}
\DoxyCodeLine{02262\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}It\ is\ possible\ that\ it\ was\ set\ by\ panda's\ automatic\ mechanisms,\(\backslash\)n"{}}}
\DoxyCodeLine{02263\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}which\ are\ currently\ enabled,\ because\ 'textures\_auto\_power\_2'\ is\(\backslash\)n"{}}}
\DoxyCodeLine{02264\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}true.\ \ Panda's\ automatic\ mechanisms\ assume\ that\ if\ one\(\backslash\)n"{}}}
\DoxyCodeLine{02265\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}window\ supports\ non-\/power-\/of-\/two\ textures,\ then\ they\ all\ will.\(\backslash\)n"{}}}
\DoxyCodeLine{02266\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}This\ assumption\ works\ for\ most\ games,\ but\ not\ all.\(\backslash\)n"{}}}
\DoxyCodeLine{02267\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}In\ particular,\ it\ can\ fail\ if\ the\ game\ creates\ multiple\ windows\(\backslash\)n"{}}}
\DoxyCodeLine{02268\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}on\ multiple\ displays\ with\ different\ video\ cards.\(\backslash\)n"{}};}
\DoxyCodeLine{02269\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02270\ \ \ \ \ \}}
\DoxyCodeLine{02271\ \ \ \}}
\DoxyCodeLine{02272\ \}}
\DoxyCodeLine{02273\ }
\DoxyCodeLine{02277\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02278\ terminate\_threads(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02279\ \ \ \mbox{\hyperlink{classReMutexHolder}{ReMutexHolder}}\ holder(\_lock,\ current\_thread);}
\DoxyCodeLine{02280\ }
\DoxyCodeLine{02281\ \ \ \textcolor{comment}{//\ We\ spend\ almost\ our\ entire\ time\ in\ this\ method\ just\ waiting\ for\ threads.}}
\DoxyCodeLine{02282\ \ \ \textcolor{comment}{//\ Time\ it\ appropriately.}}
\DoxyCodeLine{02283\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_wait\_pcollector,\ current\_thread);}
\DoxyCodeLine{02284\ }
\DoxyCodeLine{02285\ \ \ \textcolor{comment}{//\ First,\ wait\ for\ all\ the\ threads\ to\ finish\ their\ current\ frame.\ \ Grabbing}}
\DoxyCodeLine{02286\ \ \ \textcolor{comment}{//\ the\ mutex\ should\ achieve\ that.}}
\DoxyCodeLine{02287\ \ \ Threads::const\_iterator\ ti;}
\DoxyCodeLine{02288\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{02289\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{02290\ \ \ \ \ thread-\/>\_cv\_mutex.acquire();}
\DoxyCodeLine{02291\ \ \ \}}
\DoxyCodeLine{02292\ }
\DoxyCodeLine{02293\ \ \ \textcolor{comment}{//\ Now\ tell\ them\ to\ close\ their\ windows\ and\ terminate.}}
\DoxyCodeLine{02294\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{02295\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{02296\ \ \ \ \ thread-\/>\_thread\_state\ =\ TS\_terminate;}
\DoxyCodeLine{02297\ \ \ \ \ thread-\/>\_cv\_mutex.release();}
\DoxyCodeLine{02298\ \ \ \ \ thread-\/>\_cv\_start.notify();}
\DoxyCodeLine{02299\ \ \ \}}
\DoxyCodeLine{02300\ }
\DoxyCodeLine{02301\ \ \ \textcolor{comment}{//\ Finally,\ wait\ for\ them\ all\ to\ finish\ cleaning\ up.}}
\DoxyCodeLine{02302\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{02303\ \ \ \ \ RenderThread\ *thread\ =\ (*ti).second;}
\DoxyCodeLine{02304\ \ \ \ \ thread-\/>join();}
\DoxyCodeLine{02305\ \ \ \}}
\DoxyCodeLine{02306\ }
\DoxyCodeLine{02307\ \ \ \_threads.clear();}
\DoxyCodeLine{02308\ \}}
\DoxyCodeLine{02309\ }
\DoxyCodeLine{02310\ }
\DoxyCodeLine{02311\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{02316\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02317\ pstats\_count\_cycler\_type(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ type,\ \textcolor{keywordtype}{int}\ count,\ \textcolor{keywordtype}{void}\ *data)\ \{}
\DoxyCodeLine{02318\ \ \ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *self\ =\ (\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *)data;}
\DoxyCodeLine{02319\ \ \ CyclerTypeCounters::iterator\ ci\ =\ self-\/>\_all\_cycler\_types.find(type);}
\DoxyCodeLine{02320\ \ \ \textcolor{keywordflow}{if}\ (ci\ ==\ self-\/>\_all\_cycler\_types.end())\ \{}
\DoxyCodeLine{02321\ \ \ \ \ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ collector(\_cyclers\_pcollector,\ type.get\_name());}
\DoxyCodeLine{02322\ \ \ \ \ ci\ =\ self-\/>\_all\_cycler\_types.insert(CyclerTypeCounters::value\_type(type,\ collector)).first;}
\DoxyCodeLine{02323\ \ \ \}}
\DoxyCodeLine{02324\ \ \ (*ci).second.set\_level(count);}
\DoxyCodeLine{02325\ \}}
\DoxyCodeLine{02326\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ DO\_PSTATS}}
\DoxyCodeLine{02327\ }
\DoxyCodeLine{02328\ \textcolor{preprocessor}{\#ifdef\ DO\_PSTATS}}
\DoxyCodeLine{02333\ \textcolor{keywordtype}{void}\ GraphicsEngine::}
\DoxyCodeLine{02334\ pstats\_count\_dirty\_cycler\_type(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ type,\ \textcolor{keywordtype}{int}\ count,\ \textcolor{keywordtype}{void}\ *data)\ \{}
\DoxyCodeLine{02335\ \ \ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *self\ =\ (\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *)data;}
\DoxyCodeLine{02336\ \ \ CyclerTypeCounters::iterator\ ci\ =\ self-\/>\_dirty\_cycler\_types.find(type);}
\DoxyCodeLine{02337\ \ \ \textcolor{keywordflow}{if}\ (ci\ ==\ self-\/>\_dirty\_cycler\_types.end())\ \{}
\DoxyCodeLine{02338\ \ \ \ \ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ collector(\_dirty\_cyclers\_pcollector,\ type.get\_name());}
\DoxyCodeLine{02339\ \ \ \ \ ci\ =\ self-\/>\_dirty\_cycler\_types.insert(CyclerTypeCounters::value\_type(type,\ collector)).first;}
\DoxyCodeLine{02340\ \ \ \}}
\DoxyCodeLine{02341\ \ \ (*ci).second.set\_level(count);}
\DoxyCodeLine{02342\ \}}
\DoxyCodeLine{02343\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ DO\_PSTATS}}
\DoxyCodeLine{02344\ }
\DoxyCodeLine{02350\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *GraphicsEngine::}
\DoxyCodeLine{02351\ get\_invert\_polygon\_state()\ \{}
\DoxyCodeLine{02352\ \ \ \textcolor{comment}{//\ Once\ someone\ asks\ for\ this\ pointer,\ we\ hold\ its\ reference\ count\ and\ never}}
\DoxyCodeLine{02353\ \ \ \textcolor{comment}{//\ free\ it.}}
\DoxyCodeLine{02354\ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02355\ \ \ \textcolor{keywordflow}{if}\ (state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02356\ \ \ \ \ state\ =\ RenderState::make(CullFaceAttrib::make\_reverse());}
\DoxyCodeLine{02357\ \ \ \}}
\DoxyCodeLine{02358\ }
\DoxyCodeLine{02359\ \ \ \textcolor{keywordflow}{return}\ state;}
\DoxyCodeLine{02360\ \}}
\DoxyCodeLine{02361\ }
\DoxyCodeLine{02370\ GraphicsEngine::WindowRenderer\ *GraphicsEngine::}
\DoxyCodeLine{02371\ get\_window\_renderer(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name,\ \textcolor{keywordtype}{int}\ pipeline\_stage)\ \{}
\DoxyCodeLine{02372\ \ \ nassertr(\_lock.debug\_is\_locked(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02373\ }
\DoxyCodeLine{02374\ \ \ \textcolor{keywordflow}{if}\ (name.empty())\ \{}
\DoxyCodeLine{02375\ \ \ \ \ \textcolor{keywordflow}{return}\ \&\_app;}
\DoxyCodeLine{02376\ \ \ \}}
\DoxyCodeLine{02377\ }
\DoxyCodeLine{02378\ \ \ Threads::iterator\ ti\ =\ \_threads.find(name);}
\DoxyCodeLine{02379\ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_threads.end())\ \{}
\DoxyCodeLine{02380\ \ \ \ \ \textcolor{keywordflow}{return}\ (*ti).second.p();}
\DoxyCodeLine{02381\ \ \ \}}
\DoxyCodeLine{02382\ }
\DoxyCodeLine{02383\ \ \ PT(RenderThread)\ thread\ =\ \textcolor{keyword}{new}\ RenderThread(name,\ \textcolor{keyword}{this});}
\DoxyCodeLine{02384\ \ \ thread-\/>set\_min\_pipeline\_stage(pipeline\_stage);}
\DoxyCodeLine{02385\ \ \ \_pipeline-\/>set\_min\_stages(pipeline\_stage\ +\ 1);}
\DoxyCodeLine{02386\ }
\DoxyCodeLine{02387\ \ \ \textcolor{keywordtype}{bool}\ started\ =\ thread-\/>start(TP\_normal,\ \textcolor{keyword}{true});}
\DoxyCodeLine{02388\ \ \ nassertr(started,\ thread.p());}
\DoxyCodeLine{02389\ \ \ \_threads[name]\ =\ thread;}
\DoxyCodeLine{02390\ }
\DoxyCodeLine{02391\ \ \ nassertr(thread-\/>get\_pipeline\_stage()\ <\ \_pipeline-\/>get\_num\_stages(),\ thread.p());}
\DoxyCodeLine{02392\ }
\DoxyCodeLine{02393\ \ \ \textcolor{keywordflow}{return}\ thread.p();}
\DoxyCodeLine{02394\ \}}
\DoxyCodeLine{02395\ }
\DoxyCodeLine{02399\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02400\ WindowRenderer(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\ :}
\DoxyCodeLine{02401\ \ \ \_wl\_lock(string(\textcolor{stringliteral}{"{}GraphicsEngine::WindowRenderer::\_wl\_lock\ "{}})\ +\ name)}
\DoxyCodeLine{02402\ \{}
\DoxyCodeLine{02403\ \}}
\DoxyCodeLine{02404\ }
\DoxyCodeLine{02408\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02409\ add\_gsg(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg)\ \{}
\DoxyCodeLine{02410\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02411\ \ \ \_gsgs.insert(gsg);}
\DoxyCodeLine{02412\ \}}
\DoxyCodeLine{02413\ }
\DoxyCodeLine{02418\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02419\ add\_window(Windows\ \&wlist,\ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window)\ \{}
\DoxyCodeLine{02420\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02421\ \ \ wlist.insert(window);}
\DoxyCodeLine{02422\ \}}
\DoxyCodeLine{02423\ }
\DoxyCodeLine{02429\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02430\ remove\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window)\ \{}
\DoxyCodeLine{02431\ \ \ nassertv(window\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02432\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02433\ \ \ PT(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}})\ ptwin\ =\ window;}
\DoxyCodeLine{02434\ }
\DoxyCodeLine{02435\ \ \ \_cull.erase(ptwin);}
\DoxyCodeLine{02436\ \ \ \_cdraw.erase(ptwin);}
\DoxyCodeLine{02437\ \ \ \_draw.erase(ptwin);}
\DoxyCodeLine{02438\ }
\DoxyCodeLine{02439\ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{02440\ }
\DoxyCodeLine{02441\ \ \ wi\ =\ \_window.find(ptwin);}
\DoxyCodeLine{02442\ \ \ \textcolor{keywordflow}{if}\ (wi\ !=\ \_window.end())\ \{}
\DoxyCodeLine{02443\ \ \ \ \ \textcolor{comment}{//\ The\ window\ is\ on\ our\ \_window\ list,\ meaning\ its\ openclose\ operations}}
\DoxyCodeLine{02444\ \ \ \ \ \textcolor{comment}{//\ (among\ other\ window\ ops)\ are\ serviced\ by\ this\ thread.}}
\DoxyCodeLine{02445\ }
\DoxyCodeLine{02446\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ the\ window\ isn't\ about\ to\ request\ itself\ open.}}
\DoxyCodeLine{02447\ \ \ \ \ ptwin-\/>\mbox{\hyperlink{classGraphicsOutput_ab0de4fbfde41ea0a0408cda33cc82bc1}{request\_close}}();}
\DoxyCodeLine{02448\ }
\DoxyCodeLine{02449\ \ \ \ \ \textcolor{comment}{//\ If\ the\ window\ is\ already\ open,\ move\ it\ to\ the\ \_pending\_close\ list\ so\ it}}
\DoxyCodeLine{02450\ \ \ \ \ \textcolor{comment}{//\ can\ be\ closed\ later.\ \ We\ can't\ close\ it\ immediately,\ because\ we\ might}}
\DoxyCodeLine{02451\ \ \ \ \ \textcolor{comment}{//\ not\ have\ been\ called\ from\ the\ subthread.}}
\DoxyCodeLine{02452\ \ \ \ \ \textcolor{keywordflow}{if}\ (ptwin-\/>is\_valid())\ \{}
\DoxyCodeLine{02453\ \ \ \ \ \ \ \_pending\_close.push\_back(ptwin);}
\DoxyCodeLine{02454\ \ \ \ \ \}}
\DoxyCodeLine{02455\ }
\DoxyCodeLine{02456\ \ \ \ \ \_window.erase(wi);}
\DoxyCodeLine{02457\ \ \ \}}
\DoxyCodeLine{02458\ \}}
\DoxyCodeLine{02459\ }
\DoxyCodeLine{02463\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02464\ resort\_windows()\ \{}
\DoxyCodeLine{02465\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02466\ }
\DoxyCodeLine{02467\ \ \ \_cull.sort();}
\DoxyCodeLine{02468\ \ \ \_cdraw.sort();}
\DoxyCodeLine{02469\ \ \ \_draw.sort();}
\DoxyCodeLine{02470\ \ \ \_window.sort();}
\DoxyCodeLine{02471\ }
\DoxyCodeLine{02472\ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_debug())\ \{}
\DoxyCodeLine{02473\ \ \ \ \ display\_cat.debug()}
\DoxyCodeLine{02474\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Windows\ resorted:"{}};}
\DoxyCodeLine{02475\ \ \ \ \ Windows::const\_iterator\ wi;}
\DoxyCodeLine{02476\ \ \ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_window.begin();\ wi\ !=\ \_window.end();\ ++wi)\ \{}
\DoxyCodeLine{02477\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{02478\ \ \ \ \ \ \ display\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{02479\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}("{}}\ <<\ win-\/>get\_sort()\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{02480\ \ \ \ \ \}}
\DoxyCodeLine{02481\ \ \ \ \ display\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{02482\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02483\ }
\DoxyCodeLine{02484\ \ \ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_draw.begin();\ wi\ !=\ \_draw.end();\ ++wi)\ \{}
\DoxyCodeLine{02485\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{02486\ \ \ \ \ \ \ display\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{02487\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ win-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}("{}}\ <<\ win-\/>get\_sort()\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{02488\ \ \ \ \ \}}
\DoxyCodeLine{02489\ \ \ \ \ display\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{02490\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02491\ \ \ \}}
\DoxyCodeLine{02492\ \}}
\DoxyCodeLine{02493\ }
\DoxyCodeLine{02499\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02500\ do\_frame(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02501\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02502\ }
\DoxyCodeLine{02503\ \textcolor{preprocessor}{\#ifdef\ \_\_APPLE\_\_}}
\DoxyCodeLine{02504\ \ \ \textcolor{comment}{//\ Enclose\ the\ entire\ frame\ in\ an\ autorelease\ pool.}}
\DoxyCodeLine{02505\ \ \ \textcolor{keywordtype}{void}\ *pool\ =\ objc\_autoreleasePoolPush();}
\DoxyCodeLine{02506\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02507\ }
\DoxyCodeLine{02508\ \ \ \textcolor{keywordflow}{if}\ (!\_cull.empty())\ \{}
\DoxyCodeLine{02509\ \ \ \ \ engine-\/>cull\_to\_bins(\_cull,\ current\_thread);}
\DoxyCodeLine{02510\ \ \ \}}
\DoxyCodeLine{02511\ \ \ \textcolor{keywordflow}{if}\ (!\_cdraw.empty())\ \{}
\DoxyCodeLine{02512\ \ \ \ \ engine-\/>cull\_and\_draw\_together(\_cdraw,\ current\_thread);}
\DoxyCodeLine{02513\ \ \ \}}
\DoxyCodeLine{02514\ \ \ \textcolor{keywordflow}{if}\ (!\_draw.empty())\ \{}
\DoxyCodeLine{02515\ \ \ \ \ engine-\/>draw\_bins(\_draw,\ current\_thread);}
\DoxyCodeLine{02516\ \ \ \}}
\DoxyCodeLine{02517\ \ \ \textcolor{keywordflow}{if}\ (!\_window.empty())\ \{}
\DoxyCodeLine{02518\ \ \ \ \ engine-\/>process\_events(\_window,\ current\_thread);}
\DoxyCodeLine{02519\ \ \ \}}
\DoxyCodeLine{02520\ }
\DoxyCodeLine{02521\ \textcolor{preprocessor}{\#ifdef\ \_\_APPLE\_\_}}
\DoxyCodeLine{02522\ \ \ objc\_autoreleasePoolPop(pool);}
\DoxyCodeLine{02523\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02524\ }
\DoxyCodeLine{02525\ \ \ \textcolor{comment}{//\ If\ any\ GSG's\ on\ the\ list\ have\ no\ more\ outstanding\ pointers,\ clean\ them}}
\DoxyCodeLine{02526\ \ \ \textcolor{comment}{//\ up.\ \ (We\ are\ in\ the\ draw\ thread\ for\ all\ of\ these\ GSG's.)}}
\DoxyCodeLine{02527\ \ \ \textcolor{keywordflow}{if}\ (any\_done\_gsgs())\ \{}
\DoxyCodeLine{02528\ \ \ \ \ GSGs\ new\_gsgs;}
\DoxyCodeLine{02529\ \ \ \ \ GSGs::iterator\ gi;}
\DoxyCodeLine{02530\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ \_gsgs.begin();\ gi\ !=\ \_gsgs.end();\ ++gi)\ \{}
\DoxyCodeLine{02531\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ (*gi);}
\DoxyCodeLine{02532\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{02533\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ one\ has\ no\ outstanding\ pointers;\ clean\ it\ up.}}
\DoxyCodeLine{02534\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}}\ *pipe\ =\ gsg-\/>get\_pipe();}
\DoxyCodeLine{02535\ \ \ \ \ \ \ \ \ engine-\/>close\_gsg(pipe,\ gsg);}
\DoxyCodeLine{02536\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02537\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ one\ is\ ok;\ preserve\ it.}}
\DoxyCodeLine{02538\ \ \ \ \ \ \ \ \ new\_gsgs.insert(gsg);}
\DoxyCodeLine{02539\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02540\ \ \ \ \ \}}
\DoxyCodeLine{02541\ }
\DoxyCodeLine{02542\ \ \ \ \ \_gsgs.swap(new\_gsgs);}
\DoxyCodeLine{02543\ \ \ \}}
\DoxyCodeLine{02544\ \}}
\DoxyCodeLine{02545\ }
\DoxyCodeLine{02552\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02553\ do\_windows(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02554\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02555\ }
\DoxyCodeLine{02556\ \textcolor{preprocessor}{\#ifdef\ \_\_APPLE\_\_}}
\DoxyCodeLine{02557\ \ \ \textcolor{keywordtype}{void}\ *pool\ =\ objc\_autoreleasePoolPush();}
\DoxyCodeLine{02558\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02559\ }
\DoxyCodeLine{02560\ \ \ engine-\/>process\_events(\_window,\ current\_thread);}
\DoxyCodeLine{02561\ }
\DoxyCodeLine{02562\ \ \ engine-\/>make\_contexts(\_cdraw,\ current\_thread);}
\DoxyCodeLine{02563\ \ \ engine-\/>make\_contexts(\_draw,\ current\_thread);}
\DoxyCodeLine{02564\ }
\DoxyCodeLine{02565\ \textcolor{preprocessor}{\#ifdef\ \_\_APPLE\_\_}}
\DoxyCodeLine{02566\ \ \ objc\_autoreleasePoolPop(pool);}
\DoxyCodeLine{02567\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02568\ \}}
\DoxyCodeLine{02569\ }
\DoxyCodeLine{02573\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02574\ do\_flip(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02575\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02576\ \ \ engine-\/>flip\_windows(\_cdraw,\ current\_thread);}
\DoxyCodeLine{02577\ \ \ engine-\/>flip\_windows(\_draw,\ current\_thread);}
\DoxyCodeLine{02578\ \}}
\DoxyCodeLine{02579\ }
\DoxyCodeLine{02583\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02584\ do\_ready\_flip(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02585\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02586\ \ \ engine-\/>ready\_flip\_windows(\_cdraw,\ current\_thread);}
\DoxyCodeLine{02587\ \ \ engine-\/>ready\_flip\_windows(\_draw,\ current\_thread);}
\DoxyCodeLine{02588\ \}}
\DoxyCodeLine{02589\ }
\DoxyCodeLine{02590\ }
\DoxyCodeLine{02594\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02595\ do\_close(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02596\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02597\ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{02598\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ \_window.begin();\ wi\ !=\ \_window.end();\ ++wi)\ \{}
\DoxyCodeLine{02599\ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{02600\ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_af4b173e26f7a4b7dd06ad0afa0c1e932}{set\_close\_now}}();}
\DoxyCodeLine{02601\ \ \ \}}
\DoxyCodeLine{02602\ }
\DoxyCodeLine{02603\ \ \ \textcolor{comment}{//\ Also\ close\ all\ of\ the\ GSG's.}}
\DoxyCodeLine{02604\ \ \ GSGs\ new\_gsgs;}
\DoxyCodeLine{02605\ \ \ GSGs::iterator\ gi;}
\DoxyCodeLine{02606\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ \_gsgs.begin();\ gi\ !=\ \_gsgs.end();\ ++gi)\ \{}
\DoxyCodeLine{02607\ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg\ =\ (*gi);}
\DoxyCodeLine{02608\ \ \ \ \ \textcolor{keywordflow}{if}\ (gsg-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{02609\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ one\ has\ no\ outstanding\ pointers;\ clean\ it\ up.}}
\DoxyCodeLine{02610\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}}\ *pipe\ =\ gsg-\/>get\_pipe();}
\DoxyCodeLine{02611\ \ \ \ \ \ \ engine-\/>close\_gsg(pipe,\ gsg);}
\DoxyCodeLine{02612\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02613\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ one\ is\ ok;\ preserve\ it.}}
\DoxyCodeLine{02614\ \ \ \ \ \ \ new\_gsgs.insert(gsg);}
\DoxyCodeLine{02615\ \ \ \ \ \}}
\DoxyCodeLine{02616\ \ \ \}}
\DoxyCodeLine{02617\ }
\DoxyCodeLine{02618\ \ \ \_gsgs.swap(new\_gsgs);}
\DoxyCodeLine{02619\ \}}
\DoxyCodeLine{02620\ }
\DoxyCodeLine{02625\ \textcolor{keywordtype}{void}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02626\ do\_pending(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02627\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_wl\_lock);}
\DoxyCodeLine{02628\ }
\DoxyCodeLine{02629\ \ \ \textcolor{keywordflow}{if}\ (!\_pending\_close.empty())\ \{}
\DoxyCodeLine{02630\ \ \ \ \ \textcolor{keywordflow}{if}\ (display\_cat.is\_debug())\ \{}
\DoxyCodeLine{02631\ \ \ \ \ \ \ display\_cat.debug()}
\DoxyCodeLine{02632\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\_pending\_close.size()\ =\ "{}}\ <<\ \_pending\_close.size()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02633\ \ \ \ \ \}}
\DoxyCodeLine{02634\ }
\DoxyCodeLine{02635\ \ \ \ \ \textcolor{comment}{//\ Close\ any\ windows\ that\ were\ pending\ closure.\ \ Carefully\ protect\ against}}
\DoxyCodeLine{02636\ \ \ \ \ \textcolor{comment}{//\ recursive\ entry\ to\ this\ function\ by\ swapping\ the\ vector\ to\ a\ local\ copy}}
\DoxyCodeLine{02637\ \ \ \ \ \textcolor{comment}{//\ first.}}
\DoxyCodeLine{02638\ \ \ \ \ Windows::iterator\ wi;}
\DoxyCodeLine{02639\ \ \ \ \ Windows\ pending\_close;}
\DoxyCodeLine{02640\ \ \ \ \ \_pending\_close.swap(pending\_close);}
\DoxyCodeLine{02641\ \ \ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ pending\_close.begin();\ wi\ !=\ pending\_close.end();\ ++wi)\ \{}
\DoxyCodeLine{02642\ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *win\ =\ (*wi);}
\DoxyCodeLine{02643\ \ \ \ \ \ \ win-\/>\mbox{\hyperlink{classGraphicsOutput_af4b173e26f7a4b7dd06ad0afa0c1e932}{set\_close\_now}}();}
\DoxyCodeLine{02644\ \ \ \ \ \}}
\DoxyCodeLine{02645\ \ \ \}}
\DoxyCodeLine{02646\ \}}
\DoxyCodeLine{02647\ }
\DoxyCodeLine{02653\ \textcolor{keywordtype}{bool}\ GraphicsEngine::WindowRenderer::}
\DoxyCodeLine{02654\ any\_done\_gsgs()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02655\ \ \ GSGs::const\_iterator\ gi;}
\DoxyCodeLine{02656\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ \_gsgs.begin();\ gi\ !=\ \_gsgs.end();\ ++gi)\ \{}
\DoxyCodeLine{02657\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*gi)-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{02658\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02659\ \ \ \ \ \}}
\DoxyCodeLine{02660\ \ \ \}}
\DoxyCodeLine{02661\ }
\DoxyCodeLine{02662\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02663\ \}}
\DoxyCodeLine{02664\ }
\DoxyCodeLine{02668\ GraphicsEngine::RenderThread::}
\DoxyCodeLine{02669\ RenderThread(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name,\ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine)\ :}
\DoxyCodeLine{02670\ \ \ \mbox{\hyperlink{classThread}{Thread}}(name,\ \textcolor{stringliteral}{"{}Main"{}}),}
\DoxyCodeLine{02671\ \ \ WindowRenderer(name),}
\DoxyCodeLine{02672\ \ \ \_engine(engine),}
\DoxyCodeLine{02673\ \ \ \_cv\_mutex(string(\textcolor{stringliteral}{"{}GraphicsEngine::RenderThread\ "{}})\ +\ name),}
\DoxyCodeLine{02674\ \ \ \_cv\_start(\_cv\_mutex),}
\DoxyCodeLine{02675\ \ \ \_cv\_done(\_cv\_mutex)}
\DoxyCodeLine{02676\ \{}
\DoxyCodeLine{02677\ \ \ \_thread\_state\ =\ TS\_wait;}
\DoxyCodeLine{02678\ \}}
\DoxyCodeLine{02679\ }
\DoxyCodeLine{02684\ \textcolor{keywordtype}{void}\ GraphicsEngine::RenderThread::}
\DoxyCodeLine{02685\ thread\_main()\ \{}
\DoxyCodeLine{02686\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{02687\ }
\DoxyCodeLine{02688\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_cv\_mutex);}
\DoxyCodeLine{02689\ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{02690\ \ \ \ \ nassertv(\_cv\_mutex.debug\_is\_locked());}
\DoxyCodeLine{02691\ }
\DoxyCodeLine{02692\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_thread\_state)\ \{}
\DoxyCodeLine{02693\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_wait:}
\DoxyCodeLine{02694\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02695\ }
\DoxyCodeLine{02696\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_do\_frame:}
\DoxyCodeLine{02697\ \ \ \ \ \ \ do\_pending(\_engine,\ current\_thread);}
\DoxyCodeLine{02698\ \ \ \ \ \ \ do\_frame(\_engine,\ current\_thread);}
\DoxyCodeLine{02699\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02700\ }
\DoxyCodeLine{02701\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_do\_flip:}
\DoxyCodeLine{02702\ \ \ \ \ \ \ do\_flip(\_engine,\ current\_thread);}
\DoxyCodeLine{02703\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02704\ }
\DoxyCodeLine{02705\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_do\_release:}
\DoxyCodeLine{02706\ \ \ \ \ \ \ do\_pending(\_engine,\ current\_thread);}
\DoxyCodeLine{02707\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02708\ }
\DoxyCodeLine{02709\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_do\_windows:}
\DoxyCodeLine{02710\ \ \ \ \ \ \ do\_windows(\_engine,\ current\_thread);}
\DoxyCodeLine{02711\ \ \ \ \ \ \ do\_pending(\_engine,\ current\_thread);}
\DoxyCodeLine{02712\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02713\ }
\DoxyCodeLine{02714\ \ \ \ \ \textcolor{keywordflow}{case}\ TS\_callback:}
\DoxyCodeLine{02715\ \ \ \ \ \ \ nassertd(\_callback\ !=\ \textcolor{keyword}{nullptr})\ break;}
\DoxyCodeLine{02716\ \ \ \ \ \ \ \_callback(this);}
\DoxyCodeLine{02717\ \ \ \ \ \ \ break;}
\DoxyCodeLine{02718\ }
\DoxyCodeLine{02719\ \ \ \ \ case\ TS\_terminate:}
\DoxyCodeLine{02720\ \ \ \ \ \ \ do\_pending(\_engine,\ current\_thread);}
\DoxyCodeLine{02721\ \ \ \ \ \ \ do\_close(\_engine,\ current\_thread);}
\DoxyCodeLine{02722\ \ \ \ \ \ \ \_thread\_state\ =\ TS\_done;}
\DoxyCodeLine{02723\ \ \ \ \ \ \ \_cv\_done.notify();}
\DoxyCodeLine{02724\ \ \ \ \ \ \ return;}
\DoxyCodeLine{02725\ }
\DoxyCodeLine{02726\ \ \ \ \ case\ TS\_done:}
\DoxyCodeLine{02727\ \ \ \ \ \ \ \textcolor{comment}{//\ Shouldn't\ be\ possible\ to\ get\ here.}}
\DoxyCodeLine{02728\ \ \ \ \ \ \ nassertv(false);}
\DoxyCodeLine{02729\ \ \ \ \ \ \ return;}
\DoxyCodeLine{02730\ \ \ \ \ \}}
\DoxyCodeLine{02731\ }
\DoxyCodeLine{02732\ \ \ \ \ \_thread\_state\ =\ TS\_wait;}
\DoxyCodeLine{02733\ \ \ \ \ \_cv\_done.notify();}
\DoxyCodeLine{02734\ }
\DoxyCodeLine{02735\ \ \ \ \ \{}
\DoxyCodeLine{02736\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_wait\_pcollector,\ current\_thread);}
\DoxyCodeLine{02737\ \ \ \ \ \ \ \_cv\_start.wait();}
\DoxyCodeLine{02738\ \ \ \ \ \}}
\DoxyCodeLine{02739\ \ \ \}}
\DoxyCodeLine{02740\ \}}
\DoxyCodeLine{02741\ }
\DoxyCodeLine{02745\ \textcolor{keywordtype}{void}\ GraphicsEngine::RenderThread::}
\DoxyCodeLine{02746\ run\_on\_thread(Callback\ *callback,\ \textcolor{keywordtype}{void}\ *callback\_data,\ \textcolor{keywordtype}{void}\ *return\_data)\ \{}
\DoxyCodeLine{02747\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ cv\_holder(\_cv\_mutex);}
\DoxyCodeLine{02748\ }
\DoxyCodeLine{02749\ \ \ \textcolor{keywordflow}{while}\ (\_thread\_state\ !=\ TS\_wait)\ \{}
\DoxyCodeLine{02750\ \ \ \ \ \_cv\_done.wait();}
\DoxyCodeLine{02751\ \ \ \}}
\DoxyCodeLine{02752\ }
\DoxyCodeLine{02753\ \ \ \textcolor{comment}{//\ Temporarily\ set\ this\ so\ that\ it\ accesses\ data\ from\ the\ current\ thread.}}
\DoxyCodeLine{02754\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ Thread::get\_current\_pipeline\_stage();}
\DoxyCodeLine{02755\ \ \ \textcolor{keywordtype}{int}\ thread\_pipeline\_stage\ =\ get\_pipeline\_stage();}
\DoxyCodeLine{02756\ \ \ \mbox{\hyperlink{classThread_af7101798f72dd1646f300c1204591503}{set\_pipeline\_stage}}(pipeline\_stage);}
\DoxyCodeLine{02757\ }
\DoxyCodeLine{02758\ \ \ \textcolor{comment}{//\ Now\ that\ the\ draw\ thread\ is\ idle,\ signal\ it\ to\ run\ the\ callback.}}
\DoxyCodeLine{02759\ \ \ \_callback\ =\ callback;}
\DoxyCodeLine{02760\ \ \ \_callback\_data\ =\ callback\_data;}
\DoxyCodeLine{02761\ \ \ \_return\_data\ =\ return\_data;}
\DoxyCodeLine{02762\ \ \ \_thread\_state\ =\ TS\_callback;}
\DoxyCodeLine{02763\ \ \ \_cv\_mutex.release();}
\DoxyCodeLine{02764\ \ \ \_cv\_start.notify();}
\DoxyCodeLine{02765\ \ \ \_cv\_mutex.acquire();}
\DoxyCodeLine{02766\ }
\DoxyCodeLine{02767\ \ \ \textcolor{comment}{//\ Wait\ for\ it\ to\ finish\ the\ job.}}
\DoxyCodeLine{02768\ \ \ \textcolor{keywordflow}{while}\ (\_thread\_state\ !=\ TS\_wait)\ \{}
\DoxyCodeLine{02769\ \ \ \ \ \_cv\_done.wait();}
\DoxyCodeLine{02770\ \ \ \}}
\DoxyCodeLine{02771\ }
\DoxyCodeLine{02772\ \ \ \mbox{\hyperlink{classThread_af7101798f72dd1646f300c1204591503}{set\_pipeline\_stage}}(thread\_pipeline\_stage);}
\DoxyCodeLine{02773\ \ \ \_callback\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02774\ \ \ \_callback\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02775\ \ \ \_return\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02776\ \}}

\end{DoxyCode}
