\doxysection{p\+Stat\+Reader.\+cxx}
\hypertarget{pStatReader_8cxx_source}{}\label{pStatReader_8cxx_source}\index{pandatool/src/pstatserver/pStatReader.cxx@{pandatool/src/pstatserver/pStatReader.cxx}}
\mbox{\hyperlink{pStatReader_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatReader_8h}{pStatReader.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatServer_8h}{pStatServer.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatMonitor_8h}{pStatMonitor.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatClientControlMessage_8h}{pStatClientControlMessage.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatServerControlMessage_8h}{pStatServerControlMessage.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatFrameData_8h}{pStatFrameData.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatProperties_8h}{pStatProperties.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{connectionManager_8h}{connectionManager.h}}"{}}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ PStatReader::}
\DoxyCodeLine{00030\ PStatReader(\mbox{\hyperlink{classPStatServer}{PStatServer}}\ *manager,\ \mbox{\hyperlink{classPStatMonitor}{PStatMonitor}}\ *monitor)\ :}
\DoxyCodeLine{00031\ \#ifdef\ HAVE\_THREADS}
\DoxyCodeLine{00032\ \ \ \mbox{\hyperlink{classConnectionReader}{ConnectionReader}}(manager,\ monitor-\/>is\_thread\_safe()\ ?\ 1\ :\ 0),}
\DoxyCodeLine{00033\ \#else\ \ \textcolor{comment}{//\ HAVE\_THREADS}}
\DoxyCodeLine{00034\ \ \ \mbox{\hyperlink{classConnectionReader}{ConnectionReader}}(manager,\ 0),}
\DoxyCodeLine{00035\ \#endif\ \ \textcolor{comment}{//\ HAVE\_THREADS}}
\DoxyCodeLine{00036\ \ \ \_manager(manager),}
\DoxyCodeLine{00037\ \ \ \_monitor(monitor),}
\DoxyCodeLine{00038\ \ \ \_writer(manager,\ 0)}
\DoxyCodeLine{00039\ \{}
\DoxyCodeLine{00040\ \ \ set\_tcp\_header\_size(4);}
\DoxyCodeLine{00041\ \ \ \_writer.set\_tcp\_header\_size(4);}
\DoxyCodeLine{00042\ \ \ \_udp\_port\ =\ 0;}
\DoxyCodeLine{00043\ \ \ \_client\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPStatClientData}{PStatClientData}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00044\ \ \ \_monitor-\/>set\_client\_data(\_client\_data);}
\DoxyCodeLine{00045\ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00050\ PStatReader::}
\DoxyCodeLine{00051\ \string~PStatReader()\ \{}
\DoxyCodeLine{00052\ \ \ \_manager-\/>\mbox{\hyperlink{classPStatServer_adc8dead434aef51d77828742e0b7cb05}{release\_udp\_port}}(\_udp\_port);}
\DoxyCodeLine{00053\ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00060\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatReader_af7ab61e4c8b084bbd36f0f2fc5a13c86}{PStatReader::}}}
\DoxyCodeLine{00061\ \mbox{\hyperlink{classPStatReader_af7ab61e4c8b084bbd36f0f2fc5a13c86}{close}}()\ \{}
\DoxyCodeLine{00062\ \ \ \_manager-\/>\mbox{\hyperlink{classPStatServer_a5eb8967e25a6656600a769a5520ce572}{remove\_reader}}(\_tcp\_connection,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00063\ \ \ \mbox{\hyperlink{classPStatReader_a137b284b498015712a4b8459ee0a1558}{lost\_connection}}();}
\DoxyCodeLine{00064\ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00071\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatReader_a89e01ca73d652ee46820089583ce85c5}{PStatReader::}}}
\DoxyCodeLine{00072\ \mbox{\hyperlink{classPStatReader_a89e01ca73d652ee46820089583ce85c5}{set\_tcp\_connection}}(\mbox{\hyperlink{classConnection}{Connection}}\ *tcp\_connection)\ \{}
\DoxyCodeLine{00073\ \ \ \_tcp\_connection\ =\ tcp\_connection;}
\DoxyCodeLine{00074\ \ \ add\_connection(\_tcp\_connection);}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \_udp\_port\ =\ \_manager-\/>\mbox{\hyperlink{classPStatServer_af28583f7d22002e91c842351405da716}{get\_udp\_port}}();}
\DoxyCodeLine{00077\ \ \ \_udp\_connection\ =\ \_manager-\/>open\_UDP\_connection(\_udp\_port);}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{while}\ (\_udp\_connection.is\_null())\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{comment}{//\ That\ UDP\ port\ was\ no\ good.\ \ Try\ another.}}
\DoxyCodeLine{00080\ \ \ \ \ \_udp\_port\ =\ \_manager-\/>\mbox{\hyperlink{classPStatServer_af28583f7d22002e91c842351405da716}{get\_udp\_port}}();}
\DoxyCodeLine{00081\ \ \ \ \ \_udp\_connection\ =\ \_manager-\/>open\_UDP\_connection(\_udp\_port);}
\DoxyCodeLine{00082\ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ add\_connection(\_udp\_connection);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ send\_hello();}
\DoxyCodeLine{00087\ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00093\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatReader_a137b284b498015712a4b8459ee0a1558}{PStatReader::}}}
\DoxyCodeLine{00094\ \mbox{\hyperlink{classPStatReader_a137b284b498015712a4b8459ee0a1558}{lost\_connection}}()\ \{}
\DoxyCodeLine{00095\ \ \ \_client\_data-\/>\_is\_alive\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00096\ \ \ \_monitor-\/>lost\_connection();}
\DoxyCodeLine{00097\ \ \ \_manager-\/>lost\_connection(\_monitor);}
\DoxyCodeLine{00098\ \ \ \_client\_data.clear();}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \_manager-\/>close\_connection(\_tcp\_connection);}
\DoxyCodeLine{00101\ \ \ \_manager-\/>close\_connection(\_udp\_connection);}
\DoxyCodeLine{00102\ \ \ \_tcp\_connection.clear();}
\DoxyCodeLine{00103\ \ \ \_udp\_connection.clear();}
\DoxyCodeLine{00104\ \}}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00110\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatReader_ac86a43b9bc6d00550d8559a432307f6c}{PStatReader::}}}
\DoxyCodeLine{00111\ \mbox{\hyperlink{classPStatReader_ac86a43b9bc6d00550d8559a432307f6c}{idle}}()\ \{}
\DoxyCodeLine{00112\ \ \ dequeue\_frame\_data();}
\DoxyCodeLine{00113\ \ \ \_monitor-\/>idle();}
\DoxyCodeLine{00114\ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00119\ \mbox{\hyperlink{classPStatMonitor}{PStatMonitor}}\ *\mbox{\hyperlink{classPStatReader_afb027d7cc00bde7950e0e2025127d344}{PStatReader::}}}
\DoxyCodeLine{00120\ \mbox{\hyperlink{classPStatReader_afb027d7cc00bde7950e0e2025127d344}{get\_monitor}}()\ \{}
\DoxyCodeLine{00121\ \ \ \textcolor{keywordflow}{return}\ \_monitor;}
\DoxyCodeLine{00122\ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00127\ std::string\ PStatReader::}
\DoxyCodeLine{00128\ get\_hostname()\ \{}
\DoxyCodeLine{00129\ \ \ \textcolor{keywordflow}{if}\ (\_hostname.empty())\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \_hostname\ =\ ConnectionManager::get\_host\_name();}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_hostname.empty())\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \_hostname\ =\ \textcolor{stringliteral}{"{}unknown"{}};}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ \ \ \}}
\DoxyCodeLine{00135\ \ \ \textcolor{keywordflow}{return}\ \_hostname;}
\DoxyCodeLine{00136\ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00141\ \textcolor{keywordtype}{void}\ PStatReader::}
\DoxyCodeLine{00142\ send\_hello()\ \{}
\DoxyCodeLine{00143\ \ \ \mbox{\hyperlink{classPStatServerControlMessage}{PStatServerControlMessage}}\ message;}
\DoxyCodeLine{00144\ \ \ message.\_type\ =\ PStatServerControlMessage::T\_hello;}
\DoxyCodeLine{00145\ \ \ message.\_server\_hostname\ =\ get\_hostname();}
\DoxyCodeLine{00146\ \ \ message.\_server\_progname\ =\ \_monitor-\/>get\_monitor\_name();}
\DoxyCodeLine{00147\ \ \ message.\_udp\_port\ =\ \_udp\_port;}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \mbox{\hyperlink{classDatagram}{Datagram}}\ datagram;}
\DoxyCodeLine{00150\ \ \ message.encode(datagram);}
\DoxyCodeLine{00151\ \ \ \_writer.send(datagram,\ \_tcp\_connection);}
\DoxyCodeLine{00152\ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00158\ \textcolor{keywordtype}{void}\ PStatReader::}
\DoxyCodeLine{00159\ receive\_datagram(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNetDatagram}{NetDatagram}}\ \&datagram)\ \{}
\DoxyCodeLine{00160\ \ \ \mbox{\hyperlink{classConnection}{Connection}}\ *connection\ =\ datagram.get\_connection();}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{if}\ (connection\ ==\ \_tcp\_connection)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \mbox{\hyperlink{classPStatClientControlMessage}{PStatClientControlMessage}}\ message;}
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{keywordflow}{if}\ (message.decode(datagram,\ \_client\_data))\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \ \ handle\_client\_control\_message(message);}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (message.\_type\ ==\ PStatClientControlMessage::T\_datagram)\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ handle\_client\_udp\_data(datagram);}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Got\ unexpected\ message\ from\ client.\(\backslash\)n"{}};}
\DoxyCodeLine{00172\ \ \ \ \ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (connection\ ==\ \_udp\_connection)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ handle\_client\_udp\_data(datagram);}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00178\ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Got\ datagram\ from\ unexpected\ socket.\(\backslash\)n"{}};}
\DoxyCodeLine{00179\ \ \ \}}
\DoxyCodeLine{00180\ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00186\ \textcolor{keywordtype}{void}\ PStatReader::}
\DoxyCodeLine{00187\ handle\_client\_control\_message(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatClientControlMessage}{PStatClientControlMessage}}\ \&message)\ \{}
\DoxyCodeLine{00188\ \ \ \textcolor{keywordflow}{switch}\ (message.\_type)\ \{}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{case}\ PStatClientControlMessage::T\_hello:}
\DoxyCodeLine{00190\ \ \ \ \ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \_client\_data-\/>set\_version(message.\_major\_version,\ message.\_minor\_version);}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ server\_major\_version\ =\ \mbox{\hyperlink{pStatProperties_8cxx_ab00b89028fc41b776b4ffb6347e38d72}{get\_current\_pstat\_major\_version}}();}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ server\_minor\_version\ =\ \mbox{\hyperlink{pStatProperties_8cxx_ab1e70386bfc0561d952141050b5185a3}{get\_current\_pstat\_minor\_version}}();}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (message.\_major\_version\ !=\ server\_major\_version\ ||}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ (message.\_major\_version\ ==\ server\_major\_version\ \&\&}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ message.\_minor\_version\ >\ server\_minor\_version))\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \_monitor-\/>bad\_version(message.\_client\_hostname,\ message.\_client\_progname,}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ message.\_client\_pid,}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ message.\_major\_version,\ message.\_minor\_version,}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server\_major\_version,\ server\_minor\_version);}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \_monitor-\/>close();}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \_monitor-\/>hello\_from(message.\_client\_hostname,\ message.\_client\_progname,}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ message.\_client\_pid);}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00207\ \ \ \ \ \}}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{case}\ PStatClientControlMessage::T\_define\_collectors:}
\DoxyCodeLine{00211\ \ \ \ \ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ (int)message.\_collectors.size();\ i++)\ \{}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \_client\_data-\/>add\_collector(message.\_collectors[i]);}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \_monitor-\/>new\_collector(message.\_collectors[i]-\/>\_index);}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00216\ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \textcolor{keywordflow}{case}\ PStatClientControlMessage::T\_define\_threads:}
\DoxyCodeLine{00220\ \ \ \ \ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \textcolor{comment}{//\ See\ if\ we\ can\ clean\ up\ old\ threads,\ so\ that\ we\ don't\ clutter\ up\ the}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \textcolor{comment}{//\ view\ if\ we\ are\ creating\ many\ threads.}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ thread\_index\ =\ 0;\ thread\_index\ <\ \_client\_data-\/>get\_num\_threads();\ ++thread\_index)\ \{}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client\_data-\/>has\_thread(thread\_index)\ \&\&\ !\_client\_data-\/>is\_thread\_alive(thread\_index))\ \{}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *thread\_data\ =\ (\mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *)\_client\_data-\/>get\_thread\_data(thread\_index);}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (thread\_data-\/>\mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{prune\_history}}(\_client\_data-\/>get\_latest\_time()))\ \{}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \_client\_data-\/>remove\_thread(thread\_index);}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \_monitor-\/>remove\_thread(thread\_index);}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ (int)message.\_names.size();\ i++)\ \{}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ thread\_index\ =\ message.\_first\_thread\_index\ +\ i;}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ std::string\ name\ =\ message.\_names[i];}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \_client\_data-\/>define\_thread(thread\_index,\ name,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \_monitor-\/>new\_thread(thread\_index);}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00239\ \ \ \ \ \}}
\DoxyCodeLine{00240\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \textcolor{keywordflow}{case}\ PStatClientControlMessage::T\_expire\_thread:}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client\_data-\/>has\_thread(message.\_first\_thread\_index))\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ the\ thread\ right\ away\ if\ it\ has\ no\ recent\ data.}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *thread\_data\ =\ (\mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *)\_client\_data-\/>get\_thread\_data(message.\_first\_thread\_index);}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (thread\_data-\/>\mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{prune\_history}}(\_client\_data-\/>get\_latest\_time()))\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \_client\_data-\/>remove\_thread(message.\_first\_thread\_index);}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \_monitor-\/>remove\_thread(message.\_first\_thread\_index);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ just\ mark\ it\ as\ expired,\ and\ we'll\ remove\ it\ later.}}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \_client\_data-\/>expire\_thread(message.\_first\_thread\_index);}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00253\ \ \ \ \ \}}
\DoxyCodeLine{00254\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00257\ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Invalid\ control\ message\ received\ from\ client.\(\backslash\)n"{}};}
\DoxyCodeLine{00258\ \ \ \}}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00265\ \textcolor{keywordtype}{void}\ PStatReader::}
\DoxyCodeLine{00266\ handle\_client\_udp\_data(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&datagram)\ \{}
\DoxyCodeLine{00267\ \ \ \textcolor{keywordflow}{if}\ (!\_monitor-\/>is\_client\_known())\ \{}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{comment}{//\ If\ we\ haven't\ heard\ a\ "{}hello"{}\ from\ the\ client\ yet,\ we\ don't\ know\ what}}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{comment}{//\ version\ data\ it\ will\ be\ sending\ us,\ so\ we\ can't\ decode\ the\ data.}}
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{comment}{//\ Chances\ are\ good\ we\ can't\ display\ it\ sensibly\ yet\ anyway.\ \ Ignore\ frame}}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{comment}{//\ data\ until\ we\ get\ that\ hello.}}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00273\ \ \ \}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ source(datagram);}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{if}\ (\_client\_data-\/>is\_at\_least(2,\ 1))\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{comment}{//\ Throw\ away\ the\ zero\ byte\ at\ the\ beginning.}}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordtype}{int}\ initial\_byte\ =\ source.get\_uint8();}
\DoxyCodeLine{00280\ \ \ \ \ nassertv(initial\_byte\ ==\ 0);}
\DoxyCodeLine{00281\ \ \ \}}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00283\ \ \ \textcolor{keywordflow}{if}\ (!\_queued\_frame\_data.full())\ \{}
\DoxyCodeLine{00284\ \ \ \ \ FrameData\ data;}
\DoxyCodeLine{00285\ \ \ \ \ data.\_thread\_index\ =\ source.get\_uint16();}
\DoxyCodeLine{00286\ \ \ \ \ data.\_frame\_number\ =\ source.get\_uint32();}
\DoxyCodeLine{00287\ \ \ \ \ data.\_frame\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}};}
\DoxyCodeLine{00288\ \ \ \ \ data.\_frame\_data-\/>\mbox{\hyperlink{classPStatFrameData_a1249a652b0766c18b6a5a9aadaf19b3c}{read\_datagram}}(source,\ \_client\_data);}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{comment}{//\ Queue\ up\ the\ data\ till\ we're\ ready\ to\ handle\ it\ in\ a\ single-\/threaded}}
\DoxyCodeLine{00291\ \ \ \ \ \textcolor{comment}{//\ way.}}
\DoxyCodeLine{00292\ \ \ \ \ \_queued\_frame\_data.push\_back(data);}
\DoxyCodeLine{00293\ \ \ \}}
\DoxyCodeLine{00294\ \}}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00300\ \textcolor{keywordtype}{void}\ PStatReader::}
\DoxyCodeLine{00301\ dequeue\_frame\_data()\ \{}
\DoxyCodeLine{00302\ \ \ \textcolor{keywordflow}{if}\ (\_queued\_frame\_data.empty())\ \{}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{keyword}{const}\ FrameData\ \&data\ =\ \_queued\_frame\_data.front();}
\DoxyCodeLine{00308\ \ \ \ \ nassertv(\_client\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{comment}{//\ Check\ to\ see\ if\ any\ new\ collectors\ have\ level\ data.}}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_levels\ =\ data.\_frame\_data-\/>get\_num\_levels();}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_levels;\ i++)\ \{}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ collector\_index\ =\ data.\_frame\_data-\/>get\_level\_collector(i);}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_client\_data-\/>get\_collector\_has\_level(collector\_index,\ data.\_thread\_index))\ \{}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ collector\ is\ now\ reporting\ level\ data,\ and\ it\ wasn't\ before.}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \_client\_data-\/>set\_collector\_has\_level(collector\_index,\ data.\_thread\_index,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \_monitor-\/>new\_collector(collector\_index);}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00319\ \ \ \ \ \}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \ \ \_client\_data-\/>record\_new\_frame(data.\_thread\_index,}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ data.\_frame\_number,}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ data.\_frame\_data);}
\DoxyCodeLine{00324\ \ \ \ \ \_monitor-\/>new\_data(data.\_thread\_index,\ data.\_frame\_number);}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \ \ \_queued\_frame\_data.pop\_front();}
\DoxyCodeLine{00327\ \ \ \}}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{while}\ (!\_queued\_frame\_data.empty());}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \textcolor{comment}{//\ Clean\ up\ old\ threads.}}
\DoxyCodeLine{00331\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ thread\_index\ =\ 0;\ thread\_index\ <\ \_client\_data-\/>get\_num\_threads();\ ++thread\_index)\ \{}
\DoxyCodeLine{00332\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client\_data-\/>has\_thread(thread\_index)\ \&\&\ !\_client\_data-\/>is\_thread\_alive(thread\_index))\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *thread\_data\ =\ (\mbox{\hyperlink{classPStatThreadData}{PStatThreadData}}\ *)\_client\_data-\/>get\_thread\_data(thread\_index);}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (thread\_data-\/>\mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{prune\_history}}(\_client\_data-\/>get\_latest\_time()))\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \_client\_data-\/>remove\_thread(thread\_index);}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \_monitor-\/>remove\_thread(thread\_index);}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00338\ \ \ \ \ \}}
\DoxyCodeLine{00339\ \ \ \}}
\DoxyCodeLine{00340\ \}}

\end{DoxyCode}
