\doxysection{pnm\+File\+Type\+Android\+Writer.\+cxx}
\hypertarget{pnmFileTypeAndroidWriter_8cxx_source}{}\label{pnmFileTypeAndroidWriter_8cxx_source}\index{panda/src/android/pnmFileTypeAndroidWriter.cxx@{panda/src/android/pnmFileTypeAndroidWriter.cxx}}
\mbox{\hyperlink{pnmFileTypeAndroidWriter_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeAndroid_8h}{pnmFileTypeAndroid.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ ANDROID}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pnmimagetypes_8h}{config\_pnmimagetypes.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <android/bitmap.h>}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <jni.h>}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{comment}{//\ See\ android/graphics/Bitmap.java}}
\DoxyCodeLine{00024\ \textcolor{keyword}{enum\ class}\ BitmapConfig\ :\ jint\ \{}
\DoxyCodeLine{00025\ \ \ ALPHA\_8\ =\ 1,}
\DoxyCodeLine{00026\ \ \ RGB\_565\ =\ 3,}
\DoxyCodeLine{00027\ \ \ ARGB\_4444\ =\ 4,}
\DoxyCodeLine{00028\ \ \ ARGB\_8888\ =\ 5,}
\DoxyCodeLine{00029\ \ \ RGBA\_F16\ =\ 6,}
\DoxyCodeLine{00030\ \ \ HARDWARE\ =\ 7,}
\DoxyCodeLine{00031\ \};}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00036\ PNMFileTypeAndroid::Writer::}
\DoxyCodeLine{00037\ Writer(\mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type,\ std::ostream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ CompressFormat\ format)\ :}
\DoxyCodeLine{00039\ \ \ \mbox{\hyperlink{classPNMWriter}{PNMWriter}}(type,\ file,\ owns\_file),}
\DoxyCodeLine{00040\ \ \ \_format(format)}
\DoxyCodeLine{00041\ \{}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00060\ \textcolor{keywordtype}{int}\ PNMFileTypeAndroid::Writer::}
\DoxyCodeLine{00061\ write\_data(\mbox{\hyperlink{structpixel}{xel}}\ *array,\ xelval\ *alpha)\ \{}
\DoxyCodeLine{00062\ \ \ \textcolor{keywordtype}{size\_t}\ num\_pixels\ =\ (size\_t)\_x\_size\ *\ (\textcolor{keywordtype}{size\_t})\_y\_size;}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00065\ \ \ JNIEnv\ *env\ =\ current\_thread-\/>get\_jni\_env();}
\DoxyCodeLine{00066\ \ \ nassertr(env\ !=\ \textcolor{keyword}{nullptr},\ 0);}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{//\ Create\ a\ Bitmap\ object.}}
\DoxyCodeLine{00069\ \ \ jobject\ bitmap\ =}
\DoxyCodeLine{00070\ \ \ \ \ env-\/>CallStaticObjectMethod(jni\_PandaActivity,}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jni\_PandaActivity\_createBitmap,}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (jint)\_x\_size,\ (jint)\_y\_size,}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ BitmapConfig::ARGB\_8888,}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (jboolean)has\_alpha());}
\DoxyCodeLine{00075\ \ \ nassertr(bitmap\ !=\ \textcolor{keyword}{nullptr},\ 0);}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \textcolor{comment}{//\ Get\ a\ writable\ pointer\ to\ write\ our\ pixel\ data\ to.}}
\DoxyCodeLine{00078\ \ \ uint32\_t\ *out;}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordtype}{int}\ rc\ =\ AndroidBitmap\_lockPixels(env,\ bitmap,\ (\textcolor{keywordtype}{void}\ **)\&out);}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (rc\ !=\ 0)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ android\_cat.error()}
\DoxyCodeLine{00082\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ lock\ bitmap\ pixels\ (result\ code\ "{}}\ <<\ rc\ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00084\ \ \ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \textcolor{keywordflow}{if}\ (\_maxval\ ==\ 255)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_alpha()\ \&\&\ alpha\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_pixels;\ ++i)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ out[i]\ =\ (array[i].r)}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ (array[i].g\ <<\ 8u)}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ (array[i].b\ <<\ 16u)}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ (alpha[i]\ <<\ 24u);}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00094\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_pixels;\ ++i)\ \{}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ out[i]\ =\ (array[i].r)}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ (array[i].g\ <<\ 8u)}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ (array[i].b\ <<\ 16u)}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ 0xff000000u;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00101\ \ \ \ \ \}}
\DoxyCodeLine{00102\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keywordtype}{double}\ ratio\ =\ 255.0\ /\ \_maxval;}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_alpha()\ \&\&\ alpha\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_pixels;\ ++i)\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ out[i]\ =\ ((uint32\_t)(array[i].r\ *\ ratio))}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ ((uint32\_t)(array[i].g\ *\ ratio)\ <<\ 8u)}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ ((uint32\_t)(array[i].b\ *\ ratio)\ <<\ 16u)}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ ((uint32\_t)(alpha[i]\ *\ ratio)\ <<\ 24u);}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_pixels;\ ++i)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ out[i]\ =\ ((uint32\_t)(array[i].r\ *\ ratio))}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ ((uint32\_t)(array[i].g\ *\ ratio)\ <<\ 8u)}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ ((uint32\_t)(array[i].b\ *\ ratio)\ <<\ 16u)}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ |\ 0xff000000u;}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ \}}
\DoxyCodeLine{00119\ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{comment}{//\ Finally,\ unlock\ the\ pixel\ data\ and\ compress\ it\ to\ the\ ostream.}}
\DoxyCodeLine{00122\ \ \ AndroidBitmap\_unlockPixels(env,\ bitmap);}
\DoxyCodeLine{00123\ \ \ jboolean\ res\ =}
\DoxyCodeLine{00124\ \ \ \ \ env-\/>CallStaticBooleanMethod(jni\_PandaActivity,}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jni\_PandaActivity\_compressBitmap,}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ bitmap,\ \_format,\ 85,\ (jlong)\_file);}
\DoxyCodeLine{00127\ \ \ \textcolor{keywordflow}{if}\ (!res)\ \{}
\DoxyCodeLine{00128\ \ \ \ \ android\_cat.error()}
\DoxyCodeLine{00129\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ compress\ bitmap.\(\backslash\)n"{}};}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00131\ \ \ \}}
\DoxyCodeLine{00132\ \ \ \textcolor{keywordflow}{return}\ \_y\_size;}
\DoxyCodeLine{00133\ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00141\ \textcolor{keywordtype}{bool}\ PNMFileTypeAndroid::Writer::}
\DoxyCodeLine{00142\ supports\_grayscale()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00143\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00144\ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ ANDROID}}

\end{DoxyCode}
