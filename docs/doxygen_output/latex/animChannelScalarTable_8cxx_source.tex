\doxysection{anim\+Channel\+Scalar\+Table.\+cxx}
\hypertarget{animChannelScalarTable_8cxx_source}{}\label{animChannelScalarTable_8cxx_source}\index{panda/src/chan/animChannelScalarTable.cxx@{panda/src/chan/animChannelScalarTable.cxx}}
\mbox{\hyperlink{animChannelScalarTable_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{animChannelScalarTable_8h}{animChannelScalarTable.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{animBundle_8h}{animBundle.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__chan_8h}{config\_chan.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{fftCompressor_8h}{fftCompressor.h}}"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ AnimChannelScalarTable::\_type\_handle;}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00030\ AnimChannelScalarTable::}
\DoxyCodeLine{00031\ AnimChannelScalarTable()\ :\ \_table(get\_class\_type())\ \{}
\DoxyCodeLine{00032\ \}}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00039\ AnimChannelScalarTable::}
\DoxyCodeLine{00040\ AnimChannelScalarTable(\mbox{\hyperlink{classAnimGroup}{AnimGroup}}\ *parent,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classAnimChannelScalarTable}{AnimChannelScalarTable}}\ \&copy)\ :}
\DoxyCodeLine{00041\ \ \ \mbox{\hyperlink{classAnimChannel}{AnimChannelScalar}}(parent,\ copy),}
\DoxyCodeLine{00042\ \ \ \_table(copy.\_table)}
\DoxyCodeLine{00043\ \{}
\DoxyCodeLine{00044\ \}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00049\ AnimChannelScalarTable::}
\DoxyCodeLine{00050\ AnimChannelScalarTable(\mbox{\hyperlink{classAnimGroup}{AnimGroup}}\ *parent,\ \textcolor{keyword}{const}\ std::string\ \&name)\ :}
\DoxyCodeLine{00051\ \ \ \mbox{\hyperlink{classAnimChannel}{AnimChannelScalar}}(parent,\ name),}
\DoxyCodeLine{00052\ \ \ \_table(get\_class\_type())}
\DoxyCodeLine{00053\ \{}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00061\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classAnimChannelScalarTable_a01b2966f8cc66ad483f849a55e0feba4}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00062\ \mbox{\hyperlink{classAnimChannelScalarTable_a01b2966f8cc66ad483f849a55e0feba4}{has\_changed}}(\textcolor{keywordtype}{int}\ last\_frame,\ \textcolor{keywordtype}{double}\ last\_frac,}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ this\_frame,\ \textcolor{keywordtype}{double}\ this\_frac)\ \{}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordflow}{if}\ (\_table.size()\ >\ 1)\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_frame\ !=\ this\_frame)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_table[last\_frame\ \%\ \_table.size()]\ !=}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \_table[this\_frame\ \%\ \_table.size()])\ \{}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00070\ \ \ \ \ \}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_frac\ !=\ this\_frac)\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ some\ fractional\ changes,\ also\ check\ the\ next\ subsequent}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \textcolor{comment}{//\ frame\ (since\ we'll\ be\ blending\ with\ that).}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_table[last\_frame\ \%\ \_table.size()]\ !=}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \_table[(this\_frame\ +\ 1)\ \%\ \_table.size()])\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00078\ \ \ \ \ \}}
\DoxyCodeLine{00079\ \ \ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00082\ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00087\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classAnimChannelScalarTable_a47bdcd30562b27e688d36818db03d8da}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00088\ \mbox{\hyperlink{classAnimChannelScalarTable_a47bdcd30562b27e688d36818db03d8da}{get\_value}}(\textcolor{keywordtype}{int}\ frame,\ PN\_stdfloat\ \&value)\ \{}
\DoxyCodeLine{00089\ \ \ \textcolor{keywordflow}{if}\ (\_table.empty())\ \{}
\DoxyCodeLine{00090\ \ \ \ \ value\ =\ 0.0f;}
\DoxyCodeLine{00091\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00092\ \ \ \ \ value\ =\ \_table[frame\ \%\ \_table.size()];}
\DoxyCodeLine{00093\ \ \ \}}
\DoxyCodeLine{00094\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00100\ \textcolor{keywordtype}{void}\ AnimChannelScalarTable::}
\DoxyCodeLine{00101\ set\_table(\textcolor{keyword}{const}\ \mbox{\hyperlink{classConstPointerToArray}{CPTA\_stdfloat}}\ \&table)\ \{}
\DoxyCodeLine{00102\ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ \_root-\/>get\_num\_frames();}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \textcolor{keywordflow}{if}\ (table.size()\ >\ 1\ \&\&\ (\textcolor{keywordtype}{int})table.size()\ <\ num\_frames)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{comment}{//\ The\ new\ table\ has\ an\ invalid\ number\ of\ frames-\/-\/it\ doesn't\ match\ the}}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{comment}{//\ bundle's\ requirement.}}
\DoxyCodeLine{00107\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}mismatched\ number\ of\ frames"{}});}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00109\ \ \ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \_table\ =\ table;}
\DoxyCodeLine{00112\ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00117\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classAnimChannelScalarTable_afc1daae3c3abd18727c26a23193eee07}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00118\ \mbox{\hyperlink{classAnimChannelScalarTable_afc1daae3c3abd18727c26a23193eee07}{write}}(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00119\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)}
\DoxyCodeLine{00120\ \ \ \ \ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ \_table.size();}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (!\_children.empty())\ \{}
\DoxyCodeLine{00123\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \{\(\backslash\)n"{}};}
\DoxyCodeLine{00124\ \ \ \ \ \mbox{\hyperlink{classAnimGroup_af0e2255c521ed767f02eff6bcdd043d2}{write\_descendants}}(out,\ indent\_level\ +\ 2);}
\DoxyCodeLine{00125\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}\}"{}};}
\DoxyCodeLine{00126\ \ \ \}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00136\ \mbox{\hyperlink{classAnimGroup}{AnimGroup}}\ *\mbox{\hyperlink{classAnimChannelScalarTable_a8567e546e86d76fbb2fcd0c92b2b3566}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00137\ \mbox{\hyperlink{classAnimChannelScalarTable_a8567e546e86d76fbb2fcd0c92b2b3566}{make\_copy}}(\mbox{\hyperlink{classAnimGroup}{AnimGroup}}\ *parent)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classAnimChannelScalarTable}{AnimChannelScalarTable}}(parent,\ *\textcolor{keyword}{this});}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00145\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classAnimChannelScalarTable_a435d449ef91219a342efe32741c86734}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00146\ \mbox{\hyperlink{classAnimChannelScalarTable_a435d449ef91219a342efe32741c86734}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&me)\ \{}
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{classAnimChannelBase_a3fe5cec86bcb87e3f3cd8c5274db094a}{AnimChannelScalar::write\_datagram}}(manager,\ me);}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{if}\ (compress\_channels)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ chan\_cat.warning()}
\DoxyCodeLine{00151\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}FFT\ compression\ of\ animations\ is\ deprecated.\ \ For\ compatibility\ "{}}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}with\ future\ versions\ of\ Panda3D,\ set\ compress-\/channels\ to\ false.\(\backslash\)n"{}};}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classFFTCompressor_adaa64eb86e996609d2f7b3dcc9c47abe}{FFTCompressor::is\_compression\_available}}())\ \{}
\DoxyCodeLine{00155\ \ \ \ \ \ \ chan\_cat.error()}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Compression\ is\ not\ available;\ writing\ uncompressed\ channels.\(\backslash\)n"{}};}
\DoxyCodeLine{00157\ \ \ \ \ \ \ compress\_channels\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ me.add\_bool(compress\_channels);}
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{if}\ (!compress\_channels)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{comment}{//\ Write\ out\ everything\ the\ old\ way,\ as\ floats.}}
\DoxyCodeLine{00164\ \ \ \ \ me.add\_uint16(\_table.size());}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ (int)\_table.size();\ i++)\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ me.add\_stdfloat(\_table[i]);}
\DoxyCodeLine{00167\ \ \ \ \ \}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{comment}{//\ Some\ channels,\ particularly\ blink\ channels,\ may\ involve\ only\ a\ small}}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{comment}{//\ number\ of\ discrete\ values.\ \ If\ we\ come\ across\ one\ of\ those,\ write\ it}}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{comment}{//\ out\ losslessly,\ since\ the\ lossy\ compression\ could\ damage\ it}}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{comment}{//\ significantly\ (and\ we\ can\ achieve\ better\ compression\ directly\ anyway).}}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{comment}{//\ We\ consider\ the\ channel\ value\ only\ to\ the\ nearest\ 1000th\ for\ this}}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{comment}{//\ purpose,\ because\ floats\ aren't\ very\ good\ at\ being\ precisely\ equal\ to}}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{comment}{//\ each\ other.}}
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_values\ =\ 16;}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ scale\ =\ 1000.0f;}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \mbox{\hyperlink{classpmap}{pmap<int,\ int>}}\ index;}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ i\ <\ (int)\_table.size()\ \&\&\ (int)index.size()\ <=\ max\_values;}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ i++)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ value\ =\ (int)cfloor(\_table[i]\ *\ scale\ +\ 0.5f);}
\DoxyCodeLine{00186\ \ \ \ \ \ \ index.insert(\mbox{\hyperlink{classpmap}{pmap<int,\ int>::value\_type}}(value,\ index.size()));}
\DoxyCodeLine{00187\ \ \ \ \ \}}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keywordtype}{int}\ index\_length\ =\ index.size();}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ <=\ max\_values)\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \textcolor{comment}{//\ All\ right,\ here's\ a\ blink\ channel.\ \ Now\ we\ write\ out\ the\ index\ table,}}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \textcolor{comment}{//\ and\ then\ a\ table\ of\ all\ the\ index\ values,\ two\ per\ byte.}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ me.add\_uint8(index\_length);}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ >\ 0)\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ write\ the\ index\ in\ order\ by\ its\ index\ number;\ for\ this,}}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we\ need\ to\ invert\ the\ index.}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ vector\_stdfloat\ reverse\_index(index\_length);}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classpmap}{pmap<int,\ int>::iterator}}\ mi;}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ index.begin();\ mi\ !=\ index.end();\ ++mi)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ f\ =\ (PN\_stdfloat)(*mi).first\ /\ scale;}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i\ =\ (*mi).second;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ nassertv(i\ >=\ 0\ \&\&\ i\ <\ (\textcolor{keywordtype}{int})reverse\_index.size());}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ reverse\_index[i]\ =\ f;}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ index\_length;\ i++)\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ me.add\_stdfloat(reverse\_index[i]);}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ write\ out\ the\ actual\ channels.\ \ We\ write\ these\ two\ at\ a\ time,}}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ high\ and\ low\ nibbles\ of\ each\ byte.}}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ table\_length\ =\ \_table.size();}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ me.add\_uint16(table\_length);}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ ==\ 1)\ \{}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ fact,\ we\ don't\ even\ need\ to\ write\ the\ channels\ at\ all,\ if}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ there\ weren't\ at\ least\ two\ different\ values.}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ table\_length\ -\/\ 1;\ i+=\ 2)\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ value1\ =\ (int)cfloor(\_table[i]\ *\ scale\ +\ 0.5f);}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ value2\ =\ (int)cfloor(\_table[i\ +\ 1]\ *\ scale\ +\ 0.5f);}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i1\ =\ index[value1];}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i2\ =\ index[value2];}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ me.add\_uint8((i1\ <<\ 4)\ |\ i2);}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ might\ be\ one\ odd\ value.}}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ <\ table\_length)\ \{}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ value1\ =\ (int)cfloor(\_table[i]\ *\ scale\ +\ 0.5f);}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i1\ =\ index[value1];}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ me.add\_uint8(i1\ <<\ 4);}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \textcolor{comment}{//\ No,\ we\ have\ continuous\ channels.\ \ Write\ them\ out\ using\ lossy}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \textcolor{comment}{//\ compression.}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ me.add\_uint8(0xff);}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ \ \ \ \ \mbox{\hyperlink{classFFTCompressor}{FFTCompressor}}\ compressor;}
\DoxyCodeLine{00245\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_a53b0db870b069e6bd5513963af476fe2}{set\_quality}}(compress\_chan\_quality);}
\DoxyCodeLine{00246\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_a1ee5f3c053b9f9e3909bd9411ac471d9}{set\_use\_error\_threshold}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00247\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_ae4cae5073d6e047daeb3a2ed61a32838}{write\_header}}(me);}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_ae97e74c103db5941590843c2cc88bcab}{write\_reals}}(me,\ \_table,\ \_table.size());}
\DoxyCodeLine{00250\ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \}}
\DoxyCodeLine{00252\ \}}
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00259\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classAnimChannelScalarTable_a720a2ea6a5f0a699f58ede2256d2789a}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00260\ \mbox{\hyperlink{classAnimChannelScalarTable_a720a2ea6a5f0a699f58ede2256d2789a}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\&\ scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}*\ manager)\ \{}
\DoxyCodeLine{00261\ \ \ \mbox{\hyperlink{classAnimChannelBase_a83cbae12fb62fcde4d2e90ed3f483489}{AnimChannelScalar::fillin}}(scan,\ manager);}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \ \ \textcolor{keywordtype}{bool}\ wrote\_compressed\ =\ scan.get\_bool();}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \mbox{\hyperlink{classPointerToArray}{PTA\_stdfloat}}\ temp\_table\ =\ PTA\_stdfloat::empty\_array(0,\ get\_class\_type());}
\DoxyCodeLine{00266\ }
\DoxyCodeLine{00267\ \ \ \textcolor{keywordflow}{if}\ (!wrote\_compressed)\ \{}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{comment}{//\ Regular\ floats.}}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordtype}{int}\ size\ =\ scan.get\_uint16();}
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ size;\ i++)\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \ \ temp\_table.push\_back(scan.get\_stdfloat());}
\DoxyCodeLine{00272\ \ \ \ \ \}}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{comment}{//\ Compressed\ channels.\ \ Did\ we\ write\ them\ as\ discrete\ or\ continuous}}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{comment}{//\ channel\ values?}}
\DoxyCodeLine{00277\ \ \ \ \ \textcolor{keywordtype}{int}\ index\_length\ =\ scan.get\_uint8();}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ <\ 0xff)\ \{}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \textcolor{comment}{//\ Discrete.\ \ Read\ in\ the\ index.}}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ >\ 0)\ \{}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ PN\_stdfloat\ *index\ =\ (PN\_stdfloat\ *)alloca(index\_length\ *\ \textcolor{keyword}{sizeof}(PN\_stdfloat));}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ index\_length;\ i++)\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ index[i]\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ read\ in\ the\ channel\ values.}}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ table\_length\ =\ scan.get\_uint16();}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (index\_length\ ==\ 1)\ \{}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ With\ only\ one\ index\ value,\ we\ can\ infer\ the\ table.}}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ table\_length;\ i++)\ \{}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ temp\_table.push\_back(index[0]);}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ must\ read\ it.}}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ table\_length\ -\/\ 1;\ i+=\ 2)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\ =\ scan.get\_uint8();}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i1\ =\ (num\ >>\ 4)\ \&\ 0xf;}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i2\ =\ num\ \&\ 0xf;}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ temp\_table.push\_back(index[i1]);}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ temp\_table.push\_back(index[i2]);}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ might\ be\ one\ odd\ value.}}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ <\ table\_length)\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\ =\ scan.get\_uint8();}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i1\ =\ (num\ >>\ 4)\ \&\ 0xf;}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ temp\_table.push\_back(index[i1]);}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00313\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \textcolor{comment}{//\ Continuous\ channels.}}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \mbox{\hyperlink{classFFTCompressor}{FFTCompressor}}\ compressor;}
\DoxyCodeLine{00316\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_a67f6b46d2ee1d06ad4549eabdcc2c439}{read\_header}}(scan,\ manager-\/>get\_file\_minor\_ver());}
\DoxyCodeLine{00317\ \ \ \ \ \ \ compressor.\mbox{\hyperlink{classFFTCompressor_a1be8ffd0b57154f9e36b163ebb85f2d0}{read\_reals}}(scan,\ temp\_table.v());}
\DoxyCodeLine{00318\ \ \ \ \ \}}
\DoxyCodeLine{00319\ \ \ \}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \_table\ =\ temp\_table;}
\DoxyCodeLine{00322\ \}}
\DoxyCodeLine{00323\ }
\DoxyCodeLine{00327\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classAnimChannelScalarTable_afac2a9f0876432fd978af244b63ee2dc}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00328\ \mbox{\hyperlink{classAnimChannelScalarTable_afac2a9f0876432fd978af244b63ee2dc}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00329\ \ \ \mbox{\hyperlink{classAnimChannelScalarTable}{AnimChannelScalarTable}}\ *me\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classAnimChannelScalarTable}{AnimChannelScalarTable}};}
\DoxyCodeLine{00330\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00331\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00334\ \ \ me-\/>\mbox{\hyperlink{classAnimChannelScalarTable_a720a2ea6a5f0a699f58ede2256d2789a}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00335\ \ \ \textcolor{keywordflow}{return}\ me;}
\DoxyCodeLine{00336\ \}}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00341\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classAnimChannelScalarTable_a8a4f2460c47f4569cf51175e70fcf312}{AnimChannelScalarTable::}}}
\DoxyCodeLine{00342\ \mbox{\hyperlink{classAnimChannelScalarTable_a8a4f2460c47f4569cf51175e70fcf312}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00343\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classAnimChannelScalarTable_afac2a9f0876432fd978af244b63ee2dc}{make\_from\_bam}});}
\DoxyCodeLine{00344\ \}}

\end{DoxyCode}
