\doxysection{compose\+\_\+matrix\+\_\+src.\+cxx}
\hypertarget{compose__matrix__src_8cxx_source}{}\label{compose__matrix__src_8cxx_source}\index{panda/src/linmath/compose\_matrix\_src.cxx@{panda/src/linmath/compose\_matrix\_src.cxx}}
\mbox{\hyperlink{compose__matrix__src_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00022\ unwind\_yup\_rotation\_old\_hpr(FLOATNAME(LMatrix3)\ \&mat,\ FLOATNAME(LVecBase3)\ \&hpr)\ \{}
\DoxyCodeLine{00023\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}void\ unwind\_yup\_rotation\_old\_hpr(LMatrix3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \ \ \textcolor{comment}{//\ Extract\ the\ axes\ from\ the\ matrix.}}
\DoxyCodeLine{00026\ \ \ FLOATNAME(LVector3)\ x,\ y,\ z;}
\DoxyCodeLine{00027\ \ \ mat.get\_row(x,0);}
\DoxyCodeLine{00028\ \ \ mat.get\_row(y,1);}
\DoxyCodeLine{00029\ \ \ mat.get\_row(z,2);}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \textcolor{comment}{//\ Project\ X\ onto\ the\ XY\ plane.}}
\DoxyCodeLine{00032\ \ \ FLOATNAME(LVector2)\ xy(x[0],\ x[1]);}
\DoxyCodeLine{00033\ \ \ xy\ =\ normalize(xy);}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Z\ (back)\ axis.\ \ This\ is\ roll.}}
\DoxyCodeLine{00036\ \ \ FLOATTYPE\ roll\ =\ rad\_2\_deg(((FLOATTYPE)catan2(xy[1],\ xy[0])));}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \ \textcolor{comment}{//\ Unwind\ the\ roll\ from\ the\ axes,\ and\ continue.}}
\DoxyCodeLine{00039\ \ \ FLOATNAME(LMatrix3)\ rot\_z;}
\DoxyCodeLine{00040\ \ \ rot\_z.set\_rotate\_mat\_normaxis(-\/roll,\ FLOATNAME(LVector3)(0.0f,\ 0.0f,\ 1.0f),}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_yup\_right);}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ x\ =\ x\ *\ rot\_z;}
\DoxyCodeLine{00044\ \ \ y\ =\ y\ *\ rot\_z;}
\DoxyCodeLine{00045\ \ \ z\ =\ z\ *\ rot\_z;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ X\ into\ the\ XZ\ plane.}}
\DoxyCodeLine{00048\ \ \ FLOATNAME(LVector2)\ xz(x[0],\ x[2]);}
\DoxyCodeLine{00049\ \ \ xz\ =\ normalize(xz);}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Y\ (up)\ axis.\ \ This\ is\ yaw,\ or\ "{}heading"{}.}}
\DoxyCodeLine{00052\ \ \ FLOATTYPE\ heading\ =\ rad\_2\_deg(((FLOATTYPE)-\/catan2(xz[1],\ xz[0])));}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \textcolor{comment}{//\ Unwind\ the\ heading,\ and\ continue.}}
\DoxyCodeLine{00055\ \ \ FLOATNAME(LMatrix3)\ rot\_y;}
\DoxyCodeLine{00056\ \ \ rot\_y.set\_rotate\_mat\_normaxis(-\/heading,\ FLOATNAME(LVector3)(0.0f,\ 1.0f,\ 0.0f),}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_yup\_right);}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ x\ =\ x\ *\ rot\_y;}
\DoxyCodeLine{00060\ \ \ y\ =\ y\ *\ rot\_y;}
\DoxyCodeLine{00061\ \ \ z\ =\ z\ *\ rot\_y;}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ Z\ into\ the\ YZ\ plane.}}
\DoxyCodeLine{00064\ \ \ FLOATNAME(LVector2)\ yz(z[1],\ z[2]);}
\DoxyCodeLine{00065\ \ \ yz\ =\ normalize(yz);}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +X\ (right)\ axis.\ \ This\ is\ pitch.}}
\DoxyCodeLine{00068\ \ \ FLOATTYPE\ pitch\ =\ rad\_2\_deg(((FLOATTYPE)-\/catan2(yz[0],\ yz[1])));}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{comment}{//\ Unwind\ the\ pitch.}}
\DoxyCodeLine{00071\ \ \ FLOATNAME(LMatrix3)\ rot\_x;}
\DoxyCodeLine{00072\ \ \ rot\_x.set\_rotate\_mat\_normaxis(-\/pitch,\ FLOATNAME(LVector3)(1.0f,\ 0.0f,\ 0.0f),}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_yup\_right);}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ x\ =\ x\ *\ rot\_x;}
\DoxyCodeLine{00076\ \ \ y\ =\ y\ *\ rot\_x;}
\DoxyCodeLine{00077\ \ \ z\ =\ z\ *\ rot\_x;}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \textcolor{comment}{//\ Reset\ the\ matrix\ to\ reflect\ the\ unwinding.}}
\DoxyCodeLine{00080\ \ \ mat.set\_row(0,\ x);}
\DoxyCodeLine{00081\ \ \ mat.set\_row(1,\ y);}
\DoxyCodeLine{00082\ \ \ mat.set\_row(2,\ z);}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \textcolor{comment}{//\ Return\ the\ three\ rotation\ components.}}
\DoxyCodeLine{00085\ \ \ hpr[0]\ =\ heading;}
\DoxyCodeLine{00086\ \ \ hpr[1]\ =\ pitch;}
\DoxyCodeLine{00087\ \ \ hpr[2]\ =\ roll;}
\DoxyCodeLine{00088\ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00097\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00098\ unwind\_zup\_rotation\_old\_hpr(FLOATNAME(LMatrix3)\ \&mat,\ FLOATNAME(LVecBase3)\ \&hpr)\ \{}
\DoxyCodeLine{00099\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}void\ unwind\_zup\_rotation\_old\_hpr(LMatrix3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00100\ \ \ \textcolor{comment}{//\ Extract\ the\ axes\ from\ the\ matrix.}}
\DoxyCodeLine{00101\ \ \ FLOATNAME(LVector3)\ x,\ y,\ z;}
\DoxyCodeLine{00102\ \ \ mat.get\_row(x,0);}
\DoxyCodeLine{00103\ \ \ mat.get\_row(y,1);}
\DoxyCodeLine{00104\ \ \ mat.get\_row(z,2);}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \textcolor{comment}{//\ Project\ X\ into\ the\ XZ\ plane.}}
\DoxyCodeLine{00108\ \ \ FLOATNAME(LVector2)\ xz(x[0],\ x[2]);}
\DoxyCodeLine{00109\ \ \ xz\ =\ normalize(xz);}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ -\/Y\ (back)\ axis.\ \ This\ is\ roll.}}
\DoxyCodeLine{00112\ \ \ FLOATTYPE\ roll\ =\ rad\_2\_deg(((FLOATTYPE)catan2(xz[1],\ xz[0])));}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \textcolor{keywordflow}{if}\ (y[1]\ <\ 0.0f)\ \{}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordflow}{if}\ (roll\ <\ 0.0f)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ roll\ +=\ 180.0;}
\DoxyCodeLine{00117\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ roll\ -\/=\ 180.0;}
\DoxyCodeLine{00119\ \ \ \ \ \}}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \textcolor{comment}{//\ Unwind\ the\ roll\ from\ the\ axes,\ and\ continue.}}
\DoxyCodeLine{00123\ \ \ FLOATNAME(LMatrix3)\ rot\_y;}
\DoxyCodeLine{00124\ \ \ rot\_y.set\_rotate\_mat\_normaxis(roll,\ FLOATNAME(LVector3)(0.0f,\ 1.0f,\ 0.0f),}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_zup\_right);}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ x\ =\ x\ *\ rot\_y;}
\DoxyCodeLine{00128\ \ \ y\ =\ y\ *\ rot\_y;}
\DoxyCodeLine{00129\ \ \ z\ =\ z\ *\ rot\_y;}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ X\ into\ the\ XY\ plane.}}
\DoxyCodeLine{00132\ \ \ FLOATNAME(LVector2)\ xy(x[0],\ x[1]);}
\DoxyCodeLine{00133\ \ \ xy\ =\ normalize(xy);}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Z\ (up)\ axis.\ \ This\ is\ yaw,\ or\ "{}heading"{}.}}
\DoxyCodeLine{00136\ \ \ FLOATTYPE\ heading\ =\ rad\_2\_deg(((FLOATTYPE)catan2(xy[1],\ xy[0])));}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \textcolor{comment}{//\ Unwind\ the\ heading,\ and\ continue.}}
\DoxyCodeLine{00139\ \ \ FLOATNAME(LMatrix3)\ rot\_z;}
\DoxyCodeLine{00140\ \ \ rot\_z.set\_rotate\_mat\_normaxis(-\/heading,\ FLOATNAME(LVector3)(0.0f,\ 0.0f,\ 1.0f),}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_zup\_right);}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ x\ =\ x\ *\ rot\_z;}
\DoxyCodeLine{00144\ \ \ y\ =\ y\ *\ rot\_z;}
\DoxyCodeLine{00145\ \ \ z\ =\ z\ *\ rot\_z;}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ Y\ into\ the\ YZ\ plane.}}
\DoxyCodeLine{00148\ \ \ FLOATNAME(LVector2)\ yz(y[1],\ y[2]);}
\DoxyCodeLine{00149\ \ \ yz\ =\ normalize(yz);}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +X\ (right)\ axis.\ \ This\ is\ pitch.}}
\DoxyCodeLine{00152\ \ \ FLOATTYPE\ pitch\ =\ rad\_2\_deg(((FLOATTYPE)catan2(yz[1],\ yz[0])));}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \textcolor{comment}{//\ Unwind\ the\ pitch.}}
\DoxyCodeLine{00155\ \ \ FLOATNAME(LMatrix3)\ rot\_x;}
\DoxyCodeLine{00156\ \ \ rot\_x.set\_rotate\_mat\_normaxis(-\/pitch,\ FLOATNAME(LVector3)(1.0f,\ 0.0f,\ 0.0f),}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CS\_zup\_right);}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ x\ =\ x\ *\ rot\_x;}
\DoxyCodeLine{00160\ \ \ y\ =\ y\ *\ rot\_x;}
\DoxyCodeLine{00161\ \ \ z\ =\ z\ *\ rot\_x;}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ \textcolor{comment}{//\ Reset\ the\ matrix\ to\ reflect\ the\ unwinding.}}
\DoxyCodeLine{00164\ \ \ mat.set\_row(0,\ x);}
\DoxyCodeLine{00165\ \ \ mat.set\_row(1,\ y);}
\DoxyCodeLine{00166\ \ \ mat.set\_row(2,\ z);}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \textcolor{comment}{//\ Return\ the\ three\ rotation\ components.}}
\DoxyCodeLine{00169\ \ \ hpr[0]\ =\ heading;}
\DoxyCodeLine{00170\ \ \ hpr[1]\ =\ pitch;}
\DoxyCodeLine{00171\ \ \ hpr[2]\ =\ roll;}
\DoxyCodeLine{00172\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00180\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{00181\ \mbox{\hyperlink{compose__matrix__src_8cxx_a3b7d21ab923581cf44804fdbbd5debab}{decompose\_matrix\_old\_hpr}}(\textcolor{keyword}{const}\ FLOATNAME(LMatrix3)\ \&mat,}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&scale,}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&shear,}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&hpr,}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CoordinateSystem\ cs)\ \{}
\DoxyCodeLine{00186\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}bool\ decompose\_matrix\_old\_hpr(LMatrix3\ \&,\ LVecBase3\ \&,\ LVecBase3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00187\ \ \ \textcolor{keywordflow}{if}\ (cs\ ==\ CS\_default)\ \{}
\DoxyCodeLine{00188\ \ \ \ \ cs\ =\ get\_default\_coordinate\_system();}
\DoxyCodeLine{00189\ \ \ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{if}\ (linmath\_cat.is\_debug())\ \{}
\DoxyCodeLine{00192\ \ \ \ \ linmath\_cat.debug()}
\DoxyCodeLine{00193\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}decomposing\ "{}}\ <<\ mat\ <<\ \textcolor{stringliteral}{"{}\ via\ cs\ "{}}\ <<\ cs\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00194\ \ \ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \ \ \textcolor{comment}{//\ Extract\ the\ rotation\ and\ scale,\ according\ to\ the\ coordinate\ system\ of}}
\DoxyCodeLine{00197\ \ \ \textcolor{comment}{//\ choice.}}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ FLOATNAME(LMatrix3)\ new\_mat(mat);}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{switch}\ (cs)\ \{}
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_right:}
\DoxyCodeLine{00203\ \ \ \ \ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ unwind\_zup\_rotation\_old\_hpr(new\_mat,\ hpr);}
\DoxyCodeLine{00205\ \ \ \ \ \}}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_right:}
\DoxyCodeLine{00209\ \ \ \ \ \{}
\DoxyCodeLine{00210\ \ \ \ \ \ \ unwind\_yup\_rotation\_old\_hpr(new\_mat,\ hpr);}
\DoxyCodeLine{00211\ \ \ \ \ \}}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_left:}
\DoxyCodeLine{00215\ \ \ \ \ \{}
\DoxyCodeLine{00216\ \ \ \ \ \ \ new\_mat.\_m(0,\ 2)\ =\ -\/new\_mat.\_m(0,\ 2);}
\DoxyCodeLine{00217\ \ \ \ \ \ \ new\_mat.\_m(1,\ 2)\ =\ -\/new\_mat.\_m(1,\ 2);}
\DoxyCodeLine{00218\ \ \ \ \ \ \ new\_mat.\_m(2,\ 0)\ =\ -\/new\_mat.\_m(2,\ 0);}
\DoxyCodeLine{00219\ \ \ \ \ \ \ new\_mat.\_m(2,\ 1)\ =\ -\/new\_mat.\_m(2,\ 1);}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00221\ \textcolor{comment}{\ \ \ \ \ \ \ \ FLOATNAME(LMatrix3)\ lm(mat(0,\ 0),\ mat(0,\ 1),\ -\/mat(0,\ 2),}}
\DoxyCodeLine{00222\ \textcolor{comment}{\ \ \ \ \ \ \ \ mat(1,\ 0),\ mat(1,\ 1),\ -\/mat(1,\ 2),}}
\DoxyCodeLine{00223\ \textcolor{comment}{\ \ \ \ \ \ \ \ -\/mat(2,\ 0),\ -\/mat(2,\ 1),\ mat(2,\ 2));}}
\DoxyCodeLine{00224\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ unwind\_zup\_rotation\_old\_hpr(new\_mat,\ hpr);}
\DoxyCodeLine{00226\ \ \ \ \ \ \ hpr[0]\ =\ -\/hpr[0];}
\DoxyCodeLine{00227\ \ \ \ \ \ \ hpr[2]\ =\ -\/hpr[2];}
\DoxyCodeLine{00228\ \ \ \ \ \}}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_left:}
\DoxyCodeLine{00232\ \ \ \ \ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ new\_mat.\_m(0,\ 2)\ =\ -\/new\_mat.\_m(0,\ 2);}
\DoxyCodeLine{00234\ \ \ \ \ \ \ new\_mat.\_m(1,\ 2)\ =\ -\/new\_mat.\_m(1,\ 2);}
\DoxyCodeLine{00235\ \ \ \ \ \ \ new\_mat.\_m(2,\ 0)\ =\ -\/new\_mat.\_m(2,\ 0);}
\DoxyCodeLine{00236\ \ \ \ \ \ \ new\_mat.\_m(2,\ 1)\ =\ -\/new\_mat.\_m(2,\ 1);}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00238\ \textcolor{comment}{\ \ \ \ \ \ \ \ FLOATNAME(LMatrix3)\ lm(mat(0,\ 0),\ mat(0,\ 1),\ -\/mat(0,\ 2),}}
\DoxyCodeLine{00239\ \textcolor{comment}{\ \ \ \ \ \ \ \ mat(1,\ 0),\ mat(1,\ 1),\ -\/mat(1,\ 2),}}
\DoxyCodeLine{00240\ \textcolor{comment}{\ \ \ \ \ \ \ \ -\/mat(2,\ 0),\ -\/mat(2,\ 1),\ mat(2,\ 2));}}
\DoxyCodeLine{00241\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ unwind\_yup\_rotation\_old\_hpr(new\_mat,\ hpr);}
\DoxyCodeLine{00243\ \ \ \ \ \}}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00247\ \ \ \ \ linmath\_cat.error()}
\DoxyCodeLine{00248\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unexpected\ coordinate\ system:\ "{}}\ <<\ (int)cs\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00250\ \ \ \}}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ \textcolor{keywordflow}{if}\ (linmath\_cat.is\_debug())\ \{}
\DoxyCodeLine{00253\ \ \ \ \ linmath\_cat.debug()}
\DoxyCodeLine{00254\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}after\ unwind,\ mat\ is\ "{}}\ <<\ new\_mat\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00255\ \ \ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ scale.set(new\_mat(0,\ 0),\ new\_mat(1,\ 1),\ new\_mat(2,\ 2));}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \textcolor{comment}{//\ Normalize\ the\ scale\ out\ of\ the\ shear\ components,\ and\ return\ the\ shear.}}
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (scale[0]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00261\ \ \ \ \ new\_mat(0,\ 1)\ /=\ scale[0];}
\DoxyCodeLine{00262\ \ \ \ \ new\_mat(0,\ 2)\ /=\ scale[0];}
\DoxyCodeLine{00263\ \ \ \}}
\DoxyCodeLine{00264\ \ \ \textcolor{keywordflow}{if}\ (scale[1]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00265\ \ \ \ \ new\_mat(1,\ 0)\ /=\ scale[1];}
\DoxyCodeLine{00266\ \ \ \ \ new\_mat(1,\ 2)\ /=\ scale[1];}
\DoxyCodeLine{00267\ \ \ \}}
\DoxyCodeLine{00268\ \ \ \textcolor{keywordflow}{if}\ (scale[2]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00269\ \ \ \ \ new\_mat(2,\ 0)\ /=\ scale[2];}
\DoxyCodeLine{00270\ \ \ \ \ new\_mat(2,\ 1)\ /=\ scale[2];}
\DoxyCodeLine{00271\ \ \ \}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \ \ shear.set(new\_mat(0,\ 1)\ +\ new\_mat(1,\ 0),}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \ \ new\_mat(2,\ 0)\ +\ new\_mat(0,\ 2),}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ new\_mat(2,\ 1)\ +\ new\_mat(1,\ 2));}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00278\ \}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00283\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00284\ \mbox{\hyperlink{compose__matrix__src_8cxx_aa46bdf9de1e1e04a5e2cdd7af6b39c64}{compose\_matrix}}(FLOATNAME(LMatrix3)\ \&mat,}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FLOATNAME(LVecBase3)\ \&scale,}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FLOATNAME(LVecBase3)\ \&shear,}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FLOATNAME(LVecBase3)\ \&hpr,}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CoordinateSystem\ cs)\ \{}
\DoxyCodeLine{00289\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}void\ compose\_matrix(LMatrix3\ \&,\ const\ LVecBase3\ \&,\ const\ LVecBase3\ \&,\ const\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00290\ \ \ mat.set\_scale\_shear\_mat(scale,\ shear,\ cs);}
\DoxyCodeLine{00291\ \ \ \textcolor{keywordflow}{if}\ (!IS\_NEARLY\_ZERO(hpr[2]))\ \{}
\DoxyCodeLine{00292\ \ \ \ \ FLOATNAME(LMatrix3)\ r;}
\DoxyCodeLine{00293\ \ \ \ \ r.set\_rotate\_mat\_normaxis(hpr[2],\ FLOATNAME(LVector3)::forward(cs),\ cs);}
\DoxyCodeLine{00294\ \ \ \ \ mat\ *=\ r;}
\DoxyCodeLine{00295\ \ \ \}}
\DoxyCodeLine{00296\ \ \ \textcolor{keywordflow}{if}\ (!IS\_NEARLY\_ZERO(hpr[1]))\ \{}
\DoxyCodeLine{00297\ \ \ \ \ FLOATNAME(LMatrix3)\ r;}
\DoxyCodeLine{00298\ \ \ \ \ r.set\_rotate\_mat\_normaxis(hpr[1],\ FLOATNAME(LVector3)::right(cs),\ cs);}
\DoxyCodeLine{00299\ \ \ \ \ mat\ *=\ r;}
\DoxyCodeLine{00300\ \ \ \}}
\DoxyCodeLine{00301\ \ \ \textcolor{keywordflow}{if}\ (!IS\_NEARLY\_ZERO(hpr[0]))\ \{}
\DoxyCodeLine{00302\ \ \ \ \ FLOATNAME(LMatrix3)\ r;}
\DoxyCodeLine{00303\ \ \ \ \ r.set\_rotate\_mat\_normaxis(hpr[0],\ FLOATNAME(LVector3)::up(cs),\ cs);}
\DoxyCodeLine{00304\ \ \ \ \ mat\ *=\ r;}
\DoxyCodeLine{00305\ \ \ \}}
\DoxyCodeLine{00306\ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00315\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00316\ unwind\_yup\_rotation(FLOATNAME(LMatrix3)\ \&mat,\ FLOATNAME(LVecBase3)\ \&hpr)\ \{}
\DoxyCodeLine{00317\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}void\ unwind\_yup\_rotation(LMatrix3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00318\ }
\DoxyCodeLine{00319\ \ \ \textcolor{comment}{//\ Extract\ the\ axes\ from\ the\ matrix.}}
\DoxyCodeLine{00320\ \ \ FLOATNAME(LVector3)\ x,\ y,\ z;}
\DoxyCodeLine{00321\ \ \ mat.get\_row(x,0);}
\DoxyCodeLine{00322\ \ \ mat.get\_row(y,1);}
\DoxyCodeLine{00323\ \ \ mat.get\_row(z,2);}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \textcolor{comment}{//\ Project\ Z\ into\ the\ XZ\ plane.}}
\DoxyCodeLine{00326\ \ \ FLOATTYPE\ heading\ =\ 0;}
\DoxyCodeLine{00327\ \ \ FLOATNAME(LVector2)\ xz(z[0],\ z[2]);}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{if}\ (xz.normalize())\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Y\ (up)\ axis.\ \ This\ is\ yaw,\ or\ "{}heading"{}.}}
\DoxyCodeLine{00330\ \ \ \ \ heading\ =\ catan2(xz[0],\ xz[1]);}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ heading,\ and\ continue.}}
\DoxyCodeLine{00333\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_y;}
\DoxyCodeLine{00334\ \ \ \ \ rot\_y.\_m(0,\ 0)\ =\ xz[1];}
\DoxyCodeLine{00335\ \ \ \ \ rot\_y.\_m(0,\ 1)\ =\ 0;}
\DoxyCodeLine{00336\ \ \ \ \ rot\_y.\_m(0,\ 2)\ =\ xz[0];}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \ \ rot\_y.\_m(1,\ 0)\ =\ 0;}
\DoxyCodeLine{00339\ \ \ \ \ rot\_y.\_m(1,\ 1)\ =\ 1;}
\DoxyCodeLine{00340\ \ \ \ \ rot\_y.\_m(1,\ 2)\ =\ 0;}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00342\ \ \ \ \ rot\_y.\_m(2,\ 0)\ =\ -\/xz[0];}
\DoxyCodeLine{00343\ \ \ \ \ rot\_y.\_m(2,\ 1)\ =\ 0;}
\DoxyCodeLine{00344\ \ \ \ \ rot\_y.\_m(2,\ 2)\ =\ xz[1];}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \ \ x\ =\ x\ *\ rot\_y;}
\DoxyCodeLine{00347\ \ \ \ \ y\ =\ y\ *\ rot\_y;}
\DoxyCodeLine{00348\ \ \ \ \ z\ =\ z\ *\ rot\_y;}
\DoxyCodeLine{00349\ \ \ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ Z\ into\ the\ YZ\ plane.}}
\DoxyCodeLine{00352\ \ \ FLOATTYPE\ pitch\ =\ 0;}
\DoxyCodeLine{00353\ \ \ FLOATNAME(LVector2)\ yz(z[1],\ z[2]);}
\DoxyCodeLine{00354\ \ \ \textcolor{keywordflow}{if}\ (yz.normalize())\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +X\ (right)\ axis.\ \ This\ is\ pitch.}}
\DoxyCodeLine{00356\ \ \ \ \ pitch\ =\ -\/catan2(yz[0],\ yz[1]);}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ pitch.}}
\DoxyCodeLine{00359\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_x;}
\DoxyCodeLine{00360\ \ \ \ \ rot\_x.\_m(0,\ 0)\ =\ 1;}
\DoxyCodeLine{00361\ \ \ \ \ rot\_x.\_m(0,\ 1)\ =\ 0;}
\DoxyCodeLine{00362\ \ \ \ \ rot\_x.\_m(0,\ 2)\ =\ 0;}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \ \ \ \ rot\_x.\_m(1,\ 0)\ =\ 0;}
\DoxyCodeLine{00365\ \ \ \ \ rot\_x.\_m(1,\ 1)\ =\ yz[1];}
\DoxyCodeLine{00366\ \ \ \ \ rot\_x.\_m(1,\ 2)\ =\ yz[0];}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \ \ rot\_x.\_m(2,\ 0)\ =\ 0;}
\DoxyCodeLine{00369\ \ \ \ \ rot\_x.\_m(2,\ 1)\ =\ -\/yz[0];}
\DoxyCodeLine{00370\ \ \ \ \ rot\_x.\_m(2,\ 2)\ =\ yz[1];}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ \ \ x\ =\ x\ *\ rot\_x;}
\DoxyCodeLine{00373\ \ \ \ \ y\ =\ y\ *\ rot\_x;}
\DoxyCodeLine{00374\ \ \ \ \ z\ =\ z\ *\ rot\_x;}
\DoxyCodeLine{00375\ \ \ \}}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ X\ onto\ the\ XY\ plane.}}
\DoxyCodeLine{00378\ \ \ FLOATTYPE\ roll\ =\ 0;}
\DoxyCodeLine{00379\ \ \ FLOATNAME(LVector2)\ xy(x[0],\ x[1]);}
\DoxyCodeLine{00380\ \ \ \textcolor{keywordflow}{if}\ (xy.normalize())\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Z\ (back)\ axis.\ \ This\ is\ roll.}}
\DoxyCodeLine{00382\ \ \ \ \ roll\ =\ -\/catan2(xy[1],\ xy[0]);}
\DoxyCodeLine{00383\ }
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ roll\ from\ the\ axes,\ and\ continue.}}
\DoxyCodeLine{00385\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_z;}
\DoxyCodeLine{00386\ \ \ \ \ rot\_z.\_m(0,\ 0)\ =\ xy[0];}
\DoxyCodeLine{00387\ \ \ \ \ rot\_z.\_m(0,\ 1)\ =\ -\/xy[1];}
\DoxyCodeLine{00388\ \ \ \ \ rot\_z.\_m(0,\ 2)\ =\ 0;}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \ \ \ \ rot\_z.\_m(1,\ 0)\ =\ xy[1];}
\DoxyCodeLine{00391\ \ \ \ \ rot\_z.\_m(1,\ 1)\ =\ xy[0];}
\DoxyCodeLine{00392\ \ \ \ \ rot\_z.\_m(1,\ 2)\ =\ 0;}
\DoxyCodeLine{00393\ }
\DoxyCodeLine{00394\ \ \ \ \ rot\_z.\_m(2,\ 0)\ =\ 0;}
\DoxyCodeLine{00395\ \ \ \ \ rot\_z.\_m(2,\ 1)\ =\ 0;}
\DoxyCodeLine{00396\ \ \ \ \ rot\_z.\_m(2,\ 2)\ =\ 1;}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \ \ \ \ x\ =\ x\ *\ rot\_z;}
\DoxyCodeLine{00399\ \ \ \ \ y\ =\ y\ *\ rot\_z;}
\DoxyCodeLine{00400\ \ \ \ \ z\ =\ z\ *\ rot\_z;}
\DoxyCodeLine{00401\ \ \ \}}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00403\ \ \ \textcolor{comment}{//\ Reset\ the\ matrix\ to\ reflect\ the\ unwinding.}}
\DoxyCodeLine{00404\ \ \ mat.set\_row(0,\ x);}
\DoxyCodeLine{00405\ \ \ mat.set\_row(1,\ y);}
\DoxyCodeLine{00406\ \ \ mat.set\_row(2,\ z);}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \textcolor{comment}{//\ Return\ the\ three\ rotation\ components.}}
\DoxyCodeLine{00409\ \ \ hpr[0]\ =\ rad\_2\_deg(heading);}
\DoxyCodeLine{00410\ \ \ hpr[1]\ =\ rad\_2\_deg(pitch);}
\DoxyCodeLine{00411\ \ \ hpr[2]\ =\ rad\_2\_deg(roll);}
\DoxyCodeLine{00412\ \}}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00421\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{00422\ unwind\_zup\_rotation(FLOATNAME(LMatrix3)\ \&mat,\ FLOATNAME(LVecBase3)\ \&hpr)\ \{}
\DoxyCodeLine{00423\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}void\ unwind\_zup\_rotation(LMatrix3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00424\ \ \ \textcolor{comment}{//\ Extract\ the\ axes\ from\ the\ matrix.}}
\DoxyCodeLine{00425\ \ \ FLOATNAME(LVector3)\ x,\ y,\ z;}
\DoxyCodeLine{00426\ \ \ mat.get\_row(x,0);}
\DoxyCodeLine{00427\ \ \ mat.get\_row(y,1);}
\DoxyCodeLine{00428\ \ \ mat.get\_row(z,2);}
\DoxyCodeLine{00429\ }
\DoxyCodeLine{00430\ \ \ \textcolor{comment}{//\ Project\ Y\ into\ the\ XY\ plane.}}
\DoxyCodeLine{00431\ \ \ FLOATTYPE\ heading\ =\ 0;}
\DoxyCodeLine{00432\ \ \ FLOATNAME(LVector2)\ xy(y[0],\ y[1]);}
\DoxyCodeLine{00433\ \ \ \textcolor{keywordflow}{if}\ (xy.normalize())\ \{}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +Z\ (up)\ axis.\ \ This\ is\ yaw,\ or\ "{}heading"{}.}}
\DoxyCodeLine{00435\ \ \ \ \ heading\ =\ -\/catan2(xy[0],\ xy[1]);}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ heading,\ and\ continue.}}
\DoxyCodeLine{00438\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_z;}
\DoxyCodeLine{00439\ \ \ \ \ rot\_z.\_m(0,\ 0)\ =\ xy[1];}
\DoxyCodeLine{00440\ \ \ \ \ rot\_z.\_m(0,\ 1)\ =\ xy[0];}
\DoxyCodeLine{00441\ \ \ \ \ rot\_z.\_m(0,\ 2)\ =\ 0;}
\DoxyCodeLine{00442\ }
\DoxyCodeLine{00443\ \ \ \ \ rot\_z.\_m(1,\ 0)\ =\ -\/xy[0];}
\DoxyCodeLine{00444\ \ \ \ \ rot\_z.\_m(1,\ 1)\ =\ xy[1];}
\DoxyCodeLine{00445\ \ \ \ \ rot\_z.\_m(1,\ 2)\ =\ 0;}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \ \ \ \ rot\_z.\_m(2,\ 0)\ =\ 0;}
\DoxyCodeLine{00448\ \ \ \ \ rot\_z.\_m(2,\ 1)\ =\ 0;}
\DoxyCodeLine{00449\ \ \ \ \ rot\_z.\_m(2,\ 2)\ =\ 1;}
\DoxyCodeLine{00450\ }
\DoxyCodeLine{00451\ \ \ \ \ x\ =\ x\ *\ rot\_z;}
\DoxyCodeLine{00452\ \ \ \ \ y\ =\ y\ *\ rot\_z;}
\DoxyCodeLine{00453\ \ \ \ \ z\ =\ z\ *\ rot\_z;}
\DoxyCodeLine{00454\ \ \ \}}
\DoxyCodeLine{00455\ }
\DoxyCodeLine{00456\ \ \ \textcolor{comment}{//\ Project\ the\ rotated\ Y\ into\ the\ YZ\ plane.}}
\DoxyCodeLine{00457\ \ \ FLOATTYPE\ pitch\ =\ 0;}
\DoxyCodeLine{00458\ \ \ FLOATNAME(LVector2)\ yz(y[1],\ y[2]);}
\DoxyCodeLine{00459\ \ \ \textcolor{keywordflow}{if}\ (yz.normalize())\ \{}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ +X\ (right)\ axis.\ \ This\ is\ pitch.}}
\DoxyCodeLine{00461\ \ \ \ \ pitch\ =\ catan2(yz[1],\ yz[0]);}
\DoxyCodeLine{00462\ }
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ pitch.}}
\DoxyCodeLine{00464\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_x;}
\DoxyCodeLine{00465\ \ \ \ \ rot\_x.\_m(0,\ 0)\ =\ 1;}
\DoxyCodeLine{00466\ \ \ \ \ rot\_x.\_m(0,\ 1)\ =\ 0;}
\DoxyCodeLine{00467\ \ \ \ \ rot\_x.\_m(0,\ 2)\ =\ 0;}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00469\ \ \ \ \ rot\_x.\_m(1,\ 0)\ =\ 0;}
\DoxyCodeLine{00470\ \ \ \ \ rot\_x.\_m(1,\ 1)\ =\ yz[0];}
\DoxyCodeLine{00471\ \ \ \ \ rot\_x.\_m(1,\ 2)\ =\ -\/yz[1];}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \ \ rot\_x.\_m(2,\ 0)\ =\ 0;}
\DoxyCodeLine{00474\ \ \ \ \ rot\_x.\_m(2,\ 1)\ =\ yz[1];}
\DoxyCodeLine{00475\ \ \ \ \ rot\_x.\_m(2,\ 2)\ =\ yz[0];}
\DoxyCodeLine{00476\ }
\DoxyCodeLine{00477\ \ \ \ \ x\ =\ x\ *\ rot\_x;}
\DoxyCodeLine{00478\ \ \ \ \ y\ =\ y\ *\ rot\_x;}
\DoxyCodeLine{00479\ \ \ \ \ z\ =\ z\ *\ rot\_x;}
\DoxyCodeLine{00480\ \ \ \}}
\DoxyCodeLine{00481\ }
\DoxyCodeLine{00482\ \ \ \textcolor{comment}{//\ Project\ X\ into\ the\ XZ\ plane.}}
\DoxyCodeLine{00483\ \ \ FLOATTYPE\ roll\ =\ 0;}
\DoxyCodeLine{00484\ \ \ FLOATNAME(LVector2)\ xz(x[0],\ x[2]);}
\DoxyCodeLine{00485\ \ \ \textcolor{keywordflow}{if}\ (xz.normalize())\ \{}
\DoxyCodeLine{00486\ \ \ \textcolor{comment}{//\ Compute\ the\ rotation\ about\ the\ -\/Y\ (back)\ axis.\ \ This\ is\ roll.}}
\DoxyCodeLine{00487\ \ \ \ \ roll\ =\ -\/catan2(xz[1],\ xz[0]);}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \ \ \ \ \textcolor{comment}{//\ Unwind\ the\ roll\ from\ the\ axes,\ and\ continue.}}
\DoxyCodeLine{00490\ \ \ \ \ FLOATNAME(LMatrix3)\ rot\_y;}
\DoxyCodeLine{00491\ \ \ \ \ rot\_y.\_m(0,\ 0)\ =\ xz[0];}
\DoxyCodeLine{00492\ \ \ \ \ rot\_y.\_m(0,\ 1)\ =\ 0;}
\DoxyCodeLine{00493\ \ \ \ \ rot\_y.\_m(0,\ 2)\ =\ -\/xz[1];}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00495\ \ \ \ \ rot\_y.\_m(1,\ 0)\ =\ 0;}
\DoxyCodeLine{00496\ \ \ \ \ rot\_y.\_m(1,\ 1)\ =\ 1;}
\DoxyCodeLine{00497\ \ \ \ \ rot\_y.\_m(1,\ 2)\ =\ 0;}
\DoxyCodeLine{00498\ }
\DoxyCodeLine{00499\ \ \ \ \ rot\_y.\_m(2,\ 0)\ =\ xz[1];}
\DoxyCodeLine{00500\ \ \ \ \ rot\_y.\_m(2,\ 1)\ =\ 0;}
\DoxyCodeLine{00501\ \ \ \ \ rot\_y.\_m(2,\ 2)\ =\ xz[0];}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ \ \ x\ =\ x\ *\ rot\_y;}
\DoxyCodeLine{00504\ \ \ \ \ y\ =\ y\ *\ rot\_y;}
\DoxyCodeLine{00505\ \ \ \ \ z\ =\ z\ *\ rot\_y;}
\DoxyCodeLine{00506\ \ \ \}}
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \ \ \textcolor{comment}{//\ Reset\ the\ matrix\ to\ reflect\ the\ unwinding.}}
\DoxyCodeLine{00509\ \ \ mat.set\_row(0,\ x);}
\DoxyCodeLine{00510\ \ \ mat.set\_row(1,\ y);}
\DoxyCodeLine{00511\ \ \ mat.set\_row(2,\ z);}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \ \ \textcolor{comment}{//\ Return\ the\ three\ rotation\ components.}}
\DoxyCodeLine{00514\ \ \ hpr[0]\ =\ rad\_2\_deg(heading);}
\DoxyCodeLine{00515\ \ \ hpr[1]\ =\ rad\_2\_deg(pitch);}
\DoxyCodeLine{00516\ \ \ hpr[2]\ =\ rad\_2\_deg(roll);}
\DoxyCodeLine{00517\ \}}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00525\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{00526\ \mbox{\hyperlink{compose__matrix__src_8cxx_a499c787e84555f9a09c93f526b7dbc0d}{decompose\_matrix}}(\textcolor{keyword}{const}\ FLOATNAME(LMatrix3)\ \&mat,}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&scale,}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&shear,}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FLOATNAME(LVecBase3)\ \&hpr,}
\DoxyCodeLine{00530\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CoordinateSystem\ cs)\ \{}
\DoxyCodeLine{00531\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}bool\ decompose\_matrix(LMatrix3\ \&,\ LVecBase3\ \&,\ LVecBase3\ \&,\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00532\ \ \ \textcolor{keywordflow}{if}\ (cs\ ==\ CS\_default)\ \{}
\DoxyCodeLine{00533\ \ \ \ \ cs\ =\ get\_default\_coordinate\_system();}
\DoxyCodeLine{00534\ \ \ \}}
\DoxyCodeLine{00535\ }
\DoxyCodeLine{00536\ \textcolor{preprocessor}{\#ifdef\ \_DEBUG}}
\DoxyCodeLine{00537\ \ \ \textcolor{keywordflow}{if}\ (linmath\_cat.is\_debug())\ \{}
\DoxyCodeLine{00538\ \ \ \ \ linmath\_cat.debug()}
\DoxyCodeLine{00539\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}decomposing\ "{}}\ <<\ mat\ <<\ \textcolor{stringliteral}{"{}\ via\ cs\ "{}}\ <<\ cs\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00540\ \ \ \}}
\DoxyCodeLine{00541\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00542\ }
\DoxyCodeLine{00543\ \ \ \textcolor{comment}{//\ Extract\ the\ rotation\ and\ scale,\ according\ to\ the\ coordinate\ system\ of}}
\DoxyCodeLine{00544\ \ \ \textcolor{comment}{//\ choice.}}
\DoxyCodeLine{00545\ }
\DoxyCodeLine{00546\ \ \ FLOATNAME(LMatrix3)\ new\_mat(mat);}
\DoxyCodeLine{00547\ }
\DoxyCodeLine{00548\ \ \ \textcolor{keywordflow}{switch}\ (cs)\ \{}
\DoxyCodeLine{00549\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_right:}
\DoxyCodeLine{00550\ \ \ \ \ \{}
\DoxyCodeLine{00551\ \ \ \ \ \ \ unwind\_zup\_rotation(new\_mat,\ hpr);}
\DoxyCodeLine{00552\ \ \ \ \ \}}
\DoxyCodeLine{00553\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00554\ }
\DoxyCodeLine{00555\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_right:}
\DoxyCodeLine{00556\ \ \ \ \ \{}
\DoxyCodeLine{00557\ \ \ \ \ \ \ unwind\_yup\_rotation(new\_mat,\ hpr);}
\DoxyCodeLine{00558\ \ \ \ \ \}}
\DoxyCodeLine{00559\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00560\ }
\DoxyCodeLine{00561\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_left:}
\DoxyCodeLine{00562\ \ \ \ \ \{}
\DoxyCodeLine{00563\ \ \ \ \ \ \ new\_mat.\_m(0,\ 2)\ =\ -\/new\_mat.\_m(0,\ 2);}
\DoxyCodeLine{00564\ \ \ \ \ \ \ new\_mat.\_m(1,\ 2)\ =\ -\/new\_mat.\_m(1,\ 2);}
\DoxyCodeLine{00565\ \ \ \ \ \ \ new\_mat.\_m(2,\ 0)\ =\ -\/new\_mat.\_m(2,\ 0);}
\DoxyCodeLine{00566\ \ \ \ \ \ \ new\_mat.\_m(2,\ 1)\ =\ -\/new\_mat.\_m(2,\ 1);}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00568\ \textcolor{comment}{\ \ \ \ \ \ \ \ FLOATNAME(LMatrix3)\ lm(mat(0,\ 0),\ mat(0,\ 1),\ -\/mat(0,\ 2),}}
\DoxyCodeLine{00569\ \textcolor{comment}{\ \ \ \ \ \ \ \ mat(1,\ 0),\ mat(1,\ 1),\ -\/mat(1,\ 2),}}
\DoxyCodeLine{00570\ \textcolor{comment}{\ \ \ \ \ \ \ \ -\/mat(2,\ 0),\ -\/mat(2,\ 1),\ mat(2,\ 2));}}
\DoxyCodeLine{00571\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00572\ \ \ \ \ \ \ unwind\_zup\_rotation(new\_mat,\ hpr);}
\DoxyCodeLine{00573\ \ \ \ \ \ \ hpr[0]\ =\ -\/hpr[0];}
\DoxyCodeLine{00574\ \ \ \ \ \ \ hpr[2]\ =\ -\/hpr[2];}
\DoxyCodeLine{00575\ \ \ \ \ \}}
\DoxyCodeLine{00576\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_left:}
\DoxyCodeLine{00579\ \ \ \ \ \{}
\DoxyCodeLine{00580\ \ \ \ \ \ \ new\_mat.\_m(0,\ 2)\ =\ -\/new\_mat.\_m(0,\ 2);}
\DoxyCodeLine{00581\ \ \ \ \ \ \ new\_mat.\_m(1,\ 2)\ =\ -\/new\_mat.\_m(1,\ 2);}
\DoxyCodeLine{00582\ \ \ \ \ \ \ new\_mat.\_m(2,\ 0)\ =\ -\/new\_mat.\_m(2,\ 0);}
\DoxyCodeLine{00583\ \ \ \ \ \ \ new\_mat.\_m(2,\ 1)\ =\ -\/new\_mat.\_m(2,\ 1);}
\DoxyCodeLine{00584\ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00585\ \textcolor{comment}{\ \ \ \ \ \ \ \ FLOATNAME(LMatrix3)\ lm(mat(0,\ 0),\ mat(0,\ 1),\ -\/mat(0,\ 2),}}
\DoxyCodeLine{00586\ \textcolor{comment}{\ \ \ \ \ \ \ \ mat(1,\ 0),\ mat(1,\ 1),\ -\/mat(1,\ 2),}}
\DoxyCodeLine{00587\ \textcolor{comment}{\ \ \ \ \ \ \ \ -\/mat(2,\ 0),\ -\/mat(2,\ 1),\ mat(2,\ 2));}}
\DoxyCodeLine{00588\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00589\ \ \ \ \ \ \ unwind\_yup\_rotation(new\_mat,\ hpr);}
\DoxyCodeLine{00590\ \ \ \ \ \}}
\DoxyCodeLine{00591\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00594\ \ \ \ \ linmath\_cat.error()}
\DoxyCodeLine{00595\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unexpected\ coordinate\ system:\ "{}}\ <<\ (int)cs\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00596\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00597\ \ \ \}}
\DoxyCodeLine{00598\ }
\DoxyCodeLine{00599\ \textcolor{preprocessor}{\#ifdef\ \_DEBUG}}
\DoxyCodeLine{00600\ \ \ \textcolor{keywordflow}{if}\ (linmath\_cat.is\_debug())\ \{}
\DoxyCodeLine{00601\ \ \ \ \ linmath\_cat.debug()}
\DoxyCodeLine{00602\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}after\ unwind,\ mat\ is\ "{}}\ <<\ new\_mat\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00603\ \ \ \}}
\DoxyCodeLine{00604\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00605\ }
\DoxyCodeLine{00606\ \ \ scale.set(new\_mat(0,\ 0),\ new\_mat(1,\ 1),\ new\_mat(2,\ 2));}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00608\ \ \ \textcolor{comment}{//\ Normalize\ the\ scale\ out\ of\ the\ shear\ components,\ and\ return\ the\ shear.}}
\DoxyCodeLine{00609\ \ \ \textcolor{keywordflow}{if}\ (scale[0]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00610\ \ \ \ \ new\_mat(0,\ 1)\ /=\ scale[0];}
\DoxyCodeLine{00611\ \ \ \ \ new\_mat(0,\ 2)\ /=\ scale[0];}
\DoxyCodeLine{00612\ \ \ \}}
\DoxyCodeLine{00613\ \ \ \textcolor{keywordflow}{if}\ (scale[1]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00614\ \ \ \ \ new\_mat(1,\ 0)\ /=\ scale[1];}
\DoxyCodeLine{00615\ \ \ \ \ new\_mat(1,\ 2)\ /=\ scale[1];}
\DoxyCodeLine{00616\ \ \ \}}
\DoxyCodeLine{00617\ \ \ \textcolor{keywordflow}{if}\ (scale[2]\ !=\ 0.0)\ \{}
\DoxyCodeLine{00618\ \ \ \ \ new\_mat(2,\ 0)\ /=\ scale[2];}
\DoxyCodeLine{00619\ \ \ \ \ new\_mat(2,\ 1)\ /=\ scale[2];}
\DoxyCodeLine{00620\ \ \ \}}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ \ \ shear.set(new\_mat(0,\ 1)\ +\ new\_mat(1,\ 0),}
\DoxyCodeLine{00623\ \ \ \ \ \ \ \ \ \ \ \ \ new\_mat(2,\ 0)\ +\ new\_mat(0,\ 2),}
\DoxyCodeLine{00624\ \ \ \ \ \ \ \ \ \ \ \ \ new\_mat(2,\ 1)\ +\ new\_mat(1,\ 2));}
\DoxyCodeLine{00625\ }
\DoxyCodeLine{00626\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00627\ \}}
\DoxyCodeLine{00628\ }
\DoxyCodeLine{00636\ FLOATNAME(LVecBase3)}
\DoxyCodeLine{00637\ \mbox{\hyperlink{compose__matrix__src_8cxx_a98616986d213790723c720a84f9ec2b2}{old\_to\_new\_hpr}}(const\ FLOATNAME(LVecBase3)\ \&old\_hpr)\ \{}
\DoxyCodeLine{00638\ \ \ TAU\_PROFILE(\textcolor{stringliteral}{"{}LVecBase3\ old\_to\_new\_hpr(const\ LVecBase3\ \&)"{}},\ \textcolor{stringliteral}{"{}\ "{}},\ TAU\_USER);}
\DoxyCodeLine{00639\ \ \ FLOATNAME(LMatrix3)\ mat\ =}
\DoxyCodeLine{00640\ \ \ \ \ FLOATNAME(LMatrix3)::rotate\_mat\_normaxis(old\_hpr[1],\ FLOATNAME(LVector3)::right())\ *}
\DoxyCodeLine{00641\ \ \ \ \ FLOATNAME(LMatrix3)::rotate\_mat\_normaxis(old\_hpr[0],\ FLOATNAME(LVector3)::up())\ *}
\DoxyCodeLine{00642\ \ \ \ \ FLOATNAME(LMatrix3)::rotate\_mat\_normaxis(old\_hpr[2],\ FLOATNAME(LVector3)::back());}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \ \ FLOATNAME(LVecBase3)\ new\_scale;}
\DoxyCodeLine{00645\ \ \ FLOATNAME(LVecBase3)\ new\_shear;}
\DoxyCodeLine{00646\ \ \ FLOATNAME(LVecBase3)\ new\_hpr;}
\DoxyCodeLine{00647\ }
\DoxyCodeLine{00648\ \ \ \mbox{\hyperlink{compose__matrix__src_8cxx_a499c787e84555f9a09c93f526b7dbc0d}{decompose\_matrix}}(mat,\ new\_scale,\ new\_shear,\ new\_hpr);}
\DoxyCodeLine{00649\ \ \ \textcolor{keywordflow}{return}\ new\_hpr;}
\DoxyCodeLine{00650\ \}}

\end{DoxyCode}
