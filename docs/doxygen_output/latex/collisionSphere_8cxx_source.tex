\doxysection{collision\+Sphere.\+cxx}
\hypertarget{collisionSphere_8cxx_source}{}\label{collisionSphere_8cxx_source}\index{panda/src/collide/collisionSphere.cxx@{panda/src/collide/collisionSphere.cxx}}
\mbox{\hyperlink{collisionSphere_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSphere_8h}{collisionSphere.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionLine_8h}{collisionLine.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionRay_8h}{collisionRay.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionHandler_8h}{collisionHandler.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionEntry_8h}{collisionEntry.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSegment_8h}{collisionSegment.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionCapsule_8h}{collisionCapsule.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionParabola_8h}{collisionParabola.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionBox_8h}{collisionBox.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__collide_8h}{config\_collide.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nearly__zero_8h}{nearly\_zero.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cmath_8h}{cmath.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mathNumbers_8h}{mathNumbers.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTristrips_8h}{geomTristrips.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomLinestrips_8h}{geomLinestrips.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{billboardEffect_8h}{billboardEffect.h}}"{}}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00039\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionSphere::\_volume\_pcollector(}
\DoxyCodeLine{00042\ \ \ \textcolor{stringliteral}{"{}Collision\ Volumes:CollisionSphere"{}});}
\DoxyCodeLine{00043\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionSphere::\_test\_pcollector(}
\DoxyCodeLine{00044\ \ \ \textcolor{stringliteral}{"{}Collision\ Tests:CollisionSphere"{}});}
\DoxyCodeLine{00045\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CollisionSphere::\_type\_handle;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00050\ \mbox{\hyperlink{classCollisionSolid}{CollisionSolid}}\ *CollisionSphere::}
\DoxyCodeLine{00051\ make\_copy()\ \{}
\DoxyCodeLine{00052\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00053\ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00058\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00059\ test\_intersection(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00060\ \ \ \textcolor{keywordflow}{return}\ entry.get\_into()-\/>test\_intersection\_from\_sphere(entry);}
\DoxyCodeLine{00061\ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00066\ \textcolor{keywordtype}{void}\ CollisionSphere::}
\DoxyCodeLine{00067\ xform(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\ \{}
\DoxyCodeLine{00068\ \ \ \_center\ =\ \_center\ *\ mat;}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{comment}{//\ This\ is\ a\ little\ cheesy\ and\ fails\ miserably\ in\ the\ presence\ of\ a\ non-\/}}
\DoxyCodeLine{00071\ \ \ \textcolor{comment}{//\ uniform\ scale.}}
\DoxyCodeLine{00072\ \ \ LVector3\ radius\_v\ =\ LVector3(\_radius,\ 0.0f,\ 0.0f)\ *\ mat;}
\DoxyCodeLine{00073\ \ \ \_radius\ =\ length(radius\_v);}
\DoxyCodeLine{00074\ \ \ mark\_viz\_stale();}
\DoxyCodeLine{00075\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00076\ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00083\ LPoint3\ CollisionSphere::}
\DoxyCodeLine{00084\ get\_collision\_origin()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00085\ \ \ \textcolor{keywordflow}{return}\ get\_center();}
\DoxyCodeLine{00086\ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00092\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionSphere_ab5c18fdcf52c33414ff3c5e82bd1308d}{CollisionSphere::}}}
\DoxyCodeLine{00093\ \mbox{\hyperlink{classCollisionSphere_ab5c18fdcf52c33414ff3c5e82bd1308d}{get\_volume\_pcollector}}()\ \{}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{return}\ \_volume\_pcollector;}
\DoxyCodeLine{00095\ \}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00101\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionSphere_afdde67db138ebaa4a0af26a0bc862d23}{CollisionSphere::}}}
\DoxyCodeLine{00102\ \mbox{\hyperlink{classCollisionSphere_afdde67db138ebaa4a0af26a0bc862d23}{get\_test\_pcollector}}()\ \{}
\DoxyCodeLine{00103\ \ \ \textcolor{keywordflow}{return}\ \_test\_pcollector;}
\DoxyCodeLine{00104\ \}}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00109\ \textcolor{keywordtype}{void}\ CollisionSphere::}
\DoxyCodeLine{00110\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00111\ \ \ out\ <<\ \textcolor{stringliteral}{"{}sphere,\ c\ ("{}}\ <<\ get\_center()\ <<\ \textcolor{stringliteral}{"{}),\ r\ "{}}\ <<\ get\_radius();}
\DoxyCodeLine{00112\ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00117\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ CollisionSphere::}
\DoxyCodeLine{00118\ compute\_internal\_bounds()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00119\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}(\_center,\ \_radius);}
\DoxyCodeLine{00120\ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00125\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00126\ test\_intersection\_from\_sphere(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00127\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}\ *sphere;}
\DoxyCodeLine{00128\ \ \ DCAST\_INTO\_R(sphere,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_space\ =\ entry.get\_wrt\_space();}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ wrt\_space-\/>get\_mat();}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ LPoint3\ from\_b\ =\ sphere-\/>get\_center()\ *\ wrt\_mat;}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ LPoint3\ into\_center(get\_center());}
\DoxyCodeLine{00137\ \ \ PN\_stdfloat\ into\_radius(get\_radius());}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00140\ \ \ \ \ LVector3(sphere-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00141\ \ \ PN\_stdfloat\ from\_radius\ =\ length(from\_radius\_v);}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ LPoint3\ into\_intersection\_point(from\_b);}
\DoxyCodeLine{00144\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00145\ \ \ LPoint3\ contact\_point(into\_intersection\_point);}
\DoxyCodeLine{00146\ \ \ PN\_stdfloat\ actual\_t\ =\ 0.0f;}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ LPoint3\ from\_a\ =\ from\_b;}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{if}\ (entry.get\_respect\_prev\_transform())\ \{}
\DoxyCodeLine{00150\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_prev\_space\ =\ entry.get\_wrt\_prev\_space();}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{if}\ (wrt\_prev\_space\ !=\ wrt\_space)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ from\_a\ =\ sphere-\/>get\_center()\ *\ wrt\_prev\_space-\/>get\_mat();}
\DoxyCodeLine{00153\ \ \ \ \ \}}
\DoxyCodeLine{00154\ \ \ \}}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \textcolor{keywordflow}{if}\ (from\_a.almost\_equal(from\_b))\ \{}
\DoxyCodeLine{00157\ \ \ \ \ LVector3\ vec\ =\ from\_b\ -\/\ into\_center;}
\DoxyCodeLine{00158\ \ \ \ \ PN\_stdfloat\ dist2\ =\ dot(vec,\ vec);}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordflow}{if}\ (dist2\ >\ (into\_radius\ +\ from\_radius)\ *\ (into\_radius\ +\ from\_radius))\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ intersection\ with\ the\ current\ position.}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00165\ \ \ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_a,\ from\_direction,\ from\_radius))\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00169\ \ \ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0\ ||\ t1\ >\ 1.0)\ \{}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ segment\ or}}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \textcolor{comment}{//\ after\ the\ end\ of\ the\ segment.}}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00175\ \ \ \ \ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{comment}{//\ doubles,\ not\ floats,\ to\ satisfy\ min\ and\ max\ templates.}}
\DoxyCodeLine{00178\ \ \ \ \ actual\_t\ =\ min(1.0,\ max(0.0,\ t1));}
\DoxyCodeLine{00179\ \ \ \ \ contact\_point\ =\ from\_a\ +\ actual\_t\ *\ (from\_b\ -\/\ from\_a);}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordflow}{if}\ (t1\ <\ 0.0)\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ within\ the\ sphere.\ \ The\ first\ intersection\ point\ is}}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \textcolor{comment}{//\ point\ a\ itself.}}
\DoxyCodeLine{00184\ \ \ \ \ \ \ into\_intersection\_point\ =\ from\_a;}
\DoxyCodeLine{00185\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ outside\ the\ sphere,\ and\ point\ b\ is\ either\ inside\ the}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \textcolor{comment}{//\ sphere\ or\ beyond\ it.\ \ The\ first\ intersection\ point\ is\ at\ t1.}}
\DoxyCodeLine{00188\ \ \ \ \ \ \ into\_intersection\_point\ =\ from\_a\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00189\ \ \ \ \ \}}
\DoxyCodeLine{00190\ \ \ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00193\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00194\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00195\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00196\ \ \ \}}
\DoxyCodeLine{00197\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ LPoint3\ from\_center\ =\ sphere-\/>get\_center()\ *\ wrt\_mat;}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ LVector3\ surface\_normal;}
\DoxyCodeLine{00202\ \ \ LVector3\ v(into\_intersection\_point\ -\/\ into\_center);}
\DoxyCodeLine{00203\ \ \ PN\_stdfloat\ vec\_length\ =\ v.length();}
\DoxyCodeLine{00204\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(vec\_length))\ \{}
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ collision\ normal\ (e.g.\ \ the\ centers\ are\ exactly}}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{comment}{//\ coincident),\ then\ make\ up\ an\ arbitrary\ normal-\/-\/any\ one\ is\ as\ good\ as}}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{comment}{//\ any\ other.}}
\DoxyCodeLine{00208\ \ \ \ \ surface\_normal.set(1.0,\ 0.0,\ 0.0);}
\DoxyCodeLine{00209\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00210\ \ \ \ \ surface\_normal\ =\ v\ /\ vec\_length;}
\DoxyCodeLine{00211\ \ \ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ LVector3\ eff\_normal\ =\ (has\_effective\_normal()\ \&\&\ sphere-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ surface\_normal;}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ LVector3\ contact\_normal;}
\DoxyCodeLine{00216\ \ \ LVector3\ v2\ =\ contact\_point\ -\/\ into\_center;}
\DoxyCodeLine{00217\ \ \ PN\_stdfloat\ v2\_len\ =\ v2.length();}
\DoxyCodeLine{00218\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(v2\_len))\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ collision\ normal\ (e.g.\ \ the\ centers\ are\ exactly}}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{comment}{//\ coincident),\ then\ make\ up\ an\ arbitrary\ normal-\/-\/any\ one\ is\ as\ good\ as}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{//\ any\ other.}}
\DoxyCodeLine{00222\ \ \ \ \ contact\_normal.set(1.0,\ 0.0,\ 0.0);}
\DoxyCodeLine{00223\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00224\ \ \ \ \ contact\_normal\ =\ v2\ /\ v2\_len;}
\DoxyCodeLine{00225\ \ \ \}}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ new\_entry-\/>set\_surface\_normal(eff\_normal);}
\DoxyCodeLine{00228\ \ \ new\_entry-\/>set\_surface\_point(into\_center\ +\ surface\_normal\ *\ into\_radius);}
\DoxyCodeLine{00229\ \ \ new\_entry-\/>set\_interior\_point(from\_center\ -\/\ surface\_normal\ *\ from\_radius);}
\DoxyCodeLine{00230\ \ \ new\_entry-\/>set\_contact\_pos(contact\_point);}
\DoxyCodeLine{00231\ \ \ new\_entry-\/>set\_contact\_normal(contact\_normal);}
\DoxyCodeLine{00232\ \ \ new\_entry-\/>set\_t(actual\_t);}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00235\ \}}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00240\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00241\ test\_intersection\_from\_line(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00242\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionLine}{CollisionLine}}\ *line;}
\DoxyCodeLine{00243\ \ \ DCAST\_INTO\_R(line,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \ \ LPoint3\ from\_origin\ =\ line-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00248\ \ \ LVector3\ from\_direction\ =\ line-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00251\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00253\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00254\ \ \ \}}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00257\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00258\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00259\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00260\ \ \ \}}
\DoxyCodeLine{00261\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_origin\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00264\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ line-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00267\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00268\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00269\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00270\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00271\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00272\ \ \ \}}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00275\ \}}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00280\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00281\ test\_intersection\_from\_box(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00282\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionBox}{CollisionBox}}\ *box;}
\DoxyCodeLine{00283\ \ \ DCAST\_INTO\_R(box,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00284\ }
\DoxyCodeLine{00285\ \ \ \textcolor{comment}{//\ Instead\ of\ transforming\ the\ box\ into\ the\ sphere's\ coordinate\ space,\ we\ do}}
\DoxyCodeLine{00286\ \ \ \textcolor{comment}{//\ it\ the\ other\ way\ around.\ \ It's\ easier\ that\ way.}}
\DoxyCodeLine{00287\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_inv\_wrt\_mat();}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ LPoint3\ center\ =\ wrt\_mat.xform\_point(\_center);}
\DoxyCodeLine{00290\ \ \ PN\_stdfloat\ radius\_sq\ =\ wrt\_mat.xform\_vec(LVector3(0,\ 0,\ \_radius)).length\_squared();}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ LPoint3\ box\_min\ =\ box-\/>get\_min();}
\DoxyCodeLine{00293\ \ \ LPoint3\ box\_max\ =\ box-\/>get\_max();}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ \ \ \textcolor{comment}{//\ Arvo's\ algorithm.}}
\DoxyCodeLine{00296\ \ \ PN\_stdfloat\ d\ =\ 0;}
\DoxyCodeLine{00297\ \ \ PN\_stdfloat\ s;}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00299\ \ \ \textcolor{keywordflow}{if}\ (center[0]\ <\ box\_min[0])\ \{}
\DoxyCodeLine{00300\ \ \ \ \ s\ =\ center[0]\ -\/\ box\_min[0];}
\DoxyCodeLine{00301\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00303\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (center[0]\ >\ box\_max[0])\ \{}
\DoxyCodeLine{00304\ \ \ \ \ s\ =\ center[0]\ -\/\ box\_max[0];}
\DoxyCodeLine{00305\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00306\ \ \ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \ \ \textcolor{keywordflow}{if}\ (center[1]\ <\ box\_min[1])\ \{}
\DoxyCodeLine{00309\ \ \ \ \ s\ =\ center[1]\ -\/\ box\_min[1];}
\DoxyCodeLine{00310\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00312\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (center[1]\ >\ box\_max[1])\ \{}
\DoxyCodeLine{00313\ \ \ \ \ s\ =\ center[1]\ -\/\ box\_max[1];}
\DoxyCodeLine{00314\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00315\ \ \ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \textcolor{keywordflow}{if}\ (center[2]\ <\ box\_min[2])\ \{}
\DoxyCodeLine{00318\ \ \ \ \ s\ =\ center[2]\ -\/\ box\_min[2];}
\DoxyCodeLine{00319\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (center[2]\ >\ box\_max[2])\ \{}
\DoxyCodeLine{00322\ \ \ \ \ s\ =\ center[2]\ -\/\ box\_max[2];}
\DoxyCodeLine{00323\ \ \ \ \ d\ +=\ s\ *\ s;}
\DoxyCodeLine{00324\ \ \ \}}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \textcolor{keywordflow}{if}\ (d\ >\ radius\_sq)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00328\ \ \ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00331\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00332\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00333\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00334\ \ \ \}}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \textcolor{comment}{//\ To\ get\ the\ interior\ point,\ clamp\ the\ sphere\ center\ to\ the\ AABB.}}
\DoxyCodeLine{00339\ \ \ LPoint3\ interior\ =\ entry.get\_wrt\_mat().xform\_point(center.fmax(box\_min).fmin(box\_max));}
\DoxyCodeLine{00340\ \ \ new\_entry-\/>set\_interior\_point(interior);}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00342\ \ \ \textcolor{comment}{//\ Now\ extrapolate\ the\ surface\ point\ and\ normal\ from\ that.}}
\DoxyCodeLine{00343\ \ \ LVector3\ normal\ =\ interior\ -\/\ \_center;}
\DoxyCodeLine{00344\ \ \ normal.normalize();}
\DoxyCodeLine{00345\ \ \ new\_entry-\/>set\_surface\_point(\_center\ +\ normal\ *\ \_radius);}
\DoxyCodeLine{00346\ \ \ new\_entry-\/>set\_surface\_normal(}
\DoxyCodeLine{00347\ \ \ \ \ (has\_effective\_normal()\ \&\&\ box-\/>get\_respect\_effective\_normal())}
\DoxyCodeLine{00348\ \ \ \ \ ?\ get\_effective\_normal()\ :\ normal);}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00350\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00351\ \}}
\DoxyCodeLine{00352\ }
\DoxyCodeLine{00356\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00357\ test\_intersection\_from\_ray(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00358\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionRay}{CollisionRay}}\ *ray;}
\DoxyCodeLine{00359\ \ \ DCAST\_INTO\_R(ray,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ LPoint3\ from\_origin\ =\ ray-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00364\ \ \ LVector3\ from\_direction\ =\ ray-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00367\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00369\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00370\ \ \ \}}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0)\ \{}
\DoxyCodeLine{00373\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ ray.}}
\DoxyCodeLine{00374\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00375\ \ \ \}}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ \ \ t1\ =\ max(t1,\ 0.0);}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00379\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00380\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00381\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00382\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00383\ \ \ \}}
\DoxyCodeLine{00384\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00385\ }
\DoxyCodeLine{00386\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_origin\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00387\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00389\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ ray-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00390\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00391\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00392\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00393\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00394\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00395\ \ \ \}}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00398\ \}}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00403\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00404\ test\_intersection\_from\_segment(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00405\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSegment}{CollisionSegment}}\ *segment;}
\DoxyCodeLine{00406\ \ \ DCAST\_INTO\_R(segment,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \ \ LPoint3\ from\_a\ =\ segment-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00411\ \ \ LPoint3\ from\_b\ =\ segment-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00412\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00414\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00415\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_a,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00417\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00418\ \ \ \}}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0\ ||\ t1\ >\ 1.0)\ \{}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ segment\ or\ after}}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{comment}{//\ the\ end\ of\ the\ segment.}}
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00424\ \ \ \}}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ t1\ =\ max(t1,\ 0.0);}
\DoxyCodeLine{00427\ }
\DoxyCodeLine{00428\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00429\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00430\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00431\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00432\ \ \ \}}
\DoxyCodeLine{00433\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_a\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00436\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ segment-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00439\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00440\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00441\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00442\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00443\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00444\ \ \ \}}
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00446\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00447\ \}}
\DoxyCodeLine{00448\ }
\DoxyCodeLine{00452\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00453\ test\_intersection\_from\_capsule(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00454\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}\ *capsule;}
\DoxyCodeLine{00455\ \ \ DCAST\_INTO\_R(capsule,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \ \ LPoint3\ from\_a\ =\ capsule-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00460\ \ \ LPoint3\ from\_b\ =\ capsule-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00461\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00462\ }
\DoxyCodeLine{00463\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00464\ \ \ \ \ LVector3(capsule-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00465\ \ \ PN\_stdfloat\ from\_radius\ =\ length(from\_radius\_v);}
\DoxyCodeLine{00466\ }
\DoxyCodeLine{00467\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00468\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_a,\ from\_direction,\ from\_radius))\ \{}
\DoxyCodeLine{00469\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00471\ \ \ \}}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0\ ||\ t1\ >\ 1.0)\ \{}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ capsule\ or\ after}}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{comment}{//\ the\ end\ of\ the\ capsule.}}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00477\ \ \ \}}
\DoxyCodeLine{00478\ }
\DoxyCodeLine{00479\ \ \ PN\_stdfloat\ t\ =\ (t1\ +\ t2)\ *\ (PN\_stdfloat)0.5;}
\DoxyCodeLine{00480\ \ \ t\ =\ max(t,\ (PN\_stdfloat)0.0);}
\DoxyCodeLine{00481\ \ \ t\ =\ min(t,\ (PN\_stdfloat)1.0);}
\DoxyCodeLine{00482\ \ \ LPoint3\ inner\_point\ =\ from\_a\ +\ t\ *\ from\_direction;}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00485\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00486\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00487\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00488\ \ \ \}}
\DoxyCodeLine{00489\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00490\ }
\DoxyCodeLine{00491\ \ \ LVector3\ normal\ =\ inner\_point\ -\/\ get\_center();}
\DoxyCodeLine{00492\ \ \ normal.normalize();}
\DoxyCodeLine{00493\ \ \ new\_entry-\/>set\_surface\_point(get\_center()\ +\ normal\ *\ get\_radius());}
\DoxyCodeLine{00494\ \ \ new\_entry-\/>set\_interior\_point(inner\_point\ -\/\ normal\ *\ from\_radius);}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00496\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ capsule-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00497\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00498\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00499\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00500\ \ \ \}}
\DoxyCodeLine{00501\ }
\DoxyCodeLine{00502\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00503\ \}}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00508\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionSphere::}
\DoxyCodeLine{00509\ test\_intersection\_from\_parabola(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00510\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionParabola}{CollisionParabola}}\ *parabola;}
\DoxyCodeLine{00511\ \ \ DCAST\_INTO\_R(parabola,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ \textcolor{comment}{//\ Convert\ the\ parabola\ into\ local\ coordinate\ space.}}
\DoxyCodeLine{00516\ \ \ LParabola\ local\_p(parabola-\/>get\_parabola());}
\DoxyCodeLine{00517\ \ \ local\_p.xform(wrt\_mat);}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \ \ \textcolor{keywordtype}{double}\ t;}
\DoxyCodeLine{00520\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_a13501a1cb80a50c35366faaa179b37a6}{intersects\_parabola}}(t,\ local\_p,\ parabola-\/>get\_t1(),\ parabola-\/>get\_t2(),}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t1()),}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t2())))\ \{}
\DoxyCodeLine{00523\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00524\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00525\ \ \ \}}
\DoxyCodeLine{00526\ }
\DoxyCodeLine{00527\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00528\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00529\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00530\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00531\ \ \ \}}
\DoxyCodeLine{00532\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \ \ LPoint3\ into\_intersection\_point\ =\ local\_p.calc\_point(t);}
\DoxyCodeLine{00535\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00536\ }
\DoxyCodeLine{00537\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ parabola-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00538\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00539\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00540\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00541\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00542\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00543\ \ \ \}}
\DoxyCodeLine{00544\ }
\DoxyCodeLine{00545\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00546\ \}}
\DoxyCodeLine{00547\ }
\DoxyCodeLine{00552\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionSphere_ae2d87a2375ebc6a00da07b39920b7e38}{CollisionSphere::}}}
\DoxyCodeLine{00553\ \mbox{\hyperlink{classCollisionSphere_ae2d87a2375ebc6a00da07b39920b7e38}{fill\_viz\_geom}}()\ \{}
\DoxyCodeLine{00554\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00555\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00556\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Recomputing\ viz\ for\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00557\ \ \ \}}
\DoxyCodeLine{00558\ }
\DoxyCodeLine{00559\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_slices\ =\ 16;}
\DoxyCodeLine{00560\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_stacks\ =\ 24;}
\DoxyCodeLine{00561\ }
\DoxyCodeLine{00562\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00565\ \ \ \ \ (\textcolor{stringliteral}{"{}collision"{}},\ GeomVertexFormat::get\_v3(),\ Geom::UH\_static);}
\DoxyCodeLine{00566\ \ \ vdata-\/>unclean\_set\_num\_rows(num\_slices\ *\ num\_stacks\ *\ 2);}
\DoxyCodeLine{00567\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00568\ }
\DoxyCodeLine{00569\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_static);}
\DoxyCodeLine{00570\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ sl\ =\ 0;\ sl\ <\ num\_slices;\ ++sl)\ \{}
\DoxyCodeLine{00571\ \ \ \ \ PN\_stdfloat\ longitude0\ =\ (PN\_stdfloat)sl\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00572\ \ \ \ \ PN\_stdfloat\ longitude1\ =\ (PN\_stdfloat)(sl\ +\ 1)\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00573\ \ \ \ \ vertex.set\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(0.0,\ longitude0));}
\DoxyCodeLine{00574\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ st\ =\ 1;\ st\ <\ num\_stacks;\ ++st)\ \{}
\DoxyCodeLine{00575\ \ \ \ \ \ \ PN\_stdfloat\ latitude\ =\ (PN\_stdfloat)st\ /\ (PN\_stdfloat)num\_stacks;}
\DoxyCodeLine{00576\ \ \ \ \ \ \ vertex.set\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(latitude,\ longitude0));}
\DoxyCodeLine{00577\ \ \ \ \ \ \ vertex.set\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(latitude,\ longitude1));}
\DoxyCodeLine{00578\ \ \ \ \ \}}
\DoxyCodeLine{00579\ \ \ \ \ vertex.set\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(1.0,\ longitude0));}
\DoxyCodeLine{00580\ }
\DoxyCodeLine{00581\ \ \ \ \ strip-\/>add\_next\_vertices(num\_stacks\ *\ 2);}
\DoxyCodeLine{00582\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00583\ \ \ \}}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \ \ \textcolor{comment}{//\ Also\ create\ a\ ring\ around\ the\ outer\ edge.}}
\DoxyCodeLine{00586\ \ \ PT(\mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}})\ ring\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomLinestrips}{GeomLinestrips}}(Geom::UH\_static);}
\DoxyCodeLine{00587\ \ \ ring-\/>set\_index\_type(GeomEnums::NT\_uint16);}
\DoxyCodeLine{00588\ \ \ \{}
\DoxyCodeLine{00589\ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayDataHandle}{GeomVertexArrayDataHandle}})\ handle\ =\ ring-\/>modify\_vertices\_handle(current\_thread);}
\DoxyCodeLine{00590\ \ \ \ \ handle-\/>unclean\_set\_num\_rows(num\_stacks\ *\ 2\ +\ 1);}
\DoxyCodeLine{00591\ \ \ \ \ uint16\_t\ *ptr\ =\ (uint16\_t\ *)handle-\/>get\_write\_pointer();}
\DoxyCodeLine{00592\ \ \ \ \ *ptr++\ =\ 0;}
\DoxyCodeLine{00593\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stacks;\ ++i)\ \{}
\DoxyCodeLine{00594\ \ \ \ \ \ \ *ptr++\ =\ i\ *\ 2\ +\ 1;}
\DoxyCodeLine{00595\ \ \ \ \ \}}
\DoxyCodeLine{00596\ \ \ \ \ \textcolor{keywordtype}{int}\ offset\ =\ num\_slices\ *\ num\_stacks;}
\DoxyCodeLine{00597\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ num\_stacks\ -\/\ 1;\ i\ >\ 0;\ -\/-\/i)\ \{}
\DoxyCodeLine{00598\ \ \ \ \ \ \ *ptr++\ =\ offset\ +\ i\ *\ 2\ -\/\ 1;}
\DoxyCodeLine{00599\ \ \ \ \ \}}
\DoxyCodeLine{00600\ \ \ \ \ *ptr++\ =\ offset;}
\DoxyCodeLine{00601\ \ \ \}}
\DoxyCodeLine{00602\ \ \ ring-\/>close\_primitive();}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00605\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00606\ }
\DoxyCodeLine{00607\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ ring\_geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00608\ \ \ ring\_geom-\/>add\_primitive(ring);}
\DoxyCodeLine{00609\ }
\DoxyCodeLine{00610\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ transform\ =\ TransformState::make\_pos(get\_center());}
\DoxyCodeLine{00611\ }
\DoxyCodeLine{00612\ \ \ \_viz\_geom-\/>add\_geom(geom,\ get\_solid\_viz\_state());}
\DoxyCodeLine{00613\ \ \ \_viz\_geom-\/>add\_geom(ring\_geom,\ get\_wireframe\_viz\_state());}
\DoxyCodeLine{00614\ \ \ \_viz\_geom-\/>set\_transform(transform);}
\DoxyCodeLine{00615\ \ \ \_viz\_geom-\/>set\_effect(BillboardEffect::make\_point\_eye());}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \ \ \_bounds\_viz\_geom-\/>add\_geom(geom,\ get\_solid\_bounds\_viz\_state());}
\DoxyCodeLine{00618\ \ \ \_bounds\_viz\_geom-\/>add\_geom(ring\_geom,\ get\_wireframe\_bounds\_viz\_state());}
\DoxyCodeLine{00619\ \ \ \_bounds\_viz\_geom-\/>set\_transform(transform);}
\DoxyCodeLine{00620\ \ \ \_bounds\_viz\_geom-\/>set\_effect(BillboardEffect::make\_point\_eye());}
\DoxyCodeLine{00621\ \}}
\DoxyCodeLine{00622\ }
\DoxyCodeLine{00631\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{CollisionSphere::}}}
\DoxyCodeLine{00632\ \mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(\textcolor{keywordtype}{double}\ \&t1,\ \textcolor{keywordtype}{double}\ \&t2,}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&from,\ \textcolor{keyword}{const}\ LVector3\ \&delta,}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ inflate\_radius)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00635\ \ \ \textcolor{comment}{//\ Solve\ the\ equation\ for\ the\ intersection\ of\ a\ line\ with\ a\ sphere\ using\ the}}
\DoxyCodeLine{00636\ \ \ \textcolor{comment}{//\ quadratic\ equation.}}
\DoxyCodeLine{00637\ }
\DoxyCodeLine{00638\ \ \ \textcolor{comment}{//\ A\ line\ segment\ from\ f\ to\ f+d\ is\ defined\ as\ all\ P\ such\ that\ P\ =\ f\ +\ td\ for}}
\DoxyCodeLine{00639\ \ \ \textcolor{comment}{//\ 0\ <=\ t\ <=\ 1.}}
\DoxyCodeLine{00640\ }
\DoxyCodeLine{00641\ \ \ \textcolor{comment}{//\ A\ sphere\ with\ radius\ r\ about\ point\ c\ is\ defined\ as\ all\ P\ such\ that\ r\string^2\ =}}
\DoxyCodeLine{00642\ \ \ \textcolor{comment}{//\ (P\ -\/\ c)\string^2.}}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \ \ \textcolor{comment}{//\ Substituting\ P\ in\ the\ above\ we\ have:}}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00646\ \ \ \textcolor{comment}{//\ r\string^2\ =\ (f\ +\ td\ -\/\ c)\string^2\ =\ (f\string^2\ +\ ftd\ -\/\ fc\ +\ ftd\ +\ t\string^2d\string^2\ -\/\ tdc\ -\/\ fc\ -\/\ tdc\ +}}
\DoxyCodeLine{00647\ \ \ \textcolor{comment}{//\ c\string^2)\ =\ t\string^2(d\string^2)\ +\ t(fd\ +\ fd\ -\/\ dc\ -\/\ dc)\ +\ (f\string^2\ -\/\ fc\ -\/\ fc\ +\ c\string^2)\ =\ t\string^2(d\string^2)}}
\DoxyCodeLine{00648\ \ \ \textcolor{comment}{//\ +\ t(2d(f\ -\/\ c))\ +\ (f\ -\/\ c)\string^2}}
\DoxyCodeLine{00649\ }
\DoxyCodeLine{00650\ \ \ \textcolor{comment}{//\ Thus,\ the\ equation\ is\ quadratic\ in\ t,\ and\ we\ have\ at\string^2\ +\ bt\ +\ c\ =\ 0}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ \textcolor{comment}{//\ Where\ \ a\ =\ d\string^2\ b\ =\ 2d(f\ -\/\ c)\ c\ =\ (f\ -\/\ c)\string^2\ -\/\ r\string^2}}
\DoxyCodeLine{00653\ }
\DoxyCodeLine{00654\ \ \ \textcolor{comment}{//\ Solving\ for\ t\ using\ the\ quadratic\ equation\ gives\ us\ the\ point\ of}}
\DoxyCodeLine{00655\ \ \ \textcolor{comment}{//\ intersection\ along\ the\ line\ segment.\ \ Actually,\ there\ are\ two\ solutions}}
\DoxyCodeLine{00656\ \ \ \textcolor{comment}{//\ (since\ it\ is\ quadratic):\ one\ for\ the\ front\ of\ the\ sphere,\ and\ one\ for\ the}}
\DoxyCodeLine{00657\ \ \ \textcolor{comment}{//\ back.\ \ In\ the\ case\ where\ the\ line\ is\ tangent\ to\ the\ sphere,\ there\ is\ only}}
\DoxyCodeLine{00658\ \ \ \textcolor{comment}{//\ one\ solution\ (and\ the\ radical\ is\ zero).}}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \textcolor{keywordtype}{double}\ A\ =\ dot(delta,\ delta);}
\DoxyCodeLine{00661\ }
\DoxyCodeLine{00662\ \ \ LVector3\ fc\ =\ from\ -\/\ get\_center();}
\DoxyCodeLine{00663\ \ \ \textcolor{keywordtype}{double}\ fc\_d2\ =\ dot(fc,\ fc);}
\DoxyCodeLine{00664\ \ \ \textcolor{keywordtype}{double}\ radius\ =\ get\_radius()\ +\ inflate\_radius;}
\DoxyCodeLine{00665\ \ \ \textcolor{keywordtype}{double}\ C\ =\ fc\_d2\ -\/\ radius\ *\ radius;}
\DoxyCodeLine{00666\ }
\DoxyCodeLine{00667\ \ \ \textcolor{keywordflow}{if}\ (A\ ==\ 0.0)\ \{}
\DoxyCodeLine{00668\ \ \ \ \ \textcolor{comment}{//\ Degenerate\ case\ where\ delta\ is\ zero.\ \ This\ is\ effectively\ a\ test}}
\DoxyCodeLine{00669\ \ \ \ \ \textcolor{comment}{//\ against\ a\ point\ (or\ sphere,\ for\ nonzero\ inflate\_radius).}}
\DoxyCodeLine{00670\ \ \ \ \ t1\ =\ 0.0;}
\DoxyCodeLine{00671\ \ \ \ \ t2\ =\ 0.0;}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{keywordflow}{return}\ C\ <\ 0.0;}
\DoxyCodeLine{00673\ \ \ \}}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ \ \ \textcolor{keywordtype}{double}\ B\ =\ 2.0f\ *\ dot(delta,\ fc);}
\DoxyCodeLine{00676\ \ \ \textcolor{keywordtype}{double}\ radical\ =\ B*B\ -\/\ 4.0*A*C;}
\DoxyCodeLine{00677\ }
\DoxyCodeLine{00678\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(radical))\ \{}
\DoxyCodeLine{00679\ \ \ \ \ \textcolor{comment}{//\ Tangent.}}
\DoxyCodeLine{00680\ \ \ \ \ t1\ =\ t2\ =\ -\/B\ /(2.0*A);}
\DoxyCodeLine{00681\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00682\ }
\DoxyCodeLine{00683\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (radical\ <\ 0.0)\ \{}
\DoxyCodeLine{00684\ \ \ \ \ \textcolor{comment}{//\ No\ real\ roots:\ no\ intersection\ with\ the\ line.}}
\DoxyCodeLine{00685\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00686\ \ \ \}}
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00688\ \ \ \textcolor{keywordtype}{double}\ reciprocal\_2A\ =\ 1.0/(2.0*A);}
\DoxyCodeLine{00689\ \ \ \textcolor{keywordtype}{double}\ sqrt\_radical\ =\ sqrtf(radical);}
\DoxyCodeLine{00690\ \ \ t1\ =\ (\ -\/B\ -\/\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00691\ \ \ t2\ =\ (\ -\/B\ +\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00692\ }
\DoxyCodeLine{00693\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00694\ \}}
\DoxyCodeLine{00695\ }
\DoxyCodeLine{00704\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionSphere_a13501a1cb80a50c35366faaa179b37a6}{CollisionSphere::}}}
\DoxyCodeLine{00705\ \mbox{\hyperlink{classCollisionSphere_a13501a1cb80a50c35366faaa179b37a6}{intersects\_parabola}}(\textcolor{keywordtype}{double}\ \&t,\ \textcolor{keyword}{const}\ LParabola\ \&parabola,}
\DoxyCodeLine{00706\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ t1,\ \textcolor{keywordtype}{double}\ t2,}
\DoxyCodeLine{00707\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&p1,\ \textcolor{keyword}{const}\ LPoint3\ \&p2)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00708\ \ \ \textcolor{keywordflow}{if}\ (t1\ ==\ t2)\ \{}
\DoxyCodeLine{00709\ \ \ \ \ \textcolor{comment}{//\ Special\ case:\ a\ single\ point.}}
\DoxyCodeLine{00710\ \ \ \ \ \textcolor{keywordflow}{if}\ ((p1\ -\/\ \_center).length\_squared()\ >\ \_radius\ *\ \_radius)\ \{}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00713\ \ \ \ \ \}}
\DoxyCodeLine{00714\ \ \ \ \ t\ =\ t1;}
\DoxyCodeLine{00715\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00716\ \ \ \}}
\DoxyCodeLine{00717\ }
\DoxyCodeLine{00718\ \ \ \textcolor{comment}{//\ To\ directly\ test\ for\ intersection\ between\ a\ parabola\ (quadratic)\ and\ a}}
\DoxyCodeLine{00719\ \ \ \textcolor{comment}{//\ sphere\ (also\ quadratic)\ requires\ solving\ a\ quartic\ equation.\ \ Doable,\ but}}
\DoxyCodeLine{00720\ \ \ \textcolor{comment}{//\ hard,\ and\ I'm\ a\ programmer,\ not\ a\ mathematician.\ \ So\ I'll\ solve\ it\ the}}
\DoxyCodeLine{00721\ \ \ \textcolor{comment}{//\ programmer's\ way\ instead,\ by\ approximating\ the\ parabola\ with\ a\ series\ of}}
\DoxyCodeLine{00722\ \ \ \textcolor{comment}{//\ line\ segments.\ \ Hence,\ this\ function\ works\ by\ recursively\ subdividing\ the}}
\DoxyCodeLine{00723\ \ \ \textcolor{comment}{//\ parabola\ as\ necessary.}}
\DoxyCodeLine{00724\ }
\DoxyCodeLine{00725\ \ \ \textcolor{comment}{//\ First,\ see\ if\ the\ line\ segment\ (p1\ -\/\ p2)\ comes\ sufficiently\ close\ to\ the}}
\DoxyCodeLine{00726\ \ \ \textcolor{comment}{//\ parabola.\ \ Do\ this\ by\ computing\ the\ parametric\ intervening\ point\ and}}
\DoxyCodeLine{00727\ \ \ \textcolor{comment}{//\ comparing\ its\ distance\ from\ the\ linear\ intervening\ point.}}
\DoxyCodeLine{00728\ \ \ \textcolor{keywordtype}{double}\ tmid\ =\ (t1\ +\ t2)\ *\ 0.5;}
\DoxyCodeLine{00729\ \ \ \textcolor{keywordflow}{if}\ (tmid\ !=\ t1\ \&\&\ tmid\ !=\ t2)\ \{}
\DoxyCodeLine{00730\ \ \ \ \ LPoint3\ pmid\ =\ parabola.calc\_point(tmid);}
\DoxyCodeLine{00731\ \ \ \ \ LPoint3\ pmid2\ =\ (p1\ +\ p2)\ *\ 0.5f;}
\DoxyCodeLine{00732\ }
\DoxyCodeLine{00733\ \ \ \ \ \textcolor{keywordflow}{if}\ ((pmid\ -\/\ pmid2).length\_squared()\ >\ 0.001f)\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \textcolor{comment}{//\ Subdivide.}}
\DoxyCodeLine{00735\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classCollisionSphere_a13501a1cb80a50c35366faaa179b37a6}{intersects\_parabola}}(t,\ parabola,\ t1,\ tmid,\ p1,\ pmid))\ \{}
\DoxyCodeLine{00736\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00737\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00738\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classCollisionSphere_a13501a1cb80a50c35366faaa179b37a6}{intersects\_parabola}}(t,\ parabola,\ tmid,\ t2,\ pmid,\ p2);}
\DoxyCodeLine{00739\ \ \ \ \ \}}
\DoxyCodeLine{00740\ \ \ \}}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \ \ \textcolor{comment}{//\ The\ line\ segment\ is\ sufficiently\ close;\ compare\ the\ segment\ itself.}}
\DoxyCodeLine{00743\ \ \ \textcolor{keywordtype}{double}\ t1a,\ t2a;}
\DoxyCodeLine{00744\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1a,\ t2a,\ p1,\ p2\ -\/\ p1,\ 0.0f))\ \{}
\DoxyCodeLine{00745\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00746\ \ \ \}}
\DoxyCodeLine{00747\ }
\DoxyCodeLine{00748\ \ \ \textcolor{keywordflow}{if}\ (t2a\ <\ 0.0\ ||\ t1a\ >\ 1.0)\ \{}
\DoxyCodeLine{00749\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00750\ \ \ \}}
\DoxyCodeLine{00751\ }
\DoxyCodeLine{00752\ \ \ t\ =\ max(t1a,\ 0.0);}
\DoxyCodeLine{00753\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00754\ \}}
\DoxyCodeLine{00755\ }
\DoxyCodeLine{00761\ LVertex\ \mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{CollisionSphere::}}}
\DoxyCodeLine{00762\ \mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(PN\_stdfloat\ latitude,\ PN\_stdfloat\ longitude)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00763\ \ \ PN\_stdfloat\ s1,\ c1;}
\DoxyCodeLine{00764\ \ \ csincos(latitude\ *\ MathNumbers::pi,\ \&s1,\ \&c1);}
\DoxyCodeLine{00765\ }
\DoxyCodeLine{00766\ \ \ PN\_stdfloat\ s2,\ c2;}
\DoxyCodeLine{00767\ \ \ csincos(longitude\ *\ 2.0f\ *\ MathNumbers::pi,\ \&s2,\ \&c2);}
\DoxyCodeLine{00768\ }
\DoxyCodeLine{00769\ \ \ LVertex\ p(s1\ *\ c2,\ s1\ *\ s2,\ c1);}
\DoxyCodeLine{00770\ \ \ \textcolor{keywordflow}{return}\ p\ *\ get\_radius();}
\DoxyCodeLine{00771\ \}}
\DoxyCodeLine{00772\ }
\DoxyCodeLine{00776\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionSphere_a86e0cf2790636dad14a0b263bae54900}{CollisionSphere::}}}
\DoxyCodeLine{00777\ \mbox{\hyperlink{classCollisionSphere_a86e0cf2790636dad14a0b263bae54900}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00778\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classCollisionSphere_a379e705ae9d6027dfeaf47ec4b5c9823}{make\_from\_bam}});}
\DoxyCodeLine{00779\ \}}
\DoxyCodeLine{00780\ }
\DoxyCodeLine{00785\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionSphere_aee1b764c08322a46e6cd698d75187803}{CollisionSphere::}}}
\DoxyCodeLine{00786\ \mbox{\hyperlink{classCollisionSphere_aee1b764c08322a46e6cd698d75187803}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&me)\ \{}
\DoxyCodeLine{00787\ \ \ \mbox{\hyperlink{classCollisionSolid_a0d50fe1dbd0400d255a1b86f09fca42d}{CollisionSolid::write\_datagram}}(manager,\ me);}
\DoxyCodeLine{00788\ \ \ \_center.write\_datagram(me);}
\DoxyCodeLine{00789\ \ \ me.add\_stdfloat(\_radius);}
\DoxyCodeLine{00790\ \}}
\DoxyCodeLine{00791\ }
\DoxyCodeLine{00795\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classCollisionSphere_a379e705ae9d6027dfeaf47ec4b5c9823}{CollisionSphere::}}}
\DoxyCodeLine{00796\ \mbox{\hyperlink{classCollisionSphere_a379e705ae9d6027dfeaf47ec4b5c9823}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00797\ \ \ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}\ *me\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}};}
\DoxyCodeLine{00798\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00799\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00801\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00802\ \ \ me-\/>\mbox{\hyperlink{classCollisionSphere_a2368e26a8cc2347665e4e083edd54da1}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00803\ \ \ \textcolor{keywordflow}{return}\ me;}
\DoxyCodeLine{00804\ \}}
\DoxyCodeLine{00805\ }
\DoxyCodeLine{00811\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionSphere_a2368e26a8cc2347665e4e083edd54da1}{CollisionSphere::}}}
\DoxyCodeLine{00812\ \mbox{\hyperlink{classCollisionSphere_a2368e26a8cc2347665e4e083edd54da1}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\&\ scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}*\ manager)\ \{}
\DoxyCodeLine{00813\ \ \ \mbox{\hyperlink{classCollisionSolid_abb24c87297214818d7ddd2fbb1875c61}{CollisionSolid::fillin}}(scan,\ manager);}
\DoxyCodeLine{00814\ \ \ \_center.read\_datagram(scan);}
\DoxyCodeLine{00815\ \ \ \_radius\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{00816\ \}}

\end{DoxyCode}
