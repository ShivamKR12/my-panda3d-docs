\doxysection{client\+Base.\+cxx}
\hypertarget{clientBase_8cxx_source}{}\label{clientBase_8cxx_source}\index{panda/src/device/clientBase.cxx@{panda/src/device/clientBase.cxx}}
\mbox{\hyperlink{clientBase_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clientBase_8h}{clientBase.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__device_8h}{config\_device.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ ClientBase::\_type\_handle;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00022\ ClientBase::}
\DoxyCodeLine{00023\ ClientBase()\ \{}
\DoxyCodeLine{00024\ \ \ \_forked\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00025\ \ \ \_last\_poll\_time\ =\ 0.0f;}
\DoxyCodeLine{00026\ \ \ \_last\_poll\_frame\ =\ 0;}
\DoxyCodeLine{00027\ \ \ \_cs\ =\ CS\_default;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#ifdef\ OLD\_HAVE\_IPC}}
\DoxyCodeLine{00030\ \ \ \_client\_thread\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00031\ \ \ \_shutdown\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00039\ ClientBase::}
\DoxyCodeLine{00040\ \string~ClientBase()\ \{}
\DoxyCodeLine{00041\ \ \ \textcolor{comment}{//\ We\ have\ to\ disconnect\ all\ of\ our\ devices\ before\ destructing.}}
\DoxyCodeLine{00042\ \ \ Devices::iterator\ di;}
\DoxyCodeLine{00043\ \ \ Devices\ devices\_copy\ =\ \_devices;}
\DoxyCodeLine{00044\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ devices\_copy.begin();\ di\ !=\ devices\_copy.end();\ ++di)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ DevicesByName\ \&dbn\ =\ (*di).second;}
\DoxyCodeLine{00046\ \ \ \ \ DevicesByName::iterator\ dbni;}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{for}\ (dbni\ =\ dbn.begin();\ dbni\ !=\ dbn.end();\ ++dbni)\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \mbox{\hyperlink{classClientDevice}{ClientDevice}}\ *device\ =\ (*dbni).second;}
\DoxyCodeLine{00049\ \ \ \ \ \ \ device-\/>\mbox{\hyperlink{classClientDevice_a7f15a5c22c90176a15afc119c476760d}{disconnect}}();}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#ifdef\ OLD\_HAVE\_IPC}}
\DoxyCodeLine{00054\ \ \ \textcolor{keywordflow}{if}\ (\_forked)\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \_shutdown\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{comment}{//\ Join\ the\ loader\ thread\ -\/\ calling\ process\ blocks\ until\ the\ loader\ thread}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{comment}{//\ returns.}}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordtype}{void}\ *ret;}
\DoxyCodeLine{00060\ \ \ \ \ \_client\_thread-\/>join(\&ret);}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00063\ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00071\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classClientBase_ac25f76afb502e6d084a7f768671bb3b8}{ClientBase::}}}
\DoxyCodeLine{00072\ \mbox{\hyperlink{classClientBase_ac25f76afb502e6d084a7f768671bb3b8}{fork\_asynchronous\_thread}}(\textcolor{keywordtype}{double}\ poll\_time)\ \{}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#ifdef\ OLD\_HAVE\_IPC}}
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (\_forked)\ \{}
\DoxyCodeLine{00075\ \ \ \ \ device\_cat.error()}
\DoxyCodeLine{00076\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ fork\ client\ thread\ twice.\(\backslash\)n"{}};}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00078\ \ \ \}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (asynchronous\_clients)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \_sleep\_time\ =\ (int)(1000000\ *\ poll\_time);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \_client\_thread\ =\ thread::create(\&st\_callback,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00084\ \ \ \ \ \_forked\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ device\_cat.debug()}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}fork\_asynchronous\_thread()\ -\/\ forking\ client\ thread"{}}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ <<\ std::endl;}
\DoxyCodeLine{00089\ \ \ \ \ \}}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00091\ \ \ \}}
\DoxyCodeLine{00092\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00095\ \}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00115\ PT(\mbox{\hyperlink{classClientDevice}{ClientDevice}})\ ClientBase::}
\DoxyCodeLine{00116\ get\_device(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ device\_type,\ \textcolor{keyword}{const}\ std::string\ \&device\_name)\ \{}
\DoxyCodeLine{00117\ \ \ DevicesByName\ \&dbn\ =\ \_devices[device\_type];}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ DevicesByName::iterator\ dbni;}
\DoxyCodeLine{00120\ \ \ dbni\ =\ dbn.find(device\_name);}
\DoxyCodeLine{00121\ \ \ \textcolor{keywordflow}{if}\ (dbni\ !=\ dbn.end())\ \{}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{comment}{//\ This\ device\ was\ previously\ connected.\ \ Return\ it\ again.}}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordflow}{return}\ (*dbni).second;}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \textcolor{comment}{//\ We\ need\ to\ create\ a\ new\ device\ for\ this\ name.}}
\DoxyCodeLine{00127\ \ \ PT(\mbox{\hyperlink{classClientDevice}{ClientDevice}})\ device\ =\ make\_device(device\_type,\ device\_name);}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ \textcolor{keywordflow}{if}\ (device\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00130\ \ \ \ \ dbn.insert(DevicesByName::value\_type(device\_name,\ device));}
\DoxyCodeLine{00131\ \ \ \}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{keywordflow}{return}\ device;}
\DoxyCodeLine{00134\ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00144\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classClientBase_a858b40b2c7a94eeecd1e1019c0779020}{ClientBase::}}}
\DoxyCodeLine{00145\ \mbox{\hyperlink{classClientBase_a858b40b2c7a94eeecd1e1019c0779020}{disconnect\_device}}(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ device\_type,\ \textcolor{keyword}{const}\ std::string\ \&device\_name,}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classClientDevice}{ClientDevice}}\ *device)\ \{}
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{classpmap}{DevicesByName}}\ \&dbn\ =\ \_devices[device\_type];}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ DevicesByName::iterator\ dbni;}
\DoxyCodeLine{00150\ \ \ dbni\ =\ dbn.find(device\_name);}
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{if}\ (dbni\ !=\ dbn.end())\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*dbni).second\ ==\ device)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ found\ it!}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ dbn.erase(dbni);}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00156\ \ \ \ \ \}}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \textcolor{comment}{//\ The\ device\ was\ unknown.}}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00161\ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00169\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classClientBase_a893b186adada0a24355360d627d4c30d}{ClientBase::}}}
\DoxyCodeLine{00170\ \mbox{\hyperlink{classClientBase_a893b186adada0a24355360d627d4c30d}{do\_poll}}()\ \{}
\DoxyCodeLine{00171\ \ \ \mbox{\hyperlink{classClockObject}{ClockObject}}\ *global\_clock\ =\ ClockObject::get\_global\_clock();}
\DoxyCodeLine{00172\ \ \ \_last\_poll\_frame\ =\ global\_clock-\/>get\_frame\_count();}
\DoxyCodeLine{00173\ \ \ \_last\_poll\_time\ =\ global\_clock-\/>get\_frame\_time();}
\DoxyCodeLine{00174\ \}}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00176\ \textcolor{preprocessor}{\#ifdef\ OLD\_HAVE\_IPC}}
\DoxyCodeLine{00185\ \textcolor{keywordtype}{void}\ *ClientBase::}
\DoxyCodeLine{00186\ st\_callback(\textcolor{keywordtype}{void}\ *arg)\ \{}
\DoxyCodeLine{00187\ \ \ nassertr(arg\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00188\ \ \ ((\mbox{\hyperlink{classClientBase}{ClientBase}}\ *)arg)-\/>callback();}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00196\ \textcolor{keywordtype}{void}\ ClientBase::}
\DoxyCodeLine{00197\ callback()\ \{}
\DoxyCodeLine{00198\ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_shutdown)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00201\ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{classClientBase_a893b186adada0a24355360d627d4c30d}{do\_poll}}();}
\DoxyCodeLine{00203\ \ \ \ \ ipc\_traits::sleep(0,\ \_sleep\_time);}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ \}}
\DoxyCodeLine{00206\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ OLD\_HAVE\_IPC}}

\end{DoxyCode}
