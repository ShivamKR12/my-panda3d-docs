\doxysection{android\+Graphics\+Pipe.\+cxx}
\hypertarget{androidGraphicsPipe_8cxx_source}{}\label{androidGraphicsPipe_8cxx_source}\index{panda/src/androiddisplay/androidGraphicsPipe.cxx@{panda/src/androiddisplay/androidGraphicsPipe.cxx}}
\mbox{\hyperlink{androidGraphicsPipe_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{comment}{//\ \#include\ "{}androidGraphicsBuffer.h"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{androidGraphicsPipe_8h}{androidGraphicsPipe.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ \#include\ "{}androidGraphicsPixmap.h"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{androidGraphicsWindow_8h}{androidGraphicsWindow.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{androidGraphicsStateGuardian_8h}{androidGraphicsStateGuardian.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__androiddisplay_8h}{config\_androiddisplay.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{frameBufferProperties_8h}{frameBufferProperties.h}}"{}}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ AndroidGraphicsPipe::\_type\_handle;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00027\ AndroidGraphicsPipe::}
\DoxyCodeLine{00028\ AndroidGraphicsPipe()\ \{}
\DoxyCodeLine{00029\ \ \ \_is\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00030\ \ \ \_supported\_types\ =\ OT\_window\ |\ OT\_buffer\ |\ OT\_texture\_buffer;}
\DoxyCodeLine{00031\ \ \ \_egl\_display\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \_display\_width\ =\ 0;}
\DoxyCodeLine{00034\ \ \ \_display\_height\ =\ 0;}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \_egl\_display\ =\ eglGetDisplay(EGL\_DEFAULT\_DISPLAY);}
\DoxyCodeLine{00037\ \ \ \textcolor{keywordflow}{if}\ (!eglInitialize(\_egl\_display,\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr}))\ \{}
\DoxyCodeLine{00038\ \ \ \ \ androiddisplay\_cat.error()}
\DoxyCodeLine{00039\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Couldn't\ initialize\ the\ EGL\ display:\ "{}}}
\DoxyCodeLine{00040\ \ \ \ \ \ \ <<\ \mbox{\hyperlink{config__androiddisplay_8cxx_ad7bc4d698e36f500ff695d9a9f526986}{get\_egl\_error\_string}}(eglGetError())\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00041\ \ \ \}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \textcolor{keywordflow}{if}\ (!eglBindAPI(EGL\_OPENGL\_ES\_API))\ \{}
\DoxyCodeLine{00044\ \ \ \ \ androiddisplay\_cat.error()}
\DoxyCodeLine{00045\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Couldn't\ bind\ EGL\ to\ the\ OpenGL\ ES\ API:\ "{}}}
\DoxyCodeLine{00046\ \ \ \ \ \ \ <<\ \mbox{\hyperlink{config__androiddisplay_8cxx_ad7bc4d698e36f500ff695d9a9f526986}{get\_egl\_error\_string}}(eglGetError())\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00047\ \ \ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00050\ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00055\ AndroidGraphicsPipe::}
\DoxyCodeLine{00056\ \string~AndroidGraphicsPipe()\ \{}
\DoxyCodeLine{00057\ \ \ \textcolor{keywordflow}{if}\ (\_egl\_display)\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordflow}{if}\ (!eglTerminate(\_egl\_display))\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \ \ androiddisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ terminate\ EGL\ display:\ "{}}}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ <<\ \mbox{\hyperlink{config__androiddisplay_8cxx_ad7bc4d698e36f500ff695d9a9f526986}{get\_egl\_error\_string}}(eglGetError())\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00061\ \ \ \ \ \}}
\DoxyCodeLine{00062\ \ \ \}}
\DoxyCodeLine{00063\ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00071\ std::string\ \mbox{\hyperlink{classAndroidGraphicsPipe_a9c94f570a3c5eed21e2d50351532b3d8}{AndroidGraphicsPipe::}}}
\DoxyCodeLine{00072\ \mbox{\hyperlink{classAndroidGraphicsPipe_a9c94f570a3c5eed21e2d50351532b3d8}{get\_interface\_name}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00073\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}OpenGL\ ES"{}};}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00080\ PT(\mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}})\ AndroidGraphicsPipe::}
\DoxyCodeLine{00081\ pipe\_constructor()\ \{}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classAndroidGraphicsPipe}{AndroidGraphicsPipe}};}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00090\ GraphicsPipe::PreferredWindowThread}
\DoxyCodeLine{00091\ \mbox{\hyperlink{classAndroidGraphicsPipe_a96edbc864c90af0a64c781a4cb139968}{AndroidGraphicsPipe::get\_preferred\_window\_thread}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00092\ \ \ \textcolor{comment}{//\ Most\ of\ the\ Android\ NDK\ window\ functions\ can\ be\ called\ from\ any\ thread.}}
\DoxyCodeLine{00093\ \ \ \textcolor{comment}{//\ Since\ we're\ creating\ the\ context\ at\ open\_window\ time,\ let's\ choose}}
\DoxyCodeLine{00094\ \ \ \textcolor{comment}{//\ "{}draw"{}.}}
\DoxyCodeLine{00095\ \ \ \textcolor{keywordflow}{return}\ PWT\_app;}
\DoxyCodeLine{00096\ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00101\ PT(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}})\ AndroidGraphicsPipe::}
\DoxyCodeLine{00102\ make\_output(\textcolor{keyword}{const}\ std::string\ \&name,}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFrameBufferProperties}{FrameBufferProperties}}\ \&fb\_prop,}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classWindowProperties}{WindowProperties}}\ \&win\_prop,}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *host,}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ retry,}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \&precertify)\ \{}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{if}\ (!\_is\_valid)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00114\ \ \ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \mbox{\hyperlink{classAndroidGraphicsStateGuardian}{AndroidGraphicsStateGuardian}}\ *androidgsg\ =\ 0;}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (gsg\ !=\ 0)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ DCAST\_INTO\_R(androidgsg,\ gsg,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00119\ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{comment}{//\ First\ thing\ to\ try:\ an\ eglGraphicsWindow}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordflow}{if}\ (retry\ ==\ 0)\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordflow}{if}\ (((flags\&BF\_require\_parasite)!=0)||}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ ((flags\&BF\_refuse\_window)!=0)||}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ ((flags\&BF\_resizeable)!=0)||}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ ((flags\&BF\_size\_track\_host)!=0)||}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ ((flags\&BF\_rtt\_cumulative)!=0)||}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ ((flags\&BF\_can\_bind\_color)!=0)||}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ ((flags\&BF\_can\_bind\_every)!=0))\ \{}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00132\ \ \ \ \ \}}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classAndroidGraphicsWindow}{AndroidGraphicsWindow}}(engine,\ \textcolor{keyword}{this},\ name,\ fb\_prop,\ win\_prop,}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ gsg,\ host);}
\DoxyCodeLine{00135\ \ \ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//\ Second\ thing\ to\ try:\ a\ GLES(2)GraphicsBuffer}}
\DoxyCodeLine{00138\ \ \ \textcolor{comment}{/*if\ (retry\ ==\ 1)\ \{}}
\DoxyCodeLine{00139\ \textcolor{comment}{\ \ \ \ if\ ((host==0)||}}
\DoxyCodeLine{00140\ \textcolor{comment}{\ \ //\ (!gl\_support\_fbo)||}}
\DoxyCodeLine{00141\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_require\_parasite)!=0)||}}
\DoxyCodeLine{00142\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_require\_window)!=0))\ \{}}
\DoxyCodeLine{00143\ \textcolor{comment}{\ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00144\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00145\ \textcolor{comment}{\ \ \ \ //\ Early\ failure\ -\/\ if\ we\ are\ sure\ that\ this\ buffer\ WONT\ meet\ specs,\ we\ can}}
\DoxyCodeLine{00146\ \textcolor{comment}{\ \ \ \ //\ bail\ out\ early.}}
\DoxyCodeLine{00147\ \textcolor{comment}{\ \ \ \ if\ ((flags\ \&\ BF\_fb\_props\_optional)==0)\ \{}}
\DoxyCodeLine{00148\ \textcolor{comment}{\ \ \ \ \ \ if\ ((fb\_prop.get\_indexed\_color()\ >\ 0)||}}
\DoxyCodeLine{00149\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ (fb\_prop.get\_back\_buffers()\ >\ 0)||}}
\DoxyCodeLine{00150\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ (fb\_prop.get\_accum\_bits()\ >\ 0)||}}
\DoxyCodeLine{00151\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ (fb\_prop.get\_multisamples()\ >\ 0))\ \{}}
\DoxyCodeLine{00152\ \textcolor{comment}{\ \ \ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00153\ \textcolor{comment}{\ \ \ \ \ \ \}}}
\DoxyCodeLine{00154\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00155\ \textcolor{comment}{\ \ \ \ //\ Early\ success\ -\/\ if\ we\ are\ sure\ that\ this\ buffer\ WILL\ meet\ specs,\ we\ can}}
\DoxyCodeLine{00156\ \textcolor{comment}{\ \ \ \ //\ precertify\ it.}}
\DoxyCodeLine{00157\ \textcolor{comment}{\ \ \ \ if\ ((eglgsg\ !=\ 0)\ \&\&}}
\DoxyCodeLine{00158\ \textcolor{comment}{\ \ \ \ \ \ \ \ (eglgsg-\/>is\_valid())\ \&\&}}
\DoxyCodeLine{00159\ \textcolor{comment}{\ \ \ \ \ \ \ \ (!eglgsg-\/>needs\_reset())\ \&\&}}
\DoxyCodeLine{00160\ \textcolor{comment}{\ \ \ \ \ \ \ \ (eglgsg-\/>\_supports\_framebuffer\_object)\ \&\&}}
\DoxyCodeLine{00161\ \textcolor{comment}{\ \ \ \ \ \ \ \ (eglgsg-\/>\_glDrawBuffers\ !=\ 0)\&\&}}
\DoxyCodeLine{00162\ \textcolor{comment}{\ \ \ \ \ \ \ \ (fb\_prop.is\_basic()))\ \{}}
\DoxyCodeLine{00163\ \textcolor{comment}{\ \ \ \ \ \ precertify\ =\ true;}}
\DoxyCodeLine{00164\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00165\ \textcolor{comment}{\#ifdef\ OPENGLES\_2}}
\DoxyCodeLine{00166\ \textcolor{comment}{\ \ \ \ return\ new\ GLES2GraphicsBuffer(engine,\ this,\ name,\ fb\_prop,\ win\_prop,}}
\DoxyCodeLine{00167\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ gsg,\ host);}}
\DoxyCodeLine{00168\ \textcolor{comment}{\#else}}
\DoxyCodeLine{00169\ \textcolor{comment}{\ \ \ \ return\ new\ GLESGraphicsBuffer(engine,\ this,\ name,\ fb\_prop,\ win\_prop,}}
\DoxyCodeLine{00170\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ gsg,\ host);}}
\DoxyCodeLine{00171\ \textcolor{comment}{\#endif}}
\DoxyCodeLine{00172\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00173\ \textcolor{comment}{}}
\DoxyCodeLine{00174\ \textcolor{comment}{\ \ //\ Third\ thing\ to\ try:\ a\ eglGraphicsBuffer}}
\DoxyCodeLine{00175\ \textcolor{comment}{\ \ if\ (retry\ ==\ 2)\ \{}}
\DoxyCodeLine{00176\ \textcolor{comment}{\ \ \ \ if\ (((flags\&BF\_require\_parasite)!=0)||}}
\DoxyCodeLine{00177\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_require\_window)!=0)||}}
\DoxyCodeLine{00178\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_resizeable)!=0)||}}
\DoxyCodeLine{00179\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_size\_track\_host)!=0))\ \{}}
\DoxyCodeLine{00180\ \textcolor{comment}{\ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00181\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00182\ \textcolor{comment}{}}
\DoxyCodeLine{00183\ \textcolor{comment}{\ \ \ \ if\ (!support\_rtt)\ \{}}
\DoxyCodeLine{00184\ \textcolor{comment}{\ \ \ \ \ \ if\ (((flags\&BF\_rtt\_cumulative)!=0)||}}
\DoxyCodeLine{00185\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ ((flags\&BF\_can\_bind\_every)!=0))\ \{}}
\DoxyCodeLine{00186\ \textcolor{comment}{\ \ \ \ \ \ \ \ //\ If\ we\ require\ Render-\/to-\/Texture,\ but\ can't\ be\ sure\ we\ support\ it,}}
\DoxyCodeLine{00187\ \textcolor{comment}{\ \ \ \ \ \ \ \ //\ bail.}}
\DoxyCodeLine{00188\ \textcolor{comment}{\ \ \ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00189\ \textcolor{comment}{\ \ \ \ \ \ \}}}
\DoxyCodeLine{00190\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00191\ \textcolor{comment}{}}
\DoxyCodeLine{00192\ \textcolor{comment}{\ \ \ \ return\ new\ eglGraphicsBuffer(engine,\ this,\ name,\ fb\_prop,\ win\_prop,}}
\DoxyCodeLine{00193\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ gsg,\ host);}}
\DoxyCodeLine{00194\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00195\ \textcolor{comment}{}}
\DoxyCodeLine{00196\ \textcolor{comment}{\ \ //\ Fourth\ thing\ to\ try:\ an\ eglGraphicsPixmap.}}
\DoxyCodeLine{00197\ \textcolor{comment}{\ \ if\ (retry\ ==\ 3)\ \{}}
\DoxyCodeLine{00198\ \textcolor{comment}{\ \ \ \ if\ (((flags\&BF\_require\_parasite)!=0)||}}
\DoxyCodeLine{00199\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_require\_window)!=0)||}}
\DoxyCodeLine{00200\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_resizeable)!=0)||}}
\DoxyCodeLine{00201\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_size\_track\_host)!=0))\ \{}}
\DoxyCodeLine{00202\ \textcolor{comment}{\ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00203\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00204\ \textcolor{comment}{}}
\DoxyCodeLine{00205\ \textcolor{comment}{\ \ \ \ if\ (((flags\&BF\_rtt\_cumulative)!=0)||}}
\DoxyCodeLine{00206\ \textcolor{comment}{\ \ \ \ \ \ \ \ ((flags\&BF\_can\_bind\_every)!=0))\ \{}}
\DoxyCodeLine{00207\ \textcolor{comment}{\ \ \ \ \ \ return\ NULL;}}
\DoxyCodeLine{00208\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00209\ \textcolor{comment}{}}
\DoxyCodeLine{00210\ \textcolor{comment}{\ \ \ \ return\ new\ eglGraphicsPixmap(engine,\ this,\ name,\ fb\_prop,\ win\_prop,}}
\DoxyCodeLine{00211\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ gsg,\ host);}}
\DoxyCodeLine{00212\ \textcolor{comment}{\ \ \}*/}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ \textcolor{comment}{//\ Nothing\ else\ left\ to\ try.}}
\DoxyCodeLine{00215\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00216\ \}}

\end{DoxyCode}
