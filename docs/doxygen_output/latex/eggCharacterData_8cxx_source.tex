\doxysection{egg\+Character\+Data.\+cxx}
\hypertarget{eggCharacterData_8cxx_source}{}\label{eggCharacterData_8cxx_source}\index{pandatool/src/eggcharbase/eggCharacterData.cxx@{pandatool/src/eggcharbase/eggCharacterData.cxx}}
\mbox{\hyperlink{eggCharacterData_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggCharacterData_8h}{eggCharacterData.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggCharacterCollection_8h}{eggCharacterCollection.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggCharacterDb_8h}{eggCharacterDb.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggJointData_8h}{eggJointData.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggSliderData_8h}{eggSliderData.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{comment}{//\ An\ STL\ function\ object\ to\ sort\ the\ joint\ list\ in\ order\ from\ highest\ to}}
\DoxyCodeLine{00024\ \textcolor{comment}{//\ lowest\ in\ the\ new\ hierarchy.\ \ Used\ in\ do\_reparent().}}
\DoxyCodeLine{00025\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classOrderJointsByNewDepth}{OrderJointsByNewDepth}}\ \{}
\DoxyCodeLine{00026\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00027\ \ \ \textcolor{keywordtype}{bool}\ operator()(\textcolor{keyword}{const}\ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *a,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *b)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{keywordflow}{return}\ a-\/>\_new\_parent\_depth\ <\ b-\/>\_new\_parent\_depth;}
\DoxyCodeLine{00029\ \ \ \}}
\DoxyCodeLine{00030\ \};}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00036\ EggCharacterData::}
\DoxyCodeLine{00037\ EggCharacterData(\mbox{\hyperlink{classEggCharacterCollection}{EggCharacterCollection}}\ *collection)\ :}
\DoxyCodeLine{00038\ \ \ \_component\_names(\textcolor{stringliteral}{"{}\_"{}},\ \textcolor{stringliteral}{"{}joint\_"{}})}
\DoxyCodeLine{00039\ \{}
\DoxyCodeLine{00040\ \ \ \_collection\ =\ collection;}
\DoxyCodeLine{00041\ \ \ \_root\_joint\ =\ \_collection-\/>\mbox{\hyperlink{classEggCharacterCollection_a4cae262f4ae791609e8dbee350105755}{make\_joint\_data}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00042\ \ \ \textcolor{comment}{//\ The\ fictitious\ root\ joint\ is\ not\ added\ to\ the\ \_components\ list.}}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00048\ EggCharacterData::}
\DoxyCodeLine{00049\ \string~EggCharacterData()\ \{}
\DoxyCodeLine{00050\ \ \ \textcolor{keyword}{delete}\ \_root\_joint;}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ Sliders::iterator\ si;}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ \_sliders.begin();\ si\ !=\ \_sliders.end();\ ++si)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \mbox{\hyperlink{classEggSliderData}{EggSliderData}}\ *slider\ =\ (*si);}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keyword}{delete}\ slider;}
\DoxyCodeLine{00056\ \ \ \}}
\DoxyCodeLine{00057\ \}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00065\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEggCharacterData_ad882a65c39d5711483aebe8fe1989467}{EggCharacterData::}}}
\DoxyCodeLine{00066\ \mbox{\hyperlink{classEggCharacterData_ad882a65c39d5711483aebe8fe1989467}{rename\_char}}(\textcolor{keyword}{const}\ std::string\ \&name)\ \{}
\DoxyCodeLine{00067\ \ \ Models::iterator\ mi;}
\DoxyCodeLine{00068\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_models.begin();\ mi\ !=\ \_models.end();\ ++mi)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ (*mi).\_model\_root-\/>set\_name(name);}
\DoxyCodeLine{00070\ \ \ \}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ set\_name(name);}
\DoxyCodeLine{00073\ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00084\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEggCharacterData_ad59d6a9f7c36416c77105a4f5c024191}{EggCharacterData::}}}
\DoxyCodeLine{00085\ \mbox{\hyperlink{classEggCharacterData_ad59d6a9f7c36416c77105a4f5c024191}{add\_model}}(\textcolor{keywordtype}{int}\ model\_index,\ \mbox{\hyperlink{classEggNode}{EggNode}}\ *model\_root,\ \mbox{\hyperlink{classEggData}{EggData}}\ *egg\_data)\ \{}
\DoxyCodeLine{00086\ \ \ Model\ m;}
\DoxyCodeLine{00087\ \ \ m.\_model\_index\ =\ model\_index;}
\DoxyCodeLine{00088\ \ \ m.\_model\_root\ =\ model\_root;}
\DoxyCodeLine{00089\ \ \ m.\_egg\_data\ =\ egg\_data;}
\DoxyCodeLine{00090\ \ \ \_models.push\_back(m);}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00099\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classEggCharacterData_a781dd50ca0652abcffb2c519db22705c}{EggCharacterData::}}}
\DoxyCodeLine{00100\ \mbox{\hyperlink{classEggCharacterData_a781dd50ca0652abcffb2c519db22705c}{get\_num\_frames}}(\textcolor{keywordtype}{int}\ model\_index)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordtype}{int}\ max\_num\_frames\ =\ 0;}
\DoxyCodeLine{00102\ \ \ Components::const\_iterator\ ci;}
\DoxyCodeLine{00103\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_components.begin();\ ci\ !=\ \_components.end();\ ++ci)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \mbox{\hyperlink{classEggComponentData}{EggComponentData}}\ *component\ =\ (*ci);}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ component-\/>\mbox{\hyperlink{classEggComponentData_a1cf66e74805f47969bf1141246668235}{get\_num\_frames}}(model\_index);}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_frames\ >\ 1)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ winner.\ \ Assume\ all\ other\ components\ will\ be\ similar.}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ num\_frames;}
\DoxyCodeLine{00109\ \ \ \ \ \}}
\DoxyCodeLine{00110\ \ \ \ \ max\_num\_frames\ =\ std::max(max\_num\_frames,\ num\_frames);}
\DoxyCodeLine{00111\ \ \ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \textcolor{comment}{//\ Every\ component\ had\ either\ 1\ frame\ or\ 0\ frames.\ \ Return\ the\ maximum\ of}}
\DoxyCodeLine{00114\ \ \ \textcolor{comment}{//\ these.}}
\DoxyCodeLine{00115\ \ \ \textcolor{keywordflow}{return}\ max\_num\_frames;}
\DoxyCodeLine{00116\ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00122\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classEggCharacterData_a3777905f160f6b74de0935f0c2241442}{EggCharacterData::}}}
\DoxyCodeLine{00123\ \mbox{\hyperlink{classEggCharacterData_a3777905f160f6b74de0935f0c2241442}{get\_frame\_rate}}(\textcolor{keywordtype}{int}\ model\_index)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00124\ \ \ Components::const\_iterator\ ci;}
\DoxyCodeLine{00125\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_components.begin();\ ci\ !=\ \_components.end();\ ++ci)\ \{}
\DoxyCodeLine{00126\ \ \ \ \ \mbox{\hyperlink{classEggComponentData}{EggComponentData}}\ *component\ =\ (*ci);}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{double}\ frame\_rate\ =\ component-\/>\mbox{\hyperlink{classEggComponentData_a67ec24100d3a5526aa24773444c54707}{get\_frame\_rate}}(model\_index);}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\_rate\ !=\ 0.0)\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ a\ winner.\ \ Assume\ all\ other\ components\ will\ be\ similar.}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ frame\_rate;}
\DoxyCodeLine{00131\ \ \ \ \ \}}
\DoxyCodeLine{00132\ \ \ \}}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{return}\ 0.0;}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00143\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classEggCharacterData_a9f9289591422c32283998e1d4542e188}{EggCharacterData::}}}
\DoxyCodeLine{00144\ \mbox{\hyperlink{classEggCharacterData_a9f9289591422c32283998e1d4542e188}{check\_num\_frames}}(\textcolor{keywordtype}{int}\ model\_index)\ \{}
\DoxyCodeLine{00145\ \ \ \textcolor{keywordtype}{int}\ max\_num\_frames\ =\ 0;}
\DoxyCodeLine{00146\ \ \ \textcolor{keywordtype}{bool}\ any\_violations\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00147\ \ \ Components::const\_iterator\ ci;}
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_components.begin();\ ci\ !=\ \_components.end();\ ++ci)\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \mbox{\hyperlink{classEggComponentData}{EggComponentData}}\ *component\ =\ (*ci);}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ component-\/>\mbox{\hyperlink{classEggComponentData_a1cf66e74805f47969bf1141246668235}{get\_num\_frames}}(model\_index);}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_frames\ >\ 1\ \&\&\ max\_num\_frames\ >\ 1\ \&\&}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ max\_num\_frames\ !=\ num\_frames)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ two\ different\ opinions\ about\ the\ number\ of\ frames\ (other}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \textcolor{comment}{//\ than\ 0\ or\ 1),\ we\ have\ a\ discrepency.\ \ This\ is\ an\ error\ condition.}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ any\_violations\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00156\ \ \ \ \ \}}
\DoxyCodeLine{00157\ \ \ \ \ max\_num\_frames\ =\ std::max(max\_num\_frames,\ num\_frames);}
\DoxyCodeLine{00158\ \ \ \}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{if}\ (any\_violations)\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{comment}{//\ Now\ go\ back\ through\ and\ force\ all\ components\ to\ the\ appropriate\ length.}}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_components.begin();\ ci\ !=\ \_components.end();\ ++ci)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \mbox{\hyperlink{classEggComponentData}{EggComponentData}}\ *component\ =\ (*ci);}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ component-\/>\mbox{\hyperlink{classEggComponentData_a1cf66e74805f47969bf1141246668235}{get\_num\_frames}}(model\_index);}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_frames\ >\ 1\ \&\&\ max\_num\_frames\ !=\ num\_frames)\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ component-\/>\mbox{\hyperlink{classEggComponentData_a0e2f5a8acf63e1d7582624ade980df80}{extend\_to}}(model\_index,\ max\_num\_frames);}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00168\ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{return}\ !any\_violations;}
\DoxyCodeLine{00172\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00182\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classEggCharacterData_ad948e6a6da71e5403999b860cf29aa27}{EggCharacterData::}}}
\DoxyCodeLine{00183\ \mbox{\hyperlink{classEggCharacterData_ad948e6a6da71e5403999b860cf29aa27}{do\_reparent}}()\ \{}
\DoxyCodeLine{00184\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classpset}{pset<EggJointData\ *>}}\ InvalidSet;}
\DoxyCodeLine{00185\ \ \ InvalidSet\ invalid\_set;}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \textcolor{comment}{//\ To\ begin,\ make\ sure\ the\ list\ of\ new\_children\ is\ accurate.}}
\DoxyCodeLine{00188\ \ \ Joints::const\_iterator\ ji;}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00191\ \ \ \ \ joint\_data-\/>\mbox{\hyperlink{classEggJointData_ad1e58abe3ddcae64fddc1d0a37d310fc}{do\_begin\_reparent}}();}
\DoxyCodeLine{00192\ \ \ \}}
\DoxyCodeLine{00193\ \ \ \textcolor{comment}{//\ We\ also\ need\ to\ clear\ the\ children\ on\ the\ root\ joint,\ but\ the\ root\ joint}}
\DoxyCodeLine{00194\ \ \ \textcolor{comment}{//\ doesn't\ get\ any\ of\ the\ other\ operations\ (including\ finish\_reparent)}}
\DoxyCodeLine{00195\ \ \ \textcolor{comment}{//\ applied\ to\ it.}}
\DoxyCodeLine{00196\ \ \ \_root\_joint-\/>\mbox{\hyperlink{classEggJointData_ad1e58abe3ddcae64fddc1d0a37d310fc}{do\_begin\_reparent}}();}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{comment}{//\ Now,\ check\ for\ cycles\ in\ the\ new\ parenting\ hierarchy,\ and\ also\ sort\ the}}
\DoxyCodeLine{00200\ \ \ \textcolor{comment}{//\ joints\ in\ order\ from\ top\ to\ bottom\ in\ the\ new\ hierarchy.}}
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00203\ \ \ \ \ \mbox{\hyperlink{classpset}{pset<EggJointData\ *>}}\ chain;}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordflow}{if}\ (joint\_data-\/>\mbox{\hyperlink{classEggJointData_abb658e3a03070de2af4a634105864437}{calc\_new\_parent\_depth}}(chain))\ \{}
\DoxyCodeLine{00205\ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Cycle\ detected\ in\ parent\ chain\ for\ "{}}\ <<\ joint\_data-\/>get\_name()}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}!\(\backslash\)n"{}};}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00208\ \ \ \ \ \}}
\DoxyCodeLine{00209\ \ \ \}}
\DoxyCodeLine{00210\ \ \ sort(\_joints.begin(),\ \_joints.end(),\ \mbox{\hyperlink{classOrderJointsByNewDepth}{OrderJointsByNewDepth}}());}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \ \ \textcolor{comment}{//\ Now\ compute\ the\ new\ transforms\ for\ the\ joints'\ new\ positions.\ \ This\ is}}
\DoxyCodeLine{00213\ \ \ \textcolor{comment}{//\ done\ recursively\ through\ the\ new\ parent\ hierarchy,\ so\ we\ can\ take}}
\DoxyCodeLine{00214\ \ \ \textcolor{comment}{//\ advantage\ of\ caching\ the\ net\ value\ for\ a\ particular\ frame.}}
\DoxyCodeLine{00215\ \ \ Models::const\_iterator\ mi;}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_models.begin();\ mi\ !=\ \_models.end();\ ++mi)\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \mbox{\hyperlink{classEggCharacterDb}{EggCharacterDb}}\ db;}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keywordtype}{int}\ model\_index\ =\ (*mi).\_model\_index;}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ \mbox{\hyperlink{classEggCharacterData_a781dd50ca0652abcffb2c519db22705c}{get\_num\_frames}}(model\_index);}
\DoxyCodeLine{00220\ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}\ \ computing\ "{}}\ <<\ (mi\ -\/\ \_models.begin())\ +\ 1}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ of\ "{}}\ <<\ \_models.size()}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}:\ "{}}\ <<\ (*mi).\_egg\_data-\/>get\_egg\_filename()}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ ("{}}\ <<\ num\_frames\ <<\ \textcolor{stringliteral}{"{}\ frames)\(\backslash\)n"{}};}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ f\ =\ 0;\ f\ <\ num\_frames;\ f++)\ \{}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \textcolor{comment}{//\ First,\ walk\ through\ all\ the\ joints\ and\ flush\ the\ computed\ net}}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \textcolor{comment}{//\ transforms\ from\ before.}}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ joint\_data-\/>\mbox{\hyperlink{classEggJointData_a6a6d054eaa4f573becd585fc228da834}{do\_begin\_compute\_reparent}}();}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \_root\_joint-\/>\mbox{\hyperlink{classEggJointData_a6a6d054eaa4f573becd585fc228da834}{do\_begin\_compute\_reparent}}();}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ go\ back\ through\ and\ compute\ the\ reparented\ transforms,\ caching}}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \textcolor{comment}{//\ net\ transforms\ as\ necessary.}}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!joint\_data-\/>\mbox{\hyperlink{classEggJointData_a2f7b65310e85bf9002b7d3126718e069}{do\_compute\_reparent}}(model\_index,\ f,\ db))\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Oops,\ we\ got\ an\ invalid\ transform.}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ invalid\_set.insert(joint\_data);}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00242\ \ \ \ \ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{comment}{//\ Finally,\ apply\ the\ computations\ to\ the\ joints.}}
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!joint\_data-\/>\mbox{\hyperlink{classEggJointData_a05b9008f0c3eec8900b8f49600e2f9fb}{do\_joint\_rebuild}}(model\_index,\ db))\ \{}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ invalid\_set.insert(joint\_data);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00250\ \ \ \ \ \}}
\DoxyCodeLine{00251\ \ \ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{comment}{//\ Now\ remove\ all\ of\ the\ old\ children\ and\ add\ in\ the\ new\ children.}}
\DoxyCodeLine{00254\ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00256\ \ \ \ \ joint\_data-\/>\mbox{\hyperlink{classEggJointData_a8fd0ea681831b2829d2d7954e16f1396}{do\_finish\_reparent}}();}
\DoxyCodeLine{00257\ \ \ \}}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \textcolor{comment}{//\ Report\ the\ set\ of\ joints\ that\ failed.\ \ It\ really\ shouldn't\ be\ possible}}
\DoxyCodeLine{00260\ \ \ \textcolor{comment}{//\ for\ any\ joints\ to\ fail,\ so\ if\ you\ see\ anything\ reported\ here,\ something}}
\DoxyCodeLine{00261\ \ \ \textcolor{comment}{//\ went\ wrong\ at\ a\ fundamental\ level.\ \ Perhaps\ a\ problem\ with}}
\DoxyCodeLine{00262\ \ \ \textcolor{comment}{//\ decompose\_matrix().}}
\DoxyCodeLine{00263\ \ \ InvalidSet::const\_iterator\ si;}
\DoxyCodeLine{00264\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ invalid\_set.begin();\ si\ !=\ invalid\_set.end();\ ++si)\ \{}
\DoxyCodeLine{00265\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*si);}
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{comment}{//\ Don't\ bother\ reporting\ joints\ that\ no\ longer\ have\ a\ parent,\ since\ we}}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{comment}{//\ don't\ care\ about\ joints\ that\ are\ now\ outside\ the\ hierarchy.}}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{keywordflow}{if}\ (joint\_data-\/>get\_parent()\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00269\ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Warning:\ reparenting\ "{}}\ <<\ joint\_data-\/>get\_name()}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ to\ "{}};}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (joint\_data-\/>get\_parent()\ ==\ \_root\_joint)\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}the\ root"{}};}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ nout\ <<\ joint\_data-\/>get\_parent()-\/>get\_name();}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}\ results\ in\ an\ invalid\ transform.\(\backslash\)n"{}};}
\DoxyCodeLine{00277\ \ \ \ \ \}}
\DoxyCodeLine{00278\ \ \ \}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \ \ \textcolor{keywordflow}{return}\ invalid\_set.empty();}
\DoxyCodeLine{00281\ \}}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00293\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEggCharacterData_a27afbfc265e20debed76abf426bed4d1}{EggCharacterData::}}}
\DoxyCodeLine{00294\ \mbox{\hyperlink{classEggCharacterData_a27afbfc265e20debed76abf426bed4d1}{choose\_optimal\_hierarchy}}()\ \{}
\DoxyCodeLine{00295\ \ \ \mbox{\hyperlink{classEggCharacterDb}{EggCharacterDb}}\ db;}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \ \ Joints::const\_iterator\ ji,\ jj;}
\DoxyCodeLine{00298\ \ \ \textcolor{keywordflow}{for}\ (ji\ =\ \_joints.begin();\ ji\ !=\ \_joints.end();\ ++ji)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *joint\_data\ =\ (*ji);}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00301\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *best\_parent\ =\ joint\_data-\/>get\_parent();}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keywordtype}{int}\ best\_score\ =\ joint\_data-\/>\mbox{\hyperlink{classEggJointData_a116ad3ff91a23b6957011697dd76ff2c}{score\_reparent\_to}}(best\_parent,\ db);}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{keywordflow}{for}\ (jj\ =\ \_joints.begin();\ jj\ !=\ \_joints.end();\ ++jj)\ \{}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *possible\_parent\ =\ (*jj);}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (possible\_parent\ !=\ joint\_data\ \&\&\ possible\_parent\ !=\ best\_parent\ \&\&}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ !joint\_data-\/>is\_new\_ancestor(possible\_parent))\ \{}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ score\ =\ joint\_data-\/>\mbox{\hyperlink{classEggJointData_a116ad3ff91a23b6957011697dd76ff2c}{score\_reparent\_to}}(possible\_parent,\ db);}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (score\ >=\ 0\ \&\&\ (best\_score\ <\ 0\ ||\ score\ <\ best\_score))\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ best\_parent\ =\ possible\_parent;}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ best\_score\ =\ score;}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00315\ \ \ \ \ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{comment}{//\ Also\ consider\ reparenting\ the\ node\ to\ the\ root.}}
\DoxyCodeLine{00318\ \ \ \ \ \mbox{\hyperlink{classEggJointData}{EggJointData}}\ *possible\_parent\ =\ get\_root\_joint();}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keywordflow}{if}\ (possible\_parent\ !=\ best\_parent)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ score\ =\ joint\_data-\/>\mbox{\hyperlink{classEggJointData_a116ad3ff91a23b6957011697dd76ff2c}{score\_reparent\_to}}(possible\_parent,\ db);}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (score\ >=\ 0\ \&\&\ (best\_score\ <\ 0\ ||\ score\ <\ best\_score))\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ best\_parent\ =\ possible\_parent;}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ best\_score\ =\ score;}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00325\ \ \ \ \ \}}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keywordflow}{if}\ (best\_parent\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ best\_parent\ !=\ joint\_data-\/>\_parent)\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}best\ parent\ for\ "{}}\ <<\ joint\_data-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\ is\ "{}}}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ <<\ best\_parent-\/>get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00331\ \ \ \ \ \ \ joint\_data-\/>reparent\_to(best\_parent);}
\DoxyCodeLine{00332\ \ \ \ \ \}}
\DoxyCodeLine{00333\ \ \ \}}
\DoxyCodeLine{00334\ \}}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00340\ \mbox{\hyperlink{classEggSliderData}{EggSliderData}}\ *\mbox{\hyperlink{classEggCharacterData_a852f02cbeea898a5984e9fd14e15ea3f}{EggCharacterData::}}}
\DoxyCodeLine{00341\ \mbox{\hyperlink{classEggCharacterData_a852f02cbeea898a5984e9fd14e15ea3f}{find\_slider}}(\textcolor{keyword}{const}\ std::string\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00342\ \ \ SlidersByName::const\_iterator\ si;}
\DoxyCodeLine{00343\ \ \ si\ =\ \_sliders\_by\_name.find(name);}
\DoxyCodeLine{00344\ \ \ \textcolor{keywordflow}{if}\ (si\ !=\ \_sliders\_by\_name.end())\ \{}
\DoxyCodeLine{00345\ \ \ \ \ \textcolor{keywordflow}{return}\ (*si).second;}
\DoxyCodeLine{00346\ \ \ \}}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00349\ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00355\ \mbox{\hyperlink{classEggSliderData}{EggSliderData}}\ *\mbox{\hyperlink{classEggCharacterData_ab0b108a835a587aea159766117ea749c}{EggCharacterData::}}}
\DoxyCodeLine{00356\ \mbox{\hyperlink{classEggCharacterData_ab0b108a835a587aea159766117ea749c}{make\_slider}}(\textcolor{keyword}{const}\ std::string\ \&name)\ \{}
\DoxyCodeLine{00357\ \ \ SlidersByName::const\_iterator\ si;}
\DoxyCodeLine{00358\ \ \ si\ =\ \_sliders\_by\_name.find(name);}
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{if}\ (si\ !=\ \_sliders\_by\_name.end())\ \{}
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{keywordflow}{return}\ (*si).second;}
\DoxyCodeLine{00361\ \ \ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ \mbox{\hyperlink{classEggSliderData}{EggSliderData}}\ *slider\ =\ \_collection-\/>\mbox{\hyperlink{classEggCharacterCollection_a08a5e4ef34822b37509b155b6a3fb273}{make\_slider\_data}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00364\ \ \ slider-\/>set\_name(name);}
\DoxyCodeLine{00365\ \ \ \_sliders\_by\_name.insert(SlidersByName::value\_type(name,\ slider));}
\DoxyCodeLine{00366\ \ \ \_sliders.push\_back(slider);}
\DoxyCodeLine{00367\ \ \ \_components.push\_back(slider);}
\DoxyCodeLine{00368\ \ \ \textcolor{keywordflow}{return}\ slider;}
\DoxyCodeLine{00369\ \}}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00377\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classEggCharacterData_a9728ab2f8e3c56800ba48754a3d87079}{EggCharacterData::}}}
\DoxyCodeLine{00378\ \mbox{\hyperlink{classEggCharacterData_a9728ab2f8e3c56800ba48754a3d87079}{estimate\_db\_size}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00379\ \ \ \textcolor{comment}{//\ Count\ how\ much\ memory\ we\ will\ need\ to\ store\ the\ interim\ transforms.\ \ This}}
\DoxyCodeLine{00380\ \ \ \textcolor{comment}{//\ is\ models\ *\ joints\ *\ frames\ *\ 3\ *\ sizeof(LMatrix4d).}}
\DoxyCodeLine{00381\ \ \ \textcolor{keywordtype}{size\_t}\ mj\_frames\ =\ 0;}
\DoxyCodeLine{00382\ \ \ Models::const\_iterator\ mi;}
\DoxyCodeLine{00383\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_models.begin();\ mi\ !=\ \_models.end();\ ++mi)\ \{}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{keywordtype}{int}\ model\_index\ =\ (*mi).\_model\_index;}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num\_frames\ =\ (size\_t)\mbox{\hyperlink{classEggCharacterData_a781dd50ca0652abcffb2c519db22705c}{get\_num\_frames}}(model\_index);}
\DoxyCodeLine{00386\ \ \ \ \ mj\_frames\ +=\ num\_frames\ *\ \_joints.size();}
\DoxyCodeLine{00387\ \ \ \}}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00389\ \ \ \textcolor{comment}{//\ We\ do\ this\ operation\ a\ bit\ carefully,\ to\ guard\ against\ integer\ overflow.}}
\DoxyCodeLine{00390\ \ \ \textcolor{keywordtype}{size\_t}\ mb\_needed\ =\ ((mj\_frames\ *\ 3\ /\ 1024)\ *\ \textcolor{keyword}{sizeof}(LMatrix4d))\ /\ 1024;}
\DoxyCodeLine{00391\ }
\DoxyCodeLine{00392\ \ \ \textcolor{keywordflow}{return}\ mb\_needed;}
\DoxyCodeLine{00393\ \}}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00399\ \textcolor{keywordtype}{void}\ EggCharacterData::}
\DoxyCodeLine{00400\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00401\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)}
\DoxyCodeLine{00402\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Character\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{}:\(\backslash\)n"{}};}
\DoxyCodeLine{00403\ \ \ get\_root\_joint()-\/>write(out,\ indent\_level\ +\ 2);}
\DoxyCodeLine{00404\ }
\DoxyCodeLine{00405\ \ \ Sliders::const\_iterator\ si;}
\DoxyCodeLine{00406\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ \_sliders.begin();\ si\ !=\ \_sliders.end();\ ++si)\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \mbox{\hyperlink{classEggSliderData}{EggSliderData}}\ *slider\ =\ (*si);}
\DoxyCodeLine{00408\ \ \ \ \ slider-\/>write(out,\ indent\_level\ +\ 2);}
\DoxyCodeLine{00409\ \ \ \}}
\DoxyCodeLine{00410\ \}}

\end{DoxyCode}
