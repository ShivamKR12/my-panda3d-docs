\doxysection{multiplex\+Stream\+Buf.\+cxx}
\hypertarget{multiplexStreamBuf_8cxx_source}{}\label{multiplexStreamBuf_8cxx_source}\index{panda/src/downloader/multiplexStreamBuf.cxx@{panda/src/downloader/multiplexStreamBuf.cxx}}
\mbox{\hyperlink{multiplexStreamBuf_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{multiplexStreamBuf_8h}{multiplexStreamBuf.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ \_WIN32}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#define\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{windows_8h}{windows.h}}>}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#undef\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{comment}{//\ We\ use\ real\ assert()\ instead\ of\ nassert(),\ because\ we're\ likely\ to\ be}}
\DoxyCodeLine{00023\ \textcolor{comment}{//\ invoked\ directly\ by\ pnotify.here,\ and\ we\ don't\ want\ to\ risk\ infinite}}
\DoxyCodeLine{00024\ \textcolor{comment}{//\ recursion.}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <assert.h>}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00032\ \textcolor{keywordtype}{void}\ MultiplexStreamBuf::Output::}
\DoxyCodeLine{00033\ close()\ \{}
\DoxyCodeLine{00034\ \ \ \textcolor{keywordflow}{if}\ (\_owns\_obj)\ \{}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_output\_type)\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordflow}{case}\ OT\_ostream:}
\DoxyCodeLine{00037\ \ \ \ \ \ \ assert(\_out\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ \_out;}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keywordflow}{case}\ OT\_stdio:}
\DoxyCodeLine{00042\ \ \ \ \ \ \ assert(\_fout\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00043\ \ \ \ \ \ \ fclose(\_fout);}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00048\ \ \ \ \ \}}
\DoxyCodeLine{00049\ \ \ \}}
\DoxyCodeLine{00050\ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00055\ \textcolor{keywordtype}{void}\ MultiplexStreamBuf::Output::}
\DoxyCodeLine{00056\ write\_string(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&str)\ \{}
\DoxyCodeLine{00057\ \ \ \textcolor{keywordflow}{switch}\ (\_output\_type)\ \{}
\DoxyCodeLine{00058\ \ \ \textcolor{keywordflow}{case}\ OT\_ostream:}
\DoxyCodeLine{00059\ \ \ \ \ assert(\_out\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00060\ \ \ \ \ \_out-\/>write(str.data(),\ str.length());}
\DoxyCodeLine{00061\ \ \ \ \ \_out-\/>flush();}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \textcolor{keywordflow}{case}\ OT\_stdio:}
\DoxyCodeLine{00065\ \ \ \ \ assert(\_fout\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00066\ \ \ \ \ fwrite(str.data(),\ str.length(),\ 1,\ \_fout);}
\DoxyCodeLine{00067\ \ \ \ \ fflush(\_fout);}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{keywordflow}{case}\ OT\_system\_debug:}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#ifdef\ \_WIN32}}
\DoxyCodeLine{00072\ \ \ \ \ OutputDebugString(str.c\_str());}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00075\ \ \ \}}
\DoxyCodeLine{00076\ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00081\ MultiplexStreamBuf::}
\DoxyCodeLine{00082\ MultiplexStreamBuf()\ \{}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#ifndef\ PHAVE\_IOSTREAM}}
\DoxyCodeLine{00084\ \ \ \textcolor{comment}{//\ Older\ iostream\ implementations\ required\ this.}}
\DoxyCodeLine{00085\ \ \ allocate();}
\DoxyCodeLine{00086\ \ \ setp(base(),\ ebuf());}
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00088\ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00093\ MultiplexStreamBuf::}
\DoxyCodeLine{00094\ \string~MultiplexStreamBuf()\ \{}
\DoxyCodeLine{00095\ \ \ \mbox{\hyperlink{classMultiplexStreamBuf_abb312ed2e4bcb8d6710bd2be2b02047f}{sync}}();}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \textcolor{comment}{//\ Make\ sure\ all\ of\ our\ owned\ pointers\ are\ freed.}}
\DoxyCodeLine{00098\ \ \ Outputs::iterator\ oi;}
\DoxyCodeLine{00099\ \ \ \textcolor{keywordflow}{for}\ (oi\ =\ \_outputs.begin();\ oi\ !=\ \_outputs.end();\ ++oi)\ \{}
\DoxyCodeLine{00100\ \ \ \ \ Output\ \&out\ =\ (*oi);}
\DoxyCodeLine{00101\ \ \ \ \ out.close();}
\DoxyCodeLine{00102\ \ \ \}}
\DoxyCodeLine{00103\ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00109\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classMultiplexStreamBuf_a806a63a60d7500ef6be1660ff9a0bd04}{MultiplexStreamBuf::}}}
\DoxyCodeLine{00110\ \mbox{\hyperlink{classMultiplexStreamBuf_a806a63a60d7500ef6be1660ff9a0bd04}{add\_output}}(MultiplexStreamBuf::BufferType\ buffer\_type,}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ MultiplexStreamBuf::OutputType\ output\_type,}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ std::ostream\ *out,\ FILE\ *fout,\ \textcolor{keywordtype}{bool}\ owns\_obj)\ \{}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ Output\ o;}
\DoxyCodeLine{00115\ \ \ o.\_buffer\_type\ =\ buffer\_type;}
\DoxyCodeLine{00116\ \ \ o.\_output\_type\ =\ output\_type;}
\DoxyCodeLine{00117\ \ \ o.\_out\ =\ out;}
\DoxyCodeLine{00118\ \ \ o.\_fout\ =\ fout;}
\DoxyCodeLine{00119\ \ \ o.\_owns\_obj\ =\ owns\_obj;}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{comment}{//\ Ensure\ that\ we\ have\ the\ mutex\ while\ we\ fiddle\ with\ the\ list\ of\ outputs.}}
\DoxyCodeLine{00122\ \ \ \_lock.lock();}
\DoxyCodeLine{00123\ \ \ \_outputs.push\_back(o);}
\DoxyCodeLine{00124\ \ \ \_lock.unlock();}
\DoxyCodeLine{00125\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00131\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classMultiplexStreamBuf_a531bc6bdd29d15f577e8818c72880bef}{MultiplexStreamBuf::}}}
\DoxyCodeLine{00132\ \mbox{\hyperlink{classMultiplexStreamBuf_a531bc6bdd29d15f577e8818c72880bef}{flush}}()\ \{}
\DoxyCodeLine{00133\ \ \ \_lock.lock();}
\DoxyCodeLine{00134\ \ \ write\_chars(\textcolor{stringliteral}{"{}"{}},\ 0,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00135\ \ \ \_lock.unlock();}
\DoxyCodeLine{00136\ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00142\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classMultiplexStreamBuf_a490e16df31f12756e09ac9db88f8bda3}{MultiplexStreamBuf::}}}
\DoxyCodeLine{00143\ \mbox{\hyperlink{classMultiplexStreamBuf_a490e16df31f12756e09ac9db88f8bda3}{overflow}}(\textcolor{keywordtype}{int}\ ch)\ \{}
\DoxyCodeLine{00144\ \ \ \_lock.lock();}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ std::streamsize\ n\ =\ pptr()\ -\/\ pbase();}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{if}\ (n\ !=\ 0)\ \{}
\DoxyCodeLine{00149\ \ \ \ \ write\_chars(pbase(),\ n,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00150\ \ \ \ \ pbump(-\/n);\ \ \textcolor{comment}{//\ Reset\ pptr().}}
\DoxyCodeLine{00151\ \ \ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \textcolor{keywordflow}{if}\ (ch\ !=\ EOF)\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{comment}{//\ Write\ one\ more\ character.}}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordtype}{char}\ c\ =\ ch;}
\DoxyCodeLine{00156\ \ \ \ \ write\_chars(\&c,\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \_lock.unlock();}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00161\ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00167\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classMultiplexStreamBuf_abb312ed2e4bcb8d6710bd2be2b02047f}{MultiplexStreamBuf::}}}
\DoxyCodeLine{00168\ \mbox{\hyperlink{classMultiplexStreamBuf_abb312ed2e4bcb8d6710bd2be2b02047f}{sync}}()\ \{}
\DoxyCodeLine{00169\ \ \ \_lock.lock();}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ std::streamsize\ n\ =\ pptr()\ -\/\ pbase();}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \ \ \textcolor{comment}{//\ We\ pass\ in\ false\ for\ the\ flush\ value,\ even\ though\ our\ transmitting}}
\DoxyCodeLine{00174\ \ \ \textcolor{comment}{//\ ostream\ said\ to\ sync.\ \ This\ allows\ us\ to\ get\ better\ line\ buffering,\ since}}
\DoxyCodeLine{00175\ \ \ \textcolor{comment}{//\ our\ transmitting\ ostream\ is\ often\ set\ unitbuf,\ and\ might\ call\ sync}}
\DoxyCodeLine{00176\ \ \ \textcolor{comment}{//\ multiple\ times\ in\ one\ line.\ \ We\ still\ have\ an\ explicit\ flush()\ call\ to}}
\DoxyCodeLine{00177\ \ \ \textcolor{comment}{//\ force\ the\ issue.}}
\DoxyCodeLine{00178\ \ \ write\_chars(pbase(),\ n,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00179\ \ \ pbump(-\/n);}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ \_lock.unlock();}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ 0;\ \ \textcolor{comment}{//\ Return\ 0\ for\ success,\ EOF\ to\ indicate\ write\ full.}}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00193\ \textcolor{keywordtype}{void}\ MultiplexStreamBuf::}
\DoxyCodeLine{00194\ write\_chars(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *start,\ \textcolor{keywordtype}{int}\ length,\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classMultiplexStreamBuf_a531bc6bdd29d15f577e8818c72880bef}{flush}})\ \{}
\DoxyCodeLine{00195\ \ \ \textcolor{keywordtype}{size\_t}\ orig\ =\ \_line\_buffer.length();}
\DoxyCodeLine{00196\ \ \ \textcolor{keywordtype}{string}\ latest;}
\DoxyCodeLine{00197\ \ \ \textcolor{keywordflow}{if}\ (length\ !=\ 0)\ \{}
\DoxyCodeLine{00198\ \ \ \ \ latest\ =\ string(start,\ length);}
\DoxyCodeLine{00199\ \ \ \}}
\DoxyCodeLine{00200\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classMultiplexStreamBuf_a531bc6bdd29d15f577e8818c72880bef}{flush}})\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ to\ flush\ the\ stream\ now,\ we\ dump\ the\ whole\ thing\ regardless\ of}}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{comment}{//\ whether\ we\ have\ reached\ end-\/of-\/line.}}
\DoxyCodeLine{00205\ \ \ \ \ line\ =\ \_line\_buffer\ +\ latest;}
\DoxyCodeLine{00206\ \ \ \ \ \_line\_buffer\ =\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ check\ for\ the\ end-\/of-\/line\ character,\ for\ our\ ostreams}}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ that\ only\ want\ a\ complete\ line\ at\ a\ time.}}
\DoxyCodeLine{00211\ \ \ \ \ \_line\_buffer\ +=\ latest;}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ eol\ =\ \_line\_buffer.rfind(\textcolor{charliteral}{'\(\backslash\)n'},\ orig);}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{if}\ (eol\ !=\ string::npos)\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \ \ line\ =\ \_line\_buffer.substr(0,\ eol\ +\ 1);}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \_line\_buffer\ =\ \_line\_buffer.substr(eol\ +\ 1);}
\DoxyCodeLine{00216\ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00219\ \ \ Outputs::iterator\ oi;}
\DoxyCodeLine{00220\ \ \ \textcolor{keywordflow}{for}\ (oi\ =\ \_outputs.begin();\ oi\ !=\ \_outputs.end();\ ++oi)\ \{}
\DoxyCodeLine{00221\ \ \ \ \ Output\ \&out\ =\ (*oi);}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{keywordflow}{switch}\ (out.\_buffer\_type)\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordflow}{case}\ BT\_none:}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ buffering:\ send\ all\ new\ characters\ directly\ to\ the\ ostream.}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!latest.empty())\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ out.write\_string(latest);}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{keywordflow}{case}\ BT\_line:}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \textcolor{comment}{//\ Line\ buffering:\ send\ only\ when\ a\ complete\ line\ has\ been\ received.}}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!line.empty())\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ out.write\_string(line);}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00236\ \ \ \ \ \}}
\DoxyCodeLine{00237\ \ \ \}}
\DoxyCodeLine{00238\ \}}

\end{DoxyCode}
