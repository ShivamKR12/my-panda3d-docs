\doxysection{deleted\+Buffer\+Chain.\+h}
\hypertarget{deletedBufferChain_8h_source}{}\label{deletedBufferChain_8h_source}\index{dtool/src/dtoolbase/deletedBufferChain.h@{dtool/src/dtoolbase/deletedBufferChain.h}}
\mbox{\hyperlink{deletedBufferChain_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#ifndef\ DELETEDBUFFERCHAIN\_H}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#define\ DELETEDBUFFERCHAIN\_H}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dtoolbase_8h}{dtoolbase.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{neverFreeMemory_8h}{neverFreeMemory.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mutexImpl_8h}{mutexImpl.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{atomicAdjust_8h}{atomicAdjust.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{numeric__types_8h}{numeric\_types.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{typeHandle_8h}{typeHandle.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{patomic_8h}{patomic.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <assert.h>}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{comment}{//\ Though\ it's\ tempting,\ it\ doesn't\ seem\ to\ be\ possible\ to\ implement}}
\DoxyCodeLine{00027\ \textcolor{comment}{//\ DeletedBufferChain\ via\ the\ atomic\ exchange\ operation.\ \ Specifically,\ a}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ pointer\ may\ be\ removed\ from\ the\ head\ of\ the\ chain,\ then\ the\ same\ pointer}}
\DoxyCodeLine{00029\ \textcolor{comment}{//\ reinserted\ in\ the\ chain,\ while\ another\ thread\ is\ waiting;\ and\ that\ thread}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ will\ not\ detect\ the\ change.\ \ So\ instead,\ we\ always\ use\ a\ mutex.}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00033\ \textcolor{comment}{//\ In\ development\ mode,\ we\ define\ USE\_DELETEDCHAINFLAG,\ which\ triggers\ the}}
\DoxyCodeLine{00034\ \textcolor{comment}{//\ piggyback\ of\ an\ additional\ word\ of\ data\ on\ every\ allocated\ block,\ so\ we\ can}}
\DoxyCodeLine{00035\ \textcolor{comment}{//\ ensure\ that\ an\ object\ is\ not\ double-\/deleted\ and\ that\ the\ deleted\ chain}}
\DoxyCodeLine{00036\ \textcolor{comment}{//\ remains\ intact.}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#define\ USE\_DELETEDCHAINFLAG\ 1}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ NDEBUG}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#ifdef\ USE\_DELETEDCHAINFLAG}}
\DoxyCodeLine{00041\ \textcolor{keyword}{enum}\ DeletedChainFlag\ :\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \{}
\DoxyCodeLine{00042\ \ \ DCF\_deleted\ =\ 0xfeedba0f,}
\DoxyCodeLine{00043\ \ \ DCF\_alive\ =\ 0x12487654,}
\DoxyCodeLine{00044\ \};}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00059\ \textcolor{keyword}{class\ }EXPCL\_DTOOL\_DTOOLBASE\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}\ \{}
\DoxyCodeLine{00060\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00061\ \ \ \textcolor{keyword}{constexpr}\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00062\ \ \ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}(\textcolor{keywordtype}{size\_t}\ buffer\_size)\ \textcolor{keyword}{noexcept};}
\DoxyCodeLine{00063\ \ \ INLINE\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}(\mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}\ \&\&from)\ \textcolor{keyword}{noexcept};}
\DoxyCodeLine{00064\ \ \ INLINE\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}\ \&copy);}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \textcolor{keywordtype}{void}\ *allocate(\textcolor{keywordtype}{size\_t}\ size,\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ type\_handle);}
\DoxyCodeLine{00067\ \ \ \textcolor{keywordtype}{void}\ deallocate(\textcolor{keywordtype}{void}\ *ptr,\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ type\_handle);}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ INLINE\ \textcolor{keywordtype}{bool}\ validate(\textcolor{keywordtype}{void}\ *ptr);}
\DoxyCodeLine{00070\ \ \ INLINE\ \textcolor{keywordtype}{size\_t}\ get\_buffer\_size()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ INLINE\ \textcolor{keywordtype}{bool}\ operator\ <\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}\ \&other)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classDeletedBufferChain}{DeletedBufferChain}}\ *get\_deleted\_chain(\textcolor{keywordtype}{size\_t}\ buffer\_size);}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00077\ \ \ \textcolor{keyword}{class\ }ObjectNode\ \{}
\DoxyCodeLine{00078\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#ifdef\ USE\_DELETEDCHAINFLAG}}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{comment}{//\ In\ development\ mode,\ we\ piggyback\ this\ extra\ data.\ \ This\ is\ maintained}}
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{comment}{//\ out-\/of-\/band\ from\ the\ actual\ pointer\ returned,\ so\ we\ can\ safely\ use\ this}}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{//\ flag\ to\ indicate\ the\ difference\ between\ allocated\ and\ freed\ pointers.}}
\DoxyCodeLine{00083\ \ \ \ \ \mbox{\hyperlink{structpatomic}{patomic<DeletedChainFlag>}}\ \_flag;}
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{comment}{//\ This\ pointer\ sits\ within\ the\ buffer,\ in\ the\ same\ space\ referenced\ by}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{//\ the\ actual\ pointer\ returned\ (unlike\ \_flag,\ above).\ \ It's\ only\ used\ when}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{//\ the\ buffer\ is\ deleted,\ so\ there's\ no\ harm\ in\ sharing\ space\ with\ the}}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ undeleted\ buffer.}}
\DoxyCodeLine{00090\ \ \ \ \ ObjectNode\ *\_next;}
\DoxyCodeLine{00091\ \ \ \};}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \textcolor{keyword}{static}\ INLINE\ \textcolor{keywordtype}{void}\ *node\_to\_buffer(ObjectNode\ *node);}
\DoxyCodeLine{00094\ \ \ \textcolor{keyword}{static}\ INLINE\ ObjectNode\ *buffer\_to\_node(\textcolor{keywordtype}{void}\ *buffer);}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ ObjectNode\ *\_deleted\_chain\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \mbox{\hyperlink{classMutexDummyImpl}{MutexImpl}}\ \_lock;}
\DoxyCodeLine{00099\ \ \ \textcolor{keywordtype}{size\_t}\ \_buffer\_size\ =\ 0;}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \textcolor{preprocessor}{\#ifndef\ USE\_DELETEDCHAINFLAG}}
\DoxyCodeLine{00102\ \ \ \textcolor{comment}{//\ Without\ DELETEDCHAINFLAG,\ we\ don't\ even\ store\ the\ \_flag\ member\ at\ all.}}
\DoxyCodeLine{00103\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ flag\_reserved\_bytes\ =\ 0;}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//\ Otherwise,\ we\ need\ space\ for\ the\ integer.}}
\DoxyCodeLine{00107\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ flag\_reserved\_bytes\ =\ \textcolor{keyword}{sizeof}(AtomicAdjust::Integer);}
\DoxyCodeLine{00108\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ USE\_DELETEDCHAINFLAG}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classMemoryHook}{MemoryHook}};}
\DoxyCodeLine{00111\ \};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#include\ "{}deletedBufferChain.I"{}}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
