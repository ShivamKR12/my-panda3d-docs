\doxysection{opus\+Audio\+Cursor.\+cxx}
\hypertarget{opusAudioCursor_8cxx_source}{}\label{opusAudioCursor_8cxx_source}\index{panda/src/movies/opusAudioCursor.cxx@{panda/src/movies/opusAudioCursor.cxx}}
\mbox{\hyperlink{opusAudioCursor_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{opusAudioCursor_8h}{opusAudioCursor.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__movies_8h}{config\_movies.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{opusAudio_8h}{opusAudio.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#ifdef\ HAVE\_OPUS}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <opus/opusfile.h>}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00031\ \textcolor{keywordtype}{int}\ cb\_read(\textcolor{keywordtype}{void}\ *stream,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *ptr,\ \textcolor{keywordtype}{int}\ nbytes)\ \{}
\DoxyCodeLine{00032\ \ \ istream\ *in\ =\ (istream\ *)stream;}
\DoxyCodeLine{00033\ \ \ nassertr(in\ !=\ \textcolor{keyword}{nullptr},\ -\/1);}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ in-\/>read((\textcolor{keywordtype}{char}\ *)ptr,\ nbytes);}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \ \ \textcolor{keywordflow}{if}\ (in-\/>eof())\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \textcolor{comment}{//\ Gracefully\ handle\ EOF.}}
\DoxyCodeLine{00039\ \ \ \ \ in-\/>clear();}
\DoxyCodeLine{00040\ \ \ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \textcolor{keywordflow}{return}\ in-\/>gcount();}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \textcolor{keywordtype}{int}\ cb\_seek(\textcolor{keywordtype}{void}\ *stream,\ opus\_int64\ offset,\ \textcolor{keywordtype}{int}\ whence)\ \{}
\DoxyCodeLine{00046\ \ \ \textcolor{keywordflow}{if}\ (!opus\_enable\_seek)\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00048\ \ \ \}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ istream\ *in\ =\ (istream\ *)stream;}
\DoxyCodeLine{00051\ \ \ nassertr(in\ !=\ \textcolor{keyword}{nullptr},\ -\/1);}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{switch}\ (whence)\ \{}
\DoxyCodeLine{00054\ \ \ \textcolor{keywordflow}{case}\ SEEK\_SET:}
\DoxyCodeLine{00055\ \ \ \ \ in-\/>seekg(offset,\ std::ios::beg);}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \textcolor{keywordflow}{case}\ SEEK\_CUR:}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{comment}{//\ opusfile\ uses\ a\ seek\ with\ offset\ 0\ to\ determine\ whether\ seeking\ is}}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{comment}{//\ supported,\ but\ this\ is\ not\ good\ enough.\ \ We\ seek\ to\ the\ end\ and\ back.}}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keywordflow}{if}\ (offset\ ==\ 0)\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ std::streambuf\ *buf\ =\ in-\/>rdbuf();}
\DoxyCodeLine{00063\ \ \ \ \ \ \ std::streampos\ pos\ =\ buf-\/>pubseekoff(0,\ std::ios::cur,\ std::ios::in);}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pos\ <\ 0)\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (buf-\/>pubseekoff(0,\ std::ios::end,\ std::ios::in)\ >=\ 0)\ \{}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ It\ worked;\ seek\ back\ to\ the\ previous\ location.}}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ buf-\/>pubseekpos(pos,\ std::ios::in);}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00074\ \ \ \ \ \}}
\DoxyCodeLine{00075\ \ \ \ \ in-\/>seekg(offset,\ std::ios::cur);}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{case}\ SEEK\_END:}
\DoxyCodeLine{00079\ \ \ \ \ in-\/>seekg(offset,\ std::ios::end);}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00083\ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00084\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Illegal\ parameter\ to\ seek\ in\ cb\_seek\(\backslash\)n"{}};}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00086\ \ \ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{if}\ (in-\/>fail())\ \{}
\DoxyCodeLine{00089\ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00090\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failure\ to\ seek\ to\ byte\ "{}}\ <<\ offset;}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordflow}{switch}\ (whence)\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{case}\ SEEK\_CUR:}
\DoxyCodeLine{00094\ \ \ \ \ \ \ movies\_cat.error(\textcolor{keyword}{false})}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ from\ current\ location!\(\backslash\)n"{}};}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keywordflow}{case}\ SEEK\_END:}
\DoxyCodeLine{00099\ \ \ \ \ \ \ movies\_cat.error(\textcolor{keyword}{false})}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ from\ end\ of\ file!\(\backslash\)n"{}};}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00104\ \ \ \ \ \ \ movies\_cat.error(\textcolor{keyword}{false})\ <<\ \textcolor{stringliteral}{"{}!\(\backslash\)n"{}};}
\DoxyCodeLine{00105\ \ \ \ \ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00111\ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ opus\_int64\ cb\_tell(\textcolor{keywordtype}{void}\ *stream)\ \{}
\DoxyCodeLine{00114\ \ \ istream\ *in\ =\ (istream\ *)stream;}
\DoxyCodeLine{00115\ \ \ nassertr(in\ !=\ \textcolor{keyword}{nullptr},\ -\/1);}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{return}\ in-\/>tellg();}
\DoxyCodeLine{00118\ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ OpusFileCallbacks\ callbacks\ =\ \{cb\_read,\ cb\_seek,\ cb\_tell,\ \textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ OpusAudioCursor::\_type\_handle;}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00128\ OpusAudioCursor::}
\DoxyCodeLine{00129\ OpusAudioCursor(OpusAudio\ *src,\ istream\ *stream)\ :}
\DoxyCodeLine{00130\ \ \ \mbox{\hyperlink{classMovieAudioCursor}{MovieAudioCursor}}(src),}
\DoxyCodeLine{00131\ \ \ \_is\_valid(false),}
\DoxyCodeLine{00132\ \ \ \_stream(stream),}
\DoxyCodeLine{00133\ \ \ \_link(0)}
\DoxyCodeLine{00134\ \{}
\DoxyCodeLine{00135\ \ \ nassertv(stream\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00136\ \ \ nassertv(stream-\/>good());}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \textcolor{keywordtype}{int}\ error\ =\ 0;}
\DoxyCodeLine{00139\ \ \ \_op\ =\ op\_open\_callbacks((\textcolor{keywordtype}{void}\ *)stream,\ \&callbacks,\ \textcolor{keyword}{nullptr},\ 0,\ \&error);}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{if}\ (\_op\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00141\ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00142\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ read\ Opus\ file\ (error\ code\ "{}}\ <<\ error\ <<\ \textcolor{stringliteral}{"{}).\(\backslash\)n"{}};}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00144\ \ \ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ ogg\_int64\_t\ samples\ =\ op\_pcm\_total(\_op,\ -\/1);}
\DoxyCodeLine{00147\ \ \ \textcolor{keywordflow}{if}\ (samples\ !=\ OP\_EINVAL)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{comment}{//\ Opus\ timestamps\ are\ fixed\ at\ 48\ kHz.}}
\DoxyCodeLine{00149\ \ \ \ \ \_length\ =\ (double)samples\ /\ 48000.0;}
\DoxyCodeLine{00150\ \ \ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \_audio\_channels\ =\ op\_channel\_count(\_op,\ -\/1);}
\DoxyCodeLine{00153\ \ \ \_audio\_rate\ =\ 48000;}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \_can\_seek\ =\ opus\_enable\_seek\ \&\&\ op\_seekable(\_op);}
\DoxyCodeLine{00156\ \ \ \_can\_seek\_fast\ =\ \_can\_seek;}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00159\ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00164\ OpusAudioCursor::}
\DoxyCodeLine{00165\ \string~OpusAudioCursor()\ \{}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordflow}{if}\ (\_op\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00167\ \ \ \ \ op\_free(\_op);}
\DoxyCodeLine{00168\ \ \ \ \ \_op\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00169\ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{if}\ (\_stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00172\ \ \ \ \ VirtualFileSystem::close\_read\_file(\_stream);}
\DoxyCodeLine{00173\ \ \ \ \ \_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00174\ \ \ \}}
\DoxyCodeLine{00175\ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00181\ \textcolor{keywordtype}{void}\ OpusAudioCursor::}
\DoxyCodeLine{00182\ seek(\textcolor{keywordtype}{double}\ t)\ \{}
\DoxyCodeLine{00183\ \ \ \textcolor{keywordflow}{if}\ (!opus\_enable\_seek)\ \{}
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00185\ \ \ \}}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ t\ =\ std::max(t,\ 0.0);}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \textcolor{comment}{//\ Use\ op\_time\_seek\_lap\ if\ cross-\/lapping\ is\ enabled.}}
\DoxyCodeLine{00190\ \ \ ogg\_int64\_t\ sample\ =\ (ogg\_int64\_t)(t\ *\ 48000.0);}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordtype}{int}\ error\ =\ op\_pcm\_seek(\_op,\ sample);}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \textcolor{comment}{//\ Special\ case\ for\ seeking\ to\ the\ beginning;\ if\ normal\ seek\ fails,\ we\ may}}
\DoxyCodeLine{00194\ \ \ \textcolor{comment}{//\ be\ able\ to\ explicitly\ seek\ to\ the\ beginning\ of\ the\ file\ and\ call\ op\_open}}
\DoxyCodeLine{00195\ \ \ \textcolor{comment}{//\ again.\ \ This\ allows\ looping\ compressed\ .opus\ files.}}
\DoxyCodeLine{00196\ \ \ \textcolor{keywordflow}{if}\ (error\ ==\ OP\_ENOSEEK\ \&\&\ sample\ ==\ 0)\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_stream-\/>rdbuf()-\/>pubseekpos(0,\ std::ios::in)\ ==\ (std::streampos)0)\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ OggOpusFile\ *op\ =\ op\_open\_callbacks((\textcolor{keywordtype}{void}\ *)\_stream,\ \&callbacks,\ \textcolor{keyword}{nullptr},\ 0,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (op\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ op\_free(\_op);}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \_op\ =\ op;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ reopen\ Opus\ file\ to\ seek\ to\ beginning.\(\backslash\)n"{}};}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \ \ \ \ \textcolor{comment}{//\ Reset\ this\ field\ for\ good\ measure,\ just\ in\ case\ this\ changed.}}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \_audio\_channels\ =\ op\_channel\_count(\_op,\ -\/1);}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \ \ \ \ \_last\_seek\ =\ 0.0;}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \_samples\_read\ =\ 0;}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00214\ \ \ \ \ \}}
\DoxyCodeLine{00215\ \ \ \}}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{if}\ (error\ !=\ 0)\ \{}
\DoxyCodeLine{00217\ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00218\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Seek\ failed\ (error\ "{}}\ <<\ error\ <<\ \textcolor{stringliteral}{"{}).\ \ Opus\ stream\ may\ not\ be\ seekable.\(\backslash\)n"{}};}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00220\ \ \ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \ \ \_last\_seek\ =\ op\_pcm\_tell(\_op)\ /\ 48000.0;}
\DoxyCodeLine{00223\ \ \ \_samples\_read\ =\ 0;}
\DoxyCodeLine{00224\ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00231\ \textcolor{keywordtype}{int}\ OpusAudioCursor::}
\DoxyCodeLine{00232\ read\_samples(\textcolor{keywordtype}{int}\ n,\ int16\_t\ *data)\ \{}
\DoxyCodeLine{00233\ \ \ int16\_t\ *end\ =\ data\ +\ (n\ *\ \_audio\_channels);}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ \textcolor{keywordflow}{while}\ (data\ <\ end)\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \textcolor{comment}{//\ op\_read\ gives\ it\ to\ us\ in\ the\ exact\ format\ we\ need.\ \ Nifty!}}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordtype}{int}\ link;}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordtype}{int}\ read\_samples\ =\ op\_read(\_op,\ data,\ end\ -\/\ data,\ \&link);}
\DoxyCodeLine{00239\ \ \ \ \ \textcolor{keywordflow}{if}\ (read\_samples\ >\ 0)\ \{}
\DoxyCodeLine{00240\ \ \ \ \ \ \ data\ +=\ read\_samples\ *\ \_audio\_channels;}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \_samples\_read\ +=\ read\_samples;}
\DoxyCodeLine{00242\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (read\_samples\ ==\ 0\ \&\&\ \_length\ ==\ 1.0E10)\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \_length\ =\ op\_pcm\_tell(\_op)\ /\ 48000.0;}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00247\ \ \ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_link\ !=\ link)\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \textcolor{comment}{//\ It\ is\ technically\ possible\ for\ it\ to\ change\ parameters\ from\ one\ link}}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \textcolor{comment}{//\ to\ the\ next.\ \ However,\ we\ don't\ offer\ this\ flexibility.}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ channels\ =\ op\_channel\_count(\_op,\ link);}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (channels\ !=\ \_audio\_channels)\ \{}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ movies\_cat.error()}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Opus\ file\ has\ inconsistent\ channel\ count!\(\backslash\)n"{}};}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We'll\ change\ it\ anyway.\ \ Not\ sure\ what\ happens\ next.}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \_audio\_channels\ =\ channels;}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \ \ \ \ \_link\ =\ link;}
\DoxyCodeLine{00262\ \ \ \ \ \}}
\DoxyCodeLine{00263\ \ \ \}}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \textcolor{comment}{//\ Fill\ the\ rest\ of\ the\ buffer\ with\ silence.}}
\DoxyCodeLine{00266\ \ \ \textcolor{keywordflow}{if}\ (data\ <\ end)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ memset(data,\ 0,\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)end\ -\/\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)data);}
\DoxyCodeLine{00268\ \ \ \ \ n\ -\/=\ (end\ -\/\ data)\ /\ \_audio\_channels;}
\DoxyCodeLine{00269\ \ \ \}}
\DoxyCodeLine{00270\ \ \ \textcolor{keywordflow}{return}\ n;}
\DoxyCodeLine{00271\ \}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_OPUS}}

\end{DoxyCode}
