\doxysection{x\+File.\+cxx}
\hypertarget{xFile_8cxx_source}{}\label{xFile_8cxx_source}\index{pandatool/src/xfile/xFile.cxx@{pandatool/src/xfile/xFile.cxx}}
\mbox{\hyperlink{xFile_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFile_8h}{xFile.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xParserDefs_8h}{xParserDefs.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xLexerDefs_8h}{xLexerDefs.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFileTemplate_8h}{xFileTemplate.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFileDataNodeTemplate_8h}{xFileDataNodeTemplate.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__xfile_8h}{config\_xfile.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{standard__templates_8h}{standard\_templates.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{zStream_8h}{zStream.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dcast_8h}{dcast.h}}"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00026\ \textcolor{keyword}{using\ }\mbox{\hyperlink{classstd_1_1istringstream}{std::istringstream}};}
\DoxyCodeLine{00027\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00028\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ XFile::\_type\_handle;}
\DoxyCodeLine{00031\ PT(\mbox{\hyperlink{classXFile}{XFile}})\ XFile::\_standard\_templates;}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00036\ XFile::}
\DoxyCodeLine{00037\ XFile(\textcolor{keywordtype}{bool}\ keep\_names)\ :\ \mbox{\hyperlink{classXFileNode}{XFileNode}}(this)\ \{}
\DoxyCodeLine{00038\ \ \ \_major\_version\ =\ 3;}
\DoxyCodeLine{00039\ \ \ \_minor\_version\ =\ 2;}
\DoxyCodeLine{00040\ \ \ \_format\_type\ =\ FT\_text;}
\DoxyCodeLine{00041\ \ \ \_float\_size\ =\ FS\_64;}
\DoxyCodeLine{00042\ \ \ \_keep\_names\ =\ keep\_names;}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00048\ XFile::}
\DoxyCodeLine{00049\ \string~XFile()\ \{}
\DoxyCodeLine{00050\ \ \ \mbox{\hyperlink{classXFile_abf2e7917c4b194e556d329a7822e8b66}{clear}}();}
\DoxyCodeLine{00051\ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00057\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classXFile_abf2e7917c4b194e556d329a7822e8b66}{XFile::}}}
\DoxyCodeLine{00058\ \mbox{\hyperlink{classXFile_abf2e7917c4b194e556d329a7822e8b66}{clear}}()\ \{}
\DoxyCodeLine{00059\ \ \ \mbox{\hyperlink{classXFileNode_a980dd503dee6fe2da02f2a4c7e27fe4a}{XFileNode::clear}}();}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \_nodes\_by\_guid.clear();}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00072\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFile_a5480f143a7d9ac3c64f3c60403b72904}{XFile::}}}
\DoxyCodeLine{00073\ \mbox{\hyperlink{classXFile_a5480f143a7d9ac3c64f3c60403b72904}{read}}(\mbox{\hyperlink{classFilename}{Filename}}\ filename)\ \{}
\DoxyCodeLine{00074\ \ \ filename.set\_text();}
\DoxyCodeLine{00075\ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{00076\ \ \ istream\ *in\ =\ vfs-\/>open\_read\_file(filename,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00077\ \ \ \textcolor{keywordflow}{if}\ (in\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00078\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00079\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cannot\ open\ "{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\ for\ reading.\(\backslash\)n"{}};}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00081\ \ \ \}}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordtype}{bool}\ okflag\ =\ \mbox{\hyperlink{classXFile_a5480f143a7d9ac3c64f3c60403b72904}{read}}(*in,\ filename);}
\DoxyCodeLine{00083\ \ \ vfs-\/>close\_read\_file(in);}
\DoxyCodeLine{00084\ \ \ \textcolor{keywordflow}{return}\ okflag;}
\DoxyCodeLine{00085\ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00097\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFile_a5480f143a7d9ac3c64f3c60403b72904}{XFile::}}}
\DoxyCodeLine{00098\ \mbox{\hyperlink{classXFile_a5480f143a7d9ac3c64f3c60403b72904}{read}}(istream\ \&in,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&filename)\ \{}
\DoxyCodeLine{00099\ \ \ \textcolor{keywordflow}{if}\ (!read\_header(in))\ \{}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00101\ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{keywordflow}{if}\ (\_format\_type\ !=\ FT\_text)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{comment}{//\ Does\ anyone\ actually\ use\ the\ binary\ format?\ \ It\ wouldn't\ be\ too\ hard\ to}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{comment}{//\ support\ it\ if\ there\ were\ any\ reason\ at\ all\ to\ do\ so.}}
\DoxyCodeLine{00106\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00107\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cannot\ read\ binary\ .x\ files\ at\ this\ time.\(\backslash\)n"{}};}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00109\ \ \ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \textcolor{comment}{//\ We\ must\ call\ this\ first\ so\ the\ standard\ templates\ file\ will\ be\ parsed\ and}}
\DoxyCodeLine{00112\ \ \ \textcolor{comment}{//\ available\ by\ the\ time\ we\ need\ it-\/-\/it's\ tricky\ to\ invoke\ the\ parser\ from}}
\DoxyCodeLine{00113\ \ \ \textcolor{comment}{//\ within\ another\ parser\ instance.}}
\DoxyCodeLine{00114\ \ \ get\_standard\_templates();}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ x\_init\_parser(in,\ filename,\ *\textcolor{keyword}{this});}
\DoxyCodeLine{00117\ \ \ xyyparse();}
\DoxyCodeLine{00118\ \ \ x\_cleanup\_parser();}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \textcolor{keywordflow}{return}\ (x\_error\_count()\ ==\ 0);}
\DoxyCodeLine{00121\ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00129\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{XFile::}}}
\DoxyCodeLine{00130\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{write}}(\mbox{\hyperlink{classFilename}{Filename}}\ filename)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00131\ \ \ std::ofstream\ out;}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{comment}{//\ We\ actually\ open\ the\ file\ to\ write\ in\ binary\ mode,\ to\ avoid\ the\ MS-\/DOS}}
\DoxyCodeLine{00134\ \ \ \textcolor{comment}{//\ newline\ characters\ (since\ Windows\ seems\ to\ do\ this\ too).}}
\DoxyCodeLine{00135\ \ \ filename.set\_binary();}
\DoxyCodeLine{00136\ \ \ filename.\mbox{\hyperlink{classFilename_ad37a9d52c837218b01076de184dc5f4d}{open\_write}}(out);}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{if}\ (!out)\ \{}
\DoxyCodeLine{00139\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00140\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Can't\ open\ "{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\ for\ output.\(\backslash\)n"{}};}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00142\ \ \ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{00145\ \ \ \textcolor{keywordflow}{if}\ (filename.get\_extension()\ ==\ \textcolor{stringliteral}{"{}pz"{}})\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ The\ filename\ ends\ in\ .pz,\ which\ means\ to\ automatically\ compress\ the\ X}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{comment}{//\ file\ that\ we\ write.}}
\DoxyCodeLine{00148\ \ \ \ \ OCompressStream\ compressor(\&out,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{write}}(compressor);}
\DoxyCodeLine{00150\ \ \ \}}
\DoxyCodeLine{00151\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_ZLIB}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{write}}(out);}
\DoxyCodeLine{00154\ \}}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00162\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{XFile::}}}
\DoxyCodeLine{00163\ \mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{write}}(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordflow}{if}\ (!write\_header(out))\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00166\ \ \ \}}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \mbox{\hyperlink{classXFile_ad69eb2922d3b49c082146cd03010ccff}{write\_text}}(out,\ 0);}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00171\ \}}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00177\ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{XFile::}}}
\DoxyCodeLine{00178\ \mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00179\ \ \ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *standard\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00180\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classXFile}{XFile}}\ *standard\_templates\ =\ get\_standard\_templates();}
\DoxyCodeLine{00181\ \ \ \textcolor{keywordflow}{if}\ (standard\_templates\ !=\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00182\ \ \ \ \ standard\ =\ standard\_templates-\/>\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(name);}
\DoxyCodeLine{00183\ \ \ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *child\ =\ \mbox{\hyperlink{classXFileNode_a9028e5ef50b4c1dcb570de7a20604eda}{find\_child}}(name);}
\DoxyCodeLine{00186\ \ \ \textcolor{keywordflow}{if}\ (child\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00187\ \ \ \ \ \ \ child-\/>is\_of\_type(XFileTemplate::get\_class\_type()))\ \{}
\DoxyCodeLine{00188\ \ \ \ \ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *xtemplate\ =\ DCAST(\mbox{\hyperlink{classXFileTemplate}{XFileTemplate}},\ child);}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordflow}{if}\ (standard\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ xtemplate-\/>\mbox{\hyperlink{classXFileTemplate_a27781168fef77ea1336a9f52c08ab899}{matches}}(standard))\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ template\ matches\ a\ standard\ template,\ return\ the\ standard}}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \textcolor{comment}{//\ instead.\ \ The\ assumption\ is\ that\ code\ may\ expect\ a\ certain\ naming}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \textcolor{comment}{//\ scheme\ for\ the\ data\ elements\ of\ the\ standard\ template,\ so\ we\ want\ to}}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \textcolor{comment}{//\ be\ sure\ to\ provide\ it.}}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ standard;}
\DoxyCodeLine{00195\ \ \ \ \ \}}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{keywordflow}{return}\ xtemplate;}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{return}\ standard;}
\DoxyCodeLine{00200\ \}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00206\ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{XFile::}}}
\DoxyCodeLine{00207\ \mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classWindowsGuid}{WindowsGuid}}\ \&guid)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00208\ \ \ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *standard\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00209\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classXFile}{XFile}}\ *standard\_templates\ =\ get\_standard\_templates();}
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{if}\ (standard\_templates\ !=\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00211\ \ \ \ \ standard\ =\ standard\_templates-\/>\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(guid);}
\DoxyCodeLine{00212\ \ \ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ NodesByGuid::const\_iterator\ gi;}
\DoxyCodeLine{00215\ \ \ gi\ =\ \_nodes\_by\_guid.find(guid);}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{if}\ (gi\ !=\ \_nodes\_by\_guid.end()\ \&\&}
\DoxyCodeLine{00217\ \ \ \ \ \ \ (*gi).second-\/>is\_of\_type(XFileTemplate::get\_class\_type()))\ \{}
\DoxyCodeLine{00218\ \ \ \ \ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *xtemplate\ =\ DCAST(\mbox{\hyperlink{classXFileTemplate}{XFileTemplate}},\ (*gi).second);}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordflow}{if}\ (standard\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ xtemplate-\/>\mbox{\hyperlink{classXFileTemplate_a27781168fef77ea1336a9f52c08ab899}{matches}}(standard))\ \{}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ template\ matches\ a\ standard\ template,\ return\ the\ standard}}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \textcolor{comment}{//\ instead.\ \ The\ assumption\ is\ that\ code\ may\ expect\ a\ certain\ naming}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \textcolor{comment}{//\ scheme\ for\ the\ data\ elements\ of\ the\ standard\ template,\ so\ we\ want\ to}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \textcolor{comment}{//\ be\ sure\ to\ provide\ it.}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ standard;}
\DoxyCodeLine{00225\ \ \ \ \ \}}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordflow}{return}\ xtemplate;}
\DoxyCodeLine{00227\ \ \ \}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \textcolor{keywordflow}{return}\ standard;}
\DoxyCodeLine{00230\ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00236\ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *\mbox{\hyperlink{classXFile_a8f3b8166b239ff64e5b4a87cb75ea679}{XFile::}}}
\DoxyCodeLine{00237\ \mbox{\hyperlink{classXFile_a8f3b8166b239ff64e5b4a87cb75ea679}{find\_standard\_template}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\ \{}
\DoxyCodeLine{00238\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classXFile}{XFile}}\ *standard\_templates\ =\ get\_standard\_templates();}
\DoxyCodeLine{00239\ \ \ \textcolor{keywordflow}{return}\ standard\_templates-\/>\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(name);}
\DoxyCodeLine{00240\ \}}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00246\ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *\mbox{\hyperlink{classXFile_a8f3b8166b239ff64e5b4a87cb75ea679}{XFile::}}}
\DoxyCodeLine{00247\ \mbox{\hyperlink{classXFile_a8f3b8166b239ff64e5b4a87cb75ea679}{find\_standard\_template}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classWindowsGuid}{WindowsGuid}}\ \&guid)\ \{}
\DoxyCodeLine{00248\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classXFile}{XFile}}\ *standard\_templates\ =\ get\_standard\_templates();}
\DoxyCodeLine{00249\ \ \ \textcolor{keywordflow}{return}\ standard\_templates-\/>\mbox{\hyperlink{classXFile_ab92f45661b0140bf7b2b1344fd0c72a0}{find\_template}}(guid);}
\DoxyCodeLine{00250\ \}}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00256\ \mbox{\hyperlink{classXFileDataNodeTemplate}{XFileDataNodeTemplate}}\ *\mbox{\hyperlink{classXFile_ad75e73a0ccd3f7839051d51de60a5918}{XFile::}}}
\DoxyCodeLine{00257\ \mbox{\hyperlink{classXFile_ad75e73a0ccd3f7839051d51de60a5918}{find\_data\_object}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00258\ \ \ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *child\ =\ \mbox{\hyperlink{classXFileNode_a03d9a28a9be069a33084210d1a4b805d}{find\_descendent}}(name);}
\DoxyCodeLine{00259\ \ \ \textcolor{keywordflow}{if}\ (child\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00260\ \ \ \ \ \ \ child-\/>is\_of\_type(XFileDataNodeTemplate::get\_class\_type()))\ \{}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{keywordflow}{return}\ DCAST(\mbox{\hyperlink{classXFileDataNodeTemplate}{XFileDataNodeTemplate}},\ child);}
\DoxyCodeLine{00262\ \ \ \}}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00265\ \}}
\DoxyCodeLine{00266\ }
\DoxyCodeLine{00271\ \mbox{\hyperlink{classXFileDataNodeTemplate}{XFileDataNodeTemplate}}\ *\mbox{\hyperlink{classXFile_ad75e73a0ccd3f7839051d51de60a5918}{XFile::}}}
\DoxyCodeLine{00272\ \mbox{\hyperlink{classXFile_ad75e73a0ccd3f7839051d51de60a5918}{find\_data\_object}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classWindowsGuid}{WindowsGuid}}\ \&guid)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00273\ \ \ NodesByGuid::const\_iterator\ gi;}
\DoxyCodeLine{00274\ \ \ gi\ =\ \_nodes\_by\_guid.find(guid);}
\DoxyCodeLine{00275\ \ \ \textcolor{keywordflow}{if}\ (gi\ !=\ \_nodes\_by\_guid.end()\ \&\&}
\DoxyCodeLine{00276\ \ \ \ \ \ \ (*gi).second-\/>is\_of\_type(XFileDataNodeTemplate::get\_class\_type()))\ \{}
\DoxyCodeLine{00277\ \ \ \ \ \textcolor{keywordflow}{return}\ DCAST(\mbox{\hyperlink{classXFileDataNodeTemplate}{XFileDataNodeTemplate}},\ (*gi).second);}
\DoxyCodeLine{00278\ \ \ \}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00281\ \}}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00286\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classXFile_ad69eb2922d3b49c082146cd03010ccff}{XFile::}}}
\DoxyCodeLine{00287\ \mbox{\hyperlink{classXFile_ad69eb2922d3b49c082146cd03010ccff}{write\_text}}(ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00288\ \ \ Children::const\_iterator\ ci;}
\DoxyCodeLine{00289\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_children.begin();\ ci\ !=\ \_children.end();\ ++ci)\ \{}
\DoxyCodeLine{00290\ \ \ \ \ (*ci)-\/>write\_text(out,\ indent\_level);}
\DoxyCodeLine{00291\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00292\ \ \ \}}
\DoxyCodeLine{00293\ \}}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00299\ \textcolor{keywordtype}{bool}\ XFile::}
\DoxyCodeLine{00300\ read\_header(istream\ \&in)\ \{}
\DoxyCodeLine{00301\ \ \ \textcolor{keywordtype}{char}\ magic[4];}
\DoxyCodeLine{00302\ \ \ \textcolor{keywordflow}{if}\ (!in.read(magic,\ 4))\ \{}
\DoxyCodeLine{00303\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00304\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Empty\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00306\ \ \ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \ \ \textcolor{keywordflow}{if}\ (memcmp(magic,\ \textcolor{stringliteral}{"{}xof\ "{}},\ 4)\ !=\ 0)\ \{}
\DoxyCodeLine{00309\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00310\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Not\ a\ DirectX\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00312\ \ \ \}}
\DoxyCodeLine{00313\ }
\DoxyCodeLine{00314\ \ \ \textcolor{keywordtype}{char}\ version[4];}
\DoxyCodeLine{00315\ \ \ \textcolor{keywordflow}{if}\ (!in.read(version,\ 4))\ \{}
\DoxyCodeLine{00316\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00317\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Truncated\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00318\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00319\ \ \ \}}
\DoxyCodeLine{00320\ \ \ \_major\_version\ =\ (version[0]\ -\/\ \textcolor{charliteral}{'0'})\ *\ 10\ +\ (version[1]\ -\/\ \textcolor{charliteral}{'0'});}
\DoxyCodeLine{00321\ \ \ \_minor\_version\ =\ (version[2]\ -\/\ \textcolor{charliteral}{'0'})\ *\ 10\ +\ (version[3]\ -\/\ \textcolor{charliteral}{'0'});}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ \textcolor{keywordtype}{char}\ format[4];}
\DoxyCodeLine{00324\ \ \ \textcolor{keywordflow}{if}\ (!in.read(format,\ 4))\ \{}
\DoxyCodeLine{00325\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00326\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Truncated\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00328\ \ \ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \textcolor{keywordflow}{if}\ (memcmp(format,\ \textcolor{stringliteral}{"{}txt\ "{}},\ 4)\ ==\ 0)\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \_format\_type\ =\ FT\_text;}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (memcmp(format,\ \textcolor{stringliteral}{"{}bin\ "{}},\ 4)\ ==\ 0)\ \{}
\DoxyCodeLine{00334\ \ \ \ \ \_format\_type\ =\ FT\_binary;}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (memcmp(format,\ \textcolor{stringliteral}{"{}com\ "{}},\ 4)\ ==\ 0)\ \{}
\DoxyCodeLine{00337\ \ \ \ \ \_format\_type\ =\ FT\_compressed;}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00340\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00341\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unknown\ format\ type:\ "{}}\ <<\ string(format,\ 4)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00343\ \ \ \}}
\DoxyCodeLine{00344\ }
\DoxyCodeLine{00345\ \ \ \textcolor{keywordflow}{if}\ (\_format\_type\ ==\ FT\_compressed)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{comment}{//\ Read\ and\ ignore\ the\ compression\ type,\ since\ we\ don't\ support}}
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{comment}{//\ compression\ anyway.}}
\DoxyCodeLine{00348\ \ \ \ \ \textcolor{keywordtype}{char}\ compression\_type[4];}
\DoxyCodeLine{00349\ \ \ \ \ in.read(compression\_type,\ 4);}
\DoxyCodeLine{00350\ \ \ \}}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00352\ \ \ \textcolor{keywordtype}{char}\ float\_size[4];}
\DoxyCodeLine{00353\ \ \ \textcolor{keywordflow}{if}\ (!in.read(float\_size,\ 4))\ \{}
\DoxyCodeLine{00354\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00355\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Truncated\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00357\ \ \ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{if}\ (memcmp(float\_size,\ \textcolor{stringliteral}{"{}0032"{}},\ 4)\ ==\ 0)\ \{}
\DoxyCodeLine{00360\ \ \ \ \ \_float\_size\ =\ FS\_32;}
\DoxyCodeLine{00361\ }
\DoxyCodeLine{00362\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (memcmp(float\_size,\ \textcolor{stringliteral}{"{}0064"{}},\ 4)\ ==\ 0)\ \{}
\DoxyCodeLine{00363\ \ \ \ \ \_float\_size\ =\ FS\_64;}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00366\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00367\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unknown\ float\ size:\ "{}}\ <<\ string(float\_size,\ 4)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00369\ \ \ \}}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00372\ \}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00378\ \textcolor{keywordtype}{bool}\ XFile::}
\DoxyCodeLine{00379\ write\_header(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00380\ \ \ out.write(\textcolor{stringliteral}{"{}xof\ "{}},\ 4);}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ \textcolor{keywordtype}{char}\ buffer[128];}
\DoxyCodeLine{00383\ \ \ sprintf(buffer,\ \textcolor{stringliteral}{"{}\%02d\%02d"{}},\ \_major\_version,\ \_minor\_version);}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordflow}{if}\ (strlen(buffer)\ !=\ 4)\ \{}
\DoxyCodeLine{00385\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00386\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ version:\ "{}}\ <<\ \_major\_version\ <<\ \textcolor{stringliteral}{"{}."{}}\ <<\ \_minor\_version}
\DoxyCodeLine{00387\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00389\ \ \ \}}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ out.write(buffer,\ 4);}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \ \ \textcolor{keywordflow}{switch}\ (\_format\_type)\ \{}
\DoxyCodeLine{00394\ \ \ \textcolor{keywordflow}{case}\ FT\_text:}
\DoxyCodeLine{00395\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}txt\ "{}},\ 4);}
\DoxyCodeLine{00396\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \ \ \textcolor{keywordflow}{case}\ FT\_binary:}
\DoxyCodeLine{00399\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}bin\ "{}},\ 4);}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \ \ \textcolor{keywordflow}{case}\ FT\_compressed:}
\DoxyCodeLine{00403\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}cmp\ "{}},\ 4);}
\DoxyCodeLine{00404\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00405\ }
\DoxyCodeLine{00406\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00407\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00408\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ format\ type:\ "{}}\ <<\ \_format\_type\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00410\ \ \ \}}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00412\ \ \ \textcolor{keywordflow}{if}\ (\_format\_type\ ==\ FT\_compressed)\ \{}
\DoxyCodeLine{00413\ \ \ \ \ \textcolor{comment}{//\ Write\ a\ bogus\ compression\ type,\ just\ so\ we\ have\ a\ valid\ header.}}
\DoxyCodeLine{00414\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}xxx\ "{}},\ 4);}
\DoxyCodeLine{00415\ \ \ \}}
\DoxyCodeLine{00416\ }
\DoxyCodeLine{00417\ \ \ \textcolor{keywordflow}{switch}\ (\_float\_size)\ \{}
\DoxyCodeLine{00418\ \ \ \textcolor{keywordflow}{case}\ FS\_32:}
\DoxyCodeLine{00419\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}0032"{}},\ 4);}
\DoxyCodeLine{00420\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \textcolor{keywordflow}{case}\ FS\_64:}
\DoxyCodeLine{00423\ \ \ \ \ out.write(\textcolor{stringliteral}{"{}0064"{}},\ 4);}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00427\ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00428\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ float\ size:\ "{}}\ <<\ \_float\_size\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00429\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00430\ \ \ \}}
\DoxyCodeLine{00431\ }
\DoxyCodeLine{00432\ \ \ \textcolor{keywordflow}{if}\ (\_format\_type\ ==\ FT\_text)\ \{}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ If\ it's\ a\ text\ format,\ we\ can\ now\ write\ a\ newline.}}
\DoxyCodeLine{00434\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00435\ \ \ \}}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00438\ \}}
\DoxyCodeLine{00439\ }
\DoxyCodeLine{00444\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classXFile}{XFile}}\ *XFile::}
\DoxyCodeLine{00445\ get\_standard\_templates()\ \{}
\DoxyCodeLine{00446\ \ \ \textcolor{keywordflow}{if}\ (\_standard\_templates\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{comment}{//\ The\ standardTemplates.x\ file\ has\ been\ compiled\ into\ this\ binary.}}
\DoxyCodeLine{00448\ \ \ \ \ \textcolor{comment}{//\ Extract\ it\ out.}}
\DoxyCodeLine{00449\ }
\DoxyCodeLine{00450\ \ \ \ \ \textcolor{keywordtype}{string}\ data((\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *)standard\_templates\_data,\ standard\_templates\_data\_len);}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{comment}{//\ The\ data\ is\ stored\ compressed;\ decompress\ it\ on-\/the-\/fly.}}
\DoxyCodeLine{00454\ \ \ \ \ \mbox{\hyperlink{classstd_1_1istringstream}{istringstream}}\ inz(data);}
\DoxyCodeLine{00455\ \ \ \ \ IDecompressStream\ in(\&inz,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00458\ \ \ \ \ \textcolor{comment}{//\ The\ data\ is\ stored\ uncompressed,\ so\ just\ load\ it.}}
\DoxyCodeLine{00459\ \ \ \ \ \mbox{\hyperlink{classstd_1_1istringstream}{istringstream}}\ in(data);}
\DoxyCodeLine{00460\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_ZLIB}}
\DoxyCodeLine{00461\ }
\DoxyCodeLine{00462\ \ \ \ \ \_standard\_templates\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classXFile}{XFile}};}
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_standard\_templates-\/>read(in,\ \textcolor{stringliteral}{"{}standardTemplates.x"{}}))\ \{}
\DoxyCodeLine{00464\ \ \ \ \ \ \ xfile\_cat.error()}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Internal\ error:\ Unable\ to\ parse\ built-\/in\ standardTemplates.x!\(\backslash\)n"{}};}
\DoxyCodeLine{00466\ \ \ \ \ \}}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00468\ \ \ \ \ \textcolor{comment}{//\ Now\ flag\ all\ of\ these\ templates\ as\ "{}standard"{}.}}
\DoxyCodeLine{00469\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ \_standard\_templates-\/>get\_num\_children();\ i++)\ \{}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *child\ =\ \_standard\_templates-\/>get\_child(i);}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (child-\/>is\_of\_type(XFileTemplate::get\_class\_type()))\ \{}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classXFileTemplate}{XFileTemplate}}\ *xtemplate\ =\ DCAST(\mbox{\hyperlink{classXFileTemplate}{XFileTemplate}},\ child);}
\DoxyCodeLine{00473\ \ \ \ \ \ \ \ \ xtemplate-\/>\_is\_standard\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00474\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00475\ \ \ \ \ \}}
\DoxyCodeLine{00476\ \ \ \}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \ \ \textcolor{keywordflow}{return}\ \_standard\_templates;}
\DoxyCodeLine{00479\ \}}

\end{DoxyCode}
