\doxysection{prc\+Key\+Registry.\+cxx}
\hypertarget{prcKeyRegistry_8cxx_source}{}\label{prcKeyRegistry_8cxx_source}\index{dtool/src/prc/prcKeyRegistry.cxx@{dtool/src/prc/prcKeyRegistry.cxx}}
\mbox{\hyperlink{prcKeyRegistry_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{prcKeyRegistry_8h}{prcKeyRegistry.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__prc_8h}{config\_prc.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{comment}{//\ This\ file\ requires\ OpenSSL\ to\ compile,\ because\ we\ use\ routines\ in\ the}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ OpenSSL\ library\ to\ manage\ keys\ and\ to\ sign\ and\ validate\ signatures.}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifdef\ HAVE\_OPENSSL}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ <openssl/evp.h>}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <openssl/pem.h>}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{comment}{//\ Some\ versions\ of\ OpenSSL\ appear\ to\ define\ this\ as\ a\ macro.\ \ Yucky.}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#undef\ set\_key}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ PrcKeyRegistry\ *PrcKeyRegistry::\_global\_ptr\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00034\ PrcKeyRegistry::}
\DoxyCodeLine{00035\ PrcKeyRegistry()\ \{}
\DoxyCodeLine{00036\ \}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00041\ PrcKeyRegistry::}
\DoxyCodeLine{00042\ \string~PrcKeyRegistry()\ \{}
\DoxyCodeLine{00043\ \ \ prc\_cat.error()}
\DoxyCodeLine{00044\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Internal\ error-\/-\/PrcKeyRegistry\ destructor\ called!\(\backslash\)n"{}};}
\DoxyCodeLine{00045\ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00055\ \textcolor{keywordtype}{void}\ PrcKeyRegistry::}
\DoxyCodeLine{00056\ record\_keys(\textcolor{keyword}{const}\ KeyDef\ *key\_def,\ \textcolor{keywordtype}{size\_t}\ num\_keys)\ \{}
\DoxyCodeLine{00057\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_keys;\ i++)\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keyword}{const}\ KeyDef\ *def\ =\ \&key\_def[i];}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordflow}{if}\ (def-\/>\_data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \textcolor{comment}{//\ Clear\ the\ ith\ key.}}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\_keys.size()\ <=\ i)\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ Key\ key;}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ key.\_def\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ key.\_pkey\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ key.\_generated\_time\ =\ 0;}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \_keys.push\_back(key);}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_keys[i].\_def\ !=\ def)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_keys[i].\_pkey\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ EVP\_PKEY\_free(\_keys[i].\_pkey);}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \_keys[i].\_pkey\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \_keys[i].\_def\ =\ def;}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \_keys[i].\_generated\_time\ =\ def-\/>\_generated\_time;}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00076\ \ \ \ \ \}}
\DoxyCodeLine{00077\ \ \ \}}
\DoxyCodeLine{00078\ \}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00086\ \textcolor{keywordtype}{void}\ PrcKeyRegistry::}
\DoxyCodeLine{00087\ set\_key(\textcolor{keywordtype}{size\_t}\ n,\ EVP\_PKEY\ *pkey,\ time\_t\ generated\_time)\ \{}
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//\ Clear\ the\ nth\ key.}}
\DoxyCodeLine{00089\ \ \ \textcolor{keywordflow}{while}\ (\_keys.size()\ <=\ n)\ \{}
\DoxyCodeLine{00090\ \ \ \ \ Key\ key;}
\DoxyCodeLine{00091\ \ \ \ \ key.\_def\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00092\ \ \ \ \ key.\_pkey\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00093\ \ \ \ \ key.\_generated\_time\ =\ 0;}
\DoxyCodeLine{00094\ \ \ \ \ \_keys.push\_back(key);}
\DoxyCodeLine{00095\ \ \ \}}
\DoxyCodeLine{00096\ \ \ \_keys[n].\_def\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{if}\ (\_keys[n].\_pkey\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00098\ \ \ \ \ EVP\_PKEY\_free(\_keys[n].\_pkey);}
\DoxyCodeLine{00099\ \ \ \ \ \_keys[n].\_pkey\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00100\ \ \ \}}
\DoxyCodeLine{00101\ \ \ \_keys[n].\_pkey\ =\ pkey;}
\DoxyCodeLine{00102\ \ \ \_keys[n].\_generated\_time\ =\ generated\_time;}
\DoxyCodeLine{00103\ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00110\ \textcolor{keywordtype}{size\_t}\ PrcKeyRegistry::}
\DoxyCodeLine{00111\ get\_num\_keys()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{return}\ \_keys.size();}
\DoxyCodeLine{00113\ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00118\ EVP\_PKEY\ *PrcKeyRegistry::}
\DoxyCodeLine{00119\ get\_key(\textcolor{keywordtype}{size\_t}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00120\ \ \ nassertr(n\ <\ \_keys.size(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (\_keys[n].\_def\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_keys[n].\_pkey\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \textcolor{comment}{//\ Convert\ the\ def\ to\ a\ EVP\_PKEY\ structure.}}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \textcolor{keyword}{const}\ KeyDef\ *def\ =\ \_keys[n].\_def;}
\DoxyCodeLine{00126\ \ \ \ \ \ \ BIO\ *mbio\ =\ BIO\_new\_mem\_buf((\textcolor{keywordtype}{void}\ *)def-\/>\_data,\ def-\/>\_length);}
\DoxyCodeLine{00127\ \ \ \ \ \ \ EVP\_PKEY\ *pkey\ =\ PEM\_read\_bio\_PUBKEY(mbio,\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00128\ \ \ \ \ \ \ ((PrcKeyRegistry\ *)\textcolor{keyword}{this})-\/>\_keys[n].\_pkey\ =\ pkey;}
\DoxyCodeLine{00129\ \ \ \ \ \ \ BIO\_free(mbio);}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pkey\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Couldn't\ read\ the\ bio\ for\ some\ reason.}}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ ((PrcKeyRegistry\ *)\textcolor{keyword}{this})-\/>\_keys[n].\_def\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00135\ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{return}\ \_keys[n].\_pkey;}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00145\ time\_t\ PrcKeyRegistry::}
\DoxyCodeLine{00146\ get\_generated\_time(\textcolor{keywordtype}{size\_t}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00147\ \ \ nassertr(n\ <\ \_keys.size(),\ 0);}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{return}\ \_keys[n].\_generated\_time;}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00155\ PrcKeyRegistry\ *PrcKeyRegistry::}
\DoxyCodeLine{00156\ get\_global\_ptr()\ \{}
\DoxyCodeLine{00157\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ PrcKeyRegistry;}
\DoxyCodeLine{00159\ \ \ \}}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00161\ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_OPENSSL}}

\end{DoxyCode}
