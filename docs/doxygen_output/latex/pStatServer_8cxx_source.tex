\doxysection{p\+Stat\+Server.\+cxx}
\hypertarget{pStatServer_8cxx_source}{}\label{pStatServer_8cxx_source}\index{pandatool/src/pstatserver/pStatServer.cxx@{pandatool/src/pstatserver/pStatServer.cxx}}
\mbox{\hyperlink{pStatServer_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatServer_8h}{pStatServer.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatReader_8h}{pStatReader.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{thread_8h}{thread.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pstatclient_8h}{config\_pstatclient.h}}"{}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00022\ PStatServer::}
\DoxyCodeLine{00023\ PStatServer()\ \{}
\DoxyCodeLine{00024\ \ \ \_listener\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPStatListener}{PStatListener}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00025\ \ \ \_next\_udp\_port\ =\ 0;}
\DoxyCodeLine{00026\ \}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00031\ PStatServer::}
\DoxyCodeLine{00032\ \string~PStatServer()\ \{}
\DoxyCodeLine{00033\ \ \ \mbox{\hyperlink{classPStatServer_a770f50f78edc517a443275ace6acf82a}{stop\_listening}}();}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \textcolor{keyword}{delete}\ \_listener;}
\DoxyCodeLine{00036\ \}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00049\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPStatServer_ad3f87babd63a32b193b96f90c3cad21e}{PStatServer::}}}
\DoxyCodeLine{00050\ \mbox{\hyperlink{classPStatServer_ad3f87babd63a32b193b96f90c3cad21e}{listen}}(\textcolor{keywordtype}{int}\ port)\ \{}
\DoxyCodeLine{00051\ \ \ \mbox{\hyperlink{classPStatServer_a770f50f78edc517a443275ace6acf82a}{stop\_listening}}();}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{if}\ (port\ <\ 0)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ port\ =\ pstats\_port;}
\DoxyCodeLine{00055\ \ \ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \textcolor{comment}{//\ Now\ try\ to\ listen\ to\ the\ port.}}
\DoxyCodeLine{00058\ \ \ \_rendezvous\ =\ open\_TCP\_server\_rendezvous(port,\ 5);}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \textcolor{keywordflow}{if}\ (\_rendezvous.is\_null())\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{comment}{//\ Couldn't\ get\ it.}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00063\ \ \ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \textcolor{comment}{//\ Tell\ the\ listener\ about\ the\ new\ port.}}
\DoxyCodeLine{00066\ \ \ \_listener-\/>add\_connection(\_rendezvous);}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{keywordflow}{if}\ (\_next\_udp\_port\ ==\ 0)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \_next\_udp\_port\ =\ port\ +\ 1;}
\DoxyCodeLine{00070\ \ \ \}}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00072\ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00077\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a770f50f78edc517a443275ace6acf82a}{PStatServer::}}}
\DoxyCodeLine{00078\ \mbox{\hyperlink{classPStatServer_a770f50f78edc517a443275ace6acf82a}{stop\_listening}}()\ \{}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordflow}{if}\ (\_rendezvous\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00080\ \ \ \ \ close\_connection(\_rendezvous);}
\DoxyCodeLine{00081\ \ \ \ \ \_rendezvous.clear();}
\DoxyCodeLine{00082\ \ \ \}}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00094\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a60f09e8f28c5f981e1e70e740244b16c}{PStatServer::}}}
\DoxyCodeLine{00095\ \mbox{\hyperlink{classPStatServer_a60f09e8f28c5f981e1e70e740244b16c}{poll}}()\ \{}
\DoxyCodeLine{00096\ \ \ \textcolor{comment}{//\ Delete\ all\ the\ readers\ that\ we\ couldn't\ delete\ before.}}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{while}\ (!\_lost\_readers.empty())\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader\ =\ \_lost\_readers.back();}
\DoxyCodeLine{00099\ \ \ \ \ \_lost\_readers.pop\_back();}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \ \ reader-\/>\mbox{\hyperlink{classPStatReader_a137b284b498015712a4b8459ee0a1558}{lost\_connection}}();}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keyword}{delete}\ reader;}
\DoxyCodeLine{00103\ \ \ \}}
\DoxyCodeLine{00104\ \ \ \textcolor{keywordflow}{while}\ (!\_removed\_readers.empty())\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader\ =\ \_removed\_readers.back();}
\DoxyCodeLine{00106\ \ \ \ \ \_removed\_readers.pop\_back();}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{delete}\ reader;}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \_listener-\/>poll();}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ Readers::const\_iterator\ ri\ =\ \_readers.begin();}
\DoxyCodeLine{00113\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_readers.end())\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{comment}{//\ Preincrement\ the\ iterator,\ in\ case\ we\ remove\ it\ as\ a\ result\ of\ calling}}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{comment}{//\ poll().}}
\DoxyCodeLine{00116\ \ \ \ \ Readers::const\_iterator\ rnext\ =\ ri;}
\DoxyCodeLine{00117\ \ \ \ \ ++rnext;}
\DoxyCodeLine{00118\ \ \ \ \ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader\ =\ (*ri).second;}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ reader-\/>poll();}
\DoxyCodeLine{00121\ \ \ \ \ reader-\/>\mbox{\hyperlink{classPStatReader_ac86a43b9bc6d00550d8559a432307f6c}{idle}}();}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \ \ ri\ =\ rnext;}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00136\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a5503b4d69f85e96e8d8f9fe485df671f}{PStatServer::}}}
\DoxyCodeLine{00137\ \mbox{\hyperlink{classPStatServer_a5503b4d69f85e96e8d8f9fe485df671f}{main\_loop}}(\textcolor{keywordtype}{bool}\ *interrupt\_flag)\ \{}
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{while}\ (interrupt\_flag\ ==\ \textcolor{keyword}{nullptr}\ ||\ !*interrupt\_flag)\ \{}
\DoxyCodeLine{00139\ \ \ \ \ \mbox{\hyperlink{classPStatServer_a60f09e8f28c5f981e1e70e740244b16c}{poll}}();}
\DoxyCodeLine{00140\ \ \ \ \ Thread::sleep(0.1);}
\DoxyCodeLine{00141\ \ \ \}}
\DoxyCodeLine{00142\ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00147\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_aaccda2895878613155168947e0a665eb}{PStatServer::}}}
\DoxyCodeLine{00148\ \mbox{\hyperlink{classPStatServer_aaccda2895878613155168947e0a665eb}{add\_reader}}(\mbox{\hyperlink{classConnection}{Connection}}\ *connection,\ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader)\ \{}
\DoxyCodeLine{00149\ \ \ \_readers[connection]\ =\ reader;}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00155\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a5eb8967e25a6656600a769a5520ce572}{PStatServer::}}}
\DoxyCodeLine{00156\ \mbox{\hyperlink{classPStatServer_a5eb8967e25a6656600a769a5520ce572}{remove\_reader}}(\mbox{\hyperlink{classConnection}{Connection}}\ *connection,\ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader)\ \{}
\DoxyCodeLine{00157\ \ \ Readers::iterator\ ri;}
\DoxyCodeLine{00158\ \ \ ri\ =\ \_readers.find(connection);}
\DoxyCodeLine{00159\ \ \ \textcolor{keywordflow}{if}\ (ri\ ==\ \_readers.end()\ ||\ (*ri).second\ !=\ reader)\ \{}
\DoxyCodeLine{00160\ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ remove\ undefined\ reader.\(\backslash\)n"{}};}
\DoxyCodeLine{00161\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \_readers.erase(ri);}
\DoxyCodeLine{00163\ \ \ \ \ \_removed\_readers.push\_back(reader);}
\DoxyCodeLine{00164\ \ \ \}}
\DoxyCodeLine{00165\ \}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00172\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatServer_af28583f7d22002e91c842351405da716}{PStatServer::}}}
\DoxyCodeLine{00173\ \mbox{\hyperlink{classPStatServer_af28583f7d22002e91c842351405da716}{get\_udp\_port}}()\ \{}
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{if}\ (\_available\_udp\_ports.empty())\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{keywordflow}{return}\ \_next\_udp\_port++;}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordtype}{int}\ udp\_port\ =\ \_available\_udp\_ports.front();}
\DoxyCodeLine{00178\ \ \ \_available\_udp\_ports.pop\_front();}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{return}\ udp\_port;}
\DoxyCodeLine{00180\ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00185\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_adc8dead434aef51d77828742e0b7cb05}{PStatServer::}}}
\DoxyCodeLine{00186\ \mbox{\hyperlink{classPStatServer_adc8dead434aef51d77828742e0b7cb05}{release\_udp\_port}}(\textcolor{keywordtype}{int}\ port)\ \{}
\DoxyCodeLine{00187\ \ \ \_available\_udp\_ports.push\_back(port);}
\DoxyCodeLine{00188\ \}}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00193\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatServer_aac8ddae5a296162c18602afe6401bdf8}{PStatServer::}}}
\DoxyCodeLine{00194\ \mbox{\hyperlink{classPStatServer_aac8ddae5a296162c18602afe6401bdf8}{get\_num\_user\_guide\_bars}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00195\ \ \ \textcolor{keywordflow}{return}\ \_user\_guide\_bars.size();}
\DoxyCodeLine{00196\ \}}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00201\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classPStatServer_af4201e60610b97ef3d6572ebea1e06d8}{PStatServer::}}}
\DoxyCodeLine{00202\ \mbox{\hyperlink{classPStatServer_af4201e60610b97ef3d6572ebea1e06d8}{get\_user\_guide\_bar\_height}}(\textcolor{keywordtype}{int}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00203\ \ \ nassertr(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})\_user\_guide\_bars.size(),\ 0.0f);}
\DoxyCodeLine{00204\ \ \ \textcolor{keywordflow}{return}\ \_user\_guide\_bars[n];}
\DoxyCodeLine{00205\ \}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00210\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a5b181b5b2a4507837872722479c27644}{PStatServer::}}}
\DoxyCodeLine{00211\ \mbox{\hyperlink{classPStatServer_a5b181b5b2a4507837872722479c27644}{move\_user\_guide\_bar}}(\textcolor{keywordtype}{int}\ n,\ \textcolor{keywordtype}{double}\ height)\ \{}
\DoxyCodeLine{00212\ \ \ nassertv(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})\_user\_guide\_bars.size());}
\DoxyCodeLine{00213\ \ \ \_user\_guide\_bars[n]\ =\ height;}
\DoxyCodeLine{00214\ \ \ user\_guide\_bars\_changed();}
\DoxyCodeLine{00215\ \}}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00220\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatServer_a43b382ae71556301dda3685b90f855fe}{PStatServer::}}}
\DoxyCodeLine{00221\ \mbox{\hyperlink{classPStatServer_a43b382ae71556301dda3685b90f855fe}{add\_user\_guide\_bar}}(\textcolor{keywordtype}{double}\ height)\ \{}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordtype}{int}\ n\ =\ (int)\_user\_guide\_bars.size();}
\DoxyCodeLine{00223\ \ \ \_user\_guide\_bars.push\_back(height);}
\DoxyCodeLine{00224\ \ \ user\_guide\_bars\_changed();}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \ \ \textcolor{keywordflow}{return}\ n;}
\DoxyCodeLine{00227\ \}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00233\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a09dde72050fdb32e81962b3e380c9904}{PStatServer::}}}
\DoxyCodeLine{00234\ \mbox{\hyperlink{classPStatServer_a09dde72050fdb32e81962b3e380c9904}{remove\_user\_guide\_bar}}(\textcolor{keywordtype}{int}\ n)\ \{}
\DoxyCodeLine{00235\ \ \ nassertv(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})\_user\_guide\_bars.size());}
\DoxyCodeLine{00236\ \ \ \_user\_guide\_bars.erase(\_user\_guide\_bars.begin()\ +\ n);}
\DoxyCodeLine{00237\ \ \ user\_guide\_bars\_changed();}
\DoxyCodeLine{00238\ \}}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00245\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatServer_afe5be7600ec8b7b61d7b726a145f8f39}{PStatServer::}}}
\DoxyCodeLine{00246\ \mbox{\hyperlink{classPStatServer_afe5be7600ec8b7b61d7b726a145f8f39}{find\_user\_guide\_bar}}(\textcolor{keywordtype}{double}\ from\_height,\ \textcolor{keywordtype}{double}\ to\_height)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00247\ \ \ GuideBars::const\_iterator\ gbi;}
\DoxyCodeLine{00248\ \ \ \textcolor{keywordflow}{for}\ (gbi\ =\ \_user\_guide\_bars.begin();}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ gbi\ !=\ \_user\_guide\_bars.end();}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ ++gbi)\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keywordtype}{double}\ height\ =\ (*gbi);}
\DoxyCodeLine{00252\ \ \ \ \ \textcolor{keywordflow}{if}\ (height\ >=\ from\_height\ \&\&\ height\ <=\ to\_height)\ \{}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})(gbi\ -\/\ \_user\_guide\_bars.begin());}
\DoxyCodeLine{00254\ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00258\ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00263\ \textcolor{keywordtype}{void}\ PStatServer::}
\DoxyCodeLine{00264\ user\_guide\_bars\_changed()\ \{}
\DoxyCodeLine{00265\ \ \ Readers::iterator\ ri;}
\DoxyCodeLine{00266\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_readers.begin();\ ri\ !=\ \_readers.end();\ ++ri)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ (*ri).second-\/>get\_monitor()-\/>user\_guide\_bars\_changed();}
\DoxyCodeLine{00268\ \ \ \}}
\DoxyCodeLine{00269\ \}}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00281\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPStatServer_a532251340de9804b2ff90bc84da790d3}{PStatServer::}}}
\DoxyCodeLine{00282\ \mbox{\hyperlink{classPStatServer_a532251340de9804b2ff90bc84da790d3}{is\_thread\_safe}}()\ \{}
\DoxyCodeLine{00283\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00284\ \}}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00290\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatServer_a376f1b598496d87c39e41f335acbf266}{PStatServer::}}}
\DoxyCodeLine{00291\ \mbox{\hyperlink{classPStatServer_a376f1b598496d87c39e41f335acbf266}{connection\_reset}}(\textcolor{keyword}{const}\ PT(\mbox{\hyperlink{classConnection}{Connection}})\ \&connection,\ \textcolor{keywordtype}{bool}\ okflag)\ \{}
\DoxyCodeLine{00292\ \ \ \textcolor{comment}{//\ Was\ this\ a\ client\ connection?\ \ Tell\ the\ reader\ about\ it\ if\ it\ was.}}
\DoxyCodeLine{00293\ \ \ close\_connection(connection);}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ \ \ Readers::iterator\ ri;}
\DoxyCodeLine{00296\ \ \ ri\ =\ \_readers.find(connection);}
\DoxyCodeLine{00297\ \ \ \textcolor{keywordflow}{if}\ (ri\ !=\ \_readers.end())\ \{}
\DoxyCodeLine{00298\ \ \ \ \ \mbox{\hyperlink{classPStatReader}{PStatReader}}\ *reader\ =\ (*ri).second;}
\DoxyCodeLine{00299\ \ \ \ \ \_readers.erase(ri);}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{comment}{//\ Unfortunately,\ we\ can't\ delete\ the\ reader\ right\ away,\ because\ we\ might}}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{comment}{//\ have\ been\ called\ from\ a\ method\ on\ the\ reader!\ \ We'll\ have\ to\ save\ the}}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{comment}{//\ reader\ pointer\ and\ delete\ it\ some\ time\ later.}}
\DoxyCodeLine{00304\ \ \ \ \ \_lost\_readers.push\_back(reader);}
\DoxyCodeLine{00305\ \ \ \}}
\DoxyCodeLine{00306\ \}}

\end{DoxyCode}
