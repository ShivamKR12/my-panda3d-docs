\doxysection{instanced\+Node.\+cxx}
\hypertarget{instancedNode_8cxx_source}{}\label{instancedNode_8cxx_source}\index{panda/src/pgraph/instancedNode.cxx@{panda/src/pgraph/instancedNode.cxx}}
\mbox{\hyperlink{instancedNode_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{instancedNode_8h}{instancedNode.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingBox_8h}{boundingBox.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullPlanes_8h}{cullPlanes.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ InstancedNode::\_type\_handle;}
\DoxyCodeLine{00021\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ InstancedNode::CData::\_type\_handle;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00026\ InstancedNode::}
\DoxyCodeLine{00027\ InstancedNode(\textcolor{keyword}{const}\ std::string\ \&name)\ :}
\DoxyCodeLine{00028\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(name)}
\DoxyCodeLine{00029\ \{}
\DoxyCodeLine{00030\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00031\ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00036\ InstancedNode::}
\DoxyCodeLine{00037\ InstancedNode(\textcolor{keyword}{const}\ \mbox{\hyperlink{classInstancedNode}{InstancedNode}}\ \&copy)\ :}
\DoxyCodeLine{00038\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(copy),}
\DoxyCodeLine{00039\ \ \ \_cycler(copy.\_cycler)}
\DoxyCodeLine{00040\ \{}
\DoxyCodeLine{00041\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00047\ InstancedNode::}
\DoxyCodeLine{00048\ \string~InstancedNode()\ \{}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00056\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classInstancedNode_a8d2ce9a86d452e3be1498a6816bbb6bc}{InstancedNode::}}}
\DoxyCodeLine{00057\ \mbox{\hyperlink{classInstancedNode_a8d2ce9a86d452e3be1498a6816bbb6bc}{make\_copy}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00058\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classInstancedNode}{InstancedNode}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00059\ \}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00067\ PT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ InstancedNode::}
\DoxyCodeLine{00068\ modify\_instances()\ \{}
\DoxyCodeLine{00069\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00070\ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true},\ current\_thread);}
\DoxyCodeLine{00071\ \ \ PT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances\ =\ cdata-\/>\_instances.get\_write\_pointer();}
\DoxyCodeLine{00072\ \ \ mark\_bounds\_stale(current\_thread-\/>get\_pipeline\_stage(),\ current\_thread);}
\DoxyCodeLine{00073\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{return}\ instances;}
\DoxyCodeLine{00075\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00083\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a5d2992563e89257d6711593f766f112b}{InstancedNode::}}}
\DoxyCodeLine{00084\ \mbox{\hyperlink{classInstancedNode_a5d2992563e89257d6711593f766f112b}{set\_instances}}(PT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances)\ \{}
\DoxyCodeLine{00085\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00086\ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00087\ \ \ cdata-\/>\_instances\ =\ std::move(instances);}
\DoxyCodeLine{00088\ \ \ mark\_bounds\_stale(current\_thread-\/>get\_pipeline\_stage(),\ current\_thread);}
\DoxyCodeLine{00089\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00090\ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00098\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classInstancedNode_aee868fc22facdfc73fd885349ca7402a}{InstancedNode::}}}
\DoxyCodeLine{00099\ \mbox{\hyperlink{classInstancedNode_aee868fc22facdfc73fd885349ca7402a}{safe\_to\_flatten}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00100\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00101\ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00109\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classInstancedNode_ad97dc14c6fdfaed069bfae9f756d674a}{InstancedNode::}}}
\DoxyCodeLine{00110\ \mbox{\hyperlink{classInstancedNode_ad97dc14c6fdfaed069bfae9f756d674a}{safe\_to\_combine}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00111\ \ \ \textcolor{comment}{//\ This\ can\ happen\ iff\ the\ instance\ list\ is\ identical;\ see\ combine\_with().}}
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00113\ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00119\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a3a3e71255f79ed489d9591cd3ec5ddef}{InstancedNode::}}}
\DoxyCodeLine{00120\ \mbox{\hyperlink{classInstancedNode_a3a3e71255f79ed489d9591cd3ec5ddef}{xform}}(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\ \{}
\DoxyCodeLine{00121\ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00133\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classInstancedNode_af6e933f4b2dd2962a6bf0a6f5af36882}{InstancedNode::}}}
\DoxyCodeLine{00134\ \mbox{\hyperlink{classInstancedNode_af6e933f4b2dd2962a6bf0a6f5af36882}{combine\_with}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{00135\ \ \ \textcolor{keywordflow}{if}\ (is\_exact\_type(get\_class\_type())\ \&\&\ other-\/>is\_exact\_type(get\_class\_type()))\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \mbox{\hyperlink{classInstancedNode}{InstancedNode}}\ *iother\ =\ DCAST(\mbox{\hyperlink{classInstancedNode}{InstancedNode}},\ other);}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{comment}{//\ Only\ combine\ them\ if\ the\ instance\ lists\ for\ both\ are\ identical.}}
\DoxyCodeLine{00139\ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00140\ \ \ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ this\_cdata(\_cycler,\ current\_thread);}
\DoxyCodeLine{00141\ \ \ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ other\_cdata(iother-\/>\_cycler,\ current\_thread);}
\DoxyCodeLine{00142\ \ \ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ this\_instances\ =\ this\_cdata-\/>\_instances.get\_read\_pointer(current\_thread);}
\DoxyCodeLine{00143\ \ \ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ other\_instances\ =\ other\_cdata-\/>\_instances.get\_read\_pointer(current\_thread);}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{keywordflow}{if}\ (this\_instances\ ==\ other\_instances)\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00146\ \ \ \ \ \}}
\DoxyCodeLine{00147\ \ \ \}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00150\ \}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00163\ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ InstancedNode::}
\DoxyCodeLine{00164\ calc\_tight\_bounds(LPoint3\ \&min\_point,\ LPoint3\ \&max\_point,\ \textcolor{keywordtype}{bool}\ \&found\_any,}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances\ =\ get\_instances(current\_thread);}
\DoxyCodeLine{00168\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ next\_transform\ =\ transform-\/>compose(get\_transform(current\_thread));}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ii\ =\ 0;\ ii\ <\ instances-\/>size();\ ++ii)\ \{}
\DoxyCodeLine{00171\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ instance\_transform\ =\ next\_transform-\/>compose((*instances)[ii].get\_transform());}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \ \ \ \ Children\ cr\ =\ get\_children(current\_thread);}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num\_children\ =\ cr.get\_num\_children();}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ci\ =\ 0;\ ci\ <\ num\_children;\ ++ci)\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \ \ cr.get\_child(ci)-\/>calc\_tight\_bounds(min\_point,\ max\_point,}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ found\_any,\ instance\_transform,}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00179\ \ \ \ \ \}}
\DoxyCodeLine{00180\ \ \ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ next\_transform;}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00203\ \textcolor{keywordtype}{bool}\ InstancedNode::}
\DoxyCodeLine{00204\ cull\_callback(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data)\ \{}
\DoxyCodeLine{00205\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ trav-\/>get\_current\_thread();}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances\ =\ get\_instances(current\_thread);}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \textcolor{keywordflow}{if}\ (data.\_instances\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ We\ are\ already\ under\ an\ instanced\ node.\ \ Create\ a\ new\ combined\ list.}}
\DoxyCodeLine{00211\ \ \ \ \ \mbox{\hyperlink{classInstanceList}{InstanceList}}\ *new\_list\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classInstanceList}{InstanceList}}();}
\DoxyCodeLine{00212\ \ \ \ \ new\_list-\/>reserve(data.\_instances-\/>size()\ *\ instances-\/>size());}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classInstanceList_1_1Instance}{InstanceList::Instance}}\ \&parent\_instance\ :\ *data.\_instances)\ \{}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classInstanceList_1_1Instance}{InstanceList::Instance}}\ \&this\_instance\ :\ *instances)\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ new\_list-\/>append(parent\_instance.get\_transform()-\/>compose(this\_instance.get\_transform()));}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \ \ instances\ =\ new\_list;}
\DoxyCodeLine{00219\ \ \ \}}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00221\ \ \ \textcolor{keywordflow}{if}\ (data.\_view\_frustum\ !=\ \textcolor{keyword}{nullptr}\ ||\ data.\_cull\_planes\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00222\ \ \ \ \ \textcolor{comment}{//\ Culling\ is\ on,\ so\ we\ need\ to\ figure\ out\ which\ instances\ should\ be\ culled.}}
\DoxyCodeLine{00223\ \ \ \ \ \mbox{\hyperlink{classBitArray}{BitArray}}\ culled\_instances;}
\DoxyCodeLine{00224\ \ \ \ \ culled\_instances.\mbox{\hyperlink{classBitArray_a7c5b25d67999f4d2b1e4e090b05cb265}{set\_range}}(0,\ instances-\/>size());}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ ii\ =\ 0;\ ii\ <\ instances-\/>size();\ ++ii)\ \{}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data.is\_instance\_in\_view((*instances)[ii].get\_transform(),\ trav-\/>get\_camera\_mask()))\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ culled\_instances.clear\_bit(ii);}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00230\ \ \ \ \ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \ \ \textcolor{keywordflow}{if}\ (!culled\_instances.\mbox{\hyperlink{classBitArray_ac4e559ae54607b485f6a4123aacd8fa2}{is\_zero}}()\ \&\&\ trav-\/>get\_fake\_view\_frustum\_cull())\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ culled\ instances\ are\ drawn\ with\ the\ fake-\/view-\/frustum-\/cull\ effect.}}
\DoxyCodeLine{00234\ \ \ \ \ \ \ data.\_instances\ =\ instances-\/>without(culled\_instances\ \string^\ BitArray::range(0,\ instances-\/>size()));}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \ \ \ \ Children\ children\ =\ data.node\_reader()-\/>get\_children();}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ children.get\_num\_children();}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ ++i)\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ trav-\/>\mbox{\hyperlink{classCullTraverser_af0e11139cb62f5155ee680ccf3ffecbb}{do\_fake\_cull}}(data,\ children.get\_child(i),\ data.\_net\_transform,\ data.\_state);}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \}}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ \ \ instances\ =\ instances-\/>without(culled\_instances);}
\DoxyCodeLine{00244\ \ \ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{if}\ (instances-\/>empty())\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{comment}{//\ There\ are\ no\ instances,\ or\ they\ are\ all\ culled\ away.}}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00249\ \ \ \}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ data.\_instances\ =\ std::move(instances);}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{comment}{//\ Disable\ culling\ from\ this\ point\ on,\ for\ now.\ \ It's\ probably\ not\ worth\ it}}
\DoxyCodeLine{00254\ \ \ \textcolor{comment}{//\ to\ keep\ lists\ of\ transformed\ bounding\ volumes\ for\ each\ instance.}}
\DoxyCodeLine{00255\ \ \ data.\_view\_frustum\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00256\ \ \ data.\_cull\_planes\ =\ CullPlanes::make\_empty();}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00258\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00264\ \textcolor{keywordtype}{void}\ InstancedNode::}
\DoxyCodeLine{00265\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00266\ \ \ PandaNode::output(out);}
\DoxyCodeLine{00267\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ ("{}}\ <<\ get\_num\_instances()\ <<\ \textcolor{stringliteral}{"{}\ instances)"{}};}
\DoxyCodeLine{00268\ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00275\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a0744a79aaaed377f339a233232428142}{InstancedNode::}}}
\DoxyCodeLine{00276\ \mbox{\hyperlink{classInstancedNode_a0744a79aaaed377f339a233232428142}{compute\_external\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&external\_bounds,}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ BoundingVolume::BoundsType\ btype,}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **volumes,\ \textcolor{keywordtype}{size\_t}\ num\_volumes,}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances\ =\ get\_instances(current\_thread);}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00283\ \ \ PT(\mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}})\ gbv;}
\DoxyCodeLine{00284\ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_sphere)\ \{}
\DoxyCodeLine{00285\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{00286\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00287\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}};}
\DoxyCodeLine{00288\ \ \ \}}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ \textcolor{keywordflow}{if}\ (num\_volumes\ ==\ 0\ ||\ instances-\/>empty())\ \{}
\DoxyCodeLine{00291\ \ \ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{00292\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00293\ \ \ \}}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ \ \ \textcolor{comment}{//\ Compute\ a\ sphere\ at\ the\ origin,\ encompassing\ the\ children.\ \ This\ may\ not}}
\DoxyCodeLine{00296\ \ \ \textcolor{comment}{//\ be\ the\ most\ optimal\ shape,\ but\ it\ allows\ us\ to\ easily\ estimate\ a\ bounding}}
\DoxyCodeLine{00297\ \ \ \textcolor{comment}{//\ volume\ without\ having\ to\ take\ each\ instance\ transform\ into\ account.}}
\DoxyCodeLine{00298\ \ \ PN\_stdfloat\ max\_radius\ =\ 0;}
\DoxyCodeLine{00299\ \ \ LVector3\ max\_abs\_box(0);}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00301\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_volumes;\ ++i)\ \{}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *child\_volume\ =\ volumes[i];}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordflow}{if}\ (child\_volume-\/>is\_empty())\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00305\ \ \ \ \ \}}
\DoxyCodeLine{00306\ \ \ \ \ \textcolor{keywordflow}{if}\ (child\_volume-\/>is\_infinite())\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ gbv-\/>set\_infinite();}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00309\ \ \ \ \ \}}
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}\ *child\_sphere\ =\ child\_volume-\/>\mbox{\hyperlink{classBoundingVolume_a777daedc119d7f86fb95214b666ad775}{as\_bounding\_sphere}}())\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \ \ max\_radius\ =\ child\_sphere-\/>get\_center().length()\ +\ child\_sphere-\/>get\_radius();}
\DoxyCodeLine{00312\ \ \ \ \ \}}
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classFiniteBoundingVolume}{FiniteBoundingVolume}}\ *child\_finite\ =\ child\_volume-\/>\mbox{\hyperlink{classBoundingVolume_ab91d6d527a901e77bfdf49781587bf23}{as\_finite\_bounding\_volume}}())\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ LPoint3\ min1\ =\ child\_finite-\/>get\_min();}
\DoxyCodeLine{00315\ \ \ \ \ \ \ LPoint3\ max1\ =\ child\_finite-\/>get\_max();}
\DoxyCodeLine{00316\ \ \ \ \ \ \ max\_abs\_box.set(}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ std::max(max\_abs\_box[0],\ std::max(std::fabs(min1[0]),\ std::fabs(max1[0]))),}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ std::max(max\_abs\_box[1],\ std::max(std::fabs(min1[1]),\ std::fabs(max1[1]))),}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ std::max(max\_abs\_box[2],\ std::max(std::fabs(min1[2]),\ std::fabs(max1[2]))));}
\DoxyCodeLine{00320\ \ \ \ \ \}}
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \ \ gbv-\/>set\_infinite();}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00324\ \ \ \ \ \}}
\DoxyCodeLine{00325\ \ \ \}}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00327\ \ \ max\_radius\ =\ std::max(max\_radius,\ max\_abs\_box.length());}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{if}\ (max\_radius\ ==\ 0\ ||\ gbv-\/>is\_infinite())\ \{}
\DoxyCodeLine{00329\ \ \ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00331\ \ \ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \textcolor{comment}{//\ Now\ that\ we\ have\ a\ sphere\ encompassing\ the\ children,\ we\ will\ make\ a\ box}}
\DoxyCodeLine{00334\ \ \ \textcolor{comment}{//\ surrounding\ all\ the\ instances,\ extended\ by\ the\ computed\ radius.}}
\DoxyCodeLine{00335\ \ \ LPoint3\ min\_point\ =\ (*instances)[0].get\_pos();}
\DoxyCodeLine{00336\ \ \ LPoint3\ max\_point(min\_point);}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classInstanceList_1_1Instance}{InstanceList::Instance}}\ \&instance\ :\ *instances)\ \{}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{comment}{//\ To\ make\ the\ math\ easier\ and\ not\ have\ to\ take\ rotations\ into\ account,\ we}}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{comment}{//\ take\ the\ highest\ scale\ component\ and\ multiply\ it\ by\ the\ radius\ of\ the}}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{comment}{//\ bounding\ sphere\ on\ the\ origin\ we\ just\ calculated.}}
\DoxyCodeLine{00342\ \ \ \ \ LVecBase3\ scale\ =\ instance.get\_scale();}
\DoxyCodeLine{00343\ \ \ \ \ PN\_stdfloat\ max\_scale\ =\ std::max(std::fabs(scale[0]),\ std::max(std::fabs(scale[1]),\ std::fabs(scale[2])));}
\DoxyCodeLine{00344\ \ \ \ \ PN\_stdfloat\ inst\_radius\ =\ max\_scale\ *\ max\_radius;}
\DoxyCodeLine{00345\ \ \ \ \ LVector3\ extends\_by(inst\_radius);}
\DoxyCodeLine{00346\ \ \ \ \ LPoint3\ pos\ =\ instance.get\_pos();}
\DoxyCodeLine{00347\ \ \ \ \ min\_point\ =\ min\_point.fmin(pos\ -\/\ extends\_by);}
\DoxyCodeLine{00348\ \ \ \ \ max\_point\ =\ max\_point.fmax(pos\ +\ extends\_by);}
\DoxyCodeLine{00349\ \ \ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \textcolor{keywordflow}{if}\ (min\_point\ ==\ max\_point)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{00353\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00354\ \ \ \}}
\DoxyCodeLine{00355\ }
\DoxyCodeLine{00356\ \ \ \textcolor{comment}{//\ If\ we\ really\ need\ to\ make\ a\ sphere,\ we\ use\ the\ center\ of\ the\ bounding\ box}}
\DoxyCodeLine{00357\ \ \ \textcolor{comment}{//\ as\ our\ sphere\ center,\ and\ iterate\ again\ to\ find\ the\ furthest\ instance.}}
\DoxyCodeLine{00358\ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_sphere)\ \{}
\DoxyCodeLine{00359\ \ \ \ \ LPoint3\ center\ =\ (min\_point\ +\ max\_point)\ *\ 0.5;}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \ \ PN\_stdfloat\ max\_distance\ =\ 0;}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classInstanceList_1_1Instance}{InstanceList::Instance}}\ \&instance\ :\ *instances)\ \{}
\DoxyCodeLine{00363\ \ \ \ \ \ \ LVecBase3\ scale\ =\ instance.get\_scale();}
\DoxyCodeLine{00364\ \ \ \ \ \ \ PN\_stdfloat\ max\_scale\ =\ std::max(std::fabs(scale[0]),\ std::max(std::fabs(scale[1]),\ std::fabs(scale[2])));}
\DoxyCodeLine{00365\ \ \ \ \ \ \ PN\_stdfloat\ inst\_radius\ =\ max\_scale\ *\ max\_radius;}
\DoxyCodeLine{00366\ \ \ \ \ \ \ PN\_stdfloat\ distance\ =\ (instance.get\_pos()\ -\/\ center).length()\ +\ inst\_radius;}
\DoxyCodeLine{00367\ \ \ \ \ \ \ max\_distance\ =\ std::max(max\_distance,\ distance);}
\DoxyCodeLine{00368\ \ \ \ \ \}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \ \ \textcolor{keywordflow}{if}\ (max\_distance\ ==\ 0)\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00373\ \ \ \ \ \}}
\DoxyCodeLine{00374\ \ \ \ \ ((\mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}\ *)gbv.p())-\/>set\_center(center);}
\DoxyCodeLine{00375\ \ \ \ \ ((\mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}\ *)gbv.p())-\/>set\_radius(max\_distance);}
\DoxyCodeLine{00376\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00377\ \ \ \ \ ((\mbox{\hyperlink{classBoundingBox}{BoundingBox}}\ *)gbv.p())-\/>set\_min\_max(min\_point,\ max\_point);}
\DoxyCodeLine{00378\ \ \ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ \ \ \textcolor{comment}{//\ If\ we\ have\ a\ transform,\ apply\ it\ to\ the\ bounding\ volume\ we\ just}}
\DoxyCodeLine{00381\ \ \ \textcolor{comment}{//\ computed.}}
\DoxyCodeLine{00382\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ transform\ =\ get\_transform(current\_thread);}
\DoxyCodeLine{00383\ \ \ \textcolor{keywordflow}{if}\ (!transform-\/>is\_identity())\ \{}
\DoxyCodeLine{00384\ \ \ \ \ gbv-\/>xform(transform-\/>get\_mat());}
\DoxyCodeLine{00385\ \ \ \}}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00387\ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{00388\ \}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00393\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a61c9640cc2117c8cd477017ae2e7eb12}{InstancedNode::}}}
\DoxyCodeLine{00394\ \mbox{\hyperlink{classInstancedNode_a61c9640cc2117c8cd477017ae2e7eb12}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00395\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classInstancedNode_a79f998d7e59265394dee7b4d3a2572fa}{make\_from\_bam}});}
\DoxyCodeLine{00396\ \}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00402\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a4faf1bb5143c0b5f95ac210c5d197e72}{InstancedNode::}}}
\DoxyCodeLine{00403\ \mbox{\hyperlink{classInstancedNode_a4faf1bb5143c0b5f95ac210c5d197e72}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00404\ \ \ \mbox{\hyperlink{classPandaNode_ae9b3055297ade9bbf4a3b4dfc77e4506}{PandaNode::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00405\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{00406\ \}}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00413\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classInstancedNode_a79f998d7e59265394dee7b4d3a2572fa}{InstancedNode::}}}
\DoxyCodeLine{00414\ \mbox{\hyperlink{classInstancedNode_a79f998d7e59265394dee7b4d3a2572fa}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00415\ \ \ \mbox{\hyperlink{classInstancedNode}{InstancedNode}}\ *node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classInstancedNode}{InstancedNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00416\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00417\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00420\ \ \ node-\/>\mbox{\hyperlink{classInstancedNode_a2c0d10f1fcff210bcbfac45e4a542340}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \textcolor{keywordflow}{return}\ node;}
\DoxyCodeLine{00423\ \}}
\DoxyCodeLine{00424\ }
\DoxyCodeLine{00429\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classInstancedNode_a2c0d10f1fcff210bcbfac45e4a542340}{InstancedNode::}}}
\DoxyCodeLine{00430\ \mbox{\hyperlink{classInstancedNode_a2c0d10f1fcff210bcbfac45e4a542340}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00431\ \ \ \mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{PandaNode::fillin}}(scan,\ manager);}
\DoxyCodeLine{00432\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{00433\ \}}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00438\ InstancedNode::CData::}
\DoxyCodeLine{00439\ CData(\textcolor{keyword}{const}\ InstancedNode::CData\ \&copy)\ :}
\DoxyCodeLine{00440\ \ \ \_instances(copy.\_instances)}
\DoxyCodeLine{00441\ \{}
\DoxyCodeLine{00442\ \}}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00447\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *InstancedNode::CData::}
\DoxyCodeLine{00448\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00449\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{00450\ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00456\ \textcolor{keywordtype}{void}\ InstancedNode::CData::}
\DoxyCodeLine{00457\ write\_datagram(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00458\ \ \ CPT(\mbox{\hyperlink{classInstanceList}{InstanceList}})\ instances\ =\ \_instances.get\_read\_pointer();}
\DoxyCodeLine{00459\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ instances.p());}
\DoxyCodeLine{00460\ \}}
\DoxyCodeLine{00461\ }
\DoxyCodeLine{00466\ \textcolor{keywordtype}{int}\ InstancedNode::CData::}
\DoxyCodeLine{00467\ complete\_pointers(\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00468\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ \mbox{\hyperlink{classCycleData_afae68c5bc34c5cd6ab858d009fbdf1b3}{CycleData::complete\_pointers}}(p\_list,\ manager);}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \_instances\ =\ DCAST(\mbox{\hyperlink{classInstanceList}{InstanceList}},\ p\_list[pi++]);}
\DoxyCodeLine{00471\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{00472\ \}}
\DoxyCodeLine{00473\ }
\DoxyCodeLine{00478\ \textcolor{keywordtype}{void}\ InstancedNode::CData::}
\DoxyCodeLine{00479\ fillin(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00480\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{00481\ \}}

\end{DoxyCode}
