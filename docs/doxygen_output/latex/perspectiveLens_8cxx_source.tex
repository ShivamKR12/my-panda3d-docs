\doxysection{perspective\+Lens.\+cxx}
\hypertarget{perspectiveLens_8cxx_source}{}\label{perspectiveLens_8cxx_source}\index{panda/src/gobj/perspectiveLens.cxx@{panda/src/gobj/perspectiveLens.cxx}}
\mbox{\hyperlink{perspectiveLens_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{perspectiveLens_8h}{perspectiveLens.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PerspectiveLens::\_type\_handle;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00023\ PT(\mbox{\hyperlink{classLens}{Lens}})\ PerspectiveLens::}
\DoxyCodeLine{00024\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00025\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPerspectiveLens}{PerspectiveLens}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00026\ \}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00033\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPerspectiveLens_a78fb98827a88a2380349741d532dbaa7}{PerspectiveLens::}}}
\DoxyCodeLine{00034\ \mbox{\hyperlink{classPerspectiveLens_a78fb98827a88a2380349741d532dbaa7}{is\_linear}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00035\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00036\ \}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00042\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPerspectiveLens_acfe46c0d7e7fe6fa09c0ac0e5d61344d}{PerspectiveLens::}}}
\DoxyCodeLine{00043\ \mbox{\hyperlink{classPerspectiveLens_acfe46c0d7e7fe6fa09c0ac0e5d61344d}{is\_perspective}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00044\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00045\ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00052\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPerspectiveLens_adf7d21d21db358e91772d84627ffffae}{PerspectiveLens::}}}
\DoxyCodeLine{00053\ \mbox{\hyperlink{classPerspectiveLens_adf7d21d21db358e91772d84627ffffae}{do\_extrude\_depth}}(\textcolor{keyword}{const}\ CData\ *cdata,}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LPoint3\ \&point3d)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00055\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classLens_a7e9b27f70cc860b3d461a8e4c1889774}{do\_extrude\_depth\_with\_mat}}(cdata,\ point2d,\ point3d);}
\DoxyCodeLine{00056\ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00062\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPerspectiveLens_aff90bf1c2ba52776576997636769fcf7}{PerspectiveLens::}}}
\DoxyCodeLine{00063\ \mbox{\hyperlink{classPerspectiveLens_aff90bf1c2ba52776576997636769fcf7}{do\_compute\_projection\_mat}}(\mbox{\hyperlink{classLens_1_1CData}{Lens::CData}}\ *lens\_cdata)\ \{}
\DoxyCodeLine{00064\ \ \ CoordinateSystem\ cs\ =\ lens\_cdata-\/>\_cs;}
\DoxyCodeLine{00065\ \ \ \textcolor{keywordflow}{if}\ (cs\ ==\ CS\_default)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ cs\ =\ get\_default\_coordinate\_system();}
\DoxyCodeLine{00067\ \ \ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ PN\_stdfloat\ fl\ =\ do\_get\_focal\_length(lens\_cdata);}
\DoxyCodeLine{00070\ \ \ PN\_stdfloat\ fFar\ =\ do\_get\_far(lens\_cdata);}
\DoxyCodeLine{00071\ \ \ PN\_stdfloat\ fNear\ =\ do\_get\_near(lens\_cdata);}
\DoxyCodeLine{00072\ \ \ PN\_stdfloat\ a,\ b;}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \textcolor{comment}{//\ Take\ the\ limits\ if\ either\ near\ or\ far\ is\ infinite.}}
\DoxyCodeLine{00075\ \ \ \textcolor{keywordflow}{if}\ (cinf(fFar))\ \{}
\DoxyCodeLine{00076\ \ \ \ \ a\ =\ 1;}
\DoxyCodeLine{00077\ \ \ \ \ b\ =\ -\/2\ *\ fNear;}
\DoxyCodeLine{00078\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (cinf(fNear))\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{comment}{//\ This\ is\ valid\ if\ the\ near/far\ planes\ are\ inverted.}}
\DoxyCodeLine{00080\ \ \ \ \ a\ =\ -\/1;}
\DoxyCodeLine{00081\ \ \ \ \ b\ =\ 2\ *\ fFar;}
\DoxyCodeLine{00082\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00083\ \ \ \ \ PN\_stdfloat\ far\_minus\_near\ =\ fFar-\/fNear;}
\DoxyCodeLine{00084\ \ \ \ \ a\ =\ (fFar\ +\ fNear);}
\DoxyCodeLine{00085\ \ \ \ \ b\ =\ -\/2\ *\ fFar\ *\ fNear;}
\DoxyCodeLine{00086\ \ \ \ \ a\ /=\ far\_minus\_near;}
\DoxyCodeLine{00087\ \ \ \ \ b\ /=\ far\_minus\_near;}
\DoxyCodeLine{00088\ \ \ \}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ LMatrix4\ canonical;}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordflow}{switch}\ (cs)\ \{}
\DoxyCodeLine{00092\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_right:}
\DoxyCodeLine{00093\ \ \ \ \ canonical.set(\ \ fl,\ \ 0.0f,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ a,\ \ 1.0f,}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ \ fl,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ b,\ \ 0.0f);}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_right:}
\DoxyCodeLine{00100\ \ \ \ \ canonical.set(\ \ fl,\ \ 0.0f,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ \ fl,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ -\/a,\ -\/1.0f,}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ b,\ \ 0.0f);}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{case}\ CS\_zup\_left:}
\DoxyCodeLine{00107\ \ \ \ \ canonical.set(\ \ fl,\ \ 0.0f,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ -\/a,\ -\/1.0f,}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ \ fl,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ b,\ \ 0.0f);}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \textcolor{keywordflow}{case}\ CS\_yup\_left:}
\DoxyCodeLine{00114\ \ \ \ \ canonical.set(\ \ fl,\ \ 0.0f,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ \ \ fl,\ \ 0.0f,\ \ 0.0f,}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ a,\ \ 1.0f,}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ \ 0.0f,\ \ \ \ \ b,\ \ 0.0f);}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00121\ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00122\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ coordinate\ system\ "{}}\ <<\ (int)cs\ <<\ \textcolor{stringliteral}{"{}\ in\ PerspectiveLens!\(\backslash\)n"{}};}
\DoxyCodeLine{00123\ \ \ \ \ canonical\ =\ LMatrix4::ident\_mat();}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ lens\_cdata-\/>\_projection\_mat\ =\ do\_get\_lens\_mat\_inv(lens\_cdata)\ *\ canonical\ *\ do\_get\_film\_mat(lens\_cdata);}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \textcolor{keywordflow}{if}\ ((lens\_cdata-\/>\_user\_flags\ \&\ UF\_interocular\_distance)\ ==\ 0)\ \{}
\DoxyCodeLine{00129\ \ \ \ \ lens\_cdata-\/>\_projection\_mat\_left\ =\ lens\_cdata-\/>\_projection\_mat\_right\ =\ lens\_cdata-\/>\_projection\_mat;}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ left\ and\ right\ projection\ matrices\ in\ case\ this\ lens\ is}}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{comment}{//\ assigned\ to\ a\ stereo\ DisplayRegion.}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ LVector3\ iod\ =\ lens\_cdata-\/>\_interocular\_distance\ *\ 0.5f\ *\ LVector3::left(lens\_cdata-\/>\_cs);}
\DoxyCodeLine{00136\ \ \ \ \ lens\_cdata-\/>\_projection\_mat\_left\ =\ do\_get\_lens\_mat\_inv(lens\_cdata)\ *\ LMatrix4::translate\_mat(-\/iod)\ *\ canonical\ *\ do\_get\_film\_mat(lens\_cdata);}
\DoxyCodeLine{00137\ \ \ \ \ lens\_cdata-\/>\_projection\_mat\_right\ =\ do\_get\_lens\_mat\_inv(lens\_cdata)\ *\ LMatrix4::translate\_mat(iod)\ *\ canonical\ *\ do\_get\_film\_mat(lens\_cdata);}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{keywordflow}{if}\ ((lens\_cdata-\/>\_user\_flags\ \&\ UF\_convergence\_distance)\ !=\ 0\ \&\&}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ !cinf(lens\_cdata-\/>\_convergence\_distance))\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \ \ nassertv(lens\_cdata-\/>\_convergence\_distance\ !=\ 0.0f);}
\DoxyCodeLine{00142\ \ \ \ \ \ \ LVector3\ cd;}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stereo\_lens\_old\_convergence)\ \{\ \textcolor{comment}{//\ The\ old,\ incorrect\ calculation\ was\ requested.}}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ cd\ =\ (0.25f\ /\ lens\_cdata-\/>\_convergence\_distance)\ *\ LVector3::left(lens\_cdata-\/>\_cs);}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&fov\ =\ do\_get\_fov(lens\_cdata);}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ cd\ =\ (2.0f\ /\ \mbox{\hyperlink{classPerspectiveLens_a9e5f4a1e5914a041ff6445adacdc2359}{fov\_to\_film}}(fov[0],\ lens\_cdata-\/>\_convergence\_distance,\ \textcolor{keyword}{true}))\ *\ iod;}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ lens\_cdata-\/>\_projection\_mat\_left\ *=\ LMatrix4::translate\_mat(cd);}
\DoxyCodeLine{00150\ \ \ \ \ \ \ lens\_cdata-\/>\_projection\_mat\_right\ *=\ LMatrix4::translate\_mat(-\/cd);}
\DoxyCodeLine{00151\ \ \ \ \ \}}
\DoxyCodeLine{00152\ \ \ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ do\_adjust\_comp\_flags(lens\_cdata,}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat\_inv\ |\ CF\_projection\_mat\_left\_inv\ |\ CF\_projection\_mat\_right\_inv,}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CF\_projection\_mat);}
\DoxyCodeLine{00157\ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00165\ PN\_stdfloat\ \mbox{\hyperlink{classPerspectiveLens_a9e5f4a1e5914a041ff6445adacdc2359}{PerspectiveLens::}}}
\DoxyCodeLine{00166\ \mbox{\hyperlink{classPerspectiveLens_a9e5f4a1e5914a041ff6445adacdc2359}{fov\_to\_film}}(PN\_stdfloat\ fov,\ PN\_stdfloat\ focal\_length,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00167\ \ \ \textcolor{keywordflow}{return}\ (ctan(deg\_2\_rad(fov\ *\ 0.5f))\ *\ focal\_length)\ *\ 2.0f;}
\DoxyCodeLine{00168\ \}}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00176\ PN\_stdfloat\ \mbox{\hyperlink{classPerspectiveLens_a845acb73c6cfc498055538e88ad64c48}{PerspectiveLens::}}}
\DoxyCodeLine{00177\ \mbox{\hyperlink{classPerspectiveLens_a845acb73c6cfc498055538e88ad64c48}{fov\_to\_focal\_length}}(PN\_stdfloat\ fov,\ PN\_stdfloat\ film\_size,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00178\ \ \ \textcolor{keywordflow}{return}\ film\_size\ *\ 0.5f\ /\ ctan(deg\_2\_rad(fov\ *\ 0.5f));}
\DoxyCodeLine{00179\ \}}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00187\ PN\_stdfloat\ \mbox{\hyperlink{classPerspectiveLens_a9347f69c0df789a3ae8302cbc981489b}{PerspectiveLens::}}}
\DoxyCodeLine{00188\ \mbox{\hyperlink{classPerspectiveLens_a9347f69c0df789a3ae8302cbc981489b}{film\_to\_fov}}(PN\_stdfloat\ film\_size,\ PN\_stdfloat\ focal\_length,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{return}\ rad\_2\_deg(catan(film\_size\ *\ 0.5f\ /\ focal\_length))\ *\ 2.0f;}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00195\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPerspectiveLens_ae2bfe2be59412ada9296ede0856144af}{PerspectiveLens::}}}
\DoxyCodeLine{00196\ \mbox{\hyperlink{classPerspectiveLens_ae2bfe2be59412ada9296ede0856144af}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00197\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classPerspectiveLens_a04ebf39972eb8766d5e268f5b17153da}{make\_from\_bam}});}
\DoxyCodeLine{00198\ \}}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00205\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classPerspectiveLens_a04ebf39972eb8766d5e268f5b17153da}{PerspectiveLens::}}}
\DoxyCodeLine{00206\ \mbox{\hyperlink{classPerspectiveLens_a04ebf39972eb8766d5e268f5b17153da}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00207\ \ \ \mbox{\hyperlink{classPerspectiveLens}{PerspectiveLens}}\ *lens\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPerspectiveLens}{PerspectiveLens}};}
\DoxyCodeLine{00208\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00209\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00212\ \ \ lens-\/>\mbox{\hyperlink{classLens_ae07466afe50a236e96da1445c515ba95}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ \textcolor{keywordflow}{return}\ lens;}
\DoxyCodeLine{00215\ \}}

\end{DoxyCode}
