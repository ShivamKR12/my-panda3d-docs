\doxysection{python\+Callback\+Object.\+cxx}
\hypertarget{pythonCallbackObject_8cxx_source}{}\label{pythonCallbackObject_8cxx_source}\index{panda/src/putil/pythonCallbackObject.cxx@{panda/src/putil/pythonCallbackObject.cxx}}
\mbox{\hyperlink{pythonCallbackObject_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pythonCallbackObject_8h}{pythonCallbackObject.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ HAVE\_PYTHON}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}py\_panda.h"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pythonThread_8h}{pythonThread.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{callbackData_8h}{callbackData.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__putil_8h}{config\_putil.h}}"{}}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PythonCallbackObject::\_type\_handle;}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ Configure(config\_pythonCallbackObject);}
\DoxyCodeLine{00026\ ConfigureFn(config\_pythonCallbackObject)\ \{}
\DoxyCodeLine{00027\ \ \ PythonCallbackObject::init\_type();}
\DoxyCodeLine{00028\ \}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#ifndef\ CPPPARSER}}
\DoxyCodeLine{00031\ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_TypedObject;}
\DoxyCodeLine{00032\ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_PythonCallbackObject;}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00038\ PythonCallbackObject::}
\DoxyCodeLine{00039\ PythonCallbackObject(PyObject\ *function)\ \{}
\DoxyCodeLine{00040\ \ \ \_function\ =\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ set\_function(function);}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#if\ !defined(SIMPLE\_THREADS)\ \&\&\ defined(WITH\_THREAD)}}
\DoxyCodeLine{00045\ \ \ \textcolor{comment}{//\ Ensure\ that\ the\ Python\ threading\ system\ is\ initialized\ and\ ready\ to\ go.}}
\DoxyCodeLine{00046\ \ \ \textcolor{comment}{//\ WITH\_THREAD\ symbol\ defined\ within\ Python.h}}
\DoxyCodeLine{00047\ \ \ Py\_Initialize();}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#if\ PY\_VERSION\_HEX\ <\ 0x03090000}}
\DoxyCodeLine{00050\ \ \ \textcolor{comment}{//\ PyEval\_InitThreads\ is\ now\ a\ deprecated\ no-\/op\ in\ Python\ 3.9+}}
\DoxyCodeLine{00051\ \ \ PyEval\_InitThreads();}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ PY\_VERSION\_HEX}}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ WITH\_THREAD}}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00059\ PythonCallbackObject::}
\DoxyCodeLine{00060\ \string~PythonCallbackObject()\ \{}
\DoxyCodeLine{00061\ \ \ Py\_DECREF(\_function);}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00068\ \textcolor{keywordtype}{void}\ PythonCallbackObject::}
\DoxyCodeLine{00069\ set\_function(PyObject\ *function)\ \{}
\DoxyCodeLine{00070\ \ \ Py\_DECREF(\_function);}
\DoxyCodeLine{00071\ \ \ \_function\ =\ Py\_NewRef(function);}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{if}\ (\_function\ !=\ Py\_None\ \&\&\ !PyCallable\_Check(\_function))\ \{}
\DoxyCodeLine{00073\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}Invalid\ function\ passed\ to\ PythonCallbackObject"{}});}
\DoxyCodeLine{00074\ \ \ \}}
\DoxyCodeLine{00075\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00080\ PyObject\ *PythonCallbackObject::}
\DoxyCodeLine{00081\ get\_function()\ \{}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{return}\ Py\_NewRef(\_function);}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00088\ PyObject\ *PythonCallbackObject::}
\DoxyCodeLine{00089\ \_\_reduce\_\_()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00090\ \ \ \textcolor{keywordflow}{return}\ Py\_BuildValue(\textcolor{stringliteral}{"{}O(O)"{}},\ (PyObject\ *)Dtool\_GetPyTypeObject(\&Dtool\_PythonCallbackObject),\ \_function);}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00098\ \textcolor{keywordtype}{void}\ PythonCallbackObject::}
\DoxyCodeLine{00099\ do\_callback(\mbox{\hyperlink{classCallbackData}{CallbackData}}\ *cbdata)\ \{}
\DoxyCodeLine{00100\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00101\ \ \ \textcolor{comment}{//\ Use\ PyGILState\ to\ protect\ this\ asynchronous\ call.}}
\DoxyCodeLine{00102\ \ \ PyGILState\_STATE\ gstate;}
\DoxyCodeLine{00103\ \ \ gstate\ =\ PyGILState\_Ensure();}
\DoxyCodeLine{00104\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ do\_python\_callback(cbdata);}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00109\ \ \ PyGILState\_Release(gstate);}
\DoxyCodeLine{00110\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00111\ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00117\ \textcolor{keywordtype}{void}\ PythonCallbackObject::}
\DoxyCodeLine{00118\ do\_python\_callback(\mbox{\hyperlink{classCallbackData}{CallbackData}}\ *cbdata)\ \{}
\DoxyCodeLine{00119\ \ \ nassertv(cbdata\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{comment}{//\ Wrap\ the\ cbdata\ up\ in\ a\ Python\ object,\ then\ put\ it\ in\ a\ tuple,\ for\ the}}
\DoxyCodeLine{00122\ \ \ \textcolor{comment}{//\ argument\ list.}}
\DoxyCodeLine{00123\ \ \ PyObject\ *pycbdata\ =}
\DoxyCodeLine{00124\ \ \ \ \ DTool\_CreatePyInstanceTyped(cbdata,\ Dtool\_TypedObject,}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{false},\ \textcolor{keyword}{false},\ cbdata-\/>get\_type\_index());}
\DoxyCodeLine{00126\ \ \ PyObject\ *args\ =\ Py\_BuildValue(\textcolor{stringliteral}{"{}(O)"{}},\ pycbdata);}
\DoxyCodeLine{00127\ \ \ Py\_DECREF(pycbdata);}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ PyObject\ *result\ =\ PythonThread::call\_python\_func(\_function,\ args);}
\DoxyCodeLine{00130\ \ \ Py\_DECREF(args);}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{if}\ (PyErr\_Occurred()\ !=\ PyExc\_SystemExit)\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ util\_cat.error()}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Exception\ occurred\ in\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00136\ \ \ \ \ \}}
\DoxyCodeLine{00137\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00138\ \ \ \ \ Py\_DECREF(result);}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_PYTHON}}

\end{DoxyCode}
