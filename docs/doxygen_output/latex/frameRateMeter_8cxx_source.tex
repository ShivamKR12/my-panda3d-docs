\doxysection{frame\+Rate\+Meter.\+cxx}
\hypertarget{frameRateMeter_8cxx_source}{}\label{frameRateMeter_8cxx_source}\index{panda/src/grutil/frameRateMeter.cxx@{panda/src/grutil/frameRateMeter.cxx}}
\mbox{\hyperlink{frameRateMeter_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{frameRateMeter_8h}{frameRateMeter.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{camera_8h}{camera.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{displayRegion_8h}{displayRegion.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{orthographicLens_8h}{orthographicLens.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clockObject_8h}{clockObject.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__grutil_8h}{config\_grutil.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{depthTestAttrib_8h}{depthTestAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{depthWriteAttrib_8h}{depthWriteAttrib.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{omniBoundingVolume_8h}{omniBoundingVolume.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <stdio.h>}\ \ \textcolor{comment}{//\ For\ sprintf/snprintf}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ FrameRateMeter::\_show\_fps\_pcollector(\textcolor{stringliteral}{"{}*:Show\ fps"{}});}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ FrameRateMeter::\_type\_handle;}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00033\ FrameRateMeter::}
\DoxyCodeLine{00034\ FrameRateMeter(\textcolor{keyword}{const}\ std::string\ \&name)\ :}
\DoxyCodeLine{00035\ \ \ \mbox{\hyperlink{classTextNode}{TextNode}}(name),}
\DoxyCodeLine{00036\ \ \ \_last\_aspect\_ratio(-\/1)\ \{}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \textcolor{comment}{//\ Don't\ do\ frustum\ culling,\ as\ the\ text\ will\ always\ be\ in\ view.}}
\DoxyCodeLine{00041\ \ \ set\_bounds(\textcolor{keyword}{new}\ \mbox{\hyperlink{classOmniBoundingVolume}{OmniBoundingVolume}}());}
\DoxyCodeLine{00042\ \ \ set\_final(\textcolor{keyword}{true});}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \_show\_milliseconds\ =\ frame\_rate\_meter\_milliseconds;}
\DoxyCodeLine{00047\ \ \ \textcolor{keywordflow}{if}\ (\_show\_milliseconds)\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \_text\_pattern\ =\ frame\_rate\_meter\_ms\_text\_pattern;}
\DoxyCodeLine{00049\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \_text\_pattern\ =\ frame\_rate\_meter\_text\_pattern;}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \_update\_interval\ =\ frame\_rate\_meter\_update\_interval;}
\DoxyCodeLine{00054\ \ \ \_last\_update\ =\ 0.0f;}
\DoxyCodeLine{00055\ \ \ \_clock\_object\ =\ ClockObject::get\_global\_clock();}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \textcolor{comment}{//\ The\ top\ of\ the\ visible\ frame\ is\ 80\%\ of\ the\ line\ height,\ based\ on\ the}}
\DoxyCodeLine{00058\ \ \ \textcolor{comment}{//\ calculation\ within\ TextAssembler.}}
\DoxyCodeLine{00059\ \ \ PN\_stdfloat\ height\ =\ 1.0f;}
\DoxyCodeLine{00060\ \ \ \mbox{\hyperlink{classTextFont}{TextFont}}\ *font\ =\ get\_font();}
\DoxyCodeLine{00061\ \ \ \textcolor{keywordflow}{if}\ (font\ !=\ \textcolor{keyword}{nullptr})\{}
\DoxyCodeLine{00062\ \ \ \ \ height\ =\ font-\/>get\_line\_height()\ *\ 0.8;}
\DoxyCodeLine{00063\ \ \ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ set\_align(A\_right);}
\DoxyCodeLine{00066\ \ \ set\_transform(LMatrix4::scale\_mat(frame\_rate\_meter\_scale)\ *}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LMatrix4::translate\_mat(LVector3::rfu(-\/frame\_rate\_meter\_side\_margins\ *\ frame\_rate\_meter\_scale,\ 0.0f,\ -\/frame\_rate\_meter\_scale\ *\ height)));}
\DoxyCodeLine{00068\ \ \ set\_card\_color(0.0f,\ 0.0f,\ 0.0f,\ 0.4);}
\DoxyCodeLine{00069\ \ \ set\_card\_as\_margin(frame\_rate\_meter\_side\_margins,\ frame\_rate\_meter\_side\_margins,\ 0.1f,\ 0.0f);}
\DoxyCodeLine{00070\ \ \ \textcolor{comment}{//\ set\_usage\_hint(Geom::UH\_client);}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ do\_update(current\_thread);}
\DoxyCodeLine{00073\ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00078\ FrameRateMeter::}
\DoxyCodeLine{00079\ \string~FrameRateMeter()\ \{}
\DoxyCodeLine{00080\ \ \ clear\_window();}
\DoxyCodeLine{00081\ \}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00087\ \textcolor{keywordtype}{void}\ FrameRateMeter::}
\DoxyCodeLine{00088\ setup\_window(\mbox{\hyperlink{classGraphicsOutput}{GraphicsOutput}}\ *window)\ \{}
\DoxyCodeLine{00089\ \ \ clear\_window();}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \_window\ =\ window;}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \_root\ =\ \mbox{\hyperlink{classNodePath}{NodePath}}(\textcolor{stringliteral}{"{}frame\_rate\_root"{}});}
\DoxyCodeLine{00094\ \ \ \_root.attach\_new\_node(\textcolor{keyword}{this});}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ dt\ =\ DepthTestAttrib::make(DepthTestAttrib::M\_none);}
\DoxyCodeLine{00097\ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ dw\ =\ DepthWriteAttrib::make(DepthWriteAttrib::M\_off);}
\DoxyCodeLine{00098\ \ \ \_root.node()-\/>\mbox{\hyperlink{classPandaNode_ad28ec939c11631643be230d7f8ddcdf3}{set\_attrib}}(dt,\ 1);}
\DoxyCodeLine{00099\ \ \ \_root.node()-\/>\mbox{\hyperlink{classPandaNode_ad28ec939c11631643be230d7f8ddcdf3}{set\_attrib}}(dw,\ 1);}
\DoxyCodeLine{00100\ \ \ \_root.\mbox{\hyperlink{classNodePath_ac2f025c88d0438889ecf218ec0588aa2}{set\_material\_off}}(1);}
\DoxyCodeLine{00101\ \ \ \_root.\mbox{\hyperlink{classNodePath_ad5778817025e2547bf9864795d34e272}{set\_two\_sided}}(1,\ 1);}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{comment}{//\ If\ we\ don't\ set\ this\ explicitly,\ Panda\ will\ cause\ it\ to\ be\ rendered\ in\ a}}
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ back-\/to-\/front\ cull\ bin,\ which\ will\ cause\ the\ bounding\ volume\ to\ be}}
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//\ computed\ unnecessarily.\ \ Saves\ a\ little\ bit\ of\ overhead.}}
\DoxyCodeLine{00106\ \ \ \_root.set\_bin(\textcolor{stringliteral}{"{}unsorted"{}},\ 0);}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \textcolor{comment}{//\ Create\ a\ display\ region\ that\ covers\ the\ entire\ window.}}
\DoxyCodeLine{00109\ \ \ \_display\_region\ =\ \_window-\/>make\_mono\_display\_region();}
\DoxyCodeLine{00110\ \ \ \_display\_region-\/>set\_sort(frame\_rate\_meter\_layer\_sort);}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \textcolor{comment}{//\ Finally,\ we\ need\ a\ camera\ to\ associate\ with\ the\ display\ region.}}
\DoxyCodeLine{00113\ \ \ PT(\mbox{\hyperlink{classCamera}{Camera}})\ camera\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCamera}{Camera}}(\textcolor{stringliteral}{"{}frame\_rate\_camera"{}});}
\DoxyCodeLine{00114\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ camera\_np\ =\ \_root.attach\_new\_node(camera);}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ PT(\mbox{\hyperlink{classLens}{Lens}})\ lens\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classOrthographicLens}{OrthographicLens}};}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \textcolor{comment}{//\ We\ choose\ these\ values\ such\ that\ we\ can\ place\ the\ text\ against\ (0,\ 0).}}
\DoxyCodeLine{00119\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ left\ =\ -\/2.0f;}
\DoxyCodeLine{00120\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ right\ =\ 0.0f;}
\DoxyCodeLine{00121\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ bottom\ =\ -\/2.0f;}
\DoxyCodeLine{00122\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ top\ =\ 0.0f;}
\DoxyCodeLine{00123\ \ \ lens-\/>set\_film\_size(right\ -\/\ left,\ top\ -\/\ bottom);}
\DoxyCodeLine{00124\ \ \ lens-\/>set\_film\_offset((right\ +\ left)\ *\ 0.5,\ (top\ +\ bottom)\ *\ 0.5);}
\DoxyCodeLine{00125\ \ \ lens-\/>set\_near\_far(-\/1000,\ 1000);}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ camera-\/>set\_lens(lens);}
\DoxyCodeLine{00128\ \ \ camera-\/>set\_scene(\_root);}
\DoxyCodeLine{00129\ \ \ \_display\_region-\/>set\_camera(camera\_np);}
\DoxyCodeLine{00130\ \}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00135\ \textcolor{keywordtype}{void}\ FrameRateMeter::}
\DoxyCodeLine{00136\ clear\_window()\ \{}
\DoxyCodeLine{00137\ \ \ \textcolor{keywordflow}{if}\ (\_window\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \_window-\/>remove\_display\_region(\_display\_region);}
\DoxyCodeLine{00139\ \ \ \ \ \_window\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00140\ \ \ \ \ \_display\_region\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00141\ \ \ \}}
\DoxyCodeLine{00142\ \ \ \_root\ =\ \mbox{\hyperlink{classNodePath}{NodePath}}();}
\DoxyCodeLine{00143\ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00163\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classFrameRateMeter_aab144d830b054edd1b9cf4a80d21150a}{FrameRateMeter::}}}
\DoxyCodeLine{00164\ \mbox{\hyperlink{classFrameRateMeter_aab144d830b054edd1b9cf4a80d21150a}{cull\_callback}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data)\ \{}
\DoxyCodeLine{00165\ \ \ \textcolor{comment}{//\ This\ triggers\ when\ you\ try\ to\ parent\ a\ frame\ rate\ meter\ into\ the\ scene}}
\DoxyCodeLine{00166\ \ \ \textcolor{comment}{//\ graph\ yourself.\ \ Instead,\ use\ setup\_window().}}
\DoxyCodeLine{00167\ \ \ nassertr(\_display\_region\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ trav-\/>get\_current\_thread();}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{//\ Statistics}}
\DoxyCodeLine{00172\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_show\_fps\_pcollector,\ current\_thread);}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{comment}{//\ This\ is\ probably\ a\ good\ time\ to\ check\ if\ the\ aspect\ ratio\ on\ the\ window}}
\DoxyCodeLine{00175\ \ \ \textcolor{comment}{//\ has\ changed.}}
\DoxyCodeLine{00176\ \ \ \textcolor{keywordtype}{int}\ width\ =\ \_display\_region-\/>get\_pixel\_width();}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordtype}{int}\ height\ =\ \_display\_region-\/>get\_pixel\_height();}
\DoxyCodeLine{00178\ \ \ PN\_stdfloat\ aspect\_ratio\ =\ 1;}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{if}\ (width\ !=\ 0\ \&\&\ height\ !=\ 0)\ \{}
\DoxyCodeLine{00180\ \ \ \ \ aspect\_ratio\ =\ (PN\_stdfloat)height\ /\ (PN\_stdfloat)width;}
\DoxyCodeLine{00181\ \ \ \}}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{comment}{//\ Scale\ the\ transform\ by\ the\ calculated\ aspect\ ratio.}}
\DoxyCodeLine{00184\ \ \ \textcolor{keywordflow}{if}\ (aspect\_ratio\ !=\ \_last\_aspect\_ratio)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \_aspect\_ratio\_transform\ =\ TransformState::make\_scale(LVecBase3(aspect\_ratio,\ 1,\ 1));}
\DoxyCodeLine{00186\ \ \ \ \ \_last\_aspect\_ratio\ =\ aspect\_ratio;}
\DoxyCodeLine{00187\ \ \ \}}
\DoxyCodeLine{00188\ \ \ data.\_net\_transform\ =\ data.\_net\_transform-\/>compose(\_aspect\_ratio\_transform);}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ Check\ to\ see\ if\ it's\ time\ to\ update.}}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordtype}{double}\ now\ =\ \_clock\_object-\/>get\_frame\_time(current\_thread);}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordtype}{double}\ elapsed\ =\ now\ -\/\ \_last\_update;}
\DoxyCodeLine{00193\ \ \ \textcolor{keywordflow}{if}\ (elapsed\ <\ 0.0\ ||\ elapsed\ >=\ \_update\_interval)\ \{}
\DoxyCodeLine{00194\ \ \ \ \ do\_update(current\_thread);}
\DoxyCodeLine{00195\ \ \ \}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \textcolor{keywordflow}{return}\ TextNode::cull\_callback(trav,\ data);}
\DoxyCodeLine{00198\ \}}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00203\ \textcolor{keywordtype}{void}\ FrameRateMeter::}
\DoxyCodeLine{00204\ do\_update(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00205\ \ \ \_last\_update\ =\ \_clock\_object-\/>get\_frame\_time(current\_thread);}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \textcolor{keywordtype}{double}\ value\ =\ \_clock\_object-\/>get\_average\_frame\_rate(current\_thread);}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordtype}{double}\ deviation\ =\ \_clock\_object-\/>calc\_frame\_rate\_deviation(current\_thread);}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{if}\ (\_show\_milliseconds)\ \{}
\DoxyCodeLine{00211\ \ \ \ \ value\ =\ 1000.0\ /\ value;}
\DoxyCodeLine{00212\ \ \ \ \ deviation\ =\ 1000.0\ /\ deviation;}
\DoxyCodeLine{00213\ \ \ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ buffer\_size\ =\ 1024;}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordtype}{char}\ buffer[buffer\_size];}
\DoxyCodeLine{00217\ \textcolor{preprocessor}{\#ifdef\ \_WIN32}}
\DoxyCodeLine{00218\ \ \ \textcolor{comment}{//\ Windows\ doesn't\ define\ snprintf().\ \ Hope\ we\ don't\ overflow.}}
\DoxyCodeLine{00219\ \ \ sprintf(buffer,\ \_text\_pattern.c\_str(),\ value,\ deviation);}
\DoxyCodeLine{00220\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00221\ \ \ snprintf(buffer,\ buffer\_size,\ \_text\_pattern.c\_str(),\ value,\ deviation);}
\DoxyCodeLine{00222\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00223\ \ \ nassertv(strlen(buffer)\ <\ buffer\_size);}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{if}\ (get\_text()\ ==\ buffer)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \textcolor{comment}{//\ Never\ mind;\ the\ frame\ rate\ hasn't\ changed.}}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00228\ \ \ \}}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ set\_text(buffer);}
\DoxyCodeLine{00231\ \}}

\end{DoxyCode}
