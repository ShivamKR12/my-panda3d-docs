\doxysection{virtual\+File\+Mount\+HTTP.\+cxx}
\hypertarget{virtualFileMountHTTP_8cxx_source}{}\label{virtualFileMountHTTP_8cxx_source}\index{panda/src/downloader/virtualFileMountHTTP.cxx@{panda/src/downloader/virtualFileMountHTTP.cxx}}
\mbox{\hyperlink{virtualFileMountHTTP_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountHTTP_8h}{virtualFileMountHTTP.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileHTTP_8h}{virtualFileHTTP.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#if\ defined(HAVE\_OPENSSL)\ ||\ defined(\_\_EMSCRIPTEN\_\_)}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ VirtualFileMountHTTP::\_type\_handle;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00028\ VirtualFileMountHTTP::}
\DoxyCodeLine{00029\ VirtualFileMountHTTP(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&root,\ HTTPClient\ *http)\ :}
\DoxyCodeLine{00030\ \ \ \_http(http),}
\DoxyCodeLine{00031\ \ \ \_root(root)}
\DoxyCodeLine{00032\ \{}
\DoxyCodeLine{00033\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ root\ ends\ on\ a\ slash.\ \ The\ implicit\ trailing\ slash\ is\ a}}
\DoxyCodeLine{00034\ \ \ \textcolor{comment}{//\ semi-\/standard\ internet\ convention.}}
\DoxyCodeLine{00035\ \ \ \textcolor{keywordtype}{string}\ path\ =\ \_root.get\_path();}
\DoxyCodeLine{00036\ \ \ \textcolor{keywordflow}{if}\ (!path.empty()\ \&\&\ path[path.length()\ -\/\ 1]\ !=\ \textcolor{charliteral}{'/'})\ \{}
\DoxyCodeLine{00037\ \ \ \ \ path\ +=\ \textcolor{charliteral}{'/'};}
\DoxyCodeLine{00038\ \ \ \ \ \_root.set\_path(path);}
\DoxyCodeLine{00039\ \ \ \}}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00045\ VirtualFileMountHTTP::}
\DoxyCodeLine{00046\ \string~VirtualFileMountHTTP()\ \{}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00059\ \textcolor{keywordtype}{void}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00060\ reload\_vfs\_mount\_url()\ \{}
\DoxyCodeLine{00061\ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \textcolor{comment}{//\ First,\ unload\ the\ existing\ mounts.}}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordtype}{int}\ n\ =\ 0;}
\DoxyCodeLine{00065\ \ \ \textcolor{keywordflow}{while}\ (n\ <\ vfs-\/>get\_num\_mounts())\ \{}
\DoxyCodeLine{00066\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}})\ mount\ =\ vfs-\/>get\_mount(n);}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordflow}{if}\ (mount-\/>is\_of\_type(VirtualFileMountHTTP::get\_class\_type()))\ \{}
\DoxyCodeLine{00068\ \ \ \ \ \ \ vfs-\/>unmount(mount);}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ increment\ n.}}
\DoxyCodeLine{00070\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ ++n;}
\DoxyCodeLine{00072\ \ \ \ \ \}}
\DoxyCodeLine{00073\ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{comment}{//\ Now,\ reload\ the\ newly\ specified\ mounts.}}
\DoxyCodeLine{00076\ \ \ \mbox{\hyperlink{classConfigVariableList}{ConfigVariableList}}\ mounts}
\DoxyCodeLine{00077\ \ \ \ \ (\textcolor{stringliteral}{"{}vfs-\/mount-\/url"{}},}
\DoxyCodeLine{00078\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}vfs-\/mount-\/url\ http://site/path[:port]\ mount-\/point\ [options]"{}}));}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{keywordtype}{int}\ num\_unique\_values\ =\ mounts.get\_num\_unique\_values();}
\DoxyCodeLine{00081\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_unique\_values;\ i++)\ \{}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_desc\ =\ mounts.get\_unique\_value(i);}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ space\ =\ mount\_desc.rfind(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ ==\ string::npos)\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}No\ space\ in\ vfs-\/mount-\/url\ descriptor:\ "{}}\ <<\ mount\_desc\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_point\ =\ mount\_desc.substr(space\ +\ 1);}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ >\ 0\ \&\&\ isspace(mount\_desc[space\ -\/\ 1]))\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ space-\/-\/;}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00094\ \ \ \ \ \ \ mount\_desc\ =\ mount\_desc.substr(0,\ space);}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ options;}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \ \ \ \ space\ =\ mount\_desc.rfind(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ !=\ string::npos)\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ another\ space,\ we\ have\ the\ optional\ options\ field.}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ options\ =\ mount\_point;}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ mount\_point\ =\ mount\_desc.substr(space\ +\ 1);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ >\ 0\ \&\&\ isspace(mount\_desc[space\ -\/\ 1]))\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ -\/-\/space;}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ mount\_desc\ =\ mount\_desc.substr(0,\ space);}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \ \ mount\_desc\ =\ ExecutionEnvironment::expand\_string(mount\_desc);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ root(mount\_desc);}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags\ =\ 0;}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ password;}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{comment}{//\ Split\ the\ options\ up\ by\ commas.}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ 0;}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ q\ =\ options.find(\textcolor{charliteral}{','},\ p);}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (q\ !=\ string::npos)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ vfs-\/>\mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{parse\_option}}(options.substr(p,\ q\ -\/\ p),}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ password);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ p\ =\ q\ +\ 1;}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ q\ =\ options.find(\textcolor{charliteral}{','},\ p);}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00123\ \ \ \ \ \ \ vfs-\/>\mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{parse\_option}}(options.substr(p),\ flags,\ password);}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}})\ mount\ =\ \textcolor{keyword}{new}\ VirtualFileMountHTTP(root);}
\DoxyCodeLine{00126\ \ \ \ \ \ \ vfs-\/>mount(mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00127\ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \}}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00134\ \textcolor{keywordtype}{bool}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00135\ has\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00136\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00137\ \}}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00143\ \textcolor{keywordtype}{bool}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00144\ is\_directory(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00145\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00146\ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00152\ \textcolor{keywordtype}{bool}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00153\ is\_regular\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00154\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00155\ \}}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00163\ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ VirtualFileMountHTTP::}
\DoxyCodeLine{00164\ make\_virtual\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&local\_filename,}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&original\_filename,\ \textcolor{keywordtype}{bool}\ implicit\_pz\_file,}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ open\_flags)\ \{}
\DoxyCodeLine{00167\ \ \ PT(VirtualFileHTTP)\ vfile\ =}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{keyword}{new}\ VirtualFileHTTP(\textcolor{keyword}{this},\ local\_filename,\ implicit\_pz\_file,\ open\_flags);}
\DoxyCodeLine{00169\ \ \ vfile-\/>set\_original\_filename(original\_filename);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{return}\ vfile;}
\DoxyCodeLine{00172\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00179\ std::istream\ *VirtualFileMountHTTP::}
\DoxyCodeLine{00180\ open\_read\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00181\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00182\ \}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00189\ std::streamsize\ VirtualFileMountHTTP::}
\DoxyCodeLine{00190\ get\_file\_size(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&,\ std::istream\ *)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00192\ \}}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00198\ std::streamsize\ VirtualFileMountHTTP::}
\DoxyCodeLine{00199\ get\_file\_size(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00200\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00201\ \}}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00213\ time\_t\ VirtualFileMountHTTP::}
\DoxyCodeLine{00214\ get\_timestamp(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00215\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00216\ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00223\ \textcolor{keywordtype}{bool}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00224\ scan\_directory(vector\_string\ \&,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00226\ \}}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00231\ \textcolor{keywordtype}{void}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00232\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00233\ \ \ out\ <<\ \_root;}
\DoxyCodeLine{00234\ \}}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00240\ PT(HTTPChannel)\ VirtualFileMountHTTP::}
\DoxyCodeLine{00241\ get\_channel()\ \{}
\DoxyCodeLine{00242\ \ \ PT(HTTPChannel)\ channel;}
\DoxyCodeLine{00243\ \ \ \_channels\_lock.lock();}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \ \ \textcolor{keywordflow}{if}\ (!\_channels.empty())\ \{}
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ some\ channels\ sitting\ around,\ grab\ one.\ \ Grab\ the\ one\ on\ the}}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{comment}{//\ end;\ it\ was\ most\ recently\ pushed,\ and\ therefore\ most\ likely\ to\ be\ still}}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{comment}{//\ alive.}}
\DoxyCodeLine{00249\ \ \ \ \ channel\ =\ \_channels.back();}
\DoxyCodeLine{00250\ \ \ \ \ \_channels.pop\_back();}
\DoxyCodeLine{00251\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00252\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ any\ channels\ standing\ by,\ make\ a\ new\ one.}}
\DoxyCodeLine{00253\ \ \ \ \ channel\ =\ \_http-\/>make\_channel(\textcolor{keyword}{true});}
\DoxyCodeLine{00254\ \ \ \}}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \_channels\_lock.unlock();}
\DoxyCodeLine{00257\ \ \ \textcolor{keywordflow}{return}\ channel;}
\DoxyCodeLine{00258\ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00265\ \textcolor{keywordtype}{void}\ VirtualFileMountHTTP::}
\DoxyCodeLine{00266\ recycle\_channel(HTTPChannel\ *channel)\ \{}
\DoxyCodeLine{00267\ \ \ \_channels\_lock.lock();}
\DoxyCodeLine{00268\ \ \ \_channels.push\_back(channel);}
\DoxyCodeLine{00269\ \ \ \_channels\_lock.unlock();}
\DoxyCodeLine{00270\ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_OPENSSL}}

\end{DoxyCode}
