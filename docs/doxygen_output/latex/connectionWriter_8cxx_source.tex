\doxysection{connection\+Writer.\+cxx}
\hypertarget{connectionWriter_8cxx_source}{}\label{connectionWriter_8cxx_source}\index{panda/src/net/connectionWriter.cxx@{panda/src/net/connectionWriter.cxx}}
\mbox{\hyperlink{connectionWriter_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{connectionWriter_8h}{connectionWriter.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{connectionManager_8h}{connectionManager.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramTCPHeader_8h}{datagramTCPHeader.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__net_8h}{config\_net.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}socket\_tcp.h"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{socket__udp_8h}{socket\_udp.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnotify_8h}{pnotify.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__downloader_8h}{config\_downloader.h}}"{}}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00026\ ConnectionWriter::WriterThread::}
\DoxyCodeLine{00027\ WriterThread(\mbox{\hyperlink{classConnectionWriter}{ConnectionWriter}}\ *writer,\ \textcolor{keyword}{const}\ std::string\ \&thread\_name,}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ thread\_index)\ :}
\DoxyCodeLine{00029\ \ \ \mbox{\hyperlink{classThread}{Thread}}(make\_thread\_name(thread\_name,\ thread\_index),}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \ make\_thread\_name(thread\_name,\ thread\_index)),}
\DoxyCodeLine{00031\ \ \ \_writer(writer),}
\DoxyCodeLine{00032\ \ \ \_thread\_index(thread\_index)}
\DoxyCodeLine{00033\ \{}
\DoxyCodeLine{00034\ \}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00039\ \textcolor{keywordtype}{void}\ ConnectionWriter::WriterThread::}
\DoxyCodeLine{00040\ thread\_main()\ \{}
\DoxyCodeLine{00041\ \ \ \_writer-\/>thread\_run(\_thread\_index);}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00051\ ConnectionWriter::}
\DoxyCodeLine{00052\ ConnectionWriter(\mbox{\hyperlink{classConnectionManager}{ConnectionManager}}\ *manager,\ \textcolor{keywordtype}{int}\ num\_threads,}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ \&thread\_name)\ :}
\DoxyCodeLine{00054\ \ \ \_manager(manager)}
\DoxyCodeLine{00055\ \{}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordflow}{if}\ (!Thread::is\_threading\_supported())\ \{}
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_threads\ !=\ 0)\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (net\_cat.is\_debug())\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ net\_cat.debug()}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Threading\ support\ is\ not\ available.\(\backslash\)n"{}};}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00063\ \ \ \ \ \}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ NDEBUG}}
\DoxyCodeLine{00065\ \ \ \ \ num\_threads\ =\ 0;}
\DoxyCodeLine{00066\ \ \ \}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \_raw\_mode\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00069\ \ \ \_tcp\_header\_size\ =\ tcp\_header\_size;}
\DoxyCodeLine{00070\ \ \ \_immediate\ =\ (num\_threads\ <=\ 0);}
\DoxyCodeLine{00071\ \ \ \_shutdown\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ std::string\ writer\_thread\_name\ =\ thread\_name;}
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (thread\_name.empty())\ \{}
\DoxyCodeLine{00075\ \ \ \ \ writer\_thread\_name\ =\ \textcolor{stringliteral}{"{}WriterThread"{}};}
\DoxyCodeLine{00076\ \ \ \}}
\DoxyCodeLine{00077\ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_threads;\ i++)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ PT(WriterThread)\ thread\ =\ \textcolor{keyword}{new}\ WriterThread(\textcolor{keyword}{this},\ writer\_thread\_name,\ i);}
\DoxyCodeLine{00080\ \ \ \ \ \_threads.push\_back(thread);}
\DoxyCodeLine{00081\ \ \ \}}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_threads;\ i++)\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \_threads[i]-\/>start(net\_thread\_priority,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00084\ \ \ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \_manager-\/>add\_writer(\textcolor{keyword}{this});}
\DoxyCodeLine{00087\ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00092\ ConnectionWriter::}
\DoxyCodeLine{00093\ \string~ConnectionWriter()\ \{}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{if}\ (\_manager\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \_manager-\/>\mbox{\hyperlink{classConnectionManager_a7374a35ec67bd653bebd8d508359c0c7}{remove\_writer}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00096\ \ \ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ shutdown();}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00106\ \textcolor{keywordtype}{void}\ ConnectionWriter::}
\DoxyCodeLine{00107\ set\_max\_queue\_size(\textcolor{keywordtype}{int}\ max\_size)\ \{}
\DoxyCodeLine{00108\ \ \ \_queue.\mbox{\hyperlink{classDatagramQueue_ab7a760d662a908f6a7f413156af691d2}{set\_max\_queue\_size}}(max\_size);}
\DoxyCodeLine{00109\ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00115\ \textcolor{keywordtype}{int}\ ConnectionWriter::}
\DoxyCodeLine{00116\ get\_max\_queue\_size()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{return}\ \_queue.\mbox{\hyperlink{classDatagramQueue_a7ed1eed10cb995c1e679975a04413171}{get\_max\_queue\_size}}();}
\DoxyCodeLine{00118\ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00123\ \textcolor{keywordtype}{int}\ ConnectionWriter::}
\DoxyCodeLine{00124\ get\_current\_queue\_size()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00125\ \ \ \textcolor{keywordflow}{return}\ \_queue.\mbox{\hyperlink{classDatagramQueue_af86cdbb3b1bc838be0d79b78cf45f377}{get\_current\_queue\_size}}();}
\DoxyCodeLine{00126\ \}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00142\ \textcolor{keywordtype}{bool}\ ConnectionWriter::}
\DoxyCodeLine{00143\ send(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&datagram,\ \textcolor{keyword}{const}\ PT(\mbox{\hyperlink{classConnection}{Connection}})\ \&connection,\ \textcolor{keywordtype}{bool}\ block)\ \{}
\DoxyCodeLine{00144\ \ \ nassertr(!\_shutdown,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00145\ \ \ nassertr(connection\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00146\ \ \ nassertr(connection-\/>get\_socket()-\/>is\_exact\_type(Socket\_TCP::get\_class\_type()),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \mbox{\hyperlink{classNetDatagram}{NetDatagram}}\ copy(datagram);}
\DoxyCodeLine{00149\ \ \ copy.set\_connection(connection);}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{if}\ (\_immediate)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_raw\_mode)\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ connection-\/>send\_raw\_datagram(copy);}
\DoxyCodeLine{00154\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ connection-\/>send\_datagram(copy,\ \_tcp\_header\_size);}
\DoxyCodeLine{00156\ \ \ \ \ \}}
\DoxyCodeLine{00157\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{keywordflow}{return}\ \_queue.\mbox{\hyperlink{classDatagramQueue_ae83a40bf8d0f785620cef13734d98d3a}{insert}}(copy,\ block);}
\DoxyCodeLine{00159\ \ \ \}}
\DoxyCodeLine{00160\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00176\ \textcolor{keywordtype}{bool}\ ConnectionWriter::}
\DoxyCodeLine{00177\ send(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&datagram,\ \textcolor{keyword}{const}\ PT(\mbox{\hyperlink{classConnection}{Connection}})\ \&connection,}
\DoxyCodeLine{00178\ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNetAddress}{NetAddress}}\ \&address,\ \textcolor{keywordtype}{bool}\ block)\ \{}
\DoxyCodeLine{00179\ \ \ nassertr(!\_shutdown,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00180\ \ \ nassertr(connection\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00181\ \ \ nassertr(connection-\/>get\_socket()-\/>is\_exact\_type(Socket\_UDP::get\_class\_type()),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{keywordflow}{if}\ ((\textcolor{keywordtype}{int})datagram.get\_length()\ >\ maximum\_udp\_datagram)\ \{}
\DoxyCodeLine{00184\ \ \ \ \ net\_cat.warning()}
\DoxyCodeLine{00185\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ send\ UDP\ datagram\ of\ "{}}\ <<\ datagram.get\_length()}
\DoxyCodeLine{00186\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ bytes,\ more\ than\ the\(\backslash\)n"{}}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}currently\ defined\ maximum\ of\ "{}}\ <<\ maximum\_udp\_datagram}
\DoxyCodeLine{00188\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ bytes.\(\backslash\)n"{}};}
\DoxyCodeLine{00189\ \ \ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \mbox{\hyperlink{classNetDatagram}{NetDatagram}}\ copy(datagram);}
\DoxyCodeLine{00192\ \ \ copy.set\_connection(connection);}
\DoxyCodeLine{00193\ \ \ copy.set\_address(address);}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \textcolor{keywordflow}{if}\ (\_immediate)\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_raw\_mode)\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ connection-\/>send\_raw\_datagram(copy);}
\DoxyCodeLine{00198\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ connection-\/>send\_datagram(copy,\ \_tcp\_header\_size);}
\DoxyCodeLine{00200\ \ \ \ \ \}}
\DoxyCodeLine{00201\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \textcolor{keywordflow}{return}\ \_queue.\mbox{\hyperlink{classDatagramQueue_ae83a40bf8d0f785620cef13734d98d3a}{insert}}(copy,\ block);}
\DoxyCodeLine{00203\ \ \ \}}
\DoxyCodeLine{00204\ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00210\ \textcolor{keywordtype}{bool}\ ConnectionWriter::}
\DoxyCodeLine{00211\ is\_valid\_for\_udp(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&datagram)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00212\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})datagram.get\_length()\ <=\ maximum\_udp\_datagram;}
\DoxyCodeLine{00213\ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00219\ \mbox{\hyperlink{classConnectionManager}{ConnectionManager}}\ *ConnectionWriter::}
\DoxyCodeLine{00220\ get\_manager()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00221\ \ \ \textcolor{keywordflow}{return}\ \_manager;}
\DoxyCodeLine{00222\ \}}
\DoxyCodeLine{00223\ }
\DoxyCodeLine{00227\ \textcolor{keywordtype}{bool}\ ConnectionWriter::}
\DoxyCodeLine{00228\ is\_immediate()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00229\ \ \ \textcolor{keywordflow}{return}\ \_immediate;}
\DoxyCodeLine{00230\ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00235\ \textcolor{keywordtype}{int}\ ConnectionWriter::}
\DoxyCodeLine{00236\ get\_num\_threads()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00237\ \ \ \textcolor{keywordflow}{return}\ \_threads.size();}
\DoxyCodeLine{00238\ \}}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00250\ \textcolor{keywordtype}{void}\ ConnectionWriter::}
\DoxyCodeLine{00251\ set\_raw\_mode(\textcolor{keywordtype}{bool}\ mode)\ \{}
\DoxyCodeLine{00252\ \ \ \_raw\_mode\ =\ mode;}
\DoxyCodeLine{00253\ \}}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00258\ \textcolor{keywordtype}{bool}\ ConnectionWriter::}
\DoxyCodeLine{00259\ get\_raw\_mode()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{return}\ \_raw\_mode;}
\DoxyCodeLine{00261\ \}}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00269\ \textcolor{keywordtype}{void}\ ConnectionWriter::}
\DoxyCodeLine{00270\ set\_tcp\_header\_size(\textcolor{keywordtype}{int}\ tcp\_header\_size)\ \{}
\DoxyCodeLine{00271\ \ \ \_tcp\_header\_size\ =\ tcp\_header\_size;}
\DoxyCodeLine{00272\ \}}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00277\ \textcolor{keywordtype}{int}\ ConnectionWriter::}
\DoxyCodeLine{00278\ get\_tcp\_header\_size()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00279\ \ \ \textcolor{keywordflow}{return}\ \_tcp\_header\_size;}
\DoxyCodeLine{00280\ \}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00286\ \textcolor{keywordtype}{void}\ ConnectionWriter::}
\DoxyCodeLine{00287\ shutdown()\ \{}
\DoxyCodeLine{00288\ \ \ \textcolor{keywordflow}{if}\ (\_shutdown)\ \{}
\DoxyCodeLine{00289\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00290\ \ \ \}}
\DoxyCodeLine{00291\ \ \ \_shutdown\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \ \ \textcolor{comment}{//\ First,\ shutdown\ the\ queue.\ \ This\ will\ tell\ our\ threads\ they're\ done.}}
\DoxyCodeLine{00294\ \ \ \_queue.\mbox{\hyperlink{classDatagramQueue_a9bb0adc82b7a4cc74666eb8539c1f94b}{shutdown}}();}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \ \ \textcolor{comment}{//\ Now\ wait\ for\ all\ threads\ to\ terminate.}}
\DoxyCodeLine{00297\ \ \ Threads::iterator\ ti;}
\DoxyCodeLine{00298\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_threads.begin();\ ti\ !=\ \_threads.end();\ ++ti)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ (*ti)-\/>join();}
\DoxyCodeLine{00300\ \ \ \}}
\DoxyCodeLine{00301\ \ \ \_threads.clear();}
\DoxyCodeLine{00302\ \}}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00310\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classConnectionWriter_ad784e7d745f43d6fe1c602cd73faa4ef}{ConnectionWriter::}}}
\DoxyCodeLine{00311\ \mbox{\hyperlink{classConnectionWriter_ad784e7d745f43d6fe1c602cd73faa4ef}{clear\_manager}}()\ \{}
\DoxyCodeLine{00312\ \ \ \_manager\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00313\ \ \ shutdown();}
\DoxyCodeLine{00314\ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00319\ \textcolor{keywordtype}{void}\ ConnectionWriter::}
\DoxyCodeLine{00320\ thread\_run(\textcolor{keywordtype}{int}\ thread\_index)\ \{}
\DoxyCodeLine{00321\ \ \ nassertv(!\_immediate);}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ \mbox{\hyperlink{classNetDatagram}{NetDatagram}}\ datagram;}
\DoxyCodeLine{00324\ \ \ \textcolor{keywordflow}{while}\ (\_queue.\mbox{\hyperlink{classDatagramQueue_adc27e2c7773fa497c486b94723a83393}{extract}}(datagram))\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_raw\_mode)\ \{}
\DoxyCodeLine{00326\ \ \ \ \ \ \ datagram.get\_connection()-\/>send\_raw\_datagram(datagram);}
\DoxyCodeLine{00327\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00328\ \ \ \ \ \ \ datagram.get\_connection()-\/>send\_datagram(datagram,\ \_tcp\_header\_size);}
\DoxyCodeLine{00329\ \ \ \ \ \}}
\DoxyCodeLine{00330\ \ \ \ \ Thread::consider\_yield();}
\DoxyCodeLine{00331\ \ \ \}}
\DoxyCodeLine{00332\ \}}

\end{DoxyCode}
