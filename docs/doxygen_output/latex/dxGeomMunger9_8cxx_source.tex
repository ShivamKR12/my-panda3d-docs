\doxysection{dx\+Geom\+Munger9.\+cxx}
\hypertarget{dxGeomMunger9_8cxx_source}{}\label{dxGeomMunger9_8cxx_source}\index{panda/src/dxgsg9/dxGeomMunger9.cxx@{panda/src/dxgsg9/dxGeomMunger9.cxx}}
\mbox{\hyperlink{dxGeomMunger9_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dxGeomMunger9_8h}{dxGeomMunger9.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexReader_8h}{geomVertexReader.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__dxgsg9_8h}{config\_dxgsg9.h}}"{}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *DXGeomMunger9::\_deleted\_chain\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00020\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ DXGeomMunger9::\_type\_handle;}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00025\ DXGeomMunger9::}
\DoxyCodeLine{00026\ DXGeomMunger9(\mbox{\hyperlink{classGraphicsStateGuardian}{GraphicsStateGuardian}}\ *gsg,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state)\ :}
\DoxyCodeLine{00027\ \ \ \mbox{\hyperlink{classStandardMunger}{StandardMunger}}(gsg,\ state,\ 1,\ NT\_packed\_dabc,\ C\_color),}
\DoxyCodeLine{00028\ \ \ \_texture(nullptr),}
\DoxyCodeLine{00029\ \ \ \_tex\_gen(nullptr)}
\DoxyCodeLine{00030\ \{}
\DoxyCodeLine{00031\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTextureAttrib}{TextureAttrib}}\ *texture\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00032\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTexGenAttrib}{TexGenAttrib}}\ *tex\_gen\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00033\ \ \ state-\/>get\_attrib(texture);}
\DoxyCodeLine{00034\ \ \ state-\/>get\_attrib(tex\_gen);}
\DoxyCodeLine{00035\ \ \ \_texture\ =\ texture;}
\DoxyCodeLine{00036\ \ \ \_tex\_gen\ =\ tex\_gen;}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \ \textcolor{keywordflow}{if}\ (!gsg-\/>get\_color\_scale\_via\_lighting())\ \{}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{comment}{//\ We\ might\ need\ to\ munge\ the\ colors,\ if\ we\ are\ overriding\ the\ vertex}}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{comment}{//\ colors\ and\ the\ GSG\ can't\ cheat\ the\ color\ via\ lighting.}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classColorAttrib}{ColorAttrib}}\ *color\_attrib;}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *shader\_attrib;}
\DoxyCodeLine{00044\ \ \ \ \ state-\/>get\_attrib\_def(shader\_attrib);}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordflow}{if}\ (!shader\_attrib-\/>auto\_shader()\ \&\&}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ shader\_attrib-\/>get\_shader()\ ==\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ state-\/>get\_attrib(color\_attrib)\ \&\&}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ color\_attrib-\/>get\_color\_type()\ !=\ ColorAttrib::T\_vertex)\ \{}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (color\_attrib-\/>get\_color\_type()\ ==\ ColorAttrib::T\_off)\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \_color.set(1,\ 1,\ 1,\ 1);}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \_color\ =\ color\_attrib-\/>get\_color();}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classColorScaleAttrib}{ColorScaleAttrib}}\ *color\_scale\_attrib;}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (state-\/>get\_attrib(color\_scale\_attrib)\ \&\&}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ color\_scale\_attrib-\/>has\_scale())\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \_color.componentwise\_mult(color\_scale\_attrib-\/>get\_scale());}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \_munge\_color\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \_should\_munge\_state\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \_filtered\_texture\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00068\ \ \ \_reffed\_filtered\_texture\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00069\ \ \ \textcolor{keywordflow}{if}\ (texture\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \_filtered\_texture\ =\ texture-\/>filter\_to\_max(gsg-\/>get\_max\_texture\_stages());}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_filtered\_texture\ !=\ texture)\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \_filtered\_texture-\/>ref();}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \_reffed\_filtered\_texture\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00074\ \ \ \ \ \}}
\DoxyCodeLine{00075\ \ \ \}}
\DoxyCodeLine{00076\ \ \ \textcolor{comment}{//\ Set\ a\ callback\ to\ unregister\ ourselves\ when\ either\ the\ Texture\ or\ the}}
\DoxyCodeLine{00077\ \ \ \textcolor{comment}{//\ TexGen\ object\ gets\ deleted.}}
\DoxyCodeLine{00078\ \ \ \_texture.add\_callback(\textcolor{keyword}{this});}
\DoxyCodeLine{00079\ \ \ \_tex\_gen.add\_callback(\textcolor{keyword}{this});}
\DoxyCodeLine{00080\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00085\ DXGeomMunger9::}
\DoxyCodeLine{00086\ \string~DXGeomMunger9()\ \{}
\DoxyCodeLine{00087\ \ \ \textcolor{keywordflow}{if}\ (\_reffed\_filtered\_texture)\ \{}
\DoxyCodeLine{00088\ \ \ \ \ unref\_delete(\_filtered\_texture);}
\DoxyCodeLine{00089\ \ \ \ \ \_reffed\_filtered\_texture\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \_texture.remove\_callback(\textcolor{keyword}{this});}
\DoxyCodeLine{00093\ \ \ \_tex\_gen.remove\_callback(\textcolor{keyword}{this});}
\DoxyCodeLine{00094\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00101\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classDXGeomMunger9_a321fe6531c8bda5960fb38cee2b12d9b}{DXGeomMunger9::}}}
\DoxyCodeLine{00102\ \mbox{\hyperlink{classDXGeomMunger9_a321fe6531c8bda5960fb38cee2b12d9b}{wp\_callback}}(\textcolor{keywordtype}{void}\ *)\ \{}
\DoxyCodeLine{00103\ \ \ unregister\_myself();}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{keywordflow}{if}\ (\_reffed\_filtered\_texture)\ \{}
\DoxyCodeLine{00106\ \ \ \ \ unref\_delete(\_filtered\_texture);}
\DoxyCodeLine{00107\ \ \ \ \ \_reffed\_filtered\_texture\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00115\ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ DXGeomMunger9::}
\DoxyCodeLine{00116\ munge\_format\_impl(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}\ *orig,}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexAnimationSpec}{GeomVertexAnimationSpec}}\ \&animation)\ \{}
\DoxyCodeLine{00118\ \ \ \textcolor{keywordflow}{if}\ (dxgsg9\_cat.is\_debug())\ \{}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keywordflow}{if}\ (animation.get\_animation\_type()\ !=\ AT\_none)\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ dxgsg9\_cat.debug()}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}preparing\ animation\ type\ "{}}\ <<\ animation\ <<\ \textcolor{stringliteral}{"{}\ for\ "{}}\ <<\ *orig}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00123\ \ \ \ \ \}}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ \ \ \textcolor{comment}{//\ We\ have\ to\ build\ a\ completely\ new\ format\ that\ includes\ only\ the}}
\DoxyCodeLine{00126\ \ \ \textcolor{comment}{//\ appropriate\ components,\ in\ the\ appropriate\ order,\ in\ just\ one\ array.}}
\DoxyCodeLine{00127\ \ \ PT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ new\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}(*orig);}
\DoxyCodeLine{00128\ \ \ new\_format-\/>set\_animation(animation);}
\DoxyCodeLine{00129\ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ new\_array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}};}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *vertex\_type\ =\ orig-\/>get\_vertex\_column();}
\DoxyCodeLine{00132\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *normal\_type\ =\ orig-\/>get\_normal\_column();}
\DoxyCodeLine{00133\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *color\_type\ =\ orig-\/>get\_color\_column();}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \textcolor{keywordflow}{if}\ (vertex\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00136\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00137\ \ \ \ \ \ \ (InternalName::get\_vertex(),\ 3,\ NT\_float32,}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ vertex\_type-\/>get\_contents());}
\DoxyCodeLine{00139\ \ \ \ \ new\_format-\/>remove\_column(vertex\_type-\/>get\_name());}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ vertex\ type,\ not\ much\ we\ can\ do.}}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keywordflow}{return}\ orig;}
\DoxyCodeLine{00144\ \ \ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \textcolor{keywordflow}{if}\ (animation.get\_animation\_type()\ ==\ AT\_hardware\ \&\&}
\DoxyCodeLine{00147\ \ \ \ \ \ \ animation.get\_num\_transforms()\ >\ 0)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordflow}{if}\ (animation.get\_num\_transforms()\ >\ 1)\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ want\ hardware\ animation,\ we\ need\ to\ reserve\ space\ for\ the\ blend}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \textcolor{comment}{//\ weights.}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ (InternalName::get\_transform\_weight(),\ animation.get\_num\_transforms()\ -\/\ 1,}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ NT\_float32,\ C\_other);}
\DoxyCodeLine{00154\ \ \ \ \ \}}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{if}\ (animation.get\_indexed\_transforms())\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \textcolor{comment}{//\ Also,\ if\ we'll\ be\ indexing\ into\ the\ transform\ table,\ reserve\ space}}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \textcolor{comment}{//\ for\ the\ index.}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ (InternalName::get\_transform\_index(),\ 1,}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ NT\_packed\_dcba,\ C\_index);}
\DoxyCodeLine{00162\ \ \ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ the\ old\ weights\ and\ indices\ are\ removed,\ just\ in\ case.}}
\DoxyCodeLine{00165\ \ \ \ \ new\_format-\/>remove\_column(InternalName::get\_transform\_weight());}
\DoxyCodeLine{00166\ \ \ \ \ new\_format-\/>remove\_column(InternalName::get\_transform\_index());}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ And\ we\ don't\ need\ the\ transform\_blend\ table\ any\ more.}}
\DoxyCodeLine{00169\ \ \ \ \ new\_format-\/>remove\_column(InternalName::get\_transform\_blend());}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \textcolor{keywordflow}{if}\ (normal\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00173\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00174\ \ \ \ \ \ \ (InternalName::get\_normal(),\ 3,\ NT\_float32,\ C\_normal);}
\DoxyCodeLine{00175\ \ \ \ \ new\_format-\/>remove\_column(normal\_type-\/>get\_name());}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \textcolor{keywordflow}{if}\ (color\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00179\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00180\ \ \ \ \ \ \ (InternalName::get\_color(),\ 1,\ NT\_packed\_dabc,\ C\_color);}
\DoxyCodeLine{00181\ \ \ \ \ new\_format-\/>remove\_column(color\_type-\/>get\_name());}
\DoxyCodeLine{00182\ \ \ \}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \textcolor{comment}{//\ To\ support\ multitexture,\ we\ will\ need\ to\ add\ all\ of\ the\ relevant\ texcoord}}
\DoxyCodeLine{00185\ \ \ \textcolor{comment}{//\ types,\ and\ in\ the\ order\ specified\ by\ the\ TextureAttrib.}}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \textcolor{comment}{//\ Now\ set\ up\ each\ of\ the\ active\ texture\ coordinate\ stages-\/-\/or\ at\ least}}
\DoxyCodeLine{00188\ \ \ \textcolor{comment}{//\ those\ for\ which\ we're\ not\ generating\ texture\ coordinates\ automatically.}}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{keywordflow}{if}\ (\_filtered\_texture\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ \_filtered\_texture-\/>get\_num\_on\_ff\_stages();}
\DoxyCodeLine{00192\ \ \ \ \ vector\_int\ ff\_tc\_index(num\_stages,\ 0);}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{comment}{//\ Be\ sure\ we\ add\ the\ texture\ coordinates\ in\ the\ right\ order,\ as\ specified}}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{comment}{//\ by\ the\ attrib.\ \ To\ ensure\ this,\ we\ first\ walk\ through\ the\ stages\ of\ the}}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{comment}{//\ attrib\ and\ get\ the\ index\ numbers\ in\ the\ appropriate\ order.}}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordtype}{int}\ si,\ tc\_index;}
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{keywordtype}{int}\ max\_tc\_index\ =\ -\/1;}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <\ num\_stages;\ ++si)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ tc\_index\ =\ \_filtered\_texture-\/>get\_ff\_tc\_index(si);}
\DoxyCodeLine{00201\ \ \ \ \ \ \ nassertr(tc\_index\ <\ num\_stages,\ orig);}
\DoxyCodeLine{00202\ \ \ \ \ \ \ ff\_tc\_index[tc\_index]\ =\ si;}
\DoxyCodeLine{00203\ \ \ \ \ \ \ max\_tc\_index\ =\ std::max(tc\_index,\ max\_tc\_index);}
\DoxyCodeLine{00204\ \ \ \ \ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{comment}{//\ Now\ walk\ through\ the\ texture\ coordinates\ in\ the\ order\ they\ will\ appear}}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{comment}{//\ on\ the\ final\ geometry.\ \ For\ each\ one,\ get\ the\ texture\ coordinate\ name}}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{comment}{//\ from\ the\ associated\ stage.}}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keywordflow}{for}\ (tc\_index\ =\ 0;\ tc\_index\ <=\ max\_tc\_index;\ ++tc\_index)\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \ \ si\ =\ ff\_tc\_index[tc\_index];}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \mbox{\hyperlink{classTextureStage}{TextureStage}}\ *stage\ =\ \_filtered\_texture-\/>get\_on\_ff\_stage(si);}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ stage-\/>get\_texcoord\_name();}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *texcoord\_type\ =\ orig-\/>get\_column(name);}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (texcoord\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ (name,\ texcoord\_type-\/>get\_num\_values(),\ NT\_float32,\ C\_texcoord);}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ add\ something\ as\ a\ placeholder,\ even\ if\ the\ texture}}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ coordinates\ aren't\ defined.}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column(name,\ 2,\ NT\_float32,\ C\_texcoord);}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00224\ \ \ \ \ \ \ new\_format-\/>remove\_column(name);}
\DoxyCodeLine{00225\ \ \ \ \ \}}
\DoxyCodeLine{00226\ \ \ \}}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00228\ \ \ \textcolor{comment}{//\ Now\ go\ through\ the\ remaining\ arrays\ and\ make\ sure\ they\ are\ tightly}}
\DoxyCodeLine{00229\ \ \ \textcolor{comment}{//\ packed.\ \ If\ not,\ repack\ them.}}
\DoxyCodeLine{00230\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ new\_format-\/>get\_num\_arrays();\ ++i)\ \{}
\DoxyCodeLine{00231\ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ orig\_a\ =\ new\_format-\/>get\_array(i);}
\DoxyCodeLine{00232\ \ \ \ \ \textcolor{keywordflow}{if}\ (orig\_a-\/>count\_unused\_space()\ !=\ 0)\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ new\_a\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}};}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ orig\_a-\/>get\_num\_columns();\ ++j)\ \{}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *column\ =\ orig\_a-\/>get\_column(j);}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ new\_a-\/>add\_column(column-\/>get\_name(),\ column-\/>get\_num\_components(),}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ column-\/>get\_numeric\_type(),\ column-\/>get\_contents());}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ new\_format-\/>set\_array(i,\ new\_a);}
\DoxyCodeLine{00240\ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \}}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ FVF-\/style\ array\ we\ just\ built\ up\ is\ first\ in\ the\ list.}}
\DoxyCodeLine{00244\ \ \ new\_format-\/>insert\_array(0,\ new\_array\_format);}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{return}\ GeomVertexFormat::register\_format(new\_format);}
\DoxyCodeLine{00247\ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00253\ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ DXGeomMunger9::}
\DoxyCodeLine{00254\ premunge\_format\_impl(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}\ *orig)\ \{}
\DoxyCodeLine{00255\ \ \ \textcolor{comment}{//\ We\ have\ to\ build\ a\ completely\ new\ format\ that\ includes\ only\ the}}
\DoxyCodeLine{00256\ \ \ \textcolor{comment}{//\ appropriate\ components,\ in\ the\ appropriate\ order,\ in\ just\ one\ array.}}
\DoxyCodeLine{00257\ \ \ PT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ new\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}(*orig);}
\DoxyCodeLine{00258\ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ new\_array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}};}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *vertex\_type\ =\ orig-\/>get\_vertex\_column();}
\DoxyCodeLine{00261\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *normal\_type\ =\ orig-\/>get\_normal\_column();}
\DoxyCodeLine{00262\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *color\_type\ =\ orig-\/>get\_color\_column();}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ \ \ \textcolor{keywordflow}{if}\ (vertex\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00265\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00266\ \ \ \ \ \ \ (InternalName::get\_vertex(),\ 3,\ NT\_float32,}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ vertex\_type-\/>get\_contents());}
\DoxyCodeLine{00268\ \ \ \ \ new\_format-\/>remove\_column(vertex\_type-\/>get\_name());}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ vertex\ type,\ not\ much\ we\ can\ do.}}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{return}\ orig;}
\DoxyCodeLine{00273\ \ \ \}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \textcolor{keywordflow}{if}\ (normal\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00276\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00277\ \ \ \ \ \ \ (InternalName::get\_normal(),\ 3,\ NT\_float32,\ C\_normal);}
\DoxyCodeLine{00278\ \ \ \ \ new\_format-\/>remove\_column(normal\_type-\/>get\_name());}
\DoxyCodeLine{00279\ \ \ \}}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \textcolor{keywordflow}{if}\ (color\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00282\ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00283\ \ \ \ \ \ \ (InternalName::get\_color(),\ 1,\ NT\_packed\_dabc,\ C\_color);}
\DoxyCodeLine{00284\ \ \ \ \ new\_format-\/>remove\_column(color\_type-\/>get\_name());}
\DoxyCodeLine{00285\ \ \ \}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \textcolor{comment}{//\ To\ support\ multitexture,\ we\ will\ need\ to\ add\ all\ of\ the\ relevant\ texcoord}}
\DoxyCodeLine{00288\ \ \ \textcolor{comment}{//\ types,\ and\ in\ the\ order\ specified\ by\ the\ TextureAttrib.}}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ \textcolor{comment}{//\ Now\ set\ up\ each\ of\ the\ active\ texture\ coordinate\ stages-\/-\/or\ at\ least}}
\DoxyCodeLine{00291\ \ \ \textcolor{comment}{//\ those\ for\ which\ we're\ not\ generating\ texture\ coordinates\ automatically.}}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \ \ \textcolor{keywordflow}{if}\ (\_filtered\_texture\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ \_filtered\_texture-\/>get\_num\_on\_ff\_stages();}
\DoxyCodeLine{00295\ \ \ \ \ vector\_int\ ff\_tc\_index(num\_stages,\ 0);}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \ \ \ \ \textcolor{comment}{//\ Be\ sure\ we\ add\ the\ texture\ coordinates\ in\ the\ right\ order,\ as\ specified}}
\DoxyCodeLine{00298\ \ \ \ \ \textcolor{comment}{//\ by\ the\ attrib.\ \ To\ ensure\ this,\ we\ first\ walk\ through\ the\ stages\ of\ the}}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{comment}{//\ attrib\ and\ get\ the\ index\ numbers\ in\ the\ appropriate\ order.}}
\DoxyCodeLine{00300\ \ \ \ \ \textcolor{keywordtype}{int}\ si,\ tc\_index;}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keywordtype}{int}\ max\_tc\_index\ =\ -\/1;}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <\ num\_stages;\ ++si)\ \{}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ tc\_index\ =\ \_filtered\_texture-\/>get\_ff\_tc\_index(si);}
\DoxyCodeLine{00304\ \ \ \ \ \ \ nassertr(tc\_index\ <\ num\_stages,\ orig);}
\DoxyCodeLine{00305\ \ \ \ \ \ \ ff\_tc\_index[tc\_index]\ =\ si;}
\DoxyCodeLine{00306\ \ \ \ \ \ \ max\_tc\_index\ =\ std::max(tc\_index,\ max\_tc\_index);}
\DoxyCodeLine{00307\ \ \ \ \ \}}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{comment}{//\ Now\ walk\ through\ the\ texture\ coordinates\ in\ the\ order\ they\ will\ appear}}
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{comment}{//\ on\ the\ final\ geometry.\ \ For\ each\ one,\ get\ the\ texture\ coordinate\ name}}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{comment}{//\ from\ the\ associated\ stage.}}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{for}\ (tc\_index\ =\ 0;\ tc\_index\ <=\ max\_tc\_index;\ ++tc\_index)\ \{}
\DoxyCodeLine{00313\ \ \ \ \ \ \ si\ =\ ff\_tc\_index[tc\_index];}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \mbox{\hyperlink{classTextureStage}{TextureStage}}\ *stage\ =\ \_filtered\_texture-\/>get\_on\_ff\_stage(si);}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ stage-\/>get\_texcoord\_name();}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *texcoord\_type\ =\ orig-\/>get\_column(name);}
\DoxyCodeLine{00318\ }
\DoxyCodeLine{00319\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (texcoord\_type\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ (name,\ texcoord\_type-\/>get\_num\_values(),\ NT\_float32,\ C\_texcoord);}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ add\ something\ as\ a\ placeholder,\ even\ if\ the\ texture}}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ coordinates\ aren't\ defined.}}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ new\_array\_format-\/>add\_column(name,\ 2,\ NT\_float32,\ C\_texcoord);}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00327\ \ \ \ \ \ \ new\_format-\/>remove\_column(name);}
\DoxyCodeLine{00328\ \ \ \ \ \}}
\DoxyCodeLine{00329\ \ \ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ \ \ \textcolor{comment}{//\ Now\ go\ through\ the\ remaining\ arrays\ and\ make\ sure\ they\ are\ tightly}}
\DoxyCodeLine{00332\ \ \ \textcolor{comment}{//\ packed.\ \ If\ not,\ repack\ them.}}
\DoxyCodeLine{00333\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ new\_format-\/>get\_num\_arrays();\ ++i)\ \{}
\DoxyCodeLine{00334\ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ orig\_a\ =\ new\_format-\/>get\_array(i);}
\DoxyCodeLine{00335\ \ \ \ \ \textcolor{keywordflow}{if}\ (orig\_a-\/>count\_unused\_space()\ !=\ 0)\ \{}
\DoxyCodeLine{00336\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ new\_a\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}};}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ orig\_a-\/>get\_num\_columns();\ ++j)\ \{}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexColumn}{GeomVertexColumn}}\ *column\ =\ orig\_a-\/>get\_column(j);}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ new\_a-\/>add\_column(column-\/>get\_name(),\ column-\/>get\_num\_components(),}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ column-\/>get\_numeric\_type(),\ column-\/>get\_contents());}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00342\ \ \ \ \ \ \ new\_format-\/>set\_array(i,\ new\_a);}
\DoxyCodeLine{00343\ \ \ \ \ \}}
\DoxyCodeLine{00344\ \ \ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ FVF-\/style\ array\ we\ just\ built\ up\ is\ first\ in\ the\ list.}}
\DoxyCodeLine{00347\ \ \ new\_format-\/>insert\_array(0,\ new\_array\_format);}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \textcolor{keywordflow}{return}\ GeomVertexFormat::register\_format(new\_format);}
\DoxyCodeLine{00350\ \}}
\DoxyCodeLine{00351\ }
\DoxyCodeLine{00357\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDXGeomMunger9_ac7e9b42bf7d40843336321d93e07cdda}{DXGeomMunger9::}}}
\DoxyCodeLine{00358\ \mbox{\hyperlink{classDXGeomMunger9_ac7e9b42bf7d40843336321d93e07cdda}{compare\_to\_impl}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00359\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDXGeomMunger9}{DXGeomMunger9}}\ *om\ =\ DCAST(\mbox{\hyperlink{classDXGeomMunger9}{DXGeomMunger9}},\ other);}
\DoxyCodeLine{00360\ \ \ \textcolor{keywordflow}{if}\ (\_filtered\_texture\ !=\ om-\/>\_filtered\_texture)\ \{}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{keywordflow}{return}\ \_filtered\_texture\ <\ om-\/>\_filtered\_texture\ ?\ -\/1\ :\ 1;}
\DoxyCodeLine{00362\ \ \ \}}
\DoxyCodeLine{00363\ \ \ \textcolor{keywordflow}{if}\ (\_tex\_gen.owner\_before(om-\/>\_tex\_gen))\ \{}
\DoxyCodeLine{00364\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00365\ \ \ \}}
\DoxyCodeLine{00366\ \ \ \textcolor{keywordflow}{if}\ (om-\/>\_tex\_gen.owner\_before(\_tex\_gen))\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00368\ \ \ \}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classStandardMunger_ab576e6a2d439cb2790982c27309a6ac1}{StandardMunger::compare\_to\_impl}}(other);}
\DoxyCodeLine{00371\ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00378\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDXGeomMunger9_a6f9d105d9e34d137869389171d3d49b8}{DXGeomMunger9::}}}
\DoxyCodeLine{00379\ \mbox{\hyperlink{classDXGeomMunger9_a6f9d105d9e34d137869389171d3d49b8}{geom\_compare\_to\_impl}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00380\ \ \ \textcolor{comment}{//\ Unlike\ GLGeomMunger,\ we\ do\ consider\ \_filtered\_texture\ and\ \_tex\_gen}}
\DoxyCodeLine{00381\ \ \ \textcolor{comment}{//\ important\ for\ this\ purpose,\ since\ they\ control\ the\ number\ and\ order\ of}}
\DoxyCodeLine{00382\ \ \ \textcolor{comment}{//\ texture\ coordinates\ we\ might\ put\ into\ the\ FVF.}}
\DoxyCodeLine{00383\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDXGeomMunger9}{DXGeomMunger9}}\ *om\ =\ DCAST(\mbox{\hyperlink{classDXGeomMunger9}{DXGeomMunger9}},\ other);}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordflow}{if}\ (\_filtered\_texture\ !=\ om-\/>\_filtered\_texture)\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordflow}{return}\ \_filtered\_texture\ <\ om-\/>\_filtered\_texture\ ?\ -\/1\ :\ 1;}
\DoxyCodeLine{00386\ \ \ \}}
\DoxyCodeLine{00387\ \ \ \textcolor{keywordflow}{if}\ (\_tex\_gen.owner\_before(om-\/>\_tex\_gen))\ \{}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00389\ \ \ \}}
\DoxyCodeLine{00390\ \ \ \textcolor{keywordflow}{if}\ (om-\/>\_tex\_gen.owner\_before(\_tex\_gen))\ \{}
\DoxyCodeLine{00391\ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00392\ \ \ \}}
\DoxyCodeLine{00393\ }
\DoxyCodeLine{00394\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classStandardMunger_a2e3cbc4646d2bacec9ec4f6ca724c50a}{StandardMunger::geom\_compare\_to\_impl}}(other);}
\DoxyCodeLine{00395\ \}}

\end{DoxyCode}
