\doxysection{collision\+Inv\+Sphere.\+cxx}
\hypertarget{collisionInvSphere_8cxx_source}{}\label{collisionInvSphere_8cxx_source}\index{panda/src/collide/collisionInvSphere.cxx@{panda/src/collide/collisionInvSphere.cxx}}
\mbox{\hyperlink{collisionInvSphere_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionInvSphere_8h}{collisionInvSphere.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSphere_8h}{collisionSphere.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionCapsule_8h}{collisionCapsule.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionLine_8h}{collisionLine.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionParabola_8h}{collisionParabola.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionRay_8h}{collisionRay.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSegment_8h}{collisionSegment.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionHandler_8h}{collisionHandler.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionEntry_8h}{collisionEntry.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__collide_8h}{config\_collide.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{omniBoundingVolume_8h}{omniBoundingVolume.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nearly__zero_8h}{nearly\_zero.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTristrips_8h}{geomTristrips.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionInvSphere::\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionInvSphere"{}});}
\DoxyCodeLine{00036\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionInvSphere::\_test\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionInvSphere"{}});}
\DoxyCodeLine{00037\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CollisionInvSphere::\_type\_handle;}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00042\ \mbox{\hyperlink{classCollisionSolid}{CollisionSolid}}\ *CollisionInvSphere::}
\DoxyCodeLine{00043\ make\_copy()\ \{}
\DoxyCodeLine{00044\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionInvSphere}{CollisionInvSphere}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00045\ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00050\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00051\ test\_intersection(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00052\ \ \ \mbox{\hyperlink{classCollisionSolid_acdc0f5568ef91b5147ab5afc142f9f75}{report\_undefined\_from\_intersection}}(get\_type());}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00060\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionInvSphere_a14b62fd6bd4595ae860a90cd734a10a3}{CollisionInvSphere::}}}
\DoxyCodeLine{00061\ \mbox{\hyperlink{classCollisionInvSphere_a14b62fd6bd4595ae860a90cd734a10a3}{get\_volume\_pcollector}}()\ \{}
\DoxyCodeLine{00062\ \ \ \textcolor{keywordflow}{return}\ \_volume\_pcollector;}
\DoxyCodeLine{00063\ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00069\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionInvSphere_a72a3a7af20b772068d3beee776603c73}{CollisionInvSphere::}}}
\DoxyCodeLine{00070\ \mbox{\hyperlink{classCollisionInvSphere_a72a3a7af20b772068d3beee776603c73}{get\_test\_pcollector}}()\ \{}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{return}\ \_test\_pcollector;}
\DoxyCodeLine{00072\ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00077\ \textcolor{keywordtype}{void}\ CollisionInvSphere::}
\DoxyCodeLine{00078\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00079\ \ \ out\ <<\ \textcolor{stringliteral}{"{}invsphere,\ c\ ("{}}\ <<\ get\_center()\ <<\ \textcolor{stringliteral}{"{}),\ r\ "{}}\ <<\ get\_radius();}
\DoxyCodeLine{00080\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00085\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ CollisionInvSphere::}
\DoxyCodeLine{00086\ compute\_internal\_bounds()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00087\ \ \ \textcolor{comment}{//\ An\ inverse\ sphere\ always\ has\ an\ infinite\ bounding\ volume,\ since}}
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//\ everything\ outside\ the\ sphere\ is\ solid\ matter.}}
\DoxyCodeLine{00089\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classOmniBoundingVolume}{OmniBoundingVolume}}();}
\DoxyCodeLine{00090\ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00095\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00096\ test\_intersection\_from\_sphere(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00097\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}\ *sphere;}
\DoxyCodeLine{00098\ \ \ DCAST\_INTO\_R(sphere,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ LPoint3\ from\_center\ =\ sphere-\/>get\_center()\ *\ wrt\_mat;}
\DoxyCodeLine{00103\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00104\ \ \ \ \ LVector3(sphere-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00105\ \ \ PN\_stdfloat\ from\_radius\ =\ length(from\_radius\_v);}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ LPoint3\ into\_center\ =\ get\_center();}
\DoxyCodeLine{00108\ \ \ PN\_stdfloat\ into\_radius\ =\ get\_radius();}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ LVector3\ vec\ =\ from\_center\ -\/\ into\_center;}
\DoxyCodeLine{00111\ \ \ PN\_stdfloat\ dist2\ =\ dot(vec,\ vec);}
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{if}\ (dist2\ <\ (into\_radius\ -\/\ from\_radius)\ *\ (into\_radius\ -\/\ from\_radius))\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{comment}{//\ No\ intersection-\/-\/the\ sphere\ is\ within\ the\ hollow.}}
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00115\ \ \ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00118\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00119\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00120\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00121\ \ \ \}}
\DoxyCodeLine{00122\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ LVector3\ surface\_normal;}
\DoxyCodeLine{00125\ \ \ PN\_stdfloat\ vec\_length\ =\ vec.length();}
\DoxyCodeLine{00126\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(vec\_length))\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ have\ a\ collision\ normal\ (e.g.\ \ the\ centers\ are\ exactly}}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{comment}{//\ coincident),\ then\ make\ up\ an\ arbitrary\ normal-\/-\/any\ one\ is\ as\ good\ as}}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{comment}{//\ any\ other.}}
\DoxyCodeLine{00130\ \ \ \ \ surface\_normal.set(1.0,\ 0.0,\ 0.0);}
\DoxyCodeLine{00131\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00132\ \ \ \ \ surface\_normal\ =\ vec\ /\ -\/vec\_length;}
\DoxyCodeLine{00133\ \ \ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ LVector3\ normal\ =\ (has\_effective\_normal()\ \&\&\ sphere-\/>get\_respect\_effective\_normal())\ ?\ get\_effective\_normal()\ :\ surface\_normal;}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00138\ \ \ new\_entry-\/>set\_surface\_point(into\_center\ -\/\ surface\_normal\ *\ into\_radius);}
\DoxyCodeLine{00139\ \ \ new\_entry-\/>set\_interior\_point(from\_center\ -\/\ surface\_normal\ *\ from\_radius);}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00142\ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00147\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00148\ test\_intersection\_from\_line(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionLine}{CollisionLine}}\ *line;}
\DoxyCodeLine{00150\ \ \ DCAST\_INTO\_R(line,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ LPoint3\ from\_origin\ =\ line-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00155\ \ \ LVector3\ from\_direction\ =\ line-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00158\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ The\ line\ is\ in\ the\ middle\ of\ space,\ and\ therefore\ intersects\ the}}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{comment}{//\ sphere.}}
\DoxyCodeLine{00161\ \ \ \ \ t1\ =\ t2\ =\ 0.0;}
\DoxyCodeLine{00162\ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00165\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00166\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00167\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00168\ \ \ \}}
\DoxyCodeLine{00169\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_origin\ +\ t2\ *\ from\_direction;}
\DoxyCodeLine{00172\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ line-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00175\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00176\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00177\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00178\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00179\ \ \ \ \ new\_entry-\/>set\_surface\_normal(-\/normal);}
\DoxyCodeLine{00180\ \ \ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00188\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00189\ test\_intersection\_from\_ray(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00190\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionRay}{CollisionRay}}\ *ray;}
\DoxyCodeLine{00191\ \ \ DCAST\_INTO\_R(ray,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ LPoint3\ from\_origin\ =\ ray-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00196\ \ \ LVector3\ from\_direction\ =\ ray-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{comment}{//\ The\ ray\ is\ in\ the\ middle\ of\ space,\ and\ therefore\ intersects\ the\ sphere.}}
\DoxyCodeLine{00201\ \ \ \ \ t1\ =\ t2\ =\ 0.0;}
\DoxyCodeLine{00202\ \ \ \}}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \ \ t2\ =\ std::max(t2,\ 0.0);}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00207\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00208\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00209\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00210\ \ \ \}}
\DoxyCodeLine{00211\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ LPoint3\ into\_intersection\_point;}
\DoxyCodeLine{00214\ \ \ into\_intersection\_point\ =\ from\_origin\ +\ t2\ *\ from\_direction;}
\DoxyCodeLine{00215\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ ray-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00218\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00219\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00220\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00221\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00222\ \ \ \ \ new\_entry-\/>set\_surface\_normal(-\/normal);}
\DoxyCodeLine{00223\ \ \ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00226\ \}}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00231\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00232\ test\_intersection\_from\_segment(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00233\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSegment}{CollisionSegment}}\ *segment;}
\DoxyCodeLine{00234\ \ \ DCAST\_INTO\_R(segment,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ LPoint3\ from\_a\ =\ segment-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00239\ \ \ LPoint3\ from\_b\ =\ segment-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00240\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00243\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1,\ t2,\ from\_a,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{comment}{//\ The\ segment\ is\ in\ the\ middle\ of\ space,\ and\ therefore\ intersects\ the}}
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{comment}{//\ sphere.}}
\DoxyCodeLine{00246\ \ \ \ \ t1\ =\ t2\ =\ 0.0;}
\DoxyCodeLine{00247\ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \textcolor{keywordtype}{double}\ t;}
\DoxyCodeLine{00250\ \ \ \textcolor{keywordflow}{if}\ (t2\ <=\ 0.0)\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{comment}{//\ The\ segment\ is\ completely\ below\ the\ shell.}}
\DoxyCodeLine{00252\ \ \ \ \ t\ =\ 0.0;}
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00254\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1\ >=\ 1.0)\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \textcolor{comment}{//\ The\ segment\ is\ completely\ above\ the\ shell.}}
\DoxyCodeLine{00256\ \ \ \ \ t\ =\ 1.0;}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00258\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t2\ <=\ 1.0)\ \{}
\DoxyCodeLine{00259\ \ \ \ \ \textcolor{comment}{//\ The\ bottom\ edge\ of\ the\ segment\ intersects\ the\ shell.}}
\DoxyCodeLine{00260\ \ \ \ \ t\ =\ std::min(t2,\ 1.0);}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1\ >=\ 0.0)\ \{}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ The\ top\ edge\ of\ the\ segment\ intersects\ the\ shell.}}
\DoxyCodeLine{00264\ \ \ \ \ t\ =\ std::max(t1,\ 0.0);}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{comment}{//\ Neither\ edge\ of\ the\ segment\ intersects\ the\ shell.\ \ It\ follows\ that\ both}}
\DoxyCodeLine{00268\ \ \ \ \ \textcolor{comment}{//\ intersection\ points\ are\ within\ the\ hollow\ center\ of\ the\ sphere;}}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{comment}{//\ therefore,\ there\ is\ no\ intersection.}}
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00271\ \ \ \}}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00274\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00275\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00276\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00277\ \ \ \}}
\DoxyCodeLine{00278\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_a\ +\ t\ *\ from\_direction;}
\DoxyCodeLine{00281\ \ \ new\_entry-\/>set\_surface\_point(into\_intersection\_point);}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00283\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ segment-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00284\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00285\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00286\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00287\ \ \ \ \ normal.normalize();}
\DoxyCodeLine{00288\ \ \ \ \ new\_entry-\/>set\_surface\_normal(-\/normal);}
\DoxyCodeLine{00289\ \ \ \}}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00291\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00292\ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00296\ test\_intersection\_from\_parabola(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00297\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionParabola}{CollisionParabola}}\ *parabola;}
\DoxyCodeLine{00298\ \ \ DCAST\_INTO\_R(parabola,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00301\ }
\DoxyCodeLine{00302\ \ \ \textcolor{comment}{//\ Convert\ the\ parabola\ into\ local\ coordinate\ space}}
\DoxyCodeLine{00303\ \ \ LParabola\ local\_p(parabola-\/>get\_parabola());}
\DoxyCodeLine{00304\ \ \ local\_p.xform(wrt\_mat);}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{keywordtype}{double}\ t;}
\DoxyCodeLine{00307\ \ \ LPoint3\ into\_intersection\_point;}
\DoxyCodeLine{00308\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_parabola(t,\ local\_p,\ parabola-\/>get\_t1(),\ parabola-\/>get\_t2(),}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t1()),}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t2()),\ into\_intersection\_point))\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00313\ \ \ \}}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00316\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00317\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00318\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00319\ \ \ \}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ LVector3\ normal\ =\ into\_intersection\_point\ -\/\ get\_center();}
\DoxyCodeLine{00324\ \ \ normal.normalize();}
\DoxyCodeLine{00325\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ parabola-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00326\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00327\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00328\ \ \ \ \ new\_entry-\/>set\_surface\_normal(-\/normal);}
\DoxyCodeLine{00329\ \ \ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ \ \ LPoint3\ surface\_point\ =\ normal\ *\ get\_radius()\ +\ get\_center();}
\DoxyCodeLine{00332\ \ \ new\_entry-\/>set\_surface\_point(surface\_point);}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00335\ \}}
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \textcolor{keywordtype}{bool}\ CollisionInvSphere::}
\DoxyCodeLine{00339\ intersects\_parabola(\textcolor{keywordtype}{double}\ \&t,\ \textcolor{keyword}{const}\ LParabola\ \&parabola,}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ t1,\ \textcolor{keywordtype}{double}\ t2,}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&p1,\ \textcolor{keyword}{const}\ LPoint3\ \&p2,\ LPoint3\ \&into\_intersection\_point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \textcolor{comment}{/*\ The\ method\ is\ pretty\ much\ identical\ to\ CollisionSphere::intersects\_parabola:}}
\DoxyCodeLine{00344\ \textcolor{comment}{\ \ \ *\ recursively\ divide\ the\ parabola\ into\ "{}close\ enough"{}\ line\ segments,\ and\ test}}
\DoxyCodeLine{00345\ \textcolor{comment}{\ \ \ *\ their\ intersection\ with\ the\ sphere\ using\ tests\ similar\ to}}
\DoxyCodeLine{00346\ \textcolor{comment}{\ \ \ *\ CollisionInvSphere::test\_intersection\_from\_segment.\ Returns\ the}}
\DoxyCodeLine{00347\ \textcolor{comment}{\ \ \ *\ point\ of\ intersection\ via\ pass-\/by-\/reference.}}
\DoxyCodeLine{00348\ \textcolor{comment}{\ \ \ */}}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00350\ \ \ \textcolor{keywordflow}{if}\ (t1\ ==\ t2)\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{comment}{//\ Special\ case:\ a\ single\ point.}}
\DoxyCodeLine{00352\ \ \ \ \ \textcolor{keywordflow}{if}\ ((p1\ -\/\ get\_center()).length\_squared()\ <\ get\_radius()\ *\ get\_radius())\ \{}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00355\ \ \ \ \ \}}
\DoxyCodeLine{00356\ \ \ \ \ t\ =\ t1;}
\DoxyCodeLine{00357\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00358\ \ \ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ \ \ \textcolor{keywordtype}{double}\ tmid\ =\ (t1\ +\ t2)\ *\ 0.5;}
\DoxyCodeLine{00361\ \ \ \textcolor{keywordflow}{if}\ (tmid\ !=\ t1\ \&\&\ tmid\ !=\ t2)\ \{}
\DoxyCodeLine{00362\ \ \ \ \ LPoint3\ pmid\ =\ parabola.calc\_point(tmid);}
\DoxyCodeLine{00363\ \ \ \ \ LPoint3\ pmid2\ =\ (p1\ +\ p2)\ *\ 0.5f;}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{if}\ ((pmid\ -\/\ pmid2).length\_squared()\ >\ 0.001f)\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (intersects\_parabola(t,\ parabola,\ t1,\ tmid,\ p1,\ pmid,\ into\_intersection\_point))\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ intersects\_parabola(t,\ parabola,\ tmid,\ t2,\ pmid,\ p2,\ into\_intersection\_point);}
\DoxyCodeLine{00370\ \ \ \ \ \}}
\DoxyCodeLine{00371\ \ \ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \ \ \textcolor{comment}{//\ Line\ segment\ is\ close\ enough\ to\ parabola.\ Test\ for\ intersections}}
\DoxyCodeLine{00374\ \ \ \textcolor{keywordtype}{double}\ t1a,\ t2a;}
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classCollisionSphere_ab33f7176c40417a89430548f9f7a0e47}{intersects\_line}}(t1a,\ t2a,\ p1,\ p2\ -\/\ p1,\ 0.0f))\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{comment}{//\ segment\ is\ somewhere\ outside\ the\ sphere,\ so}}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{comment}{//\ we\ have\ an\ intersection,\ simply\ return\ the\ first\ point}}
\DoxyCodeLine{00378\ \ \ \ \ t\ =\ 0.0;}
\DoxyCodeLine{00379\ \ \ \}}
\DoxyCodeLine{00380\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \textcolor{keywordflow}{if}\ (t2a\ <=\ 0.0)\ \{}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \textcolor{comment}{//\ segment\ completely\ below\ sphere}}
\DoxyCodeLine{00383\ \ \ \ \ \ \ t\ =\ 0.0;}
\DoxyCodeLine{00384\ \ \ \ \ \}}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1a\ >=\ 1.0)\ \{}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \textcolor{comment}{//\ segment\ acompletely\ bove\ sphere}}
\DoxyCodeLine{00387\ \ \ \ \ \ \ t\ =\ 1.0;}
\DoxyCodeLine{00388\ \ \ \ \ \}}
\DoxyCodeLine{00389\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t2a\ <=\ 1.0)\ \{}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \textcolor{comment}{//\ bottom\ edge\ intersects\ sphere}}
\DoxyCodeLine{00391\ \ \ \ \ \ \ t\ =\ t2a;}
\DoxyCodeLine{00392\ \ \ \ \ \}}
\DoxyCodeLine{00393\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1a\ >=\ 0.0)\ \{}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \textcolor{comment}{//\ top\ edge\ intersects\ sphere}}
\DoxyCodeLine{00395\ \ \ \ \ \ \ t\ =\ t1a;}
\DoxyCodeLine{00396\ \ \ \ \ \}}
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \textcolor{comment}{//\ completely\ inside\ sphere,\ no\ intersection}}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00400\ \ \ \ \ \}}
\DoxyCodeLine{00401\ \ \ \}}
\DoxyCodeLine{00402\ \ \ into\_intersection\_point\ =\ p1\ +\ t\ *\ (p2\ -\/\ p1);}
\DoxyCodeLine{00403\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00404\ \}}
\DoxyCodeLine{00405\ }
\DoxyCodeLine{00409\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00410\ test\_intersection\_from\_capsule(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00411\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}\ *capsule;}
\DoxyCodeLine{00412\ \ \ DCAST\_INTO\_R(capsule,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00414\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00415\ }
\DoxyCodeLine{00416\ \ \ LPoint3\ from\_a\ =\ capsule-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00417\ \ \ LPoint3\ from\_b\ =\ capsule-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00420\ \ \ \ \ LVector3(capsule-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00421\ \ \ PN\_stdfloat\ from\_radius\ =\ from\_radius\_v.length();}
\DoxyCodeLine{00422\ }
\DoxyCodeLine{00423\ \ \ LPoint3\ center\ =\ get\_center();}
\DoxyCodeLine{00424\ \ \ PN\_stdfloat\ radius\ =\ get\_radius();}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ \textcolor{comment}{//\ Check\ which\ one\ of\ the\ points\ lies\ furthest\ inside\ the\ sphere.}}
\DoxyCodeLine{00427\ \ \ PN\_stdfloat\ dist\_a\ =\ (from\_a\ -\/\ center).length();}
\DoxyCodeLine{00428\ \ \ PN\_stdfloat\ dist\_b\ =\ (from\_b\ -\/\ center).length();}
\DoxyCodeLine{00429\ \ \ \textcolor{keywordflow}{if}\ (dist\_b\ >\ dist\_a)\ \{}
\DoxyCodeLine{00430\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ furthest\ point\ into\ from\_a/dist\_a.}}
\DoxyCodeLine{00431\ \ \ \ \ dist\_a\ =\ dist\_b;}
\DoxyCodeLine{00432\ \ \ \ \ from\_a\ =\ from\_b;}
\DoxyCodeLine{00433\ \ \ \}}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \ \ \textcolor{comment}{//\ from\_a\ now\ contains\ the\ furthest\ point.\ \ Is\ it\ inside?}}
\DoxyCodeLine{00436\ \ \ \textcolor{keywordflow}{if}\ (dist\_a\ <\ radius\ -\/\ from\_radius)\ \{}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00438\ \ \ \}}
\DoxyCodeLine{00439\ }
\DoxyCodeLine{00440\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00441\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00442\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00443\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00444\ \ \ \}}
\DoxyCodeLine{00445\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \ \ LVector3\ normal\ =\ center\ -\/\ from\_a;}
\DoxyCodeLine{00448\ \ \ normal.normalize();}
\DoxyCodeLine{00449\ \ \ new\_entry-\/>set\_surface\_point(get\_center()\ -\/\ normal\ *\ radius);}
\DoxyCodeLine{00450\ \ \ new\_entry-\/>set\_interior\_point(from\_a\ -\/\ normal\ *\ from\_radius);}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ capsule-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00453\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00454\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00455\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00456\ \ \ \}}
\DoxyCodeLine{00457\ }
\DoxyCodeLine{00458\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00459\ \}}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00464\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionInvSphere::}
\DoxyCodeLine{00465\ test\_intersection\_from\_box(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00466\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionBox}{CollisionBox}}\ *box;}
\DoxyCodeLine{00467\ \ \ DCAST\_INTO\_R(box,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00469\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00471\ \ \ LPoint3\ center\ =\ get\_center();}
\DoxyCodeLine{00472\ \ \ PN\_stdfloat\ radius\_sq\ =\ get\_radius();}
\DoxyCodeLine{00473\ \ \ radius\_sq\ *=\ radius\_sq;}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ \ \ \textcolor{comment}{//\ Just\ figure\ out\ which\ box\ point\ is\ furthest\ from\ the\ center.\ \ If\ it}}
\DoxyCodeLine{00476\ \ \ \textcolor{comment}{//\ exceeds\ the\ radius,\ the\ furthest\ point\ wins.}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \ \ PN\_stdfloat\ max\_dist\_sq\ =\ -\/1.0;}
\DoxyCodeLine{00479\ \ \ LPoint3\ deepest\_vertex;}
\DoxyCodeLine{00480\ }
\DoxyCodeLine{00481\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 8;\ ++i)\ \{}
\DoxyCodeLine{00482\ \ \ \ \ LPoint3\ point\ =\ wrt\_mat.xform\_point(box-\/>get\_point(i));}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \ \ \ \ PN\_stdfloat\ dist\_sq\ =\ (point\ -\/\ center).length\_squared();}
\DoxyCodeLine{00485\ \ \ \ \ \textcolor{keywordflow}{if}\ (dist\_sq\ >\ max\_dist\_sq)\ \{}
\DoxyCodeLine{00486\ \ \ \ \ \ \ deepest\_vertex\ =\ point;}
\DoxyCodeLine{00487\ \ \ \ \ \ \ max\_dist\_sq\ =\ dist\_sq;}
\DoxyCodeLine{00488\ \ \ \ \ \}}
\DoxyCodeLine{00489\ \ \ \}}
\DoxyCodeLine{00490\ }
\DoxyCodeLine{00491\ \ \ \textcolor{keywordflow}{if}\ (max\_dist\_sq\ <\ radius\_sq)\ \{}
\DoxyCodeLine{00492\ \ \ \ \ \textcolor{comment}{//\ The\ point\ furthest\ away\ from\ the\ center\ is\ still\ inside\ the\ sphere.}}
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{comment}{//\ Therefore,\ no\ collision.}}
\DoxyCodeLine{00494\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00495\ \ \ \}}
\DoxyCodeLine{00496\ }
\DoxyCodeLine{00497\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00498\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00499\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00500\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00501\ \ \ \}}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00505\ \ \ \textcolor{comment}{//\ The\ interior\ point\ is\ just\ the\ deepest\ cube\ vertex.}}
\DoxyCodeLine{00506\ \ \ new\_entry-\/>set\_interior\_point(deepest\_vertex);}
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \ \ \textcolor{comment}{//\ Now\ extrapolate\ the\ surface\ point\ and\ normal\ from\ that.}}
\DoxyCodeLine{00509\ \ \ LVector3\ normal\ =\ center\ -\/\ deepest\_vertex;}
\DoxyCodeLine{00510\ \ \ normal.normalize();}
\DoxyCodeLine{00511\ \ \ new\_entry-\/>set\_surface\_point(center\ -\/\ normal\ *\ get\_radius());}
\DoxyCodeLine{00512\ \ \ new\_entry-\/>set\_surface\_normal(}
\DoxyCodeLine{00513\ \ \ \ \ (has\_effective\_normal()\ \&\&\ box-\/>get\_respect\_effective\_normal())}
\DoxyCodeLine{00514\ \ \ \ \ ?\ get\_effective\_normal()\ :\ normal);}
\DoxyCodeLine{00515\ }
\DoxyCodeLine{00516\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00517\ \}}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00523\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionInvSphere_ada5a670615d425f7a1137df63192eb49}{CollisionInvSphere::}}}
\DoxyCodeLine{00524\ \mbox{\hyperlink{classCollisionInvSphere_ada5a670615d425f7a1137df63192eb49}{fill\_viz\_geom}}()\ \{}
\DoxyCodeLine{00525\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00526\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00527\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Recomputing\ viz\ for\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00528\ \ \ \}}
\DoxyCodeLine{00529\ }
\DoxyCodeLine{00530\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_slices\ =\ 16;}
\DoxyCodeLine{00531\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_stacks\ =\ 8;}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00533\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00534\ \ \ \ \ (\textcolor{stringliteral}{"{}collision"{}},\ GeomVertexFormat::get\_v3(),}
\DoxyCodeLine{00535\ \ \ \ \ \ Geom::UH\_static);}
\DoxyCodeLine{00536\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00537\ }
\DoxyCodeLine{00538\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_static);}
\DoxyCodeLine{00539\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ sl\ =\ 0;\ sl\ <\ num\_slices;\ ++sl)\ \{}
\DoxyCodeLine{00540\ \ \ \ \ PN\_stdfloat\ longitude0\ =\ (PN\_stdfloat)sl\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00541\ \ \ \ \ PN\_stdfloat\ longitude1\ =\ (PN\_stdfloat)(sl\ +\ 1)\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00542\ \ \ \ \ vertex.add\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(0.0,\ longitude0));}
\DoxyCodeLine{00543\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ st\ =\ 1;\ st\ <\ num\_stacks;\ ++st)\ \{}
\DoxyCodeLine{00544\ \ \ \ \ \ \ PN\_stdfloat\ latitude\ =\ (PN\_stdfloat)st\ /\ (PN\_stdfloat)num\_stacks;}
\DoxyCodeLine{00545\ \ \ \ \ \ \ vertex.add\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(latitude,\ longitude1));}
\DoxyCodeLine{00546\ \ \ \ \ \ \ vertex.add\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(latitude,\ longitude0));}
\DoxyCodeLine{00547\ \ \ \ \ \}}
\DoxyCodeLine{00548\ \ \ \ \ vertex.add\_data3(\mbox{\hyperlink{classCollisionSphere_a699469e9cf4c57fd10d9e4e7a40057d5}{compute\_point}}(1.0,\ longitude0));}
\DoxyCodeLine{00549\ }
\DoxyCodeLine{00550\ \ \ \ \ strip-\/>add\_next\_vertices(num\_stacks\ *\ 2);}
\DoxyCodeLine{00551\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00552\ \ \ \}}
\DoxyCodeLine{00553\ }
\DoxyCodeLine{00554\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00555\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00556\ }
\DoxyCodeLine{00557\ \ \ \_viz\_geom-\/>add\_geom(geom,\ get\_solid\_viz\_state());}
\DoxyCodeLine{00558\ \}}
\DoxyCodeLine{00559\ }
\DoxyCodeLine{00563\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionInvSphere_a4fab2ca741242c84a6c5eef0eaf8dcfa}{CollisionInvSphere::}}}
\DoxyCodeLine{00564\ \mbox{\hyperlink{classCollisionInvSphere_a4fab2ca741242c84a6c5eef0eaf8dcfa}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00565\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classCollisionInvSphere_a8dc812ffb6ab5c932ccd0113a7ad4b3a}{make\_from\_bam}});}
\DoxyCodeLine{00566\ \}}
\DoxyCodeLine{00567\ }
\DoxyCodeLine{00572\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionInvSphere_a565b1660c19eabaed47db212078a9935}{CollisionInvSphere::}}}
\DoxyCodeLine{00573\ \mbox{\hyperlink{classCollisionInvSphere_a565b1660c19eabaed47db212078a9935}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&me)\ \{}
\DoxyCodeLine{00574\ \ \ \mbox{\hyperlink{classCollisionSphere_aee1b764c08322a46e6cd698d75187803}{CollisionSphere::write\_datagram}}(manager,\ me);}
\DoxyCodeLine{00575\ \}}
\DoxyCodeLine{00576\ }
\DoxyCodeLine{00580\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classCollisionInvSphere_a8dc812ffb6ab5c932ccd0113a7ad4b3a}{CollisionInvSphere::}}}
\DoxyCodeLine{00581\ \mbox{\hyperlink{classCollisionInvSphere_a8dc812ffb6ab5c932ccd0113a7ad4b3a}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00582\ \ \ \mbox{\hyperlink{classCollisionInvSphere}{CollisionInvSphere}}\ *me\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionInvSphere}{CollisionInvSphere}};}
\DoxyCodeLine{00583\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00584\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00585\ }
\DoxyCodeLine{00586\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00587\ \ \ me-\/>\mbox{\hyperlink{classCollisionInvSphere_a3fad1c2c6f69b642b8e2698d2749d451}{fillin}}(scan,\ manager);}
\DoxyCodeLine{00588\ \ \ \textcolor{keywordflow}{return}\ me;}
\DoxyCodeLine{00589\ \}}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00596\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionInvSphere_a3fad1c2c6f69b642b8e2698d2749d451}{CollisionInvSphere::}}}
\DoxyCodeLine{00597\ \mbox{\hyperlink{classCollisionInvSphere_a3fad1c2c6f69b642b8e2698d2749d451}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\&\ scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}*\ manager)\ \{}
\DoxyCodeLine{00598\ \ \ \mbox{\hyperlink{classCollisionSphere_a2368e26a8cc2347665e4e083edd54da1}{CollisionSphere::fillin}}(scan,\ manager);}
\DoxyCodeLine{00599\ \}}

\end{DoxyCode}
