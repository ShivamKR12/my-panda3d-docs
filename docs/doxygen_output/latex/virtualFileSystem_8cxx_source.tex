\doxysection{virtual\+File\+System.\+cxx}
\hypertarget{virtualFileSystem_8cxx_source}{}\label{virtualFileSystem_8cxx_source}\index{panda/src/express/virtualFileSystem.cxx@{panda/src/express/virtualFileSystem.cxx}}
\mbox{\hyperlink{virtualFileSystem_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSimple_8h}{virtualFileSimple.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileComposite_8h}{virtualFileComposite.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMount_8h}{virtualFileMount.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountMultifile_8h}{virtualFileMountMultifile.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountRamdisk_8h}{virtualFileMountRamdisk.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountSystem_8h}{virtualFileMountSystem.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountZip_8h}{virtualFileMountZip.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{streamWrapper_8h}{streamWrapper.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dSearchPath_8h}{dSearchPath.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dcast_8h}{dcast.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__express_8h}{config\_express.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{configVariableList_8h}{configVariableList.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{configVariableString_8h}{configVariableString.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{executionEnvironment_8h}{executionEnvironment.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pset_8h}{pset.h}}"{}}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#ifdef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountHTTP_8h}{virtualFileMountHTTP.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{using\ }std::iostream;}
\DoxyCodeLine{00036\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00037\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00038\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *VirtualFileSystem::\_global\_ptr\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00046\ VirtualFileSystem::}
\DoxyCodeLine{00047\ VirtualFileSystem()\ :}
\DoxyCodeLine{00048\ \ \ vfs\_case\_sensitive}
\DoxyCodeLine{00049\ (\textcolor{stringliteral}{"{}vfs-\/case-\/sensitive"{}},}
\DoxyCodeLine{00050\ \#ifdef\ NDEBUG}
\DoxyCodeLine{00051\ \ false,\ \ \textcolor{comment}{//\ The\ default\ for\ a\ production\ build\ is\ not\ case-\/sensitive;}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ this\ avoids\ runtime\ overhead\ to\ verify\ case\ sensitivity.}}
\DoxyCodeLine{00053\ \#else}
\DoxyCodeLine{00054\ \ true,}
\DoxyCodeLine{00055\ \#endif}
\DoxyCodeLine{00056\ \ PRC\_DESC(\textcolor{stringliteral}{"{}Set\ this\ true\ to\ make\ the\ VirtualFileSystem\ present\ the\ native\ "{}}}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}OS-\/provided\ filesystem\ as\ if\ it\ were\ a\ case-\/sensitive\ file\ "{}}}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}system,\ even\ if\ it\ is\ not\ (e.g.\ on\ Windows).\ \ This\ variable\ "{}}}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}has\ no\ effect\ if\ the\ native\ filesystem\ is\ already\ case-\/sensitive,\ "{}}}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}and\ it\ has\ no\ effect\ on\ mounted\ multifile\ systems,\ which\ are\ "{}}}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}always\ case-\/sensitive."{}})),}
\DoxyCodeLine{00062\ \ \ vfs\_implicit\_pz}
\DoxyCodeLine{00063\ \ \ (\textcolor{stringliteral}{"{}vfs-\/implicit-\/pz"{}},\ true,}
\DoxyCodeLine{00064\ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}When\ this\ is\ true,\ the\ VirtualFileSystem\ will\ pretend\ a\ named\ "{}}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}file\ exists\ even\ if\ it\ doesn't,\ as\ long\ as\ a\ filename\ with\ the\ "{}}}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}same\ name\ and\ the\ additional\ extension\ .pz\ does\ exist.\ \ In\ this\ "{}}}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}case,\ the\ VirtualFileSystem\ will\ implicitly\ open\ the\ .pz\ file\ "{}}}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}and\ decompress\ it\ on-\/the-\/fly."{}})),}
\DoxyCodeLine{00069\ \ \ vfs\_implicit\_mf}
\DoxyCodeLine{00070\ \ \ (\textcolor{stringliteral}{"{}vfs-\/implicit-\/mf"{}},\ false,}
\DoxyCodeLine{00071\ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}When\ this\ is\ true,\ the\ VirtualFileSystem\ will\ automatically\ "{}}}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}mount\ multifiles\ on-\/the-\/fly\ when\ they\ are\ used\ as\ directories.\ \ "{}}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}For\ instance,\ opening\ the\ file\ /c/files/foo.mf/dirname/mytex.jpg\ "{}}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}will\ implicitly\ retrieve\ a\ file\ named\ 'dirname/mytex.jpg'\ "{}}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}within\ the\ multifile\ /c/files/foo.mf,\ even\ if\ the\ multifile\ "{}}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}has\ not\ already\ been\ mounted.\ \ This\ makes\ all\ of\ your\ multifiles\ "{}}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}act\ like\ directories."{}}))}
\DoxyCodeLine{00078\ \{}
\DoxyCodeLine{00079\ \ \ \_cwd\ =\ \textcolor{stringliteral}{"{}/"{}};}
\DoxyCodeLine{00080\ \ \ \_mount\_seq\ =\ 0;}
\DoxyCodeLine{00081\ \}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00086\ VirtualFileSystem::}
\DoxyCodeLine{00087\ \string~VirtualFileSystem()\ \{}
\DoxyCodeLine{00088\ \ \ unmount\_all();}
\DoxyCodeLine{00089\ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00094\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00095\ mount(\mbox{\hyperlink{classMultifile}{Multifile}}\ *multifile,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{00096\ \ \ PT(\mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}})\ new\_mount\ =}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}}(multifile);}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordflow}{return}\ mount(new\_mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00104\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00105\ mount(\mbox{\hyperlink{classZipArchive}{ZipArchive}}\ *archive,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{00106\ \ \ PT(\mbox{\hyperlink{classVirtualFileMountZip}{VirtualFileMountZip}})\ new\_mount\ =}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountZip}{VirtualFileMountZip}}(archive);}
\DoxyCodeLine{00108\ \ \ \textcolor{keywordflow}{return}\ mount(new\_mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00109\ \}}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00131\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00132\ mount(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&physical\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&password)\ \{}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{if}\ (!physical\_filename.\mbox{\hyperlink{classFilename_af8a2ef9ed26abbed32786e6d8025c2c7}{exists}}())\ \{}
\DoxyCodeLine{00135\ \ \ \ \ express\_cat-\/>warning()}
\DoxyCodeLine{00136\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ mount\ "{}}\ <<\ physical\_filename\ <<\ \textcolor{stringliteral}{"{},\ not\ found.\(\backslash\)n"{}};}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{if}\ (physical\_filename.\mbox{\hyperlink{classFilename_abfff9d5225dcef51e5fa15655156d6cb}{is\_directory}}())\ \{}
\DoxyCodeLine{00141\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}})\ new\_mount\ =}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}}(physical\_filename);}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keywordflow}{return}\ mount(new\_mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00144\ \ \ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \textcolor{comment}{//\ It's\ not\ a\ directory;\ it\ must\ be\ a\ multifile\ or\ .zip\ file.}}
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ fname\ =\ physical\_filename;}
\DoxyCodeLine{00148\ \ \ fname.set\_binary();}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ vfile\ =\ get\_file(fname);}
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{if}\ (vfile\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00153\ \ \ \}}
\DoxyCodeLine{00154\ \ \ istream\ *stream\ =\ vfile-\/>open\_read\_file(\textcolor{keyword}{false});}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{if}\ (stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \textcolor{comment}{//\ For\ now\ these\ are\ always\ opened\ read\ only.\ \ Maybe\ later\ we'll\ support}}
\DoxyCodeLine{00160\ \ \ \textcolor{comment}{//\ read-\/write\ on\ multifiles\ and\ .zip\ files.}}
\DoxyCodeLine{00161\ \ \ flags\ |=\ MF\_read\_only;}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ \textcolor{keywordtype}{int}\ ch\ =\ stream-\/>get();}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordflow}{if}\ (ch\ ==\ \textcolor{charliteral}{'\#'}\ ||\ ch\ ==\ \textcolor{charliteral}{'p'})\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ It\ *might*\ be\ a\ multifile.}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordflow}{while}\ (ch\ ==\ \textcolor{charliteral}{'\#'})\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \textcolor{comment}{//\ Skip\ to\ the\ end\ of\ the\ line.}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (ch\ !=\ EOF\ \&\&\ ch\ !=\ \textcolor{charliteral}{'\(\backslash\)n'})\ \{}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ ch\ =\ stream-\/>get();}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \textcolor{comment}{//\ Skip\ to\ the\ first\ non-\/whitespace\ character\ of\ the\ line.}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (ch\ !=\ EOF\ \&\&\ (isspace(ch)\ ||\ ch\ ==\ \textcolor{charliteral}{'\(\backslash\)r'}))\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ ch\ =\ stream-\/>get();}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00175\ \ \ \ \ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{comment}{//\ Now\ read\ the\ actual\ Multifile\ header.}}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{char}\ this\_header[6];}
\DoxyCodeLine{00179\ \ \ \ \ this\_header[0]\ =\ ch;}
\DoxyCodeLine{00180\ \ \ \ \ stream-\/>read(this\_header\ +\ 1,\ 6\ -\/\ 1);}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordflow}{if}\ (!stream-\/>fail()\ \&\&\ stream-\/>gcount()\ ==\ 6\ -\/\ 1\ \&\&}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ memcmp(this\_header,\ \textcolor{stringliteral}{"{}pmf\(\backslash\)0\(\backslash\)n\(\backslash\)r"{}},\ 6)\ ==\ 0)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \textcolor{comment}{//\ Looks\ like\ a\ multifile\ all\ right.\ \ Reopen\ it.}}
\DoxyCodeLine{00184\ \ \ \ \ \ \ close\_read\_file(stream);}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classMultifile}{Multifile}})\ multifile\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classMultifile}{Multifile}};}
\DoxyCodeLine{00187\ \ \ \ \ \ \ multifile-\/>set\_encryption\_password(password);}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!multifile-\/>open\_read(physical\_filename))\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ mount(multifile,\ mount\_point,\ flags);}
\DoxyCodeLine{00194\ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \textcolor{comment}{//\ It\ must\ be\ a\ ZIP\ file.\ \ Note\ that\ ZipArchive\ does\ not\ require\ rewinding}}
\DoxyCodeLine{00198\ \ \ \textcolor{comment}{//\ the\ stream\ back\ to\ 0.}}
\DoxyCodeLine{00199\ \ \ \mbox{\hyperlink{classIStreamWrapper}{IStreamWrapper}}\ *read\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classIStreamWrapper}{IStreamWrapper}}(stream,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ PT(\mbox{\hyperlink{classZipArchive}{ZipArchive}})\ archive\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classZipArchive}{ZipArchive}};}
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{if}\ (!archive-\/>open\_read(read,\ \textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ archive-\/>set\_filename(physical\_filename);}
\DoxyCodeLine{00207\ \ \ \textcolor{keywordflow}{return}\ mount(archive,\ mount\_point,\ flags);}
\DoxyCodeLine{00208\ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00222\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00223\ mount\_loop(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&virtual\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&password)\ \{}
\DoxyCodeLine{00225\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ get\_file(virtual\_filename,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00226\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00227\ \ \ \ \ express\_cat-\/>warning()}
\DoxyCodeLine{00228\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ mount\ "{}}\ <<\ virtual\_filename\ <<\ \textcolor{stringliteral}{"{},\ not\ found.\(\backslash\)n"{}};}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00230\ \ \ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \textcolor{keywordflow}{if}\ (file-\/>is\_directory())\ \{}
\DoxyCodeLine{00233\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}})\ new\_mount\ =}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}}(virtual\_filename);}
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{keywordflow}{return}\ mount(new\_mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{comment}{//\ It's\ not\ a\ directory;\ it\ must\ be\ a\ Multifile.}}
\DoxyCodeLine{00239\ \ \ \ \ PT(\mbox{\hyperlink{classMultifile}{Multifile}})\ multifile\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classMultifile}{Multifile}};}
\DoxyCodeLine{00240\ \ \ \ \ multifile-\/>set\_encryption\_password(password);}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ For\ now\ these\ are\ always\ opened\ read\ only.\ \ Maybe\ later\ we'll\ support}}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{comment}{//\ read-\/write\ on\ Multifiles.}}
\DoxyCodeLine{00244\ \ \ \ \ flags\ |=\ MF\_read\_only;}
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{keywordflow}{if}\ (!multifile-\/>open\_read(virtual\_filename))\ \{}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00247\ \ \ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{return}\ mount(multifile,\ mount\_point,\ flags);}
\DoxyCodeLine{00250\ \ \ \}}
\DoxyCodeLine{00251\ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00258\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00259\ mount(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00261\ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00262\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}mount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ under\ "{}}\ <<\ mount\_point\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00263\ \ \ \}}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \_lock.lock();}
\DoxyCodeLine{00266\ \ \ \textcolor{keywordtype}{bool}\ result\ =\ do\_mount(mount,\ mount\_point,\ flags);}
\DoxyCodeLine{00267\ \ \ \_lock.unlock();}
\DoxyCodeLine{00268\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00269\ \}}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00275\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00276\ unmount(\mbox{\hyperlink{classMultifile}{Multifile}}\ *multifile)\ \{}
\DoxyCodeLine{00277\ \ \ \_lock.lock();}
\DoxyCodeLine{00278\ \ \ Mounts::iterator\ ri,\ wi;}
\DoxyCodeLine{00279\ \ \ wi\ =\ ri\ =\ \_mounts.begin();}
\DoxyCodeLine{00280\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_mounts.end())\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*ri);}
\DoxyCodeLine{00282\ \ \ \ \ (*wi)\ =\ mount;}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{if}\ (mount-\/>is\_exact\_type(VirtualFileMountMultifile::get\_class\_type()))\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}}\ *mmount\ =}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}},\ mount);}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mmount-\/>get\_multifile()\ ==\ multifile)\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00294\ }
\DoxyCodeLine{00295\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00299\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00301\ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00302\ \ \ \ \ \}}
\DoxyCodeLine{00303\ \ \ \ \ ++ri;}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.end()\ -\/\ wi;}
\DoxyCodeLine{00307\ \ \ \_mounts.erase(wi,\ \_mounts.end());}
\DoxyCodeLine{00308\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00309\ \ \ \_lock.unlock();}
\DoxyCodeLine{00310\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00311\ \}}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00317\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00318\ unmount(\mbox{\hyperlink{classZipArchive}{ZipArchive}}\ *archive)\ \{}
\DoxyCodeLine{00319\ \ \ \_lock.lock();}
\DoxyCodeLine{00320\ \ \ Mounts::iterator\ ri,\ wi;}
\DoxyCodeLine{00321\ \ \ wi\ =\ ri\ =\ \_mounts.begin();}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_mounts.end())\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*ri);}
\DoxyCodeLine{00324\ \ \ \ \ (*wi)\ =\ mount;}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \ \ \textcolor{keywordflow}{if}\ (mount-\/>is\_exact\_type(VirtualFileMountZip::get\_class\_type()))\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileMountZip}{VirtualFileMountZip}}\ *zip\_mount\ =}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classVirtualFileMountZip}{VirtualFileMountZip}},\ mount);}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (zip\_mount-\/>get\_archive()\ ==\ archive)\ \{}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00341\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00343\ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00344\ \ \ \ \ \}}
\DoxyCodeLine{00345\ \ \ \ \ ++ri;}
\DoxyCodeLine{00346\ \ \ \}}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.end()\ -\/\ wi;}
\DoxyCodeLine{00349\ \ \ \_mounts.erase(wi,\ \_mounts.end());}
\DoxyCodeLine{00350\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00351\ \ \ \_lock.unlock();}
\DoxyCodeLine{00352\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00353\ \}}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00359\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00360\ unmount(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&physical\_filename)\ \{}
\DoxyCodeLine{00361\ \ \ \_lock.lock();}
\DoxyCodeLine{00362\ \ \ Mounts::iterator\ ri,\ wi;}
\DoxyCodeLine{00363\ \ \ wi\ =\ ri\ =\ \_mounts.begin();}
\DoxyCodeLine{00364\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_mounts.end())\ \{}
\DoxyCodeLine{00365\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*ri);}
\DoxyCodeLine{00366\ \ \ \ \ (*wi)\ =\ mount;}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keywordflow}{if}\ (mount-\/>is\_exact\_type(VirtualFileMountSystem::get\_class\_type()))\ \{}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}}\ *smount\ =}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classVirtualFileMountSystem}{VirtualFileMountSystem}},\ mount);}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (smount-\/>get\_physical\_filename()\ ==\ physical\_filename)\ \{}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00379\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00383\ }
\DoxyCodeLine{00384\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (mount-\/>is\_exact\_type(VirtualFileMountMultifile::get\_class\_type()))\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}}\ *mmount\ =}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}},\ mount);}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mmount-\/>get\_multifile()-\/>get\_multifile\_name()\ ==\ physical\_filename)\ \{}
\DoxyCodeLine{00388\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00392\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00401\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00402\ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00403\ \ \ \ \ \}}
\DoxyCodeLine{00404\ \ \ \ \ ++ri;}
\DoxyCodeLine{00405\ \ \ \}}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.end()\ -\/\ wi;}
\DoxyCodeLine{00408\ \ \ \_mounts.erase(wi,\ \_mounts.end());}
\DoxyCodeLine{00409\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00410\ \ \ \_lock.unlock();}
\DoxyCodeLine{00411\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00412\ \}}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00418\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00419\ unmount(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount)\ \{}
\DoxyCodeLine{00420\ \ \ \_lock.lock();}
\DoxyCodeLine{00421\ \ \ Mounts::iterator\ ri,\ wi;}
\DoxyCodeLine{00422\ \ \ wi\ =\ ri\ =\ \_mounts.begin();}
\DoxyCodeLine{00423\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_mounts.end())\ \{}
\DoxyCodeLine{00424\ \ \ \ \ (*wi)\ =\ (*ri);}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*ri)\ ==\ mount)\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00431\ \ \ \ \ \ \ (*ri)-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00435\ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00436\ \ \ \ \ \}}
\DoxyCodeLine{00437\ \ \ \ \ ++ri;}
\DoxyCodeLine{00438\ \ \ \}}
\DoxyCodeLine{00439\ }
\DoxyCodeLine{00440\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.end()\ -\/\ wi;}
\DoxyCodeLine{00441\ \ \ \_mounts.erase(wi,\ \_mounts.end());}
\DoxyCodeLine{00442\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00443\ \ \ \_lock.unlock();}
\DoxyCodeLine{00444\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00445\ \}}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00451\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00452\ unmount\_point(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point)\ \{}
\DoxyCodeLine{00453\ \ \ \_lock.lock();}
\DoxyCodeLine{00454\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ nmp\ =\ normalize\_mount\_point(mount\_point);}
\DoxyCodeLine{00455\ \ \ Mounts::iterator\ ri,\ wi;}
\DoxyCodeLine{00456\ \ \ wi\ =\ ri\ =\ \_mounts.begin();}
\DoxyCodeLine{00457\ \ \ \textcolor{keywordflow}{while}\ (ri\ !=\ \_mounts.end())\ \{}
\DoxyCodeLine{00458\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*ri);}
\DoxyCodeLine{00459\ \ \ \ \ (*wi)\ =\ mount;}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \ \ \ \ \textcolor{keywordflow}{if}\ (mount-\/>get\_mount\_point()\ ==\ nmp)\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ this\ one.\ \ Don't\ increment\ wi.}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00467\ \ \ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00469\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ remove\ this\ one.}}
\DoxyCodeLine{00471\ \ \ \ \ \ \ ++wi;}
\DoxyCodeLine{00472\ \ \ \ \ \}}
\DoxyCodeLine{00473\ \ \ \ \ ++ri;}
\DoxyCodeLine{00474\ \ \ \}}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.end()\ -\/\ wi;}
\DoxyCodeLine{00477\ \ \ \_mounts.erase(wi,\ \_mounts.end());}
\DoxyCodeLine{00478\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00479\ \ \ \_lock.unlock();}
\DoxyCodeLine{00480\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00481\ \}}
\DoxyCodeLine{00482\ }
\DoxyCodeLine{00487\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00488\ unmount\_all()\ \{}
\DoxyCodeLine{00489\ \ \ \_lock.lock();}
\DoxyCodeLine{00490\ \ \ Mounts::iterator\ ri;}
\DoxyCodeLine{00491\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ \_mounts.begin();\ ri\ !=\ \_mounts.end();\ ++ri)\ \{}
\DoxyCodeLine{00492\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*ri);}
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{keywordflow}{if}\ (express\_cat-\/>is\_debug())\ \{}
\DoxyCodeLine{00494\ \ \ \ \ \ \ express\_cat-\/>debug()}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unmount\ "{}}\ <<\ *mount\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ mount-\/>get\_mount\_point()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00496\ \ \ \ \ \}}
\DoxyCodeLine{00497\ \ \ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00498\ \ \ \}}
\DoxyCodeLine{00499\ }
\DoxyCodeLine{00500\ \ \ \textcolor{keywordtype}{int}\ num\_removed\ =\ \_mounts.size();}
\DoxyCodeLine{00501\ \ \ \_mounts.clear();}
\DoxyCodeLine{00502\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{00503\ \ \ \_lock.unlock();}
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{return}\ num\_removed;}
\DoxyCodeLine{00505\ \}}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00510\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00511\ get\_num\_mounts()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00512\ \ \ \_lock.lock();}
\DoxyCodeLine{00513\ \ \ \textcolor{keywordtype}{int}\ result\ =\ \_mounts.size();}
\DoxyCodeLine{00514\ \ \ \_lock.unlock();}
\DoxyCodeLine{00515\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00516\ \}}
\DoxyCodeLine{00517\ }
\DoxyCodeLine{00521\ PT(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}})\ VirtualFileSystem::}
\DoxyCodeLine{00522\ get\_mount(\textcolor{keywordtype}{int}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00523\ \ \ \_lock.lock();}
\DoxyCodeLine{00524\ \ \ nassertd(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})\_mounts.size())\ \{}
\DoxyCodeLine{00525\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00527\ \ \ \}}
\DoxyCodeLine{00528\ \ \ PT(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}})\ result\ =\ \_mounts[n];}
\DoxyCodeLine{00529\ \ \ \_lock.unlock();}
\DoxyCodeLine{00530\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00531\ \}}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00538\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00539\ chdir(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&new\_directory)\ \{}
\DoxyCodeLine{00540\ \ \ \_lock.lock();}
\DoxyCodeLine{00541\ \ \ \textcolor{keywordflow}{if}\ (new\_directory\ ==\ \textcolor{stringliteral}{"{}/"{}})\ \{}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{comment}{//\ We\ can\ always\ return\ to\ the\ root.}}
\DoxyCodeLine{00543\ \ \ \ \ \_cwd\ =\ new\_directory;}
\DoxyCodeLine{00544\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00545\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00546\ \ \ \}}
\DoxyCodeLine{00547\ }
\DoxyCodeLine{00548\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ do\_get\_file(new\_directory,\ OF\_status\_only);}
\DoxyCodeLine{00549\ \ \ \textcolor{keywordflow}{if}\ (file\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ file-\/>is\_directory())\ \{}
\DoxyCodeLine{00550\ \ \ \ \ \_cwd\ =\ file-\/>get\_filename();}
\DoxyCodeLine{00551\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00552\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00553\ \ \ \}}
\DoxyCodeLine{00554\ \ \ \_lock.unlock();}
\DoxyCodeLine{00555\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00556\ \}}
\DoxyCodeLine{00557\ }
\DoxyCodeLine{00561\ \mbox{\hyperlink{classFilename}{Filename}}\ VirtualFileSystem::}
\DoxyCodeLine{00562\ get\_cwd()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00563\ \ \ \_lock.lock();}
\DoxyCodeLine{00564\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ result\ =\ \_cwd;}
\DoxyCodeLine{00565\ \ \ \_lock.unlock();}
\DoxyCodeLine{00566\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00567\ \}}
\DoxyCodeLine{00568\ }
\DoxyCodeLine{00575\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00576\ make\_directory(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00577\ \ \ \_lock.lock();}
\DoxyCodeLine{00578\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ result\ =\ do\_get\_file(filename,\ OF\_make\_directory);}
\DoxyCodeLine{00579\ \ \ \_lock.unlock();}
\DoxyCodeLine{00580\ \ \ nassertr\_always(result\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00581\ \ \ \textcolor{keywordflow}{return}\ result-\/>is\_directory();}
\DoxyCodeLine{00582\ \}}
\DoxyCodeLine{00583\ }
\DoxyCodeLine{00589\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00590\ make\_directory\_full(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00591\ \ \ \_lock.lock();}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \ \ \textcolor{comment}{//\ First,\ make\ sure\ everything\ up\ to\ the\ last\ path\ is\ known.\ \ We\ don't\ care}}
\DoxyCodeLine{00594\ \ \ \textcolor{comment}{//\ too\ much\ if\ any\ of\ these\ fail;\ maybe\ they\ failed\ because\ the\ directory}}
\DoxyCodeLine{00595\ \ \ \textcolor{comment}{//\ was\ already\ there.}}
\DoxyCodeLine{00596\ \ \ \textcolor{keywordtype}{string}\ dirname\ =\ filename;}
\DoxyCodeLine{00597\ \ \ \textcolor{keywordtype}{size\_t}\ slash\ =\ dirname.find(\textcolor{charliteral}{'/'},\ 1);}
\DoxyCodeLine{00598\ \ \ \textcolor{keywordflow}{while}\ (slash\ !=\ string::npos)\ \{}
\DoxyCodeLine{00599\ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ component(dirname.substr(0,\ slash));}
\DoxyCodeLine{00600\ \ \ \ \ do\_get\_file(component,\ OF\_make\_directory);}
\DoxyCodeLine{00601\ \ \ \ \ slash\ =\ dirname.find(\textcolor{charliteral}{'/'},\ slash\ +\ 1);}
\DoxyCodeLine{00602\ \ \ \}}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \ \ \textcolor{comment}{//\ Now\ make\ the\ last\ one,\ and\ check\ the\ return\ value.}}
\DoxyCodeLine{00605\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ result\ =\ do\_get\_file(filename,\ OF\_make\_directory);}
\DoxyCodeLine{00606\ \ \ \_lock.unlock();}
\DoxyCodeLine{00607\ \ \ \textcolor{keywordflow}{return}\ (result\ !=\ \textcolor{keyword}{nullptr})\ ?\ result-\/>is\_directory()\ :\ \textcolor{keyword}{false};}
\DoxyCodeLine{00608\ \}}
\DoxyCodeLine{00609\ }
\DoxyCodeLine{00621\ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ VirtualFileSystem::}
\DoxyCodeLine{00622\ get\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{bool}\ status\_only)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00623\ \ \ \textcolor{keywordtype}{int}\ open\_flags\ =\ status\_only\ ?\ OF\_status\_only\ :\ 0;}
\DoxyCodeLine{00624\ \ \ \_lock.lock();}
\DoxyCodeLine{00625\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ result\ =\ do\_get\_file(filename,\ open\_flags);}
\DoxyCodeLine{00626\ \ \ \_lock.unlock();}
\DoxyCodeLine{00627\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00628\ \}}
\DoxyCodeLine{00629\ }
\DoxyCodeLine{00636\ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ VirtualFileSystem::}
\DoxyCodeLine{00637\ create\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00638\ \ \ \_lock.lock();}
\DoxyCodeLine{00639\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ result\ =\ do\_get\_file(filename,\ OF\_create\_file);}
\DoxyCodeLine{00640\ \ \ \_lock.unlock();}
\DoxyCodeLine{00641\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00642\ \}}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00649\ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ VirtualFileSystem::}
\DoxyCodeLine{00650\ find\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&searchpath,}
\DoxyCodeLine{00651\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ status\_only)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00652\ \ \ \textcolor{keywordflow}{if}\ (!filename.is\_local())\ \{}
\DoxyCodeLine{00653\ \ \ \ \ \textcolor{keywordflow}{return}\ get\_file(filename,\ status\_only);}
\DoxyCodeLine{00654\ \ \ \}}
\DoxyCodeLine{00655\ }
\DoxyCodeLine{00656\ \ \ \textcolor{keywordflow}{if}\ (filename.empty())\ \{}
\DoxyCodeLine{00657\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00658\ \ \ \}}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \textcolor{keywordtype}{int}\ num\_directories\ =\ searchpath.get\_num\_directories();}
\DoxyCodeLine{00661\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_directories;\ ++i)\ \{}
\DoxyCodeLine{00662\ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ match(searchpath.get\_directory(i),\ filename);}
\DoxyCodeLine{00663\ \ \ \ \ \textcolor{keywordflow}{if}\ (searchpath.get\_directory(i)\ ==\ \textcolor{stringliteral}{"{}."{}}\ \&\&}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ filename.is\_fully\_qualified())\ \{}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \textcolor{comment}{//\ A\ special\ case\ for\ the\ "{}."{}\ directory:\ to\ avoid\ prefixing\ an\ endless}}
\DoxyCodeLine{00666\ \ \ \ \ \ \ \textcolor{comment}{//\ stream\ of\ .\ in\ front\ of\ files,\ if\ the\ filename\ already\ has\ a\ .}}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \textcolor{comment}{//\ prefixed\ (i.e.\ \ is\_fully\_qualified()\ is\ true),\ we\ don't\ prefix}}
\DoxyCodeLine{00668\ \ \ \ \ \ \ \textcolor{comment}{//\ another\ one.}}
\DoxyCodeLine{00669\ \ \ \ \ \ \ match\ =\ filename;}
\DoxyCodeLine{00670\ \ \ \ \ \}}
\DoxyCodeLine{00671\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ found\_file\ =\ get\_file(match,\ status\_only);}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{keywordflow}{if}\ (found\_file\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00673\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{00674\ \ \ \ \ \}}
\DoxyCodeLine{00675\ \ \ \}}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00677\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00678\ \}}
\DoxyCodeLine{00679\ }
\DoxyCodeLine{00685\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00686\ delete\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00687\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ get\_file(filename,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00688\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00689\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00690\ \ \ \}}
\DoxyCodeLine{00691\ }
\DoxyCodeLine{00692\ \ \ \textcolor{keywordflow}{return}\ file-\/>delete\_file();}
\DoxyCodeLine{00693\ \}}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00706\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00707\ rename\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&new\_filename)\ \{}
\DoxyCodeLine{00708\ \ \ \_lock.lock();}
\DoxyCodeLine{00709\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ orig\_file\ =\ do\_get\_file(orig\_filename,\ OF\_status\_only);}
\DoxyCodeLine{00710\ \ \ \textcolor{keywordflow}{if}\ (orig\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00711\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00712\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00713\ \ \ \}}
\DoxyCodeLine{00714\ }
\DoxyCodeLine{00715\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ new\_file\ =\ do\_get\_file(new\_filename,\ OF\_status\_only\ |\ OF\_allow\_nonexist);}
\DoxyCodeLine{00716\ \ \ \textcolor{keywordflow}{if}\ (new\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00717\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00718\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00719\ \ \ \}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00721\ \ \ \_lock.unlock();}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00723\ \ \ \textcolor{keywordflow}{return}\ orig\_file-\/>rename\_file(new\_file);}
\DoxyCodeLine{00724\ \}}
\DoxyCodeLine{00725\ }
\DoxyCodeLine{00730\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00731\ copy\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&new\_filename)\ \{}
\DoxyCodeLine{00732\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ orig\_file\ =\ get\_file(orig\_filename,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00733\ \ \ \textcolor{keywordflow}{if}\ (orig\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00735\ \ \ \}}
\DoxyCodeLine{00736\ }
\DoxyCodeLine{00737\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ new\_file\ =\ create\_file(new\_filename);}
\DoxyCodeLine{00738\ \ \ \textcolor{keywordflow}{if}\ (new\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00739\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00740\ \ \ \}}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \ \ \textcolor{keywordflow}{return}\ orig\_file-\/>copy\_file(new\_file);}
\DoxyCodeLine{00743\ \}}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00750\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{00751\ resolve\_filename(\mbox{\hyperlink{classFilename}{Filename}}\ \&filename,}
\DoxyCodeLine{00752\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&searchpath,}
\DoxyCodeLine{00753\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&default\_extension)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00754\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ found;}
\DoxyCodeLine{00755\ }
\DoxyCodeLine{00756\ \ \ \textcolor{keywordflow}{if}\ (filename.is\_local())\ \{}
\DoxyCodeLine{00757\ \ \ \ \ found\ =\ find\_file(filename,\ searchpath,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00758\ }
\DoxyCodeLine{00759\ \ \ \ \ \textcolor{keywordflow}{if}\ (found.is\_null())\ \{}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ didn't\ find\ it\ with\ the\ given\ extension;\ can\ we\ try\ the\ default}}
\DoxyCodeLine{00761\ \ \ \ \ \ \ \textcolor{comment}{//\ extension?}}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (filename.get\_extension().empty()\ \&\&\ !default\_extension.empty())\ \{}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ try\_ext\ =\ filename;}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ try\_ext.\mbox{\hyperlink{classFilename_ab41121b22b7bddd945d9d76f1d550bc0}{set\_extension}}(default\_extension);}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ found\ =\ find\_file(try\_ext,\ searchpath,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00767\ \ \ \ \ \}}
\DoxyCodeLine{00768\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00769\ \ \ \ \ \textcolor{keywordflow}{if}\ (exists(filename))\ \{}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ full\ pathname\ exists.\ \ Return\ true.}}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00772\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ full\ pathname\ doesn't\ exist\ with\ the\ given\ extension;\ does\ it}}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \textcolor{comment}{//\ exist\ with\ the\ default\ extension?}}
\DoxyCodeLine{00775\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (filename.get\_extension().empty()\ \&\&\ !default\_extension.empty())\ \{}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ try\_ext\ =\ filename;}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ try\_ext.\mbox{\hyperlink{classFilename_ab41121b22b7bddd945d9d76f1d550bc0}{set\_extension}}(default\_extension);}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ found\ =\ get\_file(try\_ext,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00780\ \ \ \ \ \}}
\DoxyCodeLine{00781\ \ \ \}}
\DoxyCodeLine{00782\ }
\DoxyCodeLine{00783\ \ \ \textcolor{keywordflow}{if}\ (!found.is\_null())\ \{}
\DoxyCodeLine{00784\ \ \ \ \ filename\ =\ found-\/>get\_original\_filename();}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00786\ \ \ \}}
\DoxyCodeLine{00787\ }
\DoxyCodeLine{00788\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00789\ \}}
\DoxyCodeLine{00790\ }
\DoxyCodeLine{00799\ \textcolor{keywordtype}{int}\ VirtualFileSystem::}
\DoxyCodeLine{00800\ find\_all\_files(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&searchpath,}
\DoxyCodeLine{00801\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DSearchPath::Results\ \&results)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00802\ \ \ \textcolor{keywordtype}{int}\ num\_added\ =\ 0;}
\DoxyCodeLine{00803\ }
\DoxyCodeLine{00804\ \ \ \textcolor{keywordflow}{if}\ (filename.is\_local())\ \{}
\DoxyCodeLine{00805\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_directories\ =\ searchpath.get\_num\_directories();}
\DoxyCodeLine{00806\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_directories;\ ++i)\ \{}
\DoxyCodeLine{00807\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ match(searchpath.get\_directory(i),\ filename);}
\DoxyCodeLine{00808\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (exists(match))\ \{}
\DoxyCodeLine{00809\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (searchpath.get\_directory(i)\ ==\ \textcolor{stringliteral}{"{}."{}}\ \&\&}
\DoxyCodeLine{00810\ \ \ \ \ \ \ \ \ \ \ \ \ filename.is\_fully\_qualified())\ \{}
\DoxyCodeLine{00811\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ A\ special\ case\ for\ the\ "{}."{}\ directory:\ to\ avoid\ prefixing\ an}}
\DoxyCodeLine{00812\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ endless\ stream\ of\ .\ in\ front\ of\ files,\ if\ the\ filename\ already}}
\DoxyCodeLine{00813\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ has\ a\ .\ prefixed\ (i.e.\ \ is\_fully\_fully\_qualified()\ is\ true),\ we}}
\DoxyCodeLine{00814\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ don't\ prefix\ another\ one.}}
\DoxyCodeLine{00815\ \ \ \ \ \ \ \ \ \ \ results.add\_file(filename);}
\DoxyCodeLine{00816\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00817\ \ \ \ \ \ \ \ \ \ \ results.add\_file(match);}
\DoxyCodeLine{00818\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00819\ \ \ \ \ \ \ \ \ ++num\_added;}
\DoxyCodeLine{00820\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00821\ \ \ \ \ \}}
\DoxyCodeLine{00822\ \ \ \}}
\DoxyCodeLine{00823\ }
\DoxyCodeLine{00824\ \ \ \textcolor{keywordflow}{return}\ num\_added;}
\DoxyCodeLine{00825\ \}}
\DoxyCodeLine{00826\ }
\DoxyCodeLine{00830\ \textcolor{keywordtype}{void}\ VirtualFileSystem::}
\DoxyCodeLine{00831\ write(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00832\ \ \ \_lock.lock();}
\DoxyCodeLine{00833\ \ \ Mounts::const\_iterator\ mi;}
\DoxyCodeLine{00834\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_mounts.begin();\ mi\ !=\ \_mounts.end();\ ++mi)\ \{}
\DoxyCodeLine{00835\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*mi);}
\DoxyCodeLine{00836\ \ \ \ \ mount-\/>write(out);}
\DoxyCodeLine{00837\ \ \ \}}
\DoxyCodeLine{00838\ \ \ \_lock.unlock();}
\DoxyCodeLine{00839\ \}}
\DoxyCodeLine{00840\ }
\DoxyCodeLine{00841\ }
\DoxyCodeLine{00851\ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *VirtualFileSystem::}
\DoxyCodeLine{00852\ get\_global\_ptr()\ \{}
\DoxyCodeLine{00853\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00854\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ this\ is\ initialized.}}
\DoxyCodeLine{00855\ \ \ \ \ \mbox{\hyperlink{config__express_8cxx_aefc24287d5e9af8e1a76b406322267eb}{init\_libexpress}}();}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}};}
\DoxyCodeLine{00858\ }
\DoxyCodeLine{00859\ \ \ \ \ \textcolor{comment}{//\ Set\ up\ the\ default\ mounts.\ \ First,\ there\ is\ always\ the\ root\ mount.}}
\DoxyCodeLine{00860\ \textcolor{preprocessor}{\#ifdef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{00861\ \ \ \ \ \textcolor{comment}{//\ Unless\ we're\ running\ in\ node.js,\ we\ don't\ have\ a\ filesystem,\ and\ instead}}
\DoxyCodeLine{00862\ \ \ \ \ \textcolor{comment}{//\ mount\ the\ current\ server\ root\ as\ our\ filesystem\ root.}}
\DoxyCodeLine{00863\ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_node\ =\ (bool)EM\_ASM\_INT(\textcolor{keywordflow}{return}\ (typeof\ process\ ===\ \textcolor{stringliteral}{'object'}\ \&\&\ typeof\ process.versions\ ===\ \textcolor{stringliteral}{'object'}\ \&\&\ typeof\ process.versions.node\ ===\ \textcolor{stringliteral}{'string'}));}
\DoxyCodeLine{00864\ \ \ \ \ \textcolor{keywordflow}{if}\ (!is\_node)\ \{}
\DoxyCodeLine{00865\ \ \ \ \ \ \ \_global\_ptr-\/>mount(\textcolor{keyword}{new}\ VirtualFileMountHTTP(\mbox{\hyperlink{classURLSpec}{URLSpec}}(\textcolor{stringliteral}{"{}/"{}})),\ \textcolor{stringliteral}{"{}/"{}},\ MF\_read\_only);}
\DoxyCodeLine{00866\ }
\DoxyCodeLine{00867\ \ \ \ \ \ \ \textcolor{comment}{//\ And\ get\ the\ "{}current\ working\ directory"{}.}}
\DoxyCodeLine{00868\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ cwd[4096];}
\DoxyCodeLine{00869\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ have\_memfs\ =\ (bool)EM\_ASM\_INT(\{}
\DoxyCodeLine{00870\ \ \ \ \ \ \ \ \ var\ path\ =\ location.pathname;}
\DoxyCodeLine{00871\ \ \ \ \ \ \ \ \ stringToUTF8(path.substring(0,\ path.lastIndexOf(\textcolor{charliteral}{'/'})),\ \$0,\ 4096);}
\DoxyCodeLine{00872\ }
\DoxyCodeLine{00873\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (FS\ \&\&\ FS.root)\ \{}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Emscripten\ creates\ these\ by\ default,\ but\ we\ don't\ want\ them.\ */}}
\DoxyCodeLine{00875\ \ \ \ \ \ \ \ \ \ \ var\ contents\ =\ FS.root.contents;}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ contents.dev;}
\DoxyCodeLine{00877\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ contents.home;}
\DoxyCodeLine{00878\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ contents.proc;}
\DoxyCodeLine{00879\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ contents.tmp;}
\DoxyCodeLine{00880\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00881\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00882\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00883\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00884\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00885\ \ \ \ \ \ \ \},\ cwd);}
\DoxyCodeLine{00886\ }
\DoxyCodeLine{00887\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cwd[0]\ ==\ 0)\ \{}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \ \ cwd[0]\ =\ \textcolor{charliteral}{'/'};}
\DoxyCodeLine{00889\ \ \ \ \ \ \ \ \ cwd[1]\ =\ 0;}
\DoxyCodeLine{00890\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00891\ }
\DoxyCodeLine{00892\ \ \ \ \ \ \ \_global\_ptr-\/>\_cwd\ =\ cwd;}
\DoxyCodeLine{00893\ }
\DoxyCodeLine{00894\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ built\ with\ the\ Emscripten\ VFS\ enabled,\ mount\ it\ on\ top\ of\ the}}
\DoxyCodeLine{00895\ \ \ \ \ \ \ \textcolor{comment}{//\ current\ directory,\ so\ that\ emscripten's\ preload\ system\ will\ work.}}
\DoxyCodeLine{00896\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (have\_memfs)\ \{}
\DoxyCodeLine{00897\ \ \ \ \ \ \ \ \ \_global\_ptr-\/>mount(\textcolor{stringliteral}{"{}/"{}},\ \_global\_ptr-\/>\_cwd,\ MF\_read\_only);}
\DoxyCodeLine{00898\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00899\ \ \ \ \ \}}
\DoxyCodeLine{00900\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00901\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00902\ \ \ \ \ \{}
\DoxyCodeLine{00903\ \ \ \ \ \ \ \_global\_ptr-\/>mount(\textcolor{stringliteral}{"{}/"{}},\ \textcolor{stringliteral}{"{}/"{}},\ 0);}
\DoxyCodeLine{00904\ }
\DoxyCodeLine{00905\ \ \ \ \ \ \ \textcolor{comment}{//\ And\ our\ initial\ cwd\ comes\ from\ the\ environment.}}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \_global\_ptr-\/>chdir(ExecutionEnvironment::get\_cwd());}
\DoxyCodeLine{00907\ \ \ \ \ \}}
\DoxyCodeLine{00908\ }
\DoxyCodeLine{00909\ \ \ \ \ \textcolor{comment}{//\ Then,\ we\ add\ whatever\ mounts\ are\ listed\ in\ the\ Configrc\ file.}}
\DoxyCodeLine{00910\ \ \ \ \ \mbox{\hyperlink{classConfigVariableList}{ConfigVariableList}}\ mounts}
\DoxyCodeLine{00911\ \ \ \ \ \ \ (\textcolor{stringliteral}{"{}vfs-\/mount"{}},}
\DoxyCodeLine{00912\ \ \ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}vfs-\/mount\ system-\/filename\ mount-\/point\ [options]"{}}));}
\DoxyCodeLine{00913\ }
\DoxyCodeLine{00914\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_unique\_values\ =\ mounts.get\_num\_unique\_values();}
\DoxyCodeLine{00915\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_unique\_values;\ i++)\ \{}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_desc\ =\ mounts.get\_unique\_value(i);}
\DoxyCodeLine{00917\ }
\DoxyCodeLine{00918\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ vfs-\/mount\ syntax\ is:}}
\DoxyCodeLine{00919\ }
\DoxyCodeLine{00920\ \ \ \ \ \ \ \textcolor{comment}{//\ vfs-\/mount\ system-\/filename\ mount-\/point\ [options]}}
\DoxyCodeLine{00921\ }
\DoxyCodeLine{00922\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ last\ two\ spaces\ mark\ the\ beginning\ of\ the\ mount\ point,\ and\ of\ the}}
\DoxyCodeLine{00923\ \ \ \ \ \ \ \textcolor{comment}{//\ options,\ respectively.\ \ There\ might\ be\ multiple\ spaces\ in\ the\ system}}
\DoxyCodeLine{00924\ \ \ \ \ \ \ \textcolor{comment}{//\ filename,\ which\ are\ part\ of\ the\ filename.}}
\DoxyCodeLine{00925\ }
\DoxyCodeLine{00926\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ last\ space\ marks\ the\ beginning\ of\ the\ mount\ point.\ \ Spaces\ before}}
\DoxyCodeLine{00927\ \ \ \ \ \ \ \textcolor{comment}{//\ that\ are\ part\ of\ the\ system\ filename.}}
\DoxyCodeLine{00928\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ space\ =\ mount\_desc.rfind(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00929\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ ==\ string::npos)\ \{}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \ \ express\_cat.warning()}
\DoxyCodeLine{00931\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}No\ space\ in\ vfs-\/mount\ descriptor:\ "{}}\ <<\ mount\_desc\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00932\ }
\DoxyCodeLine{00933\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00934\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_point\ =\ mount\_desc.substr(space\ +\ 1);}
\DoxyCodeLine{00935\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ >\ 0\ \&\&\ isspace(mount\_desc[space\ -\/\ 1]))\ \{}
\DoxyCodeLine{00936\ \ \ \ \ \ \ \ \ \ \ space-\/-\/;}
\DoxyCodeLine{00937\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \ \ mount\_desc\ =\ mount\_desc.substr(0,\ space);}
\DoxyCodeLine{00939\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ options;}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00941\ \ \ \ \ \ \ \ \ space\ =\ mount\_desc.rfind(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00942\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ !=\ string::npos)\ \{}
\DoxyCodeLine{00943\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ another\ space,\ we\ have\ the\ optional\ options\ field.}}
\DoxyCodeLine{00944\ \ \ \ \ \ \ \ \ \ \ options\ =\ mount\_point;}
\DoxyCodeLine{00945\ \ \ \ \ \ \ \ \ \ \ mount\_point\ =\ mount\_desc.substr(space\ +\ 1);}
\DoxyCodeLine{00946\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ >\ 0\ \&\&\ isspace(mount\_desc[space\ -\/\ 1]))\ \{}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \ \ \ \ \ \ -\/-\/space;}
\DoxyCodeLine{00948\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \ \ \ \ mount\_desc\ =\ mount\_desc.substr(0,\ space);}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00952\ \ \ \ \ \ \ \ \ mount\_desc\ =\ ExecutionEnvironment::expand\_string(mount\_desc);}
\DoxyCodeLine{00953\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ physical\_filename\ =\ \mbox{\hyperlink{classFilename_ab17a80adaab942d6570d114d6f0675c3}{Filename::from\_os\_specific}}(mount\_desc);}
\DoxyCodeLine{00954\ }
\DoxyCodeLine{00955\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags;}
\DoxyCodeLine{00956\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ password;}
\DoxyCodeLine{00957\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileSystem_a633ae392289b10c143f1aeab2f4bca31}{parse\_options}}(options,\ flags,\ password);}
\DoxyCodeLine{00958\ \ \ \ \ \ \ \ \ \_global\_ptr-\/>mount(physical\_filename,\ mount\_point,\ flags,\ password);}
\DoxyCodeLine{00959\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00960\ \ \ \ \ \}}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \ \ \ \ \mbox{\hyperlink{classConfigVariableString}{ConfigVariableString}}\ vfs\_mount\_ramdisk}
\DoxyCodeLine{00963\ \ \ \ \ \ \ (\textcolor{stringliteral}{"{}vfs-\/mount-\/ramdisk"{}},\ \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{00964\ \ \ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}vfs-\/mount-\/ramdisk\ mount-\/point\ [options]"{}}));}
\DoxyCodeLine{00965\ \ \ \ \ \textcolor{keywordflow}{if}\ (!vfs\_mount\_ramdisk.empty())\ \{}
\DoxyCodeLine{00966\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_point\ =\ vfs\_mount\_ramdisk;}
\DoxyCodeLine{00967\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ options;}
\DoxyCodeLine{00968\ }
\DoxyCodeLine{00969\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ space\ =\ mount\_point.rfind(\textcolor{charliteral}{'\ '});}
\DoxyCodeLine{00970\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ !=\ string::npos)\ \{}
\DoxyCodeLine{00971\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ a\ space,\ we\ have\ the\ optional\ options\ field.}}
\DoxyCodeLine{00972\ \ \ \ \ \ \ \ \ options\ =\ mount\_point.substr(space\ +\ 1);}
\DoxyCodeLine{00973\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ >\ 0\ \&\&\ isspace(mount\_point[space\ -\/\ 1]))\ \{}
\DoxyCodeLine{00974\ \ \ \ \ \ \ \ \ \ \ -\/-\/space;}
\DoxyCodeLine{00975\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00976\ \ \ \ \ \ \ \ \ mount\_point\ =\ mount\_point.substr(0,\ space);}
\DoxyCodeLine{00977\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00978\ }
\DoxyCodeLine{00979\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ flags;}
\DoxyCodeLine{00980\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ password;}
\DoxyCodeLine{00981\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileSystem_a633ae392289b10c143f1aeab2f4bca31}{parse\_options}}(options,\ flags,\ password);}
\DoxyCodeLine{00982\ }
\DoxyCodeLine{00983\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}})\ ramdisk\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountRamdisk}{VirtualFileMountRamdisk}};}
\DoxyCodeLine{00984\ \ \ \ \ \ \ \_global\_ptr-\/>mount(ramdisk,\ mount\_point,\ flags);}
\DoxyCodeLine{00985\ \ \ \ \ \}}
\DoxyCodeLine{00986\ \ \ \}}
\DoxyCodeLine{00987\ }
\DoxyCodeLine{00988\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00989\ \}}
\DoxyCodeLine{00990\ }
\DoxyCodeLine{01000\ istream\ *VirtualFileSystem::}
\DoxyCodeLine{01001\ open\_read\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{bool}\ auto\_unwrap)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01002\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ get\_file(filename,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01003\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01004\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01005\ \ \ \}}
\DoxyCodeLine{01006\ \ \ istream\ *str\ =\ file-\/>open\_read\_file(auto\_unwrap);}
\DoxyCodeLine{01007\ \ \ \textcolor{keywordflow}{if}\ (str\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ str-\/>fail())\ \{}
\DoxyCodeLine{01008\ \ \ \ \ close\_read\_file(str);}
\DoxyCodeLine{01009\ \ \ \ \ str\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01010\ \ \ \}}
\DoxyCodeLine{01011\ \ \ \textcolor{keywordflow}{return}\ str;}
\DoxyCodeLine{01012\ \}}
\DoxyCodeLine{01013\ }
\DoxyCodeLine{01020\ \textcolor{keywordtype}{void}\ VirtualFileSystem::}
\DoxyCodeLine{01021\ close\_read\_file(istream\ *stream)\ \{}
\DoxyCodeLine{01022\ \ \ \textcolor{keywordflow}{if}\ (stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01023\ \ \ \ \ \textcolor{comment}{//\ For\ some\ reason-\/-\/compiler\ bug\ in\ gcc\ 3.2?-\/-\/explicitly\ deleting\ the}}
\DoxyCodeLine{01024\ \ \ \ \ \textcolor{comment}{//\ stream\ pointer\ does\ not\ call\ the\ appropriate\ global\ delete\ function;}}
\DoxyCodeLine{01025\ \ \ \ \ \textcolor{comment}{//\ instead\ apparently\ calling\ the\ system\ delete\ function.\ \ So\ we\ call\ the}}
\DoxyCodeLine{01026\ \ \ \ \ \textcolor{comment}{//\ delete\ function\ by\ hand\ instead.}}
\DoxyCodeLine{01027\ \textcolor{preprocessor}{\#if\ defined(\_\_GNUC\_\_)\ \&\&\ !defined(USE\_MEMORY\_NOWRAPPERS)\ \&\&\ defined(REDEFINE\_GLOBAL\_OPERATOR\_NEW)}}
\DoxyCodeLine{01028\ \ \ \ \ stream-\/>\string~istream();}
\DoxyCodeLine{01029\ \ \ \ \ (*global\_operator\_delete)(stream);}
\DoxyCodeLine{01030\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{01031\ \ \ \ \ \textcolor{keyword}{delete}\ stream;}
\DoxyCodeLine{01032\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01033\ \ \ \}}
\DoxyCodeLine{01034\ \}}
\DoxyCodeLine{01035\ }
\DoxyCodeLine{01044\ ostream\ *VirtualFileSystem::}
\DoxyCodeLine{01045\ open\_write\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{bool}\ auto\_wrap,\ \textcolor{keywordtype}{bool}\ truncate)\ \{}
\DoxyCodeLine{01046\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ create\_file(filename);}
\DoxyCodeLine{01047\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01048\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01049\ \ \ \}}
\DoxyCodeLine{01050\ \ \ ostream\ *str\ =\ file-\/>open\_write\_file(auto\_wrap,\ truncate);}
\DoxyCodeLine{01051\ \ \ \textcolor{keywordflow}{if}\ (str\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ str-\/>fail())\ \{}
\DoxyCodeLine{01052\ \ \ \ \ close\_write\_file(str);}
\DoxyCodeLine{01053\ \ \ \ \ str\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01054\ \ \ \}}
\DoxyCodeLine{01055\ \ \ \textcolor{keywordflow}{return}\ str;}
\DoxyCodeLine{01056\ \}}
\DoxyCodeLine{01057\ }
\DoxyCodeLine{01063\ ostream\ *VirtualFileSystem::}
\DoxyCodeLine{01064\ open\_append\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{01065\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ create\_file(filename);}
\DoxyCodeLine{01066\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01067\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01068\ \ \ \}}
\DoxyCodeLine{01069\ \ \ ostream\ *str\ =\ file-\/>open\_append\_file();}
\DoxyCodeLine{01070\ \ \ \textcolor{keywordflow}{if}\ (str\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ str-\/>fail())\ \{}
\DoxyCodeLine{01071\ \ \ \ \ close\_write\_file(str);}
\DoxyCodeLine{01072\ \ \ \ \ str\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01073\ \ \ \}}
\DoxyCodeLine{01074\ \ \ \textcolor{keywordflow}{return}\ str;}
\DoxyCodeLine{01075\ \}}
\DoxyCodeLine{01076\ }
\DoxyCodeLine{01083\ \textcolor{keywordtype}{void}\ VirtualFileSystem::}
\DoxyCodeLine{01084\ close\_write\_file(ostream\ *stream)\ \{}
\DoxyCodeLine{01085\ \ \ \textcolor{keywordflow}{if}\ (stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01086\ \textcolor{preprocessor}{\#if\ defined(\_\_GNUC\_\_)\ \&\&\ !defined(USE\_MEMORY\_NOWRAPPERS)\ \&\&\ defined(REDEFINE\_GLOBAL\_OPERATOR\_NEW)}}
\DoxyCodeLine{01087\ \ \ \ \ stream-\/>\string~ostream();}
\DoxyCodeLine{01088\ \ \ \ \ (*global\_operator\_delete)(stream);}
\DoxyCodeLine{01089\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{01090\ \ \ \ \ \textcolor{keyword}{delete}\ stream;}
\DoxyCodeLine{01091\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01092\ \ \ \}}
\DoxyCodeLine{01093\ \}}
\DoxyCodeLine{01094\ }
\DoxyCodeLine{01100\ iostream\ *VirtualFileSystem::}
\DoxyCodeLine{01101\ open\_read\_write\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{bool}\ truncate)\ \{}
\DoxyCodeLine{01102\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ create\_file(filename);}
\DoxyCodeLine{01103\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01104\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01105\ \ \ \}}
\DoxyCodeLine{01106\ \ \ iostream\ *str\ =\ file-\/>open\_read\_write\_file(truncate);}
\DoxyCodeLine{01107\ \ \ \textcolor{keywordflow}{if}\ (str\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ str-\/>fail())\ \{}
\DoxyCodeLine{01108\ \ \ \ \ close\_read\_write\_file(str);}
\DoxyCodeLine{01109\ \ \ \ \ str\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01110\ \ \ \}}
\DoxyCodeLine{01111\ \ \ \textcolor{keywordflow}{return}\ str;}
\DoxyCodeLine{01112\ \}}
\DoxyCodeLine{01113\ }
\DoxyCodeLine{01119\ iostream\ *VirtualFileSystem::}
\DoxyCodeLine{01120\ open\_read\_append\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{01121\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ create\_file(filename);}
\DoxyCodeLine{01122\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01123\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01124\ \ \ \}}
\DoxyCodeLine{01125\ \ \ iostream\ *str\ =\ file-\/>open\_read\_append\_file();}
\DoxyCodeLine{01126\ \ \ \textcolor{keywordflow}{if}\ (str\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ str-\/>fail())\ \{}
\DoxyCodeLine{01127\ \ \ \ \ close\_read\_write\_file(str);}
\DoxyCodeLine{01128\ \ \ \ \ str\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01129\ \ \ \}}
\DoxyCodeLine{01130\ \ \ \textcolor{keywordflow}{return}\ str;}
\DoxyCodeLine{01131\ \}}
\DoxyCodeLine{01132\ }
\DoxyCodeLine{01139\ \textcolor{keywordtype}{void}\ VirtualFileSystem::}
\DoxyCodeLine{01140\ close\_read\_write\_file(iostream\ *stream)\ \{}
\DoxyCodeLine{01141\ \ \ \textcolor{keywordflow}{if}\ (stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01142\ \textcolor{preprocessor}{\#if\ defined(\_\_GNUC\_\_)\ \&\&\ !defined(USE\_MEMORY\_NOWRAPPERS)\ \&\&\ defined(REDEFINE\_GLOBAL\_OPERATOR\_NEW)}}
\DoxyCodeLine{01143\ \ \ \ \ stream-\/>\string~iostream();}
\DoxyCodeLine{01144\ \ \ \ \ (*global\_operator\_delete)(stream);}
\DoxyCodeLine{01145\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{01146\ \ \ \ \ \textcolor{keyword}{delete}\ stream;}
\DoxyCodeLine{01147\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01148\ \ \ \}}
\DoxyCodeLine{01149\ \}}
\DoxyCodeLine{01150\ }
\DoxyCodeLine{01154\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classVirtualFileSystem_ac1d017feddbc5852e5aad3be09e9341c}{VirtualFileSystem::}}}
\DoxyCodeLine{01155\ \mbox{\hyperlink{classVirtualFileSystem_ac1d017feddbc5852e5aad3be09e9341c}{atomic\_compare\_and\_exchange\_contents}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{string}\ \&orig\_contents,}
\DoxyCodeLine{01156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&old\_contents,}
\DoxyCodeLine{01157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&new\_contents)\ \{}
\DoxyCodeLine{01158\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ create\_file(filename);}
\DoxyCodeLine{01159\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01160\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01161\ \ \ \}}
\DoxyCodeLine{01162\ }
\DoxyCodeLine{01163\ \ \ \textcolor{keywordflow}{return}\ file-\/>atomic\_compare\_and\_exchange\_contents(orig\_contents,\ old\_contents,\ new\_contents);}
\DoxyCodeLine{01164\ \}}
\DoxyCodeLine{01165\ }
\DoxyCodeLine{01169\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classVirtualFileSystem_afeefbe0c6e16290abfdb375aa92aabc2}{VirtualFileSystem::}}}
\DoxyCodeLine{01170\ \mbox{\hyperlink{classVirtualFileSystem_afeefbe0c6e16290abfdb375aa92aabc2}{atomic\_read\_contents}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{string}\ \&contents)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01171\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ get\_file(filename,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01172\ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01173\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01174\ \ \ \}}
\DoxyCodeLine{01175\ }
\DoxyCodeLine{01176\ \ \ \textcolor{keywordflow}{return}\ file-\/>atomic\_read\_contents(contents);}
\DoxyCodeLine{01177\ \}}
\DoxyCodeLine{01178\ }
\DoxyCodeLine{01187\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVirtualFileSystem_a9dc97377ab94e511b0607759116b44b8}{VirtualFileSystem::}}}
\DoxyCodeLine{01188\ \mbox{\hyperlink{classVirtualFileSystem_a9dc97377ab94e511b0607759116b44b8}{scan\_mount\_points}}(vector\_string\ \&names,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&path)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01189\ \ \ nassertv(!path.empty()\ \&\&\ !path.is\_local());}
\DoxyCodeLine{01190\ \ \ \textcolor{keywordtype}{string}\ prefix\ =\ path.get\_fullpath().substr(1);}
\DoxyCodeLine{01191\ \ \ Mounts::const\_iterator\ mi;}
\DoxyCodeLine{01192\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_mounts.begin();\ mi\ !=\ \_mounts.end();\ ++mi)\ \{}
\DoxyCodeLine{01193\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ (*mi);}
\DoxyCodeLine{01194\ }
\DoxyCodeLine{01195\ \ \ \ \ \textcolor{keywordtype}{string}\ mount\_point\ =\ mount-\/>get\_mount\_point();}
\DoxyCodeLine{01196\ \ \ \ \ \textcolor{keywordflow}{if}\ (prefix.empty())\ \{}
\DoxyCodeLine{01197\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ indicated\ path\ is\ the\ root.\ \ Is\ the\ mount\ point\ on\ the\ root?}}
\DoxyCodeLine{01198\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mount\_point.find(\textcolor{charliteral}{'/'})\ ==\ string::npos)\ \{}
\DoxyCodeLine{01199\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ embedded\ slashes,\ so\ the\ mount\ point\ is\ only\ one\ directory\ below}}
\DoxyCodeLine{01200\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ root.}}
\DoxyCodeLine{01201\ \ \ \ \ \ \ \ \ names.push\_back(mount\_point);}
\DoxyCodeLine{01202\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01203\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01204\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mount\_point.substr(0,\ prefix.length())\ ==\ prefix\ \&\&}
\DoxyCodeLine{01205\ \ \ \ \ \ \ \ \ \ \ mount\_point.length()\ >\ prefix.length()\ \&\&}
\DoxyCodeLine{01206\ \ \ \ \ \ \ \ \ \ \ mount\_point[prefix.length()]\ ==\ \textcolor{charliteral}{'/'})\ \{}
\DoxyCodeLine{01207\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ mount\ point\ is\ below\ the\ indicated\ path.\ \ Is\ it\ only\ one}}
\DoxyCodeLine{01208\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ directory\ below?}}
\DoxyCodeLine{01209\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ basename\ =\ mount\_point.substr(prefix.length()\ +\ 1);}
\DoxyCodeLine{01210\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (basename.find(\textcolor{charliteral}{'/'})\ ==\ string::npos)\ \{}
\DoxyCodeLine{01211\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ embedded\ slashes,\ so\ it's\ only\ one\ directory\ below.}}
\DoxyCodeLine{01212\ \ \ \ \ \ \ \ \ \ \ names.push\_back(basename);}
\DoxyCodeLine{01213\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01214\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01215\ \ \ \ \ \}}
\DoxyCodeLine{01216\ \ \ \}}
\DoxyCodeLine{01217\ \}}
\DoxyCodeLine{01218\ }
\DoxyCodeLine{01219\ }
\DoxyCodeLine{01224\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVirtualFileSystem_a633ae392289b10c143f1aeab2f4bca31}{VirtualFileSystem::}}}
\DoxyCodeLine{01225\ \mbox{\hyperlink{classVirtualFileSystem_a633ae392289b10c143f1aeab2f4bca31}{parse\_options}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&options,\ \textcolor{keywordtype}{int}\ \&flags,\ \textcolor{keywordtype}{string}\ \&password)\ \{}
\DoxyCodeLine{01226\ \ \ flags\ =\ 0;}
\DoxyCodeLine{01227\ \ \ password\ =\ string();}
\DoxyCodeLine{01228\ }
\DoxyCodeLine{01229\ \ \ \textcolor{comment}{//\ Split\ the\ options\ up\ by\ commas.}}
\DoxyCodeLine{01230\ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ 0;}
\DoxyCodeLine{01231\ \ \ \textcolor{keywordtype}{size\_t}\ q\ =\ options.find(\textcolor{charliteral}{','},\ p);}
\DoxyCodeLine{01232\ \ \ \textcolor{keywordflow}{while}\ (q\ !=\ string::npos)\ \{}
\DoxyCodeLine{01233\ \ \ \ \ \mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{parse\_option}}(options.substr(p,\ q\ -\/\ p),}
\DoxyCodeLine{01234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ flags,\ password);}
\DoxyCodeLine{01235\ \ \ \ \ p\ =\ q\ +\ 1;}
\DoxyCodeLine{01236\ \ \ \ \ q\ =\ options.find(\textcolor{charliteral}{','},\ p);}
\DoxyCodeLine{01237\ \ \ \}}
\DoxyCodeLine{01238\ \ \ \mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{parse\_option}}(options.substr(p),\ flags,\ password);}
\DoxyCodeLine{01239\ \}}
\DoxyCodeLine{01240\ }
\DoxyCodeLine{01245\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{VirtualFileSystem::}}}
\DoxyCodeLine{01246\ \mbox{\hyperlink{classVirtualFileSystem_a7e1ba639a31e07212c021967af9d54ad}{parse\_option}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&\mbox{\hyperlink{structoption}{option}},\ \textcolor{keywordtype}{int}\ \&flags,\ \textcolor{keywordtype}{string}\ \&password)\ \{}
\DoxyCodeLine{01247\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structoption}{option}}\ ==\ \textcolor{stringliteral}{"{}0"{}}\ ||\ \mbox{\hyperlink{structoption}{option}}.empty())\ \{}
\DoxyCodeLine{01248\ \ \ \ \ \textcolor{comment}{//\ 0\ is\ the\ null\ option.}}
\DoxyCodeLine{01249\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structoption}{option}}\ ==\ \textcolor{stringliteral}{"{}ro"{}})\ \{}
\DoxyCodeLine{01250\ \ \ \ \ flags\ |=\ MF\_read\_only;}
\DoxyCodeLine{01251\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structoption}{option}}.substr(0,\ 3)\ ==\ \textcolor{stringliteral}{"{}pw:"{}})\ \{}
\DoxyCodeLine{01252\ \ \ \ \ password\ =\ \mbox{\hyperlink{structoption}{option}}.substr(3);}
\DoxyCodeLine{01253\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01254\ \ \ \ \ express\_cat.warning()}
\DoxyCodeLine{01255\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ option\ on\ vfs-\/mount:\ \(\backslash\)"{}"{}}\ <<\ \mbox{\hyperlink{structoption}{option}}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01256\ \ \ \}}
\DoxyCodeLine{01257\ \}}
\DoxyCodeLine{01258\ }
\DoxyCodeLine{01266\ \mbox{\hyperlink{classFilename}{Filename}}\ VirtualFileSystem::}
\DoxyCodeLine{01267\ normalize\_mount\_point(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01268\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ nmp\ =\ mount\_point;}
\DoxyCodeLine{01269\ \ \ \textcolor{keywordflow}{if}\ (nmp.is\_local())\ \{}
\DoxyCodeLine{01270\ \ \ \ \ nmp\ =\ \mbox{\hyperlink{classFilename}{Filename}}(\_cwd,\ mount\_point);}
\DoxyCodeLine{01271\ \ \ \}}
\DoxyCodeLine{01272\ \ \ nmp.\mbox{\hyperlink{classFilename_a741ce752b93d24e2e87bff42f6a0b828}{standardize}}();}
\DoxyCodeLine{01273\ \ \ nassertr(!nmp.empty()\ \&\&\ nmp[0]\ ==\ \textcolor{charliteral}{'/'},\ nmp);}
\DoxyCodeLine{01274\ \ \ \textcolor{keywordflow}{return}\ nmp.get\_fullpath().substr(1);}
\DoxyCodeLine{01275\ \}}
\DoxyCodeLine{01276\ }
\DoxyCodeLine{01280\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{01281\ do\_mount(\mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&mount\_point,\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{01282\ \ \ nassertr(mount-\/>\_file\_system\ ==\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{01283\ \ \ mount-\/>\_file\_system\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{01284\ \ \ mount-\/>\_mount\_point\ =\ normalize\_mount\_point(mount\_point);}
\DoxyCodeLine{01285\ \ \ mount-\/>\_mount\_flags\ =\ flags;}
\DoxyCodeLine{01286\ \ \ \_mounts.push\_back(mount);}
\DoxyCodeLine{01287\ \ \ ++\_mount\_seq;}
\DoxyCodeLine{01288\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01289\ \}}
\DoxyCodeLine{01290\ }
\DoxyCodeLine{01295\ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ VirtualFileSystem::}
\DoxyCodeLine{01296\ do\_get\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{int}\ open\_flags)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01297\ \ \ \textcolor{keywordflow}{if}\ (filename.empty())\ \{}
\DoxyCodeLine{01298\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01299\ \ \ \}}
\DoxyCodeLine{01300\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ pathname(filename);}
\DoxyCodeLine{01301\ \ \ \textcolor{keywordflow}{if}\ (pathname.is\_local())\ \{}
\DoxyCodeLine{01302\ \ \ \ \ pathname\ =\ \mbox{\hyperlink{classFilename}{Filename}}(\_cwd,\ filename);}
\DoxyCodeLine{01303\ \ \ \ \ \textcolor{keywordflow}{if}\ (filename.is\_text())\ \{}
\DoxyCodeLine{01304\ \ \ \ \ \ \ pathname.set\_text();}
\DoxyCodeLine{01305\ \ \ \ \ \}}
\DoxyCodeLine{01306\ \ \ \}}
\DoxyCodeLine{01307\ \ \ pathname.standardize();}
\DoxyCodeLine{01308\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ strpath\ =\ pathname.\mbox{\hyperlink{classFilename_a3900c44b7bef44eba442c171daf0b70c}{get\_filename\_index}}(0).get\_fullpath().substr(1);}
\DoxyCodeLine{01309\ \ \ strpath.set\_type(filename.get\_type());}
\DoxyCodeLine{01310\ \ \ \textcolor{comment}{//\ Also\ transparently\ look\ for\ a\ regular\ file\ suffixed\ .pz.}}
\DoxyCodeLine{01311\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ strpath\_pz\ =\ strpath\ +\ \textcolor{stringliteral}{"{}.pz"{}};}
\DoxyCodeLine{01312\ }
\DoxyCodeLine{01313\ \ \ \textcolor{comment}{//\ Now\ scan\ all\ the\ mount\ points,\ from\ the\ back\ (since\ later\ mounts\ override}}
\DoxyCodeLine{01314\ \ \ \textcolor{comment}{//\ more\ recent\ ones),\ until\ a\ match\ is\ found.}}
\DoxyCodeLine{01315\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ found\_file\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01316\ \ \ \mbox{\hyperlink{classVirtualFileComposite}{VirtualFileComposite}}\ *composite\_file\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01317\ }
\DoxyCodeLine{01318\ \ \ \textcolor{comment}{//\ We\ use\ an\ index\ instead\ of\ an\ iterator,\ since\ the\ vector\ might\ change\ if}}
\DoxyCodeLine{01319\ \ \ \textcolor{comment}{//\ implicit\ mounts\ are\ added\ during\ this\ loop.}}
\DoxyCodeLine{01320\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ start\_seq\ =\ \_mount\_seq;}
\DoxyCodeLine{01321\ }
\DoxyCodeLine{01322\ \ \ \textcolor{keywordtype}{size\_t}\ i\ =\ \_mounts.size();}
\DoxyCodeLine{01323\ \ \ \textcolor{keywordflow}{while}\ (i\ >\ 0)\ \{}
\DoxyCodeLine{01324\ \ \ \ \ -\/-\/i;}
\DoxyCodeLine{01325\ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount\ =\ \_mounts[i];}
\DoxyCodeLine{01326\ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ mount\_point\ =\ mount-\/>get\_mount\_point();}
\DoxyCodeLine{01327\ \ \ \ \ \textcolor{keywordflow}{if}\ (strpath\ ==\ mount\_point)\ \{}
\DoxyCodeLine{01328\ \ \ \ \ \ \ \textcolor{comment}{//\ Here's\ an\ exact\ match\ on\ the\ mount\ point.\ \ This\ filename\ is\ the\ root}}
\DoxyCodeLine{01329\ \ \ \ \ \ \ \textcolor{comment}{//\ directory\ of\ this\ mount\ object.}}
\DoxyCodeLine{01330\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (consider\_match(found\_file,\ composite\_file,\ mount,\ \textcolor{stringliteral}{"{}"{}},\ pathname,}
\DoxyCodeLine{01331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{false},\ open\_flags))\ \{}
\DoxyCodeLine{01332\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01333\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01334\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (mount\_point.empty())\ \{}
\DoxyCodeLine{01335\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ the\ root\ mount\ point;\ all\ files\ are\ in\ here.}}
\DoxyCodeLine{01336\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (consider\_match(found\_file,\ composite\_file,\ mount,\ strpath,}
\DoxyCodeLine{01337\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pathname,\ \textcolor{keyword}{false},\ open\_flags))\ \{}
\DoxyCodeLine{01338\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01339\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01340\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vfs\_implicit\_pz)\ \{}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (consider\_match(found\_file,\ composite\_file,\ mount,\ strpath\_pz,}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pathname,\ \textcolor{keyword}{true},\ open\_flags))\ \{}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01346\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01347\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_ZLIB}}
\DoxyCodeLine{01348\ }
\DoxyCodeLine{01349\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (strpath.length()\ >\ mount\_point.length()\ \&\&}
\DoxyCodeLine{01350\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ mount\_point\ ==\ strpath.substr(0,\ mount\_point.length())\ \&\&}
\DoxyCodeLine{01351\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ strpath[mount\_point.length()]\ ==\ \textcolor{charliteral}{'/'})\ \{}
\DoxyCodeLine{01352\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ pathname\ falls\ within\ this\ mount\ system.}}
\DoxyCodeLine{01353\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ local\_filename\ =\ strpath.substr(mount\_point.length()\ +\ 1);}
\DoxyCodeLine{01354\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ local\_filename\_pz\ =\ strpath\_pz.substr(mount\_point.length()\ +\ 1);}
\DoxyCodeLine{01355\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (consider\_match(found\_file,\ composite\_file,\ mount,\ local\_filename,}
\DoxyCodeLine{01356\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pathname,\ \textcolor{keyword}{false},\ open\_flags))\ \{}
\DoxyCodeLine{01357\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01358\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01359\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{01360\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vfs\_implicit\_pz)\ \{}
\DoxyCodeLine{01361\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Bingo!}}
\DoxyCodeLine{01362\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (consider\_match(found\_file,\ composite\_file,\ mount,\ local\_filename\_pz,}
\DoxyCodeLine{01363\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pathname,\ \textcolor{keyword}{true},\ open\_flags))\ \{}
\DoxyCodeLine{01364\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01365\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01367\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_ZLIB}}
\DoxyCodeLine{01368\ \ \ \ \ \}}
\DoxyCodeLine{01369\ }
\DoxyCodeLine{01370\ \ \ \ \ \textcolor{comment}{//\ If\ we\ discover\ that\ a\ file\ has\ been\ implicitly\ mounted\ during\ one\ of}}
\DoxyCodeLine{01371\ \ \ \ \ \textcolor{comment}{//\ the\ above\ operations,\ start\ over\ from\ the\ beginning\ of\ the\ loop.}}
\DoxyCodeLine{01372\ \ \ \ \ \textcolor{keywordflow}{if}\ (start\_seq\ !=\ \_mount\_seq)\ \{}
\DoxyCodeLine{01373\ \ \ \ \ \ \ start\_seq\ =\ \_mount\_seq;}
\DoxyCodeLine{01374\ \ \ \ \ \ \ i\ =\ \_mounts.size();}
\DoxyCodeLine{01375\ \ \ \ \ \}}
\DoxyCodeLine{01376\ \ \ \}}
\DoxyCodeLine{01377\ }
\DoxyCodeLine{01378\ \ \ \textcolor{keywordflow}{if}\ (found\_file\ ==\ \textcolor{keyword}{nullptr}\ \&\&\ vfs\_implicit\_mf)\ \{}
\DoxyCodeLine{01379\ \ \ \ \ \textcolor{comment}{//\ The\ file\ wasn't\ found,\ as-\/is.\ \ Does\ it\ appear\ to\ be\ an\ implicit\ .mf}}
\DoxyCodeLine{01380\ \ \ \ \ \textcolor{comment}{//\ file\ reference?}}
\DoxyCodeLine{01381\ \ \ \ \ ((\mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *)\textcolor{keyword}{this})-\/>consider\_mount\_mf(filename);}
\DoxyCodeLine{01382\ }
\DoxyCodeLine{01383\ \ \ \ \ \textcolor{keywordflow}{if}\ (start\_seq\ !=\ \_mount\_seq)\ \{}
\DoxyCodeLine{01384\ \ \ \ \ \ \ \textcolor{comment}{//\ Yes,\ it\ was,\ or\ some\ nested\ file\ was.\ \ Now\ that\ we've\ implicitly}}
\DoxyCodeLine{01385\ \ \ \ \ \ \ \textcolor{comment}{//\ mounted\ the\ .mf\ file,\ go\ back\ and\ look\ again.}}
\DoxyCodeLine{01386\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ do\_get\_file(filename,\ open\_flags);}
\DoxyCodeLine{01387\ \ \ \ \ \}}
\DoxyCodeLine{01388\ \ \ \}}
\DoxyCodeLine{01389\ }
\DoxyCodeLine{01390\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)\ \&\&\ !defined(NDEBUG)}}
\DoxyCodeLine{01391\ \ \ \textcolor{keywordflow}{if}\ (!found\_file)\ \{}
\DoxyCodeLine{01392\ \ \ \ \ \textcolor{comment}{//\ The\ file\ could\ not\ be\ found.\ \ Perhaps\ this\ is\ because\ the\ user\ passed}}
\DoxyCodeLine{01393\ \ \ \ \ \textcolor{comment}{//\ in\ a\ Windows-\/style\ path\ where\ a\ Unix-\/style\ path\ was\ expected?}}
\DoxyCodeLine{01394\ \ \ \ \ \textcolor{keywordflow}{if}\ (filename.length()\ >\ 2\ \&\&\ isalpha(filename[0])\ \&\&\ filename[1]\ ==\ \textcolor{charliteral}{':'}\ \&\&}
\DoxyCodeLine{01395\ \ \ \ \ \ \ \ \ (filename[2]\ ==\ \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'}\ ||\ filename[2]\ ==\ \textcolor{charliteral}{'/'}))\ \{}
\DoxyCodeLine{01396\ }
\DoxyCodeLine{01397\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ corrected\_fn\ =\ \mbox{\hyperlink{classFilename_ab17a80adaab942d6570d114d6f0675c3}{Filename::from\_os\_specific}}(filename);}
\DoxyCodeLine{01398\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (corrected\_fn.\mbox{\hyperlink{classFilename_af8a2ef9ed26abbed32786e6d8025c2c7}{exists}}())\ \{}
\DoxyCodeLine{01399\ \ \ \ \ \ \ \ \ express\_cat.warning()}
\DoxyCodeLine{01400\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Filename\ uses\ Windows-\/style\ path:\ "{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01401\ \ \ \ \ \ \ \ \ express\_cat.warning()}
\DoxyCodeLine{01402\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ expected\ Unix-\/style\ path:\ "{}}\ <<\ corrected\_fn\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01403\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01404\ \ \ \ \ \}}
\DoxyCodeLine{01405\ \ \ \}}
\DoxyCodeLine{01406\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01407\ }
\DoxyCodeLine{01408\ \ \ \textcolor{keywordflow}{return}\ found\_file;}
\DoxyCodeLine{01409\ \}}
\DoxyCodeLine{01410\ }
\DoxyCodeLine{01420\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{01421\ consider\_match(PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ \&found\_file,\ \mbox{\hyperlink{classVirtualFileComposite}{VirtualFileComposite}}\ *\&composite\_file,}
\DoxyCodeLine{01422\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileMount}{VirtualFileMount}}\ *mount,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&local\_filename,}
\DoxyCodeLine{01423\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&original\_filename,\ \textcolor{keywordtype}{bool}\ implicit\_pz\_file,}
\DoxyCodeLine{01424\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ open\_flags)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01425\ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ vfile\ =}
\DoxyCodeLine{01426\ \ \ \ \ mount-\/>make\_virtual\_file(local\_filename,\ original\_filename,\ \textcolor{keyword}{false},\ open\_flags);}
\DoxyCodeLine{01427\ \ \ \textcolor{keywordflow}{if}\ (!vfile-\/>has\_file()\ \&\&\ ((open\_flags\ \&\ OF\_allow\_nonexist)\ ==\ 0))\ \{}
\DoxyCodeLine{01428\ \ \ \ \ \textcolor{comment}{//\ Keep\ looking.}}
\DoxyCodeLine{01429\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01430\ \ \ \}}
\DoxyCodeLine{01431\ }
\DoxyCodeLine{01432\ \ \ \textcolor{keywordflow}{if}\ (found\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01433\ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ first\ match.\ \ Save\ it.}}
\DoxyCodeLine{01434\ \ \ \ \ found\_file\ =\ vfile;}
\DoxyCodeLine{01435\ \ \ \ \ \textcolor{keywordflow}{if}\ (!found\_file-\/>\mbox{\hyperlink{classVirtualFile_a880abea862fd038b33c578312d371058}{is\_directory}}()\ ||\ ((open\_flags\ \&\ OF\_make\_directory)\ !=\ 0))\ \{}
\DoxyCodeLine{01436\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ it's\ not\ a\ directory\ (or\ we\ wanted\ to\ make\ a\ directory),\ we're}}
\DoxyCodeLine{01437\ \ \ \ \ \ \ \textcolor{comment}{//\ done.}}
\DoxyCodeLine{01438\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01439\ \ \ \ \ \}}
\DoxyCodeLine{01440\ \ \ \ \ \textcolor{comment}{//\ It\ is\ a\ directory,\ so\ save\ it\ for\ later.}}
\DoxyCodeLine{01441\ \ \ \ \ \textcolor{keywordflow}{if}\ (implicit\_pz\_file)\ \{}
\DoxyCodeLine{01442\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ look\ for\ directories\ named\ file.pz.}}
\DoxyCodeLine{01443\ \ \ \ \ \ \ found\_file\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01444\ \ \ \ \ \}}
\DoxyCodeLine{01445\ }
\DoxyCodeLine{01446\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01447\ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ second\ match.\ \ The\ previous\ match(es)\ must\ have\ been}}
\DoxyCodeLine{01448\ \ \ \ \ \textcolor{comment}{//\ directories.}}
\DoxyCodeLine{01449\ \ \ \ \ \textcolor{keywordflow}{if}\ (!vfile-\/>is\_directory())\ \{}
\DoxyCodeLine{01450\ \ \ \ \ \ \ \textcolor{comment}{//\ However,\ this\ one\ isn't\ a\ directory.\ \ We're\ done.}}
\DoxyCodeLine{01451\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01452\ \ \ \ \ \}}
\DoxyCodeLine{01453\ }
\DoxyCodeLine{01454\ \ \ \ \ \textcolor{keywordflow}{if}\ (!implicit\_pz\_file)\ \{}
\DoxyCodeLine{01455\ \ \ \ \ \ \ \textcolor{comment}{//\ At\ least\ two\ directories\ matched\ to\ the\ same\ path.\ \ We\ need\ a}}
\DoxyCodeLine{01456\ \ \ \ \ \ \ \textcolor{comment}{//\ composite\ directory.}}
\DoxyCodeLine{01457\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (composite\_file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01458\ \ \ \ \ \ \ \ \ composite\_file\ =}
\DoxyCodeLine{01459\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileComposite}{VirtualFileComposite}}((\mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *)\textcolor{keyword}{this},\ found\_file-\/>get\_original\_filename());}
\DoxyCodeLine{01460\ \ \ \ \ \ \ \ \ composite\_file-\/>set\_original\_filename(original\_filename);}
\DoxyCodeLine{01461\ \ \ \ \ \ \ \ \ composite\_file-\/>add\_component(found\_file);}
\DoxyCodeLine{01462\ \ \ \ \ \ \ \ \ found\_file\ =\ composite\_file;}
\DoxyCodeLine{01463\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01464\ }
\DoxyCodeLine{01465\ \ \ \ \ \ \ composite\_file-\/>add\_component(vfile);}
\DoxyCodeLine{01466\ \ \ \ \ \}}
\DoxyCodeLine{01467\ \ \ \}}
\DoxyCodeLine{01468\ }
\DoxyCodeLine{01469\ \ \ \textcolor{comment}{//\ Keep\ going,\ looking\ for\ more\ directories.}}
\DoxyCodeLine{01470\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01471\ \}}
\DoxyCodeLine{01472\ }
\DoxyCodeLine{01481\ \textcolor{keywordtype}{bool}\ VirtualFileSystem::}
\DoxyCodeLine{01482\ consider\_mount\_mf(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{01483\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ dirname\ =\ filename.get\_dirname();}
\DoxyCodeLine{01484\ \ \ \textcolor{keywordflow}{if}\ (dirname.empty()\ ||\ dirname\ ==\ filename)\ \{}
\DoxyCodeLine{01485\ \ \ \ \ \textcolor{comment}{//\ Reached\ the\ top\ directory;\ no\ .mf\ file\ references.}}
\DoxyCodeLine{01486\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01487\ \ \ \}}
\DoxyCodeLine{01488\ \ \ \textcolor{keywordflow}{if}\ (is\_directory(dirname))\ \{}
\DoxyCodeLine{01489\ \ \ \ \ \textcolor{comment}{//\ Reached\ a\ real\ (or\ already-\/mounted)\ directory;\ no\ unmounted\ .mf\ file}}
\DoxyCodeLine{01490\ \ \ \ \ \textcolor{comment}{//\ references.}}
\DoxyCodeLine{01491\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01492\ \ \ \}}
\DoxyCodeLine{01493\ \ \ \textcolor{keywordflow}{if}\ (dirname.get\_extension()\ ==\ \textcolor{stringliteral}{"{}mf"{}})\ \{}
\DoxyCodeLine{01494\ \ \ \ \ \textcolor{comment}{//\ Hey,\ here's\ a\ multifile\ reference!}}
\DoxyCodeLine{01495\ \ \ \ \ dirname.set\_binary();}
\DoxyCodeLine{01496\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ do\_get\_file(dirname,\ \textcolor{keyword}{false});}
\DoxyCodeLine{01497\ \ \ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr}\ ||\ !file-\/>is\_regular\_file())\ \{}
\DoxyCodeLine{01498\ \ \ \ \ \ \ \textcolor{comment}{//\ Oh,\ never\ mind.\ \ Not\ a\ real\ file.}}
\DoxyCodeLine{01499\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01500\ \ \ \ \ \}}
\DoxyCodeLine{01501\ }
\DoxyCodeLine{01502\ \ \ \ \ PT(\mbox{\hyperlink{classMultifile}{Multifile}})\ multifile\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classMultifile}{Multifile}};}
\DoxyCodeLine{01503\ }
\DoxyCodeLine{01504\ \ \ \ \ istream\ *stream\ =\ file-\/>open\_read\_file(\textcolor{keyword}{false});}
\DoxyCodeLine{01505\ \ \ \ \ \textcolor{keywordflow}{if}\ (stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01506\ \ \ \ \ \ \ \textcolor{comment}{//\ Couldn't\ read\ file.}}
\DoxyCodeLine{01507\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01508\ \ \ \ \ \}}
\DoxyCodeLine{01509\ }
\DoxyCodeLine{01510\ \ \ \ \ \textcolor{comment}{//\ Wrap\ a\ thread-\/safe\ wrapper\ around\ that\ stream,\ so\ multiple\ threads\ can}}
\DoxyCodeLine{01511\ \ \ \ \ \textcolor{comment}{//\ safely\ read\ the\ multifile\ simultaneously.}}
\DoxyCodeLine{01512\ \ \ \ \ \mbox{\hyperlink{classIStreamWrapper}{IStreamWrapper}}\ *streamw\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classIStreamWrapper}{IStreamWrapper}}(stream,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01513\ }
\DoxyCodeLine{01514\ \ \ \ \ \textcolor{keywordflow}{if}\ (!multifile-\/>open\_read(streamw,\ \textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{01515\ \ \ \ \ \ \ \textcolor{comment}{//\ Invalid\ multifile.}}
\DoxyCodeLine{01516\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01517\ \ \ \ \ \}}
\DoxyCodeLine{01518\ }
\DoxyCodeLine{01519\ \ \ \ \ multifile-\/>set\_multifile\_name(dirname.get\_basename());}
\DoxyCodeLine{01520\ \ \ \ \ express\_cat-\/>info()}
\DoxyCodeLine{01521\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Implicitly\ mounting\ "{}}\ <<\ dirname\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01522\ }
\DoxyCodeLine{01523\ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}})\ new\_mount\ =}
\DoxyCodeLine{01524\ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classVirtualFileMountMultifile}{VirtualFileMountMultifile}}(multifile);}
\DoxyCodeLine{01525\ \ \ \ \ \textcolor{keywordflow}{return}\ do\_mount(new\_mount,\ dirname,\ MF\_read\_only);}
\DoxyCodeLine{01526\ \ \ \}}
\DoxyCodeLine{01527\ }
\DoxyCodeLine{01528\ \ \ \textcolor{comment}{//\ Recurse.}}
\DoxyCodeLine{01529\ \ \ \textcolor{keywordflow}{return}\ consider\_mount\_mf(dirname);}
\DoxyCodeLine{01530\ \}}

\end{DoxyCode}
