\doxysection{pfstream\+Buf.\+cxx}
\hypertarget{pfstreamBuf_8cxx_source}{}\label{pfstreamBuf_8cxx_source}\index{dtool/src/dtoolutil/pfstreamBuf.cxx@{dtool/src/dtoolutil/pfstreamBuf.cxx}}
\mbox{\hyperlink{pfstreamBuf_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pfstreamBuf_8h}{pfstreamBuf.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <assert.h>}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{keyword}{using\ }std::cerr;}
\DoxyCodeLine{00020\ \textcolor{keyword}{using\ }std::endl;}
\DoxyCodeLine{00021\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ PipeStreamBuf::PipeStreamBuf(PipeStreamBuf::Direction\ dir)\ :}
\DoxyCodeLine{00024\ \ \ \_dir(dir)}
\DoxyCodeLine{00025\ \{}
\DoxyCodeLine{00026\ \ \ init\_pipe();}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#ifndef\ PHAVE\_IOSTREAM}}
\DoxyCodeLine{00029\ \ \ \textcolor{comment}{//\ These\ lines,\ which\ are\ essential\ on\ older\ implementations\ of\ the\ iostream}}
\DoxyCodeLine{00030\ \ \ \textcolor{comment}{//\ library,\ are\ not\ understood\ by\ more\ recent\ versions.}}
\DoxyCodeLine{00031\ \ \ allocate();}
\DoxyCodeLine{00032\ \ \ assert((dir\ ==\ Input)\ ||\ (dir\ ==\ Output));}
\DoxyCodeLine{00033\ \ \ \textcolor{keywordflow}{if}\ (dir\ ==\ Input)\ \{}
\DoxyCodeLine{00034\ \ \ \ \ setg(base(),\ ebuf(),\ ebuf());}
\DoxyCodeLine{00035\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00036\ \ \ \ \ setp(base(),\ ebuf());}
\DoxyCodeLine{00037\ \ \ \}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ PHAVE\_IOSTREAM\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00039\ \}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ PipeStreamBuf::}
\DoxyCodeLine{00042\ \string~PipeStreamBuf(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00043\ \ \ \textcolor{keywordflow}{if}\ (is\_open())\ \{}
\DoxyCodeLine{00044\ \ \ \ \ sync();}
\DoxyCodeLine{00045\ \ \ \ \ flush();}
\DoxyCodeLine{00046\ \ \ \ \ close\_pipe();}
\DoxyCodeLine{00047\ \ \ \}}
\DoxyCodeLine{00048\ \}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{keywordtype}{void}\ PipeStreamBuf::flush(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00051\ \ \ assert(is\_open());}
\DoxyCodeLine{00052\ \ \ \textcolor{keywordflow}{if}\ (\_dir\ ==\ Output)\ \{}
\DoxyCodeLine{00053\ \ \ \ \ write\_chars(\textcolor{stringliteral}{"{}"{}},\ 0,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00054\ \ \ \}}
\DoxyCodeLine{00055\ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{keywordtype}{void}\ PipeStreamBuf::command(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ cmd)\ \{}
\DoxyCodeLine{00058\ \ \ assert(!is\_open());}
\DoxyCodeLine{00059\ \ \ open\_pipe(cmd);}
\DoxyCodeLine{00060\ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \textcolor{keywordtype}{int}\ PipeStreamBuf::overflow(\textcolor{keywordtype}{int}\ c)\ \{}
\DoxyCodeLine{00063\ \ \ assert(is\_open());}
\DoxyCodeLine{00064\ \ \ assert(\_dir\ ==\ Output);}
\DoxyCodeLine{00065\ \ \ std::streamsize\ n\ =\ pptr()\ -\/\ pbase();}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordflow}{if}\ (n\ !=\ 0)\ \{}
\DoxyCodeLine{00067\ \ \ \ \ write\_chars(pbase(),\ n,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00068\ \ \ \ \ pbump(-\/n);\ \ \textcolor{comment}{//\ reset\ pptr()}}
\DoxyCodeLine{00069\ \ \ \}}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordflow}{if}\ (c\ !=\ EOF)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ write\ one\ more\ character}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordtype}{char}\ ch\ =\ c;}
\DoxyCodeLine{00073\ \ \ \ \ write\_chars(\&ch,\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00074\ \ \ \}}
\DoxyCodeLine{00075\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00076\ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \textcolor{keywordtype}{int}\ PipeStreamBuf::sync(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00079\ \ \ assert(is\_open());}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (\_dir\ ==\ Output)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ std::streamsize\ n\ =\ pptr()\ -\/\ pbase();}
\DoxyCodeLine{00082\ \ \ \ \ write\_chars(pbase(),\ n,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00083\ \ \ \ \ pbump(-\/n);}
\DoxyCodeLine{00084\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00085\ \ \ \ \ std::streamsize\ n\ =\ egptr()\ -\/\ gptr();}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{if}\ (n\ !=\ 0)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ gbump(n);\ \ \textcolor{comment}{//\ flush\ all\ our\ stored\ input\ away}}
\DoxyCodeLine{00088\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}pfstream\ tossed\ out\ "{}}\ <<\ n\ <<\ \textcolor{stringliteral}{"{}\ bytes"{}}\ <<\ endl;}
\DoxyCodeLine{00090\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00091\ \ \ \ \ \}}
\DoxyCodeLine{00092\ \ \ \}}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00094\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \textcolor{keywordtype}{int}\ PipeStreamBuf::underflow(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{00097\ \ \ assert(\_dir\ ==\ Input);}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordflow}{if}\ ((eback()\ ==\ \textcolor{keyword}{nullptr})\ ||\ (gptr()\ ==\ \textcolor{keyword}{nullptr})\ ||}
\DoxyCodeLine{00099\ \ \ \ \ \ \ (egptr()\ ==\ \textcolor{keyword}{nullptr}))\ \{}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ must\ be\ new-\/style\ iostream\ library}}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordtype}{char}*\ buf\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{char}[4096];}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{keywordtype}{char}*\ ebuf\ =\ \&(buf[4096]);}
\DoxyCodeLine{00103\ \ \ \ \ setg(buf,\ ebuf,\ ebuf);}
\DoxyCodeLine{00104\ \ \ \}}
\DoxyCodeLine{00105\ \ \ \textcolor{keywordflow}{if}\ (gptr()\ <\ egptr())\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordtype}{char}\ c\ =\ *(gptr());}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordflow}{return}\ c;}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ \ \ \textcolor{keywordflow}{if}\ (eof\_pipe())\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keywordflow}{return}\ EOF;}
\DoxyCodeLine{00111\ \ \ \}}
\DoxyCodeLine{00112\ \textcolor{preprocessor}{\#ifdef\ PHAVE\_IOSTREAM}}
\DoxyCodeLine{00113\ \ \ \textcolor{keywordtype}{size\_t}\ len\ =\ 4096;}
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ PHAVE\_IOSTREAM\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00115\ \ \ \textcolor{keywordtype}{size\_t}\ len\ =\ ebuf()\ -\/\ base();}
\DoxyCodeLine{00116\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ PHAVE\_IOSTREAM\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordtype}{char}*\ buf\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{char}[len];}
\DoxyCodeLine{00118\ \ \ \textcolor{keywordtype}{size\_t}\ n\ =\ read\_pipe(buf,\ len);}
\DoxyCodeLine{00119\ \ \ \textcolor{keywordtype}{int}\ ret\ =\ buf[0];}
\DoxyCodeLine{00120\ \ \ \textcolor{keywordflow}{if}\ (n\ ==\ 0)}
\DoxyCodeLine{00121\ \ \ \ \ ret\ =\ EOF;}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00123\ \textcolor{preprocessor}{\#ifdef\ PHAVE\_IOSTREAM}}
\DoxyCodeLine{00124\ \ \ \ \ memcpy(eback()+(len-\/n),\ buf,\ n);}
\DoxyCodeLine{00125\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ PHAVE\_IOSTREAM\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00126\ \ \ \ \ memcpy(base()+(len-\/n),\ buf,\ n);}
\DoxyCodeLine{00127\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ PHAVE\_IOSTREAM\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00128\ \ \ \ \ gbump(-\/((\textcolor{keywordtype}{int})n));}
\DoxyCodeLine{00129\ \ \ \}}
\DoxyCodeLine{00130\ \ \ \textcolor{keyword}{delete}[]\ buf;}
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{return}\ ret;}
\DoxyCodeLine{00132\ \}}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \textcolor{keywordtype}{void}\ PipeStreamBuf::write\_chars(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ start,\ \textcolor{keywordtype}{int}\ length,\ \textcolor{keywordtype}{bool}\ flush)\ \{}
\DoxyCodeLine{00135\ \ \ assert(\_dir\ ==\ Output);}
\DoxyCodeLine{00136\ \ \ \textcolor{keywordtype}{size\_t}\ orig\ =\ \_line\_buffer.length();}
\DoxyCodeLine{00137\ \ \ \textcolor{keywordtype}{string}\ latest(start,\ length);}
\DoxyCodeLine{00138\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{if}\ (flush)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{comment}{//\ if\ we're\ going\ to\ flush\ the\ stream\ now,\ we\ dump\ the\ whole\ thing}}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ reguardless\ of\ whether\ we\ have\ reached\ end-\/of-\/line.}}
\DoxyCodeLine{00143\ \ \ \ \ line\ =\ \_line\_buffer\ +\ latest;}
\DoxyCodeLine{00144\ \ \ \ \ \_line\_buffer\ =\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00145\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ check\ for\ the\ end-\/of-\/line\ character.}}
\DoxyCodeLine{00147\ \ \ \ \ \_line\_buffer\ +=\ latest;}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ eol\ =\ \_line\_buffer.rfind(\textcolor{charliteral}{'\(\backslash\)n'},\ orig);}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordflow}{if}\ (eol\ !=\ string::npos)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ line\ =\ \_line\_buffer.substr(0,\ eol+1);}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \_line\_buffer\ =\ \_line\_buffer.substr(eol+1);}
\DoxyCodeLine{00152\ \ \ \ \ \}}
\DoxyCodeLine{00153\ \ \ \}}
\DoxyCodeLine{00154\ \ \ \textcolor{comment}{//\ now\ output\ 'line'}}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordtype}{size\_t}\ wrote\ =\ write\_pipe(line.c\_str(),\ line.length());}
\DoxyCodeLine{00156\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00157\ \ \ \textcolor{keywordflow}{if}\ (wrote\ !=\ line.length())}
\DoxyCodeLine{00158\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}wrote\ only\ "{}}\ <<\ wrote\ <<\ \textcolor{stringliteral}{"{}\ of\ "{}}\ <<\ line.length()}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ bytes\ to\ pipe"{}}\ <<\ endl;}
\DoxyCodeLine{00160\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00161\ \}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \textcolor{preprocessor}{\#ifndef\ WIN\_PIPE\_CALLS}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00169\ \textcolor{keywordtype}{void}\ PipeStreamBuf::}
\DoxyCodeLine{00170\ init\_pipe()\ \{}
\DoxyCodeLine{00171\ \ \ \_pipe\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00172\ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00177\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00178\ is\_open()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{return}\ \_pipe\ !=\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00180\ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00186\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00187\ eof\_pipe()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00188\ \ \ \textcolor{keywordflow}{return}\ (\_pipe\ ==\ \textcolor{keyword}{nullptr})\ ||\ feof(\_pipe);}
\DoxyCodeLine{00189\ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00198\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00199\ open\_pipe(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cmd)\ \{}
\DoxyCodeLine{00200\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *typ\ =\ (\_dir\ ==\ Output)?\textcolor{stringliteral}{"{}w"{}}:\textcolor{stringliteral}{"{}r"{}};}
\DoxyCodeLine{00201\ \ \ \_pipe\ =\ popen(cmd.c\_str(),\ typ);}
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{return}\ (\_pipe\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00203\ \}}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00208\ \textcolor{keywordtype}{void}\ PipeStreamBuf::}
\DoxyCodeLine{00209\ close\_pipe()\ \{}
\DoxyCodeLine{00210\ \ \ \textcolor{keywordflow}{if}\ (\_pipe\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00211\ \ \ \ \ fclose(\_pipe);}
\DoxyCodeLine{00212\ \ \ \ \ \_pipe\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00213\ \ \ \}}
\DoxyCodeLine{00214\ \}}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00220\ \textcolor{keywordtype}{size\_t}\ PipeStreamBuf::}
\DoxyCodeLine{00221\ write\_pipe(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *data,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordtype}{size\_t}\ wrote\_count\ =\ fwrite(data,\ 1,\ len,\ \_pipe);}
\DoxyCodeLine{00223\ \ \ fflush(\_pipe);}
\DoxyCodeLine{00224\ \ \ \textcolor{keywordflow}{return}\ wrote\_count;}
\DoxyCodeLine{00225\ \}}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00231\ \textcolor{keywordtype}{size\_t}\ PipeStreamBuf::}
\DoxyCodeLine{00232\ read\_pipe(\textcolor{keywordtype}{char}\ *data,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{00233\ \ \ \textcolor{keywordflow}{return}\ fread(data,\ 1,\ len,\ \_pipe);}
\DoxyCodeLine{00234\ \}}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \textcolor{preprocessor}{\#else\ \ }\textcolor{comment}{//\ WIN\_PIPE\_CALLS}}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \textcolor{comment}{//\ The\ official\ Windows\ way\ of\ reading\ from\ a\ child\ process,\ without\ using\ a}}
\DoxyCodeLine{00239\ \textcolor{comment}{//\ Unix-\/style\ convenience\ function\ like\ popen(),\ is\ similar\ in\ principle\ to}}
\DoxyCodeLine{00240\ \textcolor{comment}{//\ the\ Unix\ pipe()\ method.\ \ We\ have\ to\ first\ redirect\ our\ own\ stdout\ to\ an}}
\DoxyCodeLine{00241\ \textcolor{comment}{//\ anonymous\ pipe,\ then\ we\ spawn\ a\ child,\ who\ inherits\ this\ new\ stdout.\ \ Then}}
\DoxyCodeLine{00242\ \textcolor{comment}{//\ we\ can\ restore\ our\ own\ stdout,\ and\ read\ from\ the\ other\ end\ of\ the\ pipe.}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00248\ \textcolor{keywordtype}{void}\ PipeStreamBuf::}
\DoxyCodeLine{00249\ init\_pipe()\ \{}
\DoxyCodeLine{00250\ \ \ \_child\_out\ =\ 0;}
\DoxyCodeLine{00251\ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00256\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00257\ is\_open()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00258\ \ \ \textcolor{keywordflow}{return}\ (\_child\_out\ !=\ 0);}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00265\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00266\ eof\_pipe()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00267\ \ \ \textcolor{keywordflow}{return}\ (\_child\_out\ ==\ 0);}
\DoxyCodeLine{00268\ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00277\ \textcolor{keywordtype}{bool}\ PipeStreamBuf::}
\DoxyCodeLine{00278\ open\_pipe(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cmd)\ \{}
\DoxyCodeLine{00279\ \ \ close\_pipe();}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \textcolor{comment}{//\ At\ the\ present,\ this\ only\ works\ for\ input\ pipes.\ \ We\ can\ add\ code\ to}}
\DoxyCodeLine{00282\ \ \ \textcolor{comment}{//\ support\ output\ pipes\ later\ if\ anyone\ cares.}}
\DoxyCodeLine{00283\ \ \ \textcolor{keywordflow}{if}\ (\_dir\ ==\ Output)\ \{}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00285\ \ \ \}}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \ \ \textcolor{comment}{//\ First,\ save\ our\ current\ stdout,\ so\ we\ can\ restore\ it\ after\ all\ of\ this}}
\DoxyCodeLine{00288\ \ \ \textcolor{comment}{//\ nonsense.}}
\DoxyCodeLine{00289\ \ \ HANDLE\ hSaveStdout\ =\ GetStdHandle(STD\_OUTPUT\_HANDLE);}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00291\ \ \ \textcolor{comment}{//\ Now\ create\ a\ pipe\ to\ accept\ the\ child\ processes'\ output.}}
\DoxyCodeLine{00292\ \ \ HANDLE\ hChildStdoutRd,\ hChildStdoutWr;}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ \textcolor{comment}{//\ Set\ the\ bInheritHandle\ flag\ so\ pipe\ handles\ are\ inherited.}}
\DoxyCodeLine{00295\ \ \ SECURITY\_ATTRIBUTES\ saAttr;}
\DoxyCodeLine{00296\ \ \ saAttr.nLength\ =\ \textcolor{keyword}{sizeof}(SECURITY\_ATTRIBUTES);}
\DoxyCodeLine{00297\ \ \ saAttr.bInheritHandle\ =\ TRUE;}
\DoxyCodeLine{00298\ \ \ saAttr.lpSecurityDescriptor\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00299\ \ \ \textcolor{keywordflow}{if}\ (!CreatePipe(\&hChildStdoutRd,\ \&hChildStdoutWr,\ \&saAttr,\ 0))\ \{}
\DoxyCodeLine{00300\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00301\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}Unable\ to\ create\ output\ pipe\(\backslash\)n"{}};}
\DoxyCodeLine{00302\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{comment}{//\ Remap\ stdout\ to\ the\ "{}write"{}\ end\ of\ this\ pipe.}}
\DoxyCodeLine{00307\ \ \ \textcolor{keywordflow}{if}\ (!SetStdHandle(STD\_OUTPUT\_HANDLE,\ hChildStdoutWr))\ \{}
\DoxyCodeLine{00308\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00309\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}Unable\ to\ redirect\ stdout\(\backslash\)n"{}};}
\DoxyCodeLine{00310\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00311\ \ \ \ \ CloseHandle(hChildStdoutRd);}
\DoxyCodeLine{00312\ \ \ \ \ CloseHandle(hChildStdoutWr);}
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00314\ \ \ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \textcolor{comment}{//\ Create\ noninheritable\ read\ handle\ and\ close\ the\ inheritable\ read\ handle.}}
\DoxyCodeLine{00317\ }
\DoxyCodeLine{00318\ \ \ BOOL\ fSuccess\ =\ DuplicateHandle(GetCurrentProcess(),\ hChildStdoutRd,}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GetCurrentProcess(),\ \&\_child\_out,}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ FALSE,\ DUPLICATE\_SAME\_ACCESS);}
\DoxyCodeLine{00321\ }
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{if}\ (!fSuccess)\ \{}
\DoxyCodeLine{00323\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00324\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}DuplicateHandle\ failed\(\backslash\)n"{}};}
\DoxyCodeLine{00325\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00326\ \ \ \ \ CloseHandle(hChildStdoutRd);}
\DoxyCodeLine{00327\ \ \ \ \ CloseHandle(hChildStdoutWr);}
\DoxyCodeLine{00328\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00329\ \ \ \}}
\DoxyCodeLine{00330\ \ \ CloseHandle(hChildStdoutRd);}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ \textcolor{comment}{//\ Now\ spawn\ the\ child\ process.}}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \textcolor{comment}{//\ Both\ WinExec()\ and\ CreateProcess()\ want\ a\ non-\/const\ char\ pointer.\ \ Maybe}}
\DoxyCodeLine{00335\ \ \ \textcolor{comment}{//\ they\ change\ it,\ and\ maybe\ they\ don't.\ \ I'm\ not\ taking\ chances.}}
\DoxyCodeLine{00336\ \ \ \textcolor{keywordtype}{char}\ *cmdline\ =\ (\textcolor{keywordtype}{char}\ *)alloca(cmd.size()\ +\ 1);}
\DoxyCodeLine{00337\ \ \ memcpy(cmdline,\ cmd.data(),\ cmd.size());}
\DoxyCodeLine{00338\ \ \ cmdline[cmd.size()]\ =\ 0;}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \textcolor{comment}{//\ We\ should\ be\ using\ CreateProcess()\ instead\ of\ WinExec(),\ but\ that\ seems}}
\DoxyCodeLine{00341\ \ \ \textcolor{comment}{//\ to\ be\ likely\ to\ crash\ Win98.\ \ WinExec()\ seems\ better\ behaved,\ and\ it's}}
\DoxyCodeLine{00342\ \ \ \textcolor{comment}{//\ all\ we\ need\ anyway.}}
\DoxyCodeLine{00343\ \ \ \textcolor{keywordflow}{if}\ (!WinExec(cmdline,\ 0))\ \{}
\DoxyCodeLine{00344\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00345\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}Unable\ to\ spawn\ process.\(\backslash\)n"{}};}
\DoxyCodeLine{00346\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00347\ \ \ \ \ close\_pipe();}
\DoxyCodeLine{00348\ \ \ \ \ \textcolor{comment}{//\ Don't\ return\ yet,\ since\ we\ still\ need\ to\ clean\ up.}}
\DoxyCodeLine{00349\ \ \ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \textcolor{comment}{//\ Now\ restore\ our\ own\ stdout,\ up\ here\ in\ the\ parent\ process.}}
\DoxyCodeLine{00352\ \ \ \textcolor{keywordflow}{if}\ (!SetStdHandle(STD\_OUTPUT\_HANDLE,\ hSaveStdout))\ \{}
\DoxyCodeLine{00353\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00354\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}Unable\ to\ restore\ stdout\(\backslash\)n"{}};}
\DoxyCodeLine{00355\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00356\ \ \ \}}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ \textcolor{comment}{//\ Close\ the\ write\ end\ of\ the\ pipe\ before\ reading\ from\ the\ read\ end\ of\ the}}
\DoxyCodeLine{00359\ \ \ \textcolor{comment}{//\ pipe.}}
\DoxyCodeLine{00360\ \ \ \textcolor{keywordflow}{if}\ (!CloseHandle(hChildStdoutWr))\ \{}
\DoxyCodeLine{00361\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00362\ \ \ \ \ cerr\ <<\ \textcolor{stringliteral}{"{}Unable\ to\ close\ write\ end\ of\ pipe\(\backslash\)n"{}};}
\DoxyCodeLine{00363\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00364\ \ \ \}}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \textcolor{keywordflow}{return}\ (\_child\_out\ !=\ 0);}
\DoxyCodeLine{00367\ \}}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00372\ \textcolor{keywordtype}{void}\ PipeStreamBuf::}
\DoxyCodeLine{00373\ close\_pipe()\ \{}
\DoxyCodeLine{00374\ \ \ \textcolor{keywordflow}{if}\ (\_child\_out\ !=\ 0)\ \{}
\DoxyCodeLine{00375\ \ \ \ \ CloseHandle(\_child\_out);}
\DoxyCodeLine{00376\ \ \ \ \ \_child\_out\ =\ 0;}
\DoxyCodeLine{00377\ \ \ \}}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00384\ \textcolor{keywordtype}{size\_t}\ PipeStreamBuf::}
\DoxyCodeLine{00385\ write\_pipe(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *data,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{00386\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00387\ \}}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00393\ \textcolor{keywordtype}{size\_t}\ PipeStreamBuf::}
\DoxyCodeLine{00394\ read\_pipe(\textcolor{keywordtype}{char}\ *data,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{00395\ \ \ \textcolor{keywordflow}{if}\ (\_child\_out\ ==\ 0)\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00397\ \ \ \}}
\DoxyCodeLine{00398\ \ \ DWORD\ dwRead;}
\DoxyCodeLine{00399\ \ \ \textcolor{keywordflow}{if}\ (!ReadFile(\_child\_out,\ data,\ len,\ \&dwRead,\ \textcolor{keyword}{nullptr}))\ \{}
\DoxyCodeLine{00400\ \ \ \ \ close\_pipe();}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00402\ \ \ \}}
\DoxyCodeLine{00403\ }
\DoxyCodeLine{00404\ \ \ \textcolor{keywordflow}{return}\ dwRead;}
\DoxyCodeLine{00405\ \}}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ WIN\_PIPE\_CALLS}}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ \_\_EMSCRIPTEN\_\_}}

\end{DoxyCode}
