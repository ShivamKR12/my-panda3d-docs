\doxysection{fisheye\+Lens.\+cxx}
\hypertarget{fisheyeLens_8cxx_source}{}\label{fisheyeLens_8cxx_source}\index{panda/src/distort/fisheyeLens.cxx@{panda/src/distort/fisheyeLens.cxx}}
\mbox{\hyperlink{fisheyeLens_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{fisheyeLens_8h}{fisheyeLens.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{deg__2__rad_8h}{deg\_2\_rad.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ FisheyeLens::\_type\_handle;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{comment}{//\ This\ is\ the\ focal-\/length\ constant\ for\ fisheye\ lenses.\ \ The\ focal\ length\ of}}
\DoxyCodeLine{00020\ \textcolor{comment}{//\ a\ fisheye\ lens\ relates\ to\ its\ fov\ by\ the\ equation:}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{comment}{//\ w\ =\ Fdk}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{comment}{//\ Where\ w\ is\ the\ width\ of\ the\ negative,\ F\ is\ the\ focal\ length,\ and\ d\ is\ the}}
\DoxyCodeLine{00025\ \textcolor{comment}{//\ total\ field\ of\ view\ in\ degrees.}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{comment}{//\ k\ is\ chosen\ to\ make\ the\ focal\ lengths\ for\ a\ fisheye\ lens\ roughly\ correspond}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ to\ the\ equivalent\ field\ of\ view\ for\ a\ conventional,\ perspective\ lens.\ \ It}}
\DoxyCodeLine{00029\ \textcolor{comment}{//\ was\ determined\ empirically\ by\ simple\ examination\ of\ a\ couple\ of\ actual}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ lenses\ for\ 35mm\ film.\ \ I\ don't\ know\ how\ well\ this\ extends\ to\ other\ lenses}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ and\ other\ negative\ sizes.}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ PN\_stdfloat\ fisheye\_k\ =\ 60.0f;}
\DoxyCodeLine{00034\ \textcolor{comment}{//\ focal\_length\ =\ film\_size\ *\ fisheye\_k\ \ fov;}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00040\ PT(\mbox{\hyperlink{classLens}{Lens}})\ FisheyeLens::}
\DoxyCodeLine{00041\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00042\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classFisheyeLens}{FisheyeLens}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00056\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classFisheyeLens_a3493b907f034627b4daa1404285fde34}{FisheyeLens::}}}
\DoxyCodeLine{00057\ \mbox{\hyperlink{classFisheyeLens_a3493b907f034627b4daa1404285fde34}{do\_extrude}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{Lens::CData}}\ *lens\_cdata,}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LPoint3\ \&near\_point,\ LPoint3\ \&far\_point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00059\ \ \ \textcolor{comment}{//\ Undo\ the\ shifting\ from\ film\ offsets,\ etc.\ \ This\ puts\ the\ point\ into\ the}}
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ range\ [-\/film\_size2,\ film\_size2]\ in\ x\ and\ y.}}
\DoxyCodeLine{00061\ \ \ LPoint3\ f\ =\ point2d\ *\ do\_get\_film\_mat\_inv(lens\_cdata);}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \textcolor{comment}{//\ First,\ get\ the\ vector\ from\ the\ center\ of\ the\ film\ to\ the\ point,\ and}}
\DoxyCodeLine{00064\ \ \ \textcolor{comment}{//\ normalize\ it.}}
\DoxyCodeLine{00065\ \ \ LVector2\ v2(f[0],\ f[1]);}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ LPoint3\ v;}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ PN\_stdfloat\ r\ =\ v2.length();}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordflow}{if}\ (r\ ==\ 0.0f)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ Special\ case:\ directly\ forward.}}
\DoxyCodeLine{00072\ \ \ \ \ v.set(0.0f,\ 1.0f,\ 0.0f);}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00075\ \ \ \ \ v2\ /=\ r;}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{comment}{//\ Now\ get\ the\ point\ r\ units\ around\ the\ circle\ in\ the\ YZ\ plane.}}
\DoxyCodeLine{00078\ \ \ \ \ PN\_stdfloat\ focal\_length\ =\ do\_get\_focal\_length(lens\_cdata);}
\DoxyCodeLine{00079\ \ \ \ \ PN\_stdfloat\ angle\ =\ r\ *\ fisheye\_k\ /\ focal\_length;}
\DoxyCodeLine{00080\ \ \ \ \ PN\_stdfloat\ sinAngle,\ cosAngle;}
\DoxyCodeLine{00081\ \ \ \ \ csincos(deg\_2\_rad(angle),\ \&sinAngle,\ \&cosAngle);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ LVector3\ p(0.0,\ cosAngle,\ sinAngle);}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ And\ rotate\ this\ point\ around\ the\ Y\ axis.}}
\DoxyCodeLine{00086\ \ \ \ \ v.set(p[0]*v2[1]\ +\ p[2]*v2[0],}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ p[1],}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ p[2]*v2[1]\ -\/\ p[0]*v2[0]);}
\DoxyCodeLine{00089\ \ \ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \textcolor{comment}{//\ And\ we'll\ need\ to\ account\ for\ the\ lens's\ rotations,\ etc.\ \ at\ the\ end\ of}}
\DoxyCodeLine{00092\ \ \ \textcolor{comment}{//\ the\ day.}}
\DoxyCodeLine{00093\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&lens\_mat\ =\ do\_get\_lens\_mat(lens\_cdata);}
\DoxyCodeLine{00094\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&proj\_inv\_mat\ =\ do\_get\_projection\_mat\_inv(lens\_cdata);}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ near\_point\ =\ (v\ *\ do\_get\_near(lens\_cdata))\ *\ proj\_inv\_mat\ *\ lens\_mat;}
\DoxyCodeLine{00097\ \ \ far\_point\ =\ (v\ *\ do\_get\_far(lens\_cdata))\ *\ proj\_inv\_mat\ *\ lens\_mat;}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00115\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classFisheyeLens_ac5fcd597150cb0260df480c2bf3a84d1}{FisheyeLens::}}}
\DoxyCodeLine{00116\ \mbox{\hyperlink{classFisheyeLens_ac5fcd597150cb0260df480c2bf3a84d1}{do\_extrude\_vec}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{Lens::CData}}\ *lens\_cdata,\ \textcolor{keyword}{const}\ LPoint3\ \&point2d,\ LVector3\ \&vec)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00117\ \ \ LPoint3\ near\_point,\ far\_point;}
\DoxyCodeLine{00118\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classFisheyeLens_a3493b907f034627b4daa1404285fde34}{do\_extrude}}(lens\_cdata,\ point2d,\ near\_point,\ far\_point))\ \{}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ vec\ =\ far\_point\ -\/\ near\_point;}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00125\ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00139\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classFisheyeLens_ac0b5ca695cfadb52e5c41813da99783c}{FisheyeLens::}}}
\DoxyCodeLine{00140\ \mbox{\hyperlink{classFisheyeLens_ac0b5ca695cfadb52e5c41813da99783c}{do\_project}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens_1_1CData}{Lens::CData}}\ *lens\_cdata,\ \textcolor{keyword}{const}\ LPoint3\ \&point3d,\ LPoint3\ \&point2d)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00141\ \ \ \textcolor{comment}{//\ First,\ account\ for\ any\ rotations,\ etc.\ \ on\ the\ lens.}}
\DoxyCodeLine{00142\ \ \ LVector3\ v2\ =\ point3d\ *\ do\_get\_lens\_mat\_inv(lens\_cdata)\ *\ do\_get\_projection\_mat(lens\_cdata);}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ \textcolor{comment}{//\ A\ fisheye\ lens\ projection\ has\ the\ property\ that\ the\ distance\ from\ the}}
\DoxyCodeLine{00145\ \ \ \textcolor{comment}{//\ center\ point\ to\ any\ other\ point\ on\ the\ projection\ is\ proportional\ to\ the}}
\DoxyCodeLine{00146\ \ \ \textcolor{comment}{//\ actual\ distance\ on\ the\ sphere\ along\ the\ great\ circle.\ \ Also,\ the\ angle\ to}}
\DoxyCodeLine{00147\ \ \ \textcolor{comment}{//\ the\ point\ on\ the\ projection\ is\ equal\ to\ the\ angle\ to\ the\ point\ on\ the}}
\DoxyCodeLine{00148\ \ \ \textcolor{comment}{//\ sphere.}}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \textcolor{comment}{//\ First,\ get\ the\ straight-\/line\ distance\ from\ the\ lens,\ and\ use\ it\ to}}
\DoxyCodeLine{00151\ \ \ \textcolor{comment}{//\ normalize\ the\ vector.}}
\DoxyCodeLine{00152\ \ \ PN\_stdfloat\ dist\ =\ v2.length();}
\DoxyCodeLine{00153\ \ \ v2\ /=\ dist;}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \textcolor{comment}{//\ Now,\ project\ the\ point\ into\ the\ XZ\ plane\ and\ measure\ its\ angle\ to\ the\ Z}}
\DoxyCodeLine{00156\ \ \ \textcolor{comment}{//\ axis.\ \ This\ is\ the\ same\ angle\ it\ will\ have\ to\ the\ vertical\ axis\ on\ the}}
\DoxyCodeLine{00157\ \ \ \textcolor{comment}{//\ film.}}
\DoxyCodeLine{00158\ \ \ LVector2\ y(v2[0],\ v2[2]);}
\DoxyCodeLine{00159\ \ \ y.normalize();}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ \textcolor{keywordflow}{if}\ (y\ ==\ LVector2(0.0f,\ 0.0f))\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ Special\ case.\ \ This\ point\ is\ either\ directly\ ahead\ or\ directly\ behind.}}
\DoxyCodeLine{00163\ \ \ \ \ point2d.set(0.0f,\ 0.0f,}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (do\_get\_near(lens\_cdata)\ -\/\ dist)\ /\ (do\_get\_far(lens\_cdata)\ -\/\ do\_get\_near(lens\_cdata)));}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{return}\ v2[1]\ >=\ 0.0f;}
\DoxyCodeLine{00166\ \ \ \}}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \textcolor{comment}{//\ Now\ bring\ the\ vector\ into\ the\ YZ\ plane\ by\ rotating\ about\ the\ Y\ axis.}}
\DoxyCodeLine{00169\ \ \ LVector2\ x(v2[1],\ v2[0]*y[0]+v2[2]*y[1]);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{//\ Now\ the\ angle\ of\ x\ to\ the\ forward\ vector\ represents\ the\ distance\ along}}
\DoxyCodeLine{00172\ \ \ \textcolor{comment}{//\ the\ great\ circle\ to\ the\ point.}}
\DoxyCodeLine{00173\ \ \ PN\_stdfloat\ r\ =\ 90.0f\ -\/\ rad\_2\_deg(catan2(x[0],\ x[1]));}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ PN\_stdfloat\ focal\_length\ =\ do\_get\_focal\_length(lens\_cdata);}
\DoxyCodeLine{00176\ \ \ PN\_stdfloat\ factor\ =\ r\ *\ focal\_length\ /\ fisheye\_k;}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \textcolor{comment}{//\ Compute\ the\ depth\ as\ a\ linear\ distance\ in\ the\ range\ 0\ ..\ 1.}}
\DoxyCodeLine{00179\ \ \ PN\_stdfloat\ z\ =\ (dist\ -\/\ do\_get\_near(lens\_cdata))\ /\ (do\_get\_far(lens\_cdata)\ -\/\ do\_get\_near(lens\_cdata));}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \ \ point2d.set}
\DoxyCodeLine{00182\ \ \ \ \ (y[0]\ *\ factor,}
\DoxyCodeLine{00183\ \ \ \ \ \ y[1]\ *\ factor,}
\DoxyCodeLine{00184\ \ \ \ \ \ \textcolor{comment}{//\ Z\ is\ the\ distance\ scaled\ into\ the\ range\ -\/1\ ..\ 1.}}
\DoxyCodeLine{00185\ \ \ \ \ \ 2.0\ *\ z\ -\/\ 1.0}
\DoxyCodeLine{00186\ \ \ \ \ \ );}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \textcolor{comment}{//\ Now\ we\ have\ to\ transform\ the\ point\ according\ to\ the\ film\ adjustments.}}
\DoxyCodeLine{00189\ \ \ point2d\ =\ point2d\ *\ do\_get\_film\_mat(lens\_cdata);}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{00192\ \ \ \ \ point2d[0]\ >=\ -\/1.0f\ \&\&\ point2d[0]\ <=\ 1.0f\ \&\&}
\DoxyCodeLine{00193\ \ \ \ \ point2d[1]\ >=\ -\/1.0f\ \&\&\ point2d[1]\ <=\ 1.0f;}
\DoxyCodeLine{00194\ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00202\ PN\_stdfloat\ \mbox{\hyperlink{classFisheyeLens_a8fdad297cac9328d45b912b5b8c7c27d}{FisheyeLens::}}}
\DoxyCodeLine{00203\ \mbox{\hyperlink{classFisheyeLens_a8fdad297cac9328d45b912b5b8c7c27d}{fov\_to\_film}}(PN\_stdfloat\ fov,\ PN\_stdfloat\ focal\_length,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00204\ \ \ \textcolor{keywordflow}{return}\ focal\_length\ *\ fov\ /\ fisheye\_k;}
\DoxyCodeLine{00205\ \}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00213\ PN\_stdfloat\ \mbox{\hyperlink{classFisheyeLens_a9036a2f8a8d71edef3cb82027f33a71a}{FisheyeLens::}}}
\DoxyCodeLine{00214\ \mbox{\hyperlink{classFisheyeLens_a9036a2f8a8d71edef3cb82027f33a71a}{fov\_to\_focal\_length}}(PN\_stdfloat\ fov,\ PN\_stdfloat\ film\_size,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00215\ \ \ \textcolor{keywordflow}{return}\ film\_size\ *\ fisheye\_k\ /\ fov;}
\DoxyCodeLine{00216\ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00224\ PN\_stdfloat\ \mbox{\hyperlink{classFisheyeLens_ace372895fab3a2f392894cdb13a091b5}{FisheyeLens::}}}
\DoxyCodeLine{00225\ \mbox{\hyperlink{classFisheyeLens_ace372895fab3a2f392894cdb13a091b5}{film\_to\_fov}}(PN\_stdfloat\ film\_size,\ PN\_stdfloat\ focal\_length,\ \textcolor{keywordtype}{bool})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00226\ \ \ \textcolor{keywordflow}{return}\ film\_size\ *\ fisheye\_k\ /\ focal\_length;}
\DoxyCodeLine{00227\ \}}

\end{DoxyCode}
