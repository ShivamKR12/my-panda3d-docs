\doxysection{python\+Texture\+Pool\+Filter.\+cxx}
\hypertarget{pythonTexturePoolFilter_8cxx_source}{}\label{pythonTexturePoolFilter_8cxx_source}\index{panda/src/gobj/pythonTexturePoolFilter.cxx@{panda/src/gobj/pythonTexturePoolFilter.cxx}}
\mbox{\hyperlink{pythonTexturePoolFilter_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pythonTexturePoolFilter_8h}{pythonTexturePoolFilter.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ HAVE\_PYTHON}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pythonThread_8h}{pythonThread.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}py\_panda.h"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_Filename;}
\DoxyCodeLine{00022\ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_LoaderOptions;}
\DoxyCodeLine{00023\ \textcolor{keyword}{extern}\ \textcolor{keyword}{struct\ }Dtool\_PyTypedObject\ Dtool\_Texture;}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PythonTexturePoolFilter::\_type\_handle;}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00030\ PythonTexturePoolFilter::}
\DoxyCodeLine{00031\ PythonTexturePoolFilter()\ \{}
\DoxyCodeLine{00032\ \ \ init\_type();}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00038\ PythonTexturePoolFilter::}
\DoxyCodeLine{00039\ \string~PythonTexturePoolFilter()\ \{}
\DoxyCodeLine{00040\ \ \ \textcolor{keywordflow}{if}\ (\_pre\_load\_func\ !=\ \textcolor{keyword}{nullptr}\ ||\ \_post\_load\_func\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00042\ \ \ \ \ PyGILState\_STATE\ gstate;}
\DoxyCodeLine{00043\ \ \ \ \ gstate\ =\ PyGILState\_Ensure();}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ \ \ Py\_CLEAR(\_entry\_point);}
\DoxyCodeLine{00047\ \ \ \ \ Py\_CLEAR(\_pre\_load\_func);}
\DoxyCodeLine{00048\ \ \ \ \ Py\_CLEAR(\_post\_load\_func);}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00051\ \ \ \ \ PyGILState\_Release(gstate);}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00053\ \ \ \}}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00062\ \textcolor{keywordtype}{bool}\ PythonTexturePoolFilter::}
\DoxyCodeLine{00063\ init(PyObject\ *tex\_filter)\ \{}
\DoxyCodeLine{00064\ \ \ nassertr(tex\_filter\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00065\ \ \ nassertr(\_entry\_point\ ==\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00066\ \ \ nassertr(\_pre\_load\_func\ ==\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00067\ \ \ nassertr(\_post\_load\_func\ ==\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \_pre\_load\_func\ =\ PyObject\_GetAttrString(tex\_filter,\ \textcolor{stringliteral}{"{}pre\_load"{}});}
\DoxyCodeLine{00070\ \ \ PyErr\_Clear();}
\DoxyCodeLine{00071\ \ \ \_post\_load\_func\ =\ PyObject\_GetAttrString(tex\_filter,\ \textcolor{stringliteral}{"{}post\_load"{}});}
\DoxyCodeLine{00072\ \ \ PyErr\_Clear();}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (\_pre\_load\_func\ ==\ \textcolor{keyword}{nullptr}\ \&\&\ \_post\_load\_func\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00075\ \ \ \ \ PyErr\_Format(PyExc\_TypeError,}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}texture\ pool\ filter\ plug-\/in\ \%R\ does\ not\ define\ pre\_load\ or\ post\_load\ function"{}},}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tex\_filter);}
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00079\ \ \ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \_entry\_point\ =\ Py\_NewRef(tex\_filter);}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00083\ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00090\ PT(\mbox{\hyperlink{classTexture}{Texture}})\ PythonTexturePoolFilter::}
\DoxyCodeLine{00091\ pre\_load(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_alpha\_filename,}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,\ \textcolor{keywordtype}{int}\ alpha\_file\_channel,}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options)\ \{}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{if}\ (\_pre\_load\_func\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00096\ \ \ \}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00099\ \ \ PyGILState\_STATE\ gstate;}
\DoxyCodeLine{00100\ \ \ gstate\ =\ PyGILState\_Ensure();}
\DoxyCodeLine{00101\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{comment}{//\ Wrap\ the\ arguments.}}
\DoxyCodeLine{00104\ \ \ PyObject\ *args\ =\ Py\_BuildValue(\textcolor{stringliteral}{"{}(OOiiNO)"{}},}
\DoxyCodeLine{00105\ \ \ \ \ DTool\_CreatePyInstance((\textcolor{keywordtype}{void}\ *)\&orig\_filename,\ Dtool\_Filename,\ \textcolor{keyword}{false},\ \textcolor{keyword}{true}),}
\DoxyCodeLine{00106\ \ \ \ \ DTool\_CreatePyInstance((\textcolor{keywordtype}{void}\ *)\&orig\_alpha\_filename,\ Dtool\_Filename,\ \textcolor{keyword}{false},\ \textcolor{keyword}{true}),}
\DoxyCodeLine{00107\ \ \ \ \ primary\_file\_num\_channels,}
\DoxyCodeLine{00108\ \ \ \ \ alpha\_file\_channel,}
\DoxyCodeLine{00109\ \ \ \ \ PyBool\_FromLong(read\_mipmaps),}
\DoxyCodeLine{00110\ \ \ \ \ DTool\_CreatePyInstance((\textcolor{keywordtype}{void}\ *)\&options,\ Dtool\_LoaderOptions,\ \textcolor{keyword}{false},\ \textcolor{keyword}{true})}
\DoxyCodeLine{00111\ \ \ );}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ PyObject\ *result\ =\ PythonThread::call\_python\_func(\_pre\_load\_func,\ args);}
\DoxyCodeLine{00114\ \ \ Py\_DECREF(args);}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ Py\_None)\ \{}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (DtoolInstance\_Check(result))\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ tex\ =\ (\mbox{\hyperlink{classTexture}{Texture}}\ *)DtoolInstance\_UPCAST(result,\ Dtool\_Texture);}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Preloading\ "{}}\ <<\ orig\_filename.get\_basename()\ <<\ \textcolor{stringliteral}{"{}\ failed\ as\ "{}}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}preloaded\ texture\ is\ not\ of\ Texture\ type.\(\backslash\)n"{}};}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \ \ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \ \ Py\_DECREF(result);}
\DoxyCodeLine{00131\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00132\ \ \ \ \ PyObject\ *exc\_type\ =\ PyErr\_Occurred();}
\DoxyCodeLine{00133\ \ \ \ \ nassertr(exc\_type\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00136\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Preloading\ "{}}\ <<\ orig\_filename.get\_basename()\ <<\ \textcolor{stringliteral}{"{}\ failed\ with\ "{}}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ <<\ ((PyTypeObject\ *)exc\_type)-\/>tp\_name\ <<\ \textcolor{stringliteral}{"{}\ exception.\(\backslash\)n"{}};}
\DoxyCodeLine{00138\ \ \ \ \ PyErr\_Clear();}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00142\ \ \ PyGILState\_Release(gstate);}
\DoxyCodeLine{00143\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00146\ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00153\ PT(\mbox{\hyperlink{classTexture}{Texture}})\ PythonTexturePoolFilter::}
\DoxyCodeLine{00154\ post\_load(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ \{}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{if}\ (\_post\_load\_func\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00160\ \ \ PyGILState\_STATE\ gstate;}
\DoxyCodeLine{00161\ \ \ gstate\ =\ PyGILState\_Ensure();}
\DoxyCodeLine{00162\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \textcolor{comment}{//\ Wrap\ the\ arguments.}}
\DoxyCodeLine{00165\ \ \ PyObject\ *args\ =\ PyTuple\_Pack(1,}
\DoxyCodeLine{00166\ \ \ \ \ DTool\_CreatePyInstance(tex,\ Dtool\_Texture,\ \textcolor{keyword}{true},\ \textcolor{keyword}{false})}
\DoxyCodeLine{00167\ \ \ );}
\DoxyCodeLine{00168\ \ \ PyObject\ *result\ =\ PythonThread::call\_python\_func(\_post\_load\_func,\ args);}
\DoxyCodeLine{00169\ \ \ Py\_DECREF(args);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ result\_tex;}
\DoxyCodeLine{00172\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ Py\_None)\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ the\ call\ returned\ a\ texture\ pointer.}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (DtoolInstance\_Check(result))\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ result\_tex\ =\ (\mbox{\hyperlink{classTexture}{Texture}}\ *)DtoolInstance\_UPCAST(result,\ Dtool\_Texture);}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result\_tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ valid\ texture\ was\ returned,\ use\ the\ original\ pointer.}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Postloading\ failed\ as\ the\ returned\ texture\ is\ not\ of\ the\ Texture\ type.\(\backslash\)n"{}};}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ result\_tex\ =\ tex;}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00185\ \ \ \ \ \}}
\DoxyCodeLine{00186\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00187\ \ \ \ \ PyObject\ *exc\_type\ =\ PyErr\_Occurred();}
\DoxyCodeLine{00188\ \ \ \ \ nassertr(exc\_type\ !=\ \textcolor{keyword}{nullptr},\ result\_tex);}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00191\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Postloading\ texture\ failed\ with\ "{}}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ <<\ ((PyTypeObject\ *)exc\_type)-\/>tp\_name\ <<\ \textcolor{stringliteral}{"{}\ exception.\(\backslash\)n"{}};}
\DoxyCodeLine{00193\ \ \ \ \ PyErr\_Clear();}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \ \ result\_tex\ =\ tex;}
\DoxyCodeLine{00196\ \ \ \}}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00199\ \ \ PyGILState\_Release(gstate);}
\DoxyCodeLine{00200\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{return}\ result\_tex;}
\DoxyCodeLine{00203\ \}}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_PYTHON}}

\end{DoxyCode}
