\doxysection{td\+\_\+light.\+cxx}
\hypertarget{td__light_8cxx_source}{}\label{td__light_8cxx_source}\index{panda/src/tinydisplay/td\_light.cxx@{panda/src/tinydisplay/td\_light.cxx}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}zgl.h"{}}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{math_8h}{math.h}}>}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ PN\_stdfloat\ clampf(PN\_stdfloat\ a,PN\_stdfloat\ min,PN\_stdfloat\ max)}
\DoxyCodeLine{00005\ \{}
\DoxyCodeLine{00006\ \ \ \textcolor{keywordflow}{if}\ (a<min)\ \textcolor{keywordflow}{return}\ min;}
\DoxyCodeLine{00007\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (a>max)\ \textcolor{keywordflow}{return}\ max;}
\DoxyCodeLine{00008\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{return}\ a;}
\DoxyCodeLine{00009\ \}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{comment}{/*\ non\ optimized\ lighting\ model\ */}}
\DoxyCodeLine{00012\ \textcolor{keywordtype}{void}\ gl\_shade\_vertex(\mbox{\hyperlink{structGLContext}{GLContext}}\ *c,\mbox{\hyperlink{structGLVertex}{GLVertex}}\ *v)}
\DoxyCodeLine{00013\ \{}
\DoxyCodeLine{00014\ \ \ PN\_stdfloat\ R,G,B,A;}
\DoxyCodeLine{00015\ \ \ \mbox{\hyperlink{structGLMaterial}{GLMaterial}}\ *m;}
\DoxyCodeLine{00016\ \ \ \mbox{\hyperlink{structGLLight}{GLLight}}\ *l;}
\DoxyCodeLine{00017\ \ \ \mbox{\hyperlink{structV3}{V3}}\ n,s,d;}
\DoxyCodeLine{00018\ \ \ PN\_stdfloat\ dist,tmp,att,dot,dot\_spot,dot\_spec;}
\DoxyCodeLine{00019\ \ \ \textcolor{keywordtype}{int}\ twoside\ =\ c-\/>light\_model\_two\_side;}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \ \ m=\&c-\/>materials[0];}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \ \ n.v[0]=v-\/>normal.v[0];}
\DoxyCodeLine{00024\ \ \ n.v[1]=v-\/>normal.v[1];}
\DoxyCodeLine{00025\ \ \ n.v[2]=v-\/>normal.v[2];}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \ \ R=m-\/>emission.v[0]+m-\/>ambient.v[0]*c-\/>ambient\_light\_model.v[0];}
\DoxyCodeLine{00028\ \ \ G=m-\/>emission.v[1]+m-\/>ambient.v[1]*c-\/>ambient\_light\_model.v[1];}
\DoxyCodeLine{00029\ \ \ B=m-\/>emission.v[2]+m-\/>ambient.v[2]*c-\/>ambient\_light\_model.v[2];}
\DoxyCodeLine{00030\ \ \ A=clampf(m-\/>diffuse.v[3],0,1);}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \ \ \textcolor{keywordflow}{for}(l=c-\/>first\_light;l!=\textcolor{keyword}{nullptr};l=l-\/>next)\ \{}
\DoxyCodeLine{00033\ \ \ \ \ PN\_stdfloat\ lR,lB,lG;}
\DoxyCodeLine{00034\ \ \ \ \ }
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{comment}{/*\ ambient\ */}}
\DoxyCodeLine{00036\ \ \ \ \ lR=l-\/>ambient.v[0]\ *\ m-\/>ambient.v[0];}
\DoxyCodeLine{00037\ \ \ \ \ lG=l-\/>ambient.v[1]\ *\ m-\/>ambient.v[1];}
\DoxyCodeLine{00038\ \ \ \ \ lB=l-\/>ambient.v[2]\ *\ m-\/>ambient.v[2];}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keywordflow}{if}\ (l-\/>position.v[3]\ ==\ 0)\ \{}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \textcolor{comment}{/*\ light\ at\ infinity\ */}}
\DoxyCodeLine{00042\ \ \ \ \ \ \ d.v[0]=l-\/>position.v[0];}
\DoxyCodeLine{00043\ \ \ \ \ \ \ d.v[1]=l-\/>position.v[1];}
\DoxyCodeLine{00044\ \ \ \ \ \ \ d.v[2]=l-\/>position.v[2];}
\DoxyCodeLine{00045\ \ \ \ \ \ \ att=1;}
\DoxyCodeLine{00046\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \textcolor{comment}{/*\ distance\ attenuation\ */}}
\DoxyCodeLine{00048\ \ \ \ \ \ \ d.v[0]=l-\/>position.v[0]-\/v-\/>ec.v[0];}
\DoxyCodeLine{00049\ \ \ \ \ \ \ d.v[1]=l-\/>position.v[1]-\/v-\/>ec.v[1];}
\DoxyCodeLine{00050\ \ \ \ \ \ \ d.v[2]=l-\/>position.v[2]-\/v-\/>ec.v[2];}
\DoxyCodeLine{00051\ \ \ \ \ \ \ dist\ =\ sqrtf(d.v[0]*d.v[0]+d.v[1]*d.v[1]+d.v[2]*d.v[2]);}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dist>1E-\/3)\ \{}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ tmp=1/dist;}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ d.v[0]*=tmp;}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ d.v[1]*=tmp;}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ d.v[2]*=tmp;}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00058\ \ \ \ \ \ \ att=1.0f/(l-\/>attenuation[0]+dist*(l-\/>attenuation[1]+}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ dist*l-\/>attenuation[2]));}
\DoxyCodeLine{00060\ \ \ \ \ \}}
\DoxyCodeLine{00061\ \ \ \ \ dot=d.v[0]*n.v[0]+d.v[1]*n.v[1]+d.v[2]*n.v[2];}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{if}\ (twoside\ \&\&\ dot\ <\ 0)\ dot\ =\ -\/dot;}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordflow}{if}\ (dot>0)\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \textcolor{comment}{/*\ diffuse\ light\ */}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ lR+=dot\ *\ l-\/>diffuse.v[0]\ *\ m-\/>diffuse.v[0];}
\DoxyCodeLine{00066\ \ \ \ \ \ \ lG+=dot\ *\ l-\/>diffuse.v[1]\ *\ m-\/>diffuse.v[1];}
\DoxyCodeLine{00067\ \ \ \ \ \ \ lB+=dot\ *\ l-\/>diffuse.v[2]\ *\ m-\/>diffuse.v[2];}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \ \ \textcolor{comment}{/*\ spot\ light\ */}}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (l-\/>spot\_cutoff\ !=\ 180)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ dot\_spot=-\/(d.v[0]*l-\/>norm\_spot\_direction.v[0]+}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ d.v[1]*l-\/>norm\_spot\_direction.v[1]+}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ d.v[2]*l-\/>norm\_spot\_direction.v[2]);}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (twoside\ \&\&\ dot\_spot\ <\ 0)\ dot\_spot\ =\ -\/dot\_spot;}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dot\_spot\ <\ l-\/>cos\_spot\_cutoff)\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ no\ contribution\ */}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ TODO:\ optimize\ */}}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (l-\/>spot\_exponent\ >\ 0)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ att=att*pow(dot\_spot,l-\/>spot\_exponent);}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \ \ \textcolor{comment}{/*\ specular\ light\ */}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ }
\DoxyCodeLine{00088\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c-\/>local\_light\_model)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structV3}{V3}}\ vcoord;}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ vcoord.v[0]=v-\/>ec.v[0];}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ vcoord.v[1]=v-\/>ec.v[1];}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ vcoord.v[2]=v-\/>ec.v[2];}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ gl\_V3\_Norm(\&vcoord);}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ s.v[0]=d.v[0]-\/vcoord.v[0];}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ s.v[1]=d.v[1]-\/vcoord.v[0];}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ s.v[2]=d.v[2]-\/vcoord.v[0];}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ s.v[0]=d.v[0];}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ s.v[1]=d.v[1];}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ s.v[2]=d.v[2]+1.0f;}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ dot\_spec=n.v[0]*s.v[0]+n.v[1]*s.v[1]+n.v[2]*s.v[2];}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (twoside\ \&\&\ dot\_spec\ <\ 0)\ dot\_spec\ =\ -\/dot\_spec;}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dot\_spec>0)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structGLSpecBuf}{GLSpecBuf}}\ *specbuf;}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ idx;}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ tmp=sqrt(s.v[0]*s.v[0]+s.v[1]*s.v[1]+s.v[2]*s.v[2]);}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tmp\ >\ 1E-\/3)\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ dot\_spec=dot\_spec\ /\ tmp;}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ TODO:\ optimize\ */}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ testing\ specular\ buffer\ code\ */}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ dot\_spec=\ pow(dot\_spec,m-\/>shininess);*/}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ specbuf\ =\ specbuf\_get\_buffer(c,\ m-\/>shininess\_i,\ m-\/>shininess);}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ idx\ =\ (int)(dot\_spec*SPECULAR\_BUFFER\_SIZE);}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (idx\ >\ SPECULAR\_BUFFER\_SIZE)\ idx\ =\ SPECULAR\_BUFFER\_SIZE;}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ dot\_spec\ =\ specbuf-\/>buf[idx];}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ lR+=dot\_spec\ *\ l-\/>specular.v[0]\ *\ m-\/>specular.v[0];}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ lG+=dot\_spec\ *\ l-\/>specular.v[1]\ *\ m-\/>specular.v[1];}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ lB+=dot\_spec\ *\ l-\/>specular.v[2]\ *\ m-\/>specular.v[2];}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00123\ \ \ \ \ \}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ R+=att\ *\ lR;}
\DoxyCodeLine{00126\ \ \ \ \ G+=att\ *\ lG;}
\DoxyCodeLine{00127\ \ \ \ \ B+=att\ *\ lB;}
\DoxyCodeLine{00128\ \ \ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ v-\/>color.v[0]=clampf(R,0,1);}
\DoxyCodeLine{00131\ \ \ v-\/>color.v[1]=clampf(G,0,1);}
\DoxyCodeLine{00132\ \ \ v-\/>color.v[2]=clampf(B,0,1);}
\DoxyCodeLine{00133\ \ \ v-\/>color.v[3]=clampf(A,0,1);}
\DoxyCodeLine{00134\ \ \ \textcolor{comment}{//v-\/>color.v[0]=clampf(R*v-\/>color.v[0],0,1);}}
\DoxyCodeLine{00135\ \ \ \textcolor{comment}{//v-\/>color.v[1]=clampf(G*v-\/>color.v[1],0,1);}}
\DoxyCodeLine{00136\ \ \ \textcolor{comment}{//v-\/>color.v[2]=clampf(B*v-\/>color.v[2],0,1);}}
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//v-\/>color.v[3]=clampf(A*v-\/>color.v[3],0,1);}}
\DoxyCodeLine{00138\ \}}
\DoxyCodeLine{00139\ }

\end{DoxyCode}
