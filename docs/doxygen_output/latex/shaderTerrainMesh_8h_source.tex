\doxysection{shader\+Terrain\+Mesh.\+h}
\hypertarget{shaderTerrainMesh_8h_source}{}\label{shaderTerrainMesh_8h_source}\index{panda/src/grutil/shaderTerrainMesh.h@{panda/src/grutil/shaderTerrainMesh.h}}
\mbox{\hyperlink{shaderTerrainMesh_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#ifndef\ SHADER\_TERRAIN\_MESH\_H}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#define\ SHADER\_TERRAIN\_MESH\_H}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pandabase_8h}{pandabase.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{luse_8h}{luse.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmImage_8h}{pnmImage.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pandaNode_8h}{pandaNode.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texture_8h}{texture.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texturePeeker_8h}{texturePeeker.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{configVariableBool_8h}{configVariableBool.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{configVariableInt_8h}{configVariableInt.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatCollector_8h}{pStatCollector.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{filename_8h}{filename.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pmutex_8h}{pmutex.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mutexHolder_8h}{mutexHolder.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{stdint_8h}{stdint.h}}>}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{classConfigVariableBool}{ConfigVariableBool}}\ stm\_use\_hexagonal\_layout;}
\DoxyCodeLine{00033\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{classConfigVariableInt}{ConfigVariableInt}}\ stm\_max\_chunk\_count;}
\DoxyCodeLine{00034\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{classConfigVariableInt}{ConfigVariableInt}}\ stm\_max\_views;}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ NotifyCategoryDecl(shader\_terrain,\ EXPCL\_PANDA\_GRUTIL,\ EXPTP\_PANDA\_GRUTIL);}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00054\ \textcolor{keyword}{class\ }EXPCL\_PANDA\_GRUTIL\ \mbox{\hyperlink{classShaderTerrainMesh}{ShaderTerrainMesh}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ \{}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ PUBLISHED:}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \mbox{\hyperlink{classShaderTerrainMesh}{ShaderTerrainMesh}}();}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ INLINE\ \textcolor{keywordtype}{void}\ set\_heightfield(\mbox{\hyperlink{classTexture}{Texture}}*\ heightfield);}
\DoxyCodeLine{00061\ \ \ INLINE\ \mbox{\hyperlink{classTexture}{Texture}}*\ get\_heightfield()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00062\ \ \ MAKE\_PROPERTY(heightfield,\ get\_heightfield,\ set\_heightfield);}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ INLINE\ \textcolor{keywordtype}{void}\ set\_chunk\_size(\textcolor{keywordtype}{size\_t}\ chunk\_size);}
\DoxyCodeLine{00065\ \ \ INLINE\ \textcolor{keywordtype}{size\_t}\ get\_chunk\_size()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00066\ \ \ MAKE\_PROPERTY(chunk\_size,\ get\_chunk\_size,\ set\_chunk\_size);}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ INLINE\ \textcolor{keywordtype}{void}\ set\_generate\_patches(\textcolor{keywordtype}{bool}\ generate\_patches);}
\DoxyCodeLine{00069\ \ \ INLINE\ \textcolor{keywordtype}{bool}\ get\_generate\_patches()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00070\ \ \ MAKE\_PROPERTY(generate\_patches,\ get\_generate\_patches,\ set\_generate\_patches);}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ INLINE\ \textcolor{keywordtype}{void}\ set\_update\_enabled(\textcolor{keywordtype}{bool}\ update\_enabled);}
\DoxyCodeLine{00073\ \ \ INLINE\ \textcolor{keywordtype}{bool}\ get\_update\_enabled()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00074\ \ \ MAKE\_PROPERTY(update\_enabled,\ get\_update\_enabled,\ set\_update\_enabled);}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ INLINE\ \textcolor{keywordtype}{void}\ set\_target\_triangle\_width(PN\_stdfloat\ target\_triangle\_width);}
\DoxyCodeLine{00077\ \ \ INLINE\ PN\_stdfloat\ get\_target\_triangle\_width()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00078\ \ \ MAKE\_PROPERTY(target\_triangle\_width,\ get\_target\_triangle\_width,\ set\_target\_triangle\_width);}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ LPoint3\ uv\_to\_world(\textcolor{keyword}{const}\ LTexCoord\&\ coord)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00081\ \ \ INLINE\ LPoint3\ uv\_to\_world(PN\_stdfloat\ u,\ PN\_stdfloat\ v)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \textcolor{keywordtype}{bool}\ generate();}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \textcolor{comment}{//\ Methods\ derived\ from\ PandaNode}}
\DoxyCodeLine{00088\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_afda3fef14d2f8b91310bcc5ecd0a54a3}{safe\_to\_flatten}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00089\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a2453a75c816eb34071dd72c1f194c610}{safe\_to\_combine}}()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00090\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ad3427554990bacc142d67e947334226d}{add\_for\_draw}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data);}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00093\ \ \ \textcolor{keyword}{virtual}\ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})}
\DoxyCodeLine{00094\ \ \ \ \ calc\_tight\_bounds(LPoint3\ \&min\_point,\ LPoint3\ \&max\_point,}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \&found\_any,}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread())\ \textcolor{keyword}{const};}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a52afb8d49a98320b7975ebbbc7f18d6d}{compute\_internal\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&internal\_bounds,}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \&internal\_vertices,}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ Chunk\ data}}
\DoxyCodeLine{00105\ \ \ \textcolor{keyword}{struct\ }Chunk\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classMemoryBase}{MemoryBase}}\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{comment}{//\ Depth,\ starting\ at\ 0}}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ depth;}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{comment}{//\ Chunk\ position\ in\ heightfield\ space}}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ x,\ y;}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{comment}{//\ Chunk\ size\ in\ heightfield\ space}}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ size;}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{comment}{//\ Children,\ in\ the\ order\ (0,\ 0)\ (1,\ 0)\ (0,\ 1)\ (1,\ 1)}}
\DoxyCodeLine{00116\ \ \ \ \ Chunk*\ children[4];}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{comment}{//\ Edge\ heights,\ used\ for\ lod\ computation,\ in\ the\ same\ order\ as\ the\ children}}
\DoxyCodeLine{00119\ \ \ \ \ LVector4\ edges;}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{comment}{//\ Chunk\ heights,\ used\ for\ culling}}
\DoxyCodeLine{00122\ \ \ \ \ PN\_stdfloat\ avg\_height,\ min\_height,\ max\_height;}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ Last\ CLOD\ factor,\ stored\ while\ computing\ LOD,\ used\ for\ seamless\ transitions\ between\ lods}}
\DoxyCodeLine{00125\ \ \ \ \ PN\_stdfloat\ last\_clod;}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ INLINE\ \textcolor{keywordtype}{void}\ clear\_children();}
\DoxyCodeLine{00128\ \ \ \ \ INLINE\ Chunk();}
\DoxyCodeLine{00129\ \ \ \ \ INLINE\ \string~Chunk();}
\DoxyCodeLine{00130\ \ \ \};}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{comment}{//\ Single\ entry\ in\ the\ data\ block}}
\DoxyCodeLine{00134\ \ \ \textcolor{keyword}{struct\ }ChunkDataEntry\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{//\ float\ x,\ y,\ size,\ clod;}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{comment}{//\ Panda\ uses\ BGRA,\ the\ above\ layout\ shows\ how\ its\ actually\ in\ texture\ memory,}}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{comment}{//\ the\ layout\ below\ makes\ it\ work\ with\ BGRA.}}
\DoxyCodeLine{00139\ \ \ \ \ PN\_float32\ size,\ y,\ x,\ clod;}
\DoxyCodeLine{00140\ \ \ \};}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \textcolor{comment}{//\ Data\ used\ while\ traversing\ all\ chunks}}
\DoxyCodeLine{00143\ \ \ \textcolor{keyword}{struct\ }TraversalData\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ Global\ MVP\ used\ for\ LOD}}
\DoxyCodeLine{00145\ \ \ \ \ LMatrix4\ mvp\_mat;}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{comment}{//\ Local\ model\ matrix\ used\ for\ culling}}
\DoxyCodeLine{00148\ \ \ \ \ LMatrix4\ model\_mat;}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ Camera\ bounds\ in\ world\ space}}
\DoxyCodeLine{00151\ \ \ \ \ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}*\ cam\_bounds;}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{comment}{//\ Amount\ of\ emitted\ chunks\ so\ far}}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordtype}{int}\ emitted\_chunks;}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{comment}{//\ Screen\ resolution,\ used\ for\ LOD}}
\DoxyCodeLine{00157\ \ \ \ \ LVector2i\ screen\_size;}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ Pointer\ to\ the\ texture\ memory,\ where\ each\ chunk\ is\ written\ to}}
\DoxyCodeLine{00160\ \ \ \ \ ChunkDataEntry*\ storage\_ptr;}
\DoxyCodeLine{00161\ \ \ \};}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \ \ \textcolor{keywordtype}{bool}\ do\_check\_heightfield();}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordtype}{void}\ do\_extract\_heightfield();}
\DoxyCodeLine{00165\ \ \ \textcolor{keywordtype}{void}\ do\_init\_data\_texture();}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordtype}{void}\ do\_create\_chunks();}
\DoxyCodeLine{00167\ \ \ \textcolor{keywordtype}{void}\ do\_init\_chunk(Chunk*\ chunk);}
\DoxyCodeLine{00168\ \ \ \textcolor{keywordtype}{void}\ do\_compute\_bounds(Chunk*\ chunk);}
\DoxyCodeLine{00169\ \ \ \textcolor{keywordtype}{void}\ do\_create\_chunk\_geom();}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordtype}{void}\ do\_traverse(Chunk*\ chunk,\ TraversalData*\ data,\ \textcolor{keywordtype}{bool}\ fully\_visible\ =\ \textcolor{keyword}{false});}
\DoxyCodeLine{00171\ \ \ \textcolor{keywordtype}{void}\ do\_emit\_chunk(Chunk*\ chunk,\ TraversalData*\ data);}
\DoxyCodeLine{00172\ \ \ \textcolor{keywordtype}{bool}\ do\_check\_lod\_matches(Chunk*\ chunk,\ TraversalData*\ data);}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \mbox{\hyperlink{classMutex}{Mutex}}\ \_lock;}
\DoxyCodeLine{00175\ \ \ Chunk\ \_base\_chunk;}
\DoxyCodeLine{00176\ \ \ \textcolor{keywordtype}{size\_t}\ \_size;}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordtype}{size\_t}\ \_chunk\_size;}
\DoxyCodeLine{00178\ \ \ \textcolor{keywordtype}{bool}\ \_generate\_patches;}
\DoxyCodeLine{00179\ \ \ \mbox{\hyperlink{classPNMImage}{PNMImage}}\ \_heightfield;}
\DoxyCodeLine{00180\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ \_heightfield\_tex;}
\DoxyCodeLine{00181\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ \_chunk\_geom;}
\DoxyCodeLine{00182\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ \_data\_texture;}
\DoxyCodeLine{00183\ \ \ \textcolor{keywordtype}{size\_t}\ \_current\_view\_index;}
\DoxyCodeLine{00184\ \ \ \textcolor{keywordtype}{int}\ \_last\_frame\_count;}
\DoxyCodeLine{00185\ \ \ PN\_stdfloat\ \_target\_triangle\_width;}
\DoxyCodeLine{00186\ \ \ \textcolor{keywordtype}{bool}\ \_update\_enabled;}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \textcolor{comment}{//\ PStats\ stuff}}
\DoxyCodeLine{00189\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \_lod\_collector;}
\DoxyCodeLine{00190\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \_basic\_collector;}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \textcolor{comment}{//\ Type\ handle\ stuff}}
\DoxyCodeLine{00194\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00195\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_class\_type()\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{keywordflow}{return}\ \_type\_handle;}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ init\_type()\ \{}
\DoxyCodeLine{00199\ \ \ \ \ PandaNode::init\_type();}
\DoxyCodeLine{00200\ \ \ \ \ \mbox{\hyperlink{register__type_8h_a54fc7cae2908ec9e8da7174a8d027735}{register\_type}}(\_type\_handle,\ \textcolor{stringliteral}{"{}ShaderTerrainMesh"{}},\ PandaNode::get\_class\_type());}
\DoxyCodeLine{00201\ \ \ \}}
\DoxyCodeLine{00202\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ get\_type()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{return}\ get\_class\_type();}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ \ \ \textcolor{keyword}{virtual}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ force\_init\_type()\ \{init\_type();\ \textcolor{keywordflow}{return}\ get\_class\_type();\}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00208\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ \_type\_handle;}
\DoxyCodeLine{00209\ \};}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \textcolor{preprocessor}{\#include\ "{}shaderTerrainMesh.I"{}}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ SHADER\_TERRAIN\_MESH\_H}}

\end{DoxyCode}
