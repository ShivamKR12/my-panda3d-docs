\doxysection{x\+File\+Maker.\+cxx}
\hypertarget{xFileMaker_8cxx_source}{}\label{xFileMaker_8cxx_source}\index{pandatool/src/xfileegg/xFileMaker.cxx@{pandatool/src/xfileegg/xFileMaker.cxx}}
\mbox{\hyperlink{xFileMaker_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFileMaker_8h}{xFileMaker.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFileMesh_8h}{xFileMesh.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xFileMaterial_8h}{xFileMaterial.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__xfile_8h}{config\_xfile.h}}"{}}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnotify_8h}{pnotify.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggGroupNode_8h}{eggGroupNode.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggGroup_8h}{eggGroup.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggBin_8h}{eggBin.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggPolysetMaker_8h}{eggPolysetMaker.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggVertexPool_8h}{eggVertexPool.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggVertex_8h}{eggVertex.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggPolygon_8h}{eggPolygon.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{eggData_8h}{eggData.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pvector_8h}{pvector.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vector__int_8h}{vector\_int.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{string__utils_8h}{string\_utils.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00036\ XFileMaker::}
\DoxyCodeLine{00037\ XFileMaker()\ \{}
\DoxyCodeLine{00038\ \ \ \_mesh\_index\ =\ 0;}
\DoxyCodeLine{00039\ \ \ \_x\_file\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classXFile}{XFile}};}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00045\ XFileMaker::}
\DoxyCodeLine{00046\ \string~XFileMaker()\ \{}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00053\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFileMaker_a2e203c544f45c9a05571091eb6722cf6}{XFileMaker::}}}
\DoxyCodeLine{00054\ \mbox{\hyperlink{classXFileMaker_a2e203c544f45c9a05571091eb6722cf6}{write}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00055\ \ \ \textcolor{keywordflow}{return}\ \_x\_file-\/>\mbox{\hyperlink{classXFile_aefabc9a64a2767d949b3d5d07134f2da}{write}}(filename);}
\DoxyCodeLine{00056\ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00063\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classXFileMaker_a9c13be78892b8a2278938d2572bd57e4}{XFileMaker::}}}
\DoxyCodeLine{00064\ \mbox{\hyperlink{classXFileMaker_a9c13be78892b8a2278938d2572bd57e4}{add\_tree}}(\mbox{\hyperlink{classEggData}{EggData}}\ *egg\_data)\ \{}
\DoxyCodeLine{00065\ \ \ \_meshes.clear();}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \textcolor{comment}{//\ Now\ collect\ all\ the\ polygons\ together\ into\ polysets.}}
\DoxyCodeLine{00068\ \ \ \mbox{\hyperlink{classEggPolysetMaker}{EggPolysetMaker}}\ pmaker;}
\DoxyCodeLine{00069\ \ \ pmaker.make\_bins(egg\_data);}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \textcolor{comment}{//\ And\ now\ we're\ ready\ to\ traverse\ the\ egg\ hierarchy.}}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{if}\ (!recurse\_nodes(egg\_data,\ \_x\_file))\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00074\ \ \ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \textcolor{comment}{//\ Create\ X\ structures\ for\ all\ of\ the\ meshes\ we\ built\ up.}}
\DoxyCodeLine{00077\ \ \ Meshes::iterator\ mi;}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{for}\ (mi\ =\ \_meshes.begin();\ mi\ !=\ \_meshes.end();\ ++mi)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordflow}{if}\ (!finalize\_mesh((*mi).first,\ (*mi).second))\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00081\ \ \ \ \ \}}
\DoxyCodeLine{00082\ \ \ \}}
\DoxyCodeLine{00083\ \ \ \_meshes.clear();}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00086\ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00091\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00092\ add\_node(\mbox{\hyperlink{classEggNode}{EggNode}}\ *egg\_node,\ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{if}\ (egg\_node-\/>is\_of\_type(EggBin::get\_class\_type()))\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordflow}{return}\ add\_bin(DCAST(\mbox{\hyperlink{classEggBin}{EggBin}},\ egg\_node),\ x\_parent);}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (egg\_node-\/>is\_of\_type(EggGroup::get\_class\_type()))\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordflow}{return}\ add\_group(DCAST(\mbox{\hyperlink{classEggGroup}{EggGroup}},\ egg\_node),\ x\_parent);}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (egg\_node-\/>is\_of\_type(EggGroupNode::get\_class\_type()))\ \{}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ A\ grouping\ node\ of\ some\ kind.}}
\DoxyCodeLine{00101\ \ \ \ \ \mbox{\hyperlink{classEggGroupNode}{EggGroupNode}}\ *egg\_group\ =\ DCAST(\mbox{\hyperlink{classEggGroupNode}{EggGroupNode}},\ egg\_node);}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keywordflow}{if}\ (xfile\_one\_mesh)\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ create\ any\ additional\ frames\ representing\ the\ egg\ hierarchy.}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!recurse\_nodes(egg\_group,\ x\_parent))\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \textcolor{comment}{//\ Create\ a\ Frame\ for\ each\ EggGroup.}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \mbox{\hyperlink{classXFileDataNode}{XFileDataNode}}\ *x\_frame\ =\ x\_parent-\/>\mbox{\hyperlink{classXFileNode_a0502c2ad4af383e0c6197afebf1f38a3}{add\_Frame}}(egg\_group-\/>get\_name());}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!recurse\_nodes(egg\_group,\ x\_frame))\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00116\ \ \ \ \ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00119\ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{comment}{//\ Some\ unsupported\ node\ type.\ \ Ignore\ it.}}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00123\ \}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00128\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00129\ add\_group(\mbox{\hyperlink{classEggGroup}{EggGroup}}\ *egg\_group,\ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00130\ \ \ \textcolor{keywordflow}{if}\ (xfile\_one\_mesh)\ \{}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{comment}{//\ Don't\ create\ any\ additional\ frames\ representing\ the\ egg\ hierarchy.}}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordflow}{if}\ (!recurse\_nodes(egg\_group,\ x\_parent))\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00134\ \ \ \ \ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ frame\ for\ each\ EggGroup.}}
\DoxyCodeLine{00138\ \ \ \ \ \mbox{\hyperlink{classXFileDataNode}{XFileDataNode}}\ *x\_frame\ =\ x\_parent-\/>\mbox{\hyperlink{classXFileNode_a0502c2ad4af383e0c6197afebf1f38a3}{add\_Frame}}(egg\_group-\/>get\_name());}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{comment}{//\ Set\ the\ transform\ on\ the\ frame,\ if\ we\ have\ one.}}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{if}\ (egg\_group-\/>has\_transform())\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \ \ x\_frame-\/>\mbox{\hyperlink{classXFileNode_a5cdb8905824e52580313576bb2ee8cec}{add\_FrameTransformMatrix}}(egg\_group-\/>get\_transform3d());}
\DoxyCodeLine{00143\ \ \ \ \ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keywordflow}{if}\ (!recurse\_nodes(egg\_group,\ x\_frame))\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00147\ \ \ \ \ \}}
\DoxyCodeLine{00148\ \ \ \}}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00151\ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00157\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00158\ add\_bin(\mbox{\hyperlink{classEggBin}{EggBin}}\ *egg\_bin,\ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00159\ \ \ \textcolor{keywordflow}{switch}\ (egg\_bin-\/>get\_bin\_number())\ \{}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{case}\ EggPolysetMaker::BN\_polyset:}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keywordflow}{return}\ add\_polyset(egg\_bin,\ x\_parent);}
\DoxyCodeLine{00162\ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ xfile\_cat.error()}
\DoxyCodeLine{00165\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unexpected\ bin\ type\ "{}}\ <<\ egg\_bin-\/>get\_bin\_number()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00167\ \}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00173\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00174\ add\_polyset(\mbox{\hyperlink{classEggBin}{EggBin}}\ *egg\_bin,\ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00175\ \ \ \textcolor{comment}{//\ Make\ sure\ that\ all\ our\ polygons\ are\ reasonable.}}
\DoxyCodeLine{00176\ \ \ egg\_bin-\/>\mbox{\hyperlink{classEggGroupNode_a205b285790206dbd3a359d4517655e04}{remove\_invalid\_primitives}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \mbox{\hyperlink{classXFileMesh}{XFileMesh}}\ *mesh\ =\ get\_mesh(x\_parent);}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ EggGroupNode::iterator\ ci;}
\DoxyCodeLine{00181\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ egg\_bin-\/>begin();\ ci\ !=\ egg\_bin-\/>end();\ ++ci)\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \mbox{\hyperlink{classEggPolygon}{EggPolygon}}\ *poly;}
\DoxyCodeLine{00183\ \ \ \ \ DCAST\_INTO\_R(poly,\ *ci,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ mesh-\/>\mbox{\hyperlink{classXFileMesh_aaa6504d33b6c6cc867cd42525ef8a515}{add\_polygon}}(poly);}
\DoxyCodeLine{00186\ \ \ \}}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00189\ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00196\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00197\ recurse\_nodes(\mbox{\hyperlink{classEggGroupNode}{EggGroupNode}}\ *egg\_node,\ \mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00198\ \ \ EggGroupNode::iterator\ ci;}
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ egg\_node-\/>begin();\ ci\ !=\ egg\_node-\/>end();\ ++ci)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \mbox{\hyperlink{classEggNode}{EggNode}}\ *child\ =\ (*ci);}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordflow}{if}\ (!add\_node(child,\ x\_parent))\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00203\ \ \ \ \ \}}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00207\ \}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00213\ \mbox{\hyperlink{classXFileMesh}{XFileMesh}}\ *XFileMaker::}
\DoxyCodeLine{00214\ get\_mesh(\mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent)\ \{}
\DoxyCodeLine{00215\ \ \ Meshes::iterator\ mi\ =\ \_meshes.find(x\_parent);}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{if}\ (mi\ !=\ \_meshes.end())\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \textcolor{comment}{//\ We've\ already\ started\ working\ on\ this\ x\_parent\ before;\ use\ the\ same}}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{comment}{//\ mesh\ object.}}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordflow}{return}\ (*mi).second;}
\DoxyCodeLine{00220\ \ \ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \ \ \textcolor{comment}{//\ We\ haven't\ seen\ this\ x\_parent\ before;\ create\ a\ new\ mesh\ object.}}
\DoxyCodeLine{00223\ \ \ \mbox{\hyperlink{classXFileMesh}{XFileMesh}}\ *mesh\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classXFileMesh}{XFileMesh}};}
\DoxyCodeLine{00224\ \ \ \_meshes.insert(Meshes::value\_type(x\_parent,\ mesh));}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{return}\ mesh;}
\DoxyCodeLine{00226\ \}}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00233\ \textcolor{keywordtype}{bool}\ XFileMaker::}
\DoxyCodeLine{00234\ finalize\_mesh(\mbox{\hyperlink{classXFileNode}{XFileNode}}\ *x\_parent,\ \mbox{\hyperlink{classXFileMesh}{XFileMesh}}\ *mesh)\ \{}
\DoxyCodeLine{00235\ \ \ \textcolor{comment}{//\ Get\ a\ unique\ number\ for\ each\ mesh.}}
\DoxyCodeLine{00236\ \ \ \_mesh\_index++;}
\DoxyCodeLine{00237\ \ \ std::string\ mesh\_index\ =\ format\_string(\_mesh\_index);}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \textcolor{comment}{//\ Finally,\ create\ the\ Mesh\ object.}}
\DoxyCodeLine{00240\ \ \ mesh-\/>\mbox{\hyperlink{classXFileMesh_a46a3f74f23a30a80efa8dcd2e0baa12f}{make\_x\_mesh}}(x\_parent,\ mesh\_index);}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00243\ \}}

\end{DoxyCode}
