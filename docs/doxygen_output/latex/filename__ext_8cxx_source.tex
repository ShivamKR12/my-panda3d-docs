\doxysection{filename\+\_\+ext.\+cxx}
\hypertarget{filename__ext_8cxx_source}{}\label{filename__ext_8cxx_source}\index{dtool/src/dtoolutil/filename\_ext.cxx@{dtool/src/dtoolutil/filename\_ext.cxx}}
\mbox{\hyperlink{filename__ext_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{filename__ext_8h}{filename\_ext.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00017\ \textcolor{keyword}{using\ }std::wstring;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#ifdef\ HAVE\_PYTHON}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#ifndef\ CPPPARSER}}
\DoxyCodeLine{00022\ \textcolor{keyword}{extern}\ Dtool\_PyTypedObject\ Dtool\_Filename;}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ CPPPARSER}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00028\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classExtension}{Extension<Filename>::}}}
\DoxyCodeLine{00029\ \mbox{\hyperlink{classExtension}{\_\_init\_\_}}(PyObject\ *path)\ \{}
\DoxyCodeLine{00030\ \ \ nassertv(path\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00031\ \ \ nassertv(\_this\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ Py\_ssize\_t\ length;}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \textcolor{keywordflow}{if}\ (PyUnicode\_CheckExact(path))\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordflow}{if}\ (Filename::get\_filesystem\_encoding()\ ==\ TextEncoder::E\_utf8)\ \{}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *data\ =\ PyUnicode\_AsUTF8AndSize(path,\ \&length);}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ (*\_this)\ =\ string(data,\ length);}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00041\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \textcolor{keywordtype}{wchar\_t}\ *data;}
\DoxyCodeLine{00043\ \ \ \ \ \ \ data\ =\ PyUnicode\_AsWideCharString(path,\ \&length);}
\DoxyCodeLine{00044\ \ \ \ \ \ \ (*\_this)\ =\ wstring(data,\ length);}
\DoxyCodeLine{00045\ \ \ \ \ \ \ PyMem\_Free(data);}
\DoxyCodeLine{00046\ \ \ \ \ \}}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00048\ \ \ \}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \textcolor{keywordflow}{if}\ (PyBytes\_CheckExact(path))\ \{}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keywordtype}{char}\ *data;}
\DoxyCodeLine{00052\ \ \ \ \ PyBytes\_AsStringAndSize(path,\ \&data,\ \&length);}
\DoxyCodeLine{00053\ \ \ \ \ (*\_this)\ =\ string(data,\ length);}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00055\ \ \ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \textcolor{keywordflow}{if}\ (Py\_IS\_TYPE(path,\ Dtool\_GetPyTypeObject(\&Dtool\_Filename)))\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{comment}{//\ Copy\ constructor.}}
\DoxyCodeLine{00059\ \ \ \ \ *\_this\ =\ *(\mbox{\hyperlink{classFilename}{Filename}}\ *)DtoolInstance\_VOID\_PTR(path);}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \textcolor{comment}{//\ It\ must\ be\ an\ os.PathLike\ object.\ \ Check\ for\ an\ \_\_fspath\_\_\ method.}}
\DoxyCodeLine{00064\ \ \ PyObject\ *fspath\ =\ PyObject\_GetAttrString((PyObject\ *)Py\_TYPE(path),\ \textcolor{stringliteral}{"{}\_\_fspath\_\_"{}});}
\DoxyCodeLine{00065\ \ \ \textcolor{keywordflow}{if}\ (fspath\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00066\ \ \ \ \ PyErr\_Format(PyExc\_TypeError,\ \textcolor{stringliteral}{"{}expected\ str,\ bytes\ or\ os.PathLike\ object,\ not\ \%s"{}},\ Py\_TYPE(path)-\/>tp\_name);}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00068\ \ \ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ PyObject\ *path\_str\ =\ PyObject\_CallFunctionObjArgs(fspath,\ path,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00071\ \ \ Py\_DECREF(fspath);}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{if}\ (path\_str\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00074\ \ \ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \ \ \textcolor{keywordflow}{if}\ (PyUnicode\_CheckExact(path\_str))\ \{}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordflow}{if}\ (Filename::get\_filesystem\_encoding()\ ==\ TextEncoder::E\_utf8)\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *data\ =\ PyUnicode\_AsUTF8AndSize(path\_str,\ \&length);}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ (*\_this)\ =\ \mbox{\hyperlink{classFilename_ab17a80adaab942d6570d114d6f0675c3}{Filename::from\_os\_specific}}(\textcolor{keywordtype}{string}(data,\ length));}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00082\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \textcolor{keywordtype}{wchar\_t}\ *data;}
\DoxyCodeLine{00084\ \ \ \ \ \ \ data\ =\ PyUnicode\_AsWideCharString(path\_str,\ \&length);}
\DoxyCodeLine{00085\ \ \ \ \ \ \ (*\_this)\ =\ \mbox{\hyperlink{classFilename_a70b3803d8c3509910f06f012c805379c}{Filename::from\_os\_specific\_w}}(wstring(data,\ length));}
\DoxyCodeLine{00086\ \ \ \ \ \ \ PyMem\_Free(data);}
\DoxyCodeLine{00087\ \ \ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (PyBytes\_CheckExact(path\_str))\ \{}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordtype}{char}\ *data;}
\DoxyCodeLine{00091\ \ \ \ \ PyBytes\_AsStringAndSize(path\_str,\ \&data,\ \&length);}
\DoxyCodeLine{00092\ \ \ \ \ (*\_this)\ =\ \mbox{\hyperlink{classFilename_ab17a80adaab942d6570d114d6f0675c3}{Filename::from\_os\_specific}}(\textcolor{keywordtype}{string}(data,\ length));}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00095\ \ \ \ \ PyErr\_Format(PyExc\_TypeError,\ \textcolor{stringliteral}{"{}expected\ str\ or\ bytes\ object,\ not\ \%s"{}},\ Py\_TYPE(path\_str)-\/>tp\_name);}
\DoxyCodeLine{00096\ \ \ \}}
\DoxyCodeLine{00097\ \ \ Py\_DECREF(path\_str);}
\DoxyCodeLine{00098\ \}}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00104\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<Filename>::}}}
\DoxyCodeLine{00105\ \mbox{\hyperlink{classExtension}{\_\_reduce\_\_}}(PyObject\ *self)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//\ We\ should\ return\ at\ least\ a\ 2-\/tuple,\ (Class,\ (args)):\ the\ necessary\ class}}
\DoxyCodeLine{00107\ \ \ \textcolor{comment}{//\ object\ whose\ constructor\ we\ should\ call\ (e.g.\ \ this),\ and\ the\ arguments}}
\DoxyCodeLine{00108\ \ \ \textcolor{comment}{//\ necessary\ to\ reconstruct\ this\ object.}}
\DoxyCodeLine{00109\ \ \ PyTypeObject\ *this\_class\ =\ Py\_TYPE(self);}
\DoxyCodeLine{00110\ \ \ \textcolor{keywordflow}{if}\ (this\_class\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00112\ \ \ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ PyObject\ *result\ =\ Py\_BuildValue(\textcolor{stringliteral}{"{}(O(s))"{}},\ this\_class,\ \_this-\/>c\_str());}
\DoxyCodeLine{00115\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00116\ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00122\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<Filename>::}}}
\DoxyCodeLine{00123\ \mbox{\hyperlink{classExtension}{\_\_repr\_\_}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00124\ \ \ wstring\ filename\ =\ \_this-\/>get\_fullpath\_w();}
\DoxyCodeLine{00125\ \ \ PyObject\ *str\ =\ PyUnicode\_FromWideChar(filename.data(),\ (Py\_ssize\_t)filename.size());}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ PyObject\ *result\ =\ PyUnicode\_FromFormat(\textcolor{stringliteral}{"{}Filename(\%R)"{}},\ str);}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ Py\_DECREF(str);}
\DoxyCodeLine{00130\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00131\ \}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00137\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<Filename>::}}}
\DoxyCodeLine{00138\ \mbox{\hyperlink{classExtension}{\_\_fspath\_\_}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00139\ \ \ wstring\ filename\ =\ \_this-\/>to\_os\_specific\_w();}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{return}\ PyUnicode\_FromWideChar(filename.data(),\ (Py\_ssize\_t)filename.size());}
\DoxyCodeLine{00141\ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00147\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<Filename>::}}}
\DoxyCodeLine{00148\ \mbox{\hyperlink{classExtension}{scan\_directory}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ vector\_string\ contents;}
\DoxyCodeLine{00150\ \ \ \textcolor{keywordflow}{if}\ (!\_this-\/>scan\_directory(contents))\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{return}\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00152\ \ \ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ PyObject\ *result\ =\ PyList\_New(contents.size());}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ contents.size();\ ++i)\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&filename\ =\ contents[i];}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{comment}{//\ This\ function\ expects\ UTF-\/8.}}
\DoxyCodeLine{00158\ \ \ \ \ PyObject\ *str\ =\ PyUnicode\_FromStringAndSize(filename.data(),\ filename.size());}
\DoxyCodeLine{00159\ \ \ \ \ PyList\_SET\_ITEM(result,\ i,\ str);}
\DoxyCodeLine{00160\ \ \ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00163\ \}}
\DoxyCodeLine{00164\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_PYTHON}}

\end{DoxyCode}
