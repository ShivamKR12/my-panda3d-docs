\doxysection{cull\+Planes.\+cxx}
\hypertarget{cullPlanes_8cxx_source}{}\label{cullPlanes_8cxx_source}\index{panda/src/pgraph/cullPlanes.cxx@{panda/src/pgraph/cullPlanes.cxx}}
\mbox{\hyperlink{cullPlanes_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullPlanes_8h}{cullPlanes.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clipPlaneAttrib_8h}{clipPlaneAttrib.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{occluderEffect_8h}{occluderEffect.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingBox_8h}{boundingBox.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00022\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00027\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ CullPlanes::}
\DoxyCodeLine{00028\ make\_empty()\ \{}
\DoxyCodeLine{00029\ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ empty;}
\DoxyCodeLine{00030\ \ \ \textcolor{keywordflow}{if}\ (empty\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00031\ \ \ \ \ empty\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}};}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{comment}{//\ Artificially\ tick\ the\ reference\ count,\ just\ to\ ensure\ we\ won't}}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{comment}{//\ accidentally\ modify\ this\ object\ in\ any\ of\ the\ copy-\/on-\/write\ operations}}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{//\ below.}}
\DoxyCodeLine{00035\ \ \ \ \ empty-\/>ref();}
\DoxyCodeLine{00036\ \ \ \}}
\DoxyCodeLine{00037\ \ \ \textcolor{keywordflow}{return}\ empty;}
\DoxyCodeLine{00038\ \}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00044\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ CullPlanes::}
\DoxyCodeLine{00045\ xform(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00046\ \ \ PT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ new\_planes;}
\DoxyCodeLine{00047\ \ \ \textcolor{keywordflow}{if}\ (get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{00048\ \ \ \ \ new\_planes\ =\ (\mbox{\hyperlink{classCullPlanes}{CullPlanes}}\ *)\textcolor{keyword}{this};}
\DoxyCodeLine{00049\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00050\ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{for}\ (Planes::iterator\ pi\ =\ new\_planes-\/>\_planes.begin();}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ pi\ !=\ new\_planes-\/>\_planes.end();}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ ++pi)\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*pi).second-\/>get\_ref\_count()\ !=\ 1)\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \ \ (*pi).second\ =\ DCAST(\mbox{\hyperlink{classBoundingPlane}{BoundingPlane}},\ (*pi).second-\/>make\_copy());}
\DoxyCodeLine{00058\ \ \ \ \ \}}
\DoxyCodeLine{00059\ \ \ \ \ (*pi).second-\/>xform(mat);}
\DoxyCodeLine{00060\ \ \ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \textcolor{keywordflow}{for}\ (Occluders::iterator\ oi\ =\ new\_planes-\/>\_occluders.begin();}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ oi\ !=\ new\_planes-\/>\_occluders.end();}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ ++oi)\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*oi).second-\/>get\_ref\_count()\ !=\ 1)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ \ \ (*oi).second\ =\ DCAST(\mbox{\hyperlink{classBoundingHexahedron}{BoundingHexahedron}},\ (*oi).second-\/>make\_copy());}
\DoxyCodeLine{00067\ \ \ \ \ \}}
\DoxyCodeLine{00068\ \ \ \ \ (*oi).second-\/>xform(mat);}
\DoxyCodeLine{00069\ \ \ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00072\ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00082\ \textcolor{keywordtype}{void}\ CullPlanes::}
\DoxyCodeLine{00083\ apply\_state(CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ \&planes,}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ *data,}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *net\_attrib,}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *off\_attrib,}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classOccluderEffect}{OccluderEffect}}\ *node\_effect)\ \{}
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{if}\ (net\_attrib\ ==\ \textcolor{keyword}{nullptr}\ \&\&\ node\_effect\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ PT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ new\_planes;}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{if}\ (planes\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordflow}{if}\ (planes-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ new\_planes\ =\ (\mbox{\hyperlink{classCullPlanes}{CullPlanes}}\ *)planes.p();}
\DoxyCodeLine{00096\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}}(*planes);}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ net\_transform\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{keywordflow}{if}\ (net\_attrib\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_on\_planes\ =\ net\_attrib-\/>get\_num\_on\_planes();}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_on\_planes\ >\ 0\ \&\&\ new\_planes.is\_null())\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}};}
\DoxyCodeLine{00107\ \ \ \ \ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_on\_planes;\ ++i)\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ clip\_plane\ =\ net\_attrib-\/>get\_on\_plane(i);}
\DoxyCodeLine{00111\ \ \ \ \ \ \ Planes::const\_iterator\ pi\ =\ new\_planes-\/>\_planes.find(clip\_plane);}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pi\ ==\ new\_planes-\/>\_planes.end())\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!off\_attrib-\/>has\_off\_plane(clip\_plane))\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Here's\ a\ new\ clip\ plane;\ add\ it\ to\ the\ list.\ \ For\ this\ we\ need}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ net\ transform\ to\ this\ node.}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (net\_transform\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ net\_transform\ =\ data-\/>get\_net\_transform(trav);}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPlaneNode}{PlaneNode}}\ *plane\_node\ =\ DCAST(\mbox{\hyperlink{classPlaneNode}{PlaneNode}},\ clip\_plane.node());}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ new\_transform\ =}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ net\_transform-\/>invert\_compose(clip\_plane.get\_net\_transform());}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ LPlane\ plane\ =\ plane\_node-\/>get\_plane()\ *\ new\_transform-\/>get\_mat();}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ new\_planes-\/>\_planes[clip\_plane]\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingPlane}{BoundingPlane}}(-\/plane);}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \ \ \}}
\DoxyCodeLine{00129\ \ \ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{if}\ (node\_effect\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00132\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ center\_transform\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{comment}{//\ We'll\ need\ to\ know\ the\ occluder's\ frustum\ in\ cull-\/center\ space.}}
\DoxyCodeLine{00134\ \ \ \ \ \mbox{\hyperlink{classSceneSetup}{SceneSetup}}\ *scene\ =\ trav-\/>get\_scene();}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens\ =\ scene-\/>get\_lens();}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_on\_occluders\ =\ node\_effect-\/>get\_num\_on\_occluders();}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_on\_occluders\ >\ 0\ \&\&\ new\_planes.is\_null())\ \{}
\DoxyCodeLine{00139\ \ \ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}};}
\DoxyCodeLine{00140\ \ \ \ \ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_on\_occluders;\ ++i)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ occluder\ =\ node\_effect-\/>get\_on\_occluder(i);}
\DoxyCodeLine{00144\ \ \ \ \ \ \ Occluders::const\_iterator\ oi\ =\ new\_planes-\/>\_occluders.find(occluder);}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (oi\ ==\ new\_planes-\/>\_occluders.end())\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Here's\ a\ new\ occluder;\ consider\ adding\ it\ to\ the\ list.}}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classOccluderNode}{OccluderNode}}\ *occluder\_node\ =\ DCAST(\mbox{\hyperlink{classOccluderNode}{OccluderNode}},\ occluder.node());}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ nassertv(occluder\_node-\/>get\_num\_vertices()\ ==\ 4);}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ occluder\_transform\ =\ occluder.get\_transform(scene-\/>get\_cull\_center());}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ And\ the\ transform\ from\ cull-\/center\ space\ into\ the\ current\ node's}}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ coordinate\ space.}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (center\_transform\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (net\_transform\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ net\_transform\ =\ data-\/>get\_net\_transform(trav);}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ center\_transform\ =\ net\_transform-\/>invert\_compose(scene-\/>get\_cull\_center().get\_net\_transform());}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Compare\ the\ occluder\ node's\ bounding\ volume\ to\ the\ view\ frustum.}}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ construct\ a\ new\ bounding\ volume\ because\ (a)\ the\ node's\ existing}}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ bounding\ volume\ is\ in\ the\ coordinate\ space\ of\ its\ parent,\ which}}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ isn't\ what\ we\ have\ here,\ and\ (b)\ we\ might\ as\ well\ make\ a}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ BoundingBox,\ which\ is\ as\ tight\ as\ possible,\ and\ creating\ one\ isn't}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ any\ less\ efficient\ than\ transforming\ the\ existing\ bounding\ volume.}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classBoundingBox}{BoundingBox}})\ occluder\_gbv;}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ a\ transform\ from\ the\ occluder\ directly\ to\ this\ node's\ space\ for}}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ comparing\ with\ the\ current\ view\ frustum.}}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ composed\_transform\ =\ center\_transform-\/>compose(occluder\_transform);}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&composed\_mat\ =\ composed\_transform-\/>get\_mat();}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ LPoint3\ ccp[4];}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ ccp[0]\ =\ occluder\_node-\/>get\_vertex(0)\ *\ composed\_mat;}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ ccp[1]\ =\ occluder\_node-\/>get\_vertex(1)\ *\ composed\_mat;}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ ccp[2]\ =\ occluder\_node-\/>get\_vertex(2)\ *\ composed\_mat;}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ ccp[3]\ =\ occluder\_node-\/>get\_vertex(3)\ *\ composed\_mat;}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ LPoint3\ ccp\_min(min(min(ccp[0][0],\ ccp[1][0]),}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(ccp[2][0],\ ccp[3][0])),}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(min(ccp[0][1],\ ccp[1][1]),}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(ccp[2][1],\ ccp[3][1])),}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(min(ccp[0][2],\ ccp[1][2]),}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(ccp[2][2],\ ccp[3][2])));}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ LPoint3\ ccp\_max(max(max(ccp[0][0],\ ccp[1][0]),}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max(ccp[2][0],\ ccp[3][0])),}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max(max(ccp[0][1],\ ccp[1][1]),}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max(ccp[2][1],\ ccp[3][1])),}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max(max(ccp[0][2],\ ccp[1][2]),}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max(ccp[2][2],\ ccp[3][2])));}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ occluder\_gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}}(ccp\_min,\ ccp\_max);}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data-\/>\_view\_frustum\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ occluder\_result\ =\ data-\/>\_view\_frustum-\/>contains(occluder\_gbv);}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (occluder\_result\ ==\ BoundingVolume::IF\_no\_intersection)\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ occluder\ is\ outside\ the\ view\ frustum;\ ignore\ it.}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Ignoring\ occluder\ "{}}\ <<\ occluder\ <<\ \textcolor{stringliteral}{"{}:\ outside\ view\ frustum.\(\backslash\)n"{}};}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ occluder\ geometry\ in\ cull-\/center\ space.}}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&occluder\_mat\_cull\ =\ occluder\_transform-\/>get\_mat();}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ LPoint3\ points\_near[4];}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ points\_near[0]\ =\ occluder\_node-\/>get\_vertex(0)\ *\ occluder\_mat\_cull;}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ points\_near[1]\ =\ occluder\_node-\/>get\_vertex(1)\ *\ occluder\_mat\_cull;}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ points\_near[2]\ =\ occluder\_node-\/>get\_vertex(2)\ *\ occluder\_mat\_cull;}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ points\_near[3]\ =\ occluder\_node-\/>get\_vertex(3)\ *\ occluder\_mat\_cull;}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ LPlane\ plane(points\_near[0],\ points\_near[1],\ points\_near[2]);}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (plane.get\_normal().dot(LVector3::forward())\ >=\ 0.0)\ \{}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (occluder\_node-\/>is\_double\_sided())\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ std::swap(points\_near[0],\ points\_near[3]);}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ \ \ std::swap(points\_near[1],\ points\_near[2]);}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ plane\ =\ LPlane(points\_near[0],\ points\_near[1],\ points\_near[2]);}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ occluder\ is\ facing\ the\ wrong\ direction.\ \ Ignore\ it.}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Ignoring\ occluder\ "{}}\ <<\ occluder\ <<\ \textcolor{stringliteral}{"{}:\ wrong\ direction.\(\backslash\)n"{}};}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (occluder\_node-\/>get\_min\_coverage())\ \{}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ LPoint3\ coords[4];}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ lens-\/>project(points\_near[0],\ coords[0]);}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ lens-\/>project(points\_near[1],\ coords[1]);}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ lens-\/>project(points\_near[2],\ coords[2]);}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ lens-\/>project(points\_near[3],\ coords[3]);}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ coords[0][0]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[0][0]));}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ coords[0][1]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[0][1]));}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ coords[1][0]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[1][0]));}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ coords[1][1]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[1][1]));}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ coords[2][0]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[2][0]));}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ coords[2][1]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[2][1]));}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ coords[3][0]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[3][0]));}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ coords[3][1]\ =\ max((PN\_stdfloat)-\/1.0,\ min((PN\_stdfloat)1.0,\ coords[3][1]));}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ coverage\ =\ ((coords[0]\ -\/\ coords[1]).cross(coords[0]\ -\/\ coords[2]).length()}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ +\ (coords[3]\ -\/\ coords[1]).cross(coords[3]\ -\/\ coords[2]).length())}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *\ 0.125;}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (coverage\ <\ occluder\_node-\/>get\_min\_coverage())\ \{}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ occluder\ does\ not\ cover\ enough\ screen\ space.\ \ Ignore\ it.}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Ignoring\ occluder\ "{}}\ <<\ occluder\ <<\ \textcolor{stringliteral}{"{}:\ coverage\ less\ than\ minimum.\(\backslash\)n"{}};}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Also\ check\ if\ the\ new\ occluder\ is\ completely\ within\ any\ of\ our}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ existing\ occluder\ volumes.}}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_enclosed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ Occluders::const\_iterator\ oi;}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (oi\ =\ new\_planes-\/>\_occluders.begin();\ oi\ !=\ new\_planes-\/>\_occluders.end();\ ++oi)\ \{}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ occluder\_result\ =\ (*oi).second-\/>contains(occluder\_gbv);}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((occluder\_result\ \&\ BoundingVolume::IF\_all)\ !=\ 0)\ \{}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ is\_enclosed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_enclosed)\ \{}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ reason\ to\ add\ this\ occluder;\ it's\ behind\ an\ existing\ occluder.}}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Ignoring\ occluder\ "{}}\ <<\ occluder\ <<\ \textcolor{stringliteral}{"{}:\ behind\ another.\(\backslash\)n"{}};}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ perhaps\ we\ should\ also\ check\ whether\ any\ existing\ occluders}}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ are\ fully\ contained\ within\ this\ new\ one.}}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ occluder\ coordinates\ in\ global\ space.}}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&occluder\_mat\ =\ occluder.get\_net\_transform()-\/>get\_mat();}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ points\_near[0]\ =\ occluder\_node-\/>get\_vertex(0)\ *\ occluder\_mat;}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ points\_near[1]\ =\ occluder\_node-\/>get\_vertex(1)\ *\ occluder\_mat;}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ points\_near[2]\ =\ occluder\_node-\/>get\_vertex(2)\ *\ occluder\_mat;}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ points\_near[3]\ =\ occluder\_node-\/>get\_vertex(3)\ *\ occluder\_mat;}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ the\ far\ points,\ project\ PAST\ the\ far\ clip\ of\ the\ lens\ to}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ensures\ we\ get\ stuff\ that\ might\ be\ intersecting\ the\ far\ clip.}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ LPoint3\ center\ =\ scene-\/>get\_cull\_center().get\_net\_transform()-\/>get\_pos();}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ PN\_stdfloat\ far\_clip\ =\ scene-\/>get\_lens()-\/>get\_far()\ *\ 2.0;}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ LPoint3\ points\_far[4];}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ points\_far[0]\ =\ normalize(points\_near[0]\ -\/\ center)\ *\ far\_clip\ +\ points\_near[0];}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ points\_far[1]\ =\ normalize(points\_near[1]\ -\/\ center)\ *\ far\_clip\ +\ points\_near[1];}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ points\_far[2]\ =\ normalize(points\_near[2]\ -\/\ center)\ *\ far\_clip\ +\ points\_near[2];}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ points\_far[3]\ =\ normalize(points\_near[3]\ -\/\ center)\ *\ far\_clip\ +\ points\_near[3];}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ With\ these\ points,\ construct\ the\ bounding\ frustum\ of\ the\ occluded}}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ region.}}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classBoundingHexahedron}{BoundingHexahedron}})\ frustum\ =}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingHexahedron}{BoundingHexahedron}}(points\_far[1],\ points\_far[2],\ points\_far[3],\ points\_far[0],}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ points\_near[1],\ points\_near[2],\ points\_near[3],\ points\_near[0]);}
\DoxyCodeLine{00301\ }
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ new\_planes-\/>\_occluders[occluder]\ =\ frustum;}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (show\_occluder\_volumes)\ \{}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Draw\ the\ frustum\ for\ visualization.}}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ nassertv(net\_transform\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ trav-\/>draw\_bounding\_volume(frustum,\ data-\/>get\_internal\_transform(trav));}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00310\ \ \ \ \ \}}
\DoxyCodeLine{00311\ \ \ \}}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00313\ \ \ planes\ =\ std::move(new\_planes);}
\DoxyCodeLine{00314\ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00326\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ CullPlanes::}
\DoxyCodeLine{00327\ do\_cull(\textcolor{keywordtype}{int}\ \&result,\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ \&state,}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *node\_gbv)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00329\ \ \ result\ =}
\DoxyCodeLine{00330\ \ \ \ \ BoundingVolume::IF\_all\ |\ BoundingVolume::IF\_possible\ |\ BoundingVolume::IF\_some;}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ new\_planes\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *orig\_cpa;}
\DoxyCodeLine{00335\ \ \ \textcolor{keywordflow}{if}\ (!state-\/>get\_attrib(orig\_cpa))\ \{}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{comment}{//\ If\ there\ are\ no\ clip\ planes\ in\ the\ state,\ the\ node\ is\ completely\ in}}
\DoxyCodeLine{00337\ \ \ \ \ \textcolor{comment}{//\ front\ of\ all\ zero\ of\ the\ clip\ planes.\ \ (This\ can\ happen\ if\ someone}}
\DoxyCodeLine{00338\ \ \ \ \ \textcolor{comment}{//\ directly\ changes\ the\ state\ during\ the\ traversal.)}}
\DoxyCodeLine{00339\ \ \ \ \ \mbox{\hyperlink{classCullPlanes}{CullPlanes}}\ *planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}};}
\DoxyCodeLine{00340\ \ \ \ \ planes-\/>\_occluders\ =\ \_occluders;}
\DoxyCodeLine{00341\ \ \ \ \ new\_planes\ =\ planes;}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00344\ \ \ \ \ CPT(\mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}})\ new\_cpa\ =\ orig\_cpa;}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \ \ Planes::const\_iterator\ pi;}
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_planes.begin();\ pi\ !=\ \_planes.end();\ ++pi)\ \{}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ plane\_result\ =\ (*pi).second-\/>contains(node\_gbv);}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (plane\_result\ ==\ BoundingVolume::IF\_no\_intersection)\ \{}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ node\ is\ completely\ behind\ this\ clip\ plane\ and\ gets\ culled.}}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Short-\/circuit\ the\ rest\ of\ the\ logic;\ none\ of\ the\ other\ planes}}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ matter.}}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ result\ =\ plane\_result;}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((plane\_result\ \&\ BoundingVolume::IF\_all)\ !=\ 0)\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ node\ is\ completely\ in\ front\ of\ this\ clip\ plane.\ \ We\ don't\ need}}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ consider\ this\ plane\ ever\ again\ for\ any\ descendents\ of\ this\ node.}}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ new\_planes\ =\ new\_planes-\/>remove\_plane((*pi).first);}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ nassertr(new\_planes\ !=\ \textcolor{keyword}{this},\ new\_planes);}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ new\_cpa\ =\ DCAST(\mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}},\ new\_cpa-\/>remove\_on\_plane((*pi).first));}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \ \ \ \ \ \ result\ \&=\ plane\_result;}
\DoxyCodeLine{00364\ \ \ \ \ \}}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_cpa\ !=\ orig\_cpa)\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_cpa-\/>is\_identity())\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ state\ =\ state-\/>remove\_attrib(ClipPlaneAttrib::get\_class\_slot());}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ state\ =\ state-\/>add\_attrib(new\_cpa);}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00372\ \ \ \ \ \}}
\DoxyCodeLine{00373\ \ \ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ Occluders::const\_iterator\ oi;}
\DoxyCodeLine{00376\ \ \ \textcolor{keywordflow}{for}\ (oi\ =\ \_occluders.begin();\ oi\ !=\ \_occluders.end();\ ++oi)\ \{}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordtype}{int}\ occluder\_result\ =\ (*oi).second-\/>contains(node\_gbv);}
\DoxyCodeLine{00378\ \ \ \ \ \textcolor{keywordflow}{if}\ (occluder\_result\ ==\ BoundingVolume::IF\_no\_intersection)\ \{}
\DoxyCodeLine{00379\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ node\ is\ completely\ in\ front\ of\ this\ occluder.\ \ We\ don't\ need\ to}}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \textcolor{comment}{//\ consider\ this\ occluder\ ever\ again\ for\ any\ descendents\ of\ this\ node.}}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ \ \ \ \ \textcolor{comment}{//\ Reverse\ the\ sense\ of\ the\ test,\ because\ an\ occluder\ volume\ is\ the}}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \textcolor{comment}{//\ inverse\ of\ a\ cull\ plane\ volume:\ it\ describes\ the\ volume\ that\ is\ to\ be}}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \textcolor{comment}{//\ culled,\ not\ the\ volume\ that\ is\ to\ be\ kept.}}
\DoxyCodeLine{00385\ \ \ \ \ \ \ occluder\_result\ =\ BoundingVolume::IF\_all\ |\ BoundingVolume::IF\_possible\ |\ BoundingVolume::IF\_some;}
\DoxyCodeLine{00386\ \ \ \ \ \ \ new\_planes\ =\ new\_planes-\/>remove\_occluder((*oi).first);}
\DoxyCodeLine{00387\ \ \ \ \ \ \ nassertr(new\_planes\ !=\ \textcolor{keyword}{this},\ new\_planes);}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00389\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((occluder\_result\ \&\ BoundingVolume::IF\_all)\ !=\ 0)\ \{}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ node\ is\ completely\ behind\ this\ occluder\ and\ gets\ culled.\ \ Short-\/}}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \textcolor{comment}{//\ circuit\ the\ rest\ of\ the\ logic;\ none\ of\ the\ other\ occluders\ matter.}}
\DoxyCodeLine{00392\ \ \ \ \ \ \ result\ =\ BoundingVolume::IF\_no\_intersection;}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00394\ \ \ \ \ \}}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \ \ result\ \&=\ occluder\_result;}
\DoxyCodeLine{00397\ \ \ \}}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00400\ \}}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00406\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ CullPlanes::}
\DoxyCodeLine{00407\ remove\_plane(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&clip\_plane)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00408\ \ \ PT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ new\_planes;}
\DoxyCodeLine{00409\ \ \ \textcolor{keywordflow}{if}\ (get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{00410\ \ \ \ \ new\_planes\ =\ (\mbox{\hyperlink{classCullPlanes}{CullPlanes}}\ *)\textcolor{keyword}{this};}
\DoxyCodeLine{00411\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00412\ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00413\ \ \ \}}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ Planes::iterator\ pi\ =\ new\_planes-\/>\_planes.find(clip\_plane);}
\DoxyCodeLine{00416\ \ \ nassertr(pi\ !=\ new\_planes-\/>\_planes.end(),\ new\_planes);}
\DoxyCodeLine{00417\ \ \ new\_planes-\/>\_planes.erase(pi);}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00420\ \}}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00426\ CPT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ CullPlanes::}
\DoxyCodeLine{00427\ remove\_occluder(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&occluder)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00428\ \ \ PT(\mbox{\hyperlink{classCullPlanes}{CullPlanes}})\ new\_planes;}
\DoxyCodeLine{00429\ \ \ \textcolor{keywordflow}{if}\ (get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{00430\ \ \ \ \ new\_planes\ =\ (\mbox{\hyperlink{classCullPlanes}{CullPlanes}}\ *)\textcolor{keyword}{this};}
\DoxyCodeLine{00431\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00432\ \ \ \ \ new\_planes\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCullPlanes}{CullPlanes}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00433\ \ \ \}}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \ \ Occluders::iterator\ pi\ =\ new\_planes-\/>\_occluders.find(occluder);}
\DoxyCodeLine{00436\ \ \ nassertr(pi\ !=\ new\_planes-\/>\_occluders.end(),\ new\_planes);}
\DoxyCodeLine{00437\ \ \ new\_planes-\/>\_occluders.erase(pi);}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00439\ \ \ \textcolor{keywordflow}{return}\ new\_planes;}
\DoxyCodeLine{00440\ \}}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00445\ \textcolor{keywordtype}{void}\ CullPlanes::}
\DoxyCodeLine{00446\ write(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00447\ \ \ out\ <<\ \textcolor{stringliteral}{"{}CullPlanes\ ("{}}\ <<\ \_planes.size()\ <<\ \textcolor{stringliteral}{"{}\ planes\ and\ "{}}}
\DoxyCodeLine{00448\ \ \ \ \ \ \ <<\ \_occluders.size()\ <<\ \textcolor{stringliteral}{"{}\ occluders):\(\backslash\)n"{}};}
\DoxyCodeLine{00449\ \ \ Planes::const\_iterator\ pi;}
\DoxyCodeLine{00450\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_planes.begin();\ pi\ !=\ \_planes.end();\ ++pi)\ \{}
\DoxyCodeLine{00451\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ (*pi).first\ <<\ \textcolor{stringliteral}{"{}\ :\ "{}}\ <<\ *(*pi).second\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00452\ \ \ \}}
\DoxyCodeLine{00453\ }
\DoxyCodeLine{00454\ \ \ Occluders::const\_iterator\ oi;}
\DoxyCodeLine{00455\ \ \ \textcolor{keywordflow}{for}\ (oi\ =\ \_occluders.begin();\ oi\ !=\ \_occluders.end();\ ++oi)\ \{}
\DoxyCodeLine{00456\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ (*oi).first\ <<\ \textcolor{stringliteral}{"{}\ :\ "{}}\ <<\ *(*oi).second\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00457\ \ \ \}}
\DoxyCodeLine{00458\ \}}

\end{DoxyCode}
