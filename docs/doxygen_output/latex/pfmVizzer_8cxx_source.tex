\doxysection{pfm\+Vizzer.\+cxx}
\hypertarget{pfmVizzer_8cxx_source}{}\label{pfmVizzer_8cxx_source}\index{panda/src/grutil/pfmVizzer.cxx@{panda/src/grutil/pfmVizzer.cxx}}
\mbox{\hyperlink{pfmVizzer_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pfmVizzer_8h}{pfmVizzer.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexData_8h}{geomVertexData.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexFormat_8h}{geomVertexFormat.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomPoints_8h}{geomPoints.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTriangles_8h}{geomTriangles.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lens_8h}{lens.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmImage_8h}{pnmImage.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__grutil_8h}{config\_grutil.h}}"{}}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00027\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00035\ PfmVizzer::}
\DoxyCodeLine{00036\ PfmVizzer(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm)\ :\ \_pfm(pfm)\ \{}
\DoxyCodeLine{00037\ \ \ \_vis\_inverse\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00038\ \ \ \_vis\_2d\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00039\ \ \ \_keep\_beyond\_lens\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00040\ \ \ \_vis\_blend\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00041\ \ \ \_aux\_pfm\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00042\ \}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00051\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00052\ project(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ *undist\_lut)\ \{}
\DoxyCodeLine{00053\ \ \ nassertv(\_pfm.is\_valid());}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \textcolor{keyword}{static}\ LMatrix4\ to\_uv(0.5f,\ 0.0f,\ 0.0f,\ 0.0f,}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ 0.5f,\ 0.0f,\ 0.0f,}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f,\ 0.0f,\ 0.5f,\ 0.0f,}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.5f,\ 0.5f,\ 0.5f,\ 1.0f);}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ LPoint3f\ \&p\ =\ \_pfm.modify\_point(xi,\ yi);}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \ \ LPoint3\ film;}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!lens-\/>project(LCAST(PN\_stdfloat,\ p),\ film)\ \&\&\ !\_keep\_beyond\_lens)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.has\_no\_data\_value())\ \{}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \_pfm.set\_point4(xi,\ yi,\ \_pfm.get\_no\_data\_value());}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \_pfm.set\_point4(xi,\ yi,\ LVecBase4f(0,\ 0,\ 0,\ 0));}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ the\ lens\ gives\ us\ coordinates\ in\ the\ range\ [-\/1,\ 1].\ Rescale}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ these\ to\ [0,\ 1].}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ LPoint3f\ uvw\ =\ LCAST(\textcolor{keywordtype}{float},\ film\ *\ to\_uv);}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (undist\_lut\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Apply\ the\ undistortion\ map,\ if\ given.}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ LPoint3f\ p2;}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ undist\_lut-\/>calc\_bilinear\_point(p2,\ uvw[0],\ 1.0\ -\/\ uvw[1]);}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ uvw\ =\ p2;}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ uvw[1]\ =\ 1.0\ -\/\ uvw[1];}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ p\ =\ uvw;}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00089\ \ \ \ \ \}}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00102\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00103\ extrude(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens)\ \{}
\DoxyCodeLine{00104\ \ \ nassertv(\_pfm.is\_valid());}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \ \ \textcolor{keyword}{static}\ LMatrix4\ from\_uv(2.0,\ 0.0,\ 0.0,\ 0.0,}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0,\ 2.0,\ 0.0,\ 0.0,}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0,\ 0.0,\ 2.0,\ 0.0,}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/1.0,\ -\/1.0,\ -\/1.0,\ 1.0);}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ result;}
\DoxyCodeLine{00112\ \ \ result.clear(\_pfm.get\_x\_size(),\ \_pfm.get\_y\_size(),\ 3);}
\DoxyCodeLine{00113\ \ \ \textcolor{keywordflow}{if}\ (\_pfm.has\_no\_data\_value())\ \{}
\DoxyCodeLine{00114\ \ \ \ \ result.set\_zero\_special(\textcolor{keyword}{true});}
\DoxyCodeLine{00115\ \ \ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (lens-\/>\mbox{\hyperlink{classLens_a52af0b8777ac289e2168a4e89cf698a3}{is\_linear}}())\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{comment}{//\ If\ the\ lens\ is\ linear\ (Perspective\ or\ Orthographic),\ we\ can\ take\ the}}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{comment}{//\ slightly\ faster\ approach\ of\ extruding\ all\ the\ points\ via\ a\ transform}}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{comment}{//\ matrix.}}
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&proj\_mat\_inv\ =\ lens-\/>get\_projection\_mat\_inv();}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_num\_channels()\ ==\ 1)\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \textcolor{comment}{//\ Create\ an\ implicit\ UV\ coordinate\ for\ each\ point.}}
\DoxyCodeLine{00125\ \ \ \ \ \ \ LPoint2\ uv\_scale(1.0,\ 1.0);}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_x\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ uv\_scale[0]\ =\ 1.0\ /\ PN\_stdfloat(\_pfm.get\_x\_size());}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_y\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ uv\_scale[1]\ =\ 1.0\ /\ PN\_stdfloat(\_pfm.get\_y\_size());}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ LPoint3\ p,\ rp;}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ p.set(((PN\_stdfloat)xi\ +\ 0.5)\ *\ uv\_scale[0],}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((PN\_stdfloat)yi\ +\ 0.5)\ *\ uv\_scale[1],}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (PN\_stdfloat)\_pfm.get\_point1(xi,\ yi));}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ from\_uv.xform\_point\_in\_place(p);}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ rp\ =\ proj\_mat\_inv.xform\_point\_general(p);}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ result.set\_point(xi,\ yi,\ rp);}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00147\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \textcolor{comment}{//\ Use\ the\ existing\ UV\ coordinate\ for\ each\ point.}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ LPoint3\ p,\ rp;}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ p\ =\ LCAST(PN\_stdfloat,\ \_pfm.get\_point(xi,\ yi));}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ from\_uv.xform\_point\_in\_place(p);}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ rp\ =\ proj\_mat\_inv.xform\_point\_general(p);}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ result.set\_point(xi,\ yi,\ rp);}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ If\ the\ lens\ is\ some\ non-\/linear\ specialty\ lens,\ we\ have\ to\ call}}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ Lens::extrude\_depth()\ to\ correctly\ extrude\ each\ point.}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_num\_channels()\ ==\ 1)\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \textcolor{comment}{//\ Create\ an\ implicit\ UV\ coordinate\ for\ each\ point.}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ LPoint2\ uv\_scale(1.0,\ 1.0);}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_x\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ uv\_scale[0]\ =\ 1.0\ /\ PN\_stdfloat(\_pfm.get\_x\_size());}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_y\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ uv\_scale[1]\ =\ 1.0\ /\ PN\_stdfloat(\_pfm.get\_y\_size());}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ LPoint3\ p,\ rp;}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ p.set(((PN\_stdfloat)xi\ +\ 0.5)\ *\ uv\_scale[0],}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ((PN\_stdfloat)yi\ +\ 0.5)\ *\ uv\_scale[1],}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (PN\_stdfloat)\_pfm.get\_point1(xi,\ yi));}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ from\_uv.xform\_point\_in\_place(p);}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ lens-\/>extrude\_depth(p,\ rp);}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ result.set\_point(xi,\ yi,\ rp);}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00190\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \textcolor{comment}{//\ Use\ the\ existing\ UV\ coordinate\ for\ each\ point.}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ LPoint3\ p,\ rp;}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ p\ =\ LCAST(PN\_stdfloat,\ \_pfm.get\_point(xi,\ yi));}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ from\_uv.xform\_point\_in\_place(p);}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ lens-\/>extrude\_depth(p,\ rp);}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ result.set\_point(xi,\ yi,\ rp);}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00205\ \ \ \ \ \}}
\DoxyCodeLine{00206\ \ \ \}}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \_pfm\ =\ result;}
\DoxyCodeLine{00209\ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00215\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00216\ clear\_vis\_columns()\ \{}
\DoxyCodeLine{00217\ \ \ \_vis\_columns.clear();}
\DoxyCodeLine{00218\ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00233\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00234\ add\_vis\_column(ColumnType\ source,\ ColumnType\ target,}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ *undist\_lut)\ \{}
\DoxyCodeLine{00237\ \ \ add\_vis\_column(\_vis\_columns,\ source,\ target,\ name,\ transform,\ lens,\ undist\_lut);}
\DoxyCodeLine{00238\ \}}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00245\ \mbox{\hyperlink{classNodePath}{NodePath}}\ PfmVizzer::}
\DoxyCodeLine{00246\ generate\_vis\_points()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00247\ \ \ nassertr(\_pfm.is\_valid(),\ \mbox{\hyperlink{classNodePath}{NodePath}}());}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ \textcolor{keywordtype}{bool}\ check\_aux\_pfm\ =\ uses\_aux\_pfm();}
\DoxyCodeLine{00250\ \ \ nassertr(!check\_aux\_pfm\ ||\ (\_aux\_pfm\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_aux\_pfm-\/>is\_valid()),\ \mbox{\hyperlink{classNodePath}{NodePath}}());}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ format;}
\DoxyCodeLine{00253\ \ \ \textcolor{keywordflow}{if}\ (\_vis\_inverse)\ \{}
\DoxyCodeLine{00254\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_vis\_2d)\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \ \ format\ =\ GeomVertexFormat::get\_v3t2();}
\DoxyCodeLine{00256\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ need\ a\ 3-\/d\ texture\ coordinate\ if\ we're\ inverting\ the\ vis\ and\ it's}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \textcolor{comment}{//\ 3-\/d.}}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *v3t3\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ (InternalName::get\_vertex(),\ 3,}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \ Geom::NT\_stdfloat,\ Geom::C\_point,}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ InternalName::get\_texcoord(),\ 3,}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ Geom::NT\_stdfloat,\ Geom::C\_texcoord);}
\DoxyCodeLine{00264\ \ \ \ \ \ \ format\ =\ GeomVertexFormat::register\_format(v3t3);}
\DoxyCodeLine{00265\ \ \ \ \ \}}
\DoxyCodeLine{00266\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00267\ \ \ \ \ format\ =\ GeomVertexFormat::get\_v3t2();}
\DoxyCodeLine{00268\ \ \ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00271\ \ \ \ \ (\textcolor{stringliteral}{"{}points"{}},\ format,\ Geom::UH\_static);}
\DoxyCodeLine{00272\ \ \ vdata-\/>set\_num\_rows(\_pfm.get\_x\_size()\ *\ \_pfm.get\_y\_size());}
\DoxyCodeLine{00273\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00274\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ texcoord(vdata,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \ \ LPoint2f\ uv\_scale(1.0,\ 1.0);}
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_x\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00278\ \ \ \ \ uv\_scale[0]\ =\ 1.0f\ /\ PN\_float32(\_pfm.get\_x\_size());}
\DoxyCodeLine{00279\ \ \ \}}
\DoxyCodeLine{00280\ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_y\_size()\ >\ 1)\ \{}
\DoxyCodeLine{00281\ \ \ \ \ uv\_scale[1]\ =\ 1.0f\ /\ PN\_float32(\_pfm.get\_y\_size());}
\DoxyCodeLine{00282\ \ \ \}}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00284\ \ \ \textcolor{keywordtype}{int}\ num\_points\ =\ 0;}
\DoxyCodeLine{00285\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ \_pfm.get\_y\_size();\ ++yi)\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ \_pfm.get\_x\_size();\ ++xi)\ \{}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (check\_aux\_pfm\ \&\&\ !\_aux\_pfm-\/>has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00295\ \ \ \ \ \ \ LPoint2f\ uv((PN\_float32(xi)\ +\ 0.5)\ *\ uv\_scale[0],}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (PN\_float32(yi)\ +\ 0.5)\ *\ uv\_scale[1]);}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_vis\_inverse)\ \{}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ vertex.add\_data2f(uv);}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ texcoord.add\_data3f(point);}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_vis\_2d)\ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ vertex.add\_data2f(point[0],\ point[1]);}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ texcoord.add\_data2f(uv);}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ vertex.add\_data3f(point);}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ texcoord.add\_data2f(uv);}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ ++num\_points;}
\DoxyCodeLine{00308\ \ \ \ \ \}}
\DoxyCodeLine{00309\ \ \ \}}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00311\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00312\ \ \ PT(\mbox{\hyperlink{classGeomPoints}{GeomPoints}})\ points\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomPoints}{GeomPoints}}(Geom::UH\_static);}
\DoxyCodeLine{00313\ \ \ points-\/>add\_next\_vertices(num\_points);}
\DoxyCodeLine{00314\ \ \ geom-\/>add\_primitive(points);}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ PT(\mbox{\hyperlink{classGeomNode}{GeomNode}})\ gnode\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00317\ \ \ gnode-\/>add\_geom(geom);}
\DoxyCodeLine{00318\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classNodePath}{NodePath}}(gnode);}
\DoxyCodeLine{00319\ \}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00326\ \mbox{\hyperlink{classNodePath}{NodePath}}\ PfmVizzer::}
\DoxyCodeLine{00327\ generate\_vis\_mesh(MeshFace\ face)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00328\ \ \ nassertr(\_pfm.is\_valid(),\ \mbox{\hyperlink{classNodePath}{NodePath}}());}
\DoxyCodeLine{00329\ \ \ nassertr(!uses\_aux\_pfm()\ ||\ (\_aux\_pfm\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_aux\_pfm-\/>is\_valid()),\ \mbox{\hyperlink{classNodePath}{NodePath}}());}
\DoxyCodeLine{00330\ \ \ nassertr(face\ !=\ 0,\ \mbox{\hyperlink{classNodePath}{NodePath}}());}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_num\_channels()\ ==\ 1\ \&\&\ \_vis\_columns.empty())\ \{}
\DoxyCodeLine{00333\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ generating\ a\ default\ mesh\ from\ a\ one-\/channel\ pfm\ file,\ expand}}
\DoxyCodeLine{00334\ \ \ \ \ \textcolor{comment}{//\ it\ to\ a\ three-\/channel\ pfm\ file\ to\ make\ the\ visualization\ useful.}}
\DoxyCodeLine{00335\ \ \ \ \ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ expanded;}
\DoxyCodeLine{00336\ \ \ \ \ expanded.clear\_to\_texcoords(\_pfm.get\_x\_size(),\ \_pfm.get\_y\_size());}
\DoxyCodeLine{00337\ \ \ \ \ expanded.copy\_channel(2,\ \_pfm,\ 0);}
\DoxyCodeLine{00338\ \ \ \ \ \mbox{\hyperlink{classPfmVizzer}{PfmVizzer}}\ exvizzer(expanded);}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{keywordflow}{return}\ exvizzer.generate\_vis\_mesh(face);}
\DoxyCodeLine{00340\ \ \ \}}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00342\ \ \ \textcolor{keywordflow}{if}\ (\_pfm.get\_x\_size()\ ==\ 1\ ||\ \_pfm.get\_y\_size()\ ==\ 1)\ \{}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{comment}{//\ Can't\ generate\ a\ 1-\/d\ mesh,\ so\ generate\ points\ in\ this\ case.}}
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{keywordflow}{return}\ generate\_vis\_points();}
\DoxyCodeLine{00345\ \ \ \}}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ PT(\mbox{\hyperlink{classGeomNode}{GeomNode}})\ gnode\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \textcolor{keywordflow}{if}\ (face\ \&\ MF\_front)\ \{}
\DoxyCodeLine{00350\ \ \ \ \ make\_vis\_mesh\_geom(gnode,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00351\ \ \ \}}
\DoxyCodeLine{00352\ }
\DoxyCodeLine{00353\ \ \ \textcolor{keywordflow}{if}\ (face\ \&\ MF\_back)\ \{}
\DoxyCodeLine{00354\ \ \ \ \ make\_vis\_mesh\_geom(gnode,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00355\ \ \ \}}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classNodePath}{NodePath}}(gnode);}
\DoxyCodeLine{00358\ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00366\ \textcolor{keywordtype}{double}\ PfmVizzer::}
\DoxyCodeLine{00367\ calc\_max\_u\_displacement()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00368\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ \_pfm.get\_x\_size();}
\DoxyCodeLine{00369\ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ \_pfm.get\_y\_size();}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \ \ \textcolor{keywordtype}{double}\ max\_u\ =\ 0;}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00374\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00379\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi\ =\ point[0]\ *\ (double)x\_size\ -\/\ 0.5;}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ \ \ \ \ max\_u\ =\ max(max\_u,\ cabs(nxi\ -\/\ (\textcolor{keywordtype}{double})xi));}
\DoxyCodeLine{00383\ \ \ \ \ \}}
\DoxyCodeLine{00384\ \ \ \}}
\DoxyCodeLine{00385\ }
\DoxyCodeLine{00386\ \ \ \textcolor{keywordflow}{return}\ max\_u;}
\DoxyCodeLine{00387\ \}}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00394\ \textcolor{keywordtype}{double}\ PfmVizzer::}
\DoxyCodeLine{00395\ calc\_max\_v\_displacement()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00396\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ \_pfm.get\_x\_size();}
\DoxyCodeLine{00397\ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ \_pfm.get\_y\_size();}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \ \ \textcolor{keywordtype}{double}\ max\_v\ =\ 0;}
\DoxyCodeLine{00400\ }
\DoxyCodeLine{00401\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nyi\ =\ point[1]\ *\ (double)y\_size\ -\/\ 0.5;}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \ \ \ \ \ \ max\_v\ =\ max(max\_v,\ cabs(nyi\ -\/\ (\textcolor{keywordtype}{double})yi));}
\DoxyCodeLine{00411\ \ \ \ \ \}}
\DoxyCodeLine{00412\ \ \ \}}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00414\ \ \ \textcolor{keywordflow}{return}\ max\_v;}
\DoxyCodeLine{00415\ \}}
\DoxyCodeLine{00416\ }
\DoxyCodeLine{00435\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00436\ make\_displacement(\mbox{\hyperlink{classPNMImage}{PNMImage}}\ \&result,\ \textcolor{keywordtype}{double}\ max\_u,\ \textcolor{keywordtype}{double}\ max\_v,\ \textcolor{keywordtype}{bool}\ for\_32bit)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00437\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ \_pfm.get\_x\_size();}
\DoxyCodeLine{00438\ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ \_pfm.get\_y\_size();}
\DoxyCodeLine{00439\ \ \ result.clear(x\_size,\ y\_size,\ 3,\ PNM\_MAXMAXVAL);}
\DoxyCodeLine{00440\ \ \ result.fill\_val(0,\ 0,\ PNM\_MAXMAXVAL);}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \ \ \textcolor{comment}{//\ After\ Effects\ defines\ this\ as\ the\ zero\ (no-\/change)\ value.\ \ It's\ not}}
\DoxyCodeLine{00443\ \ \ \textcolor{comment}{//\ exactly\ 0.5,\ because\ they\ round\ up.}}
\DoxyCodeLine{00444\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ midval\ =\ (PNM\_MAXMAXVAL\ +\ 1)\ /\ 2;}
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00446\ \ \ \textcolor{keywordtype}{double}\ scale\_factor;}
\DoxyCodeLine{00447\ \ \ \textcolor{keywordflow}{if}\ (for\_32bit)\ \{}
\DoxyCodeLine{00448\ \ \ \ \ \textcolor{comment}{//\ There\ doesn't\ appear\ to\ be\ an\ undershift\ needed\ on\ 32-\/bit\ projects,\ but}}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{comment}{//\ we\ have\ the\ factor\ here\ anyway\ in\ case\ it\ develops.}}
\DoxyCodeLine{00450\ \ \ \ \ scale\_factor\ =\ ae\_undershift\_factor\_32;}
\DoxyCodeLine{00451\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00452\ \ \ \ \ \textcolor{comment}{//\ Empirically,\ After\ Effects\ seems\ to\ undershift\ by\ precisely\ this\ amount}}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{comment}{//\ (but\ only\ in\ a\ 16-\/bit\ project,\ not\ in\ a\ 32-\/bit\ project).\ \ Curiously,}}
\DoxyCodeLine{00454\ \ \ \ \ \textcolor{comment}{//\ this\ value\ is\ very\ close\ to,\ but\ not\ exactly,\ 256\ \ 255.}}
\DoxyCodeLine{00455\ \ \ \ \ scale\_factor\ =\ ae\_undershift\_factor\_16;}
\DoxyCodeLine{00456\ \ \ \}}
\DoxyCodeLine{00457\ }
\DoxyCodeLine{00458\ \ \ \textcolor{keywordtype}{double}\ u\_scale\ =\ scale\_factor\ *\ 0.5\ *\ PNM\_MAXMAXVAL\ /\ max\_u;}
\DoxyCodeLine{00459\ \ \ \textcolor{keywordtype}{double}\ v\_scale\ =\ scale\_factor\ *\ 0.5\ *\ PNM\_MAXMAXVAL\ /\ max\_v;}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00466\ }
\DoxyCodeLine{00467\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi\ =\ point[0]\ *\ (double)x\_size\ -\/\ 0.5;}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nyi\ =\ point[1]\ *\ (double)y\_size\ -\/\ 0.5;}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00471\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ x\_shift\ =\ (nxi\ -\/\ (double)xi);}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ y\_shift\ =\ (nyi\ -\/\ (double)yi);}
\DoxyCodeLine{00473\ }
\DoxyCodeLine{00474\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ u\_val\ =\ midval\ +\ (int)cfloor(x\_shift\ *\ u\_scale\ +\ 0.5);}
\DoxyCodeLine{00475\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ v\_val\ =\ midval\ +\ (int)cfloor(y\_shift\ *\ v\_scale\ +\ 0.5);}
\DoxyCodeLine{00476\ }
\DoxyCodeLine{00477\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ use\ the\ blue\ channel\ to\ mark\ holes,\ so\ we\ can\ fill\ them\ in\ later.}}
\DoxyCodeLine{00478\ \ \ \ \ \ \ result.set\_xel\_val(xi,\ yi,}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(max(u\_val,\ 0),\ PNM\_MAXMAXVAL),}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(max(v\_val,\ 0),\ PNM\_MAXMAXVAL),}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0);}
\DoxyCodeLine{00482\ \ \ \ \ \}}
\DoxyCodeLine{00483\ \ \ \}}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ \textcolor{comment}{//\ Now\ fill\ in\ holes.}}
\DoxyCodeLine{00486\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00487\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00491\ }
\DoxyCodeLine{00492\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi\ =\ point[0]\ *\ (double)x\_size\ -\/\ 0.5;}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nyi\ =\ point[1]\ *\ (double)y\_size\ -\/\ 0.5;}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00496\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi\ -\/\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00497\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi\ +\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00498\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ -\/\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00499\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ +\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00500\ \ \ \ \ \}}
\DoxyCodeLine{00501\ \ \ \}}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ \textcolor{comment}{//\ Finally,\ reset\ the\ blue\ channel\ for\ cleanliness.}}
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00506\ \ \ \ \ \ \ result.set\_blue\_val(xi,\ yi,\ midval);}
\DoxyCodeLine{00507\ \ \ \ \ \}}
\DoxyCodeLine{00508\ \ \ \}}
\DoxyCodeLine{00509\ \}}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00529\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00530\ make\_displacement(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&result,\ \textcolor{keywordtype}{double}\ max\_u,\ \textcolor{keywordtype}{double}\ max\_v,\ \textcolor{keywordtype}{bool}\ for\_32bit)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00531\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ \_pfm.get\_x\_size();}
\DoxyCodeLine{00532\ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ \_pfm.get\_y\_size();}
\DoxyCodeLine{00533\ \ \ result.clear(x\_size,\ y\_size,\ 3);}
\DoxyCodeLine{00534\ }
\DoxyCodeLine{00535\ \ \ \textcolor{keywordtype}{double}\ scale\_factor;}
\DoxyCodeLine{00536\ \ \ \textcolor{keywordflow}{if}\ (for\_32bit)\ \{}
\DoxyCodeLine{00537\ \ \ \ \ \textcolor{comment}{//\ There\ doesn't\ appear\ to\ be\ an\ undershift\ needed\ on\ 32-\/bit\ projects,\ but}}
\DoxyCodeLine{00538\ \ \ \ \ \textcolor{comment}{//\ we\ have\ the\ factor\ here\ anyway\ in\ case\ it\ develops.}}
\DoxyCodeLine{00539\ \ \ \ \ scale\_factor\ =\ ae\_undershift\_factor\_32;}
\DoxyCodeLine{00540\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00541\ \ \ \ \ \textcolor{comment}{//\ Empirically,\ After\ Effects\ seems\ to\ undershift\ by\ precisely\ this\ amount}}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{comment}{//\ (but\ only\ in\ a\ 16-\/bit\ project,\ not\ in\ a\ 32-\/bit\ project).\ \ Curiously,}}
\DoxyCodeLine{00543\ \ \ \ \ \textcolor{comment}{//\ this\ value\ is\ very\ close\ to,\ but\ not\ exactly,\ 256\ \ 255.}}
\DoxyCodeLine{00544\ \ \ \ \ scale\_factor\ =\ ae\_undershift\_factor\_16;}
\DoxyCodeLine{00545\ \ \ \}}
\DoxyCodeLine{00546\ }
\DoxyCodeLine{00547\ \ \ \textcolor{keywordtype}{double}\ u\_scale\ =\ scale\_factor\ *\ 0.5\ /\ max\_u;}
\DoxyCodeLine{00548\ \ \ \textcolor{keywordtype}{double}\ v\_scale\ =\ scale\_factor\ *\ 0.5\ /\ max\_v;}
\DoxyCodeLine{00549\ }
\DoxyCodeLine{00550\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00551\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi\ =\ point[0]\ *\ (double)x\_size\ -\/\ 0.5;}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nyi\ =\ point[1]\ *\ (double)y\_size\ -\/\ 0.5;}
\DoxyCodeLine{00559\ }
\DoxyCodeLine{00560\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ x\_shift\ =\ (nxi\ -\/\ (double)xi);}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ y\_shift\ =\ (nyi\ -\/\ (double)yi);}
\DoxyCodeLine{00562\ }
\DoxyCodeLine{00563\ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ u\_val\ =\ 0.5\ +\ (float)(x\_shift\ *\ u\_scale);}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ v\_val\ =\ 0.5\ +\ (float)(y\_shift\ *\ v\_scale);}
\DoxyCodeLine{00565\ }
\DoxyCodeLine{00566\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ use\ the\ blue\ channel\ to\ mark\ holes,\ so\ we\ can\ fill\ them\ in\ later.}}
\DoxyCodeLine{00567\ \ \ \ \ \ \ result.set\_point3(xi,\ yi,\ LVecBase3f(u\_val,\ v\_val,\ 0));}
\DoxyCodeLine{00568\ \ \ \ \ \}}
\DoxyCodeLine{00569\ \ \ \}}
\DoxyCodeLine{00570\ }
\DoxyCodeLine{00571\ \ \ \textcolor{comment}{//\ Now\ fill\ in\ holes.}}
\DoxyCodeLine{00572\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00573\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi))\ \{}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&point\ =\ \_pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi\ =\ point[0]\ *\ (double)x\_size\ -\/\ 0.5;}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nyi\ =\ point[1]\ *\ (double)y\_size\ -\/\ 0.5;}
\DoxyCodeLine{00581\ }
\DoxyCodeLine{00582\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi\ -\/\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00583\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi\ +\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00584\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ -\/\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00585\ \ \ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ +\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ 1);}
\DoxyCodeLine{00586\ \ \ \ \ \}}
\DoxyCodeLine{00587\ \ \ \}}
\DoxyCodeLine{00588\ }
\DoxyCodeLine{00589\ \ \ \textcolor{comment}{//\ Finally,\ reset\ the\ blue\ channel\ for\ cleanliness.}}
\DoxyCodeLine{00590\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ 0;\ yi\ <\ y\_size;\ ++yi)\ \{}
\DoxyCodeLine{00591\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ 0;\ xi\ <\ x\_size;\ ++xi)\ \{}
\DoxyCodeLine{00592\ \ \ \ \ \ \ result.set\_channel(xi,\ yi,\ 2,\ 0.5);}
\DoxyCodeLine{00593\ \ \ \ \ \}}
\DoxyCodeLine{00594\ \ \ \}}
\DoxyCodeLine{00595\ \}}
\DoxyCodeLine{00596\ }
\DoxyCodeLine{00601\ \textcolor{keywordtype}{bool}\ PfmVizzer::}
\DoxyCodeLine{00602\ uses\_aux\_pfm()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00603\ \ \ \textcolor{keywordflow}{for}\ (VisColumns::const\_iterator\ vci\ =\ \_vis\_columns.begin();}
\DoxyCodeLine{00604\ \ \ \ \ \ \ \ vci\ !=\ \_vis\_columns.end();}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \ ++vci)\ \{}
\DoxyCodeLine{00606\ \ \ \ \ \textcolor{keyword}{const}\ VisColumn\ \&column\ =\ *vci;}
\DoxyCodeLine{00607\ \ \ \ \ \textcolor{keywordflow}{switch}\ (column.\_source)\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex1:}
\DoxyCodeLine{00609\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex2:}
\DoxyCodeLine{00610\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex3:}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00612\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00614\ \ \ \ \ \}}
\DoxyCodeLine{00615\ \ \ \}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00618\ \}}
\DoxyCodeLine{00619\ }
\DoxyCodeLine{00625\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00626\ r\_fill\_displacement(\mbox{\hyperlink{classPNMImage}{PNMImage}}\ \&result,\ \textcolor{keywordtype}{int}\ xi,\ \textcolor{keywordtype}{int}\ yi,}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi,\ \textcolor{keywordtype}{double}\ nyi,\ \textcolor{keywordtype}{double}\ u\_scale,\ \textcolor{keywordtype}{double}\ v\_scale,}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ distance)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00629\ \ \ \textcolor{keywordflow}{if}\ (xi\ <\ 0\ ||\ yi\ <\ 0\ ||}
\DoxyCodeLine{00630\ \ \ \ \ \ \ xi\ >=\ result.get\_x\_size()\ ||\ yi\ >=\ result.get\_y\_size())\ \{}
\DoxyCodeLine{00631\ \ \ \ \ \textcolor{comment}{//\ Stop\ at\ the\ edge.}}
\DoxyCodeLine{00632\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00633\ \ \ \}}
\DoxyCodeLine{00634\ }
\DoxyCodeLine{00635\ \ \ \textcolor{keywordflow}{if}\ (distance\ >\ 1000)\ \{}
\DoxyCodeLine{00636\ \ \ \ \ \textcolor{comment}{//\ Avoid\ runaway\ recursion.}}
\DoxyCodeLine{00637\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00638\ \ \ \}}
\DoxyCodeLine{00639\ }
\DoxyCodeLine{00640\ \ \ \textcolor{keywordtype}{int}\ val\ =\ result.get\_blue\_val(xi,\ yi);}
\DoxyCodeLine{00641\ \ \ \textcolor{keywordflow}{if}\ (val\ >\ distance)\ \{}
\DoxyCodeLine{00642\ \ \ \ \ \textcolor{comment}{//\ We've\ found\ a\ point\ that's\ closer.}}
\DoxyCodeLine{00643\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ midval\ =\ (PNM\_MAXMAXVAL\ +\ 1)\ /\ 2;}
\DoxyCodeLine{00644\ }
\DoxyCodeLine{00645\ \ \ \ \ \textcolor{keywordtype}{double}\ x\_shift\ =\ (nxi\ -\/\ (double)xi);}
\DoxyCodeLine{00646\ \ \ \ \ \textcolor{keywordtype}{double}\ y\_shift\ =\ (nyi\ -\/\ (double)yi);}
\DoxyCodeLine{00647\ \ \ \ \ \textcolor{keywordtype}{int}\ u\_val\ =\ midval\ +\ (int)cfloor(x\_shift\ *\ u\_scale\ +\ 0.5);}
\DoxyCodeLine{00648\ \ \ \ \ \textcolor{keywordtype}{int}\ v\_val\ =\ midval\ +\ (int)cfloor(y\_shift\ *\ v\_scale\ +\ 0.5);}
\DoxyCodeLine{00649\ \ \ \ \ result.set\_xel\_val(xi,\ yi,}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(max(u\_val,\ 0),\ PNM\_MAXMAXVAL),}
\DoxyCodeLine{00651\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(max(v\_val,\ 0),\ PNM\_MAXMAXVAL),}
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min(distance,\ PNM\_MAXMAXVAL));}
\DoxyCodeLine{00653\ }
\DoxyCodeLine{00654\ \ \ \ \ r\_fill\_displacement(result,\ xi\ -\/\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00655\ \ \ \ \ r\_fill\_displacement(result,\ xi\ +\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00656\ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ -\/\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00657\ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ +\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00658\ \ \ \}}
\DoxyCodeLine{00659\ \}}
\DoxyCodeLine{00660\ }
\DoxyCodeLine{00666\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00667\ r\_fill\_displacement(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&result,\ \textcolor{keywordtype}{int}\ xi,\ \textcolor{keywordtype}{int}\ yi,}
\DoxyCodeLine{00668\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ nxi,\ \textcolor{keywordtype}{double}\ nyi,\ \textcolor{keywordtype}{double}\ u\_scale,\ \textcolor{keywordtype}{double}\ v\_scale,}
\DoxyCodeLine{00669\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ distance)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00670\ \ \ \textcolor{keywordflow}{if}\ (xi\ <\ 0\ ||\ yi\ <\ 0\ ||}
\DoxyCodeLine{00671\ \ \ \ \ \ \ xi\ >=\ result.get\_x\_size()\ ||\ yi\ >=\ result.get\_y\_size())\ \{}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{comment}{//\ Stop\ at\ the\ edge.}}
\DoxyCodeLine{00673\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00674\ \ \ \}}
\DoxyCodeLine{00675\ }
\DoxyCodeLine{00676\ \ \ \textcolor{keywordflow}{if}\ (distance\ >\ 1000)\ \{}
\DoxyCodeLine{00677\ \ \ \ \ \textcolor{comment}{//\ Avoid\ runaway\ recursion.}}
\DoxyCodeLine{00678\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00679\ \ \ \}}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \ \ \textcolor{keywordtype}{float}\ val\ =\ result.get\_channel(xi,\ yi,\ 2);}
\DoxyCodeLine{00682\ \ \ \textcolor{keywordflow}{if}\ (val\ >\ (\textcolor{keywordtype}{float})distance)\ \{}
\DoxyCodeLine{00683\ \ \ \ \ \textcolor{comment}{//\ We've\ found\ a\ point\ that's\ closer.}}
\DoxyCodeLine{00684\ \ \ \ \ \textcolor{keywordtype}{double}\ x\_shift\ =\ (nxi\ -\/\ (double)xi);}
\DoxyCodeLine{00685\ \ \ \ \ \textcolor{keywordtype}{double}\ y\_shift\ =\ (nyi\ -\/\ (double)yi);}
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{keywordtype}{float}\ u\_val\ =\ 0.5\ +\ (float)(x\_shift\ *\ u\_scale);}
\DoxyCodeLine{00687\ \ \ \ \ \textcolor{keywordtype}{float}\ v\_val\ =\ 0.5\ +\ (float)(y\_shift\ *\ v\_scale);}
\DoxyCodeLine{00688\ \ \ \ \ result.set\_point3(xi,\ yi,\ LVecBase3f(u\_val,\ v\_val,\ distance));}
\DoxyCodeLine{00689\ }
\DoxyCodeLine{00690\ \ \ \ \ r\_fill\_displacement(result,\ xi\ -\/\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00691\ \ \ \ \ r\_fill\_displacement(result,\ xi\ +\ 1,\ yi,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00692\ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ -\/\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00693\ \ \ \ \ r\_fill\_displacement(result,\ xi,\ yi\ +\ 1,\ nxi,\ nyi,\ u\_scale,\ v\_scale,\ distance\ +\ 1);}
\DoxyCodeLine{00694\ \ \ \}}
\DoxyCodeLine{00695\ \}}
\DoxyCodeLine{00696\ }
\DoxyCodeLine{00701\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00702\ make\_vis\_mesh\_geom(\mbox{\hyperlink{classGeomNode}{GeomNode}}\ *gnode,\ \textcolor{keywordtype}{bool}\ inverted)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00703\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ keep\_beyond\_lens\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00704\ \ \ \textcolor{keywordtype}{int}\ num\_x\_cells\ =\ 1;}
\DoxyCodeLine{00705\ \ \ \textcolor{keywordtype}{int}\ num\_y\_cells\ =\ 1;}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ \_pfm.get\_x\_size();}
\DoxyCodeLine{00708\ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ \_pfm.get\_y\_size();}
\DoxyCodeLine{00709\ }
\DoxyCodeLine{00710\ \ \ \textcolor{comment}{//\ This\ is\ the\ number\ of\ independent\ vertices\ we\ will\ require.}}
\DoxyCodeLine{00711\ \ \ \textcolor{keywordtype}{int}\ num\_vertices\ =\ x\_size\ *\ y\_size;}
\DoxyCodeLine{00712\ \ \ \textcolor{keywordflow}{if}\ (num\_vertices\ ==\ 0)\ \{}
\DoxyCodeLine{00713\ \ \ \ \ \textcolor{comment}{//\ Trivial\ no-\/op.}}
\DoxyCodeLine{00714\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00715\ \ \ \}}
\DoxyCodeLine{00716\ }
\DoxyCodeLine{00717\ \ \ \textcolor{keywordtype}{bool}\ reverse\_normals\ =\ inverted;}
\DoxyCodeLine{00718\ \ \ \textcolor{keywordtype}{bool}\ reverse\_faces\ =\ inverted;}
\DoxyCodeLine{00719\ \ \ \textcolor{keywordflow}{if}\ (!is\_right\_handed(get\_default\_coordinate\_system()))\ \{}
\DoxyCodeLine{00720\ \ \ \ \ reverse\_faces\ =\ !reverse\_faces;}
\DoxyCodeLine{00721\ \ \ \}}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00723\ \ \ \textcolor{comment}{//\ This\ is\ the\ max\ number\ of\ vertex\ indices\ we\ might\ add\ to\ the}}
\DoxyCodeLine{00724\ \ \ \textcolor{comment}{//\ GeomTriangles.\ \ (We\ might\ actually\ add\ fewer\ than\ this\ due\ to\ omitting}}
\DoxyCodeLine{00725\ \ \ \textcolor{comment}{//\ the\ occasional\ missing\ data\ point.)}}
\DoxyCodeLine{00726\ \ \ \textcolor{keywordtype}{int}\ max\_indices\ =\ (x\_size\ -\/\ 1)\ *\ (y\_size\ -\/\ 1)\ *\ 6;}
\DoxyCodeLine{00727\ }
\DoxyCodeLine{00728\ \ \ \textcolor{keywordflow}{while}\ (num\_vertices\ >\ pfm\_vis\_max\_vertices\ ||\ max\_indices\ >\ pfm\_vis\_max\_indices)\ \{}
\DoxyCodeLine{00729\ \ \ \ \ \textcolor{comment}{//\ Too\ many\ vertices\ in\ one\ mesh.\ \ Subdivide\ the\ mesh\ into\ smaller\ pieces.}}
\DoxyCodeLine{00730\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_x\_cells\ >\ num\_y\_cells)\ \{}
\DoxyCodeLine{00731\ \ \ \ \ \ \ ++num\_y\_cells;}
\DoxyCodeLine{00732\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00733\ \ \ \ \ \ \ ++num\_x\_cells;}
\DoxyCodeLine{00734\ \ \ \ \ \}}
\DoxyCodeLine{00735\ }
\DoxyCodeLine{00736\ \ \ \ \ x\_size\ =\ (\_pfm.get\_x\_size()\ +\ num\_x\_cells\ -\/\ 1)\ /\ num\_x\_cells\ +\ 1;}
\DoxyCodeLine{00737\ \ \ \ \ y\_size\ =\ (\_pfm.get\_y\_size()\ +\ num\_y\_cells\ -\/\ 1)\ /\ num\_y\_cells\ +\ 1;}
\DoxyCodeLine{00738\ }
\DoxyCodeLine{00739\ \ \ \ \ num\_vertices\ =\ x\_size\ *\ y\_size;}
\DoxyCodeLine{00740\ \ \ \ \ max\_indices\ =\ (x\_size\ -\/\ 1)\ *\ (y\_size\ -\/\ 1)\ *\ 6;}
\DoxyCodeLine{00741\ \ \ \}}
\DoxyCodeLine{00742\ }
\DoxyCodeLine{00743\ \ \ \textcolor{comment}{//\ OK,\ now\ we\ know\ how\ many\ cells\ we\ need.}}
\DoxyCodeLine{00744\ \ \ \textcolor{keywordflow}{if}\ (grutil\_cat.is\_debug())\ \{}
\DoxyCodeLine{00745\ \ \ \ \ grutil\_cat.debug()}
\DoxyCodeLine{00746\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Generating\ mesh\ with\ "{}}\ <<\ num\_x\_cells\ <<\ \textcolor{stringliteral}{"{}\ x\ "{}}\ <<\ num\_y\_cells}
\DoxyCodeLine{00747\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ pieces.\(\backslash\)n"{}};}
\DoxyCodeLine{00748\ \ \ \}}
\DoxyCodeLine{00749\ }
\DoxyCodeLine{00750\ \ \ VisColumns\ vis\_columns\ =\ \_vis\_columns;}
\DoxyCodeLine{00751\ \ \ \textcolor{keywordflow}{if}\ (vis\_columns.empty())\ \{}
\DoxyCodeLine{00752\ \ \ \ \ build\_auto\_vis\_columns(vis\_columns,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00753\ \ \ \}}
\DoxyCodeLine{00754\ \ \ \textcolor{keywordtype}{bool}\ check\_aux\_pfm\ =\ uses\_aux\_pfm();}
\DoxyCodeLine{00755\ }
\DoxyCodeLine{00756\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ format\ =\ make\_array\_format(vis\_columns);}
\DoxyCodeLine{00757\ }
\DoxyCodeLine{00758\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yci\ =\ 0;\ yci\ <\ num\_y\_cells;\ ++yci)\ \{}
\DoxyCodeLine{00759\ \ \ \ \ \textcolor{keywordtype}{int}\ y\_begin\ =\ (yci\ *\ \_pfm.get\_y\_size())\ /\ num\_y\_cells;}
\DoxyCodeLine{00760\ \ \ \ \ \textcolor{keywordtype}{int}\ y\_end\ =\ ((yci\ +\ 1)\ *\ \_pfm.get\_y\_size())\ /\ num\_y\_cells;}
\DoxyCodeLine{00761\ }
\DoxyCodeLine{00762\ \ \ \ \ \textcolor{comment}{//\ Include\ the\ first\ vertex\ from\ the\ next\ strip\ in\ this\ strip's\ vertices,}}
\DoxyCodeLine{00763\ \ \ \ \ \textcolor{comment}{//\ so\ we\ are\ connected.}}
\DoxyCodeLine{00764\ \ \ \ \ y\_end\ =\ min(y\_end\ +\ 1,\ \_pfm.get\_y\_size());}
\DoxyCodeLine{00765\ }
\DoxyCodeLine{00766\ \ \ \ \ y\_size\ =\ y\_end\ -\/\ y\_begin;}
\DoxyCodeLine{00767\ \ \ \ \ \textcolor{keywordflow}{if}\ (y\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00768\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00769\ \ \ \ \ \}}
\DoxyCodeLine{00770\ }
\DoxyCodeLine{00771\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xci\ =\ 0;\ xci\ <\ num\_x\_cells;\ ++xci)\ \{}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ x\_begin\ =\ (xci\ *\ \_pfm.get\_x\_size())\ /\ num\_x\_cells;}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ x\_end\ =\ ((xci\ +\ 1)\ *\ \_pfm.get\_x\_size())\ /\ num\_x\_cells;}
\DoxyCodeLine{00774\ \ \ \ \ \ \ x\_end\ =\ min(x\_end\ +\ 1,\ \_pfm.get\_x\_size());}
\DoxyCodeLine{00775\ \ \ \ \ \ \ x\_size\ =\ x\_end\ -\/\ x\_begin;}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (x\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \ \ \ \ \ \ num\_vertices\ =\ x\_size\ *\ y\_size;}
\DoxyCodeLine{00781\ \ \ \ \ \ \ max\_indices\ =\ (x\_size\ -\/\ 1)\ *\ (y\_size\ -\/\ 1)\ *\ 6;}
\DoxyCodeLine{00782\ }
\DoxyCodeLine{00783\ \ \ \ \ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}}\ mesh\_name;}
\DoxyCodeLine{00784\ \ \ \ \ \ \ mesh\_name\ <<\ \textcolor{stringliteral}{"{}mesh\_"{}}\ <<\ xci\ <<\ \textcolor{stringliteral}{"{}\_"{}}\ <<\ yci;}
\DoxyCodeLine{00785\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00786\ \ \ \ \ \ \ \ \ (mesh\_name.str(),\ format,\ Geom::UH\_static);}
\DoxyCodeLine{00787\ }
\DoxyCodeLine{00788\ \ \ \ \ \ \ vdata-\/>set\_num\_rows(num\_vertices);}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *skip\_points\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{char}[num\_vertices];}
\DoxyCodeLine{00791\ \ \ \ \ \ \ memset(skip\_points,\ 0,\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char})\ *\ num\_vertices);}
\DoxyCodeLine{00792\ }
\DoxyCodeLine{00793\ \ \ \ \ \ \ \textcolor{comment}{//\ Fill\ in\ all\ of\ the\ vertices.}}
\DoxyCodeLine{00794\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (VisColumns::const\_iterator\ vci\ =\ vis\_columns.begin();}
\DoxyCodeLine{00795\ \ \ \ \ \ \ \ \ \ \ \ vci\ !=\ vis\_columns.end();}
\DoxyCodeLine{00796\ \ \ \ \ \ \ \ \ \ \ \ ++vci)\ \{}
\DoxyCodeLine{00797\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ VisColumn\ \&column\ =\ *vci;}
\DoxyCodeLine{00798\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vwriter(vdata,\ column.\_name);}
\DoxyCodeLine{00799\ \ \ \ \ \ \ \ \ vwriter.set\_row(0);}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00801\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ y\_begin;\ yi\ <\ y\_end;\ ++yi)\ \{}
\DoxyCodeLine{00802\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ x\_begin;\ xi\ <\ x\_end;\ ++xi)\ \{}
\DoxyCodeLine{00803\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!column.add\_data(*\textcolor{keyword}{this},\ vwriter,\ xi,\ yi,\ reverse\_normals))\ \{}
\DoxyCodeLine{00804\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ skip\_points[(yi\ -\/\ y\_begin)\ *\ x\_size\ +\ (xi\ -\/\ x\_begin)]\ =\ (char)\textcolor{keyword}{true};}
\DoxyCodeLine{00805\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00806\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00807\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00808\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00809\ }
\DoxyCodeLine{00810\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00811\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomTriangles}{GeomTriangles}})\ tris\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTriangles}{GeomTriangles}}(Geom::UH\_static);}
\DoxyCodeLine{00812\ }
\DoxyCodeLine{00813\ \ \ \ \ \ \ tris-\/>reserve\_num\_vertices(max\_indices);}
\DoxyCodeLine{00814\ }
\DoxyCodeLine{00815\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ yi\ =\ y\_begin;\ yi\ <\ y\_end\ -\/\ 1;\ ++yi)\ \{}
\DoxyCodeLine{00816\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ xi\ =\ x\_begin;\ xi\ <\ x\_end\ -\/\ 1;\ ++xi)\ \{}
\DoxyCodeLine{00817\ }
\DoxyCodeLine{00818\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_pfm.has\_point(xi,\ yi)\ ||}
\DoxyCodeLine{00819\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_pfm.has\_point(xi,\ yi\ +\ 1)\ ||}
\DoxyCodeLine{00820\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_pfm.has\_point(xi\ +\ 1,\ yi\ +\ 1)\ ||}
\DoxyCodeLine{00821\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_pfm.has\_point(xi\ +\ 1,\ yi))\ \{}
\DoxyCodeLine{00822\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00823\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00824\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (check\_aux\_pfm\ \&\&\ (!\_aux\_pfm-\/>has\_point(xi,\ yi)\ ||}
\DoxyCodeLine{00825\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_aux\_pfm-\/>has\_point(xi,\ yi\ +\ 1)\ ||}
\DoxyCodeLine{00826\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_aux\_pfm-\/>has\_point(xi\ +\ 1,\ yi\ +\ 1)\ ||}
\DoxyCodeLine{00827\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !\_aux\_pfm-\/>has\_point(xi\ +\ 1,\ yi)))\ \{}
\DoxyCodeLine{00828\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00829\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00830\ }
\DoxyCodeLine{00831\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!keep\_beyond\_lens\ \&\&}
\DoxyCodeLine{00832\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (skip\_points[(yi\ -\/\ y\_begin)\ *\ x\_size\ +\ (xi\ -\/\ x\_begin)]\ ||}
\DoxyCodeLine{00833\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ skip\_points[(yi\ -\/\ y\_begin\ +\ 1)\ *\ x\_size\ +\ (xi\ -\/\ x\_begin)]\ ||}
\DoxyCodeLine{00834\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ skip\_points[(yi\ -\/\ y\_begin)\ *\ x\_size\ +\ (xi\ -\/\ x\_begin\ +\ 1)]\ ||}
\DoxyCodeLine{00835\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ skip\_points[(yi\ -\/\ y\_begin\ +\ 1)\ *\ x\_size\ +\ (xi\ -\/\ x\_begin\ +\ 1)]))\ \{}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00838\ }
\DoxyCodeLine{00839\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ xi0\ =\ xi\ -\/\ x\_begin;}
\DoxyCodeLine{00840\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ yi0\ =\ yi\ -\/\ y\_begin;}
\DoxyCodeLine{00841\ }
\DoxyCodeLine{00842\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vi0\ =\ ((xi0)\ +\ (yi0)\ *\ x\_size);}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vi1\ =\ ((xi0)\ +\ (yi0\ +\ 1)\ *\ x\_size);}
\DoxyCodeLine{00844\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vi2\ =\ ((xi0\ +\ 1)\ +\ (yi0\ +\ 1)\ *\ x\_size);}
\DoxyCodeLine{00845\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vi3\ =\ ((xi0\ +\ 1)\ +\ (yi0)\ *\ x\_size);}
\DoxyCodeLine{00846\ }
\DoxyCodeLine{00847\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (reverse\_faces)\ \{}
\DoxyCodeLine{00848\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>add\_vertices(vi2,\ vi0,\ vi1);}
\DoxyCodeLine{00849\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>close\_primitive();}
\DoxyCodeLine{00850\ }
\DoxyCodeLine{00851\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>add\_vertices(vi3,\ vi0,\ vi2);}
\DoxyCodeLine{00852\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>close\_primitive();}
\DoxyCodeLine{00853\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00854\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>add\_vertices(vi2,\ vi1,\ vi0);}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>close\_primitive();}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>add\_vertices(vi3,\ vi2,\ vi0);}
\DoxyCodeLine{00858\ \ \ \ \ \ \ \ \ \ \ \ \ tris-\/>close\_primitive();}
\DoxyCodeLine{00859\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00860\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00862\ \ \ \ \ \ \ geom-\/>add\_primitive(tris);}
\DoxyCodeLine{00863\ \ \ \ \ \ \ gnode-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom);}
\DoxyCodeLine{00864\ }
\DoxyCodeLine{00865\ \ \ \ \ \ \ \textcolor{keyword}{delete}[]\ skip\_points;}
\DoxyCodeLine{00866\ \ \ \ \ \}}
\DoxyCodeLine{00867\ \ \ \}}
\DoxyCodeLine{00868\ \}}
\DoxyCodeLine{00869\ }
\DoxyCodeLine{00874\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00875\ add\_vis\_column(VisColumns\ \&vis\_columns,\ ColumnType\ source,\ ColumnType\ target,}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,}
\DoxyCodeLine{00877\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLens}{Lens}}\ *lens,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ *undist\_lut)\ \{}
\DoxyCodeLine{00878\ \ \ VisColumn\ column;}
\DoxyCodeLine{00879\ \ \ column.\_source\ =\ source;}
\DoxyCodeLine{00880\ \ \ column.\_target\ =\ target;}
\DoxyCodeLine{00881\ \ \ column.\_name\ =\ name;}
\DoxyCodeLine{00882\ \ \ column.\_transform\ =\ transform;}
\DoxyCodeLine{00883\ \ \ \textcolor{keywordflow}{if}\ (transform\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00884\ \ \ \ \ column.\_transform\ =\ TransformState::make\_identity();}
\DoxyCodeLine{00885\ \ \ \}}
\DoxyCodeLine{00886\ \ \ column.\_lens\ =\ lens;}
\DoxyCodeLine{00887\ \ \ \textcolor{keywordflow}{if}\ (undist\_lut\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ undist\_lut-\/>is\_valid())\ \{}
\DoxyCodeLine{00888\ \ \ \ \ column.\_undist\_lut\ =\ undist\_lut;}
\DoxyCodeLine{00889\ \ \ \}}
\DoxyCodeLine{00890\ \ \ vis\_columns.push\_back(column);}
\DoxyCodeLine{00891\ \}}
\DoxyCodeLine{00892\ }
\DoxyCodeLine{00899\ \textcolor{keywordtype}{void}\ PfmVizzer::}
\DoxyCodeLine{00900\ build\_auto\_vis\_columns(VisColumns\ \&vis\_columns,\ \textcolor{keywordtype}{bool}\ for\_points)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00901\ \ \ vis\_columns.clear();}
\DoxyCodeLine{00902\ }
\DoxyCodeLine{00903\ \ \ \textcolor{keywordflow}{if}\ (\_vis\_2d)\ \{}
\DoxyCodeLine{00904\ \ \ \ \ \textcolor{comment}{//\ No\ normals\ needed\ if\ we're\ just\ generating\ a\ 2-\/d\ mesh.}}
\DoxyCodeLine{00905\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_vis\_inverse)\ \{}
\DoxyCodeLine{00906\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_texcoord2,\ CT\_vertex2,\ InternalName::get\_vertex());}
\DoxyCodeLine{00907\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_vertex2,\ CT\_texcoord2,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00908\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00909\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_vertex2,\ CT\_vertex2,\ InternalName::get\_vertex());}
\DoxyCodeLine{00910\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_texcoord2,\ CT\_texcoord2,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00911\ \ \ \ \ \}}
\DoxyCodeLine{00912\ }
\DoxyCodeLine{00913\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00914\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_vis\_inverse)\ \{}
\DoxyCodeLine{00915\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ need\ a\ 3-\/d\ texture\ coordinate\ if\ we're\ inverting\ the\ vis\ and\ it's}}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \textcolor{comment}{//\ 3-\/d.\ \ But\ we\ still\ don't\ need\ normals\ in\ that\ case.}}
\DoxyCodeLine{00917\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_texcoord3,\ CT\_vertex3,\ InternalName::get\_vertex());}
\DoxyCodeLine{00918\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_vertex3,\ CT\_texcoord3,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00919\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00920\ \ \ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ only\ need\ a\ 2-\/d\ texture\ coordinate,\ and\ we\ do\ want}}
\DoxyCodeLine{00921\ \ \ \ \ \ \ \textcolor{comment}{//\ normals.}}
\DoxyCodeLine{00922\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_vertex3,\ CT\_vertex3,\ InternalName::get\_vertex());}
\DoxyCodeLine{00923\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_normal3,\ CT\_normal3,\ InternalName::get\_normal());}
\DoxyCodeLine{00924\ \ \ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_texcoord2,\ CT\_texcoord2,\ InternalName::get\_texcoord());}
\DoxyCodeLine{00925\ \ \ \ \ \}}
\DoxyCodeLine{00926\ \ \ \}}
\DoxyCodeLine{00927\ }
\DoxyCodeLine{00928\ \ \ \textcolor{keywordflow}{if}\ (\_flat\_texcoord\_name\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00929\ \ \ \ \ \textcolor{comment}{//\ We\ need\ an\ additional\ texcoord\ column\ for\ the\ flat\ texcoords.}}
\DoxyCodeLine{00930\ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_texcoord2,\ CT\_texcoord2,\ \_flat\_texcoord\_name);}
\DoxyCodeLine{00931\ \ \ \}}
\DoxyCodeLine{00932\ }
\DoxyCodeLine{00933\ \ \ \textcolor{keywordflow}{if}\ (\_vis\_blend\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00934\ \ \ \ \ \textcolor{comment}{//\ The\ blend\ map,\ if\ specified,\ also\ gets\ applied\ to\ the\ vertices.}}
\DoxyCodeLine{00935\ \ \ \ \ add\_vis\_column(vis\_columns,\ CT\_blend1,\ CT\_blend1,\ InternalName::get\_color());}
\DoxyCodeLine{00936\ \ \ \}}
\DoxyCodeLine{00937\ \}}
\DoxyCodeLine{00938\ }
\DoxyCodeLine{00942\ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ PfmVizzer::}
\DoxyCodeLine{00943\ make\_array\_format(\textcolor{keyword}{const}\ VisColumns\ \&vis\_columns)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00944\ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}};}
\DoxyCodeLine{00945\ }
\DoxyCodeLine{00946\ \ \ \textcolor{keywordflow}{for}\ (VisColumns::const\_iterator\ vci\ =\ vis\_columns.begin();}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \ vci\ !=\ vis\_columns.end();}
\DoxyCodeLine{00948\ \ \ \ \ \ \ \ ++vci)\ \{}
\DoxyCodeLine{00949\ \ \ \ \ \textcolor{keyword}{const}\ VisColumn\ \&column\ =\ *vci;}
\DoxyCodeLine{00950\ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ column.\_name;}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00952\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_components\ =\ 0;}
\DoxyCodeLine{00953\ \ \ \ \ GeomEnums::NumericType\ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00954\ \ \ \ \ GeomEnums::Contents\ contents\ =\ GeomEnums::C\_point;}
\DoxyCodeLine{00955\ \ \ \ \ \textcolor{keywordflow}{switch}\ (column.\_target)\ \{}
\DoxyCodeLine{00956\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_texcoord2:}
\DoxyCodeLine{00957\ \ \ \ \ \ \ num\_components\ =\ 2;}
\DoxyCodeLine{00958\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00959\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_texcoord;}
\DoxyCodeLine{00960\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_texcoord3:}
\DoxyCodeLine{00963\ \ \ \ \ \ \ num\_components\ =\ 3;}
\DoxyCodeLine{00964\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00965\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_texcoord;}
\DoxyCodeLine{00966\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00967\ }
\DoxyCodeLine{00968\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_vertex1:}
\DoxyCodeLine{00969\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex1:}
\DoxyCodeLine{00970\ \ \ \ \ \ \ num\_components\ =\ 1;}
\DoxyCodeLine{00971\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00972\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_point;}
\DoxyCodeLine{00973\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00974\ }
\DoxyCodeLine{00975\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_vertex2:}
\DoxyCodeLine{00976\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex2:}
\DoxyCodeLine{00977\ \ \ \ \ \ \ num\_components\ =\ 2;}
\DoxyCodeLine{00978\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00979\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_point;}
\DoxyCodeLine{00980\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00981\ }
\DoxyCodeLine{00982\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_vertex3:}
\DoxyCodeLine{00983\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex3:}
\DoxyCodeLine{00984\ \ \ \ \ \ \ num\_components\ =\ 3;}
\DoxyCodeLine{00985\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00986\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_point;}
\DoxyCodeLine{00987\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00988\ }
\DoxyCodeLine{00989\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_normal3:}
\DoxyCodeLine{00990\ \ \ \ \ \ \ num\_components\ =\ 3;}
\DoxyCodeLine{00991\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_float32;}
\DoxyCodeLine{00992\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_normal;}
\DoxyCodeLine{00993\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00994\ }
\DoxyCodeLine{00995\ \ \ \ \ \textcolor{keywordflow}{case}\ CT\_blend1:}
\DoxyCodeLine{00996\ \ \ \ \ \ \ num\_components\ =\ 4;}
\DoxyCodeLine{00997\ \ \ \ \ \ \ numeric\_type\ =\ GeomEnums::NT\_uint8;}
\DoxyCodeLine{00998\ \ \ \ \ \ \ contents\ =\ GeomEnums::C\_color;}
\DoxyCodeLine{00999\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01000\ \ \ \ \ \}}
\DoxyCodeLine{01001\ \ \ \ \ nassertr(num\_components\ !=\ 0,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01002\ }
\DoxyCodeLine{01003\ \ \ \ \ array\_format-\/>add\_column(name,\ num\_components,\ numeric\_type,\ contents);}
\DoxyCodeLine{01004\ \ \ \}}
\DoxyCodeLine{01005\ }
\DoxyCodeLine{01006\ \ \ \textcolor{keywordflow}{return}\ GeomVertexFormat::register\_format(array\_format);}
\DoxyCodeLine{01007\ \}}
\DoxyCodeLine{01008\ }
\DoxyCodeLine{01013\ \textcolor{keywordtype}{bool}\ PfmVizzer::VisColumn::}
\DoxyCodeLine{01014\ add\_data(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmVizzer}{PfmVizzer}}\ \&vizzer,\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ \&vwriter,\ \textcolor{keywordtype}{int}\ xi,\ \textcolor{keywordtype}{int}\ yi,\ \textcolor{keywordtype}{bool}\ reverse\_normals)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01015\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm\ =\ vizzer.get\_pfm();}
\DoxyCodeLine{01016\ \ \ \textcolor{keywordtype}{bool}\ success\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01017\ }
\DoxyCodeLine{01018\ \ \ \textcolor{keywordflow}{switch}\ (\_source)\ \{}
\DoxyCodeLine{01019\ \ \ \textcolor{keywordflow}{case}\ CT\_texcoord2:}
\DoxyCodeLine{01020\ \ \ \ \ \{}
\DoxyCodeLine{01021\ \ \ \ \ \ \ LPoint2f\ uv((PN\_float32(xi)\ +\ 0.5)\ /\ PN\_float32(pfm.get\_x\_size()),}
\DoxyCodeLine{01022\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (PN\_float32(yi)\ +\ 0.5)\ /\ PN\_float32(pfm.get\_y\_size()));}
\DoxyCodeLine{01023\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(uv))\ \{}
\DoxyCodeLine{01024\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01025\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01026\ \ \ \ \ \ \ vwriter.set\_data2f(uv);}
\DoxyCodeLine{01027\ \ \ \ \ \}}
\DoxyCodeLine{01028\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01029\ }
\DoxyCodeLine{01030\ \ \ \textcolor{keywordflow}{case}\ CT\_texcoord3:}
\DoxyCodeLine{01031\ \ \ \ \ \{}
\DoxyCodeLine{01032\ \ \ \ \ \ \ LPoint3f\ uv((PN\_float32(xi)\ +\ 0.5)\ /\ PN\_float32(pfm.get\_x\_size()),}
\DoxyCodeLine{01033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (PN\_float32(yi)\ +\ 0.5)\ /\ PN\_float32(pfm.get\_y\_size()),}
\DoxyCodeLine{01034\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0f);}
\DoxyCodeLine{01035\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(uv))\ \{}
\DoxyCodeLine{01036\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01037\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01038\ \ \ \ \ \ \ vwriter.set\_data3f(uv);}
\DoxyCodeLine{01039\ \ \ \ \ \}}
\DoxyCodeLine{01040\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01041\ }
\DoxyCodeLine{01042\ \ \ \textcolor{keywordflow}{case}\ CT\_vertex1:}
\DoxyCodeLine{01043\ \ \ \ \ \{}
\DoxyCodeLine{01044\ \ \ \ \ \ \ PN\_float32\ p\ =\ pfm.get\_point1(xi,\ yi);}
\DoxyCodeLine{01045\ \ \ \ \ \ \ LPoint2f\ point(p,\ 0.0);}
\DoxyCodeLine{01046\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01047\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01048\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01049\ \ \ \ \ \ \ vwriter.set\_data2f(point);}
\DoxyCodeLine{01050\ \ \ \ \ \}}
\DoxyCodeLine{01051\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01052\ }
\DoxyCodeLine{01053\ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex1:}
\DoxyCodeLine{01054\ \ \ \ \ \{}
\DoxyCodeLine{01055\ \ \ \ \ \ \ nassertr(vizzer.get\_aux\_pfm()\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{01056\ \ \ \ \ \ \ PN\_float32\ p\ =\ vizzer.get\_aux\_pfm()-\/>get\_point1(xi,\ yi);}
\DoxyCodeLine{01057\ \ \ \ \ \ \ LPoint2f\ point(p,\ 0.0);}
\DoxyCodeLine{01058\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01059\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01060\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01061\ \ \ \ \ \ \ vwriter.set\_data2f(point);}
\DoxyCodeLine{01062\ \ \ \ \ \}}
\DoxyCodeLine{01063\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01064\ }
\DoxyCodeLine{01065\ \ \ \textcolor{keywordflow}{case}\ CT\_vertex2:}
\DoxyCodeLine{01066\ \ \ \ \ \{}
\DoxyCodeLine{01067\ \ \ \ \ \ \ LPoint2f\ point\ =\ pfm.get\_point2(xi,\ yi);}
\DoxyCodeLine{01068\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01069\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01070\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01071\ \ \ \ \ \ \ vwriter.set\_data2f(point);}
\DoxyCodeLine{01072\ \ \ \ \ \}}
\DoxyCodeLine{01073\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01074\ }
\DoxyCodeLine{01075\ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex2:}
\DoxyCodeLine{01076\ \ \ \ \ \{}
\DoxyCodeLine{01077\ \ \ \ \ \ \ nassertr(vizzer.get\_aux\_pfm()\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{01078\ \ \ \ \ \ \ LPoint2f\ point\ =\ vizzer.get\_aux\_pfm()-\/>get\_point2(xi,\ yi);}
\DoxyCodeLine{01079\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01080\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01081\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01082\ \ \ \ \ \ \ vwriter.set\_data2f(point);}
\DoxyCodeLine{01083\ \ \ \ \ \}}
\DoxyCodeLine{01084\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01085\ }
\DoxyCodeLine{01086\ \ \ \textcolor{keywordflow}{case}\ CT\_vertex3:}
\DoxyCodeLine{01087\ \ \ \ \ \{}
\DoxyCodeLine{01088\ \ \ \ \ \ \ LPoint3f\ point\ =\ pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{01089\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01090\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01091\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01092\ \ \ \ \ \ \ vwriter.set\_data3f(point);}
\DoxyCodeLine{01093\ \ \ \ \ \}}
\DoxyCodeLine{01094\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01095\ }
\DoxyCodeLine{01096\ \ \ \textcolor{keywordflow}{case}\ CT\_aux\_vertex3:}
\DoxyCodeLine{01097\ \ \ \ \ \{}
\DoxyCodeLine{01098\ \ \ \ \ \ \ LPoint3f\ point\ =\ vizzer.get\_aux\_pfm()-\/>get\_point(xi,\ yi);}
\DoxyCodeLine{01099\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_point(point))\ \{}
\DoxyCodeLine{01100\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01102\ \ \ \ \ \ \ vwriter.set\_data3f(point);}
\DoxyCodeLine{01103\ \ \ \ \ \}}
\DoxyCodeLine{01104\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01105\ }
\DoxyCodeLine{01106\ \ \ \textcolor{keywordflow}{case}\ CT\_normal3:}
\DoxyCodeLine{01107\ \ \ \ \ \{}
\DoxyCodeLine{01108\ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ the\ normal\ based\ on\ two\ neighboring\ vertices.}}
\DoxyCodeLine{01109\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ flip\ =\ reverse\_normals;}
\DoxyCodeLine{01110\ }
\DoxyCodeLine{01111\ \ \ \ \ \ \ LPoint3f\ v[3];}
\DoxyCodeLine{01112\ \ \ \ \ \ \ v[0]\ =\ pfm.get\_point(xi,\ yi);}
\DoxyCodeLine{01113\ \ \ \ \ \ \ v[1]\ =\ v[0];}
\DoxyCodeLine{01114\ \ \ \ \ \ \ v[2]\ =\ v[0];}
\DoxyCodeLine{01115\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pfm.has\_point(xi\ +\ 1,\ yi))\ \{}
\DoxyCodeLine{01116\ \ \ \ \ \ \ \ \ v[1]\ =\ pfm.get\_point(xi\ +\ 1,\ yi);}
\DoxyCodeLine{01117\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pfm.has\_point(xi\ -\/\ 1,\ yi))\ \{}
\DoxyCodeLine{01118\ \ \ \ \ \ \ \ \ v[1]\ =\ pfm.get\_point(xi\ -\/\ 1,\ yi);}
\DoxyCodeLine{01119\ \ \ \ \ \ \ \ \ flip\ =\ !flip;}
\DoxyCodeLine{01120\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01121\ }
\DoxyCodeLine{01122\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pfm.has\_point(xi,\ yi\ +\ 1))\ \{}
\DoxyCodeLine{01123\ \ \ \ \ \ \ \ \ v[2]\ =\ pfm.get\_point(xi,\ yi\ +\ 1);}
\DoxyCodeLine{01124\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pfm.has\_point(xi,\ yi\ -\/\ 1))\ \{}
\DoxyCodeLine{01125\ \ \ \ \ \ \ \ \ v[2]\ =\ pfm.get\_point(xi,\ yi\ -\/\ 1);}
\DoxyCodeLine{01126\ \ \ \ \ \ \ \ \ flip\ =\ !flip;}
\DoxyCodeLine{01127\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01128\ }
\DoxyCodeLine{01129\ \ \ \ \ \ \ LVector3f\ n\ =\ LVector3f::zero();}
\DoxyCodeLine{01130\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 3;\ ++i)\ \{}
\DoxyCodeLine{01131\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&v0\ =\ v[i];}
\DoxyCodeLine{01132\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3f\ \&v1\ =\ v[(i\ +\ 1)\ \%\ 3];}
\DoxyCodeLine{01133\ \ \ \ \ \ \ \ \ n[0]\ +=\ v0[1]\ *\ v1[2]\ -\/\ v0[2]\ *\ v1[1];}
\DoxyCodeLine{01134\ \ \ \ \ \ \ \ \ n[1]\ +=\ v0[2]\ *\ v1[0]\ -\/\ v0[0]\ *\ v1[2];}
\DoxyCodeLine{01135\ \ \ \ \ \ \ \ \ n[2]\ +=\ v0[0]\ *\ v1[1]\ -\/\ v0[1]\ *\ v1[0];}
\DoxyCodeLine{01136\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01137\ \ \ \ \ \ \ n.normalize();}
\DoxyCodeLine{01138\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (n.is\_nan())\ \{}
\DoxyCodeLine{01139\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{01140\ \textcolor{comment}{\ \ \ \ \ \ \ \ cerr\ <<\ "{}\(\backslash\)nnan!\(\backslash\)n"{}}}
\DoxyCodeLine{01141\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ "{}\ \ v[0]\ =\ "{}\ <<\ v[0]\ <<\ "{}\(\backslash\)n"{}}}
\DoxyCodeLine{01142\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ "{}\ \ v[1]\ =\ "{}\ <<\ v[1]\ <<\ "{}\(\backslash\)n"{}}}
\DoxyCodeLine{01143\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ "{}\ \ v[2]\ =\ "{}\ <<\ v[2]\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{01144\ \textcolor{comment}{\ \ \ \ \ \ \ \ */}}
\DoxyCodeLine{01145\ \ \ \ \ \ \ \ \ n.set(0,\ 0,\ 0);}
\DoxyCodeLine{01146\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01147\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01148\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (flip)\ \{}
\DoxyCodeLine{01149\ \ \ \ \ \ \ \ \ n\ =\ -\/n;}
\DoxyCodeLine{01150\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01151\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform\_vector(n))\ \{}
\DoxyCodeLine{01152\ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01153\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01154\ \ \ \ \ \ \ vwriter.set\_data3f(n);}
\DoxyCodeLine{01155\ \ \ \ \ \}}
\DoxyCodeLine{01156\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01157\ }
\DoxyCodeLine{01158\ \ \ \textcolor{keywordflow}{case}\ CT\_blend1:}
\DoxyCodeLine{01159\ \ \ \ \ \{}
\DoxyCodeLine{01160\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPNMImage}{PNMImage}}\ *vis\_blend\ =\ vizzer.get\_vis\_blend();}
\DoxyCodeLine{01161\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vis\_blend\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01162\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ gray\ =\ vis\_blend-\/>get\_gray(xi,\ yi);}
\DoxyCodeLine{01163\ \ \ \ \ \ \ \ \ vwriter.set\_data3d(gray,\ gray,\ gray);}
\DoxyCodeLine{01164\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01165\ \ \ \ \ \}}
\DoxyCodeLine{01166\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01167\ \ \ \}}
\DoxyCodeLine{01168\ }
\DoxyCodeLine{01169\ \ \ \textcolor{keywordflow}{return}\ success;}
\DoxyCodeLine{01170\ \}}
\DoxyCodeLine{01171\ }
\DoxyCodeLine{01175\ \textcolor{keywordtype}{bool}\ PfmVizzer::VisColumn::}
\DoxyCodeLine{01176\ transform\_point(LPoint2f\ \&point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01177\ \ \ \textcolor{keywordtype}{bool}\ success\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01178\ \ \ \textcolor{keywordflow}{if}\ (!\_transform-\/>is\_identity())\ \{}
\DoxyCodeLine{01179\ \ \ \ \ LCAST(PN\_float32,\ \_transform-\/>get\_mat3()).xform\_point\_in\_place(point);}
\DoxyCodeLine{01180\ \ \ \}}
\DoxyCodeLine{01181\ }
\DoxyCodeLine{01182\ \ \ \textcolor{keywordflow}{return}\ success;}
\DoxyCodeLine{01183\ \}}
\DoxyCodeLine{01184\ }
\DoxyCodeLine{01188\ \textcolor{keywordtype}{bool}\ PfmVizzer::VisColumn::}
\DoxyCodeLine{01189\ transform\_point(LPoint3f\ \&point)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01190\ \ \ \textcolor{keywordtype}{bool}\ success\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01191\ \ \ \textcolor{keywordflow}{if}\ (!\_transform-\/>is\_identity())\ \{}
\DoxyCodeLine{01192\ \ \ \ \ LCAST(PN\_float32,\ \_transform-\/>get\_mat()).xform\_point\_in\_place(point);}
\DoxyCodeLine{01193\ \ \ \}}
\DoxyCodeLine{01194\ \ \ \textcolor{keywordflow}{if}\ (\_lens\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01195\ \ \ \ \ \textcolor{keyword}{static}\ LMatrix4f\ to\_uv(0.5,\ 0.0,\ 0.0,\ 0.0,}
\DoxyCodeLine{01196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0,\ 0.5,\ 0.0,\ 0.0,}
\DoxyCodeLine{01197\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.0,\ 0.0,\ 1.0,\ 0.0,}
\DoxyCodeLine{01198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0.5,\ 0.5,\ 0.0,\ 1.0);}
\DoxyCodeLine{01199\ \ \ \ \ LPoint3\ film;}
\DoxyCodeLine{01200\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_lens-\/>project(LCAST(PN\_stdfloat,\ point),\ film))\ \{}
\DoxyCodeLine{01201\ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01202\ \ \ \ \ \}}
\DoxyCodeLine{01203\ \ \ \ \ point\ =\ to\_uv.xform\_point(LCAST(PN\_float32,\ film));}
\DoxyCodeLine{01204\ \ \ \}}
\DoxyCodeLine{01205\ }
\DoxyCodeLine{01206\ \ \ \textcolor{keywordflow}{if}\ (\_undist\_lut\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01207\ \ \ \ \ LPoint3f\ p;}
\DoxyCodeLine{01208\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_undist\_lut-\/>calc\_bilinear\_point(p,\ point[0],\ 1.0\ -\/\ point[1]))\ \{}
\DoxyCodeLine{01209\ \ \ \ \ \ \ \textcolor{comment}{//\ Point\ is\ missing.}}
\DoxyCodeLine{01210\ \ \ \ \ \ \ point.set(0,\ 0,\ 0);}
\DoxyCodeLine{01211\ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01212\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01213\ \ \ \ \ \ \ point\ =\ p;}
\DoxyCodeLine{01214\ \ \ \ \ \ \ point[1]\ =\ 1.0\ -\/\ point[1];}
\DoxyCodeLine{01215\ \ \ \ \ \}}
\DoxyCodeLine{01216\ \ \ \}}
\DoxyCodeLine{01217\ }
\DoxyCodeLine{01218\ \ \ \textcolor{keywordflow}{return}\ success;}
\DoxyCodeLine{01219\ \}}
\DoxyCodeLine{01220\ }
\DoxyCodeLine{01224\ \textcolor{keywordtype}{bool}\ PfmVizzer::VisColumn::}
\DoxyCodeLine{01225\ transform\_vector(LVector3f\ \&vec)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01226\ \ \ \textcolor{keywordflow}{if}\ (!\_transform-\/>is\_identity())\ \{}
\DoxyCodeLine{01227\ \ \ \ \ LCAST(PN\_float32,\ \_transform-\/>get\_mat()).xform\_vec\_in\_place(vec);}
\DoxyCodeLine{01228\ \ \ \}}
\DoxyCodeLine{01229\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01230\ \}}

\end{DoxyCode}
