\doxysection{download\+Db.\+cxx}
\hypertarget{downloadDb_8cxx_source}{}\label{downloadDb_8cxx_source}\index{panda/src/downloader/downloadDb.cxx@{panda/src/downloader/downloadDb.cxx}}
\mbox{\hyperlink{downloadDb_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__downloader_8h}{config\_downloader.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{downloadDb_8h}{downloadDb.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{streamReader_8h}{streamReader.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{streamWriter_8h}{streamWriter.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ramfile_8h}{ramfile.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{using\ }std::endl;}
\DoxyCodeLine{00024\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00025\ \textcolor{keyword}{using\ }\mbox{\hyperlink{classstd_1_1istringstream}{std::istringstream}};}
\DoxyCodeLine{00026\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00027\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{comment}{//\ Defines}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{comment}{//\ Written\ at\ the\ top\ of\ the\ file\ so\ we\ know\ this\ is\ a\ downloadDb}}
\DoxyCodeLine{00032\ uint32\_t\ DownloadDb::\_magic\_number\ =\ 0xfeedfeed;}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{comment}{//\ Written\ at\ the\ top\ of\ the\ file\ to\ signify\ we\ are\ not\ done\ writing\ to\ the}}
\DoxyCodeLine{00035\ \textcolor{comment}{//\ file\ yet.\ \ If\ you\ load\ a\ db\ with\ this\ magic\ number\ that\ means\ the\ previous}}
\DoxyCodeLine{00036\ \textcolor{comment}{//\ time\ it\ got\ written\ out\ was\ probably\ interrupted\ in\ the\ middle\ of\ the}}
\DoxyCodeLine{00037\ \textcolor{comment}{//\ write.}}
\DoxyCodeLine{00038\ uint32\_t\ DownloadDb::\_bogus\_magic\_number\ =\ 0x11111111;}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{string}}
\DoxyCodeLine{00042\ back\_to\_front\_slash(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&str)\ \{}
\DoxyCodeLine{00043\ \ \ \textcolor{keywordtype}{string}\ result\ =\ str;}
\DoxyCodeLine{00044\ \ \ string::iterator\ si;}
\DoxyCodeLine{00045\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ result.begin();\ si\ !=\ result.end();\ ++si)\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*si)\ ==\ \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'})\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ (*si)\ =\ \textcolor{charliteral}{'/'};}
\DoxyCodeLine{00048\ \ \ \ \ \}}
\DoxyCodeLine{00049\ \ \ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00052\ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00058\ DownloadDb::}
\DoxyCodeLine{00059\ DownloadDb(\mbox{\hyperlink{classRamfile}{Ramfile}}\ \&server\_file,\ \mbox{\hyperlink{classFilename}{Filename}}\ \&client\_file)\ \{}
\DoxyCodeLine{00060\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00061\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00062\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb\ constructor\ called"{}}\ <<\ endl;}
\DoxyCodeLine{00063\ \ \ \}}
\DoxyCodeLine{00064\ \ \ \_client\_db\ =\ read\_db(client\_file,\ 0);}
\DoxyCodeLine{00065\ \ \ \_client\_db.\_filename\ =\ client\_file;}
\DoxyCodeLine{00066\ \ \ \_server\_db\ =\ read\_db(server\_file,\ 1);}
\DoxyCodeLine{00067\ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00072\ DownloadDb::}
\DoxyCodeLine{00073\ DownloadDb(\mbox{\hyperlink{classFilename}{Filename}}\ \&server\_file,\ \mbox{\hyperlink{classFilename}{Filename}}\ \&client\_file)\ \{}
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00075\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00076\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb\ constructor\ called"{}}\ <<\ endl;}
\DoxyCodeLine{00077\ \ \ \}}
\DoxyCodeLine{00078\ \ \ \_client\_db\ =\ read\_db(client\_file,\ 0);}
\DoxyCodeLine{00079\ \ \ \_client\_db.\_filename\ =\ client\_file;}
\DoxyCodeLine{00080\ \ \ \_server\_db\ =\ read\_db(server\_file,\ 1);}
\DoxyCodeLine{00081\ \ \ \_server\_db.\_filename\ =\ server\_file;}
\DoxyCodeLine{00082\ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00087\ DownloadDb::}
\DoxyCodeLine{00088\ DownloadDb()\ \{}
\DoxyCodeLine{00089\ \ \ \_client\_db\ =\ Db();}
\DoxyCodeLine{00090\ \ \ \_server\_db\ =\ Db();}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00096\ DownloadDb::}
\DoxyCodeLine{00097\ \string~DownloadDb()\ \{}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00099\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00100\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb\ destructor\ called"{}}\ <<\ endl;}
\DoxyCodeLine{00101\ \ \ \}}
\DoxyCodeLine{00102\ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00108\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00109\ output(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00110\ \ \ out\ <<\ \textcolor{stringliteral}{"{}["{}}\ <<\ \_server\_db.\_filename\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ \_client\_db.\_filename\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00111\ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00116\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00117\ write(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00118\ \ \ out\ <<\ \textcolor{stringliteral}{"{}DownloadDb"{}}\ <<\ endl;}
\DoxyCodeLine{00119\ \ \ out\ <<\ \textcolor{stringliteral}{"{}============================================================"{}}\ <<\ endl;}
\DoxyCodeLine{00120\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ Client\ DB\ file:\ "{}}\ <<\ \_client\_db.\_filename\ <<\ endl;}
\DoxyCodeLine{00121\ \ \ out\ <<\ \textcolor{stringliteral}{"{}============================================================"{}}\ <<\ endl;}
\DoxyCodeLine{00122\ \ \ \_client\_db.write(out);}
\DoxyCodeLine{00123\ \ \ out\ <<\ endl;}
\DoxyCodeLine{00124\ \ \ out\ <<\ \textcolor{stringliteral}{"{}============================================================"{}}\ <<\ endl;}
\DoxyCodeLine{00125\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ Server\ DB\ file:\ "{}}\ <<\ \_server\_db.\_filename\ <<\ endl;}
\DoxyCodeLine{00126\ \ \ out\ <<\ \textcolor{stringliteral}{"{}============================================================"{}}\ <<\ endl;}
\DoxyCodeLine{00127\ \ \ \_server\_db.write(out);}
\DoxyCodeLine{00128\ \ \ write\_version\_map(out);}
\DoxyCodeLine{00129\ \ \ out\ <<\ endl;}
\DoxyCodeLine{00130\ \}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00136\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00137\ write\_client\_db(\mbox{\hyperlink{classFilename}{Filename}}\ \&file)\ \{}
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{return}\ write\_db(file,\ \_client\_db,\ 0);}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00145\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00146\ write\_server\_db(\mbox{\hyperlink{classFilename}{Filename}}\ \&file)\ \{}
\DoxyCodeLine{00147\ \ \ \textcolor{keywordflow}{return}\ write\_db(file,\ \_server\_db,\ 1);}
\DoxyCodeLine{00148\ \}}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00153\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00154\ client\_multifile\_exists(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{return}\ (\_client\_db.multifile\_exists(mfname));}
\DoxyCodeLine{00156\ \}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00162\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00163\ client\_multifile\_complete(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordtype}{int}\ client\_status\ =\ \_client\_db.get\_multifile\_record\_named(mfname)-\/>\_status;}
\DoxyCodeLine{00165\ \ \ \textcolor{keywordflow}{return}\ (client\_status\ >=\ Status\_complete);}
\DoxyCodeLine{00166\ \}}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00171\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00172\ client\_multifile\_decompressed(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00173\ \ \ \textcolor{keywordtype}{int}\ client\_status\ =\ \_client\_db.get\_multifile\_record\_named(mfname)-\/>\_status;}
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{return}\ (client\_status\ >=\ Status\_decompressed);}
\DoxyCodeLine{00175\ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00180\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00181\ client\_multifile\_extracted(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordtype}{int}\ client\_status\ =\ \_client\_db.get\_multifile\_record\_named(mfname)-\/>\_status;}
\DoxyCodeLine{00183\ \ \ \textcolor{keywordflow}{return}\ (client\_status\ >=\ Status\_extracted);}
\DoxyCodeLine{00184\ \}}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00190\ \mbox{\hyperlink{classHashVal}{HashVal}}\ DownloadDb::}
\DoxyCodeLine{00191\ get\_client\_multifile\_hash(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{return}\ \_client\_db.get\_multifile\_record\_named(mfname)-\/>\_hash;}
\DoxyCodeLine{00193\ \}}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00199\ \mbox{\hyperlink{classHashVal}{HashVal}}\ DownloadDb::}
\DoxyCodeLine{00200\ get\_server\_multifile\_hash(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{return}\ \_server\_db.get\_multifile\_record\_named(mfname)-\/>\_hash;}
\DoxyCodeLine{00202\ \}}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00208\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00209\ set\_client\_multifile\_hash(\textcolor{keywordtype}{string}\ mfname,\ \mbox{\hyperlink{classHashVal}{HashVal}}\ val)\ \{}
\DoxyCodeLine{00210\ \ \ \_client\_db.get\_multifile\_record\_named(mfname)-\/>\_hash\ =\ val;}
\DoxyCodeLine{00211\ \ \ write\_client\_db(\_client\_db.\_filename);}
\DoxyCodeLine{00212\ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00218\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00219\ set\_server\_multifile\_hash(\textcolor{keywordtype}{string}\ mfname,\ \mbox{\hyperlink{classHashVal}{HashVal}}\ val)\ \{}
\DoxyCodeLine{00220\ \ \ \_server\_db.get\_multifile\_record\_named(mfname)-\/>\_hash\ =\ val;}
\DoxyCodeLine{00221\ \}}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00223\ \textcolor{comment}{//\ Operations\ on\ multifiles}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00228\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00229\ delete\_client\_multifile(\textcolor{keywordtype}{string}\ mfname)\ \{}
\DoxyCodeLine{00230\ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00235\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00236\ add\_client\_multifile(\textcolor{keywordtype}{string}\ server\_mfname)\ \{}
\DoxyCodeLine{00237\ \ \ PT(MultifileRecord)\ server\_mfr\ =\ \_server\_db.get\_multifile\_record\_named(server\_mfname);}
\DoxyCodeLine{00238\ \ \ PT(MultifileRecord)\ client\_mfr\ =\ \textcolor{keyword}{new}\ MultifileRecord;}
\DoxyCodeLine{00239\ \ \ client\_mfr-\/>\_name\ =\ server\_mfr-\/>\_name;}
\DoxyCodeLine{00240\ \ \ client\_mfr-\/>\_phase\ =\ server\_mfr-\/>\_phase;}
\DoxyCodeLine{00241\ \ \ \_client\_db.add\_multifile\_record(client\_mfr);}
\DoxyCodeLine{00242\ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00248\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00249\ expand\_client\_multifile(\textcolor{keywordtype}{string}\ mfname)\ \{}
\DoxyCodeLine{00250\ \}}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00256\ \mbox{\hyperlink{classDownloadDb_1_1Db}{DownloadDb::Db}}\ DownloadDb::}
\DoxyCodeLine{00257\ read\_db(\mbox{\hyperlink{classFilename}{Filename}}\ \&file,\ \textcolor{keywordtype}{bool}\ want\_server\_info)\ \{}
\DoxyCodeLine{00258\ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{00259\ \ \ Db\ db;}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \textcolor{comment}{//\ Open\ the\ multifile\ for\ reading}}
\DoxyCodeLine{00262\ \ \ file.set\_binary();}
\DoxyCodeLine{00263\ \ \ istream\ *read\_stream\ =\ vfs-\/>open\_read\_file(file,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \ \ \textcolor{keywordflow}{if}\ (read\_stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00266\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00267\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}failed\ to\ open\ input\ file:\ "{}}}
\DoxyCodeLine{00268\ \ \ \ \ \ \ <<\ file\ <<\ endl;}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordflow}{return}\ db;}
\DoxyCodeLine{00270\ \ \ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \mbox{\hyperlink{classStreamReader}{StreamReader}}\ sr(*read\_stream);}
\DoxyCodeLine{00273\ \ \ \textcolor{keywordflow}{if}\ (!db.read(sr,\ want\_server\_info))\ \{}
\DoxyCodeLine{00274\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00275\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}read\ failed:\ "{}}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ <<\ file\ <<\ endl;}
\DoxyCodeLine{00277\ \ \ \ \ vfs-\/>close\_read\_file(read\_stream);}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{keywordflow}{return}\ db;}
\DoxyCodeLine{00279\ \ \ \}}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \textcolor{keywordflow}{if}\ (want\_server\_info)\ \{}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordflow}{if}\ (!read\_version\_map(sr))\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}read\_version\_map()\ failed:\ "{}}}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ <<\ file\ <<\ endl;}
\DoxyCodeLine{00286\ \ \ \ \ \}}
\DoxyCodeLine{00287\ \ \ \}}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ vfs-\/>close\_read\_file(read\_stream);}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00291\ \ \ \textcolor{keywordflow}{return}\ db;}
\DoxyCodeLine{00292\ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00297\ \mbox{\hyperlink{classDownloadDb_1_1Db}{DownloadDb::Db}}\ DownloadDb::}
\DoxyCodeLine{00298\ read\_db(\mbox{\hyperlink{classRamfile}{Ramfile}}\ \&file,\ \textcolor{keywordtype}{bool}\ want\_server\_info)\ \{}
\DoxyCodeLine{00299\ \ \ \textcolor{comment}{//\ Open\ the\ multifile\ for\ reading}}
\DoxyCodeLine{00300\ \ \ \mbox{\hyperlink{classstd_1_1istringstream}{istringstream}}\ read\_stream(file.\_data);}
\DoxyCodeLine{00301\ \ \ Db\ db;}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00303\ \ \ \mbox{\hyperlink{classStreamReader}{StreamReader}}\ sr(read\_stream);}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \ \ \textcolor{keywordflow}{if}\ (!db.read(sr,\ want\_server\_info))\ \{}
\DoxyCodeLine{00306\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00307\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}read\ failed"{}}\ <<\ endl;}
\DoxyCodeLine{00308\ \ \ \ \ \textcolor{keywordflow}{return}\ db;}
\DoxyCodeLine{00309\ \ \ \}}
\DoxyCodeLine{00310\ \ \ \textcolor{keywordflow}{if}\ (want\_server\_info)\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordflow}{if}\ (!read\_version\_map(sr))\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}read\_version\_map()\ failed"{}}\ <<\ endl;}
\DoxyCodeLine{00314\ \ \ \ \ \}}
\DoxyCodeLine{00315\ \ \ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \textcolor{keywordflow}{return}\ db;}
\DoxyCodeLine{00318\ \}}
\DoxyCodeLine{00319\ }
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00324\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{00325\ write\_db(\mbox{\hyperlink{classFilename}{Filename}}\ \&file,\ Db\ db,\ \textcolor{keywordtype}{bool}\ want\_server\_info)\ \{}
\DoxyCodeLine{00326\ \ \ pofstream\ write\_stream;}
\DoxyCodeLine{00327\ \ \ file.set\_binary();}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{if}\ (!file.\mbox{\hyperlink{classFilename_ad37a9d52c837218b01076de184dc5f4d}{open\_write}}(write\_stream))\ \{}
\DoxyCodeLine{00329\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00330\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::write\_db()\ -\/\ Failed\ to\ open\ output\ file:\ "{}}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ <<\ file\ <<\ endl;}
\DoxyCodeLine{00332\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00333\ \ \ \}}
\DoxyCodeLine{00334\ }
\DoxyCodeLine{00335\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00336\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00337\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Writing\ to\ file:\ "{}}\ <<\ file\ <<\ endl;}
\DoxyCodeLine{00338\ \ \ \}}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \mbox{\hyperlink{classStreamWriter}{StreamWriter}}\ sw(write\_stream);}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00342\ \ \ \textcolor{comment}{//\ Initialize\ the\ write\ stream\ with\ a\ bogus\ header}}
\DoxyCodeLine{00343\ \ \ db.write\_bogus\_header(sw);}
\DoxyCodeLine{00344\ \ \ db.write(sw,\ want\_server\_info);}
\DoxyCodeLine{00345\ \ \ \textcolor{keywordflow}{if}\ (want\_server\_info)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ write\_version\_map(sw);}
\DoxyCodeLine{00347\ \ \ \}}
\DoxyCodeLine{00348\ \ \ \textcolor{comment}{//\ Now\ write\ the\ real\ header}}
\DoxyCodeLine{00349\ \ \ db.write\_header(write\_stream);}
\DoxyCodeLine{00350\ \ \ write\_stream.close();}
\DoxyCodeLine{00351\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00352\ \}}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00358\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00359\ create\_new\_server\_db()\ \{}
\DoxyCodeLine{00360\ \ \ \_server\_db\ =\ Db();}
\DoxyCodeLine{00361\ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00367\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00368\ server\_add\_multifile(\textcolor{keywordtype}{string}\ mfname,\ Phase\ phase,\ \textcolor{keywordtype}{int}\ size,\ \textcolor{keywordtype}{int}\ status)\ \{}
\DoxyCodeLine{00369\ \ \ PT(MultifileRecord)\ mfr\ =\ \textcolor{keyword}{new}\ MultifileRecord(mfname,\ phase,\ size,\ status);}
\DoxyCodeLine{00370\ \ \ \_server\_db.add\_multifile\_record(mfr);}
\DoxyCodeLine{00371\ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00377\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00378\ server\_add\_file(\textcolor{keywordtype}{string}\ mfname,\ \textcolor{keywordtype}{string}\ fname)\ \{}
\DoxyCodeLine{00379\ \ \ \textcolor{comment}{//\ Make\ the\ new\ file\ record}}
\DoxyCodeLine{00380\ \ \ PT(FileRecord)\ fr\ =\ \textcolor{keyword}{new}\ FileRecord(fname);}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ \textcolor{comment}{//\ Find\ the\ multifile\ with\ mfname}}
\DoxyCodeLine{00383\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(MultifileRecord)\ >::iterator\ i\ =\ \_server\_db.\_mfile\_records.begin();}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordflow}{for}\ (;\ i\ !=\ \_server\_db.\_mfile\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordflow}{if}\ (mfname\ ==\ (*i)-\/>\_name)\ \{}
\DoxyCodeLine{00386\ \ \ \ \ \ \ (*i)-\/>add\_file\_record(fr);}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00388\ \ \ \ \ \}}
\DoxyCodeLine{00389\ \ \ \}}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ \textcolor{comment}{//\ Uh-\/oh,\ did\ not\ find\ it}}
\DoxyCodeLine{00392\ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Could\ not\ find\ record\ named\ "{}}}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ mfname\ <<\ \textcolor{stringliteral}{"{}\ in\ database\ "{}}\ <<\ endl;}
\DoxyCodeLine{00394\ \ \ nassertv(\textcolor{keyword}{false});}
\DoxyCodeLine{00395\ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00396\ \}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \textcolor{comment}{//\ Multifile\ methods}}
\DoxyCodeLine{00400\ }
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00405\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00406\ MultifileRecord()\ \{}
\DoxyCodeLine{00407\ \ \ \_name\ =\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00408\ \ \ \_phase\ =\ 0;}
\DoxyCodeLine{00409\ \ \ \_size\ =\ 0;}
\DoxyCodeLine{00410\ \ \ \_status\ =\ Status\_incomplete;}
\DoxyCodeLine{00411\ \}}
\DoxyCodeLine{00412\ }
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00417\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00418\ MultifileRecord(\textcolor{keywordtype}{string}\ name,\ Phase\ phase,\ \textcolor{keywordtype}{int}\ size,\ \textcolor{keywordtype}{int}\ status)\ \{}
\DoxyCodeLine{00419\ \ \ \_name\ =\ name;}
\DoxyCodeLine{00420\ \ \ \_phase\ =\ phase;}
\DoxyCodeLine{00421\ \ \ \_size\ =\ size;}
\DoxyCodeLine{00422\ \ \ \_status\ =\ status;}
\DoxyCodeLine{00423\ \}}
\DoxyCodeLine{00424\ }
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00429\ \textcolor{keywordtype}{void}\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00430\ write(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00431\ \ \ out\ <<\ \textcolor{stringliteral}{"{}=================================================="{}}\ <<\ endl;}
\DoxyCodeLine{00432\ \ \ out\ <<\ \textcolor{stringliteral}{"{}MultifileRecord:\ "{}}\ <<\ \_name\ \ \ \ <<\ endl}
\DoxyCodeLine{00433\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ \ \ phase:\ "{}}\ <<\ \_phase\ \ \ <<\ endl}
\DoxyCodeLine{00434\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ \ \ \ size:\ "{}}\ <<\ \_size\ \ \ \ <<\ endl}
\DoxyCodeLine{00435\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ \ status:\ "{}}\ <<\ \_status\ \ <<\ endl}
\DoxyCodeLine{00436\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ \ \ \ hash:\ "{}}\ <<\ \_hash.as\_dec()\ <<\ endl;}
\DoxyCodeLine{00437\ \ \ out\ <<\ \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/"{}}\ <<\ endl;}
\DoxyCodeLine{00438\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(FileRecord)\ >::const\_iterator\ i\ =\ \_file\_records.begin();}
\DoxyCodeLine{00439\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_file\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00440\ \ \ \ \ (*i)-\/>write(out);}
\DoxyCodeLine{00441\ \ \ \}}
\DoxyCodeLine{00442\ \}}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00444\ }
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00449\ \textcolor{keywordtype}{int}\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00450\ get\_num\_files()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00451\ \ \ \textcolor{keywordflow}{return}\ \_file\_records.size();}
\DoxyCodeLine{00452\ \}}
\DoxyCodeLine{00453\ }
\DoxyCodeLine{00457\ \textcolor{keywordtype}{string}\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00458\ get\_file\_name(\textcolor{keywordtype}{int}\ index)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00459\ \ \ \textcolor{keywordflow}{return}\ \_file\_records[index]-\/>\_name;}
\DoxyCodeLine{00460\ \}}
\DoxyCodeLine{00461\ }
\DoxyCodeLine{00462\ }
\DoxyCodeLine{00466\ \textcolor{keywordtype}{bool}\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00467\ file\_exists(\textcolor{keywordtype}{string}\ fname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00468\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(FileRecord)\ >::const\_iterator\ i\ =\ \_file\_records.begin();}
\DoxyCodeLine{00469\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_file\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{keywordflow}{if}\ (fname\ ==\ (*i)-\/>\_name)\ \{}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00472\ \ \ \ \ \}}
\DoxyCodeLine{00473\ \ \ \}}
\DoxyCodeLine{00474\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00475\ \}}
\DoxyCodeLine{00476\ }
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00481\ PT(\mbox{\hyperlink{classDownloadDb_1_1FileRecord}{DownloadDb::FileRecord}})\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00482\ get\_file\_record\_named(\textcolor{keywordtype}{string}\ fname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00483\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(FileRecord)\ >::const\_iterator\ i\ =\ \_file\_records.begin();}
\DoxyCodeLine{00484\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_file\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00485\ \ \ \ \ \textcolor{keywordflow}{if}\ (fname\ ==\ (*i)-\/>\_name)\ \{}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (*i);}
\DoxyCodeLine{00487\ \ \ \ \ \}}
\DoxyCodeLine{00488\ \ \ \}}
\DoxyCodeLine{00489\ \ \ \textcolor{comment}{//\ Did\ not\ find\ it,\ just\ return\ an\ empty\ version}}
\DoxyCodeLine{00490\ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Could\ not\ find\ record\ named\ "{}}}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ fname\ <<\ \textcolor{stringliteral}{"{}\ in\ multifile\ "{}}\ <<\ \_name\ <<\ endl;}
\DoxyCodeLine{00492\ \ \ PT(FileRecord)\ foo\ =\ \textcolor{keyword}{new}\ FileRecord;}
\DoxyCodeLine{00493\ \ \ nassertr(\textcolor{keyword}{false},\ foo);}
\DoxyCodeLine{00494\ \ \ \textcolor{keywordflow}{return}\ foo;}
\DoxyCodeLine{00495\ \}}
\DoxyCodeLine{00496\ }
\DoxyCodeLine{00497\ }
\DoxyCodeLine{00501\ \textcolor{keywordtype}{void}\ DownloadDb::MultifileRecord::}
\DoxyCodeLine{00502\ add\_file\_record(PT(FileRecord)\ fr)\ \{}
\DoxyCodeLine{00503\ \ \ \_file\_records.push\_back(fr);}
\DoxyCodeLine{00504\ \}}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \textcolor{comment}{//\ Db\ methods}}
\DoxyCodeLine{00509\ }
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ }
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00516\ DownloadDb::Db::}
\DoxyCodeLine{00517\ Db()\ \{}
\DoxyCodeLine{00518\ \ \ \textcolor{comment}{//\ The\ head\ is\ a\ magic\ number\ and\ the\ number\ of\ multifiles\ in\ the\ db}}
\DoxyCodeLine{00519\ \ \ \_header\_length\ =\ \textcolor{keyword}{sizeof}(\_magic\_number)\ +\ \textcolor{keyword}{sizeof}(int32\_t);}
\DoxyCodeLine{00520\ \}}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ }
\DoxyCodeLine{00526\ \textcolor{keywordtype}{void}\ DownloadDb::Db::}
\DoxyCodeLine{00527\ write(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00528\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(MultifileRecord)\ >::const\_iterator\ i\ =\ \_mfile\_records.begin();}
\DoxyCodeLine{00529\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_mfile\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00530\ \ \ \ \ (*i)-\/>write(out);}
\DoxyCodeLine{00531\ \ \ \}}
\DoxyCodeLine{00532\ \}}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ }
\DoxyCodeLine{00538\ \textcolor{keywordtype}{int}\ DownloadDb::Db::}
\DoxyCodeLine{00539\ get\_num\_multifiles()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00540\ \ \ \textcolor{keywordflow}{return}\ \_mfile\_records.size();}
\DoxyCodeLine{00541\ \}}
\DoxyCodeLine{00542\ }
\DoxyCodeLine{00546\ \textcolor{keywordtype}{string}\ DownloadDb::Db::}
\DoxyCodeLine{00547\ get\_multifile\_name(\textcolor{keywordtype}{int}\ index)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00548\ \ \ \textcolor{keywordflow}{return}\ \_mfile\_records[index]-\/>\_name;}
\DoxyCodeLine{00549\ \}}
\DoxyCodeLine{00550\ }
\DoxyCodeLine{00554\ \textcolor{keywordtype}{bool}\ DownloadDb::Db::}
\DoxyCodeLine{00555\ multifile\_exists(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00556\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(MultifileRecord)\ >::const\_iterator\ i\ =\ \_mfile\_records.begin();}
\DoxyCodeLine{00557\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_mfile\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00558\ \ \ \ \ \textcolor{keywordflow}{if}\ (mfname\ ==\ (*i)-\/>\_name)\ \{}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00560\ \ \ \ \ \}}
\DoxyCodeLine{00561\ \ \ \}}
\DoxyCodeLine{00562\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00563\ \}}
\DoxyCodeLine{00564\ }
\DoxyCodeLine{00568\ PT(\mbox{\hyperlink{classDownloadDb_1_1MultifileRecord}{DownloadDb::MultifileRecord}})\ DownloadDb::Db::}
\DoxyCodeLine{00569\ get\_multifile\_record\_named(\textcolor{keywordtype}{string}\ mfname)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00570\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(MultifileRecord)\ >::const\_iterator\ i\ =\ \_mfile\_records.begin();}
\DoxyCodeLine{00571\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_mfile\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00572\ \ \ \ \ \textcolor{keywordflow}{if}\ (mfname\ ==\ (*i)-\/>\_name)\ \{}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (*i);}
\DoxyCodeLine{00574\ \ \ \ \ \}}
\DoxyCodeLine{00575\ \ \ \}}
\DoxyCodeLine{00576\ \ \ \textcolor{comment}{//\ Did\ not\ find\ it,\ just\ return\ an\ empty\ version}}
\DoxyCodeLine{00577\ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Could\ not\ find\ record\ named\ "{}}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ mfname\ <<\ \textcolor{stringliteral}{"{}\ in\ database\ "{}}\ <<\ endl;}
\DoxyCodeLine{00579\ \ \ PT(MultifileRecord)\ foo\ =\ \textcolor{keyword}{new}\ MultifileRecord;}
\DoxyCodeLine{00580\ \ \ nassertr(\textcolor{keyword}{false},\ foo);}
\DoxyCodeLine{00581\ \ \ \textcolor{keywordflow}{return}\ foo;}
\DoxyCodeLine{00582\ \}}
\DoxyCodeLine{00583\ }
\DoxyCodeLine{00587\ \textcolor{keywordtype}{void}\ DownloadDb::Db::}
\DoxyCodeLine{00588\ add\_multifile\_record(PT(MultifileRecord)\ mfr)\ \{}
\DoxyCodeLine{00589\ \ \ \_mfile\_records.push\_back(mfr);}
\DoxyCodeLine{00590\ \}}
\DoxyCodeLine{00591\ }
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00596\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDownloadDb_1_1Db_a5a597d2a2a5b844b7a3de79933e6087c}{DownloadDb::Db::}}}
\DoxyCodeLine{00597\ \mbox{\hyperlink{classDownloadDb_1_1Db_a5a597d2a2a5b844b7a3de79933e6087c}{parse\_header}}(\mbox{\hyperlink{classDatagram}{Datagram}}\ dg)\ \{}
\DoxyCodeLine{00598\ \ \ \textcolor{comment}{//\ Make\ sure\ we\ have\ a\ good\ header}}
\DoxyCodeLine{00599\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ di(dg);}
\DoxyCodeLine{00600\ \ \ uint32\_t\ magic\_number\ =\ di.get\_uint32();}
\DoxyCodeLine{00601\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00602\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00603\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Parsed\ magic\ number:\ "{}}\ <<\ magic\_number\ <<\ endl;}
\DoxyCodeLine{00604\ \ \ \}}
\DoxyCodeLine{00605\ \ \ \textcolor{comment}{//\ If\ the\ magic\ number\ is\ equal\ to\ the\ bogus\ magic\ number\ it\ signifies\ that}}
\DoxyCodeLine{00606\ \ \ \textcolor{comment}{//\ the\ previous\ write\ was\ interrupted}}
\DoxyCodeLine{00607\ \ \ \textcolor{keywordflow}{if}\ (magic\_number\ ==\ \_bogus\_magic\_number)\ \{}
\DoxyCodeLine{00608\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00609\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::parse\_header()\ -\/\ "{}}}
\DoxyCodeLine{00610\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Bogus\ magic\ number,\ previous\ write\ incomplete:\ "{}}}
\DoxyCodeLine{00611\ \ \ \ \ \ \ <<\ magic\_number\ <<\ \textcolor{stringliteral}{"{}\ expected:\ "{}}\ <<\ \_magic\_number\ <<\ endl;}
\DoxyCodeLine{00612\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00613\ \ \ \}}
\DoxyCodeLine{00614\ \ \ \textcolor{comment}{//\ If\ the\ magic\ number\ does\ not\ match\ at\ all,\ something\ is\ really\ wrong}}
\DoxyCodeLine{00615\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (magic\_number\ !=\ \_magic\_number)\ \{}
\DoxyCodeLine{00616\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00617\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::parse\_header()\ -\/\ Invalid\ magic\ number:\ "{}}}
\DoxyCodeLine{00618\ \ \ \ \ \ \ <<\ magic\_number\ <<\ \textcolor{stringliteral}{"{}\ expected:\ "{}}\ <<\ \_magic\_number\ <<\ endl;}
\DoxyCodeLine{00619\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00620\ \ \ \}}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ \ \ int32\_t\ num\_multifiles\ =\ di.get\_int32();}
\DoxyCodeLine{00623\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00624\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00625\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Parsed\ number\ of\ multifiles:\ "{}}\ <<\ num\_multifiles\ <<\ endl;}
\DoxyCodeLine{00626\ \ \ \}}
\DoxyCodeLine{00627\ }
\DoxyCodeLine{00628\ \ \ \textcolor{comment}{//\ If\ we\ got\ all\ the\ way\ here,\ must\ be\ done}}
\DoxyCodeLine{00629\ \ \ \textcolor{keywordflow}{return}\ num\_multifiles;}
\DoxyCodeLine{00630\ \}}
\DoxyCodeLine{00631\ }
\DoxyCodeLine{00632\ }
\DoxyCodeLine{00633\ }
\DoxyCodeLine{00638\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDownloadDb_1_1Db_ac7350eca77a5f596ce30ed74adb7ab81}{DownloadDb::Db::}}}
\DoxyCodeLine{00639\ \mbox{\hyperlink{classDownloadDb_1_1Db_ac7350eca77a5f596ce30ed74adb7ab81}{parse\_record\_header}}(\mbox{\hyperlink{classDatagram}{Datagram}}\ dg)\ \{}
\DoxyCodeLine{00640\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ di(dg);}
\DoxyCodeLine{00641\ \ \ int32\_t\ record\_length\ =\ di.get\_int32();}
\DoxyCodeLine{00642\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00643\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00644\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Parsed\ record\ header\ length:\ "{}}\ <<\ record\_length\ <<\ endl;}
\DoxyCodeLine{00645\ \ \ \}}
\DoxyCodeLine{00646\ }
\DoxyCodeLine{00647\ \ \ \textcolor{comment}{//\ If\ we\ got\ all\ the\ way\ here,\ must\ be\ done}}
\DoxyCodeLine{00648\ \ \ \textcolor{keywordflow}{return}\ record\_length;}
\DoxyCodeLine{00649\ \}}
\DoxyCodeLine{00650\ }
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00655\ PT(\mbox{\hyperlink{classDownloadDb_1_1MultifileRecord}{DownloadDb::MultifileRecord}})\ DownloadDb::Db::}
\DoxyCodeLine{00656\ parse\_mfr(\mbox{\hyperlink{classDatagram}{Datagram}}\ dg)\ \{}
\DoxyCodeLine{00657\ }
\DoxyCodeLine{00658\ \ \ PT(\mbox{\hyperlink{classDownloadDb_1_1MultifileRecord}{DownloadDb::MultifileRecord}})\ mfr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classDownloadDb_1_1MultifileRecord}{DownloadDb::MultifileRecord}};}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ di(dg);}
\DoxyCodeLine{00661\ \ \ mfr-\/>\_name\ =\ di.get\_string32();}
\DoxyCodeLine{00662\ \ \ mfr-\/>\_phase\ =\ di.get\_float64();}
\DoxyCodeLine{00663\ \ \ mfr-\/>\_size\ =\ di.get\_int32();}
\DoxyCodeLine{00664\ \ \ mfr-\/>\_status\ =\ di.get\_int32();}
\DoxyCodeLine{00665\ \ \ mfr-\/>\_num\_files\ =\ di.get\_int32();}
\DoxyCodeLine{00666\ }
\DoxyCodeLine{00667\ \ \ \textcolor{comment}{//\ At\ one\ time,\ we\ stored\ files\ in\ the\ database\ with\ a\ backslash\ separator.}}
\DoxyCodeLine{00668\ \ \ \textcolor{comment}{//\ Nowadays\ we\ use\ a\ forward\ slash,\ but\ we\ should\ make\ sure\ we\ properly}}
\DoxyCodeLine{00669\ \ \ \textcolor{comment}{//\ convert\ any\ old\ records\ we\ might\ read.}}
\DoxyCodeLine{00670\ \ \ mfr-\/>\_name\ =\ back\_to\_front\_slash(mfr-\/>\_name);}
\DoxyCodeLine{00671\ }
\DoxyCodeLine{00672\ \ \ \textcolor{comment}{//\ Read\ the\ hash\ value}}
\DoxyCodeLine{00673\ \ \ mfr-\/>\_hash.read\_datagram(di);}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00676\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00677\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Parsed\ multifile\ record:\ "{}}\ <<\ mfr-\/>\_name\ <<\ \textcolor{stringliteral}{"{}\ phase:\ "{}}\ <<\ mfr-\/>\_phase}
\DoxyCodeLine{00678\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ size:\ "{}}\ <<\ mfr-\/>\_size\ <<\ \textcolor{stringliteral}{"{}\ status:\ "{}}\ <<\ mfr-\/>\_status}
\DoxyCodeLine{00679\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ num\_files:\ "{}}\ <<\ mfr-\/>\_num\_files\ <<\ endl;}
\DoxyCodeLine{00680\ \ \ \}}
\DoxyCodeLine{00681\ }
\DoxyCodeLine{00682\ \ \ \textcolor{comment}{//\ Return\ the\ new\ MultifileRecord}}
\DoxyCodeLine{00683\ \ \ \textcolor{keywordflow}{return}\ mfr;}
\DoxyCodeLine{00684\ \}}
\DoxyCodeLine{00685\ }
\DoxyCodeLine{00686\ }
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00688\ }
\DoxyCodeLine{00692\ PT(\mbox{\hyperlink{classDownloadDb_1_1FileRecord}{DownloadDb::FileRecord}})\ DownloadDb::Db::}
\DoxyCodeLine{00693\ parse\_fr(\mbox{\hyperlink{classDatagram}{Datagram}}\ dg)\ \{}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00695\ \ \ PT(\mbox{\hyperlink{classDownloadDb_1_1FileRecord}{DownloadDb::FileRecord}})\ fr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classDownloadDb_1_1FileRecord}{DownloadDb::FileRecord}};}
\DoxyCodeLine{00696\ }
\DoxyCodeLine{00697\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ di(dg);}
\DoxyCodeLine{00698\ \ \ fr-\/>\_name\ =\ di.get\_string32();}
\DoxyCodeLine{00699\ }
\DoxyCodeLine{00700\ \ \ \textcolor{comment}{//\ At\ one\ time,\ we\ stored\ files\ in\ the\ database\ with\ a\ backslash\ separator.}}
\DoxyCodeLine{00701\ \ \ \textcolor{comment}{//\ Nowadays\ we\ use\ a\ forward\ slash,\ but\ we\ should\ make\ sure\ we\ properly}}
\DoxyCodeLine{00702\ \ \ \textcolor{comment}{//\ convert\ any\ old\ records\ we\ might\ read.}}
\DoxyCodeLine{00703\ \ \ fr-\/>\_name\ =\ back\_to\_front\_slash(fr-\/>\_name);}
\DoxyCodeLine{00704\ }
\DoxyCodeLine{00705\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00706\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00707\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Parsed\ file\ record:\ "{}}\ <<\ fr-\/>\_name\ <<\ endl;}
\DoxyCodeLine{00708\ \ \ \}}
\DoxyCodeLine{00709\ }
\DoxyCodeLine{00710\ \ \ \textcolor{comment}{//\ Return\ the\ new\ MultifileRecord}}
\DoxyCodeLine{00711\ \ \ \textcolor{keywordflow}{return}\ fr;}
\DoxyCodeLine{00712\ \}}
\DoxyCodeLine{00713\ }
\DoxyCodeLine{00714\ }
\DoxyCodeLine{00715\ }
\DoxyCodeLine{00716\ }
\DoxyCodeLine{00720\ \textcolor{keywordtype}{bool}\ DownloadDb::Db::}
\DoxyCodeLine{00721\ read(\mbox{\hyperlink{classStreamReader}{StreamReader}}\ \&sr,\ \textcolor{keywordtype}{bool}\ want\_server\_info)\ \{}
\DoxyCodeLine{00722\ \ \ \textcolor{comment}{//\ Read\ the\ header}}
\DoxyCodeLine{00723\ \ \ vector\_uchar\ header\ =\ sr.\mbox{\hyperlink{classStreamReader_aa9f42d679a6c6c4f6e7ebdd797050696}{extract\_bytes}}(\_header\_length);}
\DoxyCodeLine{00724\ \ \ \textcolor{keywordflow}{if}\ (header.size()\ !=\ (\textcolor{keywordtype}{size\_t})\_header\_length)\ \{}
\DoxyCodeLine{00725\ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}truncated\ db\ file"{}}\ <<\ endl;}
\DoxyCodeLine{00726\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00727\ \ \ \}}
\DoxyCodeLine{00728\ }
\DoxyCodeLine{00729\ \ \ \textcolor{comment}{//\ Parse\ the\ header}}
\DoxyCodeLine{00730\ \ \ \textcolor{keywordtype}{int}\ num\_multifiles\ =\ parse\_header(\mbox{\hyperlink{classDatagram}{Datagram}}(std::move(header)));}
\DoxyCodeLine{00731\ \ \ \textcolor{keywordflow}{if}\ (num\_multifiles\ <\ 0)\ \{}
\DoxyCodeLine{00732\ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}invalid\ db\ header"{}}\ <<\ endl;}
\DoxyCodeLine{00733\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00734\ \ \ \}}
\DoxyCodeLine{00735\ }
\DoxyCodeLine{00736\ \ \ \textcolor{comment}{//\ Now\ that\ we\ know\ how\ many\ multifiles\ this\ db\ has,\ we\ can\ iterate\ reading}}
\DoxyCodeLine{00737\ \ \ \textcolor{comment}{//\ them\ off\ one\ by\ one}}
\DoxyCodeLine{00738\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_multifiles;\ i++)\ \{}
\DoxyCodeLine{00739\ \ \ \ \ \textcolor{comment}{//\ The\ multifile\ record\ header\ is\ just\ one\ int\ which\ represents\ the\ size}}
\DoxyCodeLine{00740\ \ \ \ \ \textcolor{comment}{//\ of\ the\ record}}
\DoxyCodeLine{00741\ \ \ \ \ \textcolor{keywordtype}{int}\ mfr\_header\_length\ =\ \textcolor{keyword}{sizeof}(int32\_t);}
\DoxyCodeLine{00742\ }
\DoxyCodeLine{00743\ \ \ \ \ vector\_uchar\ mfr\_header\ =\ sr.\mbox{\hyperlink{classStreamReader_aa9f42d679a6c6c4f6e7ebdd797050696}{extract\_bytes}}(mfr\_header\_length);}
\DoxyCodeLine{00744\ \ \ \ \ \textcolor{keywordflow}{if}\ (mfr\_header.size()\ !=\ (size\_t)mfr\_header\_length)\ \{}
\DoxyCodeLine{00745\ \ \ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}invalid\ mfr\ header"{}}\ <<\ endl;}
\DoxyCodeLine{00746\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00747\ \ \ \ \ \}}
\DoxyCodeLine{00748\ }
\DoxyCodeLine{00749\ \ \ \ \ \textcolor{comment}{//\ Parse\ the\ header}}
\DoxyCodeLine{00750\ \ \ \ \ \textcolor{keywordtype}{int}\ mfr\_length\ =\ parse\_record\_header(\mbox{\hyperlink{classDatagram}{Datagram}}(std::move(mfr\_header)));}
\DoxyCodeLine{00751\ }
\DoxyCodeLine{00752\ \ \ \ \ \textcolor{comment}{//\ Ok,\ now\ that\ we\ know\ the\ size\ of\ the\ mfr,\ read\ it\ in\ Make\ a\ buffer\ to}}
\DoxyCodeLine{00753\ \ \ \ \ \textcolor{comment}{//\ read\ the\ multifile\ record\ into\ do\ not\ count\ the\ header\ length\ twice}}
\DoxyCodeLine{00754\ \ \ \ \ \textcolor{keywordtype}{int}\ read\_length\ =\ (mfr\_length\ -\/\ mfr\_header\_length);}
\DoxyCodeLine{00755\ \ \ \ \ vector\_uchar\ mfr\_record\ =\ sr.\mbox{\hyperlink{classStreamReader_aa9f42d679a6c6c4f6e7ebdd797050696}{extract\_bytes}}(read\_length);}
\DoxyCodeLine{00756\ \ \ \ \ \textcolor{keywordflow}{if}\ (mfr\_record.size()\ !=\ (size\_t)read\_length)\ \{}
\DoxyCodeLine{00757\ \ \ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}invalid\ mfr\ record"{}}\ <<\ endl;}
\DoxyCodeLine{00758\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00759\ \ \ \ \ \}}
\DoxyCodeLine{00760\ }
\DoxyCodeLine{00761\ \ \ \ \ \textcolor{comment}{//\ Parse\ the\ mfr}}
\DoxyCodeLine{00762\ \ \ \ \ PT(\mbox{\hyperlink{classDownloadDb_1_1MultifileRecord}{DownloadDb::MultifileRecord}})\ mfr\ =\ parse\_mfr(\mbox{\hyperlink{classDatagram}{Datagram}}(std::move(mfr\_record)));}
\DoxyCodeLine{00763\ }
\DoxyCodeLine{00764\ \ \ \ \ \textcolor{comment}{//\ Only\ read\ in\ the\ individual\ file\ info\ if\ you\ are\ the\ server}}
\DoxyCodeLine{00765\ \ \ \ \ \textcolor{keywordflow}{if}\ (want\_server\_info)\ \{}
\DoxyCodeLine{00766\ }
\DoxyCodeLine{00767\ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ off\ all\ the\ file\ records\ this\ multifile\ has}}
\DoxyCodeLine{00768\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ mfr-\/>\_num\_files;\ j++)\ \{}
\DoxyCodeLine{00769\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ file\ record\ header\ is\ just\ one\ int\ which\ represents\ the\ size\ of}}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ record}}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ fr\_header\_length\ =\ \textcolor{keyword}{sizeof}(int32\_t);}
\DoxyCodeLine{00772\ }
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ the\ header}}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \ \ vector\_uchar\ fr\_header\ =\ sr.\mbox{\hyperlink{classStreamReader_aa9f42d679a6c6c4f6e7ebdd797050696}{extract\_bytes}}(fr\_header\_length);}
\DoxyCodeLine{00775\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fr\_header.size()\ !=\ (size\_t)fr\_header\_length)\ \{}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}invalid\ fr\ header"{}}\ <<\ endl;}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Parse\ the\ header}}
\DoxyCodeLine{00781\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ fr\_length\ =\ parse\_record\_header(\mbox{\hyperlink{classDatagram}{Datagram}}(std::move(fr\_header)));}
\DoxyCodeLine{00782\ }
\DoxyCodeLine{00783\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Ok,\ now\ that\ we\ know\ the\ size\ of\ the\ mfr,\ read\ it\ in\ do\ not\ count}}
\DoxyCodeLine{00784\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ header\ length\ twice}}
\DoxyCodeLine{00785\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ read\_length\ =\ (fr\_length\ -\/\ fr\_header\_length);}
\DoxyCodeLine{00786\ }
\DoxyCodeLine{00787\ \ \ \ \ \ \ \ \ vector\_uchar\ fr\_record\ =\ sr.\mbox{\hyperlink{classStreamReader_aa9f42d679a6c6c4f6e7ebdd797050696}{extract\_bytes}}(read\_length);}
\DoxyCodeLine{00788\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fr\_record.size()\ !=\ (size\_t)read\_length)\ \{}
\DoxyCodeLine{00789\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.error()\ <<\ \textcolor{stringliteral}{"{}invalid\ fr\ record"{}}\ <<\ endl;}
\DoxyCodeLine{00790\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00791\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00792\ }
\DoxyCodeLine{00793\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Parse\ the\ file\ record}}
\DoxyCodeLine{00794\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classDownloadDb_1_1FileRecord}{DownloadDb::FileRecord}})\ fr\ =\ parse\_fr(\mbox{\hyperlink{classDatagram}{Datagram}}(std::move(fr\_record)));}
\DoxyCodeLine{00795\ }
\DoxyCodeLine{00796\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ this\ file\ record\ to\ the\ current\ multifilerecord}}
\DoxyCodeLine{00797\ \ \ \ \ \ \ \ \ mfr-\/>add\_file\_record(fr);}
\DoxyCodeLine{00798\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00799\ \ \ \ \ \}}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00801\ \ \ \ \ \textcolor{comment}{//\ Add\ the\ current\ multifilerecord\ to\ our\ database}}
\DoxyCodeLine{00802\ \ \ \ \ add\_multifile\_record(mfr);}
\DoxyCodeLine{00803\ \ \ \}}
\DoxyCodeLine{00804\ }
\DoxyCodeLine{00805\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00806\ \}}
\DoxyCodeLine{00807\ }
\DoxyCodeLine{00808\ }
\DoxyCodeLine{00809\ }
\DoxyCodeLine{00813\ \textcolor{keywordtype}{bool}\ DownloadDb::Db::}
\DoxyCodeLine{00814\ write(\mbox{\hyperlink{classStreamWriter}{StreamWriter}}\ \&sw,\ \textcolor{keywordtype}{bool}\ want\_server\_info)\ \{}
\DoxyCodeLine{00815\ \ \ \textcolor{comment}{//\ Declare\ these\ outside\ the\ loop\ so\ we\ do\ not\ keep\ creating\ and\ deleting}}
\DoxyCodeLine{00816\ \ \ \textcolor{comment}{//\ them}}
\DoxyCodeLine{00817\ \ \ PN\_float64\ phase;}
\DoxyCodeLine{00818\ \ \ int32\_t\ size;}
\DoxyCodeLine{00819\ \ \ int32\_t\ status;}
\DoxyCodeLine{00820\ \ \ int32\_t\ num\_files;}
\DoxyCodeLine{00821\ \ \ int32\_t\ name\_length;}
\DoxyCodeLine{00822\ \ \ int32\_t\ header\_length;}
\DoxyCodeLine{00823\ }
\DoxyCodeLine{00824\ \ \ \textcolor{comment}{//\ Iterate\ over\ the\ multifiles\ writing\ them\ to\ the\ stream}}
\DoxyCodeLine{00825\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(MultifileRecord)\ >::const\_iterator\ i\ =\ \_mfile\_records.begin();}
\DoxyCodeLine{00826\ \ \ \textcolor{keywordflow}{for}(;\ i\ !=\ \_mfile\_records.end();\ ++i)\ \{}
\DoxyCodeLine{00827\ \ \ \ \ \textcolor{comment}{//\ Cache\ some\ properties\ so\ we\ do\ not\ have\ to\ keep\ asking\ for\ them}}
\DoxyCodeLine{00828\ \ \ \ \ phase\ =\ (*i)-\/>\_phase;}
\DoxyCodeLine{00829\ \ \ \ \ size\ =\ (*i)-\/>\_size;}
\DoxyCodeLine{00830\ \ \ \ \ status\ =\ (*i)-\/>\_status;}
\DoxyCodeLine{00831\ \ \ \ \ num\_files\ =\ (*i)-\/>get\_num\_files();}
\DoxyCodeLine{00832\ \ \ \ \ name\_length\ =\ (*i)-\/>\_name.length();}
\DoxyCodeLine{00833\ }
\DoxyCodeLine{00834\ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ length\ of\ this\ datagram}}
\DoxyCodeLine{00835\ \ \ \ \ header\_length\ =}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(header\_length)\ +\ \ \textcolor{comment}{//\ Size\ of\ this\ header\ length}}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(name\_length)\ +\ \ \ \ \textcolor{comment}{//\ Size\ of\ the\ size\ of\ the\ name\ string}}
\DoxyCodeLine{00838\ \ \ \ \ \ \ (*i)-\/>\_name.length()\ +\ \ \ \ \ \ \textcolor{comment}{//\ Size\ of\ the\ name\ string}}
\DoxyCodeLine{00839\ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(phase)\ +\ \textcolor{keyword}{sizeof}(size)\ +}
\DoxyCodeLine{00840\ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(status)\ +\ \textcolor{keyword}{sizeof}(num\_files)\ +}
\DoxyCodeLine{00841\ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(uint32\_t)*4;\ \textcolor{comment}{//\ Size\ of\ hash\ value}}
\DoxyCodeLine{00842\ }
\DoxyCodeLine{00843\ \ \ \ \ \textcolor{comment}{//\ Add\ the\ length\ of\ this\ entire\ datagram}}
\DoxyCodeLine{00844\ \ \ \ \ sw.add\_int32(header\_length);}
\DoxyCodeLine{00845\ }
\DoxyCodeLine{00846\ \ \ \ \ \textcolor{comment}{//\ Add\ the\ length\ of\ the\ name}}
\DoxyCodeLine{00847\ \ \ \ \ sw.add\_int32(name\_length);}
\DoxyCodeLine{00848\ \ \ \ \ \textcolor{comment}{//\ Add\ the\ name}}
\DoxyCodeLine{00849\ \ \ \ \ sw.append\_data((*i)-\/>\_name);}
\DoxyCodeLine{00850\ }
\DoxyCodeLine{00851\ \ \ \ \ \textcolor{comment}{//\ Add\ all\ the\ properties}}
\DoxyCodeLine{00852\ \ \ \ \ sw.add\_float64(phase);}
\DoxyCodeLine{00853\ \ \ \ \ sw.add\_int32(size);}
\DoxyCodeLine{00854\ \ \ \ \ sw.add\_int32(status);}
\DoxyCodeLine{00855\ \ \ \ \ sw.add\_int32(num\_files);}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \ \ \ \ (*i)-\/>\_hash.write\_stream(sw);}
\DoxyCodeLine{00858\ }
\DoxyCodeLine{00859\ \ \ \ \ \textcolor{comment}{//\ Only\ write\ out\ the\ file\ information\ if\ you\ are\ the\ server}}
\DoxyCodeLine{00860\ \ \ \ \ \textcolor{keywordflow}{if}\ (want\_server\_info)\ \{}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ iterate\ over\ this\ multifile's\ files\ writing\ them\ to\ the\ stream}}
\DoxyCodeLine{00862\ \ \ \ \ \ \ \textcolor{comment}{//\ Iterate\ over\ the\ multifiles\ writing\ them\ to\ the\ stream}}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \mbox{\hyperlink{classpvector}{pvector}}<\ PT(FileRecord)\ >::const\_iterator\ j\ =\ (*i)-\/>\_file\_records.begin();}
\DoxyCodeLine{00864\ \ \ \ \ \ \ \textcolor{keywordflow}{for}(;\ j\ !=\ (*i)-\/>\_file\_records.end();\ ++j)\ \{}
\DoxyCodeLine{00865\ \ \ \ \ \ \ \ \ name\_length\ =\ (*j)-\/>\_name.length();}
\DoxyCodeLine{00866\ }
\DoxyCodeLine{00867\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Compute\ the\ length\ of\ this\ datagram}}
\DoxyCodeLine{00868\ \ \ \ \ \ \ \ \ header\_length\ =}
\DoxyCodeLine{00869\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(header\_length)\ +\ \ \textcolor{comment}{//\ Size\ of\ this\ header\ length}}
\DoxyCodeLine{00870\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(name\_length)\ +\ \ \ \ \textcolor{comment}{//\ Size\ of\ the\ size\ of\ the\ name\ string}}
\DoxyCodeLine{00871\ \ \ \ \ \ \ \ \ \ \ (*j)-\/>\_name.length();\ \ \ \ \textcolor{comment}{//\ Size\ of\ the\ name\ string}}
\DoxyCodeLine{00872\ }
\DoxyCodeLine{00873\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ the\ length\ of\ this\ entire\ datagram}}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \ \ sw.add\_int32(header\_length);}
\DoxyCodeLine{00875\ }
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ the\ length\ of\ the\ name}}
\DoxyCodeLine{00877\ \ \ \ \ \ \ \ \ sw.add\_int32(name\_length);}
\DoxyCodeLine{00878\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ the\ name}}
\DoxyCodeLine{00879\ \ \ \ \ \ \ \ \ sw.append\_data((*j)-\/>\_name);}
\DoxyCodeLine{00880\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00881\ \ \ \ \ \}}
\DoxyCodeLine{00882\ \ \ \}}
\DoxyCodeLine{00883\ }
\DoxyCodeLine{00884\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00885\ \}}
\DoxyCodeLine{00886\ }
\DoxyCodeLine{00892\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classDownloadDb_1_1Db_ab2f8be055258b6b29dad2c2f22f0b832}{DownloadDb::Db::}}}
\DoxyCodeLine{00893\ \mbox{\hyperlink{classDownloadDb_1_1Db_ab2f8be055258b6b29dad2c2f22f0b832}{write\_bogus\_header}}(\mbox{\hyperlink{classStreamWriter}{StreamWriter}}\ \&sw)\ \{}
\DoxyCodeLine{00894\ \ \ \textcolor{comment}{//\ Write\ the\ db\ magic\ number}}
\DoxyCodeLine{00895\ \ \ sw.add\_uint32(\_bogus\_magic\_number);}
\DoxyCodeLine{00896\ }
\DoxyCodeLine{00897\ \ \ \textcolor{comment}{//\ Write\ the\ number\ of\ multifiles}}
\DoxyCodeLine{00898\ \ \ sw.add\_int32(get\_num\_multifiles());}
\DoxyCodeLine{00899\ }
\DoxyCodeLine{00900\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00901\ \}}
\DoxyCodeLine{00902\ }
\DoxyCodeLine{00906\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classDownloadDb_1_1Db_abfcc719e6bbbdd0f1497d6d9b334a7a0}{DownloadDb::Db::}}}
\DoxyCodeLine{00907\ \mbox{\hyperlink{classDownloadDb_1_1Db_abfcc719e6bbbdd0f1497d6d9b334a7a0}{write\_header}}(ostream\ \&write\_stream)\ \{}
\DoxyCodeLine{00908\ \ \ \mbox{\hyperlink{classDatagram}{Datagram}}\ dg;}
\DoxyCodeLine{00909\ }
\DoxyCodeLine{00910\ \ \ \textcolor{comment}{//\ Write\ the\ db\ magic\ number}}
\DoxyCodeLine{00911\ \ \ dg.add\_uint32(\_magic\_number);}
\DoxyCodeLine{00912\ }
\DoxyCodeLine{00913\ \ \ \textcolor{comment}{//\ Write\ the\ number\ of\ multifiles}}
\DoxyCodeLine{00914\ \ \ dg.add\_int32(get\_num\_multifiles());}
\DoxyCodeLine{00915\ }
\DoxyCodeLine{00916\ \ \ \textcolor{comment}{//\ Seek\ back\ to\ the\ beginning\ of\ the\ write\ stream}}
\DoxyCodeLine{00917\ \ \ write\_stream.seekp(0);}
\DoxyCodeLine{00918\ \ \ \textcolor{comment}{//\ Overwrite\ the\ old\ bogus\ header\ with\ the\ real\ header}}
\DoxyCodeLine{00919\ \ \ write\_stream.write((\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *)dg.get\_data(),\ dg.get\_length());}
\DoxyCodeLine{00920\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00921\ \}}
\DoxyCodeLine{00922\ }
\DoxyCodeLine{00923\ }
\DoxyCodeLine{00924\ }
\DoxyCodeLine{00925\ \textcolor{comment}{//\ FileRecord\ methods}}
\DoxyCodeLine{00926\ }
\DoxyCodeLine{00927\ }
\DoxyCodeLine{00931\ DownloadDb::FileRecord::}
\DoxyCodeLine{00932\ FileRecord()\ \{}
\DoxyCodeLine{00933\ \ \ \_name\ =\ \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{00934\ \}}
\DoxyCodeLine{00935\ }
\DoxyCodeLine{00936\ }
\DoxyCodeLine{00940\ DownloadDb::FileRecord::}
\DoxyCodeLine{00941\ FileRecord(\textcolor{keywordtype}{string}\ name)\ \{}
\DoxyCodeLine{00942\ \ \ \_name\ =\ name;}
\DoxyCodeLine{00943\ \}}
\DoxyCodeLine{00944\ }
\DoxyCodeLine{00948\ \textcolor{keywordtype}{void}\ DownloadDb::FileRecord::}
\DoxyCodeLine{00949\ write(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00950\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ FileRecord:\ "{}}\ <<\ \_name\ <<\ endl;}
\DoxyCodeLine{00951\ \}}
\DoxyCodeLine{00952\ }
\DoxyCodeLine{00959\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{00960\ add\_version(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classHashVal}{HashVal}}\ \&hash,\ \textcolor{keywordtype}{int}\ version)\ \{}
\DoxyCodeLine{00961\ \ \ nassertv(version\ >=\ 1);}
\DoxyCodeLine{00962\ }
\DoxyCodeLine{00963\ \ \ VectorHash\ \&vhash\ =\ \_versions[name];}
\DoxyCodeLine{00964\ \ \ \textcolor{keywordtype}{int}\ size\ =\ vhash.size();}
\DoxyCodeLine{00965\ }
\DoxyCodeLine{00966\ \ \ \textcolor{comment}{//\ We\ should\ not\ skip\ over\ versions\ as\ we\ add\ them.}}
\DoxyCodeLine{00967\ \ \ nassertv(version\ <=\ size+1);}
\DoxyCodeLine{00968\ }
\DoxyCodeLine{00969\ \ \ \textcolor{keywordflow}{if}\ (version-\/1\ <\ size)\ \{}
\DoxyCodeLine{00970\ \ \ \ \ \textcolor{comment}{//\ If\ you\ are\ overwriting\ an\ old\ hash\ value,\ just\ rewrite\ the\ value}}
\DoxyCodeLine{00971\ \ \ \ \ vhash[version-\/1]\ =\ hash;}
\DoxyCodeLine{00972\ }
\DoxyCodeLine{00973\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00974\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ extend\ the\ vector.}}
\DoxyCodeLine{00975\ \ \ \ \ vhash.push\_back(hash);}
\DoxyCodeLine{00976\ \ \ \}}
\DoxyCodeLine{00977\ \}}
\DoxyCodeLine{00978\ }
\DoxyCodeLine{00983\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classDownloadDb_a65fe47fc497a719b5012e83d9ca67122}{DownloadDb::}}}
\DoxyCodeLine{00984\ \mbox{\hyperlink{classDownloadDb_a65fe47fc497a719b5012e83d9ca67122}{insert\_new\_version}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classHashVal}{HashVal}}\ \&hash)\ \{}
\DoxyCodeLine{00985\ \ \ \mbox{\hyperlink{classpvector}{VectorHash}}\ \&vhash\ =\ \_versions[name];}
\DoxyCodeLine{00986\ \ \ vhash.insert(vhash.begin(),\ hash);}
\DoxyCodeLine{00987\ \}}
\DoxyCodeLine{00988\ }
\DoxyCodeLine{00994\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classDownloadDb_a56b5c3b0e264dc0e7eadcf42470f4327}{DownloadDb::}}}
\DoxyCodeLine{00995\ \mbox{\hyperlink{classDownloadDb_a56b5c3b0e264dc0e7eadcf42470f4327}{has\_version}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00996\ \ \ \textcolor{keywordflow}{return}\ (\_versions.find(name)\ !=\ \_versions.end());}
\DoxyCodeLine{00997\ \}}
\DoxyCodeLine{00998\ }
\DoxyCodeLine{01002\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDownloadDb_ae4fd6965ce027b032a10ebd96f15eb9c}{DownloadDb::}}}
\DoxyCodeLine{01003\ \mbox{\hyperlink{classDownloadDb_ae4fd6965ce027b032a10ebd96f15eb9c}{get\_num\_versions}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01004\ \ \ VersionMap::const\_iterator\ vmi\ =\ \_versions.find(name);}
\DoxyCodeLine{01005\ \ \ \textcolor{keywordflow}{if}\ (vmi\ ==\ \_versions.end())\ \{}
\DoxyCodeLine{01006\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01007\ \ \ \}}
\DoxyCodeLine{01008\ }
\DoxyCodeLine{01009\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})(*vmi).second.size();}
\DoxyCodeLine{01010\ \}}
\DoxyCodeLine{01011\ }
\DoxyCodeLine{01016\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classDownloadDb_ac7ecced5520c763643b7ec71e9e6bc9d}{DownloadDb::}}}
\DoxyCodeLine{01017\ \mbox{\hyperlink{classDownloadDb_ac7ecced5520c763643b7ec71e9e6bc9d}{set\_num\_versions}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name,\ \textcolor{keywordtype}{int}\ num\_versions)\ \{}
\DoxyCodeLine{01018\ \ \ VersionMap::iterator\ vmi\ =\ \_versions.find(name);}
\DoxyCodeLine{01019\ \ \ \textcolor{keywordflow}{if}\ (vmi\ ==\ \_versions.end())\ \{}
\DoxyCodeLine{01020\ \ \ \ \ nassertv(num\_versions\ ==\ 0);}
\DoxyCodeLine{01021\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01022\ \ \ \}}
\DoxyCodeLine{01023\ }
\DoxyCodeLine{01024\ \ \ \mbox{\hyperlink{classpvector}{VectorHash}}\ \&vhash\ =\ (*vmi).second;}
\DoxyCodeLine{01025\ }
\DoxyCodeLine{01026\ \ \ nassertv(num\_versions\ <=\ (\textcolor{keywordtype}{int})vhash.size());}
\DoxyCodeLine{01027\ \ \ vhash.erase(vhash.begin()\ +\ num\_versions,\ vhash.end());}
\DoxyCodeLine{01028\ \}}
\DoxyCodeLine{01029\ }
\DoxyCodeLine{01035\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classDownloadDb_a532218531e297d2a4ff1adcf056bf348}{DownloadDb::}}}
\DoxyCodeLine{01036\ \mbox{\hyperlink{classDownloadDb_a532218531e297d2a4ff1adcf056bf348}{get\_version}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classHashVal}{HashVal}}\ \&hash)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01037\ \ \ VersionMap::const\_iterator\ vmi\ =\ \_versions.find(name);}
\DoxyCodeLine{01038\ \ \ \textcolor{keywordflow}{if}\ (vmi\ ==\ \_versions.end())\ \{}
\DoxyCodeLine{01039\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01040\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01041\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::get\_version()\ -\/\ can't\ find:\ "{}}\ <<\ name\ <<\ endl;}
\DoxyCodeLine{01042\ \ \ \ \ \}}
\DoxyCodeLine{01043\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{01044\ \ \ \}}
\DoxyCodeLine{01045\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{VectorHash}}\ \&vhash\ =\ (*vmi).second;}
\DoxyCodeLine{01046\ \ \ VectorHash::const\_iterator\ i\ =\ find(vhash.begin(),\ vhash.end(),\ hash);}
\DoxyCodeLine{01047\ \ \ \textcolor{keywordflow}{if}\ (i\ !=\ vhash.end())\ \{}
\DoxyCodeLine{01048\ \ \ \ \ \textcolor{keywordflow}{return}\ (i\ -\/\ vhash.begin()\ +\ 1);}
\DoxyCodeLine{01049\ \ \ \}}
\DoxyCodeLine{01050\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01051\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01052\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::get\_version()\ -\/\ can't\ find\ hash:\ "{}}\ <<\ hash\ <<\ endl;}
\DoxyCodeLine{01053\ \ \ \}}
\DoxyCodeLine{01054\ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{01055\ \}}
\DoxyCodeLine{01056\ }
\DoxyCodeLine{01061\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classHashVal}{HashVal}}\ \&\mbox{\hyperlink{classDownloadDb_a1b635d3ebc08ec1e7fbbf1cccfd8dba6}{DownloadDb::}}}
\DoxyCodeLine{01062\ \mbox{\hyperlink{classDownloadDb_a1b635d3ebc08ec1e7fbbf1cccfd8dba6}{get\_hash}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&name,\ \textcolor{keywordtype}{int}\ version)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01063\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classHashVal}{HashVal}}\ bogus\_hash;}
\DoxyCodeLine{01064\ }
\DoxyCodeLine{01065\ \ \ VersionMap::const\_iterator\ vmi\ =\ \_versions.find(name);}
\DoxyCodeLine{01066\ \ \ \textcolor{keywordflow}{if}\ (vmi\ ==\ \_versions.end())\ \{}
\DoxyCodeLine{01067\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{01068\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::get\_hash()\ -\/\ can't\ find:\ "{}}\ <<\ name\ <<\ endl;}
\DoxyCodeLine{01069\ \ \ \ \ \textcolor{keywordflow}{return}\ bogus\_hash;}
\DoxyCodeLine{01070\ \ \ \}}
\DoxyCodeLine{01071\ }
\DoxyCodeLine{01072\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{VectorHash}}\ \&vhash\ =\ (*vmi).second;}
\DoxyCodeLine{01073\ \ \ \textcolor{keywordflow}{if}\ (version\ <\ 1\ ||\ version\ >\ (\textcolor{keywordtype}{int})vhash.size())\ \{}
\DoxyCodeLine{01074\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{01075\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::get\_hash()\ -\/\ no\ version\ "{}}\ <<\ version}
\DoxyCodeLine{01076\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ for\ "{}}\ <<\ name\ <<\ endl;}
\DoxyCodeLine{01077\ \ \ \ \ \textcolor{keywordflow}{return}\ bogus\_hash;}
\DoxyCodeLine{01078\ \ \ \}}
\DoxyCodeLine{01079\ \ \ \textcolor{keywordflow}{return}\ vhash[version\ -\/\ 1];}
\DoxyCodeLine{01080\ \}}
\DoxyCodeLine{01081\ }
\DoxyCodeLine{01085\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{01086\ write\_version\_map(\mbox{\hyperlink{classStreamWriter}{StreamWriter}}\ \&sw)\ \{}
\DoxyCodeLine{01087\ \ \ VersionMap::iterator\ vmi;}
\DoxyCodeLine{01088\ \ \ VectorHash::iterator\ i;}
\DoxyCodeLine{01089\ \ \ \textcolor{keywordtype}{string}\ name;}
\DoxyCodeLine{01090\ }
\DoxyCodeLine{01091\ \ \ sw.add\_int32(\_versions.size());}
\DoxyCodeLine{01092\ \ \ \textcolor{keywordflow}{for}\ (vmi\ =\ \_versions.begin();\ vmi\ !=\ \_versions.end();\ ++vmi)\ \{}
\DoxyCodeLine{01093\ \ \ \ \ name\ =\ (*vmi).first;}
\DoxyCodeLine{01094\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01095\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01096\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::write\_version\_map()\ -\/\ writing\ file:\ "{}}}
\DoxyCodeLine{01097\ \ \ \ \ \ \ \ \ <<\ name\ <<\ \textcolor{stringliteral}{"{}\ of\ length:\ "{}}\ <<\ name.length()\ <<\ endl;}
\DoxyCodeLine{01098\ \ \ \ \ \}}
\DoxyCodeLine{01099\ \ \ \ \ sw.add\_int32(name.length());}
\DoxyCodeLine{01100\ \ \ \ \ sw.append\_data(name);}
\DoxyCodeLine{01101\ \ \ \ \ sw.add\_int32((*vmi).second.size());}
\DoxyCodeLine{01102\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ (*vmi).second.begin();\ i\ !=\ (*vmi).second.end();\ ++i)\ \{}
\DoxyCodeLine{01103\ \ \ \ \ \ \ \textcolor{comment}{//\ *i\ will\ point\ to\ a\ HashVal}}
\DoxyCodeLine{01104\ \ \ \ \ \ \ (*i).write\_stream(sw);}
\DoxyCodeLine{01105\ \ \ \ \ \}}
\DoxyCodeLine{01106\ \ \ \}}
\DoxyCodeLine{01107\ \}}
\DoxyCodeLine{01108\ }
\DoxyCodeLine{01112\ \textcolor{keywordtype}{bool}\ DownloadDb::}
\DoxyCodeLine{01113\ read\_version\_map(\mbox{\hyperlink{classStreamReader}{StreamReader}}\ \&sr)\ \{}
\DoxyCodeLine{01114\ \ \ \textcolor{keywordtype}{int}\ num\_entries\ =\ sr.get\_int32();}
\DoxyCodeLine{01115\ \ \ \textcolor{keywordflow}{if}\ (sr.get\_istream()-\/>fail())\ \{}
\DoxyCodeLine{01116\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01117\ \ \ \}}
\DoxyCodeLine{01118\ }
\DoxyCodeLine{01119\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_entries;\ i++)\ \{}
\DoxyCodeLine{01120\ }
\DoxyCodeLine{01121\ \ \ \ \ \textcolor{comment}{//\ Get\ the\ file\ name}}
\DoxyCodeLine{01122\ \ \ \ \ \textcolor{keywordtype}{string}\ name\ =\ sr.\mbox{\hyperlink{classStreamReader_a1aa8b6cd79d02c073eb2dff55ceab665}{get\_string32}}();}
\DoxyCodeLine{01123\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01124\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01125\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::read\_version\_map()\ -\/\ name:\ "{}}\ <<\ name\ <<\ endl;}
\DoxyCodeLine{01126\ \ \ \ \ \}}
\DoxyCodeLine{01127\ }
\DoxyCodeLine{01128\ \ \ \ \ \textcolor{comment}{//\ Get\ number\ of\ hash\ values\ for\ name}}
\DoxyCodeLine{01129\ \ \ \ \ \textcolor{keywordtype}{int}\ length\ =\ sr.get\_int32();}
\DoxyCodeLine{01130\ \ \ \ \ \textcolor{keywordflow}{if}\ (sr.get\_istream()-\/>fail())\ \{}
\DoxyCodeLine{01131\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01132\ \ \ \ \ \}}
\DoxyCodeLine{01133\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01134\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01135\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DownloadDb::read\_version\_map()\ -\/\ number\ of\ values:\ "{}}\ <<\ length}
\DoxyCodeLine{01136\ \ \ \ \ \ \ \ \ <<\ endl;}
\DoxyCodeLine{01137\ \ \ \ \ \}}
\DoxyCodeLine{01138\ }
\DoxyCodeLine{01139\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ length;\ j++)\ \{}
\DoxyCodeLine{01140\ \ \ \ \ \ \ \mbox{\hyperlink{classHashVal}{HashVal}}\ hash;}
\DoxyCodeLine{01141\ \ \ \ \ \ \ hash.read\_stream(sr);}
\DoxyCodeLine{01142\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sr.get\_istream()-\/>fail())\ \{}
\DoxyCodeLine{01143\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01144\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01145\ \ \ \ \ \ \ add\_version(name,\ hash,\ j\ +\ 1);}
\DoxyCodeLine{01146\ \ \ \ \ \}}
\DoxyCodeLine{01147\ \ \ \}}
\DoxyCodeLine{01148\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01149\ \}}
\DoxyCodeLine{01150\ }
\DoxyCodeLine{01154\ \textcolor{keywordtype}{void}\ DownloadDb::}
\DoxyCodeLine{01155\ write\_version\_map(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01156\ \ \ out\ <<\ \textcolor{stringliteral}{"{}Version\ Map:\ "{}}\ <<\ endl;}
\DoxyCodeLine{01157\ \ \ VersionMap::const\_iterator\ vmi;}
\DoxyCodeLine{01158\ \ \ VectorHash::const\_iterator\ i;}
\DoxyCodeLine{01159\ \ \ \textcolor{keywordflow}{for}\ (vmi\ =\ \_versions.begin();\ vmi\ !=\ \_versions.end();\ ++vmi)\ \{}
\DoxyCodeLine{01160\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ (*vmi).first\ <<\ endl;}
\DoxyCodeLine{01161\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ (*vmi).second.begin();\ i\ !=\ (*vmi).second.end();\ ++i)\ \{}
\DoxyCodeLine{01162\ \ \ \ \ \ \ \mbox{\hyperlink{classHashVal}{HashVal}}\ hash\ =\ *i;}
\DoxyCodeLine{01163\ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ "{}}\ <<\ hash.as\_dec()\ <<\ endl;}
\DoxyCodeLine{01164\ \ \ \ \ \}}
\DoxyCodeLine{01165\ \ \ \}}
\DoxyCodeLine{01166\ \ \ out\ <<\ endl;}
\DoxyCodeLine{01167\ \}}

\end{DoxyCode}
