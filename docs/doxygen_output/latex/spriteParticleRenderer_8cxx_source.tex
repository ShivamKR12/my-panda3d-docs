\doxysection{sprite\+Particle\+Renderer.\+cxx}
\hypertarget{spriteParticleRenderer_8cxx_source}{}\label{spriteParticleRenderer_8cxx_source}\index{panda/src/particlesystem/spriteParticleRenderer.cxx@{panda/src/particlesystem/spriteParticleRenderer.cxx}}
\mbox{\hyperlink{spriteParticleRenderer_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{spriteParticleRenderer_8h}{spriteParticleRenderer.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sequenceNode_8h}{sequenceNode.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePath_8h}{nodePath.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dcast_8h}{dcast.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexReader_8h}{geomVertexReader.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderModeAttrib_8h}{renderModeAttrib.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texMatrixAttrib_8h}{texMatrixAttrib.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texGenAttrib_8h}{texGenAttrib.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{textureAttrib_8h}{textureAttrib.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{textureCollection_8h}{textureCollection.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePathCollection_8h}{nodePathCollection.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__particlesystem_8h}{config\_particlesystem.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{using\ }std::max;}
\DoxyCodeLine{00034\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ SpriteParticleRenderer::\_render\_collector(\textcolor{stringliteral}{"{}App:Particles:Sprite:Render"{}});}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00041\ SpriteParticleRenderer::}
\DoxyCodeLine{00042\ SpriteParticleRenderer(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ :}
\DoxyCodeLine{00043\ \ \ \mbox{\hyperlink{classBaseParticleRenderer}{BaseParticleRenderer}}(PR\_ALPHA\_NONE),}
\DoxyCodeLine{00044\ \ \ \_color(LColor(1.0f,\ 1.0f,\ 1.0f,\ 1.0f)),}
\DoxyCodeLine{00045\ \ \ \_height(1.0f),}
\DoxyCodeLine{00046\ \ \ \_width(1.0f),}
\DoxyCodeLine{00047\ \ \ \_initial\_x\_scale(1.0f),}
\DoxyCodeLine{00048\ \ \ \_final\_x\_scale(1.0f),}
\DoxyCodeLine{00049\ \ \ \_initial\_y\_scale(1.0f),}
\DoxyCodeLine{00050\ \ \ \_final\_y\_scale(1.0f),}
\DoxyCodeLine{00051\ \ \ \_theta(0.0f),}
\DoxyCodeLine{00052\ \ \ \_base\_y\_scale(1.0f),}
\DoxyCodeLine{00053\ \ \ \_aspect\_ratio(1.0f),}
\DoxyCodeLine{00054\ \ \ \_animate\_frames\_rate(0.0f),}
\DoxyCodeLine{00055\ \ \ \_animate\_frames\_index(0),}
\DoxyCodeLine{00056\ \ \ \_animate\_x\_ratio(false),}
\DoxyCodeLine{00057\ \ \ \_animate\_y\_ratio(false),}
\DoxyCodeLine{00058\ \ \ \_animate\_theta(false),}
\DoxyCodeLine{00059\ \ \ \_alpha\_disable(false),}
\DoxyCodeLine{00060\ \ \ \_animate\_frames(false),}
\DoxyCodeLine{00061\ \ \ \_animation\_removed(true),}
\DoxyCodeLine{00062\ \ \ \_blend\_method(PP\_BLEND\_LINEAR),}
\DoxyCodeLine{00063\ \ \ \_color\_interpolation\_manager(new\ \mbox{\hyperlink{classColorInterpolationManager}{ColorInterpolationManager}}(\_color)),}
\DoxyCodeLine{00064\ \ \ \_pool\_size(0)\ \{}
\DoxyCodeLine{00065\ \ \ set\_texture(tex);}
\DoxyCodeLine{00066\ \ \ init\_geoms();}
\DoxyCodeLine{00067\ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00072\ SpriteParticleRenderer::}
\DoxyCodeLine{00073\ SpriteParticleRenderer(\textcolor{keyword}{const}\ \mbox{\hyperlink{classSpriteParticleRenderer}{SpriteParticleRenderer}}\&\ copy)\ :}
\DoxyCodeLine{00074\ \ \ \mbox{\hyperlink{classBaseParticleRenderer}{BaseParticleRenderer}}(copy),}
\DoxyCodeLine{00075\ \ \ \_anims(copy.\_anims),}
\DoxyCodeLine{00076\ \ \ \_color(copy.\_color),}
\DoxyCodeLine{00077\ \ \ \_height(copy.\_height),}
\DoxyCodeLine{00078\ \ \ \_width(copy.\_width),}
\DoxyCodeLine{00079\ \ \ \_initial\_x\_scale(copy.\_initial\_x\_scale),}
\DoxyCodeLine{00080\ \ \ \_final\_x\_scale(copy.\_final\_x\_scale),}
\DoxyCodeLine{00081\ \ \ \_initial\_y\_scale(copy.\_initial\_y\_scale),}
\DoxyCodeLine{00082\ \ \ \_final\_y\_scale(copy.\_final\_y\_scale),}
\DoxyCodeLine{00083\ \ \ \_theta(copy.\_theta),}
\DoxyCodeLine{00084\ \ \ \_base\_y\_scale(copy.\_base\_y\_scale),}
\DoxyCodeLine{00085\ \ \ \_aspect\_ratio(copy.\_aspect\_ratio),}
\DoxyCodeLine{00086\ \ \ \_animate\_frames\_rate(copy.\_animate\_frames\_rate),}
\DoxyCodeLine{00087\ \ \ \_animate\_frames\_index(copy.\_animate\_frames\_index),}
\DoxyCodeLine{00088\ \ \ \_animate\_x\_ratio(copy.\_animate\_x\_ratio),}
\DoxyCodeLine{00089\ \ \ \_animate\_y\_ratio(copy.\_animate\_y\_ratio),}
\DoxyCodeLine{00090\ \ \ \_animate\_theta(copy.\_animate\_theta),}
\DoxyCodeLine{00091\ \ \ \_alpha\_disable(copy.\_alpha\_disable),}
\DoxyCodeLine{00092\ \ \ \_animate\_frames(copy.\_animate\_frames),}
\DoxyCodeLine{00093\ \ \ \_animation\_removed(true),}
\DoxyCodeLine{00094\ \ \ \_blend\_method(copy.\_blend\_method),}
\DoxyCodeLine{00095\ \ \ \_color\_interpolation\_manager(copy.\_color\_interpolation\_manager),}
\DoxyCodeLine{00096\ \ \ \_pool\_size(0),}
\DoxyCodeLine{00097\ \ \ \_birth\_list(copy.\_birth\_list)\ \{}
\DoxyCodeLine{00098\ \ \ init\_geoms();}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00104\ SpriteParticleRenderer::}
\DoxyCodeLine{00105\ \string~SpriteParticleRenderer()\ \{}
\DoxyCodeLine{00106\ \ \ get\_render\_node()-\/>remove\_all\_geoms();}
\DoxyCodeLine{00107\ \}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00112\ \mbox{\hyperlink{classBaseParticleRenderer}{BaseParticleRenderer}}\ *\mbox{\hyperlink{classSpriteParticleRenderer_a8528bc3d0e591b9ed87d1a212d8d5497}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00113\ \mbox{\hyperlink{classSpriteParticleRenderer_a8528bc3d0e591b9ed87d1a212d8d5497}{make\_copy}}()\ \{}
\DoxyCodeLine{00114\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classSpriteParticleRenderer}{SpriteParticleRenderer}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00115\ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00125\ \textcolor{keywordtype}{int}\ SpriteParticleRenderer::}
\DoxyCodeLine{00126\ extract\_textures\_from\_node(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&node\_path,\ \mbox{\hyperlink{classNodePathCollection}{NodePathCollection}}\ \&np\_col,\ \mbox{\hyperlink{classTextureCollection}{TextureCollection}}\ \&tex\_col)\ \{}
\DoxyCodeLine{00127\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ tex\_node\_path\ =\ node\_path;}
\DoxyCodeLine{00128\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ geom\_node\_path;}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \textcolor{comment}{//\ Look\ for\ a\ sequence\ node\ first,\ in\ case\ they\ want\ animated\ texture}}
\DoxyCodeLine{00131\ \ \ \textcolor{comment}{//\ sprites}}
\DoxyCodeLine{00132\ \ \ \textcolor{keywordflow}{if}\ (!tex\_node\_path.is\_empty()\ \&\&\ tex\_node\_path.node()-\/>get\_type()\ !=\ SequenceNode::get\_class\_type())\ \{}
\DoxyCodeLine{00133\ \ \ \ \ tex\_node\_path\ =\ node\_path.find(\textcolor{stringliteral}{"{}**/+SequenceNode"{}});}
\DoxyCodeLine{00134\ \ \ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \textcolor{comment}{//\ Nodepath\ contains\ a\ sequence\ node,\ attempt\ to\ read\ its\ textures.}}
\DoxyCodeLine{00137\ \ \ \textcolor{keywordflow}{if}\ (!tex\_node\_path.is\_empty())\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordtype}{int}\ frame\_count\ =\ tex\_node\_path.get\_num\_children();}
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{comment}{//\ We\ do\ it\ this\ way\ in\ order\ to\ preserve\ the\ order\ of\ the\ textures\ in\ the}}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{comment}{//\ sequence.\ \ If\ we\ use\ a\ find\_all\_textures()\ that\ order\ is\ lost.}}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ frame\_count;\ ++i)\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \ \ geom\_node\_path\ =\ tex\_node\_path.get\_child(i);}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!geom\_node\_path.is\_empty())\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Since\ this\ is\ a\ SequenceNode,\ there\ will\ be\ only\ one\ texture\ on}}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ this\ geom\_node\_path.}}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ tex\_col.add\_textures\_from(geom\_node\_path.\mbox{\hyperlink{classNodePath_aae7ead4fc9db16932578ec90629f23ef}{find\_all\_textures}}());}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ np\_col.add\_path(geom\_node\_path);}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00149\ \ \ \ \ \}}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ If\ unsuccessful,\ try\ again\ as\ if\ the\ node\ were\ a\ normal\ GeomNode.}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\_col.get\_num\_textures()\ ==\ 0)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ geom\_node\_path\ =\ \mbox{\hyperlink{classNodePath}{NodePath}}();}
\DoxyCodeLine{00153\ \ \ \ \ \ \ tex\_col.clear();}
\DoxyCodeLine{00154\ \ \ \ \ \ \ np\_col.clear();}
\DoxyCodeLine{00155\ \ \ \ \ \}}
\DoxyCodeLine{00156\ \ \ \}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \textcolor{comment}{//\ If\ a\ sequence\ node\ is\ not\ found,\ we\ just\ want\ to\ look\ for\ a\ regular\ geom}}
\DoxyCodeLine{00159\ \ \ \textcolor{comment}{//\ node.}}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{if}\ (geom\_node\_path.is\_empty())\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{comment}{//\ Find\ the\ first\ GeomNode.}}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{keywordflow}{if}\ (!node\_path.is\_empty()\ \&\&\ node\_path.node()-\/>get\_type()\ !=\ GeomNode::get\_class\_type())\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ geom\_node\_path\ =\ node\_path.find(\textcolor{stringliteral}{"{}**/+GeomNode"{}});}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_node\_path.is\_empty())\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ particlesystem\_cat.error();}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00168\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00169\ \ \ \ \ \ \ geom\_node\_path\ =\ node\_path;}
\DoxyCodeLine{00170\ \ \ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{comment}{//\ Grab\ the\ first\ texture.}}
\DoxyCodeLine{00173\ \ \ \ \ tex\_col.add\_texture(geom\_node\_path.\mbox{\hyperlink{classNodePath_a73929e4542ef7ee2337e7fa992fda3fd}{find\_texture}}(\textcolor{stringliteral}{"{}*"{}}));}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\_col.get\_num\_textures()\ <\ 1)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \ \ particlesystem\_cat.error()}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ <<\ geom\_node\_path\ <<\ \textcolor{stringliteral}{"{}\ does\ not\ contain\ a\ texture.\(\backslash\)n"{}};}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00178\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00179\ \ \ \ \ \ \ np\_col.add\_path(geom\_node\_path);}
\DoxyCodeLine{00180\ \ \ \ \ \}}
\DoxyCodeLine{00181\ \ \ \}}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00194\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_af2ad7cb596896bf13a1372821fe1d543}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00195\ \mbox{\hyperlink{classSpriteParticleRenderer_af2ad7cb596896bf13a1372821fe1d543}{set\_from\_node}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&node\_path,\ \textcolor{keyword}{const}\ std::string\ \&model,\ \textcolor{keyword}{const}\ std::string\ \&node,\ \textcolor{keywordtype}{bool}\ size\_from\_texels)\ \{}
\DoxyCodeLine{00196\ \ \ \textcolor{comment}{//\ Clear\ all\ texture\ information}}
\DoxyCodeLine{00197\ \ \ \_anims.clear();}
\DoxyCodeLine{00198\ \ \ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{add\_from\_node}}(node\_path,model,node,size\_from\_texels,\textcolor{keyword}{true});}
\DoxyCodeLine{00199\ \}}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00225\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_af2ad7cb596896bf13a1372821fe1d543}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00226\ \mbox{\hyperlink{classSpriteParticleRenderer_af2ad7cb596896bf13a1372821fe1d543}{set\_from\_node}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&node\_path,\ \textcolor{keywordtype}{bool}\ size\_from\_texels)\ \{}
\DoxyCodeLine{00227\ \ \ nassertv(!node\_path.is\_empty());}
\DoxyCodeLine{00228\ \ \ \textcolor{comment}{//\ Clear\ all\ texture\ information}}
\DoxyCodeLine{00229\ \ \ \_anims.clear();}
\DoxyCodeLine{00230\ \ \ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{add\_from\_node}}(node\_path,size\_from\_texels,\textcolor{keyword}{true});}
\DoxyCodeLine{00231\ \}}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00246\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00247\ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{add\_from\_node}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&node\_path,\ \textcolor{keyword}{const}\ std::string\ \&model,\ \textcolor{keyword}{const}\ std::string\ \&node,\ \textcolor{keywordtype}{bool}\ size\_from\_texels,\ \textcolor{keywordtype}{bool}\ resize)\ \{}
\DoxyCodeLine{00248\ \ \ \textcolor{keywordtype}{int}\ anim\_count\ =\ \_anims.size();}
\DoxyCodeLine{00249\ \ \ \textcolor{keywordflow}{if}\ (anim\_count\ ==\ 0)}
\DoxyCodeLine{00250\ \ \ \ \ resize\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00251\ \ \ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{add\_from\_node}}(node\_path,size\_from\_texels,resize);}
\DoxyCodeLine{00252\ \ \ \textcolor{keywordflow}{if}\ (anim\_count\ <\ (\textcolor{keywordtype}{int})\_anims.size())\ \{}
\DoxyCodeLine{00253\ \ \ \ \ get\_last\_anim()-\/>set\_source\_info(model,node);}
\DoxyCodeLine{00254\ \ \ \}}
\DoxyCodeLine{00255\ \}}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00265\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00266\ \mbox{\hyperlink{classSpriteParticleRenderer_a8de62cabdd92f121796add6609c79c7a}{add\_from\_node}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&node\_path,\ \textcolor{keywordtype}{bool}\ size\_from\_texels,\ \textcolor{keywordtype}{bool}\ resize)\ \{}
\DoxyCodeLine{00267\ \ \ nassertv(!node\_path.is\_empty());}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00269\ \ \ \mbox{\hyperlink{classNodePathCollection}{NodePathCollection}}\ np\_col;}
\DoxyCodeLine{00270\ \ \ \mbox{\hyperlink{classTextureCollection}{TextureCollection}}\ tex\_col;}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \textcolor{keywordflow}{if}\ (\_anims.empty())}
\DoxyCodeLine{00273\ \ \ \ \ resize\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \textcolor{comment}{//\ Load\ the\ found\ textures\ into\ the\ renderer.}}
\DoxyCodeLine{00276\ \ \ \textcolor{keywordflow}{if}\ (extract\_textures\_from\_node(node\_path,np\_col,tex\_col))\ \{}
\DoxyCodeLine{00277\ \ \ \ \ \mbox{\hyperlink{classpvector}{pvector<\ LTexCoord\ >}}\ ll,ur;}
\DoxyCodeLine{00278\ \ \ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *gnode\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeom}{Geom}}\ *geom;}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomPrimitive}{GeomPrimitive}}\ *primitive;}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ np\_col.get\_num\_paths();\ ++i)\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ node\ from\ which\ we'll\ extract\ the\ geometry\ information.}}
\DoxyCodeLine{00284\ \ \ \ \ \ \ gnode\ =\ DCAST(\mbox{\hyperlink{classGeomNode}{GeomNode}},\ np\_col[i].node());}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ examine\ the\ UV's\ of\ the\ first\ Geom\ within\ the\ GeomNode.}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ nassertv(gnode-\/>get\_num\_geoms()\ >\ 0);}
\DoxyCodeLine{00288\ \ \ \ \ \ \ geom\ =\ gnode-\/>get\_geom(0);}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ got\_texcoord\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00291\ \ \ \ \ \ \ LTexCoord\ min\_uv(0.0f,\ 0.0f);}
\DoxyCodeLine{00292\ \ \ \ \ \ \ LTexCoord\ max\_uv(0.0f,\ 0.0f);}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ texcoord(geom-\/>get\_vertex\_data(),}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ InternalName::get\_texcoord());}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (texcoord.has\_column())\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ pi\ =\ 0;\ pi\ <\ geom-\/>get\_num\_primitives();\ ++pi)\ \{}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ primitive\ =\ geom-\/>get\_primitive(pi);}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ vi\ =\ 0;\ vi\ <\ primitive-\/>get\_num\_vertices();\ ++vi)\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vert\ =\ primitive-\/>get\_vertex(vi);}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ texcoord.set\_row\_unsafe(vert);}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_texcoord)\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_uv\ =\ max\_uv\ =\ texcoord.get\_data2();}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ got\_texcoord\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00306\ }
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVecBase2\ \&uv\ =\ texcoord.get\_data2();}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_uv[0]\ =\ min(min\_uv[0],\ uv[0]);}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_uv[0]\ =\ max(max\_uv[0],\ uv[0]);}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_uv[1]\ =\ min(min\_uv[1],\ uv[1]);}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_uv[1]\ =\ max(max\_uv[1],\ uv[1]);}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00318\ }
\DoxyCodeLine{00319\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (got\_texcoord)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ really\ pay\ attention\ to\ orientation\ of\ UV's\ here;\ a\ minor}}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ flaw.\ \ We\ assume\ the\ minimum\ is\ in\ the\ lower-\/left,\ and\ the\ maximum}}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ is\ in\ the\ upper-\/right.}}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ ll.push\_back(min\_uv);}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ ur.push\_back(max\_uv);}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00326\ \ \ \ \ \}}
\DoxyCodeLine{00327\ }
\DoxyCodeLine{00328\ \ \ \ \ \_anims.push\_back(\textcolor{keyword}{new}\ \mbox{\hyperlink{classSpriteAnim}{SpriteAnim}}(tex\_col,ll,ur));}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keywordflow}{if}\ (resize)\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \ \ gnode\ =\ DCAST(\mbox{\hyperlink{classGeomNode}{GeomNode}},\ np\_col[0].node());}
\DoxyCodeLine{00332\ \ \ \ \ \ \ geom\ =\ gnode-\/>get\_geom(0);}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ got\_vertex\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00335\ \ \ \ \ \ \ LVertex\ min\_xyz(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{00336\ \ \ \ \ \ \ LVertex\ max\_xyz(0.0f,\ 0.0f,\ 0.0f);}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomVertexReader}{GeomVertexReader}}\ vertex(geom-\/>get\_vertex\_data(),}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ InternalName::get\_vertex());}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vertex.has\_column())\ \{}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ pi\ =\ 0;\ pi\ <\ geom-\/>get\_num\_primitives();\ ++pi)\ \{}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ primitive\ =\ geom-\/>get\_primitive(pi);}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ vi\ =\ 0;\ vi\ <\ primitive-\/>get\_num\_vertices();\ ++vi)\ \{}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ vert\ =\ primitive-\/>get\_vertex(vi);}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ vertex.set\_row\_unsafe(vert);}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_vertex)\ \{}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_xyz\ =\ max\_xyz\ =\ vertex.get\_data3();}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ got\_vertex\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVecBase3\ \&xyz\ =\ vertex.get\_data3();}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_xyz[0]\ =\ min(min\_xyz[0],\ xyz[0]);}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_xyz[0]\ =\ max(max\_xyz[0],\ xyz[0]);}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_xyz[1]\ =\ min(min\_xyz[1],\ xyz[1]);}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_xyz[1]\ =\ max(max\_xyz[1],\ xyz[1]);}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_xyz[2]\ =\ min(min\_xyz[2],\ xyz[2]);}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_xyz[2]\ =\ max(max\_xyz[2],\ xyz[2]);}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (got\_vertex)\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ PN\_stdfloat\ width\ =\ max\_xyz[0]\ -\/\ min\_xyz[0];}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ PN\_stdfloat\ height\ =\ max(max\_xyz[1]\ -\/\ min\_xyz[1],}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ max\_xyz[2]\ -\/\ min\_xyz[2]);}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (size\_from\_texels)\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ size\_from\_texels\ is\ true,\ we\ get\ the\ particle\ size\ from\ the}}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ number\ of\ texels\ in\ the\ source\ image.}}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ y\_texels\ =\ \_anims[0]-\/>get\_frame(0)-\/>get\_y\_size()\ *\ fabs(\_anims[0]-\/>get\_ur(0)[1]\ -\/\ \_anims[0]-\/>get\_ll(0)[1]);}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \ \ set\_size(y\_texels\ *\ width\ /\ height,\ y\_texels);}
\DoxyCodeLine{00375\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ size\_from\_texels\ is\ false,\ we\ get\ the\ particle\ size\ from\ the}}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ size\ of\ the\ polygon.}}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ \ \ set\_size(width,\ height);}
\DoxyCodeLine{00379\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ With\ no\ vertices,\ just\ punt.}}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \ \ set\_size(1.0f,\ 1.0f);}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00385\ \ \ \ \ \}}
\DoxyCodeLine{00386\ \ \ \ \ init\_geoms();}
\DoxyCodeLine{00387\ \ \ \}}
\DoxyCodeLine{00388\ \}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00393\ \textcolor{keywordtype}{void}\ SpriteParticleRenderer::}
\DoxyCodeLine{00394\ resize\_pool(\textcolor{keywordtype}{int}\ new\_size)\ \{}
\DoxyCodeLine{00395\ \ \ \textcolor{keywordflow}{if}\ (new\_size\ !=\ \_pool\_size)\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \_pool\_size\ =\ new\_size;}
\DoxyCodeLine{00397\ \ \ \ \ init\_geoms();}
\DoxyCodeLine{00398\ \ \ \}}
\DoxyCodeLine{00399\ \}}
\DoxyCodeLine{00400\ }
\DoxyCodeLine{00405\ \textcolor{keywordtype}{void}\ SpriteParticleRenderer::}
\DoxyCodeLine{00406\ init\_geoms()\ \{}
\DoxyCodeLine{00407\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ \_render\_state;}
\DoxyCodeLine{00408\ \ \ \mbox{\hyperlink{classSpriteAnim}{SpriteAnim}}\ *anim;}
\DoxyCodeLine{00409\ \ \ \textcolor{keywordtype}{int}\ anim\_count\ =\ \_anims.size();}
\DoxyCodeLine{00410\ \ \ \textcolor{keywordtype}{int}\ i,j;}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00412\ \ \ \textcolor{comment}{//\ Setup\ format}}
\DoxyCodeLine{00413\ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ array\_format;}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \textcolor{keywordflow}{if}\ (vertex\_colors\_prefer\_packed)\ \{}
\DoxyCodeLine{00416\ \ \ \ \ array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}}
\DoxyCodeLine{00417\ \ \ \ \ \ \ (InternalName::get\_vertex(),\ 3,\ Geom::NT\_stdfloat,\ Geom::C\_point,}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ InternalName::get\_color(),\ 1,\ Geom::NT\_packed\_dabc,\ Geom::C\_color);}
\DoxyCodeLine{00419\ \ \ \}}
\DoxyCodeLine{00420\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00421\ \ \ \ \ array\_format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}}
\DoxyCodeLine{00422\ \ \ \ \ \ \ (InternalName::get\_vertex(),\ 3,\ Geom::NT\_stdfloat,\ Geom::C\_point,}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ InternalName::get\_color(),\ 4,\ Geom::NT\_uint8,\ Geom::C\_color);}
\DoxyCodeLine{00424\ \ \ \}}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ \textcolor{keywordflow}{if}\ (\_animate\_theta\ ||\ \_theta\ !=\ 0.0f)\ \{}
\DoxyCodeLine{00427\ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00428\ \ \ \ \ \ \ (InternalName::get\_rotate(),\ 1,\ Geom::NT\_stdfloat,\ Geom::C\_other);}
\DoxyCodeLine{00429\ \ \ \}}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00431\ \ \ \_base\_y\_scale\ =\ \_initial\_y\_scale;}
\DoxyCodeLine{00432\ \ \ \_aspect\_ratio\ =\ \_width\ /\ \_height;}
\DoxyCodeLine{00433\ }
\DoxyCodeLine{00434\ \ \ PN\_stdfloat\ final\_x\_scale\ =\ \_animate\_x\_ratio\ ?\ \_final\_x\_scale\ :\ \_initial\_x\_scale;}
\DoxyCodeLine{00435\ \ \ PN\_stdfloat\ final\_y\_scale\ =\ \_animate\_y\_ratio\ ?\ \_final\_y\_scale\ :\ \_initial\_y\_scale;}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ \ \ \textcolor{keywordflow}{if}\ (\_animate\_y\_ratio)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \_base\_y\_scale\ =\ max(\_initial\_y\_scale,\ \_final\_y\_scale);}
\DoxyCodeLine{00439\ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00440\ \ \ \ \ \ \ (InternalName::get\_size(),\ 1,\ Geom::NT\_stdfloat,\ Geom::C\_other);}
\DoxyCodeLine{00441\ \ \ \}}
\DoxyCodeLine{00442\ }
\DoxyCodeLine{00443\ \ \ \textcolor{keywordflow}{if}\ (\_aspect\_ratio\ *\ \_initial\_x\_scale\ !=\ \_initial\_y\_scale\ ||}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \_aspect\_ratio\ *\ final\_x\_scale\ !=\ final\_y\_scale)\ \{}
\DoxyCodeLine{00445\ \ \ \ \ array\_format-\/>add\_column}
\DoxyCodeLine{00446\ \ \ \ \ \ \ (InternalName::get\_aspect\_ratio(),\ 1,\ Geom::NT\_stdfloat,}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ Geom::C\_other);}
\DoxyCodeLine{00448\ \ \ \}}
\DoxyCodeLine{00449\ }
\DoxyCodeLine{00450\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ format\ =\ GeomVertexFormat::register\_format}
\DoxyCodeLine{00451\ \ \ \ \ (\textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}(array\_format));}
\DoxyCodeLine{00452\ }
\DoxyCodeLine{00453\ \ \ \textcolor{comment}{//\ Reset\ render()\ data\ structures}}
\DoxyCodeLine{00454\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ (int)\_ttl\_count.size();\ ++i)\ \{}
\DoxyCodeLine{00455\ \ \ \ \ PANDA\_FREE\_ARRAY(\_ttl\_count[i]);}
\DoxyCodeLine{00456\ \ \ \}}
\DoxyCodeLine{00457\ \ \ \_anim\_size.resize(anim\_count);}
\DoxyCodeLine{00458\ \ \ \_ttl\_count.clear();}
\DoxyCodeLine{00459\ \ \ \_ttl\_count.resize(anim\_count);}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \ \ \textcolor{comment}{//\ Reset\ sprite\ primitive\ data\ in\ order\ to\ prepare\ for\ next\ pass.}}
\DoxyCodeLine{00462\ \ \ \_sprite\_primitive.clear();}
\DoxyCodeLine{00463\ \ \ \_sprites.clear();}
\DoxyCodeLine{00464\ \ \ \_vdata.clear();}
\DoxyCodeLine{00465\ \ \ \_sprite\_writer.clear();}
\DoxyCodeLine{00466\ }
\DoxyCodeLine{00467\ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *render\_node\ =\ get\_render\_node();}
\DoxyCodeLine{00468\ \ \ render\_node-\/>remove\_all\_geoms();}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \textcolor{comment}{//\ For\ each\ animation...}}
\DoxyCodeLine{00471\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00472\ \ \ \ \ anim\ =\ \_anims[i];}
\DoxyCodeLine{00473\ \ \ \ \ \_anim\_size[i]\ =\ anim-\/>get\_num\_frames();}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ \ \ \ \ \_sprite\_primitive.push\_back(\mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classGeom}{Geom}})>());}
\DoxyCodeLine{00476\ \ \ \ \ \_sprites.push\_back(\mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classGeomPoints}{GeomPoints}})>());}
\DoxyCodeLine{00477\ \ \ \ \ \_vdata.push\_back(\mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})>());}
\DoxyCodeLine{00478\ \ \ \ \ \_sprite\_writer.push\_back(\mbox{\hyperlink{classpvector}{pvector<SpriteWriter>}}());}
\DoxyCodeLine{00479\ }
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{comment}{//\ For\ each\ frame\ of\ the\ animation...}}
\DoxyCodeLine{00481\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ \_anim\_size[i];\ ++j)\ \{}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \_ttl\_count[i]\ =\ (\textcolor{keywordtype}{int}\ *)PANDA\_MALLOC\_ARRAY(\_anim\_size[i]\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \_vdata[i].push\_back(\textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}(\textcolor{stringliteral}{"{}sprite\_particles"{}},\ format,\ Geom::UH\_stream));}
\DoxyCodeLine{00484\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(\_vdata[i][j]);}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \_sprite\_primitive[i].push\_back((\mbox{\hyperlink{classGeom}{Geom}}*)geom);}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \_sprites[i].push\_back(\textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomPoints}{GeomPoints}}(Geom::UH\_stream));}
\DoxyCodeLine{00487\ \ \ \ \ \ \ geom-\/>add\_primitive(\_sprites[i][j]);}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ will\ be\ overwritten\ in\ render(),\ but\ we\ had\ to\ have\ some\ initial}}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \textcolor{comment}{//\ value}}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \_sprite\_writer[i].push\_back(\mbox{\hyperlink{classSpriteWriter}{SpriteWriter}}());}
\DoxyCodeLine{00492\ }
\DoxyCodeLine{00493\ \ \ \ \ \ \ state\ =\ state-\/>add\_attrib(RenderModeAttrib::make(RenderModeAttrib::M\_unchanged,\ \_base\_y\_scale\ *\ \_height,\ \textcolor{keyword}{true}));}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (anim-\/>get\_frame(j)\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ state\ =\ state-\/>add\_attrib(TextureAttrib::make(anim-\/>get\_frame(j)));}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ state\ =\ state-\/>add\_attrib(TexGenAttrib::make(TextureStage::get\_default(),\ TexGenAttrib::M\_point\_sprite));}
\DoxyCodeLine{00497\ }
\DoxyCodeLine{00498\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Build\ a\ transform\ to\ convert\ the\ texture\ coordinates\ to\ the\ ll,\ ur}}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ space.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ LPoint2\ ul(anim-\/>get\_ll(j)[0],\ anim-\/>get\_ur(j)[1]);}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ LPoint2\ lr(anim-\/>get\_ur(j)[0],\ anim-\/>get\_ll(j)[1]);}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ LVector2\ sc\ =\ lr\ -\/\ ul;}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ ts\ =\ TransformState::make\_pos\_rotate\_scale2d(ul,\ 0.0f,\ sc);}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ state\ =\ state-\/>add\_attrib(TexMatrixAttrib::make(TextureStage::get\_default(),\ ts));}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \ \ \ \ \ \ render\_node-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(\_sprite\_primitive[i][j],\ state);}
\DoxyCodeLine{00509\ \ \ \ \ \}}
\DoxyCodeLine{00510\ \ \ \}}
\DoxyCodeLine{00511\ }
\DoxyCodeLine{00512\ \ \ nassertv(render\_node-\/>\mbox{\hyperlink{classGeomNode_acd21514059c8e921f616d04adad475e8}{check\_valid}}());}
\DoxyCodeLine{00513\ \}}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00519\ \textcolor{keywordtype}{void}\ SpriteParticleRenderer::}
\DoxyCodeLine{00520\ birth\_particle(\textcolor{keywordtype}{int}\ index)\ \{}
\DoxyCodeLine{00521\ \ \ \_birth\_list.push\_back(index);}
\DoxyCodeLine{00522\ \}}
\DoxyCodeLine{00523\ }
\DoxyCodeLine{00527\ \textcolor{keywordtype}{void}\ SpriteParticleRenderer::}
\DoxyCodeLine{00528\ kill\_particle(\textcolor{keywordtype}{int})\ \{}
\DoxyCodeLine{00529\ \}}
\DoxyCodeLine{00530\ }
\DoxyCodeLine{00534\ \textcolor{keywordtype}{void}\ SpriteParticleRenderer::}
\DoxyCodeLine{00535\ render(\mbox{\hyperlink{classpvector}{pvector}}<\ PT(\mbox{\hyperlink{classPhysicsObject}{PhysicsObject}})\ >\&\ po\_vector,\ \textcolor{keywordtype}{int}\ ttl\_particles)\ \{}
\DoxyCodeLine{00536\ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ t1(\_render\_collector);}
\DoxyCodeLine{00537\ \ \ \textcolor{comment}{//\ There\ is\ no\ texture\ data\ available,\ exit.}}
\DoxyCodeLine{00538\ \ \ \textcolor{keywordflow}{if}\ (\_anims.empty())\ \{}
\DoxyCodeLine{00539\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00540\ \ \ \}}
\DoxyCodeLine{00541\ }
\DoxyCodeLine{00542\ \ \ \mbox{\hyperlink{classBaseParticle}{BaseParticle}}\ *cur\_particle;}
\DoxyCodeLine{00543\ \ \ \textcolor{keywordtype}{int}\ remaining\_particles\ =\ ttl\_particles;}
\DoxyCodeLine{00544\ \ \ \textcolor{keywordtype}{int}\ i,j;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ loop\ counters}}
\DoxyCodeLine{00545\ \ \ \textcolor{keywordtype}{int}\ anim\_count\ =\ \_anims.size();\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ number\ of\ animations}}
\DoxyCodeLine{00546\ \ \ \textcolor{keywordtype}{int}\ frame;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ frame\ index,\ used\ in\ indicating\ which\ frame\ to\ use\ when\ not\ animated}}
\DoxyCodeLine{00547\ \ \ \textcolor{comment}{//\ First,\ since\ this\ is\ the\ only\ time\ we\ have\ access\ to\ the\ actual}}
\DoxyCodeLine{00548\ \ \ \textcolor{comment}{//\ particles,\ do\ some\ delayed\ initialization.}}
\DoxyCodeLine{00549\ \ \ \textcolor{keywordflow}{if}\ (\_animate\_frames\ ||\ anim\_count)\ \{}
\DoxyCodeLine{00550\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_birth\_list.empty())\ \{}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (vector\_int::iterator\ vIter\ =\ \_birth\_list.begin();\ vIter\ !=\ \_birth\_list.end();\ ++vIter)\ \{}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ cur\_particle\ =\ (\mbox{\hyperlink{classBaseParticle}{BaseParticle}}*)po\_vector[*vIter].p();}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ i\ =\ int(NORMALIZED\_RAND()*anim\_count);}
\DoxyCodeLine{00554\ }
\DoxyCodeLine{00555\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there\ are\ multiple\ animations\ to\ choose\ from,\ choose\ one\ at}}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ random\ for\ this\ new\ particle}}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ cur\_particle-\/>set\_index(i\ <\ anim\_count?i:i-\/1);}
\DoxyCodeLine{00558\ }
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ an\ experimental\ age\ offset\ so\ that\ the\ animations\ don't}}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ appear\ synchronized.\ \ If\ we\ are\ using\ animations,\ try\ to\ vary\ the}}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ frame\ flipping\ a\ bit\ for\ particles\ in\ the\ same\ litter.\ \ A\ similar}}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ effect\ might\ be\ a\ achieved\ by\ using\ a\ small\ lifespan\ spread\ value}}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ on\ the\ factory.}}
\DoxyCodeLine{00564\ }
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Perhaps\ we\ should\ look\ into\ other\ methods.\ \ The\ age\ offset\ doesn't}}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ seem\ to\ be\ cutting\ it.}}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_frames)\ \{}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ \ \ cur\_particle-\/>set\_age(cur\_particle-\/>get\_age()+i/10.0*cur\_particle-\/>get\_lifespan());}
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00571\ \ \ \ \ \}}
\DoxyCodeLine{00572\ \ \ \}}
\DoxyCodeLine{00573\ \ \ \_birth\_list.clear();}
\DoxyCodeLine{00574\ }
\DoxyCodeLine{00575\ \ \ \textcolor{comment}{//\ Create\ vertex\ writers\ for\ each\ of\ the\ possible\ geoms.\ \ Could\ possibly\ be}}
\DoxyCodeLine{00576\ \ \ \textcolor{comment}{//\ changed\ to\ only\ create\ writers\ for\ geoms\ that\ would\ be\ used\ according\ to}}
\DoxyCodeLine{00577\ \ \ \textcolor{comment}{//\ the\ animation\ configuration.}}
\DoxyCodeLine{00578\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00579\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ \_anim\_size[i];\ ++j)\ \{}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \textcolor{comment}{//\ Set\ the\ particle\ per\ frame\ counts\ to\ 0.}}
\DoxyCodeLine{00581\ \ \ \ \ \ \ memset(\_ttl\_count[i],\ 0,\ \_anim\_size[i]*\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00582\ \ \ \ \ \ \ \_sprite\_writer[i][j].vertex\ =\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata[i][j],\ InternalName::get\_vertex());}
\DoxyCodeLine{00583\ \ \ \ \ \ \ \_sprite\_writer[i][j].color\ =\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata[i][j],\ InternalName::get\_color());}
\DoxyCodeLine{00584\ \ \ \ \ \ \ \_sprite\_writer[i][j].rotate\ =\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata[i][j],\ InternalName::get\_rotate());}
\DoxyCodeLine{00585\ \ \ \ \ \ \ \_sprite\_writer[i][j].size\ =\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata[i][j],\ InternalName::get\_size());}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \_sprite\_writer[i][j].aspect\_ratio\ =\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata[i][j],\ InternalName::get\_aspect\_ratio());}
\DoxyCodeLine{00587\ \ \ \ \ \}}
\DoxyCodeLine{00588\ \ \ \}}
\DoxyCodeLine{00589\ }
\DoxyCodeLine{00590\ \ \ \textcolor{comment}{//\ init\ the\ aabb}}
\DoxyCodeLine{00591\ \ \ \_aabb\_min.set(99999.0f,\ 99999.0f,\ 99999.0f);}
\DoxyCodeLine{00592\ \ \ \_aabb\_max.set(-\/99999.0f,\ -\/99999.0f,\ -\/99999.0f);}
\DoxyCodeLine{00593\ }
\DoxyCodeLine{00594\ \ \ \textcolor{comment}{//\ run\ through\ every\ filled\ slot}}
\DoxyCodeLine{00595\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ (int)po\_vector.size();\ i++)\ \{}
\DoxyCodeLine{00596\ \ \ \ \ cur\_particle\ =\ (\mbox{\hyperlink{classBaseParticle}{BaseParticle}}\ *)\ po\_vector[i].p();}
\DoxyCodeLine{00597\ }
\DoxyCodeLine{00598\ \ \ \ \ \textcolor{keywordflow}{if}\ (!cur\_particle-\/>get\_alive())\ \{}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00600\ \ \ \ \ \}}
\DoxyCodeLine{00601\ }
\DoxyCodeLine{00602\ \ \ \ \ LPoint3\ position\ =\ cur\_particle-\/>get\_position();}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \ \ \ \ \textcolor{comment}{//\ x\ aabb\ adjust}}
\DoxyCodeLine{00605\ \ \ \ \ \textcolor{keywordflow}{if}\ (position[0]\ >\ \_aabb\_max[0])}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \_aabb\_max[0]\ =\ position[0];}
\DoxyCodeLine{00607\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (position[0]\ <\ \_aabb\_min[0])}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \_aabb\_min[0]\ =\ position[0];}
\DoxyCodeLine{00609\ }
\DoxyCodeLine{00610\ \ \ \ \ \textcolor{comment}{//\ y\ aabb\ adjust}}
\DoxyCodeLine{00611\ \ \ \ \ \textcolor{keywordflow}{if}\ (position[1]\ >\ \_aabb\_max[1])}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \_aabb\_max[1]\ =\ position[1];}
\DoxyCodeLine{00613\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (position[1]\ <\ \_aabb\_min[1])}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \_aabb\_min[1]\ =\ position[1];}
\DoxyCodeLine{00615\ }
\DoxyCodeLine{00616\ \ \ \ \ \textcolor{comment}{//\ z\ aabb\ adjust}}
\DoxyCodeLine{00617\ \ \ \ \ \textcolor{keywordflow}{if}\ (position[2]\ >\ \_aabb\_max[2])}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \_aabb\_max[2]\ =\ position[2];}
\DoxyCodeLine{00619\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (position[2]\ <\ \_aabb\_min[2])}
\DoxyCodeLine{00620\ \ \ \ \ \ \ \_aabb\_min[2]\ =\ position[2];}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ }
\DoxyCodeLine{00623\ \ \ \ \ PN\_stdfloat\ t\ =\ cur\_particle-\/>get\_parameterized\_age();}
\DoxyCodeLine{00624\ \ \ \ \ \textcolor{keywordtype}{int}\ anim\_index\ =\ cur\_particle-\/>get\_index();}
\DoxyCodeLine{00625\ }
\DoxyCodeLine{00626\ \ \ \ \ \textcolor{comment}{//\ If\ an\ animation\ has\ been\ removed,\ we\ need\ to\ reassign\ those\ particles}}
\DoxyCodeLine{00627\ \ \ \ \ \textcolor{comment}{//\ assigned\ to\ the\ removed\ animation.}}
\DoxyCodeLine{00628\ \ \ \ \ \textcolor{keywordflow}{if}(\_animation\_removed\ \&\&\ (anim\_index\ >=\ anim\_count))\ \{}
\DoxyCodeLine{00629\ \ \ \ \ \ \ anim\_index\ =\ int(NORMALIZED\_RAND()*anim\_count);}
\DoxyCodeLine{00630\ \ \ \ \ \ \ anim\_index\ =\ anim\_index<anim\_count?anim\_index:anim\_index-\/1;}
\DoxyCodeLine{00631\ \ \ \ \ \ \ cur\_particle-\/>set\_index(anim\_index);}
\DoxyCodeLine{00632\ \ \ \ \ \}}
\DoxyCodeLine{00633\ }
\DoxyCodeLine{00634\ \ \ \ \ \textcolor{comment}{//\ Find\ the\ frame}}
\DoxyCodeLine{00635\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_frames)\ \{}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_frames\_rate\ ==\ 0.0f)\ \{}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ frame\ =\ (int)(t*\_anim\_size[anim\_index]);}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ frame\ =\ (int)fmod(cur\_particle-\/>get\_age()*\_animate\_frames\_rate+1,\_anim\_size[anim\_index]);}
\DoxyCodeLine{00640\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00641\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00642\ \ \ \ \ \ \ frame\ =\ \_animate\_frames\_index;}
\DoxyCodeLine{00643\ \ \ \ \ \}}
\DoxyCodeLine{00644\ }
\DoxyCodeLine{00645\ \ \ \ \ \textcolor{comment}{//\ Quick\ check\ make\ sure\ our\ math\ above\ didn't\ result\ in\ an\ invalid\ frame.}}
\DoxyCodeLine{00646\ \ \ \ \ frame\ =\ (frame\ <\ \_anim\_size[anim\_index])\ ?\ frame\ :\ (\_anim\_size[anim\_index]-\/1);}
\DoxyCodeLine{00647\ \ \ \ \ ++\_ttl\_count[anim\_index][frame];}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \ \ \ \ \textcolor{comment}{//\ Calculate\ the\ color\ This\ is\ where\ we'll\ want\ to\ give\ the\ renderer\ the}}
\DoxyCodeLine{00650\ \ \ \ \ \textcolor{comment}{//\ new\ color}}
\DoxyCodeLine{00651\ \ \ \ \ LColor\ c\ =\ \_color\_interpolation\_manager-\/>generateColor(t);}
\DoxyCodeLine{00652\ }
\DoxyCodeLine{00653\ \ \ \ \ \textcolor{keywordtype}{int}\ alphamode=get\_alpha\_mode();}
\DoxyCodeLine{00654\ \ \ \ \ \textcolor{keywordflow}{if}\ (alphamode\ !=\ PR\_ALPHA\_NONE)\ \{}
\DoxyCodeLine{00655\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (alphamode\ ==\ PR\_ALPHA\_OUT)}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \ \ c[3]\ *=\ (1.0f\ -\/\ t)\ *\ get\_user\_alpha();}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (alphamode\ ==\ PR\_ALPHA\_IN)}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ c[3]\ *=\ t\ *\ get\_user\_alpha();}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (alphamode\ ==\ PR\_ALPHA\_IN\_OUT)\ \{}
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ c[3]\ *=\ 2.0f\ *\ min(t,\ 1.0f\ -\/\ t)\ *\ get\_user\_alpha();}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00662\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ assert(alphamode\ ==\ PR\_ALPHA\_USER);}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \ \ c[3]\ *=\ get\_user\_alpha();}
\DoxyCodeLine{00665\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00666\ \ \ \ \ \}}
\DoxyCodeLine{00667\ }
\DoxyCodeLine{00668\ \ \ \ \ \textcolor{comment}{//\ Send\ the\ data\ on\ its\ way...}}
\DoxyCodeLine{00669\ \ \ \ \ \_sprite\_writer[anim\_index][frame].vertex.add\_data3(position);}
\DoxyCodeLine{00670\ \ \ \ \ \_sprite\_writer[anim\_index][frame].color.add\_data4(c);}
\DoxyCodeLine{00671\ }
\DoxyCodeLine{00672\ \ \ \ \ PN\_stdfloat\ current\_x\_scale\ =\ \_initial\_x\_scale;}
\DoxyCodeLine{00673\ \ \ \ \ PN\_stdfloat\ current\_y\_scale\ =\ \_initial\_y\_scale;}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_x\_ratio\ ||\ \_animate\_y\_ratio)\ \{}
\DoxyCodeLine{00676\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_blend\_method\ ==\ PP\_BLEND\_CUBIC)\ \{}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \ \ t\ =\ CUBIC\_T(t);}
\DoxyCodeLine{00678\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00679\ }
\DoxyCodeLine{00680\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_x\_ratio)\ \{}
\DoxyCodeLine{00681\ \ \ \ \ \ \ \ \ current\_x\_scale\ =\ (\_initial\_x\_scale\ +}
\DoxyCodeLine{00682\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (t\ *\ (\_final\_x\_scale\ -\/\ \_initial\_x\_scale)));}
\DoxyCodeLine{00683\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00684\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_y\_ratio)\ \{}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \ \ current\_y\_scale\ =\ (\_initial\_y\_scale\ +}
\DoxyCodeLine{00686\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (t\ *\ (\_final\_y\_scale\ -\/\ \_initial\_y\_scale)));}
\DoxyCodeLine{00687\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00688\ \ \ \ \ \}}
\DoxyCodeLine{00689\ }
\DoxyCodeLine{00690\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_sprite\_writer[anim\_index][frame].size.has\_column())\ \{}
\DoxyCodeLine{00691\ \ \ \ \ \ \ \_sprite\_writer[anim\_index][frame].size.add\_data1f(current\_y\_scale\ *\ \_height);}
\DoxyCodeLine{00692\ \ \ \ \ \}}
\DoxyCodeLine{00693\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_sprite\_writer[anim\_index][frame].aspect\_ratio.has\_column())\ \{}
\DoxyCodeLine{00694\ \ \ \ \ \ \ \_sprite\_writer[anim\_index][frame].aspect\_ratio.add\_data1f(\_aspect\_ratio\ *\ current\_x\_scale\ /\ current\_y\_scale);}
\DoxyCodeLine{00695\ \ \ \ \ \}}
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_animate\_theta)\ \{}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \_sprite\_writer[anim\_index][frame].rotate.add\_data1f(cur\_particle-\/>\mbox{\hyperlink{classBaseParticle_a97503df341ef6ef75e052400a116c829}{get\_theta}}());}
\DoxyCodeLine{00698\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_sprite\_writer[anim\_index][frame].rotate.has\_column())\ \{}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \_sprite\_writer[anim\_index][frame].rotate.add\_data1f(\_theta);}
\DoxyCodeLine{00700\ \ \ \ \ \}}
\DoxyCodeLine{00701\ }
\DoxyCodeLine{00702\ \ \ \ \ \textcolor{comment}{//\ maybe\ jump\ out\ early?}}
\DoxyCodeLine{00703\ \ \ \ \ remaining\_particles-\/-\/;}
\DoxyCodeLine{00704\ \ \ \ \ \textcolor{keywordflow}{if}\ (remaining\_particles\ ==\ 0)\ \{}
\DoxyCodeLine{00705\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00706\ \ \ \ \ \}}
\DoxyCodeLine{00707\ \ \ \}}
\DoxyCodeLine{00708\ \ \ \textcolor{keywordtype}{int}\ n\ =\ 0;}
\DoxyCodeLine{00709\ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *render\_node\ =\ get\_render\_node();}
\DoxyCodeLine{00710\ }
\DoxyCodeLine{00711\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00712\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ \_anim\_size[i];\ ++j)\ \{}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \_sprites[i][j]-\/>clear\_vertices();}
\DoxyCodeLine{00714\ \ \ \ \ \ \ \_sprite\_writer[i][j].clear();}
\DoxyCodeLine{00715\ }
\DoxyCodeLine{00716\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ reassign\ the\ GeomVertexData\ and\ GeomPrimitive\ to\ the\ Geom,}}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \textcolor{comment}{//\ and\ the\ Geom\ to\ the\ GeomNode,\ in\ case\ it\ got\ flattened\ away.}}
\DoxyCodeLine{00718\ \ \ \ \ \ \ \_sprite\_primitive[i][j]-\/>set\_primitive(0,\ \_sprites[i][j]);}
\DoxyCodeLine{00719\ \ \ \ \ \ \ \_sprite\_primitive[i][j]-\/>set\_vertex\_data(\_vdata[i][j]);}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00721\ \ \ \ \ \ \ render\_node-\/>\mbox{\hyperlink{classGeomNode_a7ff87a416a4b0f4adc472329aef5128f}{set\_geom}}(n,\ \_sprite\_primitive[i][j]);}
\DoxyCodeLine{00722\ \ \ \ \ \ \ ++n;}
\DoxyCodeLine{00723\ \ \ \ \ \}}
\DoxyCodeLine{00724\ \ \ \}}
\DoxyCodeLine{00725\ }
\DoxyCodeLine{00726\ \ \ \textcolor{keywordflow}{if}\ (\_animate\_frames)\ \{}
\DoxyCodeLine{00727\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00728\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ \_anim\_size[i];\ ++j)\ \{}
\DoxyCodeLine{00729\ \ \ \ \ \ \ \ \ \_sprites[i][j]-\/>add\_next\_vertices(\_ttl\_count[i][j]);}
\DoxyCodeLine{00730\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00731\ \ \ \ \ \}}
\DoxyCodeLine{00732\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00733\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \_sprites[i][\_animate\_frames\_index]-\/>add\_next\_vertices(\_ttl\_count[i][\_animate\_frames\_index]);}
\DoxyCodeLine{00735\ \ \ \ \ \}}
\DoxyCodeLine{00736\ \ \ \}}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \textcolor{comment}{//\ done\ filling\ geompoint\ node,\ now\ do\ the\ bb\ stuff}}
\DoxyCodeLine{00739\ \ \ LPoint3\ aabb\_center\ =\ \_aabb\_min\ +\ ((\_aabb\_max\ -\/\ \_aabb\_min)\ *\ 0.5f);}
\DoxyCodeLine{00740\ \ \ PN\_stdfloat\ radius\ =\ (aabb\_center\ -\/\ \_aabb\_min).length();}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ anim\_count;\ ++i)\ \{}
\DoxyCodeLine{00743\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ \_anim\_size[i];\ ++j)\ \{}
\DoxyCodeLine{00744\ \ \ \ \ \ \ nassertv(\_sprite\_primitive[i][j]-\/>check\_valid());}
\DoxyCodeLine{00745\ \ \ \ \ \ \ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}\ sphere(aabb\_center,\ radius);}
\DoxyCodeLine{00746\ \ \ \ \ \ \ \_sprite\_primitive[i][j]-\/>set\_bounds(\&sphere);}
\DoxyCodeLine{00747\ \ \ \ \ \}}
\DoxyCodeLine{00748\ \ \ \}}
\DoxyCodeLine{00749\ }
\DoxyCodeLine{00750\ \ \ get\_render\_node()-\/>mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00751\ \ \ nassertv(render\_node-\/>\mbox{\hyperlink{classGeomNode_acd21514059c8e921f616d04adad475e8}{check\_valid}}());}
\DoxyCodeLine{00752\ \ \ \_animation\_removed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00753\ \}}
\DoxyCodeLine{00754\ }
\DoxyCodeLine{00758\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_ab7d86aa5c03b85ccb4e7bc7bb4980a7a}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00759\ \mbox{\hyperlink{classSpriteParticleRenderer_ab7d86aa5c03b85ccb4e7bc7bb4980a7a}{output}}(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00760\ \textcolor{preprocessor}{\ \ \#ifndef\ NDEBUG\ }\textcolor{comment}{//[}}
\DoxyCodeLine{00761\ \ \ out<<\textcolor{stringliteral}{"{}SpriteParticleRenderer"{}};}
\DoxyCodeLine{00762\ \textcolor{preprocessor}{\ \ \#endif\ }\textcolor{comment}{//]\ NDEBUG}}
\DoxyCodeLine{00763\ \}}
\DoxyCodeLine{00764\ }
\DoxyCodeLine{00768\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classSpriteParticleRenderer_abfb8fe26fed3c4fb8838a9fe6137f3f3}{SpriteParticleRenderer::}}}
\DoxyCodeLine{00769\ \mbox{\hyperlink{classSpriteParticleRenderer_abfb8fe26fed3c4fb8838a9fe6137f3f3}{write}}(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00770\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}SpriteParticleRenderer:\(\backslash\)n"{}};}
\DoxyCodeLine{00771\ \ \ \textcolor{comment}{//\ indent(out,\ indent\_level\ +\ 2)\ <<\ "{}\_sprite\_primitive}}
\DoxyCodeLine{00772\ \ \ \textcolor{comment}{//\ "{}<<\_sprite\_primitive<<"{}\(\backslash\)n"{};}}
\DoxyCodeLine{00773\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_color\ "{}}<<\_color<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00774\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_initial\_x\_scale\ "{}}<<\_initial\_x\_scale<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00775\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_final\_x\_scale\ "{}}<<\_final\_x\_scale<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00776\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_initial\_y\_scale\ "{}}<<\_initial\_y\_scale<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00777\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_final\_y\_scale\ "{}}<<\_final\_y\_scale<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00778\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_theta\ "{}}<<\_theta<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00779\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_animate\_x\_ratio\ "{}}<<\_animate\_x\_ratio<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00780\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_animate\_y\_ratio\ "{}}<<\_animate\_y\_ratio<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00781\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_animate\_theta\ "{}}<<\_animate\_theta<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00782\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_blend\_method\ "{}}<<\_blend\_method<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00783\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_aabb\_min\ "{}}<<\_aabb\_min<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00784\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_aabb\_max\ "{}}<<\_aabb\_max<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00785\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)\ <<\ \textcolor{stringliteral}{"{}\_pool\_size\ "{}}<<\_pool\_size<<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00786\ \ \ BaseParticleRenderer::write(out,\ indent\_level\ +\ 2);}
\DoxyCodeLine{00787\ \}}

\end{DoxyCode}
