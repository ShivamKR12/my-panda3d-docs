\doxysection{weak\+Reference\+List.\+cxx}
\hypertarget{weakReferenceList_8cxx_source}{}\label{weakReferenceList_8cxx_source}\index{panda/src/express/weakReferenceList.cxx@{panda/src/express/weakReferenceList.cxx}}
\mbox{\hyperlink{weakReferenceList_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{weakReferenceList_8h}{weakReferenceList.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{weakPointerToVoid_8h}{weakPointerToVoid.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnotify_8h}{pnotify.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00021\ WeakReferenceList::}
\DoxyCodeLine{00022\ WeakReferenceList()\ :\ \_count(\_alive\_offset)\ \{}
\DoxyCodeLine{00023\ \}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00028\ \mbox{\hyperlink{classWeakReferenceList_a411b553c092844a08a32481ddfb779ca}{WeakReferenceList::}}}
\DoxyCodeLine{00029\ \mbox{\hyperlink{classWeakReferenceList_a411b553c092844a08a32481ddfb779ca}{\string~WeakReferenceList}}()\ \{}
\DoxyCodeLine{00030\ \ \ nassertv(\_count.load(std::memory\_order\_relaxed)\ ==\ 0);}
\DoxyCodeLine{00031\ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00043\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWeakReferenceList_a07956ca531cacd89ece8cc7e441d5458}{WeakReferenceList::}}}
\DoxyCodeLine{00044\ \mbox{\hyperlink{classWeakReferenceList_a07956ca531cacd89ece8cc7e441d5458}{add\_callback}}(\mbox{\hyperlink{classWeakPointerCallback}{WeakPointerCallback}}\ *callback,\ \textcolor{keywordtype}{void}\ *data)\ \{}
\DoxyCodeLine{00045\ \ \ nassertv(callback\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00046\ \ \ \_lock.lock();}
\DoxyCodeLine{00047\ \ \ \textcolor{comment}{//\ We\ need\ to\ check\ again\ whether\ the\ object\ is\ deleted\ after\ grabbing\ the}}
\DoxyCodeLine{00048\ \ \ \textcolor{comment}{//\ lock,\ despite\ having\ already\ done\ this\ in\ weakPointerTo.I,\ since\ it\ may}}
\DoxyCodeLine{00049\ \ \ \textcolor{comment}{//\ have\ been\ deleted\ in\ the\ meantime.}}
\DoxyCodeLine{00050\ \ \ \textcolor{keywordtype}{bool}\ deleted\ =\ was\_deleted();}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordflow}{if}\ (!deleted)\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \_callbacks.insert(std::make\_pair(callback,\ data));}
\DoxyCodeLine{00053\ \ \ \}}
\DoxyCodeLine{00054\ \ \ \_lock.unlock();}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \textcolor{keywordflow}{if}\ (deleted)\ \{}
\DoxyCodeLine{00057\ \ \ \ \ callback-\/>wp\_callback(data);}
\DoxyCodeLine{00058\ \ \ \}}
\DoxyCodeLine{00059\ \}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00069\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWeakReferenceList_aa97fdbe8dd4e7de1e9bb7e871972de07}{WeakReferenceList::}}}
\DoxyCodeLine{00070\ \mbox{\hyperlink{classWeakReferenceList_aa97fdbe8dd4e7de1e9bb7e871972de07}{remove\_callback}}(\mbox{\hyperlink{classWeakPointerCallback}{WeakPointerCallback}}\ *callback)\ \{}
\DoxyCodeLine{00071\ \ \ nassertv(callback\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00072\ \ \ \_lock.lock();}
\DoxyCodeLine{00073\ \ \ \_callbacks.erase(callback);}
\DoxyCodeLine{00074\ \ \ \_lock.unlock();}
\DoxyCodeLine{00075\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00083\ \textcolor{keywordtype}{void}\ WeakReferenceList::}
\DoxyCodeLine{00084\ mark\_deleted()\ \{}
\DoxyCodeLine{00085\ \ \ \_lock.lock();}
\DoxyCodeLine{00086\ \ \ Callbacks::iterator\ ci;}
\DoxyCodeLine{00087\ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ \_callbacks.begin();\ ci\ !=\ \_callbacks.end();\ ++ci)\ \{}
\DoxyCodeLine{00088\ \ \ \ \ (*ci).first-\/>wp\_callback((*ci).second);}
\DoxyCodeLine{00089\ \ \ \}}
\DoxyCodeLine{00090\ \ \ \_callbacks.clear();}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \textcolor{comment}{//\ Decrement\ the\ special\ offset\ added\ to\ the\ weak\ pointer\ count\ to\ indicate}}
\DoxyCodeLine{00093\ \ \ \textcolor{comment}{//\ that\ it\ can\ be\ deleted\ when\ all\ the\ weak\ references\ have\ gone.}}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordtype}{int}\ result\ =\ \_count.fetch\_sub(\_alive\_offset,\ std::memory\_order\_relaxed)\ -\/\ \_alive\_offset;}
\DoxyCodeLine{00095\ \ \ \_lock.unlock();}
\DoxyCodeLine{00096\ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ 0)\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{comment}{//\ There\ are\ no\ weak\ references\ remaining\ either,\ so\ delete\ this.}}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keyword}{delete}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ \ \ nassertv(result\ >=\ 0);}
\DoxyCodeLine{00101\ \}}

\end{DoxyCode}
