\doxysection{geom\+Node.\+cxx}
\hypertarget{geomNode_8cxx_source}{}\label{geomNode_8cxx_source}\index{panda/src/pgraph/geomNode.cxx@{panda/src/pgraph/geomNode.cxx}}
\mbox{\hyperlink{geomNode_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTransformer_8h}{geomTransformer.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sceneGraphReducer_8h}{sceneGraphReducer.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{stateMunger_8h}{stateMunger.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{accumulatedAttribs_8h}{accumulatedAttribs.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{colorAttrib_8h}{colorAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{colorScaleAttrib_8h}{colorScaleAttrib.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullFaceAttrib_8h}{cullFaceAttrib.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texMatrixAttrib_8h}{texMatrixAttrib.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{textureAttrib_8h}{textureAttrib.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{shaderAttrib_8h}{shaderAttrib.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullableObject_8h}{cullableObject.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullHandler_8h}{cullHandler.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverser_8h}{cullTraverser.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pset_8h}{pset.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pgraph_8h}{config\_pgraph.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsStateGuardianBase_8h}{graphicsStateGuardianBase.h}}"{}}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingBox_8h}{boundingBox.h}}"{}}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__mathutil_8h}{config\_mathutil.h}}"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{preparedGraphicsObjects_8h}{preparedGraphicsObjects.h}}"{}}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{instanceList_8h}{instanceList.h}}"{}}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \textcolor{keywordtype}{bool}\ allow\_flatten\_color\ =\ \mbox{\hyperlink{classConfigVariableBool}{ConfigVariableBool}}}
\DoxyCodeLine{00046\ \ \ \ \ (\textcolor{stringliteral}{"{}allow-\/flatten-\/color"{}},\ \textcolor{keyword}{false},}
\DoxyCodeLine{00047\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}allows\ color\ to\ always\ be\ flattened\ to\ vertices"{}}));}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ GeomNode::\_type\_handle;}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ GeomNode::}
\DoxyCodeLine{00055\ GeomNode(\textcolor{keyword}{const}\ std::string\ \&name)\ :}
\DoxyCodeLine{00056\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(name)}
\DoxyCodeLine{00057\ \{}
\DoxyCodeLine{00058\ \ \ \_preserved\ =\ preserve\_geom\_nodes;}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ GeomNodes\ have\ a\ certain\ set\ of\ bits\ on\ by\ default.}}
\DoxyCodeLine{00061\ \ \ set\_into\_collide\_mask(get\_default\_collide\_mask());}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ set\_renderable();}
\DoxyCodeLine{00064\ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00069\ GeomNode::}
\DoxyCodeLine{00070\ GeomNode(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ \&copy)\ :}
\DoxyCodeLine{00071\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}(copy),}
\DoxyCodeLine{00072\ \ \ \_preserved(copy.\_preserved),}
\DoxyCodeLine{00073\ \ \ \_cycler(copy.\_cycler)}
\DoxyCodeLine{00074\ \{}
\DoxyCodeLine{00075\ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00080\ GeomNode::}
\DoxyCodeLine{00081\ \string~GeomNode()\ \{}
\DoxyCodeLine{00082\ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00089\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classGeomNode_a280099fb91e248c826a6bf4eff6975b6}{GeomNode::}}}
\DoxyCodeLine{00090\ \mbox{\hyperlink{classGeomNode_a280099fb91e248c826a6bf4eff6975b6}{make\_copy}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00092\ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00103\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a4949e92d3f7195ddba8f131b10b295d7}{GeomNode::}}}
\DoxyCodeLine{00104\ \mbox{\hyperlink{classGeomNode_a4949e92d3f7195ddba8f131b10b295d7}{apply\_attribs\_to\_vertices}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classAccumulatedAttribs}{AccumulatedAttribs}}\ \&attribs,\ \textcolor{keywordtype}{int}\ attrib\_types,}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ \&transformer)\ \{}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_debug())\ \{}
\DoxyCodeLine{00107\ \ \ \ \ pgraph\_cat.debug()}
\DoxyCodeLine{00108\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Transforming\ geometry:\(\backslash\)n"{}};}
\DoxyCodeLine{00109\ \ \ \ \ attribs.write(pgraph\_cat.debug(\textcolor{keyword}{false}),\ attrib\_types,\ 2);}
\DoxyCodeLine{00110\ \ \ \}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_transform)\ !=\ 0)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{if}\ (!attribs.\_transform-\/>is\_identity())\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_a90c1f54a951b8de56ae2cabc76307547}{transform\_vertices}}(\textcolor{keyword}{this},\ attribs.\_transform-\/>get\_mat());}
\DoxyCodeLine{00115\ \ \ \ \ \}}
\DoxyCodeLine{00116\ \ \ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00119\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00121\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{//\ Iterate\ based\ on\ the\ number\ of\ geoms,\ not\ using\ STL\ iterators.\ \ This}}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ allows\ us\ to\ append\ to\ the\ list\ in\ the\ code\ below\ (which\ we\ might\ do}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{//\ when\ doublesiding\ polys)\ without\ visiting\ those\ new\ nodes\ during\ the}}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{comment}{//\ traversal.}}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num\_geoms\ =\ geoms-\/>size();}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_geoms;\ ++i)\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ *entry\ =\ \&(*geoms)[i];}
\DoxyCodeLine{00130\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ new\_geom\ =\ entry-\/>\_geom.get\_read\_pointer()-\/>make\_copy();}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \ \ \mbox{\hyperlink{classAccumulatedAttribs}{AccumulatedAttribs}}\ geom\_attribs\ =\ attribs;}
\DoxyCodeLine{00133\ \ \ \ \ \ \ entry-\/>\_state\ =\ geom\_attribs.\mbox{\hyperlink{classAccumulatedAttribs_a356865421675298cdef0f64e497c1fae}{collect}}(entry-\/>\_state,\ attrib\_types);}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_color)\ !=\ 0)\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ ra\ =\ geom\_attribs.\_color;}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ra\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \textcolor{keyword}{override}\ =\ geom\_attribs.\_color\_override;}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>add\_attrib(ra,\ \textcolor{keyword}{override});}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ ra\ =\ entry-\/>\_state-\/>get\_attrib\_def(ColorAttrib::get\_class\_slot());}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ CPT\ (\mbox{\hyperlink{classColorAttrib}{ColorAttrib}})\ ca\ =\ DCAST(\mbox{\hyperlink{classColorAttrib}{ColorAttrib}},\ ra);}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ca-\/>get\_color\_type()\ !=\ ColorAttrib::T\_vertex)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(allow\_flatten\_color)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(transformer.\mbox{\hyperlink{classGeomTransformer_aa91113bdc7b58116316f28550f324817}{set\_color}}(new\_geom,\ ca-\/>get\_color()))\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>set\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (transformer.\mbox{\hyperlink{classGeomTransformer_aa9ecf4d903a1a04a08b186abdf150a60}{remove\_column}}(new\_geom,\ InternalName::get\_color()))\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_color\_scale)\ !=\ 0)\ \{}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_attribs.\_color\_scale\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classColorScaleAttrib}{ColorScaleAttrib}})\ csa\ =\ DCAST(\mbox{\hyperlink{classColorScaleAttrib}{ColorScaleAttrib}},\ geom\_attribs.\_color\_scale);}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (csa-\/>get\_scale()\ !=\ LVecBase4(1.0f,\ 1.0f,\ 1.0f,\ 1.0f))\ \{}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now,\ if\ we\ have\ an\ "{}off"{}\ or\ "{}flat"{}\ color\ attribute,\ we\ simply}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ modify\ the\ color\ attribute,\ and\ leave\ the\ vertices\ alone.}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ ra\ =\ entry-\/>\_state-\/>get\_attrib\_def(ColorAttrib::get\_class\_slot());}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classColorAttrib}{ColorAttrib}})\ ca\ =\ DCAST(\mbox{\hyperlink{classColorAttrib}{ColorAttrib}},\ ra);}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(allow\_flatten\_color)\ \{}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (transformer.\mbox{\hyperlink{classGeomTransformer_a8492463bc7f9c31d98b218e646b1b5f5}{transform\_colors}}(new\_geom,\ csa-\/>get\_scale()))\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ca-\/>get\_color\_type()\ ==\ ColorAttrib::T\_off)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>set\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ColorAttrib::T\_off\ means\ the\ color\ scale\ becomes\ the\ new}}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ color.}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>set\_attrib(ColorAttrib::make\_flat(csa-\/>get\_scale()));}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (ca-\/>get\_color\_type()\ ==\ ColorAttrib::T\_flat)\ \{}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ColorAttrib::T\_flat\ means\ the\ color\ scale\ modulates\ the}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ specified\ color\ to\ produce\ a\ new\ color.}}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LColor\ \&c1\ =\ ca-\/>get\_color();}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LVecBase4\ \&c2\ =\ csa-\/>get\_scale();}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LColor\ \mbox{\hyperlink{structcolor}{color}}(c1[0]\ *\ c2[0],\ c1[1]\ *\ c2[1],}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ c1[2]\ *\ c2[2],\ c1[3]\ *\ c2[3]);}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>set\_attrib(ColorAttrib::make\_flat(\mbox{\hyperlink{structcolor}{color}}));}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ have\ vertex\ color,\ and\ we\ just\ scale\ it}}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ normally.}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (transformer.\mbox{\hyperlink{classGeomTransformer_a8492463bc7f9c31d98b218e646b1b5f5}{transform\_colors}}(new\_geom,\ csa-\/>get\_scale()))\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>set\_attrib(ColorAttrib::make\_vertex());}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_tex\_matrix)\ !=\ 0)\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_attribs.\_tex\_matrix\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Determine\ which\ texture\ coordinate\ names\ are\ used\ more\ than\ once.}}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ assumes\ we\ have\ discovered\ all\ of\ the\ textures\ that\ are\ in}}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ effect\ on\ the\ GeomNode;\ this\ may\ not\ be\ true\ if\ there\ is\ a}}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ texture\ that\ has\ been\ applied\ at\ a\ node\ above\ that\ from\ which\ we}}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ started\ the\ flatten\ operation,\ but\ caveat\ programmer.}}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classpmap}{pmap}}<\mbox{\hyperlink{classInternalName}{InternalName}}\ *,\ \mbox{\hyperlink{classpset}{pset}}<CPT(\mbox{\hyperlink{classTransformState}{TransformState}})>\ >\ name\_transforms;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTexMatrixAttrib}{TexMatrixAttrib}}\ *tma\ =}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classTexMatrixAttrib}{TexMatrixAttrib}},\ geom\_attribs.\_tex\_matrix);}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ tma-\/>get\_num\_stages();}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ i++)\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTextureStage}{TextureStage}}\ *stage\ =\ tma-\/>get\_stage(i);}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ stage-\/>get\_texcoord\_name();}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ name\_transforms[name].insert(tma-\/>get\_transform(stage)-\/>get\_unique());}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_attribs.\_texture\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ may\ be\ stages\ without\ a\ TexMatrixAttrib,\ which\ implicitly}}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ the\ identity\ transform.}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTextureAttrib}{TextureAttrib}}\ *ta\ =\ DCAST(\mbox{\hyperlink{classTextureAttrib}{TextureAttrib}},\ geom\_attribs.\_texture);}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_on\_stages\ =\ ta-\/>get\_num\_on\_stages();}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ si\ =\ 0;\ si\ <\ num\_on\_stages;\ si++)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTextureStage}{TextureStage}}\ *stage\ =\ ta-\/>get\_on\_stage(si);}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ stage-\/>get\_texcoord\_name();}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!tma-\/>has\_stage(stage))\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\_transforms[name].insert(TransformState::make\_identity());}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTexMatrixAttrib}{TexMatrixAttrib}})\ new\_tma\ =\ DCAST(\mbox{\hyperlink{classTexMatrixAttrib}{TexMatrixAttrib}},\ TexMatrixAttrib::make());}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ i++)\ \{}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTextureStage}{TextureStage}}\ *stage\ =\ tma-\/>get\_stage(i);}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classInternalName}{InternalName}}\ *name\ =\ stage-\/>get\_texcoord\_name();}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ it\ =\ name\_transforms.find(name);}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (it\ ==\ name\_transforms.end())\ \{}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Already\ processed\ this\ set.}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (it-\/>second.size()\ !=\ 1)\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can't\ transform\ these\ texcoords,\ since\ the\ name\ is\ used\ by}}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ more\ than\ one\ active\ stage.}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_tma\ =\ DCAST(\mbox{\hyperlink{classTexMatrixAttrib}{TexMatrixAttrib}},\ new\_tma-\/>add\_stage(stage,\ tma-\/>get\_transform(stage)));}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ It's\ safe\ to\ transform\ these\ texcoords;\ the\ name\ is\ used\ by}}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ no\ more\ than\ one\ active\ stage,\ or\ all\ these\ stages\ have\ the}}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ same\ transform.}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform\ =\ *(it-\/>second.begin());}
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform-\/>is\_identity()\ \&\&}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_ac813e4b0a61c3aa52f1719c22852039a}{transform\_texcoords}}(new\_geom,\ name,\ name,\ transform-\/>get\_mat()))\ \{}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ make\ sure\ we\ don't\ transform\ this\ set\ more\ than\ once.}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\_transforms.erase(it);}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!new\_tma-\/>is\_empty())\ \{}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ entry-\/>\_state-\/>add\_attrib(new\_tma);}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_other)\ !=\ 0)\ \{}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ entry-\/>\_state\ =\ geom\_attribs.\_other-\/>compose(entry-\/>\_state);}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ handle\ cull\_face\ last,\ since\ that\ might\ involve\ duplicating\ the}}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \textcolor{comment}{//\ geom,\ and\ we'd\ also\ like\ to\ duplicate\ all\ of\ the\ changes\ we\ may\ have}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \textcolor{comment}{//\ applied\ in\ the\ above.}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_cull\_face)\ !=\ 0)\ \{}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_attribs.\_cull\_face\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCullFaceAttrib}{CullFaceAttrib}}\ *cfa\ =\ DCAST(\mbox{\hyperlink{classCullFaceAttrib}{CullFaceAttrib}},\ geom\_attribs.\_cull\_face);}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ CullFaceAttrib::Mode\ mode\ =\ cfa-\/>get\_effective\_mode();}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (mode)\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CullFaceAttrib::M\_cull\_none:}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Doublesided\ polys.\ \ Duplicate\ them.}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ has\_normals\ =\ (new\_geom-\/>get\_vertex\_data()-\/>has\_column(InternalName::get\_normal()));}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_normals)\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ geometry\ has\ normals,\ we\ have\ to\ duplicate\ it\ to}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ reverse\ the\ normals\ on\ the\ duplicate\ copy.}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ dup\_geom\ =\ new\_geom-\/>reverse();}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_a81959c70528771cd4c4b5f271d9bae55}{reverse\_normals}}(dup\_geom);}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ geoms-\/>push\_back(\mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}(dup\_geom,\ entry-\/>\_state));}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ above\ push\_back()\ operation\ might\ have\ invalidated\ our}}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ old\ pointer\ into\ the\ list,\ so\ we\ reassign\ it\ now.}}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry\ =\ \&(*geoms)[i];}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there\ are\ no\ normals,\ we\ can\ just\ doubleside\ it\ in}}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ place.\ \ This\ is\ preferable\ because\ we\ can\ share\ vertices.}}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_geom-\/>doubleside\_in\_place();}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ CullFaceAttrib::M\_cull\_counter\_clockwise:}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reverse\ winding\ order.}}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ new\_geom-\/>reverse\_in\_place();}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_a81959c70528771cd4c4b5f271d9bae55}{reverse\_normals}}(new\_geom);}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00318\ }
\DoxyCodeLine{00319\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ entry-\/>\_geom\ =\ new\_geom;}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00322\ \ \ \ \ \}}
\DoxyCodeLine{00323\ \ \ \}}
\DoxyCodeLine{00324\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_apply\_texture\_color)\ !=\ 0)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_a5f2c7a85ad1143499f8228c7be4c7db7}{apply\_texture\_colors}}(\textcolor{keyword}{this},\ attribs.\_other);}
\DoxyCodeLine{00328\ \ \ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_af68df9bb98381a78db84d6b874084bd3}{register\_vertices}}(\textcolor{keyword}{this},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00331\ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00341\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a32aa1883e84d75662be2633434063c83}{GeomNode::}}}
\DoxyCodeLine{00342\ \mbox{\hyperlink{classGeomNode_a32aa1883e84d75662be2633434063c83}{xform}}(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\ \{}
\DoxyCodeLine{00343\ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ transformer;}
\DoxyCodeLine{00344\ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_a90c1f54a951b8de56ae2cabc76307547}{transform\_vertices}}(\textcolor{keyword}{this},\ mat);}
\DoxyCodeLine{00345\ \}}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00354\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classGeomNode_a5b9980d7bb630da104ff3592fca68a42}{GeomNode::}}}
\DoxyCodeLine{00355\ \mbox{\hyperlink{classGeomNode_a5b9980d7bb630da104ff3592fca68a42}{safe\_to\_flatten}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00356\ \ \ \textcolor{keywordflow}{if}\ (\_preserved)\ \{}
\DoxyCodeLine{00357\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00358\ \ \ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00361\ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00369\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classGeomNode_a1e96225ea57f2b04f0adbc4648157446}{GeomNode::}}}
\DoxyCodeLine{00370\ \mbox{\hyperlink{classGeomNode_a1e96225ea57f2b04f0adbc4648157446}{safe\_to\_combine}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00371\ \ \ \textcolor{keywordflow}{if}\ (\_preserved)\ \{}
\DoxyCodeLine{00372\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00373\ \ \ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00376\ \}}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00382\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a963d41a835ef293f3c90bfa62e76391b}{GeomNode::}}}
\DoxyCodeLine{00383\ \mbox{\hyperlink{classGeomNode_a963d41a835ef293f3c90bfa62e76391b}{r\_prepare\_scene}}(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *node\_state,}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ \&transformer,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00385\ \ \ \mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects\ =\ gsg-\/>get\_prepared\_objects();}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00387\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler,\ current\_thread);}
\DoxyCodeLine{00388\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00389\ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00390\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00391\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00392\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ geom\_state\ =\ node\_state-\/>compose(entry.\_state);}
\DoxyCodeLine{00393\ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{comment}{//\ Munge\ the\ geom\ as\ required\ by\ the\ GSG.}}
\DoxyCodeLine{00396\ \ \ \ \ PT(\mbox{\hyperlink{classGeomMunger}{GeomMunger}})\ munger\ =\ gsg-\/>get\_geom\_munger(geom\_state,\ current\_thread);}
\DoxyCodeLine{00397\ \ \ \ \ geom\ =\ transformer.premunge\_geom(geom,\ munger);}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00399\ \ \ \ \ \textcolor{comment}{//\ Prepare\ each\ of\ the\ vertex\ arrays\ in\ the\ munged\ Geom.}}
\DoxyCodeLine{00400\ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ geom-\/>get\_animated\_vertex\_data(\textcolor{keyword}{false},\ current\_thread);}
\DoxyCodeLine{00401\ \ \ \ \ \mbox{\hyperlink{classGeomVertexDataPipelineReader}{GeomVertexDataPipelineReader}}\ vdata\_reader(vdata,\ current\_thread);}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_arrays\ =\ vdata\_reader.get\_num\_arrays();}
\DoxyCodeLine{00403\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_arrays;\ ++i)\ \{}
\DoxyCodeLine{00404\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexArrayData}{GeomVertexArrayData}})\ array\ =\ vdata\_reader.get\_array(i);}
\DoxyCodeLine{00405\ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_a079c30ee715d902194d78a002f8956d3}{enqueue\_vertex\_buffer}}((\mbox{\hyperlink{classGeomVertexArrayData}{GeomVertexArrayData}}\ *)array.p());}
\DoxyCodeLine{00406\ \ \ \ \ \}}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \ \ \textcolor{comment}{//\ And\ also\ each\ of\ the\ index\ arrays.}}
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_primitives\ =\ geom-\/>get\_num\_primitives();}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_primitives;\ ++i)\ \{}
\DoxyCodeLine{00411\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeomPrimitive}{GeomPrimitive}})\ prim\ =\ geom-\/>get\_primitive(i);}
\DoxyCodeLine{00412\ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_adf09abd6c22be7507612524390a07f91}{enqueue\_index\_buffer}}((\mbox{\hyperlink{classGeomPrimitive}{GeomPrimitive}}\ *)prim.p());}
\DoxyCodeLine{00413\ \ \ \ \ \}}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \ \ \textcolor{comment}{//\ As\ well\ as\ the\ shaders.}}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *sa;}
\DoxyCodeLine{00417\ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_state-\/>get\_attrib(sa))\ \{}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \mbox{\hyperlink{classShader}{Shader}}\ *shader\ =\ (\mbox{\hyperlink{classShader}{Shader}}\ *)sa-\/>get\_shader();}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (shader\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_ae89d9f2e64192a1d03ad81524591abf6}{enqueue\_shader}}(shader);}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (sa-\/>auto\_shader())\ \{}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ \ gsg-\/>ensure\_generated\_shader(geom\_state);}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (munger-\/>is\_of\_type(StateMunger::get\_class\_type()))\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Premunge\ the\ state\ for\ the\ fixed-\/function\ pipeline.}}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classStateMunger}{StateMunger}}\ *state\_munger\ =\ (\mbox{\hyperlink{classStateMunger}{StateMunger}}\ *)munger.p();}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (state\_munger-\/>should\_munge\_state())\ \{}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ geom\_state\ =\ state\_munger-\/>munge\_state(geom\_state);}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ prepare\ the\ shader\ inputs.}}
\DoxyCodeLine{00433\ \ \ \ \ \}}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{comment}{//\ And\ now\ prepare\ each\ of\ the\ textures.}}
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTextureAttrib}{TextureAttrib}}\ *ta;}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{if}\ (geom\_state-\/>get\_attrib(ta))\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stages\ =\ ta-\/>get\_num\_on\_stages();}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_stages;\ ++i)\ \{}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *texture\ =\ ta-\/>get\_on\_texture(ta-\/>get\_on\_stage(i));}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ prepare\ the\ sampler\ states,\ if\ specified.}}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (texture\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_a45db9601d0aaea6961a93b8e6e228a7a}{enqueue\_texture}}(texture);}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00446\ \ \ \ \ \}}
\DoxyCodeLine{00447\ \ \ \}}
\DoxyCodeLine{00448\ }
\DoxyCodeLine{00449\ \ \ \mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{PandaNode::r\_prepare\_scene}}(gsg,\ node\_state,\ transformer,\ current\_thread);}
\DoxyCodeLine{00450\ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ }
\DoxyCodeLine{00463\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classGeomNode_a3c3d63155a53f24b12f6d14d12647391}{GeomNode::}}}
\DoxyCodeLine{00464\ \mbox{\hyperlink{classGeomNode_a3c3d63155a53f24b12f6d14d12647391}{combine\_with}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{00465\ \ \ \textcolor{keywordflow}{if}\ (is\_exact\_type(get\_class\_type())\ \&\&}
\DoxyCodeLine{00466\ \ \ \ \ \ \ other-\/>is\_exact\_type(get\_class\_type()))\ \{}
\DoxyCodeLine{00467\ \ \ \ \ \textcolor{comment}{//\ Two\ GeomNodes\ can\ combine\ by\ moving\ Geoms\ from\ one\ to\ the\ other.}}
\DoxyCodeLine{00468\ \ \ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *gother\ =\ DCAST(\mbox{\hyperlink{classGeomNode}{GeomNode}},\ other);}
\DoxyCodeLine{00469\ \ \ \ \ \mbox{\hyperlink{classGeomNode_a05448ffc3db1a751ad98edeff915d4a6}{add\_geoms\_from}}(gother);}
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00471\ \ \ \}}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \textcolor{keywordflow}{return}\ PandaNode::combine\_with(other);}
\DoxyCodeLine{00474\ \}}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00487\ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ GeomNode::}
\DoxyCodeLine{00488\ calc\_tight\_bounds(LPoint3\ \&min\_point,\ LPoint3\ \&max\_point,\ \textcolor{keywordtype}{bool}\ \&found\_any,}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00490\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ next\_transform\ =}
\DoxyCodeLine{00491\ \ \ \ \ PandaNode::calc\_tight\_bounds(min\_point,\ max\_point,\ found\_any,\ transform,}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00493\ }
\DoxyCodeLine{00494\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&mat\ =\ next\_transform-\/>get\_mat();}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00496\ \ \ CDReader\ cdata(\_cycler,\ current\_thread);}
\DoxyCodeLine{00497\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00498\ \ \ CPT(GeomList)\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00499\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00500\ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ (*gi).\_geom.get\_read\_pointer();}
\DoxyCodeLine{00501\ \ \ \ \ geom-\/>calc\_tight\_bounds(min\_point,\ max\_point,\ found\_any,}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ geom-\/>get\_animated\_vertex\_data(\textcolor{keyword}{true},\ current\_thread),}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !next\_transform-\/>is\_identity(),\ mat,}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00505\ \ \ \}}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ \textcolor{keywordflow}{return}\ next\_transform;}
\DoxyCodeLine{00508\ \}}
\DoxyCodeLine{00509\ }
\DoxyCodeLine{00515\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a7a61ef1cfd9d0b45bda546458c33dd6b}{GeomNode::}}}
\DoxyCodeLine{00516\ \mbox{\hyperlink{classGeomNode_a7a61ef1cfd9d0b45bda546458c33dd6b}{add\_for\_draw}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data)\ \{}
\DoxyCodeLine{00517\ \ \ trav-\/>\_geom\_nodes\_pcollector.add\_level(1);}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_spam())\ \{}
\DoxyCodeLine{00520\ \ \ \ \ pgraph\_cat.spam()}
\DoxyCodeLine{00521\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Found\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\ in\ state\ "{}}\ <<\ *data.\_state}
\DoxyCodeLine{00522\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ draw\_mask\ =\ "{}}\ <<\ data.\_draw\_mask\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00523\ \ \ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ trav-\/>get\_current\_thread();}
\DoxyCodeLine{00526\ }
\DoxyCodeLine{00527\ \ \ \textcolor{comment}{//\ Get\ all\ the\ Geoms,\ with\ no\ decalling.}}
\DoxyCodeLine{00528\ \ \ Geoms\ geoms\ =\ get\_geoms(current\_thread);}
\DoxyCodeLine{00529\ \ \ \textcolor{keywordtype}{int}\ num\_geoms\ =\ geoms.get\_num\_geoms();}
\DoxyCodeLine{00530\ \ \ trav-\/>\_geoms\_pcollector.add\_level(num\_geoms);}
\DoxyCodeLine{00531\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ internal\_transform\ =\ data.get\_internal\_transform(trav);}
\DoxyCodeLine{00532\ }
\DoxyCodeLine{00533\ \ \ \textcolor{keywordflow}{if}\ (num\_geoms\ ==\ 1)\ \{}
\DoxyCodeLine{00534\ \ \ \ \ \textcolor{comment}{//\ If\ there's\ only\ one\ Geom,\ we\ don't\ need\ to\ bother\ culling\ each\ individual}}
\DoxyCodeLine{00535\ \ \ \ \ \textcolor{comment}{//\ Geom\ bounding\ volume\ against\ the\ view\ frustum,\ since\ we've\ already}}
\DoxyCodeLine{00536\ \ \ \ \ \textcolor{comment}{//\ checked\ the\ one\ on\ the\ GeomNode\ itself.}}
\DoxyCodeLine{00537\ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ geoms.get\_geom(0);}
\DoxyCodeLine{00538\ \ \ \ \ \textcolor{keywordflow}{if}\ (!geom-\/>is\_empty())\ \{}
\DoxyCodeLine{00539\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state-\/>compose(geoms.get\_geom\_state(0));}
\DoxyCodeLine{00540\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!state-\/>has\_cull\_callback()\ ||\ state-\/>cull\_callback(trav,\ data))\ \{}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCullableObject}{CullableObject}}\ object(std::move(geom),\ std::move(state),\ std::move(internal\_transform));}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}.\_instances\ =\ data.\_instances;}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(std::move(\textcolor{keywordtype}{object}),\ trav);}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00545\ \ \ \ \ \}}
\DoxyCodeLine{00546\ \ \ \}}
\DoxyCodeLine{00547\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00548\ \ \ \ \ \textcolor{comment}{//\ More\ than\ one\ Geom.}}
\DoxyCodeLine{00549\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_geoms;\ i++)\ \{}
\DoxyCodeLine{00550\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ geoms.get\_geom(i);}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (geom-\/>is\_empty())\ \{}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00554\ }
\DoxyCodeLine{00555\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ data.\_state-\/>compose(geoms.get\_geom\_state(i));}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (state-\/>has\_cull\_callback()\ \&\&\ !state-\/>cull\_callback(trav,\ data))\ \{}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cull.}}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00560\ }
\DoxyCodeLine{00561\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data.\_instances\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Draw\ each\ individual\ instance.\ \ We\ don't\ bother\ culling\ each}}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ individual\ Geom\ for\ each\ instance;\ that\ is\ probably\ way\ too\ slow.}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classCullableObject}{CullableObject}}\ object(std::move(geom),\ std::move(state),\ internal\_transform);}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{object}.\_instances\ =\ data.\_instances;}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(std::move(\textcolor{keywordtype}{object}),\ trav);}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ \ \ \ \ \textcolor{comment}{//\ Cull\ the\ individual\ Geom\ against\ the\ view\ frustum.}}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data.\_view\_frustum\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00572\ \ \ \ \ \ \ \ \ \ \ !geom-\/>is\_in\_view(data.\_view\_frustum,\ current\_thread))\ \{}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cull\ this\ Geom.}}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (data.\_cull\_planes\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00577\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Also\ cull\ the\ Geom\ against\ the\ cull\ planes.}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ geom\_volume\ =\ geom-\/>get\_bounds(current\_thread);}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *geom\_gbv\ =}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \ \ \ \ geom\_volume-\/>\mbox{\hyperlink{classGeometricBoundingVolume_ad2f80e4331f60ae9a0eeda85a347c8d3}{as\_geometric\_bounding\_volume}}();}
\DoxyCodeLine{00581\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ result;}
\DoxyCodeLine{00582\ \ \ \ \ \ \ \ \ data.\_cull\_planes-\/>do\_cull(result,\ state,\ geom\_gbv);}
\DoxyCodeLine{00583\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ BoundingVolume::IF\_no\_intersection)\ \{}
\DoxyCodeLine{00584\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cull.}}
\DoxyCodeLine{00585\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00588\ }
\DoxyCodeLine{00589\ \ \ \ \ \ \ trav-\/>get\_cull\_handler()-\/>\mbox{\hyperlink{classCullHandler_a35e3215f1c647c0ce091d234a9afa57c}{record\_object}}(\mbox{\hyperlink{classCullableObject}{CullableObject}}(}
\DoxyCodeLine{00590\ \ \ \ \ \ \ \ \ std::move(geom),\ std::move(state),\ internal\_transform),\ trav);}
\DoxyCodeLine{00591\ \ \ \ \ \}}
\DoxyCodeLine{00592\ \ \ \}}
\DoxyCodeLine{00593\ \}}
\DoxyCodeLine{00594\ }
\DoxyCodeLine{00603\ \mbox{\hyperlink{classBitMask}{CollideMask}}\ \mbox{\hyperlink{classGeomNode_a727208f8c03e1eb2bde2b1a39f913f5e}{GeomNode::}}}
\DoxyCodeLine{00604\ \mbox{\hyperlink{classGeomNode_a727208f8c03e1eb2bde2b1a39f913f5e}{get\_legal\_collide\_mask}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00605\ \ \ \textcolor{keywordflow}{return}\ CollideMask::all\_on();}
\DoxyCodeLine{00606\ \}}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00613\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{GeomNode::}}}
\DoxyCodeLine{00614\ \mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(\mbox{\hyperlink{classGeom}{Geom}}\ *geom,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state)\ \{}
\DoxyCodeLine{00615\ \ \ nassertv(geom\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00616\ \ \ nassertv(geom-\/>\mbox{\hyperlink{classGeom_a6d7ce0a07b34fc0dea0d7db3838c57dd}{check\_valid}}());}
\DoxyCodeLine{00617\ \ \ nassertv(state\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00618\ }
\DoxyCodeLine{00619\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00620\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00621\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00622\ }
\DoxyCodeLine{00623\ \ \ \ \ cdata-\/>modify\_geoms()-\/>push\_back(\mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}(geom,\ state));}
\DoxyCodeLine{00624\ \ \ \}}
\DoxyCodeLine{00625\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00626\ }
\DoxyCodeLine{00627\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00628\ \}}
\DoxyCodeLine{00629\ }
\DoxyCodeLine{00634\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a05448ffc3db1a751ad98edeff915d4a6}{GeomNode::}}}
\DoxyCodeLine{00635\ \mbox{\hyperlink{classGeomNode_a05448ffc3db1a751ad98edeff915d4a6}{add\_geoms\_from}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *other)\ \{}
\DoxyCodeLine{00636\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00637\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00638\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00639\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageReader}{CDStageReader}}\ cdata\_other(other-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00640\ }
\DoxyCodeLine{00641\ \ \ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00642\ \ \ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ other\_geoms\ =\ cdata\_other-\/>get\_geoms();}
\DoxyCodeLine{00643\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ this\_geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00644\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ other\_geoms-\/>begin();\ gi\ !=\ other\_geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00646\ \ \ \ \ \ \ nassertv(entry.\_geom.get\_read\_pointer()-\/>check\_valid());}
\DoxyCodeLine{00647\ \ \ \ \ \ \ this\_geoms-\/>push\_back(entry);}
\DoxyCodeLine{00648\ \ \ \ \ \}}
\DoxyCodeLine{00649\ \ \ \}}
\DoxyCodeLine{00650\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00653\ \}}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00664\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a7ff87a416a4b0f4adc472329aef5128f}{GeomNode::}}}
\DoxyCodeLine{00665\ \mbox{\hyperlink{classGeomNode_a7ff87a416a4b0f4adc472329aef5128f}{set\_geom}}(\textcolor{keywordtype}{int}\ n,\ \mbox{\hyperlink{classGeom}{Geom}}\ *geom)\ \{}
\DoxyCodeLine{00666\ \ \ nassertv(geom\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00667\ \ \ nassertv(geom-\/>\mbox{\hyperlink{classGeom_a6d7ce0a07b34fc0dea0d7db3838c57dd}{check\_valid}}());}
\DoxyCodeLine{00668\ }
\DoxyCodeLine{00669\ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00670\ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00671\ \ \ nassertv(n\ >=\ 0\ \&\&\ n\ <\ (\textcolor{keywordtype}{int})geoms-\/>size());}
\DoxyCodeLine{00672\ \ \ (*geoms)[n].\_geom\ =\ geom;}
\DoxyCodeLine{00673\ }
\DoxyCodeLine{00674\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00675\ \}}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00682\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classGeomNode_acd21514059c8e921f616d04adad475e8}{GeomNode::}}}
\DoxyCodeLine{00683\ \mbox{\hyperlink{classGeomNode_acd21514059c8e921f616d04adad475e8}{check\_valid}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00684\ \ \ \textcolor{keywordtype}{int}\ num\_geoms\ =\ get\_num\_geoms();}
\DoxyCodeLine{00685\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_geoms;\ i++)\ \{}
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeom}{Geom}}\ *geom\ =\ get\_geom(i);}
\DoxyCodeLine{00687\ \ \ \ \ \textcolor{keywordflow}{if}\ (!geom-\/>\mbox{\hyperlink{classGeom_a6d7ce0a07b34fc0dea0d7db3838c57dd}{check\_valid}}())\ \{}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00689\ \ \ \ \ \}}
\DoxyCodeLine{00690\ \ \ \}}
\DoxyCodeLine{00691\ }
\DoxyCodeLine{00692\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00693\ \}}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00705\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_ad12f491ed935e8d0f0b029e6a3bf4459}{GeomNode::}}}
\DoxyCodeLine{00706\ \mbox{\hyperlink{classGeomNode_ad12f491ed935e8d0f0b029e6a3bf4459}{decompose}}()\ \{}
\DoxyCodeLine{00707\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00708\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00709\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00710\ }
\DoxyCodeLine{00711\ \ \ \ \ GeomList::iterator\ gi;}
\DoxyCodeLine{00712\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00713\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00714\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00715\ \ \ \ \ \ \ nassertv(entry.\_geom.test\_ref\_count\_integrity());}
\DoxyCodeLine{00716\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_write\_pointer();}
\DoxyCodeLine{00717\ \ \ \ \ \ \ geom-\/>decompose\_in\_place();}
\DoxyCodeLine{00718\ \ \ \ \ \}}
\DoxyCodeLine{00719\ \ \ \}}
\DoxyCodeLine{00720\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00721\ \}}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00741\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a2bc5b616cbf7cfe6bb67da664f311a0c}{GeomNode::}}}
\DoxyCodeLine{00742\ \mbox{\hyperlink{classGeomNode_a2bc5b616cbf7cfe6bb67da664f311a0c}{unify}}(\textcolor{keywordtype}{int}\ max\_indices,\ \textcolor{keywordtype}{bool}\ preserve\_order)\ \{}
\DoxyCodeLine{00743\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00745\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00746\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00747\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00748\ }
\DoxyCodeLine{00749\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ new\_geoms\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCopyOnWriteObj}{GeomList}};}
\DoxyCodeLine{00750\ }
\DoxyCodeLine{00751\ \ \ \ \ \textcolor{comment}{//\ Try\ to\ unify\ each\ Geom\ with\ each\ preceding\ Geom.\ \ This\ is\ an\ n\string^2}}
\DoxyCodeLine{00752\ \ \ \ \ \textcolor{comment}{//\ operation,\ but\ usually\ there\ are\ only\ a\ handful\ of\ Geoms\ to\ consider,}}
\DoxyCodeLine{00753\ \ \ \ \ \textcolor{comment}{//\ so\ that's\ not\ a\ big\ deal.}}
\DoxyCodeLine{00754\ \ \ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00755\ \ \ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ old\_geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00756\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ old\_geoms-\/>begin();\ gi\ !=\ old\_geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00757\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&old\_entry\ =\ (*gi);}
\DoxyCodeLine{00758\ }
\DoxyCodeLine{00759\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ unified\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00760\ }
\DoxyCodeLine{00761\ \ \ \ \ \ \ \textcolor{comment}{//\ Go\ from\ back\ to\ front,\ to\ minimize\ damage\ to\ the\ primitive\ ordering.}}
\DoxyCodeLine{00762\ \ \ \ \ \ \ GeomList::reverse\_iterator\ gj;}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (gj\ =\ new\_geoms-\/>rbegin();\ gj\ !=\ new\_geoms-\/>rend()\ \&\&\ !unified;\ ++gj)\ \{}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&new\_entry\ =\ (*gj);}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (old\_entry.\_state\ ==\ new\_entry.\_state)\ \{}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Both\ states\ match,\ so\ try\ to\ combine\ the\ primitives.}}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ old\_geom\ =\ old\_entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{00768\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ new\_geom\ =\ new\_entry.\_geom.get\_write\_pointer();}
\DoxyCodeLine{00769\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_geom-\/>copy\_primitives\_from(old\_geom))\ \{}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Successfully\ combined!}}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \ \ \ \ \ \ unified\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (preserve\_order)\ \{}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we're\ insisting\ on\ preserving\ the\ order,\ we\ can\ only\ attempt}}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ merge\ with\ the\ tail\ of\ the\ list.}}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00780\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00781\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00782\ }
\DoxyCodeLine{00783\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!unified)\ \{}
\DoxyCodeLine{00784\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Couldn't\ unify\ this\ Geom\ with\ anything,\ so\ just\ add\ it\ to\ the}}
\DoxyCodeLine{00785\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ output\ list.}}
\DoxyCodeLine{00786\ \ \ \ \ \ \ \ \ new\_geoms-\/>push\_back(old\_entry);}
\DoxyCodeLine{00787\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00788\ \ \ \ \ \}}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \ \ \ \ \textcolor{comment}{//\ Done!\ \ We'll\ keep\ whatever's\ left\ in\ the\ output\ list.}}
\DoxyCodeLine{00791\ \ \ \ \ cdata-\/>set\_geoms(new\_geoms);}
\DoxyCodeLine{00792\ }
\DoxyCodeLine{00793\ \ \ \ \ \textcolor{comment}{//\ Finally,\ go\ back\ through\ and\ unify\ the\ resulting\ geom(s).}}
\DoxyCodeLine{00794\ \ \ \ \ GeomList::iterator\ wgi;}
\DoxyCodeLine{00795\ \ \ \ \ \textcolor{keywordflow}{for}\ (wgi\ =\ new\_geoms-\/>begin();\ wgi\ !=\ new\_geoms-\/>end();\ ++wgi)\ \{}
\DoxyCodeLine{00796\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*wgi);}
\DoxyCodeLine{00797\ \ \ \ \ \ \ nassertv(entry.\_geom.test\_ref\_count\_integrity());}
\DoxyCodeLine{00798\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_write\_pointer();}
\DoxyCodeLine{00799\ \ \ \ \ \ \ geom-\/>unify\_in\_place(max\_indices,\ preserve\_order);}
\DoxyCodeLine{00800\ \ \ \ \ \}}
\DoxyCodeLine{00801\ \ \ \}}
\DoxyCodeLine{00802\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00803\ }
\DoxyCodeLine{00804\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{00805\ \ \ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00806\ \ \ \}}
\DoxyCodeLine{00807\ \}}
\DoxyCodeLine{00808\ }
\DoxyCodeLine{00812\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a1617ea7fdd60986cbc8cc1be61849a43}{GeomNode::}}}
\DoxyCodeLine{00813\ \mbox{\hyperlink{classGeomNode_a1617ea7fdd60986cbc8cc1be61849a43}{write\_geoms}}(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00814\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00815\ \ \ write(out,\ indent\_level);}
\DoxyCodeLine{00816\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00817\ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00818\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00819\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00820\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)}
\DoxyCodeLine{00821\ \ \ \ \ \ \ <<\ *entry.\_geom.get\_read\_pointer()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *entry.\_state\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00822\ \ \ \}}
\DoxyCodeLine{00823\ \}}
\DoxyCodeLine{00824\ }
\DoxyCodeLine{00828\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a9c1a1ea1d8296ba344ff4fd4807b0404}{GeomNode::}}}
\DoxyCodeLine{00829\ \mbox{\hyperlink{classGeomNode_a9c1a1ea1d8296ba344ff4fd4807b0404}{write\_verbose}}(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00830\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00831\ \ \ write(out,\ indent\_level);}
\DoxyCodeLine{00832\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00833\ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00834\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00835\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00836\ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{00837\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level\ +\ 2)}
\DoxyCodeLine{00838\ \ \ \ \ \ \ <<\ *geom\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *entry.\_state\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00839\ \ \ \ \ geom-\/>write(out,\ indent\_level\ +\ 4);}
\DoxyCodeLine{00840\ \ \ \}}
\DoxyCodeLine{00841\ \}}
\DoxyCodeLine{00842\ }
\DoxyCodeLine{00846\ \textcolor{keywordtype}{void}\ GeomNode::}
\DoxyCodeLine{00847\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00848\ \ \ \textcolor{comment}{//\ Accumulate\ the\ total\ set\ of\ RenderAttrib\ types\ that\ are\ applied\ to\ any\ of}}
\DoxyCodeLine{00849\ \ \ \textcolor{comment}{//\ our\ Geoms,\ so\ we\ can\ output\ them\ too.\ \ The\ result\ will\ be\ the\ list\ of}}
\DoxyCodeLine{00850\ \ \ \textcolor{comment}{//\ attrib\ types\ that\ might\ be\ applied\ to\ some\ Geoms,\ but\ not\ necessarily\ to}}
\DoxyCodeLine{00851\ \ \ \textcolor{comment}{//\ all\ Geoms.}}
\DoxyCodeLine{00852\ }
\DoxyCodeLine{00853\ \ \ CDReader\ cdata(\_cycler);}
\DoxyCodeLine{00854\ }
\DoxyCodeLine{00855\ \ \ \mbox{\hyperlink{classpset}{pset<TypeHandle>}}\ attrib\_types;}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00858\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ common\ =\ RenderState::make\_empty();}
\DoxyCodeLine{00859\ }
\DoxyCodeLine{00860\ \ \ CPT(GeomList)\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00861\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00862\ \ \ \ \ \textcolor{keyword}{const}\ GeomEntry\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00863\ \ \ \ \ common\ =\ common-\/>compose(entry.\_state);}
\DoxyCodeLine{00864\ \ \ \}}
\DoxyCodeLine{00865\ }
\DoxyCodeLine{00866\ \ \ PandaNode::output(out);}
\DoxyCodeLine{00867\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ ("{}}\ <<\ geoms-\/>size()\ <<\ \textcolor{stringliteral}{"{}\ geoms"{}};}
\DoxyCodeLine{00868\ }
\DoxyCodeLine{00869\ \ \ \textcolor{keywordflow}{if}\ (!common-\/>is\_empty())\ \{}
\DoxyCodeLine{00870\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}:\ "{}}\ <<\ *common;}
\DoxyCodeLine{00871\ \ \ \}}
\DoxyCodeLine{00872\ }
\DoxyCodeLine{00873\ \ \ out\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{00874\ \}}
\DoxyCodeLine{00875\ }
\DoxyCodeLine{00884\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classGeomNode_a796093f24def376992dc7b574d55b8b1}{GeomNode::}}}
\DoxyCodeLine{00885\ \mbox{\hyperlink{classGeomNode_a796093f24def376992dc7b574d55b8b1}{is\_geom\_node}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00886\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00887\ \}}
\DoxyCodeLine{00888\ }
\DoxyCodeLine{00893\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a0758e6a90e05867d746957ade9e12125}{GeomNode::}}}
\DoxyCodeLine{00894\ \mbox{\hyperlink{classGeomNode_a0758e6a90e05867d746957ade9e12125}{do\_premunge}}(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,}
\DoxyCodeLine{00895\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *node\_state,}
\DoxyCodeLine{00896\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ \&transformer)\ \{}
\DoxyCodeLine{00897\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00898\ }
\DoxyCodeLine{00899\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00900\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00901\ }
\DoxyCodeLine{00902\ \ \ \ \ GeomList::iterator\ gi;}
\DoxyCodeLine{00903\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00904\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00906\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ geom\_state\ =\ node\_state-\/>compose(entry.\_state);}
\DoxyCodeLine{00907\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{00908\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomMunger}{GeomMunger}})\ munger\ =\ gsg-\/>get\_geom\_munger(geom\_state,\ current\_thread);}
\DoxyCodeLine{00909\ \ \ \ \ \ \ entry.\_geom\ =\ transformer.premunge\_geom(geom,\ munger);}
\DoxyCodeLine{00910\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (premunge\_remove\_unused\_vertices)\ \{}
\DoxyCodeLine{00911\ \ \ \ \ \ \ \ \ transformer.\mbox{\hyperlink{classGeomTransformer_af68df9bb98381a78db84d6b874084bd3}{register\_vertices}}(entry.\_geom.get\_write\_pointer(),\ \textcolor{keyword}{true});}
\DoxyCodeLine{00912\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00913\ \ \ \ \ \}}
\DoxyCodeLine{00914\ \ \ \}}
\DoxyCodeLine{00915\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00916\ \}}
\DoxyCodeLine{00917\ }
\DoxyCodeLine{00922\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a161ea55c432a5b5b0fc0c9a09fdd9518}{GeomNode::}}}
\DoxyCodeLine{00923\ \mbox{\hyperlink{classGeomNode_a161ea55c432a5b5b0fc0c9a09fdd9518}{r\_mark\_geom\_bounds\_stale}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00924\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00925\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00926\ }
\DoxyCodeLine{00927\ \ \ \ \ GeomList::iterator\ gi;}
\DoxyCodeLine{00928\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{00929\ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00931\ \ \ \ \ \ \ entry.\_geom.get\_read\_pointer()-\/>mark\_bounds\_stale();}
\DoxyCodeLine{00932\ \ \ \ \ \}}
\DoxyCodeLine{00933\ \ \ \}}
\DoxyCodeLine{00934\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00935\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00936\ }
\DoxyCodeLine{00937\ \ \ \mbox{\hyperlink{classPandaNode_aa41e720c22111481fb0964d20596d036}{PandaNode::r\_mark\_geom\_bounds\_stale}}(current\_thread);}
\DoxyCodeLine{00938\ \}}
\DoxyCodeLine{00939\ }
\DoxyCodeLine{00945\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_ac34cea8c2f22858acf10c3d0e5f1e71c}{GeomNode::}}}
\DoxyCodeLine{00946\ \mbox{\hyperlink{classGeomNode_ac34cea8c2f22858acf10c3d0e5f1e71c}{compute\_internal\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&internal\_bounds,}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \&internal\_vertices,}
\DoxyCodeLine{00948\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00950\ \ \ \textcolor{keywordtype}{int}\ num\_vertices\ =\ 0;}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00952\ \ \ \mbox{\hyperlink{classCycleDataLockedStageReader}{CDLockedStageReader}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00953\ }
\DoxyCodeLine{00954\ \ \ \mbox{\hyperlink{classpvector}{pvector<const\ BoundingVolume\ *>}}\ child\_volumes;}
\DoxyCodeLine{00955\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ >\ child\_volumes\_ref;}
\DoxyCodeLine{00956\ \ \ \textcolor{keywordtype}{bool}\ all\_box\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00957\ }
\DoxyCodeLine{00958\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{00959\ \ \ CPT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>get\_geoms();}
\DoxyCodeLine{00960\ \ \ child\_volumes.reserve(geoms-\/>size());}
\DoxyCodeLine{00961\ \ \ child\_volumes\_ref.reserve(geoms-\/>size());}
\DoxyCodeLine{00962\ }
\DoxyCodeLine{00963\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{00964\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{00965\ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{00966\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ volume\ =\ geom-\/>get\_bounds();}
\DoxyCodeLine{00967\ }
\DoxyCodeLine{00968\ \ \ \ \ \textcolor{keywordflow}{if}\ (!volume-\/>is\_empty())\ \{}
\DoxyCodeLine{00969\ \ \ \ \ \ \ child\_volumes.push\_back(volume);}
\DoxyCodeLine{00970\ \ \ \ \ \ \ child\_volumes\_ref.push\_back(volume);}
\DoxyCodeLine{00971\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!volume-\/>is\_exact\_type(BoundingBox::get\_class\_type()))\ \{}
\DoxyCodeLine{00972\ \ \ \ \ \ \ \ \ all\_box\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00973\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00974\ \ \ \ \ \}}
\DoxyCodeLine{00975\ \ \ \ \ num\_vertices\ +=\ geom-\/>get\_nested\_vertices();}
\DoxyCodeLine{00976\ \ \ \}}
\DoxyCodeLine{00977\ }
\DoxyCodeLine{00978\ \ \ PT(\mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}})\ gbv;}
\DoxyCodeLine{00979\ }
\DoxyCodeLine{00980\ \ \ BoundingVolume::BoundsType\ btype\ =\ \mbox{\hyperlink{classPandaNode_a762e487a7d3378c7d4be1b7582f3d850}{get\_bounds\_type}}();}
\DoxyCodeLine{00981\ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_default)\ \{}
\DoxyCodeLine{00982\ \ \ \ \ btype\ =\ bounds\_type;}
\DoxyCodeLine{00983\ \ \ \}}
\DoxyCodeLine{00984\ }
\DoxyCodeLine{00985\ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_box\ ||}
\DoxyCodeLine{00986\ \ \ \ \ \ \ (btype\ !=\ BoundingVolume::BT\_sphere\ \&\&\ all\_box))\ \{}
\DoxyCodeLine{00987\ \ \ \ \ \textcolor{comment}{//\ If\ all\ of\ the\ child\ volumes\ are\ a\ BoundingBox,\ then\ our\ volume\ is\ also}}
\DoxyCodeLine{00988\ \ \ \ \ \textcolor{comment}{//\ a\ BoundingBox.}}
\DoxyCodeLine{00989\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}};}
\DoxyCodeLine{00990\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00991\ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ it's\ a\ sphere.}}
\DoxyCodeLine{00992\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{00993\ \ \ \}}
\DoxyCodeLine{00994\ }
\DoxyCodeLine{00995\ \ \ \textcolor{keywordflow}{if}\ (child\_volumes.size()\ >\ 0)\ \{}
\DoxyCodeLine{00996\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **child\_begin\ =\ \&child\_volumes[0];}
\DoxyCodeLine{00997\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **child\_end\ =\ child\_begin\ +\ child\_volumes.size();}
\DoxyCodeLine{00998\ \ \ \ \ ((\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *)gbv)-\/>around(child\_begin,\ child\_end);}
\DoxyCodeLine{00999\ \ \ \}}
\DoxyCodeLine{01000\ }
\DoxyCodeLine{01001\ \ \ internal\_bounds\ =\ gbv;}
\DoxyCodeLine{01002\ \ \ internal\_vertices\ =\ num\_vertices;}
\DoxyCodeLine{01003\ \}}
\DoxyCodeLine{01004\ }
\DoxyCodeLine{01008\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a5fae284d9f9c410e9393f14ea8812edb}{GeomNode::}}}
\DoxyCodeLine{01009\ \mbox{\hyperlink{classGeomNode_a5fae284d9f9c410e9393f14ea8812edb}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{01010\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classGeomNode_aa51fe2f9755c4f8589ba4607d9823bfc}{make\_from\_bam}});}
\DoxyCodeLine{01011\ \}}
\DoxyCodeLine{01012\ }
\DoxyCodeLine{01017\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_a49ba3e118d7b7b449f473e8a558aa8a8}{GeomNode::}}}
\DoxyCodeLine{01018\ \mbox{\hyperlink{classGeomNode_a49ba3e118d7b7b449f473e8a558aa8a8}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{01019\ \ \ \mbox{\hyperlink{classPandaNode_ae9b3055297ade9bbf4a3b4dfc77e4506}{PandaNode::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{01020\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{01021\ \}}
\DoxyCodeLine{01022\ }
\DoxyCodeLine{01028\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_aa8f389b6565816505de27ea4795e1372}{GeomNode::}}}
\DoxyCodeLine{01029\ \mbox{\hyperlink{classGeomNode_aa8f389b6565816505de27ea4795e1372}{finalize}}(\mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01030\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ <\ 14)\ \{}
\DoxyCodeLine{01031\ \ \ \ \ \textcolor{comment}{//\ With\ version\ 6.14,\ we\ changed\ the\ default\ ColorAttrib\ behavior\ from}}
\DoxyCodeLine{01032\ \ \ \ \ \textcolor{comment}{//\ make\_vertex()\ to\ make\_flat().\ \ This\ means\ that\ every\ Geom\ that\ contains}}
\DoxyCodeLine{01033\ \ \ \ \ \textcolor{comment}{//\ vertex\ colors\ now\ needs\ to\ have\ an\ explicit\ ColorAttrib::make\_vertex()}}
\DoxyCodeLine{01034\ \ \ \ \ \textcolor{comment}{//\ on\ its\ state.}}
\DoxyCodeLine{01035\ }
\DoxyCodeLine{01036\ \ \ \ \ \textcolor{comment}{//\ Since\ we\ shouldn't\ override\ a\ different\ ColorAttrib\ inherited\ from}}
\DoxyCodeLine{01037\ \ \ \ \ \textcolor{comment}{//\ above,\ we\ create\ this\ new\ attrib\ with\ an\ override\ of\ -\/1.}}
\DoxyCodeLine{01038\ }
\DoxyCodeLine{01039\ \ \ \ \ CPT(\mbox{\hyperlink{classInternalName}{InternalName}})\ \mbox{\hyperlink{structcolor}{color}}\ =\ InternalName::get\_color();}
\DoxyCodeLine{01040\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ vertex\_color\ =\ ColorAttrib::make\_vertex();}
\DoxyCodeLine{01041\ }
\DoxyCodeLine{01042\ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01043\ \ \ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01044\ \ \ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01045\ }
\DoxyCodeLine{01046\ \ \ \ \ \ \ GeomList::iterator\ gi;}
\DoxyCodeLine{01047\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj}{GeomList}})\ geoms\ =\ cdata-\/>modify\_geoms();}
\DoxyCodeLine{01048\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{01049\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomNode_1_1GeomEntry}{GeomEntry}}\ \&entry\ =\ (*gi);}
\DoxyCodeLine{01050\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ entry.\_geom.get\_read\_pointer();}
\DoxyCodeLine{01051\ }
\DoxyCodeLine{01052\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Force\ the\ various\ GeomVertexArrayFormat\ objects\ to\ finalize}}
\DoxyCodeLine{01053\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ themselves.\ \ We\ have\ to\ do\ this\ before\ we\ can\ reliably\ call}}
\DoxyCodeLine{01054\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ GeomVertexData::has\_column().}}
\DoxyCodeLine{01055\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ geom-\/>get\_vertex\_data(current\_thread);}
\DoxyCodeLine{01056\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ vformat\ =\ vdata-\/>get\_format();}
\DoxyCodeLine{01057\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ vformat-\/>get\_num\_arrays();\ ++i)\ \{}
\DoxyCodeLine{01058\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *varray\ =\ vformat-\/>get\_array(i);}
\DoxyCodeLine{01059\ \ \ \ \ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a786911fd5b8d98eed701a3bb6e2b3a19}{finalize\_now}}((\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}\ *)varray);}
\DoxyCodeLine{01060\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01061\ }
\DoxyCodeLine{01062\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vdata-\/>has\_column(\mbox{\hyperlink{structcolor}{color}})\ \&\&}
\DoxyCodeLine{01063\ \ \ \ \ \ \ \ \ \ \ \ \ !entry.\_state-\/>has\_attrib(ColorAttrib::get\_class\_slot()))\ \{}
\DoxyCodeLine{01064\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We'll\ be\ reassigning\ the\ RenderState.\ \ Therefore,\ save\ it}}
\DoxyCodeLine{01065\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ temporarily\ to\ increment\ its\ reference\ count.}}
\DoxyCodeLine{01066\ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeomNode_1_1BamAuxData}{BamAuxData}})\ aux\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode_1_1BamAuxData}{BamAuxData}};}
\DoxyCodeLine{01067\ \ \ \ \ \ \ \ \ \ \ aux\_data-\/>\_hold\_state\ =\ entry.\_state;}
\DoxyCodeLine{01068\ \ \ \ \ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a97cb720e14628af2131871369039b986}{set\_aux\_data}}((\mbox{\hyperlink{classRenderState}{RenderState}}\ *)entry.\_state.p(),\ \textcolor{stringliteral}{"{}hold\_state"{}},\ aux\_data);}
\DoxyCodeLine{01069\ }
\DoxyCodeLine{01070\ \ \ \ \ \ \ \ \ \ \ entry.\_state\ =\ entry.\_state-\/>add\_attrib(vertex\_color,\ -\/1);}
\DoxyCodeLine{01071\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01072\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01073\ \ \ \ \ \}}
\DoxyCodeLine{01074\ \ \ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01075\ \ \ \}}
\DoxyCodeLine{01076\ \}}
\DoxyCodeLine{01077\ }
\DoxyCodeLine{01083\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classGeomNode_aa51fe2f9755c4f8589ba4607d9823bfc}{GeomNode::}}}
\DoxyCodeLine{01084\ \mbox{\hyperlink{classGeomNode_aa51fe2f9755c4f8589ba4607d9823bfc}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{01085\ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{01086\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{01087\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{01088\ }
\DoxyCodeLine{01089\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{01090\ \ \ node-\/>\mbox{\hyperlink{classGeomNode_aab14d1a8e704d81910ac16984cc38eee}{fillin}}(scan,\ manager);}
\DoxyCodeLine{01091\ }
\DoxyCodeLine{01092\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ <\ 14)\ \{}
\DoxyCodeLine{01093\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a0c2e8dc5a794a4263139116b5b8dcb2d}{register\_finalize}}(node);}
\DoxyCodeLine{01094\ \ \ \}}
\DoxyCodeLine{01095\ }
\DoxyCodeLine{01096\ \ \ \textcolor{keywordflow}{return}\ node;}
\DoxyCodeLine{01097\ \}}
\DoxyCodeLine{01098\ }
\DoxyCodeLine{01103\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classGeomNode_aab14d1a8e704d81910ac16984cc38eee}{GeomNode::}}}
\DoxyCodeLine{01104\ \mbox{\hyperlink{classGeomNode_aab14d1a8e704d81910ac16984cc38eee}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01105\ \ \ \mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{PandaNode::fillin}}(scan,\ manager);}
\DoxyCodeLine{01106\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{01107\ \}}
\DoxyCodeLine{01108\ }
\DoxyCodeLine{01112\ GeomNode::CData::}
\DoxyCodeLine{01113\ CData(\textcolor{keyword}{const}\ GeomNode::CData\ \&copy)\ :}
\DoxyCodeLine{01114\ \ \ \_geoms(copy.\_geoms)}
\DoxyCodeLine{01115\ \{}
\DoxyCodeLine{01116\ \}}
\DoxyCodeLine{01117\ }
\DoxyCodeLine{01121\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *GeomNode::CData::}
\DoxyCodeLine{01122\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01123\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{01124\ \}}
\DoxyCodeLine{01125\ }
\DoxyCodeLine{01130\ \textcolor{keywordtype}{void}\ GeomNode::CData::}
\DoxyCodeLine{01131\ write\_datagram(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01132\ \ \ CPT(GeomList)\ geoms\ =\ \_geoms.get\_read\_pointer();}
\DoxyCodeLine{01133\ \ \ \textcolor{keywordtype}{int}\ num\_geoms\ =\ geoms-\/>size();}
\DoxyCodeLine{01134\ \ \ nassertv(num\_geoms\ ==\ (\textcolor{keywordtype}{int})(uint16\_t)num\_geoms);}
\DoxyCodeLine{01135\ \ \ dg.add\_uint16(num\_geoms);}
\DoxyCodeLine{01136\ }
\DoxyCodeLine{01137\ \ \ GeomList::const\_iterator\ gi;}
\DoxyCodeLine{01138\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{01139\ \ \ \ \ \textcolor{keyword}{const}\ GeomEntry\ \&entry\ =\ (*gi);}
\DoxyCodeLine{01140\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ entry.\_geom.get\_read\_pointer());}
\DoxyCodeLine{01141\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ entry.\_state);}
\DoxyCodeLine{01142\ \ \ \}}
\DoxyCodeLine{01143\ \}}
\DoxyCodeLine{01144\ }
\DoxyCodeLine{01149\ \textcolor{keywordtype}{int}\ GeomNode::CData::}
\DoxyCodeLine{01150\ complete\_pointers(\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01151\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ \mbox{\hyperlink{classCycleData_afae68c5bc34c5cd6ab858d009fbdf1b3}{CycleData::complete\_pointers}}(p\_list,\ manager);}
\DoxyCodeLine{01152\ }
\DoxyCodeLine{01153\ \ \ \textcolor{comment}{//\ Get\ the\ geom\ and\ state\ pointers.}}
\DoxyCodeLine{01154\ \ \ GeomList::iterator\ gi;}
\DoxyCodeLine{01155\ \ \ PT(GeomList)\ geoms\ =\ \_geoms.get\_write\_pointer();}
\DoxyCodeLine{01156\ \ \ \textcolor{keywordflow}{for}\ (gi\ =\ geoms-\/>begin();\ gi\ !=\ geoms-\/>end();\ ++gi)\ \{}
\DoxyCodeLine{01157\ \ \ \ \ GeomEntry\ \&entry\ =\ (*gi);}
\DoxyCodeLine{01158\ \ \ \ \ entry.\_geom\ =\ DCAST(\mbox{\hyperlink{classGeom}{Geom}},\ p\_list[pi++]);}
\DoxyCodeLine{01159\ \ \ \ \ entry.\_state\ =\ DCAST(\mbox{\hyperlink{classRenderState}{RenderState}},\ p\_list[pi++]);}
\DoxyCodeLine{01160\ \ \ \}}
\DoxyCodeLine{01161\ }
\DoxyCodeLine{01162\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{01163\ \}}
\DoxyCodeLine{01164\ }
\DoxyCodeLine{01169\ \textcolor{keywordtype}{void}\ GeomNode::CData::}
\DoxyCodeLine{01170\ fillin(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01171\ \ \ \textcolor{keywordtype}{int}\ num\_geoms\ =\ scan.get\_uint16();}
\DoxyCodeLine{01172\ \ \ \textcolor{comment}{//\ Read\ the\ list\ of\ geoms\ and\ states.\ \ Push\ back\ a\ NULL\ for\ each\ one.}}
\DoxyCodeLine{01173\ \ \ PT(GeomList)\ geoms\ =\ \textcolor{keyword}{new}\ GeomList;}
\DoxyCodeLine{01174\ \ \ geoms-\/>reserve(num\_geoms);}
\DoxyCodeLine{01175\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_geoms;\ i++)\ \{}
\DoxyCodeLine{01176\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{01177\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{01178\ \ \ \ \ geoms-\/>push\_back(GeomEntry(\textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr}));}
\DoxyCodeLine{01179\ \ \ \}}
\DoxyCodeLine{01180\ \ \ \_geoms\ =\ geoms;}
\DoxyCodeLine{01181\ \}}

\end{DoxyCode}
