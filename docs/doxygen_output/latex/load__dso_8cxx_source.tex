\doxysection{load\+\_\+dso.\+cxx}
\hypertarget{load__dso_8cxx_source}{}\label{load__dso_8cxx_source}\index{dtool/src/dtoolutil/load\_dso.cxx@{dtool/src/dtoolutil/load\_dso.cxx}}
\mbox{\hyperlink{load__dso_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{load__dso_8h}{load\_dso.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{executionEnvironment_8h}{executionEnvironment.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{keyword}{static}\ \mbox{\hyperlink{classFilename}{Filename}}\ resolve\_dso(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&path,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00020\ \ \ \textcolor{keywordflow}{if}\ (filename.is\_local())\ \{}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keywordflow}{if}\ ((path.get\_num\_directories()==1)\&\&(path.get\_directory(0)==\textcolor{stringliteral}{"{}<auto>"{}}))\ \{}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ special\ case,\ meaning\ to\ search\ in\ the\ same\ directory\ in}}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \textcolor{comment}{//\ which\ libp3dtool.dll,\ or\ the\ exe,\ was\ started\ from.}}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ dtoolpath\ =\ ExecutionEnvironment::get\_dtool\_name();}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ spath(dtoolpath.get\_dirname());}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ spath.find\_file(filename);}
\DoxyCodeLine{00027\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ path.find\_file(filename);}
\DoxyCodeLine{00029\ \ \ \ \ \}}
\DoxyCodeLine{00030\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keywordflow}{return}\ filename;}
\DoxyCodeLine{00032\ \ \ \}}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)}}
\DoxyCodeLine{00036\ \textcolor{comment}{/*\ begin\ Win32-\/specific\ code\ */}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#define\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{windows_8h}{windows.h}}>}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#undef\ WINDOWS\_LEAN\_AND\_MEAN}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{comment}{//\ Loads\ in\ a\ dynamic\ library\ like\ an\ .so\ or\ .dll.\ \ Returns\ NULL\ if\ failure,}}
\DoxyCodeLine{00043\ \textcolor{comment}{//\ otherwise\ on\ success.\ \ If\ the\ filename\ is\ not\ absolute,\ searches\ the\ path.}}
\DoxyCodeLine{00044\ \textcolor{comment}{//\ If\ the\ path\ is\ empty,\ searches\ the\ dtool\ directory.}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \textcolor{keywordtype}{void}\ *}
\DoxyCodeLine{00047\ load\_dso(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&path,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00048\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ abspath\ =\ resolve\_dso(path,\ filename);}
\DoxyCodeLine{00049\ \ \ \textcolor{keywordflow}{if}\ (!abspath.\mbox{\hyperlink{classFilename_a19272a004582f775f780f8db4f4ddabc}{is\_regular\_file}}())\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ \ \ std::wstring\ os\_specific\_w\ =\ abspath.\mbox{\hyperlink{classFilename_a9c83035e7265e07243abd466fed94c6a}{to\_os\_specific\_w}}();}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{return}\ LoadLibraryExW(os\_specific\_w.c\_str(),\ \textcolor{keyword}{nullptr},\ LOAD\_WITH\_ALTERED\_SEARCH\_PATH);}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{00057\ unload\_dso(\textcolor{keywordtype}{void}\ *dso\_handle)\ \{}
\DoxyCodeLine{00058\ \ \ HMODULE\ dll\_handle\ =\ (HMODULE)\ dso\_handle;}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ true\ indicates\ success}}
\DoxyCodeLine{00061\ \ \ \textcolor{keywordflow}{return}\ (FreeLibrary(dll\_handle)!=0);}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \textcolor{keywordtype}{string}}
\DoxyCodeLine{00065\ load\_dso\_error()\ \{}
\DoxyCodeLine{00066\ \ \ DWORD\ last\_error\ =\ GetLastError();}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00069\ \textcolor{comment}{\ \ LPVOID\ ptr;}}
\DoxyCodeLine{00070\ \textcolor{comment}{\ \ if\ (FormatMessage(\ FORMAT\_MESSAGE\_ALLOCATE\_BUFFER\ |}}
\DoxyCodeLine{00071\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FORMAT\_MESSAGE\_FROM\_SYSTEM,}}
\DoxyCodeLine{00072\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ NULL,}}
\DoxyCodeLine{00073\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ last\_error,}}
\DoxyCodeLine{00074\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MAKELANGID(\ LANG\_ENGLISH,\ SUBLANG\_ENGLISH\_US\ ),}}
\DoxyCodeLine{00075\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (LPTSTR)\&ptr,}}
\DoxyCodeLine{00076\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ NULL))}}
\DoxyCodeLine{00077\ \textcolor{comment}{\ \ \ \ \{}}
\DoxyCodeLine{00078\ \textcolor{comment}{\ \ \ \ \ \ cout\ <<\ "{}ERROR:\ "{}\ <<\ "{}\ result\ =\ "{}\ <<\ (char*)\ ptr\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{00079\ \textcolor{comment}{\ \ \ \ \ \ LocalFree(\ ptr\ );}}
\DoxyCodeLine{00080\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00081\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \textcolor{keywordflow}{switch}\ (last\_error)\ \{}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{case}\ 2:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}File\ not\ found"{}};}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordflow}{case}\ 3:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Path\ not\ found"{}};}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{case}\ 4:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Too\ many\ open\ files"{}};}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordflow}{case}\ 5:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Access\ denied"{}};}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordflow}{case}\ 14:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Out\ of\ memory"{}};}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keywordflow}{case}\ 18:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}No\ more\ files"{}};}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{case}\ 126:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Module\ not\ found"{}};}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordflow}{case}\ 127:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}The\ specified\ procedure\ could\ not\ be\ found"{}};}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordflow}{case}\ 193:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Not\ a\ valid\ Win32\ application"{}};}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{case}\ 998:\ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Invalid\ access\ to\ memory\ location"{}};}
\DoxyCodeLine{00094\ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \textcolor{comment}{//\ Some\ unknown\ error\ code.}}
\DoxyCodeLine{00097\ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}}\ errmsg;}
\DoxyCodeLine{00098\ \ \ errmsg\ <<\ \textcolor{stringliteral}{"{}Unknown\ error\ "{}}\ <<\ last\_error;}
\DoxyCodeLine{00099\ \ \ \textcolor{keywordflow}{return}\ errmsg.str();}
\DoxyCodeLine{00100\ \}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \textcolor{keywordtype}{void}\ *}
\DoxyCodeLine{00103\ get\_dso\_symbol(\textcolor{keywordtype}{void}\ *handle,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\ \{}
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ Windows\ puts\ a\ leading\ underscore\ in\ front\ of\ the\ symbol\ name.}}
\DoxyCodeLine{00105\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{void}\ *)GetProcAddress((HMODULE)handle,\ name.c\_str());}
\DoxyCodeLine{00106\ \}}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \textcolor{comment}{/*\ end\ Win32-\/specific\ code\ */}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00111\ \textcolor{comment}{/*\ begin\ Posix\ code\ */}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#if\ defined(IS\_OSX)}}
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#include\ <mach-\/o/dyld.h>}}
\DoxyCodeLine{00115\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \textcolor{preprocessor}{\#include\ <dlfcn.h>}}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \textcolor{keywordtype}{void}\ *}
\DoxyCodeLine{00120\ load\_dso(\textcolor{keyword}{const}\ \mbox{\hyperlink{classDSearchPath}{DSearchPath}}\ \&path,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\ \{}
\DoxyCodeLine{00121\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ abspath\ =\ resolve\_dso(path,\ filename);}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (!abspath.\mbox{\hyperlink{classFilename_a19272a004582f775f780f8db4f4ddabc}{is\_regular\_file}}())\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ the\ error\ flag\ is\ cleared,\ to\ prevent\ a\ subsequent\ call\ to}}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ load\_dso\_error()\ from\ returning\ a\ previously\ stored\ error.}}
\DoxyCodeLine{00125\ \ \ \ \ dlerror();}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00127\ \ \ \}}
\DoxyCodeLine{00128\ \ \ \textcolor{keywordtype}{string}\ os\_specific\ =\ abspath.\mbox{\hyperlink{classFilename_a5965a823b0fda63742c59103e8b447dd}{to\_os\_specific}}();}
\DoxyCodeLine{00129\ \ \ \textcolor{keywordflow}{return}\ dlopen(os\_specific.c\_str(),\ RTLD\_NOW\ |\ RTLD\_GLOBAL);}
\DoxyCodeLine{00130\ \}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \textcolor{keywordtype}{bool}}
\DoxyCodeLine{00133\ unload\_dso(\textcolor{keywordtype}{void}\ *dso\_handle)\ \{}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{return}\ dlclose(dso\_handle)==0;}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \textcolor{keywordtype}{string}}
\DoxyCodeLine{00138\ load\_dso\_error()\ \{}
\DoxyCodeLine{00139\ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *message\ =\ dlerror();}
\DoxyCodeLine{00140\ \ \ \ \textcolor{keywordflow}{if}\ (message\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{return}\ std::string(message);}
\DoxyCodeLine{00142\ \ \ \}}
\DoxyCodeLine{00143\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}No\ error."{}};}
\DoxyCodeLine{00144\ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \textcolor{keywordtype}{void}\ *}
\DoxyCodeLine{00147\ get\_dso\_symbol(\textcolor{keywordtype}{void}\ *handle,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\ \{}
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{return}\ dlsym(handle,\ name.c\_str());}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
