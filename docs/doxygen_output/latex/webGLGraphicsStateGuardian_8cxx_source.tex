\doxysection{web\+GLGraphics\+State\+Guardian.\+cxx}
\hypertarget{webGLGraphicsStateGuardian_8cxx_source}{}\label{webGLGraphicsStateGuardian_8cxx_source}\index{panda/src/webgldisplay/webGLGraphicsStateGuardian.cxx@{panda/src/webgldisplay/webGLGraphicsStateGuardian.cxx}}
\mbox{\hyperlink{webGLGraphicsStateGuardian_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{webGLGraphicsStateGuardian_8h}{webGLGraphicsStateGuardian.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__webgldisplay_8h}{config\_webgldisplay.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{extern}\ \textcolor{stringliteral}{"{}C"{}}\ \{}
\DoxyCodeLine{00018\ \ \ \textcolor{keyword}{extern}\ \textcolor{keywordtype}{void}*\ emscripten\_GetProcAddress(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *x);}
\DoxyCodeLine{00019\ \}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ WebGLGraphicsStateGuardian::\_type\_handle;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00026\ WebGLGraphicsStateGuardian::}
\DoxyCodeLine{00027\ WebGLGraphicsStateGuardian(\mbox{\hyperlink{classGraphicsEngine}{GraphicsEngine}}\ *engine,\ \mbox{\hyperlink{classGraphicsPipe}{GraphicsPipe}}\ *pipe)\ :}
\DoxyCodeLine{00028\ \ \ GLES2GraphicsStateGuardian(engine,\ pipe)}
\DoxyCodeLine{00029\ \{}
\DoxyCodeLine{00030\ \ \ \_context\ =\ 0;}
\DoxyCodeLine{00031\ \ \ \_have\_context\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00032\ \}}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00037\ WebGLGraphicsStateGuardian::}
\DoxyCodeLine{00038\ \string~WebGLGraphicsStateGuardian()\ \{}
\DoxyCodeLine{00039\ \ \ \textcolor{keywordflow}{if}\ (\_context\ !=\ 0)\ \{}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *target\ =\ \textcolor{stringliteral}{"{}\#canvas"{}};}
\DoxyCodeLine{00041\ \ \ \ \ emscripten\_set\_webglcontextlost\_callback(target,\ NULL,\ \textcolor{keyword}{false},\ NULL);}
\DoxyCodeLine{00042\ \ \ \ \ emscripten\_set\_webglcontextrestored\_callback(target,\ NULL,\ \textcolor{keyword}{false},\ NULL);}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keywordflow}{if}\ (emscripten\_webgl\_destroy\_context(\_context)\ !=\ EMSCRIPTEN\_RESULT\_SUCCESS)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \ \ webgldisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ destroy\ WebGL\ context!\(\backslash\)n"{}};}
\DoxyCodeLine{00046\ \ \ \ \ \}}
\DoxyCodeLine{00047\ \ \ \ \ \_context\ =\ 0;}
\DoxyCodeLine{00048\ \ \ \}}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00055\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6b31b18d5d54202647c493668dc6f8e6}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00056\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6b31b18d5d54202647c493668dc6f8e6}{choose\_pixel\_format}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFrameBufferProperties}{FrameBufferProperties}}\ \&properties,}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *target)\ \{}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ nassertv(\_context\ ==\ 0);}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ EmscriptenWebGLContextAttributes\ attribs;}
\DoxyCodeLine{00062\ \ \ emscripten\_webgl\_init\_context\_attributes(\&attribs);}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ attribs.alpha\ =\ (properties.get\_alpha\_bits()\ >\ 0);}
\DoxyCodeLine{00065\ \ \ attribs.depth\ =\ (properties.get\_depth\_bits()\ >\ 0);}
\DoxyCodeLine{00066\ \ \ attribs.stencil\ =\ (properties.get\_stencil\_bits()\ >\ 0);}
\DoxyCodeLine{00067\ \ \ attribs.majorVersion\ =\ 2;}
\DoxyCodeLine{00068\ \ \ attribs.minorVersion\ =\ 0;}
\DoxyCodeLine{00069\ \ \ attribs.enableExtensionsByDefault\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ EMSCRIPTEN\_WEBGL\_CONTEXT\_HANDLE\ result;}
\DoxyCodeLine{00072\ \ \ result\ =\ emscripten\_webgl\_create\_context(target,\ \&attribs);}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (result\ <=\ 0)\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{comment}{//\ Fall\ back\ to\ WebGL\ 1.}}
\DoxyCodeLine{00076\ \ \ \ \ attribs.majorVersion\ =\ 1;}
\DoxyCodeLine{00077\ \ \ \ \ result\ =\ emscripten\_webgl\_create\_context(target,\ \&attribs);}
\DoxyCodeLine{00078\ \ \ \}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (result\ >\ 0)\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \_context\ =\ result;}
\DoxyCodeLine{00082\ \ \ \ \ \_have\_context\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ We\ may\ lose\ the\ WebGL\ context\ at\ any\ time,\ at\ which\ time\ we\ have\ to\ be}}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{comment}{//\ prepared\ to\ drop\ all\ resources.}}
\DoxyCodeLine{00086\ \ \ \ \ emscripten\_set\_webglcontextlost\_callback(target,\ (\textcolor{keywordtype}{void}\ *)\textcolor{keyword}{this},\ \textcolor{keyword}{false},\ \&\mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6fdc69e7ad7abb72a5ae56078b7e3706}{on\_context\_event}});}
\DoxyCodeLine{00087\ \ \ \ \ emscripten\_set\_webglcontextrestored\_callback(target,\ (\textcolor{keywordtype}{void}\ *)\textcolor{keyword}{this},\ \textcolor{keyword}{false},\ \&\mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6fdc69e7ad7abb72a5ae56078b7e3706}{on\_context\_event}});}
\DoxyCodeLine{00088\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00089\ \ \ \ \ webgldisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Context\ creation\ failed.\(\backslash\)n"{}};}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00096\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a90a6dba6d0d42f8f3a4e6fe8d0dadf6f}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00097\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a90a6dba6d0d42f8f3a4e6fe8d0dadf6f}{reset}}()\ \{}
\DoxyCodeLine{00098\ \ \ GLES2GraphicsStateGuardian::reset();}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00105\ EM\_BOOL\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6fdc69e7ad7abb72a5ae56078b7e3706}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00106\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a6fdc69e7ad7abb72a5ae56078b7e3706}{on\_context\_event}}(\textcolor{keywordtype}{int}\ type,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{void}\ *,\ \textcolor{keywordtype}{void}\ *user\_data)\ \{}
\DoxyCodeLine{00107\ \ \ \mbox{\hyperlink{classWebGLGraphicsStateGuardian}{WebGLGraphicsStateGuardian}}\ *gsg\ =\ (\mbox{\hyperlink{classWebGLGraphicsStateGuardian}{WebGLGraphicsStateGuardian}}\ *)user\_data;}
\DoxyCodeLine{00108\ \ \ nassertr(gsg\ !=\ NULL,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \textcolor{keywordflow}{if}\ (type\ ==\ EMSCRIPTEN\_EVENT\_WEBGLCONTEXTLOST)\ \{}
\DoxyCodeLine{00111\ \ \ \ \ webgldisplay\_cat.info()\ <<\ \textcolor{stringliteral}{"{}WebGL\ context\ lost!\(\backslash\)n"{}};}
\DoxyCodeLine{00112\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classWebGLGraphicsStateGuardian_ab3d04de63fcaa30b4d0a92159e100609}{context\_lost}}();}
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (type\ ==\ EMSCRIPTEN\_EVENT\_WEBGLCONTEXTRESTORED)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ webgldisplay\_cat.info()\ <<\ \textcolor{stringliteral}{"{}WebGL\ context\ restored!\(\backslash\)n"{}};}
\DoxyCodeLine{00117\ \ \ \ \ gsg-\/>\mbox{\hyperlink{classWebGLGraphicsStateGuardian_a90a6dba6d0d42f8f3a4e6fe8d0dadf6f}{reset}}();}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00119\ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00122\ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00128\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_ab3d04de63fcaa30b4d0a92159e100609}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00129\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_ab3d04de63fcaa30b4d0a92159e100609}{context\_lost}}()\ \{}
\DoxyCodeLine{00130\ \ \ release\_all();}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \textcolor{comment}{//\ Assign\ a\ new\ PreparedGraphicsObjects\ to\ prevent\ the\ GSG\ from\ to\ trying\ to}}
\DoxyCodeLine{00133\ \ \ \textcolor{comment}{//\ neatly\ clean\ up\ the\ old\ resources.}}
\DoxyCodeLine{00134\ \ \ \_prepared\_objects\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}};}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00142\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_aaf906eaa4f0bd9870c7cc96a598ba023}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00143\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_aaf906eaa4f0bd9870c7cc96a598ba023}{get\_extra\_extensions}}()\ \{}
\DoxyCodeLine{00144\ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00150\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a790b04b336c9aba7ed2e349fa7dbfe97}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00151\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a790b04b336c9aba7ed2e349fa7dbfe97}{has\_extension}}(\textcolor{keyword}{const}\ std::string\ \&extension)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00152\ \ \ nassertr(\_context\ !=\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \textcolor{comment}{//\ If\ the\ GSG\ asks\ for\ it,\ that\ is\ probably\ a\ good\ reason\ to\ activate\ the}}
\DoxyCodeLine{00155\ \ \ \textcolor{comment}{//\ extension.}}
\DoxyCodeLine{00156\ \ \ EM\_BOOL\ result\ =\ emscripten\_webgl\_enable\_extension(\_context,\ extension.c\_str());}
\DoxyCodeLine{00157\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00158\ \ \ \textcolor{keywordflow}{if}\ (result)\ \{}
\DoxyCodeLine{00159\ \ \ \ \ webgldisplay\_cat.info()\ <<\ \textcolor{stringliteral}{"{}Activated\ extension:\ "{}}\ <<\ extension\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00160\ \ \ \}}
\DoxyCodeLine{00161\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00163\ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00171\ \textcolor{keywordtype}{void}\ *\mbox{\hyperlink{classWebGLGraphicsStateGuardian_a4b49936d214643085abc78cea597124e}{WebGLGraphicsStateGuardian::}}}
\DoxyCodeLine{00172\ \mbox{\hyperlink{classWebGLGraphicsStateGuardian_a4b49936d214643085abc78cea597124e}{do\_get\_extension\_func}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *name)\ \{}
\DoxyCodeLine{00173\ \ \ \textcolor{keywordflow}{return}\ emscripten\_GetProcAddress(name);}
\DoxyCodeLine{00174\ \}}

\end{DoxyCode}
