\doxysection{io\+Kit\+Input\+Device\+Manager.\+cxx}
\hypertarget{ioKitInputDeviceManager_8cxx_source}{}\label{ioKitInputDeviceManager_8cxx_source}\index{panda/src/device/ioKitInputDeviceManager.cxx@{panda/src/device/ioKitInputDeviceManager.cxx}}
\mbox{\hyperlink{ioKitInputDeviceManager_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ioKitInputDeviceManager_8h}{ioKitInputDeviceManager.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ioKitInputDevice_8h}{ioKitInputDevice.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#if\ defined(\_\_APPLE\_\_)\ \&\&\ !defined(CPPPARSER)}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{keyword}{static}\ \mbox{\hyperlink{classConfigVariableBool}{ConfigVariableBool}}\ iokit\_scan\_mouse\_devices}
\DoxyCodeLine{00020\ (\textcolor{stringliteral}{"{}iokit-\/scan-\/mouse-\/devices"{}},\ \textcolor{keyword}{false},}
\DoxyCodeLine{00021\ \ PRC\_DESC(\textcolor{stringliteral}{"{}Set\ this\ to\ true\ to\ enable\ capturing\ raw\ mouse\ data\ via\ IOKit\ on\ "{}}}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}macOS.\ \ This\ is\ disabled\ by\ default\ because\ newer\ macOS\ versions\ "{}}}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}will\ prompt\ the\ user\ explicitly\ for\ permissions\ when\ this\ is\ on."{}}));}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{static}\ \mbox{\hyperlink{classConfigVariableBool}{ConfigVariableBool}}\ iokit\_scan\_keyboard\_devices}
\DoxyCodeLine{00026\ (\textcolor{stringliteral}{"{}iokit-\/scan-\/keyboard-\/devices"{}},\ \textcolor{keyword}{false},}
\DoxyCodeLine{00027\ \ PRC\_DESC(\textcolor{stringliteral}{"{}Set\ this\ to\ true\ to\ enable\ capturing\ raw\ keyboard\ data\ via\ IOKit\ on\ "{}}}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}macOS.\ \ This\ is\ disabled\ by\ default\ because\ newer\ macOS\ versions\ "{}}}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}will\ prompt\ the\ user\ explicitly\ for\ permissions\ when\ this\ is\ on."{}}));}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00036\ IOKitInputDeviceManager::}
\DoxyCodeLine{00037\ IOKitInputDeviceManager()\ \{}
\DoxyCodeLine{00038\ \ \ \_hid\_manager\ =\ IOHIDManagerCreate(kCFAllocatorDefault,\ kIOHIDOptionsTypeNone);}
\DoxyCodeLine{00039\ \ \ \textcolor{keywordflow}{if}\ (!\_hid\_manager)\ \{}
\DoxyCodeLine{00040\ \ \ \ \ device\_cat.error()}
\DoxyCodeLine{00041\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ create\ an\ IOHIDManager.\(\backslash\)n"{}};}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00043\ \ \ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \ \ \textcolor{comment}{//\ The\ types\ of\ devices\ we're\ interested\ in.}}
\DoxyCodeLine{00046\ \ \ \textcolor{keywordtype}{int}\ page\ =\ kHIDPage\_GenericDesktop;}
\DoxyCodeLine{00047\ \ \ \textcolor{keywordtype}{int}\ usages[]\ =\ \{kHIDUsage\_GD\_GamePad,}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kHIDUsage\_GD\_Joystick,}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kHIDUsage\_GD\_MultiAxisController,}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ 0\};}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \textcolor{keywordtype}{int}\ num\_usages\ =\ 3;}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{if}\ (iokit\_scan\_mouse\_devices)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ usages[num\_usages++]\ =\ kHIDUsage\_GD\_Mouse;}
\DoxyCodeLine{00055\ \ \ \}}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordflow}{if}\ (iokit\_scan\_keyboard\_devices)\ \{}
\DoxyCodeLine{00057\ \ \ \ \ usages[num\_usages++]\ =\ kHIDUsage\_GD\_Keyboard;}
\DoxyCodeLine{00058\ \ \ \}}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ This\ giant\ mess\ is\ necessary\ to\ create\ an\ array\ of\ match\ dictionaries}}
\DoxyCodeLine{00061\ \ \ \textcolor{comment}{//\ that\ will\ match\ the\ devices\ we're\ interested\ in.}}
\DoxyCodeLine{00062\ \ \ CFMutableArrayRef\ match\ =\ CFArrayCreateMutable(kCFAllocatorDefault,\ 0,\ \&kCFTypeArrayCallBacks);}
\DoxyCodeLine{00063\ \ \ nassertv(match);}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordtype}{int}\ *usage\ =\ usages;}
\DoxyCodeLine{00065\ \ \ \textcolor{keywordflow}{while}\ (*usage)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ CFMutableDictionaryRef\ dict\ =\ CFDictionaryCreateMutable(kCFAllocatorDefault,\ 0,\ \&kCFTypeDictionaryKeyCallBacks,\ \&kCFTypeDictionaryValueCallBacks);}
\DoxyCodeLine{00067\ \ \ \ \ CFNumberRef\ page\_ref\ =\ CFNumberCreate(kCFAllocatorDefault,\ kCFNumberIntType,\ \&page);}
\DoxyCodeLine{00068\ \ \ \ \ CFDictionarySetValue(dict,\ CFSTR(kIOHIDDeviceUsagePageKey),\ page\_ref);}
\DoxyCodeLine{00069\ \ \ \ \ CFRelease(page\_ref);}
\DoxyCodeLine{00070\ \ \ \ \ CFNumberRef\ usage\_ref\ =\ CFNumberCreate(kCFAllocatorDefault,\ kCFNumberIntType,\ usage);}
\DoxyCodeLine{00071\ \ \ \ \ CFDictionarySetValue(dict,\ CFSTR(kIOHIDDeviceUsageKey),\ usage\_ref);}
\DoxyCodeLine{00072\ \ \ \ \ CFRelease(usage\_ref);}
\DoxyCodeLine{00073\ \ \ \ \ CFArrayAppendValue(match,\ dict);}
\DoxyCodeLine{00074\ \ \ \ \ CFRelease(dict);}
\DoxyCodeLine{00075\ \ \ \ \ ++usage;}
\DoxyCodeLine{00076\ \ \ \}}
\DoxyCodeLine{00077\ \ \ IOHIDManagerSetDeviceMatchingMultiple(\_hid\_manager,\ match);}
\DoxyCodeLine{00078\ \ \ CFRelease(match);}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ IOHIDManagerRegisterDeviceMatchingCallback(\_hid\_manager,\ on\_match\_device,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00081\ \ \ IOHIDManagerRegisterDeviceRemovalCallback(\_hid\_manager,\ on\_remove\_device,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00082\ \ \ IOHIDManagerScheduleWithRunLoop(\_hid\_manager,\ CFRunLoopGetMain(),\ kCFRunLoopCommonModes);}
\DoxyCodeLine{00083\ \ \ IOHIDManagerOpen(\_hid\_manager,\ kIOHIDOptionsTypeNone);}
\DoxyCodeLine{00084\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00089\ IOKitInputDeviceManager::}
\DoxyCodeLine{00090\ \string~IOKitInputDeviceManager()\ \{}
\DoxyCodeLine{00091\ \ \ IOHIDManagerUnscheduleFromRunLoop(\_hid\_manager,\ CFRunLoopGetMain(),\ kCFRunLoopCommonModes);}
\DoxyCodeLine{00092\ \ \ IOHIDManagerClose(\_hid\_manager,\ kIOHIDOptionsTypeNone);}
\DoxyCodeLine{00093\ \ \ CFRelease(\_hid\_manager);}
\DoxyCodeLine{00094\ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00099\ \textcolor{keywordtype}{void}\ IOKitInputDeviceManager::}
\DoxyCodeLine{00100\ on\_match\_device(\textcolor{keywordtype}{void}\ *ctx,\ IOReturn\ result,\ \textcolor{keywordtype}{void}\ *sender,\ IOHIDDeviceRef\ device)\ \{}
\DoxyCodeLine{00101\ \ \ IOKitInputDeviceManager\ *mgr\ =\ (IOKitInputDeviceManager\ *)ctx;}
\DoxyCodeLine{00102\ \ \ nassertv(mgr\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00103\ \ \ nassertv(device);}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ IOKitInputDevice\ *input\_device\ =\ \textcolor{keyword}{new}\ IOKitInputDevice(device);}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00107\ \ \ \ \ device\_cat.debug()}
\DoxyCodeLine{00108\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Discovered\ input\ device\ "{}}\ <<\ *input\_device\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00109\ \ \ \}}
\DoxyCodeLine{00110\ \ \ mgr-\/>add\_device(input\_device);}
\DoxyCodeLine{00111\ \ \ mgr-\/>\_devices\_by\_hidref[device]\ =\ input\_device;}
\DoxyCodeLine{00112\ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00117\ \textcolor{keywordtype}{void}\ IOKitInputDeviceManager::}
\DoxyCodeLine{00118\ on\_remove\_device(\textcolor{keywordtype}{void}\ *ctx,\ IOReturn\ result,\ \textcolor{keywordtype}{void}\ *sender,\ IOHIDDeviceRef\ device)\ \{}
\DoxyCodeLine{00119\ \ \ IOKitInputDeviceManager\ *mgr\ =\ (IOKitInputDeviceManager\ *)ctx;}
\DoxyCodeLine{00120\ \ \ nassertv(mgr\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00121\ \ \ nassertv(device);}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keyword}{auto}\ it\ =\ mgr-\/>\_devices\_by\_hidref.find(device);}
\DoxyCodeLine{00124\ \ \ nassertv(it\ !=\ mgr-\/>\_devices\_by\_hidref.end());}
\DoxyCodeLine{00125\ \ \ IOKitInputDevice\ *input\_device\ =\ it-\/>second;}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ input\_device-\/>set\_connected(\textcolor{keyword}{false});}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ mgr-\/>\_devices\_by\_hidref.erase(device);}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ IOHIDDeviceClose(device,\ kIOHIDOptionsTypeNone);}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00134\ \ \ \ \ device\_cat.debug()}
\DoxyCodeLine{00135\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Removed\ input\ device\ "{}}\ <<\ *input\_device\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00136\ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ mgr-\/>remove\_device(input\_device);}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
