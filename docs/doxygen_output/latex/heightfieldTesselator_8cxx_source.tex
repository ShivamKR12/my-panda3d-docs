\doxysection{heightfield\+Tesselator.\+cxx}
\hypertarget{heightfieldTesselator_8cxx_source}{}\label{heightfieldTesselator_8cxx_source}\index{panda/src/grutil/heightfieldTesselator.cxx@{panda/src/grutil/heightfieldTesselator.cxx}}
\mbox{\hyperlink{heightfieldTesselator_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{heightfieldTesselator_8h}{heightfieldTesselator.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{transformState_8h}{transformState.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sceneGraphReducer_8h}{sceneGraphReducer.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lvector3_8h}{lvector3.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00025\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00026\ fix\_heightfield(\textcolor{keywordtype}{int}\ size)\ \{}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \textcolor{comment}{//\ Calculate\ the\ padded\ size\ of\ the\ heightfield.}}
\DoxyCodeLine{00029\ \ \ \textcolor{keywordtype}{int}\ xsize\ =\ \_heightfield.get\_x\_size();}
\DoxyCodeLine{00030\ \ \ \textcolor{keywordtype}{int}\ ysize\ =\ \_heightfield.get\_y\_size();}
\DoxyCodeLine{00031\ \ \ \textcolor{keywordtype}{int}\ xcells\ =\ (xsize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00032\ \ \ \textcolor{keywordtype}{int}\ ycells\ =\ (ysize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00033\ \ \ \textcolor{keywordtype}{int}\ xpadded\ =\ xcells\ *\ size\ +\ 1;}
\DoxyCodeLine{00034\ \ \ \textcolor{keywordtype}{int}\ ypadded\ =\ ycells\ *\ size\ +\ 1;}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \textcolor{comment}{//\ If\ the\ heightfield\ is\ already\ in\ good\ shape,\ done.}}
\DoxyCodeLine{00037\ \ \ \textcolor{keywordflow}{if}\ ((xpadded\ ==\ \_heightfield.get\_x\_size())\ \&\&}
\DoxyCodeLine{00038\ \ \ \ \ \ \ (ypadded\ ==\ \_heightfield.get\_y\_size())\ \&\&}
\DoxyCodeLine{00039\ \ \ \ \ \ \ (\_heightfield.is\_grayscale()))\ \{}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00041\ \ \ \}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \textcolor{comment}{//\ Pad\ the\ heightfield,\ and\ convert\ to\ grey.}}
\DoxyCodeLine{00044\ \ \ \mbox{\hyperlink{classPNMImage}{PNMImage}}\ unfixed(\_heightfield);}
\DoxyCodeLine{00045\ \ \ \_heightfield.clear(xpadded,\ ypadded,\ 1,}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ unfixed.get\_maxval(),}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ unfixed.get\_type());}
\DoxyCodeLine{00048\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y\ =\ 0;\ y\ <\ ysize;\ y++)\ \{}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x\ =\ 0;\ x\ <\ xsize;\ x++)\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \_heightfield.set\_gray\_val(x,\ y,\ unfixed.get\_gray\_val(x,\ y));}
\DoxyCodeLine{00051\ \ \ \ \ \}}
\DoxyCodeLine{00052\ \ \ \}}
\DoxyCodeLine{00053\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y\ =\ ysize;\ y\ <\ ypadded;\ y++)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x\ =\ xsize;\ x\ <\ xpadded;\ x++)\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \_heightfield.set\_gray\_val(x,\ y,\ 0);}
\DoxyCodeLine{00056\ \ \ \ \ \}}
\DoxyCodeLine{00057\ \ \ \}}
\DoxyCodeLine{00058\ \}}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00065\ \textcolor{keywordtype}{double}\ HeightfieldTesselator::}
\DoxyCodeLine{00066\ get\_elevation(\textcolor{keywordtype}{double}\ x,\ \textcolor{keywordtype}{double}\ y)\ \{}
\DoxyCodeLine{00067\ \ \ \textcolor{keywordtype}{int}\ scale\ =\ 7;}
\DoxyCodeLine{00068\ \ \ \textcolor{keywordtype}{int}\ size\ =\ 1\ <<\ scale;}
\DoxyCodeLine{00069\ \ \ fix\_heightfield(size);}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordtype}{int}\ xlo\ =\ (int)x;}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordtype}{int}\ ylo\ =\ (int)y;}
\DoxyCodeLine{00072\ \ \ \textcolor{keywordflow}{if}\ (xlo\ <\ 0)\ xlo\ =\ 0;}
\DoxyCodeLine{00073\ \ \ \textcolor{keywordflow}{if}\ (ylo\ <\ 0)\ ylo\ =\ 0;}
\DoxyCodeLine{00074\ \ \ \textcolor{keywordflow}{if}\ (xlo\ >\ \_heightfield.get\_x\_size()-\/2)}
\DoxyCodeLine{00075\ \ \ \ \ xlo\ =\ \_heightfield.get\_x\_size()-\/2;}
\DoxyCodeLine{00076\ \ \ \textcolor{keywordflow}{if}\ (ylo\ >\ \_heightfield.get\_y\_size()-\/2)}
\DoxyCodeLine{00077\ \ \ \ \ ylo\ =\ \_heightfield.get\_y\_size()-\/2;}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordtype}{int}\ xhi\ =\ xlo+1;}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordtype}{int}\ yhi\ =\ ylo+1;}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordtype}{double}\ xoffs\ =\ x\ -\/\ xlo;}
\DoxyCodeLine{00081\ \ \ \textcolor{keywordtype}{double}\ yoffs\ =\ y\ -\/\ ylo;}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordtype}{double}\ grayxlyl\ =\ \_heightfield.get\_gray(xlo,ylo);}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordtype}{double}\ grayxhyl\ =\ \_heightfield.get\_gray(xhi,ylo);}
\DoxyCodeLine{00084\ \ \ \textcolor{keywordtype}{double}\ grayxlyh\ =\ \_heightfield.get\_gray(xlo,yhi);}
\DoxyCodeLine{00085\ \ \ \textcolor{keywordtype}{double}\ grayxhyh\ =\ \_heightfield.get\_gray(xhi,yhi);}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordtype}{double}\ lerpyl\ =\ grayxhyl\ *\ xoffs\ +\ grayxlyl\ *\ (1.0\ -\/\ xoffs);}
\DoxyCodeLine{00087\ \ \ \textcolor{keywordtype}{double}\ lerpyh\ =\ grayxhyh\ *\ xoffs\ +\ grayxlyh\ *\ (1.0\ -\/\ xoffs);}
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{return}\ lerpyh\ *\ yoffs\ +\ lerpyl\ *\ (1.0\ -\/\ yoffs);}
\DoxyCodeLine{00089\ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00094\ \textcolor{keywordtype}{int}\ HeightfieldTesselator::}
\DoxyCodeLine{00095\ get\_vertex(\textcolor{keywordtype}{int}\ x,\ \textcolor{keywordtype}{int}\ y)\ \{}
\DoxyCodeLine{00096\ \ \ \textcolor{keywordtype}{int}\ xsize\ =\ \_heightfield.get\_x\_size();}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordtype}{int}\ vtx\ =\ \_vertex\_index[x+y*xsize];}
\DoxyCodeLine{00098\ \ \ \textcolor{keywordflow}{if}\ (vtx\ >=\ 0)\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keywordflow}{return}\ vtx;}
\DoxyCodeLine{00100\ \ \ \}}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordtype}{int}\ nx\ =\ x-\/1;}
\DoxyCodeLine{00102\ \ \ \textcolor{keywordtype}{int}\ px\ =\ x+1;}
\DoxyCodeLine{00103\ \ \ \textcolor{keywordtype}{int}\ ny\ =\ y-\/1;}
\DoxyCodeLine{00104\ \ \ \textcolor{keywordtype}{int}\ py\ =\ y+1;}
\DoxyCodeLine{00105\ \ \ \textcolor{keywordflow}{if}\ (nx\ <\ 0)\ nx++;}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{if}\ (ny\ <\ 0)\ ny++;}
\DoxyCodeLine{00107\ \ \ \textcolor{keywordflow}{if}\ (px\ >=\ \_heightfield.get\_x\_size())\ px-\/-\/;}
\DoxyCodeLine{00108\ \ \ \textcolor{keywordflow}{if}\ (py\ >=\ \_heightfield.get\_y\_size())\ py-\/-\/;}
\DoxyCodeLine{00109\ \ \ \textcolor{keywordtype}{double}\ drx\ =\ \_heightfield.get\_gray(px,y)\ -\/\ \_heightfield.get\_gray(nx,y);}
\DoxyCodeLine{00110\ \ \ \textcolor{keywordtype}{double}\ dry\ =\ \_heightfield.get\_gray(x,py)\ -\/\ \_heightfield.get\_gray(x,ny);}
\DoxyCodeLine{00111\ \ \ LVector3\ normal(drx\ *\ \_vertical\_scale\ *\ 0.5,\ dry\ *\ \_vertical\_scale\ *\ 0.5,\ \_horizontal\_scale);}
\DoxyCodeLine{00112\ \ \ normal.normalize();}
\DoxyCodeLine{00113\ \ \ \textcolor{keywordtype}{double}\ z\ =\ \_heightfield.get\_gray(x,y);}
\DoxyCodeLine{00114\ \ \ \_vertex\_writer-\/>add\_data3(x*\_horizontal\_scale,-\/y*\_horizontal\_scale,z*\_vertical\_scale);}
\DoxyCodeLine{00115\ \ \ \_normal\_writer-\/>add\_data3(normal);}
\DoxyCodeLine{00116\ \ \ vtx\ =\ \_next\_index++;}
\DoxyCodeLine{00117\ \ \ \_dirty\_vertices[vtx]\ =\ x+y*xsize;}
\DoxyCodeLine{00118\ \ \ \_vertex\_index[x+y*xsize]\ =\ vtx;}
\DoxyCodeLine{00119\ \ \ \textcolor{keywordflow}{return}\ vtx;}
\DoxyCodeLine{00120\ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00127\ \mbox{\hyperlink{classNodePath}{NodePath}}\ HeightfieldTesselator::}
\DoxyCodeLine{00128\ generate()\ \{}
\DoxyCodeLine{00129\ \ \ \textcolor{keywordtype}{int}\ scale\ =\ 7;}
\DoxyCodeLine{00130\ \ \ \textcolor{keywordtype}{int}\ size\ =\ 1\ <<\ scale;}
\DoxyCodeLine{00131\ \ \ fix\_heightfield(size);}
\DoxyCodeLine{00132\ \ \ \textcolor{keywordtype}{int}\ xsize\ =\ \_heightfield.get\_x\_size();}
\DoxyCodeLine{00133\ \ \ \textcolor{keywordtype}{int}\ ysize\ =\ \_heightfield.get\_y\_size();}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordtype}{int}\ xcells\ =\ (xsize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00135\ \ \ \textcolor{keywordtype}{int}\ ycells\ =\ (ysize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \_vertex\_index\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{int}[xsize\ *\ ysize];}
\DoxyCodeLine{00138\ \ \ \_dirty\_vertices\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{int}[xsize\ *\ ysize];}
\DoxyCodeLine{00139\ \ \ \_triangle\_totals\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{int}[xsize\ *\ ysize];}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y=0;\ y<ysize;\ y++)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x=0;\ x<xsize;\ x++)\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \_vertex\_index[y*xsize+x]\ =\ -\/1;}
\DoxyCodeLine{00143\ \ \ \ \ \}}
\DoxyCodeLine{00144\ \ \ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \textcolor{keywordflow}{if}\ (!\_radii\_calculated)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordtype}{int}\ saved\_focal\_x\ =\ \_focal\_x;}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordtype}{int}\ saved\_focal\_y\ =\ \_focal\_y;}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \ \ \_focal\_x\ =\ \_heightfield.get\_x\_size()\ >>\ 1;}
\DoxyCodeLine{00151\ \ \ \ \ \_focal\_y\ =\ \_heightfield.get\_y\_size()\ >>\ 1;}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ calculate\_radii(scale);}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \_focal\_x\ =\ saved\_focal\_x;}
\DoxyCodeLine{00156\ \ \ \ \ \_focal\_y\ =\ saved\_focal\_y;}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \ \ \_radii\_calculated\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00159\ \ \ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ result\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}(get\_name());}
\DoxyCodeLine{00162\ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ root(result);}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \textcolor{comment}{//int\ total\ =\ 0;}}
\DoxyCodeLine{00165\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y=0;\ y<ycells;\ y++)\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x=0;\ x<xcells;\ x++)\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \textcolor{comment}{/*total\ +=\ */}count\_triangles(scale,x*size,y*size);}
\DoxyCodeLine{00168\ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \}}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y=0;\ y<ycells;\ y++)\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x=0;\ x<xcells;\ x++)\ \{}
\DoxyCodeLine{00172\ \ \ \ \ \ \ generate\_square(root,scale,x*size,y*size,\textcolor{keyword}{true});}
\DoxyCodeLine{00173\ \ \ \ \ \}}
\DoxyCodeLine{00174\ \ \ \}}
\DoxyCodeLine{00175\ \ \ \textcolor{keyword}{delete}[]\ \_vertex\_index;}
\DoxyCodeLine{00176\ \ \ \textcolor{keyword}{delete}[]\ \_dirty\_vertices;}
\DoxyCodeLine{00177\ \ \ \textcolor{keyword}{delete}[]\ \_triangle\_totals;}
\DoxyCodeLine{00178\ \ \ \_vertex\_index\ =\textcolor{keyword}{nullptr};}
\DoxyCodeLine{00179\ \ \ \_dirty\_vertices\ =\textcolor{keyword}{nullptr};}
\DoxyCodeLine{00180\ \ \ \_triangle\_totals\ =\textcolor{keyword}{nullptr};}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ root;}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00189\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00190\ calculate\_radii(\textcolor{keywordtype}{int}\ scale)\ \{}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordtype}{int}\ size\ =\ 1\ <<\ scale;}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordtype}{int}\ xsize\ =\ \_heightfield.get\_x\_size();}
\DoxyCodeLine{00193\ \ \ \textcolor{keywordtype}{int}\ ysize\ =\ \_heightfield.get\_y\_size();}
\DoxyCodeLine{00194\ \ \ \textcolor{keywordtype}{int}\ xcells\ =\ (xsize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00195\ \ \ \textcolor{keywordtype}{int}\ ycells\ =\ (ysize\ +\ size\ -\/\ 2)\ /\ size;}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \textcolor{keywordtype}{double}\ lo\ =\ 5.0;}
\DoxyCodeLine{00198\ \ \ \textcolor{keywordtype}{double}\ hi\ =\ \_heightfield.get\_x\_size()\ +\ \_heightfield.get\_y\_size();}
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{while}\ (1)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keywordtype}{double}\ mid\ =\ (lo\ +\ hi)\ *\ 0.5;}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<16;\ i++)\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \_radii[i]\ =\ (int)(mid\ *\ (1<<i));}
\DoxyCodeLine{00203\ \ \ \ \ \}}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordtype}{int}\ total\ =\ 0;}
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ y=0;\ y<ycells;\ y++)\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ x=0;\ x<xcells;\ x++)\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ total\ +=\ count\_triangles(scale,x*size,y*size);}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00209\ \ \ \ \ \}}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordflow}{if}\ (total\ >\ \_poly\_count)\ \{}
\DoxyCodeLine{00211\ \ \ \ \ \ \ hi\ =\ mid;}
\DoxyCodeLine{00212\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00213\ \ \ \ \ \ \ lo\ =\ mid;}
\DoxyCodeLine{00214\ \ \ \ \ \}}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{keywordflow}{if}\ (hi\ -\/\ lo\ <\ 1.0)\ \{}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00217\ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \}}
\DoxyCodeLine{00219\ \ \ \textcolor{keywordtype}{double}\ mid\ =\ (lo\ +\ hi)\ *\ 0.5;}
\DoxyCodeLine{00220\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<16;\ i++)\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \_radii[i]\ =\ (int)(mid\ *\ (1<<i));}
\DoxyCodeLine{00222\ \ \ \}}
\DoxyCodeLine{00223\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00240\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00241\ generate\_square(\mbox{\hyperlink{classNodePath}{NodePath}}\ root,\ \textcolor{keywordtype}{int}\ scale,\ \textcolor{keywordtype}{int}\ x,\ \textcolor{keywordtype}{int}\ y,\ \textcolor{keywordtype}{bool}\ forceclose)\ \{}
\DoxyCodeLine{00242\ \textcolor{comment}{/*}}
\DoxyCodeLine{00243\ \textcolor{comment}{\ *\ There\ are\ nine\ possible\ vertices\ in\ the\ square,\ which\ are\ labeled\ as}}
\DoxyCodeLine{00244\ \textcolor{comment}{\ *\ follows:\ G-\/-\/H-\/-\/I\ |\ \ \ \ \ |\ D\ \ E\ \ F\ |\ \ \ \ \ |\ A-\/-\/B-\/-\/C}}
\DoxyCodeLine{00245\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \ \ \textcolor{keywordtype}{int}\ size\ =\ 1<<scale;}
\DoxyCodeLine{00248\ \ \ \textcolor{keywordtype}{int}\ hsize\ =\ size>>1;}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ \textcolor{preprocessor}{\#define\ POINTA\ get\_vertex(x\ \ \ \ \ \ ,y)}}
\DoxyCodeLine{00251\ \textcolor{preprocessor}{\#define\ POINTB\ get\_vertex(x+hsize,y)}}
\DoxyCodeLine{00252\ \textcolor{preprocessor}{\#define\ POINTC\ get\_vertex(x+size\ ,y)}}
\DoxyCodeLine{00253\ \textcolor{preprocessor}{\#define\ POINTD\ get\_vertex(x\ \ \ \ \ \ ,y+hsize)}}
\DoxyCodeLine{00254\ \textcolor{preprocessor}{\#define\ POINTE\ get\_vertex(x+hsize,y+hsize)}}
\DoxyCodeLine{00255\ \textcolor{preprocessor}{\#define\ POINTF\ get\_vertex(x+size\ ,y+hsize)}}
\DoxyCodeLine{00256\ \textcolor{preprocessor}{\#define\ POINTG\ get\_vertex(x\ \ \ \ \ \ ,y+size)}}
\DoxyCodeLine{00257\ \textcolor{preprocessor}{\#define\ POINTH\ get\_vertex(x+hsize,y+size)}}
\DoxyCodeLine{00258\ \textcolor{preprocessor}{\#define\ POINTI\ get\_vertex(x+size\ ,y+size)}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (\_triangles\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00261\ \ \ \ \ open\_geom();}
\DoxyCodeLine{00262\ \ \ \}}
\DoxyCodeLine{00263\ \ \ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y))\ \{}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{keywordtype}{int}\ xc\ =\ x+(size>>1);}
\DoxyCodeLine{00265\ \ \ \ \ \textcolor{keywordtype}{int}\ yc\ =\ y+(size>>1);}
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_triangle\_totals[yc*\_heightfield.get\_x\_size()+xc]\ >\ \_max\_triangles)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_next\_index)\ close\_geom(root);}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \mbox{\hyperlink{classNodePath}{NodePath}}\ subroot\ =\ root.attach\_new\_node(get\_name()\ +\ \textcolor{stringliteral}{"{}\ interior"{}});}
\DoxyCodeLine{00269\ \ \ \ \ \ \ generate\_square(subroot,\ scale-\/1,\ x,\ \ y\ ,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00270\ \ \ \ \ \ \ generate\_square(subroot,\ scale-\/1,\ xc,\ y\ ,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00271\ \ \ \ \ \ \ generate\_square(subroot,\ scale-\/1,\ xc,\ yc,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00272\ \ \ \ \ \ \ generate\_square(subroot,\ scale-\/1,\ x,\ \ yc,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00273\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ generate\_square(root,\ scale-\/1,\ x,\ \ y\ ,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00275\ \ \ \ \ \ \ generate\_square(root,\ scale-\/1,\ xc,\ y\ ,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00276\ \ \ \ \ \ \ generate\_square(root,\ scale-\/1,\ xc,\ yc,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00277\ \ \ \ \ \ \ generate\_square(root,\ scale-\/1,\ x,\ \ yc,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00278\ \ \ \ \ \}}
\DoxyCodeLine{00279\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x+size,\ y))\ \{}
\DoxyCodeLine{00280\ \ \ \ \ add\_quad(POINTG,POINTA,POINTI,POINTF);}
\DoxyCodeLine{00281\ \ \ \ \ add\_quad(POINTA,POINTA,POINTF,POINTC);}
\DoxyCodeLine{00282\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x-\/size,\ y))\ \{}
\DoxyCodeLine{00283\ \ \ \ \ add\_quad(POINTG,POINTD,POINTI,POINTI);}
\DoxyCodeLine{00284\ \ \ \ \ add\_quad(POINTD,POINTA,POINTI,POINTC);}
\DoxyCodeLine{00285\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y+size))\ \{}
\DoxyCodeLine{00286\ \ \ \ \ add\_quad(POINTG,POINTA,POINTH,POINTA);}
\DoxyCodeLine{00287\ \ \ \ \ add\_quad(POINTH,POINTA,POINTI,POINTC);}
\DoxyCodeLine{00288\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y-\/size))\ \{}
\DoxyCodeLine{00289\ \ \ \ \ add\_quad(POINTG,POINTA,POINTI,POINTB);}
\DoxyCodeLine{00290\ \ \ \ \ add\_quad(POINTI,POINTB,POINTI,POINTC);}
\DoxyCodeLine{00291\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00292\ \ \ \ \ add\_quad(POINTG,POINTA,POINTI,POINTC);}
\DoxyCodeLine{00293\ \ \ \}}
\DoxyCodeLine{00294\ \ \ \textcolor{keywordflow}{if}\ (forceclose\ ||\ (\_next\_index\ >\ \_max\_triangles))\ \{}
\DoxyCodeLine{00295\ \ \ \ \ close\_geom(root);}
\DoxyCodeLine{00296\ \ \ \}}
\DoxyCodeLine{00297\ \}}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00303\ \textcolor{keywordtype}{int}\ HeightfieldTesselator::}
\DoxyCodeLine{00304\ count\_triangles(\textcolor{keywordtype}{int}\ scale,\ \textcolor{keywordtype}{int}\ x,\ \textcolor{keywordtype}{int}\ y)\ \{}
\DoxyCodeLine{00305\ \ \ \textcolor{keywordtype}{int}\ size\ =\ 1<<scale;}
\DoxyCodeLine{00306\ \ \ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y))\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{keywordtype}{int}\ xc\ =\ x\ +\ (size>>1);}
\DoxyCodeLine{00308\ \ \ \ \ \textcolor{keywordtype}{int}\ yc\ =\ y\ +\ (size>>1);}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{keywordtype}{int}\ n\ =\ 0;}
\DoxyCodeLine{00310\ \ \ \ \ n\ +=\ count\_triangles(scale-\/1,\ x,\ \ y\ );}
\DoxyCodeLine{00311\ \ \ \ \ n\ +=\ count\_triangles(scale-\/1,\ xc,\ y\ );}
\DoxyCodeLine{00312\ \ \ \ \ n\ +=\ count\_triangles(scale-\/1,\ x,\ \ yc);}
\DoxyCodeLine{00313\ \ \ \ \ n\ +=\ count\_triangles(scale-\/1,\ xc,\ yc);}
\DoxyCodeLine{00314\ \ \ \ \ \_triangle\_totals[yc*\_heightfield.get\_x\_size()\ +\ xc]\ =\ n;}
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{keywordflow}{return}\ n;}
\DoxyCodeLine{00316\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x+size,\ y))\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordflow}{return}\ 3;}
\DoxyCodeLine{00318\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x-\/size,\ y))\ \{}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keywordflow}{return}\ 3;}
\DoxyCodeLine{00320\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y+size))\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keywordflow}{return}\ 3;}
\DoxyCodeLine{00322\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (subdivide(scale,\ x,\ y-\/size))\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordflow}{return}\ 3;}
\DoxyCodeLine{00324\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{keywordflow}{return}\ 2;}
\DoxyCodeLine{00326\ \ \ \}}
\DoxyCodeLine{00327\ \}}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00332\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00333\ add\_quad\_to\_strip(\textcolor{keywordtype}{int}\ v1,\ \textcolor{keywordtype}{int}\ v2,\ \textcolor{keywordtype}{int}\ v3,\ \textcolor{keywordtype}{int}\ v4)\ \{}
\DoxyCodeLine{00334\ \ \ \textcolor{keywordflow}{if}\ ((v1\ !=\ v2)\&\&(v2\ !=\ v3)\&\&(v1\ !=\ v3))\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \_triangles-\/>add\_vertices(v1,v3,v2);}
\DoxyCodeLine{00336\ \ \ \}}
\DoxyCodeLine{00337\ \ \ \textcolor{keywordflow}{if}\ ((v3\ !=\ v2)\&\&(v2\ !=\ v4)\&\&(v4\ !=\ v3))\ \{}
\DoxyCodeLine{00338\ \ \ \ \ \_triangles-\/>add\_vertices(v3,v4,v2);}
\DoxyCodeLine{00339\ \ \ \}}
\DoxyCodeLine{00340\ \}}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00351\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00352\ add\_quad(\textcolor{keywordtype}{int}\ v1,\ \textcolor{keywordtype}{int}\ v2,\ \textcolor{keywordtype}{int}\ v3,\ \textcolor{keywordtype}{int}\ v4)\ \{}
\DoxyCodeLine{00353\ \ \ add\_quad\_to\_strip(v1,\ v2,\ v3,\ v4);}
\DoxyCodeLine{00354\ \}}
\DoxyCodeLine{00355\ }
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00360\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00361\ open\_geom()\ \{}
\DoxyCodeLine{00362\ \ \ \_vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00363\ \ \ \ \ (\textcolor{stringliteral}{"{}heightfield"{}},\ GeomVertexFormat::get\_v3n3(),\ Geom::UH\_static);}
\DoxyCodeLine{00364\ \ \ \_vertex\_writer\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00365\ \ \ \_normal\_writer\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}(\_vdata,\ InternalName::get\_normal());}
\DoxyCodeLine{00366\ \ \ \_triangles\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTriangles}{GeomTriangles}}(Geom::UH\_static);}
\DoxyCodeLine{00367\ \ \ \_triangles-\/>set\_shade\_model(Geom::SM\_uniform);}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \ \ \_next\_index\ =\ 0;}
\DoxyCodeLine{00370\ \ \ \_last\_vertex\_a\ =\ -\/1;}
\DoxyCodeLine{00371\ \ \ \_last\_vertex\_b\ =\ -\/1;}
\DoxyCodeLine{00372\ \}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00377\ \textcolor{keywordtype}{void}\ HeightfieldTesselator::}
\DoxyCodeLine{00378\ close\_geom(\mbox{\hyperlink{classNodePath}{NodePath}}\ root)\ \{}
\DoxyCodeLine{00379\ \ \ \textcolor{keywordflow}{if}\ (\_triangles\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00380\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00381\ \ \ \}}
\DoxyCodeLine{00382\ \ \ \_triangles-\/>close\_primitive();}
\DoxyCodeLine{00383\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(\_vdata);}
\DoxyCodeLine{00384\ \ \ geom-\/>add\_primitive(\_triangles);}
\DoxyCodeLine{00385\ \ \ PT(\mbox{\hyperlink{classGeomNode}{GeomNode}})\ gnode\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(get\_name()\ +\ \textcolor{stringliteral}{"{}\ patch"{}});}
\DoxyCodeLine{00386\ \ \ gnode-\/>add\_geom(geom);}
\DoxyCodeLine{00387\ \ \ root.attach\_new\_node(gnode);}
\DoxyCodeLine{00388\ \ \ \textcolor{keyword}{delete}\ \_vertex\_writer;}
\DoxyCodeLine{00389\ \ \ \textcolor{keyword}{delete}\ \_normal\_writer;}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i=0;\ i<\_next\_index;\ i++)\ \{}
\DoxyCodeLine{00392\ \ \ \ \ \_vertex\_index[\_dirty\_vertices[i]]\ =\ -\/1;}
\DoxyCodeLine{00393\ \ \ \}}
\DoxyCodeLine{00394\ }
\DoxyCodeLine{00395\ \ \ \_next\_index\ =\ 0;}
\DoxyCodeLine{00396\ \ \ \_last\_vertex\_a\ =\ -\/1;}
\DoxyCodeLine{00397\ \ \ \_last\_vertex\_b\ =\ -\/1;}
\DoxyCodeLine{00398\ \ \ \_vertex\_writer\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00399\ \ \ \_normal\_writer\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00400\ \ \ \_triangles\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00401\ \}}

\end{DoxyCode}
