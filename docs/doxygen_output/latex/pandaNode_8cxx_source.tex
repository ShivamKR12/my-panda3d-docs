\doxysection{panda\+Node.\+cxx}
\hypertarget{pandaNode_8cxx_source}{}\label{pandaNode_8cxx_source}\index{panda/src/pgraph/pandaNode.cxx@{panda/src/pgraph/pandaNode.cxx}}
\mbox{\hyperlink{pandaNode_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pandaNode_8h}{pandaNode.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pgraph_8h}{config\_pgraph.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePathComponent_8h}{nodePathComponent.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{indent_8h}{indent.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geometricBoundingVolume_8h}{geometricBoundingVolume.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sceneGraphReducer_8h}{sceneGraphReducer.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{accumulatedAttribs_8h}{accumulatedAttribs.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clipPlaneAttrib_8h}{clipPlaneAttrib.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingBox_8h}{boundingBox.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__mathutil_8h}{config\_mathutil.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightReMutexHolder_8h}{lightReMutexHolder.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsStateGuardianBase_8h}{graphicsStateGuardianBase.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{decalEffect_8h}{decalEffect.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{showBoundsEffect_8h}{showBoundsEffect.h}}"{}}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00034\ \textcolor{keyword}{using\ }\mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}};}
\DoxyCodeLine{00035\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{comment}{//\ This\ category\ is\ just\ temporary\ for\ debugging\ convenience.}}
\DoxyCodeLine{00038\ NotifyCategoryDecl(drawmask,\ EXPCL\_PANDA\_PGRAPH,\ EXPTP\_PANDA\_PGRAPH);}
\DoxyCodeLine{00039\ NotifyCategoryDef(drawmask,\ \textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PandaNode::BamReaderAuxDataDown::\_type\_handle;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ PandaNode::SceneRootFunc\ *PandaNode::\_scene\_root\_func;}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ PandaNode::\_reset\_prev\_transform\_seq;}
\DoxyCodeLine{00046\ \mbox{\hyperlink{classBitMask}{DrawMask}}\ PandaNode::\_overall\_bit\ =\ DrawMask::bit(31);}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ PandaNode::\_update\_bounds\_pcollector(\textcolor{stringliteral}{"{}*:Bounds"{}});}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PandaNode::\_type\_handle;}
\DoxyCodeLine{00051\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PandaNode::CData::\_type\_handle;}
\DoxyCodeLine{00052\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PandaNodePipelineReader::\_type\_handle;}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{comment}{/*}}
\DoxyCodeLine{00055\ \textcolor{comment}{\ *\ There\ are\ two\ different\ interfaces\ here\ for\ making\ and\ breaking\ parent-\/}}
\DoxyCodeLine{00056\ \textcolor{comment}{\ *\ child\ connections:\ the\ fundamental\ PandaNode\ interface,\ via\ add\_child()\ and}}
\DoxyCodeLine{00057\ \textcolor{comment}{\ *\ remove\_child()\ (and\ related\ functions),\ and\ the\ NodePath\ support\ interface,}}
\DoxyCodeLine{00058\ \textcolor{comment}{\ *\ via\ attach(),\ detach(),\ and\ reparent().\ They\ both\ do\ essentially\ the\ same}}
\DoxyCodeLine{00059\ \textcolor{comment}{\ *\ thing,\ but\ with\ slightly\ different\ inputs.\ \ The\ PandaNode\ interfaces\ try\ to}}
\DoxyCodeLine{00060\ \textcolor{comment}{\ *\ guess\ which\ NodePaths\ should\ be\ updated\ as\ a\ result\ of\ the\ scene\ graph}}
\DoxyCodeLine{00061\ \textcolor{comment}{\ *\ change,\ while\ the\ NodePath\ interfaces\ already\ know.\ \ The\ NodePath\ support}}
\DoxyCodeLine{00062\ \textcolor{comment}{\ *\ interface\ functions\ are\ strictly\ called\ from\ within\ the\ NodePath\ class,\ and}}
\DoxyCodeLine{00063\ \textcolor{comment}{\ *\ are\ used\ to\ implement\ NodePath::reparent\_to()\ and\ NodePath::remove\_node(),}}
\DoxyCodeLine{00064\ \textcolor{comment}{\ *\ etc.\ \ The\ fundamental\ interface,\ on\ the\ other\ hand,\ is\ intended\ to\ be}}
\DoxyCodeLine{00065\ \textcolor{comment}{\ *\ called\ directly\ by\ the\ user.\ \ The\ fundamental\ interface\ has\ a\ slightly}}
\DoxyCodeLine{00066\ \textcolor{comment}{\ *\ lower\ overhead\ because\ it\ does\ not\ need\ to\ create\ a\ NodePathComponent\ chain}}
\DoxyCodeLine{00067\ \textcolor{comment}{\ *\ where\ one\ does\ not\ already\ exist;\ however,\ the\ NodePath\ support\ interface}}
\DoxyCodeLine{00068\ \textcolor{comment}{\ *\ is\ more\ useful\ when\ the\ NodePath\ already\ does\ exist,\ because\ it\ ensures}}
\DoxyCodeLine{00069\ \textcolor{comment}{\ *\ that\ the\ particular\ NodePath\ calling\ it\ is\ kept\ appropriately\ up-\/to-\/date.}}
\DoxyCodeLine{00070\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00076\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode::}}}
\DoxyCodeLine{00077\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\ :}
\DoxyCodeLine{00078\ \ \ \mbox{\hyperlink{classNamable}{Namable}}(name),}
\DoxyCodeLine{00079\ \ \ \_paths\_lock(\textcolor{stringliteral}{"{}PandaNode::\_paths\_lock"{}}),}
\DoxyCodeLine{00080\ \ \ \_prev\_transform\_valid(\_reset\_prev\_transform\_seq)}
\DoxyCodeLine{00081\ \{}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_debug())\ \{}
\DoxyCodeLine{00083\ \ \ \ \ pgraph\_cat.debug()}
\DoxyCodeLine{00084\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Constructing\ "{}}\ <<\ (\textcolor{keywordtype}{void}\ *)\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00085\ \ \ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#ifdef\ DO\_MEMORY\_USAGE}}
\DoxyCodeLine{00088\ \ \ MemoryUsage::update\_type(\textcolor{keyword}{this},\ \textcolor{keyword}{this});}
\DoxyCodeLine{00089\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00090\ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00095\ PandaNode::}
\DoxyCodeLine{00096\ \string~PandaNode()\ \{}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_debug())\ \{}
\DoxyCodeLine{00098\ \ \ \ \ pgraph\_cat.debug()}
\DoxyCodeLine{00099\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Destructing\ "{}}\ <<\ (\textcolor{keywordtype}{void}\ *)\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00100\ \ \ \}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \textcolor{comment}{//\ We\ shouldn't\ have\ any\ parents\ left\ by\ the\ time\ we\ destruct,\ or\ there's\ a}}
\DoxyCodeLine{00103\ \ \ \textcolor{comment}{//\ refcount\ fault\ somewhere.}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//\ Actually,\ that's\ not\ necessarily\ true\ anymore,\ since\ we\ might\ be\ updating}}
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//\ a\ node\ dynamically\ via\ the\ bam\ reader,\ which\ doesn't\ necessarily\ keep}}
\DoxyCodeLine{00107\ \ \ \textcolor{comment}{//\ related\ pairs\ of\ nodes\ in\ sync\ with\ each\ other.}}
\DoxyCodeLine{00108\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00109\ \textcolor{comment}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00110\ \textcolor{comment}{\ \ \{}}
\DoxyCodeLine{00111\ \textcolor{comment}{\ \ \ \ CDReader\ cdata(\_cycler);}}
\DoxyCodeLine{00112\ \textcolor{comment}{\ \ \ \ nassertv(cdata-\/>get\_up()-\/>empty());}}
\DoxyCodeLine{00113\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00114\ \textcolor{comment}{\#endif\ \ //\ NDEBUG}}
\DoxyCodeLine{00115\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \mbox{\hyperlink{classPandaNode_a449ebdf8285bc42bb62c7fd1afe8ef7a}{remove\_all\_children}}();}
\DoxyCodeLine{00118\ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00124\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode::}}}
\DoxyCodeLine{00125\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ \&copy)\ :}
\DoxyCodeLine{00126\ \ \ \mbox{\hyperlink{classTypedWritableReferenceCount}{TypedWritableReferenceCount}}(copy),}
\DoxyCodeLine{00127\ \ \ \mbox{\hyperlink{classNamable}{Namable}}(copy),}
\DoxyCodeLine{00128\ \ \ \_paths\_lock(\textcolor{stringliteral}{"{}PandaNode::\_paths\_lock"{}}),}
\DoxyCodeLine{00129\ \ \ \_prev\_transform\_valid(\_reset\_prev\_transform\_seq),}
\DoxyCodeLine{00130\ \ \ \_python\_tag\_data(copy.\_python\_tag\_data),}
\DoxyCodeLine{00131\ \ \ \_unexpected\_change\_flags(0)}
\DoxyCodeLine{00132\ \{}
\DoxyCodeLine{00133\ \ \ \textcolor{keywordflow}{if}\ (pgraph\_cat.is\_debug())\ \{}
\DoxyCodeLine{00134\ \ \ \ \ pgraph\_cat.debug()}
\DoxyCodeLine{00135\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Copying\ "{}}\ <<\ (\textcolor{keywordtype}{void}\ *)\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00136\ \ \ \}}
\DoxyCodeLine{00137\ \textcolor{preprocessor}{\#ifdef\ DO\_MEMORY\_USAGE}}
\DoxyCodeLine{00138\ \ \ MemoryUsage::update\_type(\textcolor{keyword}{this},\ \textcolor{keyword}{this});}
\DoxyCodeLine{00139\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \textcolor{comment}{//\ Copy\ the\ other\ node's\ state.}}
\DoxyCodeLine{00142\ \ \ \{}
\DoxyCodeLine{00143\ \ \ \ \ CDReader\ copy\_cdata(copy.\_cycler);}
\DoxyCodeLine{00144\ \ \ \ \ CDWriter\ cdata(\_cycler,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00145\ \ \ \ \ cdata-\/>\_state\ =\ copy\_cdata-\/>\_state;}
\DoxyCodeLine{00146\ \ \ \ \ cdata-\/>\_transform\ =\ copy\_cdata-\/>\_transform;}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordflow}{if}\ (copy.\_prev\_transform\_valid\ ==\ \_reset\_prev\_transform\_seq)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ cdata-\/>\_prev\_transform\ =\ copy\_cdata-\/>\_prev\_transform;}
\DoxyCodeLine{00149\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ cdata-\/>\_prev\_transform\ =\ copy\_cdata-\/>\_transform;}
\DoxyCodeLine{00151\ \ \ \ \ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ cdata-\/>\_effects\ =\ copy\_cdata-\/>\_effects;}
\DoxyCodeLine{00154\ \ \ \ \ cdata-\/>\_tag\_data\ =\ copy\_cdata-\/>\_tag\_data;}
\DoxyCodeLine{00155\ \ \ \ \ cdata-\/>\_draw\_control\_mask\ =\ copy\_cdata-\/>\_draw\_control\_mask;}
\DoxyCodeLine{00156\ \ \ \ \ cdata-\/>\_draw\_show\_mask\ =\ copy\_cdata-\/>\_draw\_show\_mask;}
\DoxyCodeLine{00157\ \ \ \ \ cdata-\/>\_into\_collide\_mask\ =\ copy\_cdata-\/>\_into\_collide\_mask;}
\DoxyCodeLine{00158\ \ \ \ \ cdata-\/>\_bounds\_type\ =\ copy\_cdata-\/>\_bounds\_type;}
\DoxyCodeLine{00159\ \ \ \ \ cdata-\/>\_user\_bounds\ =\ copy\_cdata-\/>\_user\_bounds;}
\DoxyCodeLine{00160\ \ \ \ \ cdata-\/>\_internal\_bounds\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00161\ \ \ \ \ cdata-\/>\_internal\_bounds\_computed\ =\ UpdateSeq::initial();}
\DoxyCodeLine{00162\ \ \ \ \ cdata-\/>\_internal\_bounds\_mark\ =\ UpdateSeq::initial();}
\DoxyCodeLine{00163\ \ \ \ \ ++cdata-\/>\_internal\_bounds\_mark;}
\DoxyCodeLine{00164\ \ \ \ \ cdata-\/>\_final\_bounds\ =\ copy\_cdata-\/>\_final\_bounds;}
\DoxyCodeLine{00165\ \ \ \ \ cdata-\/>\_fancy\_bits\ =\ copy\_cdata-\/>\_fancy\_bits;}
\DoxyCodeLine{00166\ \ \ \}}
\DoxyCodeLine{00167\ \}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00176\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classPandaNode_a9c0d18fed0dc09fb13fb3842d7e0eb31}{PandaNode::}}}
\DoxyCodeLine{00177\ \mbox{\hyperlink{classPandaNode_a9c0d18fed0dc09fb13fb3842d7e0eb31}{dupe\_for\_flatten}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00178\ \ \ \textcolor{keywordflow}{return}\ make\_copy();}
\DoxyCodeLine{00179\ \}}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00187\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_afda3fef14d2f8b91310bcc5ecd0a54a3}{PandaNode::}}}
\DoxyCodeLine{00188\ \mbox{\hyperlink{classPandaNode_afda3fef14d2f8b91310bcc5ecd0a54a3}{safe\_to\_flatten}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00196\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a2b2fa8fec37063e403fa89e20cb0cbfe}{PandaNode::}}}
\DoxyCodeLine{00197\ \mbox{\hyperlink{classPandaNode_a2b2fa8fec37063e403fa89e20cb0cbfe}{safe\_to\_transform}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00198\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00199\ \}}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00209\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a5705b8b7a0dd064fc222d668c55dc52b}{PandaNode::}}}
\DoxyCodeLine{00210\ \mbox{\hyperlink{classPandaNode_a5705b8b7a0dd064fc222d668c55dc52b}{safe\_to\_modify\_transform}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00211\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00212\ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00220\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a2453a75c816eb34071dd72c1f194c610}{PandaNode::}}}
\DoxyCodeLine{00221\ \mbox{\hyperlink{classPandaNode_a2453a75c816eb34071dd72c1f194c610}{safe\_to\_combine}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00223\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00230\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a53cb12da0c53f0254462106b50068d49}{PandaNode::}}}
\DoxyCodeLine{00231\ \mbox{\hyperlink{classPandaNode_a53cb12da0c53f0254462106b50068d49}{safe\_to\_combine\_children}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00232\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00233\ \}}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00239\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a9a4423018e1a2151b5d65cae88f109eb}{PandaNode::}}}
\DoxyCodeLine{00240\ \mbox{\hyperlink{classPandaNode_a9a4423018e1a2151b5d65cae88f109eb}{safe\_to\_flatten\_below}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00241\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00242\ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00248\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a0b5c708b788df52184bc5acc5918fc7f}{PandaNode::}}}
\DoxyCodeLine{00249\ \mbox{\hyperlink{classPandaNode_a0b5c708b788df52184bc5acc5918fc7f}{preserve\_name}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00250\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00251\ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00260\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPandaNode_a27ed81e4f9ad8a36cadf06929679f847}{PandaNode::}}}
\DoxyCodeLine{00261\ \mbox{\hyperlink{classPandaNode_a27ed81e4f9ad8a36cadf06929679f847}{get\_unsafe\_to\_apply\_attribs}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00262\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00263\ \}}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00274\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aa5171708383a7197cf178ffd2cdb1048}{PandaNode::}}}
\DoxyCodeLine{00275\ \mbox{\hyperlink{classPandaNode_aa5171708383a7197cf178ffd2cdb1048}{apply\_attribs\_to\_vertices}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classAccumulatedAttribs}{AccumulatedAttribs}}\ \&attribs,\ \textcolor{keywordtype}{int}\ attrib\_types,}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ \&transformer)\ \{}
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{if}\ ((attrib\_types\ \&\ SceneGraphReducer::TT\_transform)\ !=\ 0)\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&mat\ =\ attribs.\_transform-\/>get\_mat();}
\DoxyCodeLine{00279\ \ \ \ \ \mbox{\hyperlink{classPandaNode_a84965804b720a9d5c7eef0f80ae75aff}{xform}}(mat);}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00282\ \ \ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00284\ \ \ \ \ \ \ cdata-\/>\_effects\ =\ cdata-\/>\_effects-\/>xform(mat);}
\DoxyCodeLine{00285\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_effects,\ !cdata-\/>\_effects-\/>is\_empty());}
\DoxyCodeLine{00286\ \ \ \ \ \}}
\DoxyCodeLine{00287\ \ \ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00288\ \ \ \}}
\DoxyCodeLine{00289\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00290\ \}}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00296\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a84965804b720a9d5c7eef0f80ae75aff}{PandaNode::}}}
\DoxyCodeLine{00297\ \mbox{\hyperlink{classPandaNode_a84965804b720a9d5c7eef0f80ae75aff}{xform}}(\textcolor{keyword}{const}\ LMatrix4\ \&)\ \{}
\DoxyCodeLine{00298\ \}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00311\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *PandaNode::}
\DoxyCodeLine{00312\ combine\_with(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{00313\ \ \ \textcolor{comment}{//\ An\ unadorned\ PandaNode\ always\ combines\ with\ any\ other\ PandaNodes\ by}}
\DoxyCodeLine{00314\ \ \ \textcolor{comment}{//\ yielding\ completely.\ \ However,\ if\ we\ are\ actually\ some\ fancy\ PandaNode}}
\DoxyCodeLine{00315\ \ \ \textcolor{comment}{//\ type\ that\ derives\ from\ PandaNode\ but\ didn't\ redefine\ this\ function,\ we}}
\DoxyCodeLine{00316\ \ \ \textcolor{comment}{//\ should\ refuse\ to\ combine.}}
\DoxyCodeLine{00317\ \ \ \textcolor{keywordflow}{if}\ (is\_exact\_type(get\_class\_type()))\ \{}
\DoxyCodeLine{00318\ \ \ \ \ \textcolor{comment}{//\ No,\ we're\ an\ ordinary\ PandaNode.}}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keywordflow}{return}\ other;}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (other-\/>is\_exact\_type(get\_class\_type()))\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \textcolor{comment}{//\ We're\ not\ an\ ordinary\ PandaNode,\ but\ the\ other\ one\ is.}}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00324\ \ \ \}}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00326\ \ \ \textcolor{comment}{//\ We're\ something\ other\ than\ an\ ordinary\ PandaNode.\ \ Don't\ combine.}}
\DoxyCodeLine{00327\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00328\ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00344\ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ PandaNode::}
\DoxyCodeLine{00345\ calc\_tight\_bounds(LPoint3\ \&min\_point,\ LPoint3\ \&max\_point,\ \textcolor{keywordtype}{bool}\ \&found\_any,}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00347\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ next\_transform\ =\ transform-\/>compose(get\_transform());}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ Children\ cr\ =\ get\_children(current\_thread);}
\DoxyCodeLine{00350\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ cr.get\_num\_children();}
\DoxyCodeLine{00351\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ cr.get\_child(i)-\/>calc\_tight\_bounds(min\_point,\ max\_point,}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ found\_any,\ next\_transform,}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00355\ \ \ \}}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \textcolor{keywordflow}{return}\ next\_transform;}
\DoxyCodeLine{00358\ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00378\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{00379\ cull\_callback(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&)\ \{}
\DoxyCodeLine{00380\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00381\ \}}
\DoxyCodeLine{00382\ }
\DoxyCodeLine{00394\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a2413e0a016c8a6d5b208f37e6dbd78c4}{PandaNode::}}}
\DoxyCodeLine{00395\ \mbox{\hyperlink{classPandaNode_a2413e0a016c8a6d5b208f37e6dbd78c4}{has\_single\_child\_visibility}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00396\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00397\ \}}
\DoxyCodeLine{00398\ }
\DoxyCodeLine{00403\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPandaNode_a28d19405e8610fc317f58b17f20d6c2a}{PandaNode::}}}
\DoxyCodeLine{00404\ \mbox{\hyperlink{classPandaNode_a28d19405e8610fc317f58b17f20d6c2a}{get\_visible\_child}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00405\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00406\ \}}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00414\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a9a49139388783a2d66434f9a651e9ec4}{PandaNode::}}}
\DoxyCodeLine{00415\ \mbox{\hyperlink{classPandaNode_a9a49139388783a2d66434f9a651e9ec4}{is\_renderable}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00416\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00417\ \ \ \textcolor{keywordflow}{return}\ (cdata-\/>\_fancy\_bits\ \&\ FB\_renderable)\ !=\ 0;}
\DoxyCodeLine{00418\ \}}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00425\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ad3427554990bacc142d67e947334226d}{PandaNode::}}}
\DoxyCodeLine{00426\ \mbox{\hyperlink{classPandaNode_ad3427554990bacc142d67e947334226d}{add\_for\_draw}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&)\ \{}
\DoxyCodeLine{00427\ \}}
\DoxyCodeLine{00428\ }
\DoxyCodeLine{00434\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *PandaNode::}
\DoxyCodeLine{00435\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00436\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00437\ \}}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00445\ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ PandaNode::}
\DoxyCodeLine{00446\ copy\_subgraph(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00447\ \ \ InstanceMap\ inst\_map;}
\DoxyCodeLine{00448\ \ \ \textcolor{keywordflow}{return}\ r\_copy\_subgraph(inst\_map,\ current\_thread);}
\DoxyCodeLine{00449\ \}}
\DoxyCodeLine{00450\ }
\DoxyCodeLine{00454\ \textcolor{keywordtype}{int}\ PandaNode::}
\DoxyCodeLine{00455\ count\_num\_descendants()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00456\ \ \ \textcolor{keywordtype}{int}\ count\ =\ 1;}
\DoxyCodeLine{00457\ \ \ Children\ children\ =\ get\_children();}
\DoxyCodeLine{00458\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ children.get\_num\_children();}
\DoxyCodeLine{00459\ }
\DoxyCodeLine{00460\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ ++i)\ \{}
\DoxyCodeLine{00461\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ children.get\_child(i);}
\DoxyCodeLine{00462\ \ \ \ \ count\ +=\ child-\/>count\_num\_descendants();}
\DoxyCodeLine{00463\ \ \ \}}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00465\ \ \ \textcolor{keywordflow}{return}\ count;}
\DoxyCodeLine{00466\ \}}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00476\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{00477\ add\_child(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{int}\ sort,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00478\ \ \ nassertv(child\_node\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00479\ }
\DoxyCodeLine{00480\ \ \ \textcolor{keywordflow}{if}\ (!verify\_child\_no\_cycles(child\_node))\ \{}
\DoxyCodeLine{00481\ \ \ \ \ \textcolor{comment}{//\ Whoops,\ adding\ this\ child\ node\ would\ introduce\ a\ cycle\ in\ the\ scene}}
\DoxyCodeLine{00482\ \ \ \ \ \textcolor{comment}{//\ graph.}}
\DoxyCodeLine{00483\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00484\ \ \ \}}
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \ \ \textcolor{comment}{//\ Ensure\ the\ child\_node\ is\ not\ deleted\ while\ we\ do\ this.}}
\DoxyCodeLine{00487\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_child\ =\ child\_node;}
\DoxyCodeLine{00488\ \ \ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(child\_node);}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{00491\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{00492\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00493\ \ \ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00494\ \ \ \ \ CDStageWriter\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00496\ \ \ \ \ cdata-\/>modify\_down()-\/>insert(DownConnection(child\_node,\ sort));}
\DoxyCodeLine{00497\ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00498\ \ \ \}}
\DoxyCodeLine{00499\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00500\ }
\DoxyCodeLine{00501\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00502\ \ \ \ \ new\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00503\ \ \ \}}
\DoxyCodeLine{00504\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler);}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}();}
\DoxyCodeLine{00507\ }
\DoxyCodeLine{00508\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00509\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00510\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00511\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00512\ \}}
\DoxyCodeLine{00513\ }
\DoxyCodeLine{00517\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{PandaNode::}}}
\DoxyCodeLine{00518\ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(\textcolor{keywordtype}{int}\ child\_index,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00519\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00520\ \ \ nassertv(pipeline\_stage\ ==\ 0);}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00523\ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj1}{Down}})\ down\ =\ cdata-\/>modify\_down();}
\DoxyCodeLine{00524\ \ \ nassertv(child\_index\ >=\ 0\ \&\&\ child\_index\ <\ (\textcolor{keywordtype}{int})down-\/>size());}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ (*down)[child\_index].get\_child();}
\DoxyCodeLine{00527\ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00529\ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj1}{Up}})\ up\ =\ cdata\_child-\/>modify\_up();}
\DoxyCodeLine{00530\ }
\DoxyCodeLine{00531\ \ \ down-\/>erase(down-\/>begin()\ +\ child\_index);}
\DoxyCodeLine{00532\ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ up-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00533\ \ \ nassertv(num\_erased\ ==\ 1);}
\DoxyCodeLine{00534\ }
\DoxyCodeLine{00535\ \ \ sever\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00536\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00537\ }
\DoxyCodeLine{00538\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00539\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00540\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00541\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00542\ \}}
\DoxyCodeLine{00543\ }
\DoxyCodeLine{00549\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{PandaNode::}}}
\DoxyCodeLine{00550\ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00551\ \ \ nassertr(child\_node\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00552\ }
\DoxyCodeLine{00553\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ child\ node\ is\ not\ destructed\ during\ the\ execution\ of\ this}}
\DoxyCodeLine{00554\ \ \ \textcolor{comment}{//\ method.}}
\DoxyCodeLine{00555\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_child\ =\ child\_node;}
\DoxyCodeLine{00556\ }
\DoxyCodeLine{00557\ \ \ \textcolor{comment}{//\ We\ have\ to\ do\ this\ for\ each\ upstream\ pipeline\ stage.}}
\DoxyCodeLine{00558\ \ \ \textcolor{keywordtype}{bool}\ any\_removed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00559\ }
\DoxyCodeLine{00560\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00561\ \ \ \ \ \textcolor{keywordflow}{if}\ (stage\_remove\_child(child\_node,\ pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{00562\ \ \ \ \ \ \ any\_removed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \ \ \ \ \ \ sever\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00566\ \ \ \ \ \}}
\DoxyCodeLine{00567\ \ \ \}}
\DoxyCodeLine{00568\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler);}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ \textcolor{keywordflow}{if}\ (any\_removed)\ \{}
\DoxyCodeLine{00571\ \ \ \ \ \textcolor{comment}{//\ Call\ callback\ hooks.}}
\DoxyCodeLine{00572\ \ \ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00573\ \ \ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00574\ \ \ \}}
\DoxyCodeLine{00575\ }
\DoxyCodeLine{00576\ \ \ \textcolor{keywordflow}{return}\ any\_removed;}
\DoxyCodeLine{00577\ \}}
\DoxyCodeLine{00578\ }
\DoxyCodeLine{00585\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a0db5cac63970ca4710013ace782db67f}{PandaNode::}}}
\DoxyCodeLine{00586\ \mbox{\hyperlink{classPandaNode_a0db5cac63970ca4710013ace782db67f}{replace\_child}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *orig\_child,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *new\_child,}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00588\ \ \ nassertr(orig\_child\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00589\ \ \ nassertr(new\_child\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \ \ \textcolor{keywordflow}{if}\ (orig\_child\ ==\ new\_child)\ \{}
\DoxyCodeLine{00592\ \ \ \ \ \textcolor{comment}{//\ Trivial\ no-\/op.}}
\DoxyCodeLine{00593\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00594\ \ \ \}}
\DoxyCodeLine{00595\ }
\DoxyCodeLine{00596\ \ \ \textcolor{keywordflow}{if}\ (!verify\_child\_no\_cycles(new\_child))\ \{}
\DoxyCodeLine{00597\ \ \ \ \ \textcolor{comment}{//\ Whoops,\ adding\ this\ child\ node\ would\ introduce\ a\ cycle\ in\ the\ scene}}
\DoxyCodeLine{00598\ \ \ \ \ \textcolor{comment}{//\ graph.}}
\DoxyCodeLine{00599\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00600\ \ \ \}}
\DoxyCodeLine{00601\ }
\DoxyCodeLine{00602\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ orig\_child\ node\ is\ not\ destructed\ during\ the\ execution\ of}}
\DoxyCodeLine{00603\ \ \ \textcolor{comment}{//\ this\ method.}}
\DoxyCodeLine{00604\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_orig\_child\ =\ orig\_child;}
\DoxyCodeLine{00605\ }
\DoxyCodeLine{00606\ \ \ \textcolor{comment}{//\ We\ have\ to\ do\ this\ for\ each\ upstream\ pipeline\ stage.}}
\DoxyCodeLine{00607\ \ \ \textcolor{keywordtype}{bool}\ any\_replaced\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00608\ }
\DoxyCodeLine{00609\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00610\ \ \ \ \ \textcolor{keywordflow}{if}\ (stage\_replace\_child(orig\_child,\ new\_child,\ pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{00611\ \ \ \ \ \ \ any\_replaced\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00612\ \ \ \ \ \}}
\DoxyCodeLine{00613\ \ \ \}}
\DoxyCodeLine{00614\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00615\ }
\DoxyCodeLine{00616\ \ \ \textcolor{keywordflow}{if}\ (any\_replaced)\ \{}
\DoxyCodeLine{00617\ \ \ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00618\ \ \ \ \ orig\_child-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00619\ \ \ \ \ new\_child-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00620\ \ \ \}}
\DoxyCodeLine{00621\ }
\DoxyCodeLine{00622\ \ \ \textcolor{keywordflow}{return}\ any\_replaced;}
\DoxyCodeLine{00623\ \}}
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00625\ }
\DoxyCodeLine{00635\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{00636\ stash\_child(\textcolor{keywordtype}{int}\ child\_index,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00637\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00638\ \ \ nassertv(pipeline\_stage\ ==\ 0);}
\DoxyCodeLine{00639\ \ \ nassertv(child\_index\ >=\ 0\ \&\&\ child\_index\ <\ get\_num\_children());}
\DoxyCodeLine{00640\ }
\DoxyCodeLine{00641\ \ \ \textcolor{comment}{//\ Save\ a\ reference\ count\ for\ ourselves.}}
\DoxyCodeLine{00642\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ self\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ get\_child(child\_index);}
\DoxyCodeLine{00645\ \ \ \textcolor{keywordtype}{int}\ sort\ =\ get\_child\_sort(child\_index);}
\DoxyCodeLine{00646\ }
\DoxyCodeLine{00647\ \ \ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(child\_index);}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \ \ \{}
\DoxyCodeLine{00650\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00651\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00652\ }
\DoxyCodeLine{00653\ \ \ \ \ cdata-\/>modify\_stashed()-\/>insert(\mbox{\hyperlink{classPandaNode_1_1DownConnection}{DownConnection}}(child\_node,\ sort));}
\DoxyCodeLine{00654\ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00655\ \ \ \}}
\DoxyCodeLine{00656\ }
\DoxyCodeLine{00657\ \ \ new\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00658\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00661\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00662\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00663\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00664\ \}}
\DoxyCodeLine{00665\ }
\DoxyCodeLine{00675\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{00676\ unstash\_child(\textcolor{keywordtype}{int}\ stashed\_index,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00677\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00678\ \ \ nassertv(pipeline\_stage\ ==\ 0);}
\DoxyCodeLine{00679\ \ \ nassertv(stashed\_index\ >=\ 0\ \&\&\ stashed\_index\ <\ get\_num\_stashed());}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \ \ \textcolor{comment}{//\ Save\ a\ reference\ count\ for\ ourselves.\ \ I\ don't\ think\ this\ should\ be}}
\DoxyCodeLine{00682\ \ \ \textcolor{comment}{//\ necessary,\ but\ there\ are\ occasional\ crashes\ in\ stash()\ during\ furniture}}
\DoxyCodeLine{00683\ \ \ \textcolor{comment}{//\ moving\ mode.\ \ Perhaps\ this\ will\ eliminate\ those\ crashes.}}
\DoxyCodeLine{00684\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ self\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00685\ }
\DoxyCodeLine{00686\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ get\_stashed(stashed\_index);}
\DoxyCodeLine{00687\ \ \ \textcolor{keywordtype}{int}\ sort\ =\ get\_stashed\_sort(stashed\_index);}
\DoxyCodeLine{00688\ }
\DoxyCodeLine{00689\ \ \ \mbox{\hyperlink{classPandaNode_a5c4b1c6cbc75ea4c319ca845d2ba3bf4}{remove\_stashed}}(stashed\_index);}
\DoxyCodeLine{00690\ }
\DoxyCodeLine{00691\ \ \ \{}
\DoxyCodeLine{00692\ \ \ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler);}
\DoxyCodeLine{00693\ \ \ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata\_child(child\_node-\/>\_cycler);}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00695\ \ \ \ \ cdata-\/>modify\_down()-\/>insert(\mbox{\hyperlink{classPandaNode_1_1DownConnection}{DownConnection}}(child\_node,\ sort));}
\DoxyCodeLine{00696\ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00697\ \ \ \}}
\DoxyCodeLine{00698\ }
\DoxyCodeLine{00699\ \ \ new\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00700\ }
\DoxyCodeLine{00701\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}();}
\DoxyCodeLine{00702\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00703\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00704\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00705\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00706\ \}}
\DoxyCodeLine{00707\ }
\DoxyCodeLine{00718\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ab1a83b397261883f5fd69bfb744360df}{PandaNode::}}}
\DoxyCodeLine{00719\ \mbox{\hyperlink{classPandaNode_ab1a83b397261883f5fd69bfb744360df}{add\_stashed}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{int}\ sort,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00720\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00721\ \ \ nassertv(pipeline\_stage\ ==\ 0);}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00723\ \ \ \textcolor{keywordflow}{if}\ (!verify\_child\_no\_cycles(child\_node))\ \{}
\DoxyCodeLine{00724\ \ \ \ \ \textcolor{comment}{//\ Whoops,\ adding\ this\ child\ node\ would\ introduce\ a\ cycle\ in\ the\ scene}}
\DoxyCodeLine{00725\ \ \ \ \ \textcolor{comment}{//\ graph.}}
\DoxyCodeLine{00726\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00727\ \ \ \}}
\DoxyCodeLine{00728\ }
\DoxyCodeLine{00729\ \ \ \textcolor{comment}{//\ Ensure\ the\ child\_node\ is\ not\ deleted\ while\ we\ do\ this.}}
\DoxyCodeLine{00730\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_child\ =\ child\_node;}
\DoxyCodeLine{00731\ \ \ \mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(child\_node);}
\DoxyCodeLine{00732\ }
\DoxyCodeLine{00733\ \ \ \{}
\DoxyCodeLine{00734\ \ \ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata(\_cycler);}
\DoxyCodeLine{00735\ \ \ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata\_child(child\_node-\/>\_cycler);}
\DoxyCodeLine{00736\ }
\DoxyCodeLine{00737\ \ \ \ \ cdata-\/>modify\_stashed()-\/>insert(\mbox{\hyperlink{classPandaNode_1_1DownConnection}{DownConnection}}(child\_node,\ sort));}
\DoxyCodeLine{00738\ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00739\ \ \ \}}
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \ \ new\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00742\ }
\DoxyCodeLine{00743\ \ \ \textcolor{comment}{//\ Call\ callback\ hooks.}}
\DoxyCodeLine{00744\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00745\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00746\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00747\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00748\ \}}
\DoxyCodeLine{00749\ }
\DoxyCodeLine{00753\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a5c4b1c6cbc75ea4c319ca845d2ba3bf4}{PandaNode::}}}
\DoxyCodeLine{00754\ \mbox{\hyperlink{classPandaNode_a5c4b1c6cbc75ea4c319ca845d2ba3bf4}{remove\_stashed}}(\textcolor{keywordtype}{int}\ child\_index,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00755\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{00756\ \ \ nassertv(pipeline\_stage\ ==\ 0);}
\DoxyCodeLine{00757\ }
\DoxyCodeLine{00758\ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00759\ \ \ \mbox{\hyperlink{classCopyOnWriteObj1}{Down}}\ \&stashed\ =\ *cdata-\/>modify\_stashed();}
\DoxyCodeLine{00760\ \ \ nassertv(child\_index\ >=\ 0\ \&\&\ child\_index\ <\ (\textcolor{keywordtype}{int})stashed.size());}
\DoxyCodeLine{00761\ }
\DoxyCodeLine{00762\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ stashed[child\_index].get\_child();}
\DoxyCodeLine{00763\ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00764\ }
\DoxyCodeLine{00765\ \ \ stashed.erase(stashed.begin()\ +\ child\_index);}
\DoxyCodeLine{00766\ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00767\ \ \ nassertv(num\_erased\ ==\ 1);}
\DoxyCodeLine{00768\ }
\DoxyCodeLine{00769\ \ \ sever\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00770\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00771\ }
\DoxyCodeLine{00772\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00773\ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00774\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00775\ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00776\ \}}
\DoxyCodeLine{00777\ }
\DoxyCodeLine{00783\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a449ebdf8285bc42bb62c7fd1afe8ef7a}{PandaNode::}}}
\DoxyCodeLine{00784\ \mbox{\hyperlink{classPandaNode_a449ebdf8285bc42bb62c7fd1afe8ef7a}{remove\_all\_children}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00785\ \ \ \textcolor{comment}{//\ We\ have\ to\ do\ this\ for\ each\ upstream\ pipeline\ stage.}}
\DoxyCodeLine{00786\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00787\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00788\ \ \ \ \ PT(\mbox{\hyperlink{classCopyOnWriteObj1}{Down}})\ down\ =\ cdata-\/>modify\_down();}
\DoxyCodeLine{00789\ \ \ \ \ Down::iterator\ di;}
\DoxyCodeLine{00790\ \ \ \ \ \textcolor{keywordflow}{for}\ (di\ =\ down-\/>begin();\ di\ !=\ down-\/>end();\ ++di)\ \{}
\DoxyCodeLine{00791\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ (*di).get\_child();}
\DoxyCodeLine{00792\ \ \ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,}
\DoxyCodeLine{00793\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00794\ \ \ \ \ \ \ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00795\ }
\DoxyCodeLine{00796\ \ \ \ \ \ \ sever\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00797\ \ \ \ \ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00798\ \ \ \ \ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00799\ \ \ \ \ \}}
\DoxyCodeLine{00800\ \ \ \ \ down-\/>clear();}
\DoxyCodeLine{00801\ }
\DoxyCodeLine{00802\ \ \ \ \ \mbox{\hyperlink{classCopyOnWriteObj1}{Down}}\ \&stashed\ =\ *cdata-\/>modify\_stashed();}
\DoxyCodeLine{00803\ \ \ \ \ \textcolor{keywordflow}{for}\ (di\ =\ stashed.begin();\ di\ !=\ stashed.end();\ ++di)\ \{}
\DoxyCodeLine{00804\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ (*di).get\_child();}
\DoxyCodeLine{00805\ \ \ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,}
\DoxyCodeLine{00806\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{00807\ \ \ \ \ \ \ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{00808\ }
\DoxyCodeLine{00809\ \ \ \ \ \ \ sever\_connection(\textcolor{keyword}{this},\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00810\ \ \ \ \ \ \ child\_node-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{00811\ \ \ \ \ \ \ child\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{00812\ \ \ \ \ \}}
\DoxyCodeLine{00813\ \ \ \ \ stashed.clear();}
\DoxyCodeLine{00814\ \ \ \}}
\DoxyCodeLine{00815\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00816\ }
\DoxyCodeLine{00817\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}();}
\DoxyCodeLine{00818\ \ \ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{00819\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00820\ \}}
\DoxyCodeLine{00821\ }
\DoxyCodeLine{00828\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aec337c4ec3d2b93800935311e0dc4ca3}{PandaNode::}}}
\DoxyCodeLine{00829\ \mbox{\hyperlink{classPandaNode_aec337c4ec3d2b93800935311e0dc4ca3}{steal\_children}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00830\ \ \ \textcolor{keywordflow}{if}\ (other\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00831\ \ \ \ \ \textcolor{comment}{//\ Trivial.}}
\DoxyCodeLine{00832\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00833\ \ \ \}}
\DoxyCodeLine{00834\ }
\DoxyCodeLine{00835\ \ \ \textcolor{comment}{//\ We\ do\ this\ through\ the\ high-\/level\ interface\ for\ convenience.\ \ This\ could}}
\DoxyCodeLine{00836\ \ \ \textcolor{comment}{//\ begin\ to\ be\ a\ problem\ if\ we\ have\ a\ node\ with\ hundreds\ of\ children\ to}}
\DoxyCodeLine{00837\ \ \ \textcolor{comment}{//\ copy;\ this\ could\ break\ down\ the\ ov\_set.insert()\ method,\ which\ is\ an}}
\DoxyCodeLine{00838\ \ \ \textcolor{comment}{//\ O(n\string^2)\ operation.\ \ If\ this\ happens,\ we\ should\ rewrite\ this\ to\ do\ a}}
\DoxyCodeLine{00839\ \ \ \textcolor{comment}{//\ simpler\ add\_child()\ operation\ that\ involves\ push\_back()\ instead\ of}}
\DoxyCodeLine{00840\ \ \ \textcolor{comment}{//\ insert(),\ and\ then\ sort\ the\ down\ list\ at\ the\ end.}}
\DoxyCodeLine{00841\ }
\DoxyCodeLine{00842\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ other-\/>get\_num\_children();}
\DoxyCodeLine{00843\ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00844\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00845\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ other-\/>get\_child(i);}
\DoxyCodeLine{00846\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ other-\/>get\_child\_sort(i);}
\DoxyCodeLine{00847\ \ \ \ \ add\_child(child\_node,\ sort,\ current\_thread);}
\DoxyCodeLine{00848\ \ \ \}}
\DoxyCodeLine{00849\ \ \ \textcolor{keywordtype}{int}\ num\_stashed\ =\ other-\/>get\_num\_stashed();}
\DoxyCodeLine{00850\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_stashed;\ i++)\ \{}
\DoxyCodeLine{00851\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ other-\/>get\_stashed(i);}
\DoxyCodeLine{00852\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ other-\/>get\_stashed\_sort(i);}
\DoxyCodeLine{00853\ \ \ \ \ \mbox{\hyperlink{classPandaNode_ab1a83b397261883f5fd69bfb744360df}{add\_stashed}}(child\_node,\ sort,\ current\_thread);}
\DoxyCodeLine{00854\ \ \ \}}
\DoxyCodeLine{00855\ }
\DoxyCodeLine{00856\ \ \ other-\/>\mbox{\hyperlink{classPandaNode_a449ebdf8285bc42bb62c7fd1afe8ef7a}{remove\_all\_children}}(current\_thread);}
\DoxyCodeLine{00857\ \}}
\DoxyCodeLine{00858\ }
\DoxyCodeLine{00863\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a00c67be81f15ca0f6d11f3ac1bf1fbb5}{PandaNode::}}}
\DoxyCodeLine{00864\ \mbox{\hyperlink{classPandaNode_a00c67be81f15ca0f6d11f3ac1bf1fbb5}{copy\_children}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{00865\ \ \ \textcolor{keywordflow}{if}\ (other\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00866\ \ \ \ \ \textcolor{comment}{//\ Trivial.}}
\DoxyCodeLine{00867\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00868\ \ \ \}}
\DoxyCodeLine{00869\ \ \ Children\ children\ =\ other-\/>get\_children(current\_thread);}
\DoxyCodeLine{00870\ \ \ Stashed\ stashed\ =\ other-\/>get\_stashed(current\_thread);}
\DoxyCodeLine{00871\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ children.get\_num\_children();}
\DoxyCodeLine{00872\ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{00873\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00874\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ children.get\_child(i);}
\DoxyCodeLine{00875\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ children.get\_child\_sort(i);}
\DoxyCodeLine{00876\ \ \ \ \ add\_child(child\_node,\ sort,\ current\_thread);}
\DoxyCodeLine{00877\ \ \ \}}
\DoxyCodeLine{00878\ \ \ \textcolor{keywordtype}{int}\ num\_stashed\ =\ stashed.get\_num\_stashed();}
\DoxyCodeLine{00879\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_stashed;\ i++)\ \{}
\DoxyCodeLine{00880\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ stashed.get\_stashed(i);}
\DoxyCodeLine{00881\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ stashed.get\_stashed\_sort(i);}
\DoxyCodeLine{00882\ \ \ \ \ \mbox{\hyperlink{classPandaNode_ab1a83b397261883f5fd69bfb744360df}{add\_stashed}}(child\_node,\ sort,\ current\_thread);}
\DoxyCodeLine{00883\ \ \ \}}
\DoxyCodeLine{00884\ \}}
\DoxyCodeLine{00885\ }
\DoxyCodeLine{00891\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ad28ec939c11631643be230d7f8ddcdf3}{PandaNode::}}}
\DoxyCodeLine{00892\ \mbox{\hyperlink{classPandaNode_ad28ec939c11631643be230d7f8ddcdf3}{set\_attrib}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderAttrib}{RenderAttrib}}\ *attrib,\ \textcolor{keywordtype}{int}\ \textcolor{keyword}{override})\ \{}
\DoxyCodeLine{00893\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{00894\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{00895\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00896\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00897\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00898\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00899\ }
\DoxyCodeLine{00900\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ new\_state\ =\ cdata-\/>\_state-\/>set\_attrib(attrib,\ \textcolor{keyword}{override});}
\DoxyCodeLine{00901\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_state\ !=\ new\_state)\ \{}
\DoxyCodeLine{00902\ \ \ \ \ \ \ cdata-\/>\_state\ =\ new\_state;}
\DoxyCodeLine{00903\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_state,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00904\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00905\ \ \ \ \ \}}
\DoxyCodeLine{00906\ \ \ \}}
\DoxyCodeLine{00907\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00908\ }
\DoxyCodeLine{00909\ \ \ \textcolor{comment}{//\ Maybe\ we\ changed\ a\ ClipPlaneAttrib.}}
\DoxyCodeLine{00910\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{00911\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{00912\ \ \ \ \ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{state\_changed}}();}
\DoxyCodeLine{00913\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00914\ \ \ \}}
\DoxyCodeLine{00915\ \}}
\DoxyCodeLine{00916\ }
\DoxyCodeLine{00922\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{00923\ clear\_attrib(\textcolor{keywordtype}{int}\ slot)\ \{}
\DoxyCodeLine{00924\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00925\ }
\DoxyCodeLine{00926\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00927\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00928\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00929\ }
\DoxyCodeLine{00930\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ new\_state\ =\ cdata-\/>\_state-\/>remove\_attrib(slot);}
\DoxyCodeLine{00931\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_state\ !=\ new\_state)\ \{}
\DoxyCodeLine{00932\ \ \ \ \ \ \ cdata-\/>\_state\ =\ new\_state;}
\DoxyCodeLine{00933\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_state,\ !new\_state-\/>is\_empty());}
\DoxyCodeLine{00934\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00935\ \ \ \ \ \}}
\DoxyCodeLine{00936\ \ \ \}}
\DoxyCodeLine{00937\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00938\ }
\DoxyCodeLine{00939\ \ \ \textcolor{comment}{//\ We\ mark\ the\ bounds\ stale\ when\ the\ state\ changes,\ in\ case\ we\ have\ changed}}
\DoxyCodeLine{00940\ \ \ \textcolor{comment}{//\ a\ ClipPlaneAttrib.}}
\DoxyCodeLine{00941\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{00942\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{00943\ \ \ \ \ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{state\_changed}}();}
\DoxyCodeLine{00944\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00945\ \ \ \}}
\DoxyCodeLine{00946\ \}}
\DoxyCodeLine{00947\ }
\DoxyCodeLine{00952\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aa342abc462d06e1e11edc873927dbcd2}{PandaNode::}}}
\DoxyCodeLine{00953\ \mbox{\hyperlink{classPandaNode_aa342abc462d06e1e11edc873927dbcd2}{set\_effect}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderEffect}{RenderEffect}}\ *effect)\ \{}
\DoxyCodeLine{00954\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{00955\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{00956\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00957\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00958\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00959\ \ \ \ \ cdata-\/>\_effects\ =\ cdata-\/>\_effects-\/>add\_effect(effect);}
\DoxyCodeLine{00960\ }
\DoxyCodeLine{00961\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_effects,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00962\ \ \ \ \ \textcolor{keywordflow}{if}\ (effect-\/>get\_type()\ ==\ DecalEffect::get\_class\_type())\ \{}
\DoxyCodeLine{00963\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_decal,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00964\ \ \ \ \ \}}
\DoxyCodeLine{00965\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (effect-\/>get\_type()\ ==\ ShowBoundsEffect::get\_class\_type())\ \{}
\DoxyCodeLine{00966\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_show\_bounds,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00967\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_show\_tight\_bounds,\ ((\textcolor{keyword}{const}\ \mbox{\hyperlink{classShowBoundsEffect}{ShowBoundsEffect}}\ *)effect)-\/>get\_tight());}
\DoxyCodeLine{00968\ \ \ \ \ \}}
\DoxyCodeLine{00969\ \ \ \}}
\DoxyCodeLine{00970\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00971\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00972\ \}}
\DoxyCodeLine{00973\ }
\DoxyCodeLine{00977\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a36ea83c47c4af5108fd3e717aef9d94f}{PandaNode::}}}
\DoxyCodeLine{00978\ \mbox{\hyperlink{classPandaNode_a36ea83c47c4af5108fd3e717aef9d94f}{clear\_effect}}(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ type)\ \{}
\DoxyCodeLine{00979\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00980\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{00981\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{00982\ \ \ \ \ cdata-\/>\_effects\ =\ cdata-\/>\_effects-\/>remove\_effect(type);}
\DoxyCodeLine{00983\ }
\DoxyCodeLine{00984\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_effects,\ !cdata-\/>\_effects-\/>is\_empty());}
\DoxyCodeLine{00985\ \ \ \ \ \textcolor{keywordflow}{if}\ (type\ ==\ DecalEffect::get\_class\_type())\ \{}
\DoxyCodeLine{00986\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_decal,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00987\ \ \ \ \ \}}
\DoxyCodeLine{00988\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (type\ ==\ ShowBoundsEffect::get\_class\_type())\ \{}
\DoxyCodeLine{00989\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_show\_bounds\ |\ FB\_show\_tight\_bounds,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00990\ \ \ \ \ \}}
\DoxyCodeLine{00991\ \ \ \}}
\DoxyCodeLine{00992\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{00993\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{00994\ \}}
\DoxyCodeLine{00995\ }
\DoxyCodeLine{01003\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a1546d648fa57896436917ce3fa087d2e}{PandaNode::}}}
\DoxyCodeLine{01004\ \mbox{\hyperlink{classPandaNode_a1546d648fa57896436917ce3fa087d2e}{set\_state}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01005\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01006\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01007\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01008\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01009\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01010\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_state\ !=\ state)\ \{}
\DoxyCodeLine{01011\ \ \ \ \ \ \ cdata-\/>\_state\ =\ state;}
\DoxyCodeLine{01012\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_state,\ !state-\/>is\_empty());}
\DoxyCodeLine{01013\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01014\ \ \ \ \ \}}
\DoxyCodeLine{01015\ \ \ \}}
\DoxyCodeLine{01016\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01017\ }
\DoxyCodeLine{01018\ \ \ \textcolor{comment}{//\ Maybe\ we\ have\ changed\ a\ ClipPlaneAttrib.}}
\DoxyCodeLine{01019\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{01020\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{01021\ \ \ \ \ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{state\_changed}}();}
\DoxyCodeLine{01022\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01023\ \ \ \}}
\DoxyCodeLine{01024\ \}}
\DoxyCodeLine{01025\ }
\DoxyCodeLine{01031\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a7e6099a768b20f409469c7ba9881b83b}{PandaNode::}}}
\DoxyCodeLine{01032\ \mbox{\hyperlink{classPandaNode_a7e6099a768b20f409469c7ba9881b83b}{set\_effects}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderEffects}{RenderEffects}}\ *effects,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01033\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01034\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01035\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01036\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01037\ \ \ \ \ cdata-\/>\_effects\ =\ effects;}
\DoxyCodeLine{01038\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_effects,\ !effects-\/>is\_empty());}
\DoxyCodeLine{01039\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_decal,\ effects-\/>has\_decal());}
\DoxyCodeLine{01040\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_show\_bounds,\ effects-\/>has\_show\_bounds());}
\DoxyCodeLine{01041\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_show\_tight\_bounds,\ effects-\/>has\_show\_tight\_bounds());}
\DoxyCodeLine{01042\ \ \ \}}
\DoxyCodeLine{01043\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01044\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01045\ \}}
\DoxyCodeLine{01046\ }
\DoxyCodeLine{01051\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a47b2c6957f65738cd8fcbc66c0603638}{PandaNode::}}}
\DoxyCodeLine{01052\ \mbox{\hyperlink{classPandaNode_a47b2c6957f65738cd8fcbc66c0603638}{set\_transform}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01053\ \ \ nassertv(!transform-\/>is\_invalid());}
\DoxyCodeLine{01054\ }
\DoxyCodeLine{01055\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01056\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01057\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01058\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01059\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01060\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_transform\ !=\ transform)\ \{}
\DoxyCodeLine{01061\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pipeline\_stage\ ==\ 0)\ \{}
\DoxyCodeLine{01062\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Back\ up\ the\ previous\ transform.}}
\DoxyCodeLine{01063\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_prev\_transform\_valid\ !=\ \_reset\_prev\_transform\_seq)\ \{}
\DoxyCodeLine{01064\ \ \ \ \ \ \ \ \ \ \ cdata-\/>\_prev\_transform\ =\ std::move(cdata-\/>\_transform);}
\DoxyCodeLine{01065\ \ \ \ \ \ \ \ \ \ \ \_prev\_transform\_valid\ =\ \_reset\_prev\_transform\_seq;}
\DoxyCodeLine{01066\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01067\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01068\ }
\DoxyCodeLine{01069\ \ \ \ \ \ \ cdata-\/>\_transform\ =\ transform;}
\DoxyCodeLine{01070\ \ \ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_transform,\ !transform-\/>is\_identity());}
\DoxyCodeLine{01071\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01072\ \ \ \ \ \}}
\DoxyCodeLine{01073\ \ \ \}}
\DoxyCodeLine{01074\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01075\ }
\DoxyCodeLine{01076\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{01077\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{01078\ \ \ \ \ \mbox{\hyperlink{classPandaNode_a28a4ed8dab3b2bcd2a686712b9e391d6}{transform\_changed}}();}
\DoxyCodeLine{01079\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01080\ \ \ \}}
\DoxyCodeLine{01081\ \}}
\DoxyCodeLine{01082\ }
\DoxyCodeLine{01088\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ac6851e99ce009ab87f9e482a032b1920}{PandaNode::}}}
\DoxyCodeLine{01089\ \mbox{\hyperlink{classPandaNode_ac6851e99ce009ab87f9e482a032b1920}{set\_prev\_transform}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01090\ \ \ nassertv(!transform-\/>is\_invalid());}
\DoxyCodeLine{01091\ }
\DoxyCodeLine{01092\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01093\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01094\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01095\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01096\ \ \ \ \ cdata-\/>\_prev\_transform\ =\ transform;}
\DoxyCodeLine{01097\ \ \ \ \ \textcolor{keywordflow}{if}\ (pipeline\_stage\ ==\ 0)\ \{}
\DoxyCodeLine{01098\ \ \ \ \ \ \ \_prev\_transform\_valid\ =\ \_reset\_prev\_transform\_seq;}
\DoxyCodeLine{01099\ \ \ \ \ \}}
\DoxyCodeLine{01100\ \ \ \}}
\DoxyCodeLine{01101\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01102\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01103\ \}}
\DoxyCodeLine{01104\ }
\DoxyCodeLine{01110\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a360d855b5faf6809e839a63a908ce912}{PandaNode::}}}
\DoxyCodeLine{01111\ \mbox{\hyperlink{classPandaNode_a360d855b5faf6809e839a63a908ce912}{reset\_prev\_transform}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01112\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01113\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01114\ }
\DoxyCodeLine{01115\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01116\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01117\ \ \ \ \ cdata-\/>\_prev\_transform\ =\ cdata-\/>\_transform;}
\DoxyCodeLine{01118\ \ \ \}}
\DoxyCodeLine{01119\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01120\ \}}
\DoxyCodeLine{01121\ }
\DoxyCodeLine{01126\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a4e308f57efc41defa8df1e66422db894}{PandaNode::}}}
\DoxyCodeLine{01127\ \mbox{\hyperlink{classPandaNode_a4e308f57efc41defa8df1e66422db894}{reset\_all\_prev\_transform}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01128\ \ \ nassertv(current\_thread-\/>get\_pipeline\_stage()\ ==\ 0);}
\DoxyCodeLine{01129\ }
\DoxyCodeLine{01130\ \ \ \textcolor{comment}{//\ Rather\ than\ keeping\ a\ linked\ list\ of\ all\ nodes\ that\ have\ changed\ their}}
\DoxyCodeLine{01131\ \ \ \textcolor{comment}{//\ transform,\ we\ simply\ increment\ this\ counter.\ \ All\ the\ nodes\ compare\ this}}
\DoxyCodeLine{01132\ \ \ \textcolor{comment}{//\ value\ to\ their\ own\ \_prev\_transform\_valid\ value,\ and\ if\ it's\ different,}}
\DoxyCodeLine{01133\ \ \ \textcolor{comment}{//\ they\ should\ disregard\ their\ \_prev\_transform\ field\ and\ assume\ it's\ the\ same}}
\DoxyCodeLine{01134\ \ \ \textcolor{comment}{//\ as\ their\ \_transform.}}
\DoxyCodeLine{01135\ \ \ ++\_reset\_prev\_transform\_seq;}
\DoxyCodeLine{01136\ \}}
\DoxyCodeLine{01137\ }
\DoxyCodeLine{01147\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a296946c276029665366c3426d88f091a}{PandaNode::}}}
\DoxyCodeLine{01148\ \mbox{\hyperlink{classPandaNode_a296946c276029665366c3426d88f091a}{set\_tag}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&key,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&value,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01149\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01150\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01151\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01152\ \ \ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01153\ \ \ \ \ cdata-\/>\_tag\_data.store(key,\ value);}
\DoxyCodeLine{01154\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_tag,\ \textcolor{keyword}{true});}
\DoxyCodeLine{01155\ \ \ \}}
\DoxyCodeLine{01156\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01157\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01158\ \}}
\DoxyCodeLine{01159\ }
\DoxyCodeLine{01164\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ac13bef3b1a08ff88ea3a8b9653f7aa0e}{PandaNode::}}}
\DoxyCodeLine{01165\ \mbox{\hyperlink{classPandaNode_ac13bef3b1a08ff88ea3a8b9653f7aa0e}{clear\_tag}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&key,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01166\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01167\ \ \ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01168\ \ \ \ \ cdata-\/>\_tag\_data.remove(key);}
\DoxyCodeLine{01169\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_tag,\ !cdata-\/>\_tag\_data.is\_empty());}
\DoxyCodeLine{01170\ \ \ \}}
\DoxyCodeLine{01171\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01172\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01173\ \}}
\DoxyCodeLine{01174\ }
\DoxyCodeLine{01180\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ac414ed275ba76dc3873cc68bad17607f}{PandaNode::}}}
\DoxyCodeLine{01181\ \mbox{\hyperlink{classPandaNode_ac414ed275ba76dc3873cc68bad17607f}{copy\_tags}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{01182\ \ \ \textcolor{keywordflow}{if}\ (other\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{01183\ \ \ \ \ \textcolor{comment}{//\ Trivial.}}
\DoxyCodeLine{01184\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01185\ \ \ \}}
\DoxyCodeLine{01186\ }
\DoxyCodeLine{01187\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{01188\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{01189\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01190\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01191\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdataw(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01192\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageReader}{CDStageReader}}\ cdatar(other-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01193\ }
\DoxyCodeLine{01194\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ n\ =\ 0;\ n\ <\ cdatar-\/>\_tag\_data.size();\ ++n)\ \{}
\DoxyCodeLine{01195\ \ \ \ \ \ \ cdataw-\/>\_tag\_data.store(cdatar-\/>\_tag\_data.get\_key(n),\ cdatar-\/>\_tag\_data.get\_data(n));}
\DoxyCodeLine{01196\ \ \ \ \ \}}
\DoxyCodeLine{01197\ \ \ \ \ cdataw-\/>set\_fancy\_bit(FB\_tag,\ !cdataw-\/>\_tag\_data.is\_empty());}
\DoxyCodeLine{01198\ \ \ \}}
\DoxyCodeLine{01199\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01200\ }
\DoxyCodeLine{01201\ \ \ \textcolor{comment}{//\ It's\ okay\ to\ copy\ the\ tags\ by\ pointer,\ because\ get\_python\_tags\ does\ a}}
\DoxyCodeLine{01202\ \ \ \textcolor{comment}{//\ copy-\/on-\/write.}}
\DoxyCodeLine{01203\ \ \ \_python\_tag\_data\ =\ other-\/>\_python\_tag\_data;}
\DoxyCodeLine{01204\ }
\DoxyCodeLine{01205\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01206\ \}}
\DoxyCodeLine{01207\ }
\DoxyCodeLine{01217\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_abd9fda200bdb7b8712ea6a1cb796e345}{PandaNode::}}}
\DoxyCodeLine{01218\ \mbox{\hyperlink{classPandaNode_abd9fda200bdb7b8712ea6a1cb796e345}{list\_tags}}(ostream\ \&out,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&separator)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01219\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{01220\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ n\ =\ 0;\ n\ <\ cdata-\/>\_tag\_data.size();\ ++n)\ \{}
\DoxyCodeLine{01221\ \ \ \ \ \textcolor{keywordflow}{if}\ (n\ >\ 0)\ \{}
\DoxyCodeLine{01222\ \ \ \ \ \ \ out\ <<\ separator;}
\DoxyCodeLine{01223\ \ \ \ \ \}}
\DoxyCodeLine{01224\ \ \ \ \ out\ <<\ cdata-\/>\_tag\_data.get\_key(n);}
\DoxyCodeLine{01225\ \ \ \}}
\DoxyCodeLine{01226\ }
\DoxyCodeLine{01227\ \ \ \textcolor{comment}{//\ We\ used\ to\ list\ the\ Python\ tags\ here.\ \ That's\ a\ bit\ awkward,\ though,}}
\DoxyCodeLine{01228\ \ \ \textcolor{comment}{//\ since\ that\ means\ calling\ up\ into\ Python\ code\ to\ print\ the\ keys.\ \ If}}
\DoxyCodeLine{01229\ \ \ \textcolor{comment}{//\ someone\ finds\ it\ useful,\ we\ can\ implement\ it\ in\ an\ extension\ method.}}
\DoxyCodeLine{01230\ \}}
\DoxyCodeLine{01231\ }
\DoxyCodeLine{01238\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a18999859e15688065ff30abefdf93f7d}{PandaNode::}}}
\DoxyCodeLine{01239\ \mbox{\hyperlink{classPandaNode_a18999859e15688065ff30abefdf93f7d}{get\_tag\_keys}}(vector\_string\ \&keys)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01240\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{01241\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ n\ =\ 0;\ n\ <\ cdata-\/>\_tag\_data.size();\ ++n)\ \{}
\DoxyCodeLine{01242\ \ \ \ \ keys.push\_back(cdata-\/>\_tag\_data.get\_key(n));}
\DoxyCodeLine{01243\ \ \ \}}
\DoxyCodeLine{01244\ \}}
\DoxyCodeLine{01245\ }
\DoxyCodeLine{01253\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPandaNode_aec90e8c22a823ecc717b70aa9b6bd656}{PandaNode::}}}
\DoxyCodeLine{01254\ \mbox{\hyperlink{classPandaNode_aec90e8c22a823ecc717b70aa9b6bd656}{compare\_tags}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01255\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{01256\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata\_other(other-\/>\_cycler);}
\DoxyCodeLine{01257\ }
\DoxyCodeLine{01258\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSimpleHashMap}{TagData}}\ \&a\_data\ =\ cdata-\/>\_tag\_data;}
\DoxyCodeLine{01259\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSimpleHashMap}{TagData}}\ \&b\_data\ =\ cdata\_other-\/>\_tag\_data;}
\DoxyCodeLine{01260\ }
\DoxyCodeLine{01261\ \ \ \textcolor{keywordtype}{size\_t}\ ai\ =\ 0;}
\DoxyCodeLine{01262\ \ \ \textcolor{keywordtype}{size\_t}\ bi\ =\ 0;}
\DoxyCodeLine{01263\ \ \ \textcolor{keywordflow}{while}\ (ai\ <\ a\_data.size()\ \&\&\ bi\ <\ b\_data.size())\ \{}
\DoxyCodeLine{01264\ \ \ \ \ \textcolor{keywordtype}{int}\ cmp\ =\ strcmp(a\_data.get\_key(ai).c\_str(),\ b\_data.get\_key(bi).c\_str());}
\DoxyCodeLine{01265\ \ \ \ \ \textcolor{keywordflow}{if}\ (cmp\ !=\ 0)\ \{}
\DoxyCodeLine{01266\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cmp;}
\DoxyCodeLine{01267\ \ \ \ \ \}}
\DoxyCodeLine{01268\ }
\DoxyCodeLine{01269\ \ \ \ \ cmp\ =\ strcmp(a\_data.get\_data(ai).c\_str(),\ b\_data.get\_data(bi).c\_str());}
\DoxyCodeLine{01270\ \ \ \ \ \textcolor{keywordflow}{if}\ (cmp\ !=\ 0)\ \{}
\DoxyCodeLine{01271\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cmp;}
\DoxyCodeLine{01272\ \ \ \ \ \}}
\DoxyCodeLine{01273\ }
\DoxyCodeLine{01274\ \ \ \ \ ++ai;}
\DoxyCodeLine{01275\ \ \ \ \ ++bi;}
\DoxyCodeLine{01276\ \ \ \}}
\DoxyCodeLine{01277\ \ \ \textcolor{keywordflow}{if}\ (ai\ <\ a\_data.size())\ \{}
\DoxyCodeLine{01278\ \ \ \ \ \textcolor{comment}{//\ list\ A\ is\ longer.}}
\DoxyCodeLine{01279\ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{01280\ \ \ \}}
\DoxyCodeLine{01281\ \ \ \textcolor{keywordflow}{if}\ (bi\ <\ b\_data.size())\ \{}
\DoxyCodeLine{01282\ \ \ \ \ \textcolor{comment}{//\ list\ B\ is\ longer.}}
\DoxyCodeLine{01283\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{01284\ \ \ \}}
\DoxyCodeLine{01285\ }
\DoxyCodeLine{01286\ \ \ \textcolor{comment}{//\ We\ compare\ these\ by\ pointer,\ since\ it's\ problematic\ to\ call\ up\ into}}
\DoxyCodeLine{01287\ \ \ \textcolor{comment}{//\ Python\ from\ arbitrary\ C++\ code.}}
\DoxyCodeLine{01288\ \ \ \textcolor{keywordflow}{if}\ (\_python\_tag\_data\ !=\ other-\/>\_python\_tag\_data)\ \{}
\DoxyCodeLine{01289\ \ \ \ \ \textcolor{keywordflow}{return}\ (\_python\_tag\_data\ <\ other-\/>\_python\_tag\_data)\ ?\ -\/1\ :\ 1;}
\DoxyCodeLine{01290\ \ \ \}}
\DoxyCodeLine{01291\ }
\DoxyCodeLine{01292\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01293\ \}}
\DoxyCodeLine{01294\ }
\DoxyCodeLine{01301\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a96900772489dad8d48fb85b227d739bd}{PandaNode::}}}
\DoxyCodeLine{01302\ \mbox{\hyperlink{classPandaNode_a96900772489dad8d48fb85b227d739bd}{copy\_all\_properties}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{01303\ \ \ \textcolor{keywordflow}{if}\ (other\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{01304\ \ \ \ \ \textcolor{comment}{//\ Trivial.}}
\DoxyCodeLine{01305\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01306\ \ \ \}}
\DoxyCodeLine{01307\ }
\DoxyCodeLine{01308\ \ \ \textcolor{keywordtype}{bool}\ any\_transform\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01309\ \ \ \textcolor{keywordtype}{bool}\ any\_state\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01310\ \ \ \textcolor{keywordtype}{bool}\ any\_draw\_mask\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01311\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01312\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01313\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdataw(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01314\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageReader}{CDStageReader}}\ cdatar(other-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01315\ }
\DoxyCodeLine{01316\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_transform\ !=\ cdatar-\/>\_transform)\ \{}
\DoxyCodeLine{01317\ \ \ \ \ \ \ any\_transform\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01318\ \ \ \ \ \}}
\DoxyCodeLine{01319\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_state\ !=\ cdatar-\/>\_state)\ \{}
\DoxyCodeLine{01320\ \ \ \ \ \ \ any\_state\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01321\ \ \ \ \ \}}
\DoxyCodeLine{01322\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_draw\_control\_mask\ !=\ cdatar-\/>\_draw\_control\_mask\ ||}
\DoxyCodeLine{01323\ \ \ \ \ \ \ \ \ cdataw-\/>\_draw\_show\_mask\ !=\ cdatar-\/>\_draw\_show\_mask)\ \{}
\DoxyCodeLine{01324\ \ \ \ \ \ \ any\_draw\_mask\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01325\ \ \ \ \ \}}
\DoxyCodeLine{01326\ }
\DoxyCodeLine{01327\ \ \ \ \ cdataw-\/>\_transform\ =\ cdatar-\/>\_transform;}
\DoxyCodeLine{01328\ \ \ \ \ \textcolor{keywordflow}{if}\ (other-\/>\_prev\_transform\_valid\ ==\ \_reset\_prev\_transform\_seq)\ \{}
\DoxyCodeLine{01329\ \ \ \ \ \ \ cdataw-\/>\_prev\_transform\ =\ cdatar-\/>\_prev\_transform;}
\DoxyCodeLine{01330\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01331\ \ \ \ \ \ \ cdataw-\/>\_prev\_transform\ =\ cdatar-\/>\_transform;}
\DoxyCodeLine{01332\ \ \ \ \ \}}
\DoxyCodeLine{01333\ \ \ \ \ cdataw-\/>\_state\ =\ cdatar-\/>\_state;}
\DoxyCodeLine{01334\ \ \ \ \ cdataw-\/>\_effects\ =\ cdatar-\/>\_effects;}
\DoxyCodeLine{01335\ \ \ \ \ cdataw-\/>\_draw\_control\_mask\ =\ cdatar-\/>\_draw\_control\_mask;}
\DoxyCodeLine{01336\ \ \ \ \ cdataw-\/>\_draw\_show\_mask\ =\ cdatar-\/>\_draw\_show\_mask;}
\DoxyCodeLine{01337\ }
\DoxyCodeLine{01338\ \ \ \ \ \textcolor{comment}{//\ The\ collide\ mask\ becomes\ the\ union\ of\ the\ two\ masks.\ \ This\ is\ important}}
\DoxyCodeLine{01339\ \ \ \ \ \textcolor{comment}{//\ to\ preserve\ properties\ such\ as\ the\ default\ GeomNode\ bitmask.}}
\DoxyCodeLine{01340\ \ \ \ \ cdataw-\/>\_into\_collide\_mask\ |=\ cdatar-\/>\_into\_collide\_mask;}
\DoxyCodeLine{01341\ }
\DoxyCodeLine{01342\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ n\ =\ 0;\ n\ <\ cdatar-\/>\_tag\_data.size();\ ++n)\ \{}
\DoxyCodeLine{01343\ \ \ \ \ \ \ cdataw-\/>\_tag\_data.store(cdatar-\/>\_tag\_data.get\_key(n),\ cdatar-\/>\_tag\_data.get\_data(n));}
\DoxyCodeLine{01344\ \ \ \ \ \}}
\DoxyCodeLine{01345\ }
\DoxyCodeLine{01346\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ change\_bits\ =\ (FB\_transform\ |\ FB\_state\ |\ FB\_effects\ |}
\DoxyCodeLine{01347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FB\_tag\ |\ FB\_draw\_mask\ |\ FB\_decal\ |}
\DoxyCodeLine{01348\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FB\_show\_bounds\ |\ FB\_show\_tight\_bounds);}
\DoxyCodeLine{01349\ \ \ \ \ cdataw-\/>\_fancy\_bits\ =}
\DoxyCodeLine{01350\ \ \ \ \ \ \ (cdataw-\/>\_fancy\_bits\ \&\ \string~change\_bits)\ |}
\DoxyCodeLine{01351\ \ \ \ \ \ \ (cdatar-\/>\_fancy\_bits\ \&\ change\_bits);}
\DoxyCodeLine{01352\ }
\DoxyCodeLine{01353\ \ \ \ \ \textcolor{keywordflow}{if}\ (pipeline\_stage\ ==\ 0)\ \{}
\DoxyCodeLine{01354\ \ \ \ \ \ \ \_prev\_transform\_valid\ =\ \_reset\_prev\_transform\_seq;}
\DoxyCodeLine{01355\ \ \ \ \ \}}
\DoxyCodeLine{01356\ \ \ \}}
\DoxyCodeLine{01357\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01358\ }
\DoxyCodeLine{01359\ \ \ \textcolor{comment}{//\ It's\ okay\ to\ copy\ the\ tags\ by\ pointer,\ because\ get\_python\_tags\ does\ a}}
\DoxyCodeLine{01360\ \ \ \textcolor{comment}{//\ copy-\/on-\/write.}}
\DoxyCodeLine{01361\ \ \ \_python\_tag\_data\ =\ other-\/>\_python\_tag\_data;}
\DoxyCodeLine{01362\ }
\DoxyCodeLine{01363\ \ \ \textcolor{keywordflow}{if}\ (any\_transform\_changed\ ||\ any\_state\_changed\ ||\ any\_draw\_mask\_changed)\ \{}
\DoxyCodeLine{01364\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{01365\ }
\DoxyCodeLine{01366\ \ \ \ \ \textcolor{keywordflow}{if}\ (any\_transform\_changed)\ \{}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode_a28a4ed8dab3b2bcd2a686712b9e391d6}{transform\_changed}}();}
\DoxyCodeLine{01368\ \ \ \ \ \}}
\DoxyCodeLine{01369\ \ \ \ \ \textcolor{keywordflow}{if}\ (any\_state\_changed)\ \{}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{state\_changed}}();}
\DoxyCodeLine{01371\ \ \ \ \ \}}
\DoxyCodeLine{01372\ \ \ \ \ \textcolor{keywordflow}{if}\ (any\_draw\_mask\_changed)\ \{}
\DoxyCodeLine{01373\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode_aecf925ac58ff33505254da07c194338c}{draw\_mask\_changed}}();}
\DoxyCodeLine{01374\ \ \ \ \ \}}
\DoxyCodeLine{01375\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01376\ \ \ \}}
\DoxyCodeLine{01377\ \}}
\DoxyCodeLine{01378\ }
\DoxyCodeLine{01394\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ae1104ae4377c3d15b90faa9ebfc3db46}{PandaNode::}}}
\DoxyCodeLine{01395\ \mbox{\hyperlink{classPandaNode_ae1104ae4377c3d15b90faa9ebfc3db46}{replace\_node}}(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *other)\ \{}
\DoxyCodeLine{01396\ \ \ \textcolor{comment}{//\ nassertv(Thread::get\_current\_pipeline\_stage()\ ==\ 0);}}
\DoxyCodeLine{01397\ }
\DoxyCodeLine{01398\ \ \ \textcolor{keywordflow}{if}\ (other\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{01399\ \ \ \ \ \textcolor{comment}{//\ Trivial.}}
\DoxyCodeLine{01400\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01401\ \ \ \}}
\DoxyCodeLine{01402\ }
\DoxyCodeLine{01403\ \ \ \textcolor{comment}{//\ Make\ sure\ the\ other\ node\ is\ not\ destructed\ during\ the\ execution\ of\ this}}
\DoxyCodeLine{01404\ \ \ \textcolor{comment}{//\ method.}}
\DoxyCodeLine{01405\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_other\ =\ other;}
\DoxyCodeLine{01406\ }
\DoxyCodeLine{01407\ \ \ \textcolor{comment}{//\ Get\ all\ the\ important\ scene\ graph\ properties.}}
\DoxyCodeLine{01408\ \ \ \mbox{\hyperlink{classPandaNode_a96900772489dad8d48fb85b227d739bd}{copy\_all\_properties}}(other);}
\DoxyCodeLine{01409\ }
\DoxyCodeLine{01410\ \ \ \textcolor{comment}{//\ Fix\ up\ the\ NodePaths.}}
\DoxyCodeLine{01411\ \ \ \{}
\DoxyCodeLine{01412\ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder1(other-\/>\_paths\_lock);}
\DoxyCodeLine{01413\ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder2(\_paths\_lock);}
\DoxyCodeLine{01414\ \ \ \ \ Paths::iterator\ pi;}
\DoxyCodeLine{01415\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ other-\/>\_paths.begin();\ pi\ !=\ other-\/>\_paths.end();\ ++pi)\ \{}
\DoxyCodeLine{01416\ \ \ \ \ \ \ (*pi)-\/>\_node\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{01417\ \ \ \ \ \ \ \_paths.insert(*pi);}
\DoxyCodeLine{01418\ \ \ \ \ \}}
\DoxyCodeLine{01419\ \ \ \ \ other-\/>\_paths.clear();}
\DoxyCodeLine{01420\ \ \ \}}
\DoxyCodeLine{01421\ }
\DoxyCodeLine{01422\ \ \ \textcolor{comment}{//\ Get\ the\ children.}}
\DoxyCodeLine{01423\ \ \ \mbox{\hyperlink{classPandaNode_aec337c4ec3d2b93800935311e0dc4ca3}{steal\_children}}(other);}
\DoxyCodeLine{01424\ }
\DoxyCodeLine{01425\ \ \ \textcolor{comment}{//\ Switch\ the\ parents.}}
\DoxyCodeLine{01426\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01427\ \ \ Parents\ other\_parents\ =\ other-\/>get\_parents();}
\DoxyCodeLine{01428\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ other\_parents.get\_num\_parents();\ ++i)\ \{}
\DoxyCodeLine{01429\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\ =\ other\_parents.get\_parent(i);}
\DoxyCodeLine{01430\ \ \ \ \ \textcolor{keywordflow}{if}\ (find\_parent(parent)\ !=\ -\/1)\ \{}
\DoxyCodeLine{01431\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ node\ was\ already\ a\ child\ of\ this\ parent;\ don't\ change\ it.}}
\DoxyCodeLine{01432\ \ \ \ \ \ \ parent-\/>\mbox{\hyperlink{classPandaNode_a716da168c3b4828a04dc65b7ebdb89e2}{remove\_child}}(other);}
\DoxyCodeLine{01433\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01434\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ node\ was\ not\ yet\ a\ child\ of\ this\ parent;\ now\ it\ is.}}
\DoxyCodeLine{01435\ \ \ \ \ \ \ parent-\/>\mbox{\hyperlink{classPandaNode_a0db5cac63970ca4710013ace782db67f}{replace\_child}}(other,\ \textcolor{keyword}{this},\ current\_thread);}
\DoxyCodeLine{01436\ \ \ \ \ \}}
\DoxyCodeLine{01437\ \ \ \}}
\DoxyCodeLine{01438\ \}}
\DoxyCodeLine{01439\ }
\DoxyCodeLine{01453\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_adccbab722598a8900ca9cd3258136f58}{PandaNode::}}}
\DoxyCodeLine{01454\ \mbox{\hyperlink{classPandaNode_adccbab722598a8900ca9cd3258136f58}{set\_unexpected\_change}}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{01455\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{01456\ \ \ \_unexpected\_change\_flags\ |=\ flags;}
\DoxyCodeLine{01457\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ !NDEBUG}}
\DoxyCodeLine{01458\ \}}
\DoxyCodeLine{01459\ }
\DoxyCodeLine{01469\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPandaNode_abfb566beb9b0f6ee867e4773b1063861}{PandaNode::}}}
\DoxyCodeLine{01470\ \mbox{\hyperlink{classPandaNode_abfb566beb9b0f6ee867e4773b1063861}{get\_unexpected\_change}}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ flags)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01471\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{01472\ \ \ \textcolor{keywordflow}{return}\ \_unexpected\_change\_flags\ \&\ flags;}
\DoxyCodeLine{01473\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{01474\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01475\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ !NDEBUG}}
\DoxyCodeLine{01476\ \}}
\DoxyCodeLine{01477\ }
\DoxyCodeLine{01488\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a3370cc8224715971027e882c664cf28e}{PandaNode::}}}
\DoxyCodeLine{01489\ \mbox{\hyperlink{classPandaNode_a3370cc8224715971027e882c664cf28e}{clear\_unexpected\_change}}(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ flags)\ \{}
\DoxyCodeLine{01490\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{01491\ \ \ \_unexpected\_change\_flags\ \&=\ \string~flags;}
\DoxyCodeLine{01492\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ !NDEBUG}}
\DoxyCodeLine{01493\ \}}
\DoxyCodeLine{01494\ }
\DoxyCodeLine{01525\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a820da56f01dc2c69c3d5b08da0c09e47}{PandaNode::}}}
\DoxyCodeLine{01526\ \mbox{\hyperlink{classPandaNode_a820da56f01dc2c69c3d5b08da0c09e47}{adjust\_draw\_mask}}(\mbox{\hyperlink{classBitMask}{DrawMask}}\ show\_mask,\ \mbox{\hyperlink{classBitMask}{DrawMask}}\ hide\_mask,\ \mbox{\hyperlink{classBitMask}{DrawMask}}\ clear\_mask)\ \{}
\DoxyCodeLine{01527\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01528\ }
\DoxyCodeLine{01529\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01530\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01531\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01532\ }
\DoxyCodeLine{01533\ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_control\_mask\ =\ (cdata-\/>\_draw\_control\_mask\ |\ show\_mask\ |\ hide\_mask)\ \&\ \string~clear\_mask;}
\DoxyCodeLine{01534\ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_show\_mask\ =\ (cdata-\/>\_draw\_show\_mask\ |\ show\_mask)\ \&\ \string~hide\_mask;}
\DoxyCodeLine{01535\ \ \ \ \ \textcolor{comment}{//\ The\ uncontrolled\ bits\ are\ implicitly\ on.}}
\DoxyCodeLine{01536\ \ \ \ \ draw\_show\_mask\ |=\ \string~draw\_control\_mask;}
\DoxyCodeLine{01537\ }
\DoxyCodeLine{01538\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_draw\_control\_mask\ !=\ draw\_control\_mask\ ||}
\DoxyCodeLine{01539\ \ \ \ \ \ \ \ \ cdata-\/>\_draw\_show\_mask\ !=\ draw\_show\_mask)\ \{}
\DoxyCodeLine{01540\ \ \ \ \ \ \ cdata-\/>\_draw\_control\_mask\ =\ draw\_control\_mask;}
\DoxyCodeLine{01541\ \ \ \ \ \ \ cdata-\/>\_draw\_show\_mask\ =\ draw\_show\_mask;}
\DoxyCodeLine{01542\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01543\ \ \ \ \ \}}
\DoxyCodeLine{01544\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_draw\_mask,\ !draw\_control\_mask.is\_zero());}
\DoxyCodeLine{01545\ \ \ \}}
\DoxyCodeLine{01546\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01547\ }
\DoxyCodeLine{01548\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{01549\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{01550\ \ \ \ \ \mbox{\hyperlink{classPandaNode_aecf925ac58ff33505254da07c194338c}{draw\_mask\_changed}}();}
\DoxyCodeLine{01551\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01552\ \ \ \}}
\DoxyCodeLine{01553\ \}}
\DoxyCodeLine{01554\ }
\DoxyCodeLine{01563\ \mbox{\hyperlink{classBitMask}{DrawMask}}\ \mbox{\hyperlink{classPandaNode_a0a3af906cb4e6d90cd6549c9810905cc}{PandaNode::}}}
\DoxyCodeLine{01564\ \mbox{\hyperlink{classPandaNode_a0a3af906cb4e6d90cd6549c9810905cc}{get\_net\_draw\_control\_mask}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01565\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01566\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01567\ \ \ \mbox{\hyperlink{classCycleDataLockedStageReader}{CDLockedStageReader}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01568\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01569\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01570\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01571\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdataw\ =}
\DoxyCodeLine{01572\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{false},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01573\ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_net\_draw\_control\_mask;}
\DoxyCodeLine{01574\ \ \ \}}
\DoxyCodeLine{01575\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_net\_draw\_control\_mask;}
\DoxyCodeLine{01576\ \}}
\DoxyCodeLine{01577\ }
\DoxyCodeLine{01590\ \mbox{\hyperlink{classBitMask}{DrawMask}}\ \mbox{\hyperlink{classPandaNode_a33ee1f4cd51ce6a0d40a2662699c9938}{PandaNode::}}}
\DoxyCodeLine{01591\ \mbox{\hyperlink{classPandaNode_a33ee1f4cd51ce6a0d40a2662699c9938}{get\_net\_draw\_show\_mask}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01592\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01593\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01594\ \ \ \mbox{\hyperlink{classCycleDataLockedStageReader}{CDLockedStageReader}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01595\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01596\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01597\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01598\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdataw\ =}
\DoxyCodeLine{01599\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{false},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01600\ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_net\_draw\_show\_mask;}
\DoxyCodeLine{01601\ \ \ \}}
\DoxyCodeLine{01602\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_net\_draw\_show\_mask;}
\DoxyCodeLine{01603\ \}}
\DoxyCodeLine{01604\ }
\DoxyCodeLine{01617\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aa7a3b5719026d40acbe068a3c5b4ec70}{PandaNode::}}}
\DoxyCodeLine{01618\ \mbox{\hyperlink{classPandaNode_aa7a3b5719026d40acbe068a3c5b4ec70}{set\_into\_collide\_mask}}(\mbox{\hyperlink{classBitMask}{CollideMask}}\ mask)\ \{}
\DoxyCodeLine{01619\ \ \ mask\ \&=\ \mbox{\hyperlink{classPandaNode_a6951323ca029d0e79a115ebe1054bf0c}{get\_legal\_collide\_mask}}();}
\DoxyCodeLine{01620\ }
\DoxyCodeLine{01621\ \ \ \textcolor{keywordtype}{bool}\ any\_changed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01622\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01623\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01624\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01625\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_into\_collide\_mask\ !=\ mask)\ \{}
\DoxyCodeLine{01626\ \ \ \ \ \ \ cdata-\/>\_into\_collide\_mask\ =\ mask;}
\DoxyCodeLine{01627\ \ \ \ \ \ \ any\_changed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01628\ \ \ \ \ \}}
\DoxyCodeLine{01629\ \ \ \}}
\DoxyCodeLine{01630\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01631\ }
\DoxyCodeLine{01632\ \ \ \textcolor{keywordflow}{if}\ (any\_changed)\ \{}
\DoxyCodeLine{01633\ \ \ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{01634\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01635\ \ \ \}}
\DoxyCodeLine{01636\ \}}
\DoxyCodeLine{01637\ }
\DoxyCodeLine{01646\ \mbox{\hyperlink{classBitMask}{CollideMask}}\ \mbox{\hyperlink{classPandaNode_a6951323ca029d0e79a115ebe1054bf0c}{PandaNode::}}}
\DoxyCodeLine{01647\ \mbox{\hyperlink{classPandaNode_a6951323ca029d0e79a115ebe1054bf0c}{get\_legal\_collide\_mask}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01648\ \ \ \textcolor{keywordflow}{return}\ CollideMask::all\_off();}
\DoxyCodeLine{01649\ \}}
\DoxyCodeLine{01650\ }
\DoxyCodeLine{01655\ \mbox{\hyperlink{classBitMask}{CollideMask}}\ \mbox{\hyperlink{classPandaNode_a3a25efa163541e6f4c6a6a02c86f81dc}{PandaNode::}}}
\DoxyCodeLine{01656\ \mbox{\hyperlink{classPandaNode_a3a25efa163541e6f4c6a6a02c86f81dc}{get\_net\_collide\_mask}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01657\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01658\ \ \ \mbox{\hyperlink{classCycleDataLockedStageReader}{CDLockedStageReader}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01659\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01660\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01661\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01662\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdataw\ =}
\DoxyCodeLine{01663\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{false},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01664\ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_net\_collide\_mask;}
\DoxyCodeLine{01665\ \ \ \}}
\DoxyCodeLine{01666\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_net\_collide\_mask;}
\DoxyCodeLine{01667\ \}}
\DoxyCodeLine{01668\ }
\DoxyCodeLine{01673\ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ PandaNode::}
\DoxyCodeLine{01674\ get\_off\_clip\_planes(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01675\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01676\ \ \ CDLockedStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01677\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01678\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01679\ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01680\ \ \ \ \ CDStageWriter\ cdataw\ =}
\DoxyCodeLine{01681\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{false},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01682\ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_off\_clip\_planes;}
\DoxyCodeLine{01683\ \ \ \}}
\DoxyCodeLine{01684\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_off\_clip\_planes;}
\DoxyCodeLine{01685\ \}}
\DoxyCodeLine{01686\ }
\DoxyCodeLine{01697\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{01698\ prepare\_scene(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *node\_state)\ \{}
\DoxyCodeLine{01699\ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ transformer;}
\DoxyCodeLine{01700\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01701\ \ \ \mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{r\_prepare\_scene}}(gsg,\ node\_state,\ transformer,\ current\_thread);}
\DoxyCodeLine{01702\ \}}
\DoxyCodeLine{01703\ }
\DoxyCodeLine{01709\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_aa8f159268547508bc8c38925b15d294a}{PandaNode::}}}
\DoxyCodeLine{01710\ \mbox{\hyperlink{classPandaNode_aa8f159268547508bc8c38925b15d294a}{is\_scene\_root}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01711\ \ \ \textcolor{comment}{//\ This\ function\ pointer\ has\ to\ be\ filled\ in\ when\ the\ global\ GraphicsEngine}}
\DoxyCodeLine{01712\ \ \ \textcolor{comment}{//\ is\ created,\ because\ we\ can't\ link\ with\ the\ GraphicsEngine\ functions}}
\DoxyCodeLine{01713\ \ \ \textcolor{comment}{//\ directly.}}
\DoxyCodeLine{01714\ \ \ \textcolor{keywordflow}{if}\ (\_scene\_root\_func\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01715\ \ \ \ \ \textcolor{keywordflow}{return}\ (*\_scene\_root\_func)(\textcolor{keyword}{this});}
\DoxyCodeLine{01716\ \ \ \}}
\DoxyCodeLine{01717\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01718\ \}}
\DoxyCodeLine{01719\ }
\DoxyCodeLine{01726\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a8ebd7bfaea49e2a5901a020e035f4acd}{PandaNode::}}}
\DoxyCodeLine{01727\ \mbox{\hyperlink{classPandaNode_a8ebd7bfaea49e2a5901a020e035f4acd}{is\_under\_scene\_root}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01728\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classPandaNode_aa8f159268547508bc8c38925b15d294a}{is\_scene\_root}}())\ \{}
\DoxyCodeLine{01729\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01730\ \ \ \}}
\DoxyCodeLine{01731\ }
\DoxyCodeLine{01732\ \ \ Parents\ parents\ =\ get\_parents();}
\DoxyCodeLine{01733\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ parents.get\_num\_parents();\ ++i)\ \{}
\DoxyCodeLine{01734\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\ =\ parents.get\_parent(i);}
\DoxyCodeLine{01735\ \ \ \ \ \textcolor{keywordflow}{if}\ (parent-\/>find\_stashed((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})\ ==\ -\/1)\ \{}
\DoxyCodeLine{01736\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parent-\/>\mbox{\hyperlink{classPandaNode_a8ebd7bfaea49e2a5901a020e035f4acd}{is\_under\_scene\_root}}())\ \{}
\DoxyCodeLine{01737\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01738\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01739\ \ \ \ \ \}}
\DoxyCodeLine{01740\ \ \ \}}
\DoxyCodeLine{01741\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01742\ \}}
\DoxyCodeLine{01743\ }
\DoxyCodeLine{01747\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{01748\ output(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01749\ \ \ out\ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ get\_name();}
\DoxyCodeLine{01750\ \}}
\DoxyCodeLine{01751\ }
\DoxyCodeLine{01755\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{01756\ write(ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01757\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ *\textcolor{keyword}{this};}
\DoxyCodeLine{01758\ \ \ \textcolor{keywordflow}{if}\ (has\_tags())\ \{}
\DoxyCodeLine{01759\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ ["{}};}
\DoxyCodeLine{01760\ \ \ \ \ \mbox{\hyperlink{classPandaNode_abd9fda200bdb7b8712ea6a1cb796e345}{list\_tags}}(out,\ \textcolor{stringliteral}{"{}\ "{}});}
\DoxyCodeLine{01761\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{01762\ \ \ \}}
\DoxyCodeLine{01763\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ transform\ =\ get\_transform();}
\DoxyCodeLine{01764\ \ \ \textcolor{keywordflow}{if}\ (!transform-\/>is\_identity())\ \{}
\DoxyCodeLine{01765\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *transform;}
\DoxyCodeLine{01766\ \ \ \}}
\DoxyCodeLine{01767\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ state\ =\ get\_state();}
\DoxyCodeLine{01768\ \ \ \textcolor{keywordflow}{if}\ (!state-\/>is\_empty())\ \{}
\DoxyCodeLine{01769\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *state;}
\DoxyCodeLine{01770\ \ \ \}}
\DoxyCodeLine{01771\ \ \ CPT(\mbox{\hyperlink{classRenderEffects}{RenderEffects}})\ effects\ =\ get\_effects();}
\DoxyCodeLine{01772\ \ \ \textcolor{keywordflow}{if}\ (!effects-\/>is\_empty())\ \{}
\DoxyCodeLine{01773\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ *effects;}
\DoxyCodeLine{01774\ \ \ \}}
\DoxyCodeLine{01775\ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_control\_mask\ =\ get\_draw\_control\_mask();}
\DoxyCodeLine{01776\ \ \ \textcolor{keywordflow}{if}\ (!draw\_control\_mask.is\_zero())\ \{}
\DoxyCodeLine{01777\ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_show\_mask\ =\ get\_draw\_show\_mask();}
\DoxyCodeLine{01778\ \ \ \ \ \textcolor{keywordflow}{if}\ (!(draw\_control\_mask\ \&\ \_overall\_bit).is\_zero())\ \{}
\DoxyCodeLine{01779\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(draw\_show\_mask\ \&\ \_overall\_bit).is\_zero())\ \{}
\DoxyCodeLine{01780\ \ \ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ (show\_through)"{}};}
\DoxyCodeLine{01781\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01782\ \ \ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ (hidden)"{}};}
\DoxyCodeLine{01783\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01784\ \ \ \ \ \}}
\DoxyCodeLine{01785\ \ \ \ \ \textcolor{keywordflow}{if}\ (!(draw\_control\_mask\ \&\ \string~\_overall\_bit).is\_zero())\ \{}
\DoxyCodeLine{01786\ \ \ \ \ \ \ draw\_control\_mask\ \&=\ \string~\_overall\_bit;}
\DoxyCodeLine{01787\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(draw\_show\_mask\ \&\ draw\_control\_mask).is\_zero())\ \{}
\DoxyCodeLine{01788\ \ \ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ (per-\/camera\ show\_through)"{}};}
\DoxyCodeLine{01789\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01790\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(\string~draw\_show\_mask\ \&\ draw\_control\_mask).is\_zero())\ \{}
\DoxyCodeLine{01791\ \ \ \ \ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ (per-\/camera\ hidden)"{}};}
\DoxyCodeLine{01792\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01793\ \ \ \ \ \}}
\DoxyCodeLine{01794\ \ \ \}}
\DoxyCodeLine{01795\ \ \ out\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01796\ \}}
\DoxyCodeLine{01797\ }
\DoxyCodeLine{01812\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a6dc0db3908b2e454ac9f9d4aa7355d63}{PandaNode::}}}
\DoxyCodeLine{01813\ \mbox{\hyperlink{classPandaNode_a6dc0db3908b2e454ac9f9d4aa7355d63}{set\_bounds\_type}}(BoundingVolume::BoundsType\ bounds\_type)\ \{}
\DoxyCodeLine{01814\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01815\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01816\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01817\ \ \ \ \ cdata-\/>\_bounds\_type\ =\ bounds\_type;}
\DoxyCodeLine{01818\ \ \ \ \ mark\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01819\ }
\DoxyCodeLine{01820\ \ \ \ \ \textcolor{comment}{//\ GeomNodes,\ CollisionNodes,\ and\ PGItems\ all\ have\ an\ internal\ bounds\ that}}
\DoxyCodeLine{01821\ \ \ \ \ \textcolor{comment}{//\ may\ need\ to\ be\ updated\ when\ the\ bounds\_type\ changes.}}
\DoxyCodeLine{01822\ \ \ \ \ mark\_internal\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01823\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01824\ \ \ \}}
\DoxyCodeLine{01825\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01826\ \}}
\DoxyCodeLine{01827\ }
\DoxyCodeLine{01831\ BoundingVolume::BoundsType\ \mbox{\hyperlink{classPandaNode_a762e487a7d3378c7d4be1b7582f3d850}{PandaNode::}}}
\DoxyCodeLine{01832\ \mbox{\hyperlink{classPandaNode_a762e487a7d3378c7d4be1b7582f3d850}{get\_bounds\_type}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01833\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{01834\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_bounds\_type;}
\DoxyCodeLine{01835\ \}}
\DoxyCodeLine{01836\ }
\DoxyCodeLine{01847\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a6a40f5ea4b91b13351141d2a9bf614ff}{PandaNode::}}}
\DoxyCodeLine{01848\ \mbox{\hyperlink{classPandaNode_a6a40f5ea4b91b13351141d2a9bf614ff}{set\_bounds}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *volume)\ \{}
\DoxyCodeLine{01849\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{01850\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01851\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01852\ \ \ \ \ \textcolor{keywordflow}{if}\ (volume\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01853\ \ \ \ \ \ \ cdata-\/>\_user\_bounds\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01854\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01855\ \ \ \ \ \ \ cdata-\/>\_user\_bounds\ =\ volume-\/>make\_copy();}
\DoxyCodeLine{01856\ \ \ \ \ \}}
\DoxyCodeLine{01857\ \ \ \ \ mark\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01858\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{01859\ \ \ \}}
\DoxyCodeLine{01860\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{01861\ \}}
\DoxyCodeLine{01862\ }
\DoxyCodeLine{01868\ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ PandaNode::}
\DoxyCodeLine{01869\ get\_bounds(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01870\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01871\ \ \ CDLockedStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01872\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_bounds\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01873\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01874\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ result;}
\DoxyCodeLine{01875\ \ \ \ \ \{}
\DoxyCodeLine{01876\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01877\ \ \ \ \ \ \ CDStageWriter\ cdataw\ =}
\DoxyCodeLine{01878\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{true},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01879\ \ \ \ \ \ \ result\ =\ cdataw-\/>\_external\_bounds;}
\DoxyCodeLine{01880\ \ \ \ \ \}}
\DoxyCodeLine{01881\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01882\ \ \ \}}
\DoxyCodeLine{01883\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_external\_bounds;}
\DoxyCodeLine{01884\ \}}
\DoxyCodeLine{01885\ }
\DoxyCodeLine{01897\ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ PandaNode::}
\DoxyCodeLine{01898\ get\_bounds(\mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ \&seq,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01899\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01900\ \ \ CDLockedStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01901\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_bounds\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01902\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01903\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ result;}
\DoxyCodeLine{01904\ \ \ \ \ \{}
\DoxyCodeLine{01905\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01906\ \ \ \ \ \ \ CDStageWriter\ cdataw\ =}
\DoxyCodeLine{01907\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{true},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01908\ \ \ \ \ \ \ result\ =\ cdataw-\/>\_external\_bounds;}
\DoxyCodeLine{01909\ \ \ \ \ \ \ seq\ =\ cdataw-\/>\_last\_bounds\_update;}
\DoxyCodeLine{01910\ \ \ \ \ \}}
\DoxyCodeLine{01911\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01912\ \ \ \}}
\DoxyCodeLine{01913\ \ \ seq\ =\ cdata-\/>\_last\_bounds\_update;}
\DoxyCodeLine{01914\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_external\_bounds;}
\DoxyCodeLine{01915\ \}}
\DoxyCodeLine{01916\ }
\DoxyCodeLine{01926\ \textcolor{keywordtype}{int}\ PandaNode::}
\DoxyCodeLine{01927\ get\_nested\_vertices(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01928\ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{01929\ \ \ CDLockedStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01930\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_bounds\_update\ !=\ cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{01931\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{01932\ \ \ \ \ \textcolor{keywordtype}{int}\ result;}
\DoxyCodeLine{01933\ \ \ \ \ \{}
\DoxyCodeLine{01934\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(\_update\_bounds\_pcollector);}
\DoxyCodeLine{01935\ \ \ \ \ \ \ CDStageWriter\ cdataw\ =}
\DoxyCodeLine{01936\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>update\_cached(\textcolor{keyword}{true},\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{01937\ \ \ \ \ \ \ result\ =\ cdataw-\/>\_nested\_vertices;}
\DoxyCodeLine{01938\ \ \ \ \ \}}
\DoxyCodeLine{01939\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01940\ \ \ \}}
\DoxyCodeLine{01941\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_nested\_vertices;}
\DoxyCodeLine{01942\ \}}
\DoxyCodeLine{01943\ }
\DoxyCodeLine{01957\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{01958\ mark\_bounds\_stale(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01959\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01960\ \ \ \ \ mark\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01961\ \ \ \}}
\DoxyCodeLine{01962\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler);}
\DoxyCodeLine{01963\ \}}
\DoxyCodeLine{01964\ }
\DoxyCodeLine{01976\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{01977\ mark\_internal\_bounds\_stale(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{01978\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{01979\ \ \ \ \ mark\_internal\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{01980\ \ \ \}}
\DoxyCodeLine{01981\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler);}
\DoxyCodeLine{01982\ \}}
\DoxyCodeLine{01983\ }
\DoxyCodeLine{01992\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_a1799fcdc4d1d62fbbbb63d4dedc1bdcf}{PandaNode::}}}
\DoxyCodeLine{01993\ \mbox{\hyperlink{classPandaNode_a1799fcdc4d1d62fbbbb63d4dedc1bdcf}{is\_geom\_node}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01994\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01995\ \}}
\DoxyCodeLine{01996\ }
\DoxyCodeLine{02004\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_aacb666aa53f9c5a729e33098c8ee144b}{PandaNode::}}}
\DoxyCodeLine{02005\ \mbox{\hyperlink{classPandaNode_aacb666aa53f9c5a729e33098c8ee144b}{is\_lod\_node}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02006\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02007\ \}}
\DoxyCodeLine{02008\ }
\DoxyCodeLine{02016\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_ab86095d2dc71d5bdfbd7685fc5f062e0}{PandaNode::}}}
\DoxyCodeLine{02017\ \mbox{\hyperlink{classPandaNode_ab86095d2dc71d5bdfbd7685fc5f062e0}{is\_collision\_node}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02018\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02019\ \}}
\DoxyCodeLine{02020\ }
\DoxyCodeLine{02025\ \mbox{\hyperlink{classLight}{Light}}\ *\mbox{\hyperlink{classPandaNode_af78c62764c93b98f10de8595b5cff167}{PandaNode::}}}
\DoxyCodeLine{02026\ \mbox{\hyperlink{classPandaNode_af78c62764c93b98f10de8595b5cff167}{as\_light}}()\ \{}
\DoxyCodeLine{02027\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02028\ \}}
\DoxyCodeLine{02029\ }
\DoxyCodeLine{02034\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPandaNode_aca812e62157b67f9ff98d2f3574af92d}{PandaNode::}}}
\DoxyCodeLine{02035\ \mbox{\hyperlink{classPandaNode_aca812e62157b67f9ff98d2f3574af92d}{is\_ambient\_light}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02036\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02037\ \}}
\DoxyCodeLine{02038\ }
\DoxyCodeLine{02049\ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ PandaNode::}
\DoxyCodeLine{02050\ decode\_from\_bam\_stream(vector\_uchar\ data,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *reader)\ \{}
\DoxyCodeLine{02051\ \ \ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *object;}
\DoxyCodeLine{02052\ \ \ \mbox{\hyperlink{classReferenceCount}{ReferenceCount}}\ *ref\_ptr;}
\DoxyCodeLine{02053\ }
\DoxyCodeLine{02054\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classTypedWritable_a65c5c9a26f16735bd9b6b3fb2a3b51f6}{TypedWritable::decode\_raw\_from\_bam\_stream}}(\textcolor{keywordtype}{object},\ ref\_ptr,\ std::move(data),\ reader))\ \{}
\DoxyCodeLine{02055\ \ \ \ \ \textcolor{keywordflow}{return}\ DCAST(\mbox{\hyperlink{classPandaNode}{PandaNode}},\ \textcolor{keywordtype}{object});}
\DoxyCodeLine{02056\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02057\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02058\ \ \ \}}
\DoxyCodeLine{02059\ \}}
\DoxyCodeLine{02060\ }
\DoxyCodeLine{02065\ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ PandaNode::}
\DoxyCodeLine{02066\ get\_internal\_bounds(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02067\ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{02068\ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ mark;}
\DoxyCodeLine{02069\ \ \ \ \ \{}
\DoxyCodeLine{02070\ \ \ \ \ \ \ CDStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02071\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_user\_bounds\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_user\_bounds;}
\DoxyCodeLine{02073\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02074\ }
\DoxyCodeLine{02075\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_internal\_bounds\_mark\ ==\ cdata-\/>\_internal\_bounds\_computed)\ \{}
\DoxyCodeLine{02076\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_internal\_bounds;}
\DoxyCodeLine{02077\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02078\ }
\DoxyCodeLine{02079\ \ \ \ \ \ \ mark\ =\ cdata-\/>\_internal\_bounds\_mark;}
\DoxyCodeLine{02080\ \ \ \ \ \}}
\DoxyCodeLine{02081\ }
\DoxyCodeLine{02082\ \ \ \ \ \textcolor{comment}{//\ First,\ call\ compute\_internal\_bounds\ without\ acquiring\ the\ lock.\ \ This}}
\DoxyCodeLine{02083\ \ \ \ \ \textcolor{comment}{//\ avoids\ a\ deadlock\ condition.}}
\DoxyCodeLine{02084\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ internal\_bounds;}
\DoxyCodeLine{02085\ \ \ \ \ \textcolor{keywordtype}{int}\ internal\_vertices;}
\DoxyCodeLine{02086\ \ \ \ \ \mbox{\hyperlink{classPandaNode_a52afb8d49a98320b7975ebbbc7f18d6d}{compute\_internal\_bounds}}(internal\_bounds,\ internal\_vertices,}
\DoxyCodeLine{02087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02088\ \ \ \ \ nassertr(!internal\_bounds.is\_null(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02089\ }
\DoxyCodeLine{02090\ \ \ \ \ \textcolor{comment}{//\ Now,\ acquire\ the\ lock,\ and\ apply\ the\ above-\/computed\ bounds.}}
\DoxyCodeLine{02091\ \ \ \ \ CDStageWriter\ cdataw(((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>\_cycler,\ pipeline\_stage);}
\DoxyCodeLine{02092\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_internal\_bounds\_mark\ ==\ mark)\ \{}
\DoxyCodeLine{02093\ \ \ \ \ \ \ cdataw-\/>\_internal\_bounds\_computed\ =\ mark;}
\DoxyCodeLine{02094\ \ \ \ \ \ \ cdataw-\/>\_internal\_bounds\ =\ internal\_bounds;}
\DoxyCodeLine{02095\ \ \ \ \ \ \ cdataw-\/>\_internal\_vertices\ =\ internal\_vertices;}
\DoxyCodeLine{02096\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>mark\_bam\_modified();}
\DoxyCodeLine{02097\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_internal\_bounds;}
\DoxyCodeLine{02098\ \ \ \ \ \}}
\DoxyCodeLine{02099\ }
\DoxyCodeLine{02100\ \ \ \ \ \textcolor{comment}{//\ Dang,\ someone\ in\ another\ thread\ incremented\ \_internal\_bounds\_mark\ while}}
\DoxyCodeLine{02101\ \ \ \ \ \textcolor{comment}{//\ we\ weren't\ holding\ the\ lock.\ \ That\ means\ we\ need\ to\ go\ back\ and\ do\ it}}
\DoxyCodeLine{02102\ \ \ \ \ \textcolor{comment}{//\ again.}}
\DoxyCodeLine{02103\ \ \ \}}
\DoxyCodeLine{02104\ \}}
\DoxyCodeLine{02105\ }
\DoxyCodeLine{02112\ \textcolor{keywordtype}{int}\ PandaNode::}
\DoxyCodeLine{02113\ get\_internal\_vertices(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02114\ \ \ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true})\ \{}
\DoxyCodeLine{02115\ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ mark;}
\DoxyCodeLine{02116\ \ \ \ \ \{}
\DoxyCodeLine{02117\ \ \ \ \ \ \ CDStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02118\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_internal\_bounds\_mark\ ==\ cdata-\/>\_internal\_bounds\_computed)\ \{}
\DoxyCodeLine{02119\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_internal\_vertices;}
\DoxyCodeLine{02120\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02121\ }
\DoxyCodeLine{02122\ \ \ \ \ \ \ mark\ =\ cdata-\/>\_internal\_bounds\_mark;}
\DoxyCodeLine{02123\ \ \ \ \ \}}
\DoxyCodeLine{02124\ }
\DoxyCodeLine{02125\ \ \ \ \ \textcolor{comment}{//\ First,\ call\ compute\_internal\_bounds\ without\ acquiring\ the\ lock.\ \ This}}
\DoxyCodeLine{02126\ \ \ \ \ \textcolor{comment}{//\ avoids\ a\ deadlock\ condition.}}
\DoxyCodeLine{02127\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ internal\_bounds;}
\DoxyCodeLine{02128\ \ \ \ \ \textcolor{keywordtype}{int}\ internal\_vertices;}
\DoxyCodeLine{02129\ \ \ \ \ \mbox{\hyperlink{classPandaNode_a52afb8d49a98320b7975ebbbc7f18d6d}{compute\_internal\_bounds}}(internal\_bounds,\ internal\_vertices,}
\DoxyCodeLine{02130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02131\ \ \ \ \ nassertr(!internal\_bounds.is\_null(),\ 0);}
\DoxyCodeLine{02132\ }
\DoxyCodeLine{02133\ \ \ \ \ \textcolor{comment}{//\ Now,\ acquire\ the\ lock,\ and\ apply\ the\ above-\/computed\ bounds.}}
\DoxyCodeLine{02134\ \ \ \ \ CDStageWriter\ cdataw(((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>\_cycler,\ pipeline\_stage);}
\DoxyCodeLine{02135\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_internal\_bounds\_mark\ ==\ mark)\ \{}
\DoxyCodeLine{02136\ \ \ \ \ \ \ cdataw-\/>\_internal\_bounds\_computed\ =\ mark;}
\DoxyCodeLine{02137\ \ \ \ \ \ \ cdataw-\/>\_internal\_bounds\ =\ internal\_bounds;}
\DoxyCodeLine{02138\ \ \ \ \ \ \ cdataw-\/>\_internal\_vertices\ =\ internal\_vertices;}
\DoxyCodeLine{02139\ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\textcolor{keyword}{this})-\/>mark\_bam\_modified();}
\DoxyCodeLine{02140\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw-\/>\_internal\_vertices;}
\DoxyCodeLine{02141\ \ \ \ \ \}}
\DoxyCodeLine{02142\ }
\DoxyCodeLine{02143\ \ \ \ \ \textcolor{comment}{//\ Dang,\ someone\ in\ another\ thread\ incremented\ \_internal\_bounds\_mark\ while}}
\DoxyCodeLine{02144\ \ \ \ \ \textcolor{comment}{//\ we\ weren't\ holding\ the\ lock.\ \ That\ means\ we\ need\ to\ go\ back\ and\ do\ it}}
\DoxyCodeLine{02145\ \ \ \ \ \textcolor{comment}{//\ again.}}
\DoxyCodeLine{02146\ \ \ \}}
\DoxyCodeLine{02147\ \}}
\DoxyCodeLine{02148\ }
\DoxyCodeLine{02155\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02156\ set\_internal\_bounds(\textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *volume)\ \{}
\DoxyCodeLine{02157\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{02158\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02159\ \ \ \ \ CDStageWriter\ cdataw(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02160\ \ \ \ \ cdataw-\/>\_internal\_bounds\ =\ volume;}
\DoxyCodeLine{02161\ \ \ \ \ cdataw-\/>\_internal\_bounds\_computed\ =\ cdataw-\/>\_internal\_bounds\_mark;}
\DoxyCodeLine{02162\ \ \ \}}
\DoxyCodeLine{02163\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{02164\ \ \ mark\_bounds\_stale(current\_thread);}
\DoxyCodeLine{02165\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{02166\ \}}
\DoxyCodeLine{02167\ }
\DoxyCodeLine{02175\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{PandaNode::}}}
\DoxyCodeLine{02176\ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02177\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02178\ \ \ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02179\ \ \ \}}
\DoxyCodeLine{02180\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM\_NOLOCK(\_cycler);}
\DoxyCodeLine{02181\ \}}
\DoxyCodeLine{02182\ }
\DoxyCodeLine{02187\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{PandaNode::}}}
\DoxyCodeLine{02188\ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02189\ \ \ \{}
\DoxyCodeLine{02190\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02191\ \ \ \ \ ++cdata-\/>\_next\_update;}
\DoxyCodeLine{02192\ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{02193\ }
\DoxyCodeLine{02194\ \ \ \ \ \textcolor{comment}{//\ It\ is\ important\ that\ we\ allow\ this\ lock\ to\ be\ dropped\ before\ we}}
\DoxyCodeLine{02195\ \ \ \ \ \textcolor{comment}{//\ continue\ up\ the\ graph;\ otherwise,\ we\ risk\ deadlock\ from\ another\ thread}}
\DoxyCodeLine{02196\ \ \ \ \ \textcolor{comment}{//\ walking\ down\ the\ graph.}}
\DoxyCodeLine{02197\ \ \ \}}
\DoxyCodeLine{02198\ }
\DoxyCodeLine{02199\ \ \ \textcolor{comment}{//\ It\ is\ similarly\ important\ that\ we\ use\ get\_parents()\ here\ to\ copy\ the}}
\DoxyCodeLine{02200\ \ \ \textcolor{comment}{//\ parents\ list,\ instead\ of\ keeping\ the\ lock\ open\ while\ we\ walk\ through\ the}}
\DoxyCodeLine{02201\ \ \ \textcolor{comment}{//\ parents\ list\ directly\ on\ the\ node.}}
\DoxyCodeLine{02202\ \ \ Parents\ parents;}
\DoxyCodeLine{02203\ \ \ \{}
\DoxyCodeLine{02204\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageReader}{CDStageReader}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02205\ \ \ \ \ parents\ =\ Parents(cdata);}
\DoxyCodeLine{02206\ \ \ \}}
\DoxyCodeLine{02207\ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ parents.get\_num\_parents();}
\DoxyCodeLine{02208\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_parents;\ ++i)\ \{}
\DoxyCodeLine{02209\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\ =\ parents.get\_parent(i);}
\DoxyCodeLine{02210\ \ \ \ \ parent-\/>mark\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02211\ \ \ \}}
\DoxyCodeLine{02212\ \}}
\DoxyCodeLine{02213\ }
\DoxyCodeLine{02218\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aa41e720c22111481fb0964d20596d036}{PandaNode::}}}
\DoxyCodeLine{02219\ \mbox{\hyperlink{classPandaNode_aa41e720c22111481fb0964d20596d036}{r\_mark\_geom\_bounds\_stale}}(\mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02220\ \ \ Children\ children\ =\ get\_children(current\_thread);}
\DoxyCodeLine{02221\ }
\DoxyCodeLine{02222\ \ \ \textcolor{keywordtype}{size\_t}\ i;}
\DoxyCodeLine{02223\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ children.get\_num\_children();\ i++)\ \{}
\DoxyCodeLine{02224\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ children.get\_child(i);}
\DoxyCodeLine{02225\ \ \ \ \ child-\/>\mbox{\hyperlink{classPandaNode_aa41e720c22111481fb0964d20596d036}{r\_mark\_geom\_bounds\_stale}}(current\_thread);}
\DoxyCodeLine{02226\ \ \ \}}
\DoxyCodeLine{02227\ }
\DoxyCodeLine{02228\ \ \ Stashed\ stashed\ =\ get\_stashed(current\_thread);}
\DoxyCodeLine{02229\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ stashed.get\_num\_stashed();\ i++)\ \{}
\DoxyCodeLine{02230\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ stashed.get\_stashed(i);}
\DoxyCodeLine{02231\ \ \ \ \ child-\/>\mbox{\hyperlink{classPandaNode_aa41e720c22111481fb0964d20596d036}{r\_mark\_geom\_bounds\_stale}}(current\_thread);}
\DoxyCodeLine{02232\ \ \ \}}
\DoxyCodeLine{02233\ \}}
\DoxyCodeLine{02234\ }
\DoxyCodeLine{02240\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a52afb8d49a98320b7975ebbbc7f18d6d}{PandaNode::}}}
\DoxyCodeLine{02241\ \mbox{\hyperlink{classPandaNode_a52afb8d49a98320b7975ebbbc7f18d6d}{compute\_internal\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&internal\_bounds,}
\DoxyCodeLine{02242\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \&internal\_vertices,}
\DoxyCodeLine{02243\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02244\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02245\ \ \ internal\_bounds\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{02246\ \ \ internal\_vertices\ =\ 0;}
\DoxyCodeLine{02247\ \}}
\DoxyCodeLine{02248\ }
\DoxyCodeLine{02254\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a30812b7fdc5ee30feaa4c939b3f48330}{PandaNode::}}}
\DoxyCodeLine{02255\ \mbox{\hyperlink{classPandaNode_a30812b7fdc5ee30feaa4c939b3f48330}{compute\_external\_bounds}}(CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ \&external\_bounds,}
\DoxyCodeLine{02256\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ BoundingVolume::BoundsType\ btype,}
\DoxyCodeLine{02257\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **volumes,\ \textcolor{keywordtype}{size\_t}\ num\_volumes,}
\DoxyCodeLine{02258\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02259\ }
\DoxyCodeLine{02260\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ transform\ =\ get\_transform(current\_thread);}
\DoxyCodeLine{02261\ \ \ PT(\mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}})\ gbv;}
\DoxyCodeLine{02262\ }
\DoxyCodeLine{02263\ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_box)\ \{}
\DoxyCodeLine{02264\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}};}
\DoxyCodeLine{02265\ \ \ \}}
\DoxyCodeLine{02266\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_sphere\ ||\ !transform-\/>is\_identity())\ \{}
\DoxyCodeLine{02267\ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{02268\ \ \ \}}
\DoxyCodeLine{02269\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02270\ \ \ \ \ \textcolor{comment}{//\ If\ all\ of\ the\ child\ volumes\ are\ a\ BoundingBox,\ and\ we\ have\ no}}
\DoxyCodeLine{02271\ \ \ \ \ \textcolor{comment}{//\ transform,\ then\ our\ volume\ is\ also\ a\ BoundingBox.}}
\DoxyCodeLine{02272\ \ \ \ \ \textcolor{keywordtype}{bool}\ all\_box\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02273\ }
\DoxyCodeLine{02274\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_volumes;\ ++i)\ \{}
\DoxyCodeLine{02275\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (volumes[i]-\/>as\_bounding\_box()\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02276\ \ \ \ \ \ \ \ \ all\_box\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02277\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02278\ \ \ \ \ \}}
\DoxyCodeLine{02279\ }
\DoxyCodeLine{02280\ \ \ \ \ \textcolor{keywordflow}{if}\ (all\_box)\ \{}
\DoxyCodeLine{02281\ \ \ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingBox}{BoundingBox}};}
\DoxyCodeLine{02282\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02283\ \ \ \ \ \ \ gbv\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}};}
\DoxyCodeLine{02284\ \ \ \ \ \}}
\DoxyCodeLine{02285\ \ \ \}}
\DoxyCodeLine{02286\ }
\DoxyCodeLine{02287\ \ \ \textcolor{keywordflow}{if}\ (num\_volumes\ >\ 0)\ \{}
\DoxyCodeLine{02288\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **child\_begin\ =\ \&volumes[0];}
\DoxyCodeLine{02289\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **child\_end\ =\ child\_begin\ +\ num\_volumes;}
\DoxyCodeLine{02290\ \ \ \ \ ((\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *)gbv)-\/>\mbox{\hyperlink{classBoundingVolume_ae04587b004219dadc7e109a4fbc6ea76}{around}}(child\_begin,\ child\_end);}
\DoxyCodeLine{02291\ }
\DoxyCodeLine{02292\ \ \ \ \ \textcolor{comment}{//\ If\ we\ have\ a\ transform,\ apply\ it\ to\ the\ bounding\ volume\ we\ just}}
\DoxyCodeLine{02293\ \ \ \ \ \textcolor{comment}{//\ computed.}}
\DoxyCodeLine{02294\ \ \ \ \ \textcolor{keywordflow}{if}\ (!transform-\/>is\_identity())\ \{}
\DoxyCodeLine{02295\ \ \ \ \ \ \ gbv-\/>xform(transform-\/>get\_mat());}
\DoxyCodeLine{02296\ \ \ \ \ \}}
\DoxyCodeLine{02297\ \ \ \}}
\DoxyCodeLine{02298\ }
\DoxyCodeLine{02299\ \ \ external\_bounds\ =\ gbv;}
\DoxyCodeLine{02300\ \}}
\DoxyCodeLine{02301\ }
\DoxyCodeLine{02307\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{PandaNode::}}}
\DoxyCodeLine{02308\ \mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}()\ \{}
\DoxyCodeLine{02309\ \ \ nassertv((\_unexpected\_change\_flags\ \&\ UC\_parents)\ ==\ 0);}
\DoxyCodeLine{02310\ \}}
\DoxyCodeLine{02311\ }
\DoxyCodeLine{02317\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{PandaNode::}}}
\DoxyCodeLine{02318\ \mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}()\ \{}
\DoxyCodeLine{02319\ \ \ nassertv((\_unexpected\_change\_flags\ \&\ UC\_children)\ ==\ 0);}
\DoxyCodeLine{02320\ \}}
\DoxyCodeLine{02321\ }
\DoxyCodeLine{02327\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a28a4ed8dab3b2bcd2a686712b9e391d6}{PandaNode::}}}
\DoxyCodeLine{02328\ \mbox{\hyperlink{classPandaNode_a28a4ed8dab3b2bcd2a686712b9e391d6}{transform\_changed}}()\ \{}
\DoxyCodeLine{02329\ \ \ nassertv((\_unexpected\_change\_flags\ \&\ UC\_transform)\ ==\ 0);}
\DoxyCodeLine{02330\ \}}
\DoxyCodeLine{02331\ }
\DoxyCodeLine{02337\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{PandaNode::}}}
\DoxyCodeLine{02338\ \mbox{\hyperlink{classPandaNode_aa4a7c5577bbca5a5fd8951ab08a3faa0}{state\_changed}}()\ \{}
\DoxyCodeLine{02339\ \ \ nassertv((\_unexpected\_change\_flags\ \&\ UC\_state)\ ==\ 0);}
\DoxyCodeLine{02340\ \}}
\DoxyCodeLine{02341\ }
\DoxyCodeLine{02346\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_aecf925ac58ff33505254da07c194338c}{PandaNode::}}}
\DoxyCodeLine{02347\ \mbox{\hyperlink{classPandaNode_aecf925ac58ff33505254da07c194338c}{draw\_mask\_changed}}()\ \{}
\DoxyCodeLine{02348\ \ \ nassertv((\_unexpected\_change\_flags\ \&\ UC\_draw\_mask)\ ==\ 0);}
\DoxyCodeLine{02349\ \}}
\DoxyCodeLine{02350\ }
\DoxyCodeLine{02359\ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ PandaNode::}
\DoxyCodeLine{02360\ r\_copy\_subgraph(\mbox{\hyperlink{classpmap}{PandaNode::InstanceMap}}\ \&inst\_map,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{02361\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ copy\ =\ make\_copy();}
\DoxyCodeLine{02362\ \ \ nassertr(copy\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02363\ \ \ \textcolor{keywordflow}{if}\ (copy-\/>get\_type()\ !=\ get\_type())\ \{}
\DoxyCodeLine{02364\ \ \ \ \ pgraph\_cat.warning()}
\DoxyCodeLine{02365\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Don't\ know\ how\ to\ copy\ nodes\ of\ type\ "{}}\ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02366\ }
\DoxyCodeLine{02367\ \ \ \ \ \textcolor{keywordflow}{if}\ (no\_unsupported\_copy)\ \{}
\DoxyCodeLine{02368\ \ \ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}unsupported\ copy"{}});}
\DoxyCodeLine{02369\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02370\ \ \ \ \ \}}
\DoxyCodeLine{02371\ \ \ \}}
\DoxyCodeLine{02372\ }
\DoxyCodeLine{02373\ \ \ copy-\/>r\_copy\_children(\textcolor{keyword}{this},\ inst\_map,\ current\_thread);}
\DoxyCodeLine{02374\ \ \ \textcolor{keywordflow}{return}\ copy;}
\DoxyCodeLine{02375\ \}}
\DoxyCodeLine{02376\ }
\DoxyCodeLine{02387\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02388\ r\_copy\_children(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *from,\ \mbox{\hyperlink{classpmap}{PandaNode::InstanceMap}}\ \&inst\_map,}
\DoxyCodeLine{02389\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02390\ \ \ CDReader\ from\_cdata(from-\/>\_cycler,\ current\_thread);}
\DoxyCodeLine{02391\ \ \ CPT(Down)\ from\_down\ =\ from\_cdata-\/>get\_down();}
\DoxyCodeLine{02392\ \ \ Down::const\_iterator\ di;}
\DoxyCodeLine{02393\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ from\_down-\/>begin();\ di\ !=\ from\_down-\/>end();\ ++di)\ \{}
\DoxyCodeLine{02394\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ (*di).get\_sort();}
\DoxyCodeLine{02395\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *source\_child\ =\ (*di).get\_child();}
\DoxyCodeLine{02396\ \ \ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ dest\_child;}
\DoxyCodeLine{02397\ }
\DoxyCodeLine{02398\ \ \ \ \ \textcolor{comment}{//\ Check\ to\ see\ if\ we\ have\ already\ copied\ this\ child.\ \ If\ we\ have,\ use\ the}}
\DoxyCodeLine{02399\ \ \ \ \ \textcolor{comment}{//\ copy.\ \ In\ this\ way,\ a\ subgraph\ that\ contains\ instances\ will\ be}}
\DoxyCodeLine{02400\ \ \ \ \ \textcolor{comment}{//\ correctly\ duplicated\ into\ another\ subgraph\ that\ also\ contains\ its\ own}}
\DoxyCodeLine{02401\ \ \ \ \ \textcolor{comment}{//\ instances.}}
\DoxyCodeLine{02402\ \ \ \ \ InstanceMap::const\_iterator\ ci;}
\DoxyCodeLine{02403\ \ \ \ \ ci\ =\ inst\_map.find(source\_child);}
\DoxyCodeLine{02404\ \ \ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ inst\_map.end())\ \{}
\DoxyCodeLine{02405\ \ \ \ \ \ \ dest\_child\ =\ (*ci).second;}
\DoxyCodeLine{02406\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02407\ \ \ \ \ \ \ dest\_child\ =\ source\_child-\/>r\_copy\_subgraph(inst\_map,\ current\_thread);}
\DoxyCodeLine{02408\ \ \ \ \ \ \ inst\_map[source\_child]\ =\ dest\_child;}
\DoxyCodeLine{02409\ \ \ \ \ \}}
\DoxyCodeLine{02410\ }
\DoxyCodeLine{02411\ \ \ \ \ quick\_add\_new\_child(dest\_child,\ sort,\ current\_thread);}
\DoxyCodeLine{02412\ \ \ \}}
\DoxyCodeLine{02413\ \}}
\DoxyCodeLine{02414\ }
\DoxyCodeLine{02419\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{PandaNode::}}}
\DoxyCodeLine{02420\ \mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{r\_prepare\_scene}}(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *node\_state,}
\DoxyCodeLine{02421\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGeomTransformer}{GeomTransformer}}\ \&transformer,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02422\ \ \ Children\ children\ =\ get\_children(current\_thread);}
\DoxyCodeLine{02423\ \ \ \textcolor{comment}{//\ We\ must\ call\ get\_num\_children()\ each\ time\ through\ the\ loop,\ in\ case\ we're}}
\DoxyCodeLine{02424\ \ \ \textcolor{comment}{//\ running\ SIMPLE\_THREADS\ and\ we\ get\ interrupted.}}
\DoxyCodeLine{02425\ \ \ \textcolor{keywordtype}{size\_t}\ i;}
\DoxyCodeLine{02426\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ children.get\_num\_children();\ i++)\ \{}
\DoxyCodeLine{02427\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ children.get\_child(i);}
\DoxyCodeLine{02428\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ child\_state\ =\ node\_state-\/>compose(child-\/>get\_state());}
\DoxyCodeLine{02429\ \ \ \ \ child-\/>\mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{r\_prepare\_scene}}(gsg,\ child\_state,\ transformer,\ current\_thread);}
\DoxyCodeLine{02430\ \ \ \}}
\DoxyCodeLine{02431\ }
\DoxyCodeLine{02432\ \ \ Stashed\ stashed\ =\ get\_stashed(current\_thread);}
\DoxyCodeLine{02433\ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ stashed.get\_num\_stashed();\ i++)\ \{}
\DoxyCodeLine{02434\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ stashed.get\_stashed(i);}
\DoxyCodeLine{02435\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ child\_state\ =\ node\_state-\/>compose(child-\/>get\_state());}
\DoxyCodeLine{02436\ \ \ \ \ child-\/>\mbox{\hyperlink{classPandaNode_a6406573ccb15db492df630f334448b31}{r\_prepare\_scene}}(gsg,\ child\_state,\ transformer,\ current\_thread);}
\DoxyCodeLine{02437\ \ \ \}}
\DoxyCodeLine{02438\ \}}
\DoxyCodeLine{02439\ }
\DoxyCodeLine{02445\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a7d1a687dc24b5882b0da4a2908018ec3}{PandaNode::}}}
\DoxyCodeLine{02446\ \mbox{\hyperlink{classPandaNode_a7d1a687dc24b5882b0da4a2908018ec3}{set\_cull\_callback}}()\ \{}
\DoxyCodeLine{02447\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{02448\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02449\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02450\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_cull\_callback,\ \textcolor{keyword}{true});}
\DoxyCodeLine{02451\ \ \ \}}
\DoxyCodeLine{02452\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{02453\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{02454\ \}}
\DoxyCodeLine{02455\ }
\DoxyCodeLine{02459\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_adb811bf1c32d02d71b8d7296138ca366}{PandaNode::}}}
\DoxyCodeLine{02460\ \mbox{\hyperlink{classPandaNode_adb811bf1c32d02d71b8d7296138ca366}{disable\_cull\_callback}}()\ \{}
\DoxyCodeLine{02461\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{02462\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02463\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02464\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_cull\_callback,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02465\ \ \ \}}
\DoxyCodeLine{02466\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{02467\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{02468\ \}}
\DoxyCodeLine{02469\ }
\DoxyCodeLine{02478\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_acab0226d40fa5acd75f33cfb5657833f}{PandaNode::}}}
\DoxyCodeLine{02479\ \mbox{\hyperlink{classPandaNode_acab0226d40fa5acd75f33cfb5657833f}{set\_renderable}}()\ \{}
\DoxyCodeLine{02480\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{02481\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02482\ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{CDStageWriter}}\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02483\ \ \ \ \ cdata-\/>set\_fancy\_bit(FB\_renderable,\ \textcolor{keyword}{true});}
\DoxyCodeLine{02484\ \ \ \}}
\DoxyCodeLine{02485\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{02486\ \}}
\DoxyCodeLine{02487\ }
\DoxyCodeLine{02492\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{02493\ stage\_remove\_child(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02494\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02495\ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02496\ }
\DoxyCodeLine{02497\ \ \ \textcolor{comment}{//\ First,\ look\ for\ the\ parent\ in\ the\ child's\ up\ list,\ to\ ensure\ the\ child\ is}}
\DoxyCodeLine{02498\ \ \ \textcolor{comment}{//\ known.}}
\DoxyCodeLine{02499\ \ \ CDStageWriter\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,}
\DoxyCodeLine{02500\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_thread);}
\DoxyCodeLine{02501\ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ child\_node-\/>do\_find\_parent(\textcolor{keyword}{this},\ cdata\_child);}
\DoxyCodeLine{02502\ \ \ \textcolor{keywordflow}{if}\ (parent\_index\ <\ 0)\ \{}
\DoxyCodeLine{02503\ \ \ \ \ \textcolor{comment}{//\ Nope,\ no\ relation.}}
\DoxyCodeLine{02504\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02505\ \ \ \}}
\DoxyCodeLine{02506\ }
\DoxyCodeLine{02507\ \ \ PT(Down)\ down\ =\ cdata-\/>modify\_down();}
\DoxyCodeLine{02508\ \ \ \textcolor{keywordtype}{int}\ child\_index\ =\ do\_find\_child(child\_node,\ down);}
\DoxyCodeLine{02509\ \ \ \textcolor{keywordflow}{if}\ (child\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02510\ \ \ \ \ \textcolor{comment}{//\ The\ child\ exists;\ remove\ it.}}
\DoxyCodeLine{02511\ \ \ \ \ down-\/>erase(down-\/>begin()\ +\ child\_index);}
\DoxyCodeLine{02512\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{02513\ \ \ \ \ nassertr(num\_erased\ ==\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02514\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02515\ \ \ \}}
\DoxyCodeLine{02516\ }
\DoxyCodeLine{02517\ \ \ PT(Down)\ stashed\ =\ cdata-\/>modify\_stashed();}
\DoxyCodeLine{02518\ \ \ \textcolor{keywordtype}{int}\ stashed\_index\ =\ do\_find\_child(child\_node,\ stashed);}
\DoxyCodeLine{02519\ \ \ \textcolor{keywordflow}{if}\ (stashed\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02520\ \ \ \ \ \textcolor{comment}{//\ The\ child\ has\ been\ stashed;\ remove\ it.}}
\DoxyCodeLine{02521\ \ \ \ \ stashed-\/>erase(stashed-\/>begin()\ +\ stashed\_index);}
\DoxyCodeLine{02522\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{02523\ \ \ \ \ nassertr(num\_erased\ ==\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02524\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02525\ \ \ \}}
\DoxyCodeLine{02526\ }
\DoxyCodeLine{02527\ \ \ \textcolor{comment}{//\ Never\ heard\ of\ this\ child.\ \ This\ shouldn't\ be\ possible,\ because\ the}}
\DoxyCodeLine{02528\ \ \ \textcolor{comment}{//\ parent\ was\ in\ the\ child's\ up\ list,\ above.\ \ Must\ be\ some\ internal\ error.}}
\DoxyCodeLine{02529\ \ \ nassertr(\textcolor{keyword}{false},\ \textcolor{keyword}{false});}
\DoxyCodeLine{02530\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02531\ \}}
\DoxyCodeLine{02532\ }
\DoxyCodeLine{02537\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{02538\ stage\_replace\_child(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *orig\_child,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *new\_child,}
\DoxyCodeLine{02539\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02540\ \ \ \{}
\DoxyCodeLine{02541\ \ \ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02542\ \ \ \ \ CDStageWriter\ cdata\_orig\_child(orig\_child-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02543\ \ \ \ \ CDStageWriter\ cdata\_new\_child(new\_child-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02544\ }
\DoxyCodeLine{02545\ \ \ \ \ \textcolor{comment}{//\ First,\ look\ for\ the\ parent\ in\ the\ child's\ up\ list,\ to\ ensure\ the\ child}}
\DoxyCodeLine{02546\ \ \ \ \ \textcolor{comment}{//\ is\ known.}}
\DoxyCodeLine{02547\ \ \ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ orig\_child-\/>do\_find\_parent(\textcolor{keyword}{this},\ cdata\_orig\_child);}
\DoxyCodeLine{02548\ \ \ \ \ \textcolor{keywordflow}{if}\ (parent\_index\ <\ 0)\ \{}
\DoxyCodeLine{02549\ \ \ \ \ \ \ \textcolor{comment}{//\ Nope,\ no\ relation.}}
\DoxyCodeLine{02550\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02551\ \ \ \ \ \}}
\DoxyCodeLine{02552\ }
\DoxyCodeLine{02553\ \ \ \ \ \textcolor{keywordflow}{if}\ (orig\_child\ ==\ new\_child)\ \{}
\DoxyCodeLine{02554\ \ \ \ \ \ \ \textcolor{comment}{//\ Trivial\ no-\/op.}}
\DoxyCodeLine{02555\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02556\ \ \ \ \ \}}
\DoxyCodeLine{02557\ }
\DoxyCodeLine{02558\ \ \ \ \ \textcolor{comment}{//\ Don't\ let\ orig\_child\ be\ destructed\ yet.}}
\DoxyCodeLine{02559\ \ \ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ keep\_orig\_child\ =\ orig\_child;}
\DoxyCodeLine{02560\ }
\DoxyCodeLine{02561\ \ \ \ \ \textcolor{comment}{//\ If\ we\ already\ have\ new\_child\ as\ a\ child,\ remove\ it\ first.}}
\DoxyCodeLine{02562\ \ \ \ \ \textcolor{keywordflow}{if}\ (stage\_remove\_child(new\_child,\ pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{02563\ \ \ \ \ \ \ sever\_connection(\textcolor{keyword}{this},\ new\_child,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02564\ \ \ \ \ \}}
\DoxyCodeLine{02565\ }
\DoxyCodeLine{02566\ \ \ \ \ PT(Down)\ down\ =\ cdata-\/>modify\_down();}
\DoxyCodeLine{02567\ \ \ \ \ \textcolor{keywordtype}{int}\ child\_index\ =\ do\_find\_child(orig\_child,\ down);}
\DoxyCodeLine{02568\ \ \ \ \ \textcolor{keywordflow}{if}\ (child\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02569\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ child\ exists;\ replace\ it.}}
\DoxyCodeLine{02570\ \ \ \ \ \ \ DownConnection\ \&dc\ =\ (*down)[child\_index];}
\DoxyCodeLine{02571\ \ \ \ \ \ \ nassertr(dc.get\_child()\ ==\ orig\_child,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02572\ \ \ \ \ \ \ dc.set\_child(new\_child);}
\DoxyCodeLine{02573\ }
\DoxyCodeLine{02574\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02575\ \ \ \ \ \ \ PT(Down)\ stashed\ =\ cdata-\/>modify\_stashed();}
\DoxyCodeLine{02576\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ stashed\_index\ =\ do\_find\_child(orig\_child,\ stashed);}
\DoxyCodeLine{02577\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (stashed\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02578\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ child\ has\ been\ stashed;\ remove\ it.}}
\DoxyCodeLine{02579\ \ \ \ \ \ \ \ \ DownConnection\ \&dc\ =\ (*stashed)[stashed\_index];}
\DoxyCodeLine{02580\ \ \ \ \ \ \ \ \ nassertr(dc.get\_child()\ ==\ orig\_child,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02581\ \ \ \ \ \ \ \ \ dc.set\_child(new\_child);}
\DoxyCodeLine{02582\ }
\DoxyCodeLine{02583\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02584\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Never\ heard\ of\ this\ child.\ \ This\ shouldn't\ be\ possible,\ because\ the}}
\DoxyCodeLine{02585\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ parent\ was\ in\ the\ child's\ up\ list,\ above.\ \ Must\ be\ some\ internal}}
\DoxyCodeLine{02586\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ error.}}
\DoxyCodeLine{02587\ \ \ \ \ \ \ \ \ nassertr(\textcolor{keyword}{false},\ \textcolor{keyword}{false});}
\DoxyCodeLine{02588\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02589\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02590\ \ \ \ \ \}}
\DoxyCodeLine{02591\ }
\DoxyCodeLine{02592\ \ \ \ \ \textcolor{comment}{//\ Now\ adjust\ the\ bookkeeping\ on\ both\ children.}}
\DoxyCodeLine{02593\ \ \ \ \ cdata\_new\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{02594\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ cdata\_orig\_child-\/>modify\_up()-\/>erase(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{02595\ \ \ \ \ nassertr(num\_erased\ ==\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02596\ \ \ \}}
\DoxyCodeLine{02597\ }
\DoxyCodeLine{02598\ \ \ sever\_connection(\textcolor{keyword}{this},\ orig\_child,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02599\ \ \ new\_connection(\textcolor{keyword}{this},\ new\_child,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02600\ }
\DoxyCodeLine{02601\ \ \ \mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02602\ \ \ orig\_child-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{02603\ \ \ new\_child-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{02604\ \ \ mark\_bam\_modified();}
\DoxyCodeLine{02605\ \ \ orig\_child-\/>mark\_bam\_modified();}
\DoxyCodeLine{02606\ \ \ new\_child-\/>mark\_bam\_modified();}
\DoxyCodeLine{02607\ }
\DoxyCodeLine{02608\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02609\ \}}
\DoxyCodeLine{02610\ }
\DoxyCodeLine{02617\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02618\ quick\_add\_new\_child(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{int}\ sort,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02619\ \ \ \textcolor{comment}{//\ Apply\ this\ operation\ to\ the\ current\ stage\ as\ well\ as\ to\ all\ upstream}}
\DoxyCodeLine{02620\ \ \ \textcolor{comment}{//\ stages.}}
\DoxyCodeLine{02621\ \ \ OPEN\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler,\ current\_thread)\ \{}
\DoxyCodeLine{02622\ \ \ \ \ CDStageWriter\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02623\ \ \ \ \ CDStageWriter\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02624\ }
\DoxyCodeLine{02625\ \ \ \ \ cdata-\/>modify\_down()-\/>insert(DownConnection(child\_node,\ sort));}
\DoxyCodeLine{02626\ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(\textcolor{keyword}{this}));}
\DoxyCodeLine{02627\ \ \ \}}
\DoxyCodeLine{02628\ \ \ CLOSE\_ITERATE\_CURRENT\_AND\_UPSTREAM(\_cycler);}
\DoxyCodeLine{02629\ \}}
\DoxyCodeLine{02630\ }
\DoxyCodeLine{02634\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02635\ report\_cycle(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node)\ \{}
\DoxyCodeLine{02636\ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{ostringstream}}\ strm;}
\DoxyCodeLine{02637\ \ \ strm\ <<\ \textcolor{stringliteral}{"{}Detected\ attempt\ to\ create\ a\ cycle\ in\ the\ scene\ graph:\ "{}}}
\DoxyCodeLine{02638\ \ \ \ \ \ \ \ <<\ NodePath::any\_path(\textcolor{keyword}{this})\ <<\ \textcolor{stringliteral}{"{}\ :\ "{}}\ <<\ *child\_node;}
\DoxyCodeLine{02639\ \ \ nassert\_raise(strm.str());}
\DoxyCodeLine{02640\ \}}
\DoxyCodeLine{02641\ }
\DoxyCodeLine{02646\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{02647\ find\_node\_above(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node)\ \{}
\DoxyCodeLine{02648\ \ \ \textcolor{keywordflow}{if}\ (node\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{02649\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02650\ \ \ \}}
\DoxyCodeLine{02651\ }
\DoxyCodeLine{02652\ \ \ Parents\ parents\ =\ get\_parents();}
\DoxyCodeLine{02653\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ parents.get\_num\_parents();\ ++i)\ \{}
\DoxyCodeLine{02654\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\ =\ parents.get\_parent(i);}
\DoxyCodeLine{02655\ \ \ \ \ \textcolor{keywordflow}{if}\ (parent-\/>find\_node\_above(node))\ \{}
\DoxyCodeLine{02656\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02657\ \ \ \ \ \}}
\DoxyCodeLine{02658\ \ \ \}}
\DoxyCodeLine{02659\ }
\DoxyCodeLine{02660\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02661\ \}}
\DoxyCodeLine{02662\ }
\DoxyCodeLine{02671\ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ PandaNode::}
\DoxyCodeLine{02672\ attach(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *parent,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{int}\ sort,}
\DoxyCodeLine{02673\ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02674\ \ \ \textcolor{keywordflow}{if}\ (parent\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02675\ \ \ \ \ \textcolor{comment}{//\ Attaching\ to\ NULL\ means\ to\ create\ a\ new\ "{}instance"{}\ with\ no\ attachments,}}
\DoxyCodeLine{02676\ \ \ \ \ \textcolor{comment}{//\ and\ no\ questions\ asked.}}
\DoxyCodeLine{02677\ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ child\ =}
\DoxyCodeLine{02678\ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}(child\_node,\ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{02679\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02680\ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{02681\ \ \ \ \ child\_node-\/>\_paths.insert(child);}
\DoxyCodeLine{02682\ \ \ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02683\ \ \ \}}
\DoxyCodeLine{02684\ }
\DoxyCodeLine{02685\ \ \ \textcolor{comment}{//\ See\ if\ the\ child\ was\ already\ attached\ to\ the\ parent.\ \ If\ it\ was,\ we'll}}
\DoxyCodeLine{02686\ \ \ \textcolor{comment}{//\ use\ that\ same\ NodePathComponent.}}
\DoxyCodeLine{02687\ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ child\ =\ get\_component(parent,\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02688\ }
\DoxyCodeLine{02689\ \ \ \textcolor{keywordflow}{if}\ (child\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02690\ \ \ \ \ \textcolor{comment}{//\ The\ child\ was\ not\ already\ attached\ to\ the\ parent,\ so\ get\ a\ new}}
\DoxyCodeLine{02691\ \ \ \ \ \textcolor{comment}{//\ component.}}
\DoxyCodeLine{02692\ \ \ \ \ child\ =\ get\_top\_component(child\_node,\ \textcolor{keyword}{true},\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02693\ \ \ \}}
\DoxyCodeLine{02694\ }
\DoxyCodeLine{02695\ \ \ reparent(parent,\ child,\ sort,\ \textcolor{keyword}{false},\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02696\ }
\DoxyCodeLine{02697\ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02698\ \}}
\DoxyCodeLine{02699\ }
\DoxyCodeLine{02706\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02707\ detach(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child,\ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02708\ \ \ nassertv(child\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02709\ }
\DoxyCodeLine{02710\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ pipeline\_stage\_i\ =\ pipeline\_stage;}
\DoxyCodeLine{02711\ \ \ \ \ \ \ \ pipeline\_stage\_i\ >=\ 0;}
\DoxyCodeLine{02712\ \ \ \ \ \ \ \ -\/-\/pipeline\_stage\_i)\ \{}
\DoxyCodeLine{02713\ \ \ \ \ detach\_one\_stage(child,\ pipeline\_stage\_i,\ current\_thread);}
\DoxyCodeLine{02714\ \ \ \}}
\DoxyCodeLine{02715\ }
\DoxyCodeLine{02716\ \ \ child-\/>get\_node()-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{02717\ \}}
\DoxyCodeLine{02718\ }
\DoxyCodeLine{02725\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{02726\ detach\_one\_stage(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02727\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02728\ \ \ nassertv(child\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02729\ \ \ \textcolor{keywordflow}{if}\ (child-\/>\mbox{\hyperlink{classNodePathComponent_a117fd73db9686487463e2c2eacba5d59}{is\_top\_node}}(pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{02730\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{02731\ \ \ \}}
\DoxyCodeLine{02732\ }
\DoxyCodeLine{02733\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ child\_node\ =\ child-\/>get\_node();}
\DoxyCodeLine{02734\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ parent\_node\ =\ child-\/>get\_next(pipeline\_stage,\ current\_thread)-\/>get\_node();}
\DoxyCodeLine{02735\ }
\DoxyCodeLine{02736\ \ \ CDStageWriter\ cdata\_parent(parent\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02737\ \ \ CDStageWriter\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02738\ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ child\_node-\/>do\_find\_parent(parent\_node,\ cdata\_child);}
\DoxyCodeLine{02739\ \ \ \textcolor{keywordflow}{if}\ (parent\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02740\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ for\ the\ child\ and\ break\ the\ actual\ connection.}}
\DoxyCodeLine{02741\ }
\DoxyCodeLine{02742\ \ \ \ \ \textcolor{comment}{//\ First,\ look\ for\ and\ remove\ the\ parent\ node\ from\ the\ child's\ up\ list.}}
\DoxyCodeLine{02743\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ cdata\_child-\/>modify\_up()-\/>erase(UpConnection(parent\_node));}
\DoxyCodeLine{02744\ \ \ \ \ nassertv(num\_erased\ ==\ 1);}
\DoxyCodeLine{02745\ }
\DoxyCodeLine{02746\ \ \ \ \ \textcolor{comment}{//\ Now,\ look\ for\ and\ remove\ the\ child\ node\ from\ the\ parent's\ down\ list.}}
\DoxyCodeLine{02747\ \ \ \ \ \textcolor{comment}{//\ We\ also\ check\ in\ the\ stashed\ list,\ in\ case\ the\ child\ node\ has\ been}}
\DoxyCodeLine{02748\ \ \ \ \ \textcolor{comment}{//\ stashed.}}
\DoxyCodeLine{02749\ \ \ \ \ Down::iterator\ di;}
\DoxyCodeLine{02750\ \ \ \ \ \textcolor{keywordtype}{bool}\ found\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02751\ \ \ \ \ PT(Down)\ down\ =\ cdata\_parent-\/>modify\_down();}
\DoxyCodeLine{02752\ \ \ \ \ \textcolor{keywordflow}{for}\ (di\ =\ down-\/>begin();\ di\ !=\ down-\/>end();\ ++di)\ \{}
\DoxyCodeLine{02753\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*di).get\_child()\ ==\ child\_node)\ \{}
\DoxyCodeLine{02754\ \ \ \ \ \ \ \ \ down-\/>erase(di);}
\DoxyCodeLine{02755\ \ \ \ \ \ \ \ \ found\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02756\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02757\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02758\ \ \ \ \ \}}
\DoxyCodeLine{02759\ \ \ \ \ \textcolor{keywordflow}{if}\ (!found)\ \{}
\DoxyCodeLine{02760\ \ \ \ \ \ \ PT(Down)\ stashed\ =\ cdata\_parent-\/>modify\_stashed();}
\DoxyCodeLine{02761\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (di\ =\ stashed-\/>begin();\ di\ !=\ stashed-\/>end();\ ++di)\ \{}
\DoxyCodeLine{02762\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*di).get\_child()\ ==\ child\_node)\ \{}
\DoxyCodeLine{02763\ \ \ \ \ \ \ \ \ \ \ stashed-\/>erase(di);}
\DoxyCodeLine{02764\ \ \ \ \ \ \ \ \ \ \ found\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02765\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02766\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02767\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02768\ \ \ \ \ \}}
\DoxyCodeLine{02769\ \ \ \ \ nassertv(found);}
\DoxyCodeLine{02770\ \ \ \}}
\DoxyCodeLine{02771\ }
\DoxyCodeLine{02772\ \ \ \textcolor{comment}{//\ Finally,\ break\ the\ NodePathComponent\ connection.}}
\DoxyCodeLine{02773\ \ \ sever\_connection(parent\_node,\ child\_node,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02774\ }
\DoxyCodeLine{02775\ \ \ parent\_node-\/>force\_bounds\_stale(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02776\ \ \ parent\_node-\/>children\_changed();}
\DoxyCodeLine{02777\ \ \ parent\_node-\/>mark\_bam\_modified();}
\DoxyCodeLine{02778\ \}}
\DoxyCodeLine{02779\ }
\DoxyCodeLine{02789\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{02790\ reparent(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *new\_parent,\ \mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child,\ \textcolor{keywordtype}{int}\ sort,}
\DoxyCodeLine{02791\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ as\_stashed,\ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02792\ \ \ \textcolor{keywordtype}{bool}\ any\_ok\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02793\ }
\DoxyCodeLine{02794\ \ \ \textcolor{keywordflow}{if}\ (new\_parent\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{02795\ \ \ \ \ \ \ !new\_parent-\/>get\_node()-\/>verify\_child\_no\_cycles(child-\/>get\_node()))\ \{}
\DoxyCodeLine{02796\ \ \ \ \ \textcolor{comment}{//\ Whoops,\ adding\ this\ child\ node\ would\ introduce\ a\ cycle\ in\ the\ scene}}
\DoxyCodeLine{02797\ \ \ \ \ \textcolor{comment}{//\ graph.}}
\DoxyCodeLine{02798\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02799\ \ \ \}}
\DoxyCodeLine{02800\ }
\DoxyCodeLine{02801\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ pipeline\_stage\_i\ =\ pipeline\_stage;}
\DoxyCodeLine{02802\ \ \ \ \ \ \ \ pipeline\_stage\_i\ >=\ 0;}
\DoxyCodeLine{02803\ \ \ \ \ \ \ \ -\/-\/pipeline\_stage\_i)\ \{}
\DoxyCodeLine{02804\ \ \ \ \ \textcolor{keywordflow}{if}\ (reparent\_one\_stage(new\_parent,\ child,\ sort,\ as\_stashed,}
\DoxyCodeLine{02805\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage\_i,\ current\_thread))\ \{}
\DoxyCodeLine{02806\ \ \ \ \ \ \ any\_ok\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02807\ \ \ \ \ \}}
\DoxyCodeLine{02808\ \ \ \}}
\DoxyCodeLine{02809\ }
\DoxyCodeLine{02810\ \ \ \textcolor{keywordflow}{if}\ (new\_parent\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02811\ \ \ \ \ new\_parent-\/>get\_node()-\/>\mbox{\hyperlink{classPandaNode_ae9f29143ce4d303e0d575ed5ace3b365}{children\_changed}}();}
\DoxyCodeLine{02812\ \ \ \ \ new\_parent-\/>get\_node()-\/>mark\_bam\_modified();}
\DoxyCodeLine{02813\ \ \ \}}
\DoxyCodeLine{02814\ \ \ child-\/>get\_node()-\/>\mbox{\hyperlink{classPandaNode_a6730fd19532985902c74adae145b8572}{parents\_changed}}();}
\DoxyCodeLine{02815\ \ \ child-\/>get\_node()-\/>mark\_bam\_modified();}
\DoxyCodeLine{02816\ }
\DoxyCodeLine{02817\ \ \ \textcolor{keywordflow}{return}\ any\_ok;}
\DoxyCodeLine{02818\ \}}
\DoxyCodeLine{02819\ }
\DoxyCodeLine{02829\ \textcolor{keywordtype}{bool}\ PandaNode::}
\DoxyCodeLine{02830\ reparent\_one\_stage(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *new\_parent,\ \mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child,}
\DoxyCodeLine{02831\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ sort,\ \textcolor{keywordtype}{bool}\ as\_stashed,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02832\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02833\ \ \ nassertr(child\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{02834\ }
\DoxyCodeLine{02835\ \ \ \textcolor{comment}{//\ Keep\ a\ reference\ count\ to\ the\ new\ parent,\ since\ detaching\ the\ child\ might}}
\DoxyCodeLine{02836\ \ \ \textcolor{comment}{//\ lose\ the\ count.}}
\DoxyCodeLine{02837\ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ keep\_parent\ =\ new\_parent;}
\DoxyCodeLine{02838\ }
\DoxyCodeLine{02839\ \ \ \textcolor{keywordflow}{if}\ (!child-\/>\mbox{\hyperlink{classNodePathComponent_a117fd73db9686487463e2c2eacba5d59}{is\_top\_node}}(pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{02840\ \ \ \ \ detach(child,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02841\ \ \ \}}
\DoxyCodeLine{02842\ }
\DoxyCodeLine{02843\ \ \ \textcolor{keywordflow}{if}\ (new\_parent\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02844\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ child-\/>get\_node();}
\DoxyCodeLine{02845\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ new\_parent-\/>get\_node();}
\DoxyCodeLine{02846\ }
\DoxyCodeLine{02847\ \ \ \ \ \{}
\DoxyCodeLine{02848\ \ \ \ \ \ \ CDStageReader\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02849\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ child\_node-\/>do\_find\_parent(parent\_node,\ cdata\_child);}
\DoxyCodeLine{02850\ }
\DoxyCodeLine{02851\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parent\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02852\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Whoops,\ there's\ already\ another\ instance\ of\ the\ child\ there.}}
\DoxyCodeLine{02853\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02854\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02855\ \ \ \ \ \}}
\DoxyCodeLine{02856\ }
\DoxyCodeLine{02857\ \ \ \ \ \textcolor{comment}{//\ Redirect\ the\ connection\ to\ the\ indicated\ new\ parent.}}
\DoxyCodeLine{02858\ \ \ \ \ child-\/>set\_next(new\_parent,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02859\ }
\DoxyCodeLine{02860\ \ \ \ \ \textcolor{comment}{//\ Now\ reattach\ the\ child\ node\ at\ the\ indicated\ sort\ position.}}
\DoxyCodeLine{02861\ \ \ \ \ \{}
\DoxyCodeLine{02862\ \ \ \ \ \ \ CDStageWriter\ cdata\_parent(parent\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02863\ \ \ \ \ \ \ CDStageWriter\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02864\ }
\DoxyCodeLine{02865\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (as\_stashed)\ \{}
\DoxyCodeLine{02866\ \ \ \ \ \ \ \ \ cdata\_parent-\/>modify\_stashed()-\/>insert(DownConnection(child\_node,\ sort));}
\DoxyCodeLine{02867\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02868\ \ \ \ \ \ \ \ \ cdata\_parent-\/>modify\_down()-\/>insert(DownConnection(child\_node,\ sort));}
\DoxyCodeLine{02869\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02870\ \ \ \ \ \ \ cdata\_child-\/>modify\_up()-\/>insert(UpConnection(parent\_node));}
\DoxyCodeLine{02871\ }
\DoxyCodeLine{02872\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{02873\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ NodePathComponent\ should\ already\ be\ in\ the\ set.}}
\DoxyCodeLine{02874\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02875\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{02876\ \ \ \ \ \ \ \ \ nassertr(child\_node-\/>\_paths.find(child)\ !=\ child\_node-\/>\_paths.end(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{02877\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02878\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ NDEBUG}}
\DoxyCodeLine{02879\ \ \ \ \ \}}
\DoxyCodeLine{02880\ }
\DoxyCodeLine{02881\ \ \ \ \ child\_node-\/>fix\_path\_lengths(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02882\ \ \ \ \ parent\_node-\/>\mbox{\hyperlink{classPandaNode_ae5d2ba3861c6427f1bdaefa542aeef10}{force\_bounds\_stale}}(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02883\ \ \ \}}
\DoxyCodeLine{02884\ }
\DoxyCodeLine{02885\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02886\ \}}
\DoxyCodeLine{02887\ }
\DoxyCodeLine{02892\ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ PandaNode::}
\DoxyCodeLine{02893\ get\_component(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *parent,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,}
\DoxyCodeLine{02894\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02895\ \ \ nassertr(parent\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{02896\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ parent-\/>get\_node();}
\DoxyCodeLine{02897\ }
\DoxyCodeLine{02898\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{02899\ }
\DoxyCodeLine{02900\ \ \ \textcolor{comment}{//\ First,\ walk\ through\ the\ list\ of\ NodePathComponents\ we\ already\ have\ on\ the}}
\DoxyCodeLine{02901\ \ \ \textcolor{comment}{//\ child,\ looking\ for\ one\ that\ already\ exists,\ referencing\ the\ indicated}}
\DoxyCodeLine{02902\ \ \ \textcolor{comment}{//\ parent\ component.}}
\DoxyCodeLine{02903\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child\ :\ child\_node-\/>\_paths)\ \{}
\DoxyCodeLine{02904\ \ \ \ \ \textcolor{keywordflow}{if}\ (child-\/>get\_next(pipeline\_stage,\ current\_thread)\ ==\ parent)\ \{}
\DoxyCodeLine{02905\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ already\ have\ such\ a\ component,\ just\ return\ it.}}
\DoxyCodeLine{02906\ \ \ \ \ \ \ \textcolor{comment}{//\ But\ before\ we\ do,\ we\ have\ to\ make\ sure\ it's\ not\ in\ the\ middle\ of\ being}}
\DoxyCodeLine{02907\ \ \ \ \ \ \ \textcolor{comment}{//\ destructed.}}
\DoxyCodeLine{02908\ \textcolor{preprocessor}{\#ifdef\ HAVE\_THREADS}}
\DoxyCodeLine{02909\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (child-\/>ref\_if\_nonzero())\ \{}
\DoxyCodeLine{02910\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ result;}
\DoxyCodeLine{02911\ \ \ \ \ \ \ \ \ result.cheat()\ =\ child;}
\DoxyCodeLine{02912\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{02913\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02914\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{02915\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we're\ not\ building\ with\ threading,\ increment\ as\ normal.}}
\DoxyCodeLine{02916\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02917\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02918\ \ \ \ \ \}}
\DoxyCodeLine{02919\ \ \ \}}
\DoxyCodeLine{02920\ }
\DoxyCodeLine{02921\ \ \ \textcolor{comment}{//\ We\ don't\ already\ have\ a\ NodePathComponent\ referring\ to\ this\ parent-\/child}}
\DoxyCodeLine{02922\ \ \ \textcolor{comment}{//\ relationship.\ \ Are\ they\ actually\ related?}}
\DoxyCodeLine{02923\ \ \ CDStageReader\ cdata\_child(child\_node-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02924\ \ \ \textcolor{keywordtype}{int}\ parent\_index\ =\ child\_node-\/>do\_find\_parent(parent\_node,\ cdata\_child);}
\DoxyCodeLine{02925\ }
\DoxyCodeLine{02926\ \ \ \textcolor{keywordflow}{if}\ (parent\_index\ >=\ 0)\ \{}
\DoxyCodeLine{02927\ \ \ \ \ \textcolor{comment}{//\ They\ are.\ \ Create\ and\ return\ a\ new\ one.}}
\DoxyCodeLine{02928\ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ child\ =}
\DoxyCodeLine{02929\ \ \ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}(child\_node,\ parent,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02930\ \ \ \ \ child\_node-\/>\_paths.insert(child);}
\DoxyCodeLine{02931\ \ \ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02932\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02933\ \ \ \ \ \textcolor{comment}{//\ They\ aren't\ related.\ \ Return\ NULL.}}
\DoxyCodeLine{02934\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02935\ \ \ \}}
\DoxyCodeLine{02936\ \}}
\DoxyCodeLine{02937\ }
\DoxyCodeLine{02948\ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ PandaNode::}
\DoxyCodeLine{02949\ get\_top\_component(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,\ \textcolor{keywordtype}{bool}\ force,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02950\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02951\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{02952\ }
\DoxyCodeLine{02953\ \ \ \textcolor{comment}{//\ Walk\ through\ the\ list\ of\ NodePathComponents\ we\ already\ have\ on\ the\ child,}}
\DoxyCodeLine{02954\ \ \ \textcolor{comment}{//\ looking\ for\ one\ that\ already\ exists\ as\ a\ top\ node.}}
\DoxyCodeLine{02955\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *child\ :\ child\_node-\/>\_paths)\ \{}
\DoxyCodeLine{02956\ \ \ \ \ \textcolor{keywordflow}{if}\ (child-\/>\mbox{\hyperlink{classNodePathComponent_a117fd73db9686487463e2c2eacba5d59}{is\_top\_node}}(pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{02957\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we\ already\ have\ such\ a\ component,\ just\ return\ it.}}
\DoxyCodeLine{02958\ \ \ \ \ \ \ \textcolor{comment}{//\ But\ before\ we\ do,\ we\ have\ to\ make\ sure\ it's\ not\ in\ the\ middle\ of\ being}}
\DoxyCodeLine{02959\ \ \ \ \ \ \ \textcolor{comment}{//\ destructed.}}
\DoxyCodeLine{02960\ \textcolor{preprocessor}{\#ifdef\ HAVE\_THREADS}}
\DoxyCodeLine{02961\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (child-\/>ref\_if\_nonzero())\ \{}
\DoxyCodeLine{02962\ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ result;}
\DoxyCodeLine{02963\ \ \ \ \ \ \ \ \ result.cheat()\ =\ child;}
\DoxyCodeLine{02964\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{02965\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02966\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{02967\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we're\ not\ building\ with\ threading,\ increment\ as\ normal.}}
\DoxyCodeLine{02968\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02969\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02970\ \ \ \ \ \}}
\DoxyCodeLine{02971\ \ \ \}}
\DoxyCodeLine{02972\ }
\DoxyCodeLine{02973\ \ \ \textcolor{keywordflow}{if}\ (!force)\ \{}
\DoxyCodeLine{02974\ \ \ \ \ \textcolor{comment}{//\ If\ we\ don't\ care\ to\ force\ the\ point,\ return\ NULL\ to\ indicate\ there's}}
\DoxyCodeLine{02975\ \ \ \ \ \textcolor{comment}{//\ not\ already\ a\ top\ component.}}
\DoxyCodeLine{02976\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02977\ \ \ \}}
\DoxyCodeLine{02978\ }
\DoxyCodeLine{02979\ \ \ \textcolor{comment}{//\ We\ don't\ already\ have\ such\ a\ NodePathComponent;\ create\ and\ return\ a\ new}}
\DoxyCodeLine{02980\ \ \ \textcolor{comment}{//\ one.}}
\DoxyCodeLine{02981\ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ child\ =}
\DoxyCodeLine{02982\ \ \ \ \ \textcolor{keyword}{new}\ \mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}(child\_node,\ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{02983\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{02984\ \ \ child\_node-\/>\_paths.insert(child);}
\DoxyCodeLine{02985\ }
\DoxyCodeLine{02986\ \ \ \textcolor{keywordflow}{return}\ child;}
\DoxyCodeLine{02987\ \}}
\DoxyCodeLine{02988\ }
\DoxyCodeLine{02996\ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ PandaNode::}
\DoxyCodeLine{02997\ get\_generic\_component(\textcolor{keywordtype}{bool}\ accept\_ambiguity,\ \textcolor{keywordtype}{int}\ pipeline\_stage,}
\DoxyCodeLine{02998\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{02999\ \ \ \textcolor{keywordtype}{bool}\ ambiguity\_detected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{03000\ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ result\ =}
\DoxyCodeLine{03001\ \ \ \ \ r\_get\_generic\_component(accept\_ambiguity,\ ambiguity\_detected,}
\DoxyCodeLine{03002\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03003\ }
\DoxyCodeLine{03004\ \ \ \textcolor{keywordflow}{if}\ (!accept\_ambiguity\ \&\&\ ambiguity\_detected)\ \{}
\DoxyCodeLine{03005\ \ \ \ \ pgraph\_cat.warning()}
\DoxyCodeLine{03006\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Chose:\ "{}}\ <<\ *result\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03007\ \ \ \ \ nassertr(!unambiguous\_graph,\ result);}
\DoxyCodeLine{03008\ \ \ \}}
\DoxyCodeLine{03009\ }
\DoxyCodeLine{03010\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{03011\ \}}
\DoxyCodeLine{03012\ }
\DoxyCodeLine{03018\ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ PandaNode::}
\DoxyCodeLine{03019\ r\_get\_generic\_component(\textcolor{keywordtype}{bool}\ accept\_ambiguity,\ \textcolor{keywordtype}{bool}\ \&ambiguity\_detected,}
\DoxyCodeLine{03020\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{03021\ \ \ PT(\mbox{\hyperlink{classPandaNode}{PandaNode}})\ parent\_node;}
\DoxyCodeLine{03022\ }
\DoxyCodeLine{03023\ \ \ \{}
\DoxyCodeLine{03024\ \ \ \ \ CDStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03025\ }
\DoxyCodeLine{03026\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ cdata-\/>get\_up()-\/>size();}
\DoxyCodeLine{03027\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_parents\ ==\ 0)\ \{}
\DoxyCodeLine{03028\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ parents;\ no\ ambiguity.\ \ This\ is\ the\ root.}}
\DoxyCodeLine{03029\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ get\_top\_component(\textcolor{keyword}{this},\ \textcolor{keyword}{true},\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03030\ \ \ \ \ \}}
\DoxyCodeLine{03031\ }
\DoxyCodeLine{03032\ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ result;}
\DoxyCodeLine{03033\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_parents\ ==\ 1)\ \{}
\DoxyCodeLine{03034\ \ \ \ \ \ \ \textcolor{comment}{//\ Only\ one\ parent;\ no\ ambiguity.}}
\DoxyCodeLine{03035\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ parent\ =}
\DoxyCodeLine{03036\ \ \ \ \ \ \ \ \ get\_parent(0)-\/>r\_get\_generic\_component(accept\_ambiguity,\ ambiguity\_detected,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03037\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ get\_component(parent,\ \textcolor{keyword}{this},\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03038\ \ \ \ \ \}}
\DoxyCodeLine{03039\ }
\DoxyCodeLine{03040\ \ \ \ \ \textcolor{comment}{//\ Oops,\ multiple\ parents;\ the\ NodePath\ is\ ambiguous.}}
\DoxyCodeLine{03041\ \ \ \ \ \textcolor{keywordflow}{if}\ (!accept\_ambiguity)\ \{}
\DoxyCodeLine{03042\ \ \ \ \ \ \ pgraph\_cat.warning()}
\DoxyCodeLine{03043\ \ \ \ \ \ \ \ \ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\ has\ "{}}\ <<\ num\_parents}
\DoxyCodeLine{03044\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ parents;\ choosing\ arbitrary\ path\ to\ root.\(\backslash\)n"{}};}
\DoxyCodeLine{03045\ \ \ \ \ \}}
\DoxyCodeLine{03046\ \ \ \ \ ambiguity\_detected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{03047\ \ \ \ \ CPT(Up)\ up\ =\ cdata-\/>get\_up();}
\DoxyCodeLine{03048\ \ \ \ \ parent\_node\ =\ (*up)[0].get\_parent();}
\DoxyCodeLine{03049\ \ \ \}}
\DoxyCodeLine{03050\ }
\DoxyCodeLine{03051\ \ \ \textcolor{comment}{//\ Now\ that\ the\ lock\ is\ released,\ it's\ safe\ to\ recurse.}}
\DoxyCodeLine{03052\ \ \ PT(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}})\ parent\ =}
\DoxyCodeLine{03053\ \ \ \ \ parent\_node-\/>r\_get\_generic\_component(accept\_ambiguity,\ ambiguity\_detected,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03054\ \ \ \textcolor{keywordflow}{return}\ get\_component(parent,\ \textcolor{keyword}{this},\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03055\ \}}
\DoxyCodeLine{03056\ }
\DoxyCodeLine{03061\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{03062\ delete\_component(\mbox{\hyperlink{classNodePathComponent}{NodePathComponent}}\ *component)\ \{}
\DoxyCodeLine{03063\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_paths\_lock);}
\DoxyCodeLine{03064\ \ \ \textcolor{keywordtype}{int}\ num\_erased\ =\ \_paths.erase(component);}
\DoxyCodeLine{03065\ \ \ nassertv(num\_erased\ ==\ 1);}
\DoxyCodeLine{03066\ \}}
\DoxyCodeLine{03067\ }
\DoxyCodeLine{03080\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{03081\ sever\_connection(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,}
\DoxyCodeLine{03082\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{03083\ \ \ \{}
\DoxyCodeLine{03084\ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{03085\ \ \ \ \ Paths::iterator\ pi;}
\DoxyCodeLine{03086\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ child\_node-\/>\_paths.begin();\ pi\ !=\ child\_node-\/>\_paths.end();\ ++pi)\ \{}
\DoxyCodeLine{03087\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(*pi)-\/>is\_top\_node(pipeline\_stage,\ current\_thread)\ \&\&}
\DoxyCodeLine{03088\ \ \ \ \ \ \ \ \ \ \ (*pi)-\/>get\_next(pipeline\_stage,\ current\_thread)-\/>get\_node()\ ==\ parent\_node)\ \{}
\DoxyCodeLine{03089\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Sever\ the\ component\ here.}}
\DoxyCodeLine{03090\ \ \ \ \ \ \ \ \ (*pi)-\/>set\_top\_node(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03091\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03092\ \ \ \ \ \}}
\DoxyCodeLine{03093\ \ \ \}}
\DoxyCodeLine{03094\ \ \ child\_node-\/>fix\_path\_lengths(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03095\ \}}
\DoxyCodeLine{03096\ }
\DoxyCodeLine{03108\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{03109\ new\_connection(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node,\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node,}
\DoxyCodeLine{03110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{03111\ \ \ \{}
\DoxyCodeLine{03112\ \ \ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(child\_node-\/>\_paths\_lock);}
\DoxyCodeLine{03113\ \ \ \ \ Paths::iterator\ pi;}
\DoxyCodeLine{03114\ \ \ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ child\_node-\/>\_paths.begin();\ pi\ !=\ child\_node-\/>\_paths.end();\ ++pi)\ \{}
\DoxyCodeLine{03115\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((*pi)-\/>is\_top\_node(pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{03116\ \ \ \ \ \ \ \ \ (*pi)-\/>set\_next(parent\_node-\/>get\_generic\_component(\textcolor{keyword}{false},\ pipeline\_stage,\ current\_thread),\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03117\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03118\ \ \ \ \ \}}
\DoxyCodeLine{03119\ \ \ \}}
\DoxyCodeLine{03120\ \ \ child\_node-\/>fix\_path\_lengths(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03121\ \}}
\DoxyCodeLine{03122\ }
\DoxyCodeLine{03131\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{03132\ fix\_path\_lengths(\textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread)\ \{}
\DoxyCodeLine{03133\ \ \ \mbox{\hyperlink{classLightReMutexHolder}{LightReMutexHolder}}\ holder(\_paths\_lock);}
\DoxyCodeLine{03134\ }
\DoxyCodeLine{03135\ \ \ \textcolor{keywordtype}{bool}\ any\_wrong\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{03136\ }
\DoxyCodeLine{03137\ \ \ Paths::const\_iterator\ pi;}
\DoxyCodeLine{03138\ \ \ \textcolor{keywordflow}{for}\ (pi\ =\ \_paths.begin();\ pi\ !=\ \_paths.end();\ ++pi)\ \{}
\DoxyCodeLine{03139\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*pi)-\/>fix\_length(pipeline\_stage,\ current\_thread))\ \{}
\DoxyCodeLine{03140\ \ \ \ \ \ \ any\_wrong\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{03141\ \ \ \ \ \}}
\DoxyCodeLine{03142\ \ \ \}}
\DoxyCodeLine{03143\ }
\DoxyCodeLine{03144\ \ \ \textcolor{comment}{//\ If\ any\ paths\ were\ updated,\ we\ have\ to\ recurse\ on\ all\ of\ our\ children,}}
\DoxyCodeLine{03145\ \ \ \textcolor{comment}{//\ since\ any\ one\ of\ those\ paths\ might\ be\ shared\ by\ any\ of\ our\ child\ nodes.}}
\DoxyCodeLine{03146\ \ \ \textcolor{comment}{//\ Don't\ hold\ any\ locks\ while\ we\ recurse.}}
\DoxyCodeLine{03147\ \ \ \textcolor{keywordflow}{if}\ (any\_wrong)\ \{}
\DoxyCodeLine{03148\ \ \ \ \ Children\ children;}
\DoxyCodeLine{03149\ \ \ \ \ Stashed\ stashed;}
\DoxyCodeLine{03150\ \ \ \ \ \{}
\DoxyCodeLine{03151\ \ \ \ \ \ \ CDStageReader\ cdata(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03152\ \ \ \ \ \ \ children\ =\ Children(cdata);}
\DoxyCodeLine{03153\ \ \ \ \ \ \ stashed\ =\ Stashed(cdata);}
\DoxyCodeLine{03154\ \ \ \ \ \}}
\DoxyCodeLine{03155\ }
\DoxyCodeLine{03156\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ children.get\_num\_children();}
\DoxyCodeLine{03157\ \ \ \ \ \textcolor{keywordtype}{int}\ i;}
\DoxyCodeLine{03158\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_children;\ ++i)\ \{}
\DoxyCodeLine{03159\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ children.get\_child(i);}
\DoxyCodeLine{03160\ \ \ \ \ \ \ child\_node-\/>fix\_path\_lengths(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03161\ \ \ \ \ \}}
\DoxyCodeLine{03162\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_stashed\ =\ stashed.get\_num\_stashed();}
\DoxyCodeLine{03163\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ num\_stashed;\ ++i)\ \{}
\DoxyCodeLine{03164\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ stashed.get\_stashed(i);}
\DoxyCodeLine{03165\ \ \ \ \ \ \ child\_node-\/>fix\_path\_lengths(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03166\ \ \ \ \ \}}
\DoxyCodeLine{03167\ \ \ \}}
\DoxyCodeLine{03168\ \}}
\DoxyCodeLine{03169\ }
\DoxyCodeLine{03173\ \textcolor{keywordtype}{void}\ PandaNode::}
\DoxyCodeLine{03174\ r\_list\_descendants(ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03175\ \ \ write(out,\ indent\_level);}
\DoxyCodeLine{03176\ }
\DoxyCodeLine{03177\ \ \ Children\ children\ =\ get\_children();}
\DoxyCodeLine{03178\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ children.get\_num\_children();}
\DoxyCodeLine{03179\ }
\DoxyCodeLine{03180\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ ++i)\ \{}
\DoxyCodeLine{03181\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ children.get\_child(i);}
\DoxyCodeLine{03182\ \ \ \ \ child-\/>r\_list\_descendants(out,\ indent\_level\ +\ 2);}
\DoxyCodeLine{03183\ \ \ \}}
\DoxyCodeLine{03184\ }
\DoxyCodeLine{03185\ \ \ \textcolor{comment}{//\ Also\ report\ the\ number\ of\ stashed\ nodes\ at\ this\ level.}}
\DoxyCodeLine{03186\ \ \ \textcolor{keywordtype}{int}\ num\_stashed\ =\ get\_num\_stashed();}
\DoxyCodeLine{03187\ \ \ \textcolor{keywordflow}{if}\ (num\_stashed\ !=\ 0)\ \{}
\DoxyCodeLine{03188\ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}("{}}\ <<\ num\_stashed\ <<\ \textcolor{stringliteral}{"{}\ stashed)\(\backslash\)n"{}};}
\DoxyCodeLine{03189\ \ \ \}}
\DoxyCodeLine{03190\ \}}
\DoxyCodeLine{03191\ }
\DoxyCodeLine{03195\ \textcolor{keywordtype}{int}\ PandaNode::}
\DoxyCodeLine{03196\ do\_find\_child(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Down}}\ *down)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03197\ \ \ nassertr(node\ !=\ \textcolor{keyword}{nullptr},\ -\/1);}
\DoxyCodeLine{03198\ }
\DoxyCodeLine{03199\ \ \ \textcolor{comment}{//\ We\ have\ to\ search\ for\ the\ child\ by\ brute\ force,\ since\ we\ don't\ know\ what}}
\DoxyCodeLine{03200\ \ \ \textcolor{comment}{//\ sort\ index\ it\ was\ added\ as.}}
\DoxyCodeLine{03201\ \ \ Down::const\_iterator\ di;}
\DoxyCodeLine{03202\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ down-\/>begin();\ di\ !=\ down-\/>end();\ ++di)\ \{}
\DoxyCodeLine{03203\ \ \ \ \ \textcolor{keywordflow}{if}\ ((*di).get\_child()\ ==\ node)\ \{}
\DoxyCodeLine{03204\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ di\ -\/\ down-\/>begin();}
\DoxyCodeLine{03205\ \ \ \ \ \}}
\DoxyCodeLine{03206\ \ \ \}}
\DoxyCodeLine{03207\ }
\DoxyCodeLine{03208\ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{03209\ \}}
\DoxyCodeLine{03210\ }
\DoxyCodeLine{03222\ \mbox{\hyperlink{classCycleDataStageWriter}{PandaNode::CDStageWriter}}\ PandaNode::}
\DoxyCodeLine{03223\ update\_cached(\textcolor{keywordtype}{bool}\ update\_bounds,\ \textcolor{keywordtype}{int}\ pipeline\_stage,\ \mbox{\hyperlink{classCycleDataLockedStageReader}{PandaNode::CDLockedStageReader}}\ \&cdata)\ \{}
\DoxyCodeLine{03224\ \ \ \textcolor{comment}{//\ We\ might\ need\ to\ try\ this\ a\ couple\ of\ times,\ in\ case\ someone\ else\ steps}}
\DoxyCodeLine{03225\ \ \ \textcolor{comment}{//\ on\ our\ result.}}
\DoxyCodeLine{03226\ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03227\ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03228\ \ \ \ \ \ \ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}::update\_cached()\ \{\(\backslash\)n"{}};}
\DoxyCodeLine{03229\ \ \ \}}
\DoxyCodeLine{03230\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ cdata.get\_current\_thread();}
\DoxyCodeLine{03231\ }
\DoxyCodeLine{03232\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{03233\ \ \ \ \ \textcolor{comment}{//\ Grab\ the\ last\_update\ counter.}}
\DoxyCodeLine{03234\ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ last\_update\ =\ cdata-\/>\_last\_update;}
\DoxyCodeLine{03235\ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ next\_update\ =\ cdata-\/>\_next\_update;}
\DoxyCodeLine{03236\ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ last\_bounds\_update\ =\ cdata-\/>\_last\_bounds\_update;}
\DoxyCodeLine{03237\ \ \ \ \ nassertr(last\_update\ !=\ next\_update\ ||}
\DoxyCodeLine{03238\ \ \ \ \ \ \ \ \ \ \ \ \ \ (update\_bounds\ \&\&\ last\_bounds\_update\ !=\ next\_update),}
\DoxyCodeLine{03239\ \ \ \ \ \ \ \ \ \ \ \ \ \ CDStageWriter(\_cycler,\ pipeline\_stage,\ cdata));}
\DoxyCodeLine{03240\ }
\DoxyCodeLine{03241\ \ \ \ \ \textcolor{comment}{//\ Start\ with\ a\ clean\ slate.}}
\DoxyCodeLine{03242\ \ \ \ \ \mbox{\hyperlink{classBitMask}{CollideMask}}\ net\_collide\_mask\ =\ cdata-\/>\_into\_collide\_mask;}
\DoxyCodeLine{03243\ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ net\_draw\_control\_mask,\ net\_draw\_show\_mask;}
\DoxyCodeLine{03244\ \ \ \ \ \textcolor{keywordtype}{bool}\ renderable\ =\ (cdata-\/>\_fancy\_bits\ \&\ FB\_renderable)\ !=\ 0;}
\DoxyCodeLine{03245\ }
\DoxyCodeLine{03246\ \ \ \ \ \textcolor{keywordflow}{if}\ (renderable)\ \{}
\DoxyCodeLine{03247\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ this\ node\ is\ itself\ renderable,\ it\ contributes\ to\ the\ net\ draw}}
\DoxyCodeLine{03248\ \ \ \ \ \ \ \textcolor{comment}{//\ mask.}}
\DoxyCodeLine{03249\ \ \ \ \ \ \ net\_draw\_control\_mask\ =\ cdata-\/>\_draw\_control\_mask;}
\DoxyCodeLine{03250\ \ \ \ \ \ \ net\_draw\_show\_mask\ =\ cdata-\/>\_draw\_show\_mask;}
\DoxyCodeLine{03251\ \ \ \ \ \}}
\DoxyCodeLine{03252\ }
\DoxyCodeLine{03253\ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03254\ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03255\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}net\_draw\_control\_mask\ =\ "{}}\ <<\ net\_draw\_control\_mask}
\DoxyCodeLine{03256\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nnet\_draw\_show\_mask\ =\ "{}}\ <<\ net\_draw\_show\_mask}
\DoxyCodeLine{03257\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03258\ \ \ \ \ \}}
\DoxyCodeLine{03259\ \ \ \ \ CPT(\mbox{\hyperlink{classRenderAttrib}{RenderAttrib}})\ off\_clip\_planes\ =\ cdata-\/>\_state-\/>get\_attrib(ClipPlaneAttrib::get\_class\_slot());}
\DoxyCodeLine{03260\ \ \ \ \ \textcolor{keywordflow}{if}\ (off\_clip\_planes\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03261\ \ \ \ \ \ \ off\_clip\_planes\ =\ ClipPlaneAttrib::make();}
\DoxyCodeLine{03262\ \ \ \ \ \}}
\DoxyCodeLine{03263\ }
\DoxyCodeLine{03264\ \ \ \ \ \textcolor{comment}{//\ Also\ get\ the\ list\ of\ the\ node's\ children.\ \ When\ the\ cdataw\ destructs,\ it}}
\DoxyCodeLine{03265\ \ \ \ \ \textcolor{comment}{//\ will\ also\ release\ the\ lock,\ since\ we've\ got\ all\ the\ data\ we\ need\ from\ the}}
\DoxyCodeLine{03266\ \ \ \ \ \textcolor{comment}{//\ node.}}
\DoxyCodeLine{03267\ \ \ \ \ PT(Down)\ down;}
\DoxyCodeLine{03268\ \ \ \ \ \{}
\DoxyCodeLine{03269\ \ \ \ \ \ \ CDStageWriter\ cdataw(\_cycler,\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{03270\ \ \ \ \ \ \ down\ =\ cdataw-\/>modify\_down();}
\DoxyCodeLine{03271\ \ \ \ \ \}}
\DoxyCodeLine{03272\ }
\DoxyCodeLine{03273\ \ \ \ \ \textcolor{comment}{//\ Now\ that\ we've\ got\ all\ the\ data\ we\ need\ from\ the\ node,\ we\ can\ release}}
\DoxyCodeLine{03274\ \ \ \ \ \textcolor{comment}{//\ the\ lock.}}
\DoxyCodeLine{03275\ \ \ \ \ \textcolor{comment}{//\_cycler.release\_read\_stage(pipeline\_stage,\ cdata.take\_pointer());}}
\DoxyCodeLine{03276\ }
\DoxyCodeLine{03277\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ down-\/>size();}
\DoxyCodeLine{03278\ }
\DoxyCodeLine{03279\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ keep\ references\ to\ the\ bounding\ volumes,\ since\ in\ a\ threaded}}
\DoxyCodeLine{03280\ \ \ \ \ \textcolor{comment}{//\ environment\ the\ pointers\ might\ go\ away\ while\ we're\ working\ (since\ we're}}
\DoxyCodeLine{03281\ \ \ \ \ \textcolor{comment}{//\ not\ holding\ a\ lock\ on\ our\ set\ of\ children\ right\ now).\ \ But\ we\ also\ need}}
\DoxyCodeLine{03282\ \ \ \ \ \textcolor{comment}{//\ the\ regular\ pointers,\ to\ pass\ to\ BoundingVolume::around().}}
\DoxyCodeLine{03283\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **child\_volumes;}
\DoxyCodeLine{03284\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{03285\ \ \ \ \ \mbox{\hyperlink{classpvector}{pvector}}<CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ >\ child\_volumes\_ref;}
\DoxyCodeLine{03286\ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_bounds)\ \{}
\DoxyCodeLine{03287\ \ \ \ \ \ \ child\_volumes\_ref.reserve(num\_children\ +\ 1);}
\DoxyCodeLine{03288\ \ \ \ \ \}}
\DoxyCodeLine{03289\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{03290\ \ \ \ \ \textcolor{keywordtype}{int}\ child\_volumes\_i\ =\ 0;}
\DoxyCodeLine{03291\ }
\DoxyCodeLine{03292\ \ \ \ \ CPT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ internal\_bounds\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03293\ }
\DoxyCodeLine{03294\ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_bounds)\ \{}
\DoxyCodeLine{03295\ \ \ \ \ \ \ child\_volumes\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ **)alloca(\textcolor{keyword}{sizeof}(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}\ *)\ *\ (num\_children\ +\ 1));}
\DoxyCodeLine{03296\ \ \ \ \ \ \ internal\_bounds\ =\ get\_internal\_bounds(pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03297\ }
\DoxyCodeLine{03298\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!internal\_bounds-\/>is\_empty())\ \{}
\DoxyCodeLine{03299\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{03300\ \ \ \ \ \ \ \ \ child\_volumes\_ref.push\_back(internal\_bounds);}
\DoxyCodeLine{03301\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{03302\ \ \ \ \ \ \ \ \ nassertr(child\_volumes\_i\ <\ num\_children\ +\ 1,\ CDStageWriter(\_cycler,\ pipeline\_stage,\ cdata));}
\DoxyCodeLine{03303\ \ \ \ \ \ \ \ \ child\_volumes[child\_volumes\_i++]\ =\ internal\_bounds;}
\DoxyCodeLine{03304\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03305\ \ \ \ \ \}}
\DoxyCodeLine{03306\ }
\DoxyCodeLine{03307\ \ \ \ \ \textcolor{comment}{//\ Now\ expand\ those\ contents\ to\ include\ all\ of\ our\ children.}}
\DoxyCodeLine{03308\ \ \ \ \ \textcolor{keywordtype}{int}\ child\_vertices\ =\ 0;}
\DoxyCodeLine{03309\ }
\DoxyCodeLine{03310\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ ++i)\ \{}
\DoxyCodeLine{03311\ \ \ \ \ \ \ DownConnection\ \&connection\ =\ (*down)[i];}
\DoxyCodeLine{03312\ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\ =\ connection.get\_child();}
\DoxyCodeLine{03313\ }
\DoxyCodeLine{03314\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}}\ *orig\_cp\ =\ DCAST(\mbox{\hyperlink{classClipPlaneAttrib}{ClipPlaneAttrib}},\ off\_clip\_planes);}
\DoxyCodeLine{03315\ }
\DoxyCodeLine{03316\ \ \ \ \ \ \ CDLockedStageReader\ child\_cdata(child-\/>\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03317\ }
\DoxyCodeLine{03318\ \ \ \ \ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ last\_child\_update\ =\ update\_bounds}
\DoxyCodeLine{03319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ?\ child\_cdata-\/>\_last\_bounds\_update}
\DoxyCodeLine{03320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ child\_cdata-\/>\_last\_update;}
\DoxyCodeLine{03321\ }
\DoxyCodeLine{03322\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_child\_update\ !=\ child\_cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{03323\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Child\ needs\ update.}}
\DoxyCodeLine{03324\ \ \ \ \ \ \ \ \ CDStageWriter\ child\_cdataw\ =\ child-\/>update\_cached(update\_bounds,\ pipeline\_stage,\ child\_cdata);}
\DoxyCodeLine{03325\ }
\DoxyCodeLine{03326\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{CollideMask}}\ child\_collide\_mask\ =\ child\_cdataw-\/>\_net\_collide\_mask;}
\DoxyCodeLine{03327\ \ \ \ \ \ \ \ \ net\_collide\_mask\ |=\ child\_collide\_mask;}
\DoxyCodeLine{03328\ \ \ \ \ \ \ \ \ connection.\_net\_collide\_mask\ =\ child\_collide\_mask;}
\DoxyCodeLine{03329\ }
\DoxyCodeLine{03330\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03331\ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03332\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nchild\ update\ "{}}\ <<\ *child\ <<\ \textcolor{stringliteral}{"{}:\(\backslash\)n"{}};}
\DoxyCodeLine{03333\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03334\ }
\DoxyCodeLine{03335\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ child\_control\_mask\ =\ child\_cdataw-\/>\_net\_draw\_control\_mask;}
\DoxyCodeLine{03336\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ child\_show\_mask\ =\ child\_cdataw-\/>\_net\_draw\_show\_mask;}
\DoxyCodeLine{03337\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(child\_control\_mask\ |\ child\_show\_mask).is\_zero())\ \{}
\DoxyCodeLine{03338\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ child\ includes\ a\ renderable\ node\ or\ subtree.\ \ Thus,\ we}}
\DoxyCodeLine{03339\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ should\ propagate\ its\ draw\ masks.}}
\DoxyCodeLine{03340\ \ \ \ \ \ \ \ \ \ \ renderable\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{03341\ }
\DoxyCodeLine{03342\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ each\ bit\ position\ in\ the\ masks,\ we\ have\ assigned\ the}}
\DoxyCodeLine{03343\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ following\ semantic\ meaning.\ \ The\ number\ on\ the\ left\ represents}}
\DoxyCodeLine{03344\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ pairing\ of\ the\ corresponding\ bit\ from\ the\ control\ mask\ and}}
\DoxyCodeLine{03345\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ from\ the\ show\ mask:}}
\DoxyCodeLine{03346\ }
\DoxyCodeLine{03347\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 00\ :\ not\ a\ renderable\ node\ \ \ (control\ 0,\ show\ 0)\ 01\ :\ a\ normally}}
\DoxyCodeLine{03348\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ visible\ node\ (control\ 0,\ show\ 1)\ 10\ :\ a\ hidden\ node}}
\DoxyCodeLine{03349\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ (control\ 1,\ show\ 0)\ 11\ :\ a\ show-\/through\ node\ \ \ \ \ (control\ 1,\ show}}
\DoxyCodeLine{03350\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 1)}}
\DoxyCodeLine{03351\ }
\DoxyCodeLine{03352\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now,\ when\ we\ accumulate\ these\ masks,\ we\ want\ to\ do\ so\ according}}
\DoxyCodeLine{03353\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ the\ following\ table,\ for\ each\ bit\ position:}}
\DoxyCodeLine{03354\ }
\DoxyCodeLine{03355\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 00\ \ \ 01\ \ \ 10\ \ \ 11\ \ \ \ \ (child)\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ 00\ |\ 00\ \ \ 01}}
\DoxyCodeLine{03356\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 10\ \ \ 11\ 01\ |\ 01\ \ \ 01\ \ \ 01*\ \ 11\ 10\ |\ 10\ \ \ 01*\ \ 10\ \ \ 11\ 11\ |\ 11}}
\DoxyCodeLine{03357\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 11\ \ \ 11\ \ \ 11\ (parent)}}
\DoxyCodeLine{03358\ }
\DoxyCodeLine{03359\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ table\ is\ almost\ the\ same\ as\ the\ union\ of\ both\ masks,\ with}}
\DoxyCodeLine{03360\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ one\ exception,\ marked\ with\ a\ *\ in\ the\ above\ table:\ if\ one\ is\ 10}}
\DoxyCodeLine{03361\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ the\ other\ is\ 01-\/-\/that\ is,\ one\ is\ hidden\ and\ the\ other\ is}}
\DoxyCodeLine{03362\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ normally\ visible-\/-\/then\ the\ result\ should\ be\ 01,\ normally\ visible.}}
\DoxyCodeLine{03363\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ because\ we\ only\ want\ to\ propagate\ the\ hidden\ bit\ upwards}}
\DoxyCodeLine{03364\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ *all*\ renderable\ nodes\ are\ hidden.}}
\DoxyCodeLine{03365\ }
\DoxyCodeLine{03366\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ set\ of\ exception\ bits\ for\ which\ the\ above\ rule\ applies.}}
\DoxyCodeLine{03367\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ These\ are\ the\ bits\ for\ which\ both\ bits\ have\ flipped,\ but\ which}}
\DoxyCodeLine{03368\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ were\ not\ the\ same\ in\ the\ original.}}
\DoxyCodeLine{03369\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ exception\_mask\ =\ (net\_draw\_control\_mask\ \string^\ child\_control\_mask)\ \&\ (net\_draw\_show\_mask\ \string^\ child\_show\_mask);}
\DoxyCodeLine{03370\ \ \ \ \ \ \ \ \ \ \ exception\_mask\ \&=\ (net\_draw\_control\_mask\ \string^\ net\_draw\_show\_mask);}
\DoxyCodeLine{03371\ }
\DoxyCodeLine{03372\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03373\ \ \ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03374\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}exception\_mask\ =\ "{}}\ <<\ exception\_mask\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03375\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03376\ }
\DoxyCodeLine{03377\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ compute\ the\ union,\ applying\ the\ above\ exception.}}
\DoxyCodeLine{03378\ \ \ \ \ \ \ \ \ \ \ net\_draw\_control\_mask\ |=\ child\_control\_mask;}
\DoxyCodeLine{03379\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ |=\ child\_show\_mask;}
\DoxyCodeLine{03380\ }
\DoxyCodeLine{03381\ \ \ \ \ \ \ \ \ \ \ net\_draw\_control\_mask\ \&=\ \string~exception\_mask;}
\DoxyCodeLine{03382\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ |=\ exception\_mask;}
\DoxyCodeLine{03383\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03384\ }
\DoxyCodeLine{03385\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03386\ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03387\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}child\_control\_mask\ =\ "{}}\ <<\ child\_control\_mask}
\DoxyCodeLine{03388\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nchild\_show\_mask\ =\ "{}}\ <<\ child\_show\_mask}
\DoxyCodeLine{03389\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nnet\_draw\_control\_mask\ =\ "{}}\ <<\ net\_draw\_control\_mask}
\DoxyCodeLine{03390\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nnet\_draw\_show\_mask\ =\ "{}}\ <<\ net\_draw\_show\_mask}
\DoxyCodeLine{03391\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03392\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03393\ }
\DoxyCodeLine{03394\ \ \ \ \ \ \ \ \ off\_clip\_planes\ =\ orig\_cp-\/>compose\_off(child\_cdataw-\/>\_off\_clip\_planes);}
\DoxyCodeLine{03395\ }
\DoxyCodeLine{03396\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_bounds)\ \{}
\DoxyCodeLine{03397\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!child\_cdataw-\/>\_external\_bounds-\/>is\_empty())\ \{}
\DoxyCodeLine{03398\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{03399\ \ \ \ \ \ \ \ \ \ \ \ \ child\_volumes\_ref.push\_back(child\_cdataw-\/>\_external\_bounds);}
\DoxyCodeLine{03400\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{03401\ \ \ \ \ \ \ \ \ \ \ \ \ nassertr(child\_volumes\_i\ <\ num\_children\ +\ 1,\ CDStageWriter(\_cycler,\ pipeline\_stage,\ cdata));}
\DoxyCodeLine{03402\ \ \ \ \ \ \ \ \ \ \ \ \ child\_volumes[child\_volumes\_i++]\ =\ child\_cdataw-\/>\_external\_bounds;}
\DoxyCodeLine{03403\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03404\ \ \ \ \ \ \ \ \ \ \ child\_vertices\ +=\ child\_cdataw-\/>\_nested\_vertices;}
\DoxyCodeLine{03405\ }
\DoxyCodeLine{03406\ \ \ \ \ \ \ \ \ \ \ connection.\_external\_bounds\ =\ child\_cdataw-\/>\_external\_bounds-\/>\mbox{\hyperlink{classBoundingVolume_aa9e9fc55dc53f19b21d5d39a6194818b}{as\_geometric\_bounding\_volume}}();}
\DoxyCodeLine{03407\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03408\ }
\DoxyCodeLine{03409\ \ \ \ \ \ \ \ \ connection.\_net\_draw\_control\_mask\ =\ child\_control\_mask;}
\DoxyCodeLine{03410\ \ \ \ \ \ \ \ \ connection.\_net\_draw\_show\_mask\ =\ child\_show\_mask;}
\DoxyCodeLine{03411\ }
\DoxyCodeLine{03412\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03413\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Child\ is\ good.}}
\DoxyCodeLine{03414\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{CollideMask}}\ child\_collide\_mask\ =\ child\_cdata-\/>\_net\_collide\_mask;}
\DoxyCodeLine{03415\ \ \ \ \ \ \ \ \ net\_collide\_mask\ |=\ child\_collide\_mask;}
\DoxyCodeLine{03416\ \ \ \ \ \ \ \ \ connection.\_net\_collide\_mask\ =\ child\_collide\_mask;}
\DoxyCodeLine{03417\ }
\DoxyCodeLine{03418\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ See\ comments\ in\ similar\ block\ above.}}
\DoxyCodeLine{03419\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03420\ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03421\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nchild\ fresh\ "{}}\ <<\ *child\ <<\ \textcolor{stringliteral}{"{}:\(\backslash\)n"{}};}
\DoxyCodeLine{03422\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03423\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ child\_control\_mask\ =\ child\_cdata-\/>\_net\_draw\_control\_mask;}
\DoxyCodeLine{03424\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ child\_show\_mask\ =\ child\_cdata-\/>\_net\_draw\_show\_mask;}
\DoxyCodeLine{03425\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(child\_control\_mask\ |\ child\_show\_mask).is\_zero())\ \{}
\DoxyCodeLine{03426\ \ \ \ \ \ \ \ \ \ \ renderable\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{03427\ }
\DoxyCodeLine{03428\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ exception\_mask\ =\ (net\_draw\_control\_mask\ \string^\ child\_control\_mask)\ \&\ (net\_draw\_show\_mask\ \string^\ child\_show\_mask);}
\DoxyCodeLine{03429\ \ \ \ \ \ \ \ \ \ \ exception\_mask\ \&=\ (net\_draw\_control\_mask\ \string^\ net\_draw\_show\_mask);}
\DoxyCodeLine{03430\ }
\DoxyCodeLine{03431\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03432\ \ \ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03433\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}exception\_mask\ =\ "{}}\ <<\ exception\_mask\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03434\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03435\ }
\DoxyCodeLine{03436\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ compute\ the\ union,\ applying\ the\ above\ exception.}}
\DoxyCodeLine{03437\ \ \ \ \ \ \ \ \ \ \ net\_draw\_control\_mask\ |=\ child\_control\_mask;}
\DoxyCodeLine{03438\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ |=\ child\_show\_mask;}
\DoxyCodeLine{03439\ }
\DoxyCodeLine{03440\ \ \ \ \ \ \ \ \ \ \ net\_draw\_control\_mask\ \&=\ \string~exception\_mask;}
\DoxyCodeLine{03441\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ |=\ exception\_mask;}
\DoxyCodeLine{03442\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03443\ }
\DoxyCodeLine{03444\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03445\ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03446\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}child\_control\_mask\ =\ "{}}\ <<\ child\_control\_mask}
\DoxyCodeLine{03447\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nchild\_show\_mask\ =\ "{}}\ <<\ child\_show\_mask}
\DoxyCodeLine{03448\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nnet\_draw\_control\_mask\ =\ "{}}\ <<\ net\_draw\_control\_mask}
\DoxyCodeLine{03449\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)nnet\_draw\_show\_mask\ =\ "{}}\ <<\ net\_draw\_show\_mask}
\DoxyCodeLine{03450\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03451\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03452\ }
\DoxyCodeLine{03453\ \ \ \ \ \ \ \ \ off\_clip\_planes\ =\ orig\_cp-\/>compose\_off(child\_cdata-\/>\_off\_clip\_planes);}
\DoxyCodeLine{03454\ }
\DoxyCodeLine{03455\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_bounds)\ \{}
\DoxyCodeLine{03456\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!child\_cdata-\/>\_external\_bounds-\/>is\_empty())\ \{}
\DoxyCodeLine{03457\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{03458\ \ \ \ \ \ \ \ \ \ \ \ \ child\_volumes\_ref.push\_back(child\_cdata-\/>\_external\_bounds);}
\DoxyCodeLine{03459\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{03460\ \ \ \ \ \ \ \ \ \ \ \ \ nassertr(child\_volumes\_i\ <\ num\_children\ +\ 1,\ CDStageWriter(\_cycler,\ pipeline\_stage,\ cdata));}
\DoxyCodeLine{03461\ \ \ \ \ \ \ \ \ \ \ \ \ child\_volumes[child\_volumes\_i++]\ =\ child\_cdata-\/>\_external\_bounds;}
\DoxyCodeLine{03462\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03463\ \ \ \ \ \ \ \ \ \ \ child\_vertices\ +=\ child\_cdata-\/>\_nested\_vertices;}
\DoxyCodeLine{03464\ }
\DoxyCodeLine{03465\ \ \ \ \ \ \ \ \ \ \ connection.\_external\_bounds\ =\ child\_cdata-\/>\_external\_bounds-\/>\mbox{\hyperlink{classBoundingVolume_aa9e9fc55dc53f19b21d5d39a6194818b}{as\_geometric\_bounding\_volume}}();}
\DoxyCodeLine{03466\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03467\ }
\DoxyCodeLine{03468\ \ \ \ \ \ \ \ \ connection.\_net\_draw\_control\_mask\ =\ child\_control\_mask;}
\DoxyCodeLine{03469\ \ \ \ \ \ \ \ \ connection.\_net\_draw\_show\_mask\ =\ child\_show\_mask;}
\DoxyCodeLine{03470\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03471\ \ \ \ \ \}}
\DoxyCodeLine{03472\ }
\DoxyCodeLine{03473\ \ \ \ \ \{}
\DoxyCodeLine{03474\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ grab\ the\ write\ lock\ on\ this\ node.}}
\DoxyCodeLine{03475\ \ \ \ \ \ \ CDStageWriter\ cdataw(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03476\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_update\ ==\ cdataw-\/>\_last\_update\ \&\&}
\DoxyCodeLine{03477\ \ \ \ \ \ \ \ \ \ \ next\_update\ ==\ cdataw-\/>\_next\_update)\ \{}
\DoxyCodeLine{03478\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Great,\ no\ one\ has\ monkeyed\ with\ these\ while\ we\ were\ computing\ the}}
\DoxyCodeLine{03479\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cache.\ \ Safe\ to\ store\ the\ computed\ values\ and\ return.}}
\DoxyCodeLine{03480\ \ \ \ \ \ \ \ \ cdataw-\/>\_net\_collide\_mask\ =\ net\_collide\_mask;}
\DoxyCodeLine{03481\ }
\DoxyCodeLine{03482\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (renderable)\ \{}
\DoxyCodeLine{03483\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Any\ explicit\ draw\ control\ mask\ on\ this\ node\ trumps\ anything}}
\DoxyCodeLine{03484\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ inherited\ from\ below,\ except\ a\ show-\/through.}}
\DoxyCodeLine{03485\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_control\_mask\ =\ cdataw-\/>\_draw\_control\_mask;}
\DoxyCodeLine{03486\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_show\_mask\ =\ cdataw-\/>\_draw\_show\_mask;}
\DoxyCodeLine{03487\ }
\DoxyCodeLine{03488\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ show\_through\_mask\ =\ net\_draw\_control\_mask\ \&\ net\_draw\_show\_mask;}
\DoxyCodeLine{03489\ }
\DoxyCodeLine{03490\ \ \ \ \ \ \ \ \ \ \ net\_draw\_control\_mask\ |=\ draw\_control\_mask;}
\DoxyCodeLine{03491\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ =\ (net\_draw\_show\_mask\ \&\ \string~draw\_control\_mask)\ |\ (draw\_show\_mask\ \&\ draw\_control\_mask);}
\DoxyCodeLine{03492\ }
\DoxyCodeLine{03493\ \ \ \ \ \ \ \ \ \ \ net\_draw\_show\_mask\ |=\ show\_through\_mask;}
\DoxyCodeLine{03494\ }
\DoxyCodeLine{03495\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ are\ renderable\ nodes\ below,\ so\ the\ implicit\ draw\ bits\ are}}
\DoxyCodeLine{03496\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ all\ on.}}
\DoxyCodeLine{03497\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_net\_draw\_control\_mask\ =\ net\_draw\_control\_mask;}
\DoxyCodeLine{03498\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_net\_draw\_show\_mask\ =\ net\_draw\_show\_mask\ |\ \string~net\_draw\_control\_mask;}
\DoxyCodeLine{03499\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03500\ \ \ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03501\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}renderable,\ set\ mask\ "{}}\ <<\ cdataw-\/>\_net\_draw\_show\_mask\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03502\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03503\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03504\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ are\ no\ renderable\ nodes\ below,\ so\ the\ implicit\ draw\ bits}}
\DoxyCodeLine{03505\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ are\ all\ off.\ \ Also,\ we\ don't\ care\ about\ the\ draw\ mask\ on\ this}}
\DoxyCodeLine{03506\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ particular\ node\ (since\ nothing\ below\ it\ is\ renderable\ anyway).}}
\DoxyCodeLine{03507\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_net\_draw\_control\_mask\ =\ net\_draw\_control\_mask;}
\DoxyCodeLine{03508\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_net\_draw\_show\_mask\ =\ net\_draw\_show\_mask;}
\DoxyCodeLine{03509\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03510\ \ \ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03511\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}not\ renderable,\ set\ mask\ "{}}\ <<\ cdataw-\/>\_net\_draw\_show\_mask\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03512\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03513\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03514\ }
\DoxyCodeLine{03515\ \ \ \ \ \ \ \ \ cdataw-\/>\_off\_clip\_planes\ =\ off\_clip\_planes;}
\DoxyCodeLine{03516\ }
\DoxyCodeLine{03517\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (update\_bounds)\ \{}
\DoxyCodeLine{03518\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_nested\_vertices\ =\ cdataw-\/>\_internal\_vertices\ +\ child\_vertices;}
\DoxyCodeLine{03519\ }
\DoxyCodeLine{03520\ \ \ \ \ \ \ \ \ \ \ BoundingVolume::BoundsType\ btype\ =\ cdataw-\/>\_bounds\_type;}
\DoxyCodeLine{03521\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (btype\ ==\ BoundingVolume::BT\_default)\ \{}
\DoxyCodeLine{03522\ \ \ \ \ \ \ \ \ \ \ \ \ btype\ =\ bounds\_type;}
\DoxyCodeLine{03523\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03524\ }
\DoxyCodeLine{03525\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classPandaNode_a30812b7fdc5ee30feaa4c939b3f48330}{compute\_external\_bounds}}(cdataw-\/>\_external\_bounds,\ btype,}
\DoxyCodeLine{03526\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ child\_volumes,\ child\_volumes\_i,}
\DoxyCodeLine{03527\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03528\ }
\DoxyCodeLine{03529\ \ \ \ \ \ \ \ \ \ \ nassertr(cdataw-\/>\_external\_bounds\ !=\ \textcolor{keyword}{nullptr},\ cdataw);}
\DoxyCodeLine{03530\ }
\DoxyCodeLine{03531\ \ \ \ \ \ \ \ \ \ \ cdataw-\/>\_last\_bounds\_update\ =\ next\_update;}
\DoxyCodeLine{03532\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03533\ }
\DoxyCodeLine{03534\ \ \ \ \ \ \ \ \ cdataw-\/>\_last\_update\ =\ next\_update;}
\DoxyCodeLine{03535\ }
\DoxyCodeLine{03536\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (drawmask\_cat.is\_debug())\ \{}
\DoxyCodeLine{03537\ \ \ \ \ \ \ \ \ \ \ drawmask\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03538\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\}\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}::update\_cached();\(\backslash\)n"{}};}
\DoxyCodeLine{03539\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03540\ }
\DoxyCodeLine{03541\ \ \ \ \ \ \ \ \ nassertr(cdataw-\/>\_last\_update\ ==\ cdataw-\/>\_next\_update,\ cdataw);}
\DoxyCodeLine{03542\ }
\DoxyCodeLine{03543\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Even\ though\ implicit\ bounding\ volume\ is\ not\ (yet?)\ part\ of\ the\ bam}}
\DoxyCodeLine{03544\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ stream.}}
\DoxyCodeLine{03545\ \ \ \ \ \ \ \ \ mark\_bam\_modified();}
\DoxyCodeLine{03546\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw;}
\DoxyCodeLine{03547\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03548\ }
\DoxyCodeLine{03549\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cdataw-\/>\_last\_update\ ==\ cdataw-\/>\_next\_update\ \&\&}
\DoxyCodeLine{03550\ \ \ \ \ \ \ \ \ \ \ (!update\_bounds\ ||\ cdataw-\/>\_last\_bounds\_update\ ==\ cdataw-\/>\_next\_update))\ \{}
\DoxyCodeLine{03551\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Someone\ else\ has\ computed\ the\ cache\ for\ us.\ \ OK.}}
\DoxyCodeLine{03552\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cdataw;}
\DoxyCodeLine{03553\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03554\ \ \ \ \ \}}
\DoxyCodeLine{03555\ }
\DoxyCodeLine{03556\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ go\ around\ again.\ \ Release\ the\ write\ lock,\ and\ grab\ the\ read}}
\DoxyCodeLine{03557\ \ \ \ \ \textcolor{comment}{//\ lock\ back.}}
\DoxyCodeLine{03558\ \ \ \ \ cdata\ =\ CDLockedStageReader(\_cycler,\ pipeline\_stage,\ current\_thread);}
\DoxyCodeLine{03559\ }
\DoxyCodeLine{03560\ \ \ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_last\_update\ ==\ cdata-\/>\_next\_update\ \&\&}
\DoxyCodeLine{03561\ \ \ \ \ \ \ \ \ (!update\_bounds\ ||\ cdata-\/>\_last\_bounds\_update\ ==\ cdata-\/>\_next\_update))\ \{}
\DoxyCodeLine{03562\ \ \ \ \ \ \ \textcolor{comment}{//\ Someone\ else\ has\ computed\ the\ cache\ for\ us\ while\ we\ were\ diddling}}
\DoxyCodeLine{03563\ \ \ \ \ \ \ \textcolor{comment}{//\ with\ the\ locks.\ \ OK.}}
\DoxyCodeLine{03564\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ CDStageWriter(\_cycler,\ pipeline\_stage,\ cdata);}
\DoxyCodeLine{03565\ \ \ \ \ \}}
\DoxyCodeLine{03566\ }
\DoxyCodeLine{03567\ \ \ \}\ \textcolor{keywordflow}{while}\ (\textcolor{keyword}{true});}
\DoxyCodeLine{03568\ \}}
\DoxyCodeLine{03569\ }
\DoxyCodeLine{03576\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_abfb6c991ee1f3e11c332dcad9db8849f}{PandaNode::}}}
\DoxyCodeLine{03577\ \mbox{\hyperlink{classPandaNode_abfb6c991ee1f3e11c332dcad9db8849f}{set\_scene\_root\_func}}(SceneRootFunc\ *func)\ \{}
\DoxyCodeLine{03578\ \ \ \_scene\_root\_func\ =\ func;}
\DoxyCodeLine{03579\ \}}
\DoxyCodeLine{03580\ }
\DoxyCodeLine{03584\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a7b177984938793eded52205333ed306d}{PandaNode::}}}
\DoxyCodeLine{03585\ \mbox{\hyperlink{classPandaNode_a7b177984938793eded52205333ed306d}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{03586\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classPandaNode_a12bd6956299e3a1e6d351b8e1c9edec0}{make\_from\_bam}});}
\DoxyCodeLine{03587\ \}}
\DoxyCodeLine{03588\ }
\DoxyCodeLine{03593\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_ae9b3055297ade9bbf4a3b4dfc77e4506}{PandaNode::}}}
\DoxyCodeLine{03594\ \mbox{\hyperlink{classPandaNode_ae9b3055297ade9bbf4a3b4dfc77e4506}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{03595\ \ \ TypedWritable::write\_datagram(manager,\ dg);}
\DoxyCodeLine{03596\ \ \ dg.add\_string(get\_name());}
\DoxyCodeLine{03597\ }
\DoxyCodeLine{03598\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{03599\ \}}
\DoxyCodeLine{03600\ }
\DoxyCodeLine{03605\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a37c8bc773a8962235e9fcc121cd64477}{PandaNode::}}}
\DoxyCodeLine{03606\ \mbox{\hyperlink{classPandaNode_a37c8bc773a8962235e9fcc121cd64477}{update\_bam\_nested}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager)\ \{}
\DoxyCodeLine{03607\ \ \ \mbox{\hyperlink{classCycleDataReader}{CDReader}}\ cdata(\_cycler);}
\DoxyCodeLine{03608\ \ \ cdata-\/>update\_bam\_nested(manager);}
\DoxyCodeLine{03609\ \}}
\DoxyCodeLine{03610\ }
\DoxyCodeLine{03622\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a06e10804b3be197228447bacf80b07bc}{PandaNode::}}}
\DoxyCodeLine{03623\ \mbox{\hyperlink{classPandaNode_a06e10804b3be197228447bacf80b07bc}{write\_recorder}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{03624\ \ \ dg.add\_string(get\_name());}
\DoxyCodeLine{03625\ \}}
\DoxyCodeLine{03626\ }
\DoxyCodeLine{03632\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classPandaNode_a12bd6956299e3a1e6d351b8e1c9edec0}{PandaNode::}}}
\DoxyCodeLine{03633\ \mbox{\hyperlink{classPandaNode_a12bd6956299e3a1e6d351b8e1c9edec0}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{03634\ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPandaNode_ae4f746bb5bb08cecdac78ba6bd345d2f}{PandaNode}}(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{03635\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{03636\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{03637\ }
\DoxyCodeLine{03638\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{03639\ \ \ node-\/>\mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{fillin}}(scan,\ manager);}
\DoxyCodeLine{03640\ }
\DoxyCodeLine{03641\ \ \ \textcolor{keywordflow}{return}\ node;}
\DoxyCodeLine{03642\ \}}
\DoxyCodeLine{03643\ }
\DoxyCodeLine{03648\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{PandaNode::}}}
\DoxyCodeLine{03649\ \mbox{\hyperlink{classPandaNode_a924d7f721627231f4504db71809ad2c2}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{03650\ \ \ \mbox{\hyperlink{classTypedWritable_a3ad6cc1cd23bc3783d83edb3302bb43c}{TypedWritable::fillin}}(scan,\ manager);}
\DoxyCodeLine{03651\ }
\DoxyCodeLine{03652\ \ \ \mbox{\hyperlink{classPandaNode_a449ebdf8285bc42bb62c7fd1afe8ef7a}{remove\_all\_children}}();}
\DoxyCodeLine{03653\ }
\DoxyCodeLine{03654\ \ \ \textcolor{keywordtype}{string}\ name\ =\ scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}();}
\DoxyCodeLine{03655\ \ \ set\_name(name);}
\DoxyCodeLine{03656\ }
\DoxyCodeLine{03657\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{03658\ \}}
\DoxyCodeLine{03659\ }
\DoxyCodeLine{03665\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNode_af4ba5568cd5bbb57919ba1d4d5fb9e55}{PandaNode::}}}
\DoxyCodeLine{03666\ \mbox{\hyperlink{classPandaNode_af4ba5568cd5bbb57919ba1d4d5fb9e55}{fillin\_recorder}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *)\ \{}
\DoxyCodeLine{03667\ \ \ \textcolor{keywordtype}{string}\ name\ =\ scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}();}
\DoxyCodeLine{03668\ \ \ set\_name(name);}
\DoxyCodeLine{03669\ \}}
\DoxyCodeLine{03670\ }
\DoxyCodeLine{03674\ PandaNode::CData::}
\DoxyCodeLine{03675\ CData()\ :}
\DoxyCodeLine{03676\ \ \ \_state(\mbox{\hyperlink{classRenderState}{RenderState}}::make\_empty()),}
\DoxyCodeLine{03677\ \ \ \_transform(\mbox{\hyperlink{classTransformState}{TransformState}}::make\_identity()),}
\DoxyCodeLine{03678\ \ \ \_prev\_transform(\mbox{\hyperlink{classTransformState}{TransformState}}::make\_identity()),}
\DoxyCodeLine{03679\ }
\DoxyCodeLine{03680\ \ \ \_effects(\mbox{\hyperlink{classRenderEffects}{RenderEffects}}::make\_empty()),}
\DoxyCodeLine{03681\ \ \ \_draw\_control\_mask(\mbox{\hyperlink{classBitMask}{DrawMask}}::all\_off()),}
\DoxyCodeLine{03682\ \ \ \_draw\_show\_mask(\mbox{\hyperlink{classBitMask}{DrawMask}}::all\_on()),}
\DoxyCodeLine{03683\ \ \ \_into\_collide\_mask(\mbox{\hyperlink{classBitMask}{CollideMask}}::all\_off()),}
\DoxyCodeLine{03684\ \ \ \_bounds\_type(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}}::BT\_default),}
\DoxyCodeLine{03685\ \ \ \_user\_bounds(nullptr),}
\DoxyCodeLine{03686\ \ \ \_final\_bounds(false),}
\DoxyCodeLine{03687\ \ \ \_fancy\_bits(0),}
\DoxyCodeLine{03688\ }
\DoxyCodeLine{03689\ \ \ \_net\_collide\_mask(\mbox{\hyperlink{classBitMask}{CollideMask}}::all\_off()),}
\DoxyCodeLine{03690\ \ \ \_net\_draw\_control\_mask(\mbox{\hyperlink{classBitMask}{DrawMask}}::all\_off()),}
\DoxyCodeLine{03691\ \ \ \_net\_draw\_show\_mask(\mbox{\hyperlink{classBitMask}{DrawMask}}::all\_off()),}
\DoxyCodeLine{03692\ }
\DoxyCodeLine{03693\ \ \ \_down(new\ \mbox{\hyperlink{classPandaNode}{PandaNode}}::Down(\mbox{\hyperlink{classPandaNode}{PandaNode}}::get\_class\_type())),}
\DoxyCodeLine{03694\ \ \ \_stashed(new\ \mbox{\hyperlink{classPandaNode}{PandaNode}}::Down(\mbox{\hyperlink{classPandaNode}{PandaNode}}::get\_class\_type())),}
\DoxyCodeLine{03695\ \ \ \_up(new\ \mbox{\hyperlink{classPandaNode}{PandaNode}}::Up(\mbox{\hyperlink{classPandaNode}{PandaNode}}::get\_class\_type()))}
\DoxyCodeLine{03696\ \{}
\DoxyCodeLine{03697\ \ \ ++\_next\_update;}
\DoxyCodeLine{03698\ \}}
\DoxyCodeLine{03699\ }
\DoxyCodeLine{03703\ PandaNode::CData::}
\DoxyCodeLine{03704\ CData(\textcolor{keyword}{const}\ PandaNode::CData\ \&copy)\ :}
\DoxyCodeLine{03705\ \ \ BoundsData(copy),}
\DoxyCodeLine{03706\ \ \ \_state(copy.\_state),}
\DoxyCodeLine{03707\ \ \ \_transform(copy.\_transform),}
\DoxyCodeLine{03708\ \ \ \_prev\_transform(copy.\_prev\_transform),}
\DoxyCodeLine{03709\ }
\DoxyCodeLine{03710\ \ \ \_effects(copy.\_effects),}
\DoxyCodeLine{03711\ \ \ \_tag\_data(copy.\_tag\_data),}
\DoxyCodeLine{03712\ \ \ \_draw\_control\_mask(copy.\_draw\_control\_mask),}
\DoxyCodeLine{03713\ \ \ \_draw\_show\_mask(copy.\_draw\_show\_mask),}
\DoxyCodeLine{03714\ \ \ \_into\_collide\_mask(copy.\_into\_collide\_mask),}
\DoxyCodeLine{03715\ \ \ \_bounds\_type(copy.\_bounds\_type),}
\DoxyCodeLine{03716\ \ \ \_user\_bounds(copy.\_user\_bounds),}
\DoxyCodeLine{03717\ \ \ \_final\_bounds(copy.\_final\_bounds),}
\DoxyCodeLine{03718\ \ \ \_fancy\_bits(copy.\_fancy\_bits),}
\DoxyCodeLine{03719\ }
\DoxyCodeLine{03720\ \ \ \_net\_collide\_mask(copy.\_net\_collide\_mask),}
\DoxyCodeLine{03721\ \ \ \_net\_draw\_control\_mask(copy.\_net\_draw\_control\_mask),}
\DoxyCodeLine{03722\ \ \ \_net\_draw\_show\_mask(copy.\_net\_draw\_show\_mask),}
\DoxyCodeLine{03723\ \ \ \_off\_clip\_planes(copy.\_off\_clip\_planes),}
\DoxyCodeLine{03724\ \ \ \_nested\_vertices(copy.\_nested\_vertices),}
\DoxyCodeLine{03725\ \ \ \_external\_bounds(copy.\_external\_bounds),}
\DoxyCodeLine{03726\ \ \ \_last\_update(copy.\_last\_update),}
\DoxyCodeLine{03727\ \ \ \_next\_update(copy.\_next\_update),}
\DoxyCodeLine{03728\ \ \ \_last\_bounds\_update(copy.\_last\_bounds\_update),}
\DoxyCodeLine{03729\ }
\DoxyCodeLine{03730\ \ \ \_down(copy.\_down),}
\DoxyCodeLine{03731\ \ \ \_stashed(copy.\_stashed),}
\DoxyCodeLine{03732\ \ \ \_up(copy.\_up)}
\DoxyCodeLine{03733\ \{}
\DoxyCodeLine{03734\ \ \ \textcolor{comment}{//\ Note\ that\ this\ copy\ constructor\ is\ not\ used\ by\ the\ PandaNode\ copy}}
\DoxyCodeLine{03735\ \ \ \textcolor{comment}{//\ constructor!\ \ Any\ elements\ that\ must\ be\ copied\ between\ nodes\ should\ also}}
\DoxyCodeLine{03736\ \ \ \textcolor{comment}{//\ be\ explicitly\ copied\ there.}}
\DoxyCodeLine{03737\ \}}
\DoxyCodeLine{03738\ }
\DoxyCodeLine{03742\ PandaNode::CData::}
\DoxyCodeLine{03743\ \string~CData()\ \{}
\DoxyCodeLine{03744\ \}}
\DoxyCodeLine{03745\ }
\DoxyCodeLine{03749\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *PandaNode::CData::}
\DoxyCodeLine{03750\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03751\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{03752\ \}}
\DoxyCodeLine{03753\ }
\DoxyCodeLine{03758\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03759\ write\_datagram(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03760\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ \_state);}
\DoxyCodeLine{03761\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ \_transform);}
\DoxyCodeLine{03762\ }
\DoxyCodeLine{03763\ }
\DoxyCodeLine{03764\ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ \_effects);}
\DoxyCodeLine{03765\ }
\DoxyCodeLine{03766\ \ \ dg.add\_uint32(\_draw\_control\_mask.get\_word());}
\DoxyCodeLine{03767\ \ \ dg.add\_uint32(\_draw\_show\_mask.get\_word());}
\DoxyCodeLine{03768\ \ \ dg.add\_uint32(\_into\_collide\_mask.get\_word());}
\DoxyCodeLine{03769\ \ \ dg.add\_uint8(\_bounds\_type);}
\DoxyCodeLine{03770\ }
\DoxyCodeLine{03771\ \ \ dg.add\_uint32(\_tag\_data.size());}
\DoxyCodeLine{03772\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ n\ =\ 0;\ n\ <\ \_tag\_data.size();\ ++n)\ \{}
\DoxyCodeLine{03773\ \ \ \ \ dg.add\_string(\_tag\_data.get\_key(n));}
\DoxyCodeLine{03774\ \ \ \ \ dg.add\_string(\_tag\_data.get\_data(n));}
\DoxyCodeLine{03775\ \ \ \}}
\DoxyCodeLine{03776\ }
\DoxyCodeLine{03777\ \ \ write\_up\_list(*get\_up(),\ manager,\ dg);}
\DoxyCodeLine{03778\ \ \ write\_down\_list(*get\_down(),\ manager,\ dg);}
\DoxyCodeLine{03779\ \ \ write\_down\_list(*get\_stashed(),\ manager,\ dg);}
\DoxyCodeLine{03780\ \}}
\DoxyCodeLine{03781\ }
\DoxyCodeLine{03786\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03787\ update\_bam\_nested(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03788\ \ \ \textcolor{comment}{//\ No\ need\ to\ check\ the\ state\ pointers\ for\ updates,\ since\ they're\ all}}
\DoxyCodeLine{03789\ \ \ \textcolor{comment}{//\ immutable\ objects.\ \ manager-\/>consider\_update(\_state);}}
\DoxyCodeLine{03790\ \ \ \textcolor{comment}{//\ manager-\/>consider\_update(\_transform);\ manager-\/>consider\_update(\_effects);}}
\DoxyCodeLine{03791\ }
\DoxyCodeLine{03792\ \ \ update\_up\_list(*get\_up(),\ manager);}
\DoxyCodeLine{03793\ \ \ update\_down\_list(*get\_down(),\ manager);}
\DoxyCodeLine{03794\ \ \ update\_down\_list(*get\_stashed(),\ manager);}
\DoxyCodeLine{03795\ \}}
\DoxyCodeLine{03796\ }
\DoxyCodeLine{03801\ \textcolor{keywordtype}{int}\ PandaNode::CData::}
\DoxyCodeLine{03802\ complete\_pointers(\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{03803\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ \mbox{\hyperlink{classCycleData_afae68c5bc34c5cd6ab858d009fbdf1b3}{CycleData::complete\_pointers}}(p\_list,\ manager);}
\DoxyCodeLine{03804\ }
\DoxyCodeLine{03805\ \ \ \textcolor{comment}{//\ Get\ the\ state\ and\ transform\ pointers.}}
\DoxyCodeLine{03806\ \ \ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state;}
\DoxyCodeLine{03807\ \ \ DCAST\_INTO\_R(state,\ p\_list[pi++],\ pi);}
\DoxyCodeLine{03808\ \ \ \_state\ =\ state;}
\DoxyCodeLine{03809\ }
\DoxyCodeLine{03810\ \ \ \mbox{\hyperlink{classTransformState}{TransformState}}\ *transform;}
\DoxyCodeLine{03811\ \ \ DCAST\_INTO\_R(transform,\ p\_list[pi++],\ pi);}
\DoxyCodeLine{03812\ \ \ \_prev\_transform\ =\ \_transform\ =\ transform;}
\DoxyCodeLine{03813\ }
\DoxyCodeLine{03814\ \textcolor{comment}{/*}}
\DoxyCodeLine{03815\ \textcolor{comment}{\ *\ Finalize\ these\ pointers\ now\ to\ decrement\ their\ artificially-\/held\ reference}}
\DoxyCodeLine{03816\ \textcolor{comment}{\ *\ counts.\ \ We\ do\ this\ now,\ rather\ than\ later,\ in\ case\ some\ other\ object}}
\DoxyCodeLine{03817\ \textcolor{comment}{\ *\ reassigns\ them\ a\ little\ later\ on\ during\ initialization,\ before\ they\ can}}
\DoxyCodeLine{03818\ \textcolor{comment}{\ *\ finalize\ themselves\ normally\ (for\ instance,\ the\ character\ may\ change\ the}}
\DoxyCodeLine{03819\ \textcolor{comment}{\ *\ node's\ transform).\ \ If\ that\ happens,\ the\ pointer\ may\ discover\ that\ no\ one}}
\DoxyCodeLine{03820\ \textcolor{comment}{\ *\ else\ holds\ its\ reference\ count\ when\ it\ finalizes,\ which\ will\ constitute\ a}}
\DoxyCodeLine{03821\ \textcolor{comment}{\ *\ memory\ leak\ (see\ the\ comments\ in\ TransformState::finalize(),\ etc.).}}
\DoxyCodeLine{03822\ \textcolor{comment}{\ */}}
\DoxyCodeLine{03823\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a786911fd5b8d98eed701a3bb6e2b3a19}{finalize\_now}}((\mbox{\hyperlink{classRenderState}{RenderState}}\ *)\_state.p());}
\DoxyCodeLine{03824\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a786911fd5b8d98eed701a3bb6e2b3a19}{finalize\_now}}((\mbox{\hyperlink{classTransformState}{TransformState}}\ *)\_transform.p());}
\DoxyCodeLine{03825\ }
\DoxyCodeLine{03826\ }
\DoxyCodeLine{03827\ }
\DoxyCodeLine{03828\ \ \ \textcolor{comment}{//\ Get\ the\ effects\ pointer.}}
\DoxyCodeLine{03829\ \ \ \mbox{\hyperlink{classRenderEffects}{RenderEffects}}\ *effects;}
\DoxyCodeLine{03830\ \ \ DCAST\_INTO\_R(effects,\ p\_list[pi++],\ pi);}
\DoxyCodeLine{03831\ \ \ \_effects\ =\ effects;}
\DoxyCodeLine{03832\ }
\DoxyCodeLine{03833\ \textcolor{comment}{/*}}
\DoxyCodeLine{03834\ \textcolor{comment}{\ *\ Finalize\ these\ pointers\ now\ to\ decrement\ their\ artificially-\/held\ reference}}
\DoxyCodeLine{03835\ \textcolor{comment}{\ *\ counts.\ \ We\ do\ this\ now,\ rather\ than\ later,\ in\ case\ some\ other\ object}}
\DoxyCodeLine{03836\ \textcolor{comment}{\ *\ reassigns\ them\ a\ little\ later\ on\ during\ initialization,\ before\ they\ can}}
\DoxyCodeLine{03837\ \textcolor{comment}{\ *\ finalize\ themselves\ normally\ (for\ instance,\ the\ character\ may\ change\ the}}
\DoxyCodeLine{03838\ \textcolor{comment}{\ *\ node's\ transform).\ \ If\ that\ happens,\ the\ pointer\ may\ discover\ that\ no\ one}}
\DoxyCodeLine{03839\ \textcolor{comment}{\ *\ else\ holds\ its\ reference\ count\ when\ it\ finalizes,\ which\ will\ constitute\ a}}
\DoxyCodeLine{03840\ \textcolor{comment}{\ *\ memory\ leak\ (see\ the\ comments\ in\ TransformState::finalize(),\ etc.).}}
\DoxyCodeLine{03841\ \textcolor{comment}{\ */}}
\DoxyCodeLine{03842\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a786911fd5b8d98eed701a3bb6e2b3a19}{finalize\_now}}((\mbox{\hyperlink{classRenderEffects}{RenderEffects}}\ *)\_effects.p());}
\DoxyCodeLine{03843\ }
\DoxyCodeLine{03844\ }
\DoxyCodeLine{03845\ }
\DoxyCodeLine{03846\ \ \ \textcolor{comment}{//\ Get\ the\ parent\ and\ child\ pointers.}}
\DoxyCodeLine{03847\ \ \ pi\ +=\ complete\_up\_list(*modify\_up(),\ \textcolor{stringliteral}{"{}up"{}},\ p\_list\ +\ pi,\ manager);}
\DoxyCodeLine{03848\ \ \ pi\ +=\ complete\_down\_list(*modify\_down(),\ \textcolor{stringliteral}{"{}down"{}},\ p\_list\ +\ pi,\ manager);}
\DoxyCodeLine{03849\ \ \ pi\ +=\ complete\_down\_list(*modify\_stashed(),\ \textcolor{stringliteral}{"{}stashed"{}},\ p\_list\ +\ pi,\ manager);}
\DoxyCodeLine{03850\ }
\DoxyCodeLine{03851\ \ \ \textcolor{comment}{//\ Since\ the\ \_effects\ and\ \_states\ members\ have\ been\ finalized\ by\ now,\ this}}
\DoxyCodeLine{03852\ \ \ \textcolor{comment}{//\ should\ be\ safe.}}
\DoxyCodeLine{03853\ \ \ set\_fancy\_bit(FB\_transform,\ !\_transform-\/>is\_identity());}
\DoxyCodeLine{03854\ \ \ set\_fancy\_bit(FB\_state,\ !\_state-\/>is\_empty());}
\DoxyCodeLine{03855\ \ \ set\_fancy\_bit(FB\_effects,\ !\_effects-\/>is\_empty());}
\DoxyCodeLine{03856\ \ \ set\_fancy\_bit(FB\_tag,\ !\_tag\_data.is\_empty());}
\DoxyCodeLine{03857\ \ \ set\_fancy\_bit(FB\_decal,\ \_effects-\/>has\_decal());}
\DoxyCodeLine{03858\ \ \ set\_fancy\_bit(FB\_show\_bounds,\ \_effects-\/>has\_show\_bounds());}
\DoxyCodeLine{03859\ \ \ set\_fancy\_bit(FB\_show\_tight\_bounds,\ \_effects-\/>has\_show\_tight\_bounds());}
\DoxyCodeLine{03860\ }
\DoxyCodeLine{03861\ \ \ \textcolor{comment}{//\ Mark\ the\ bounds\ stale.}}
\DoxyCodeLine{03862\ \ \ ++\_next\_update;}
\DoxyCodeLine{03863\ }
\DoxyCodeLine{03864\ \ \ nassertr(!\_transform-\/>is\_invalid(),\ pi);}
\DoxyCodeLine{03865\ \ \ nassertr(!\_prev\_transform-\/>is\_invalid(),\ pi);}
\DoxyCodeLine{03866\ }
\DoxyCodeLine{03867\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{03868\ \}}
\DoxyCodeLine{03869\ }
\DoxyCodeLine{03874\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03875\ fillin(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{03876\ \ \ \textcolor{comment}{//\ Read\ the\ state\ and\ transform\ pointers.}}
\DoxyCodeLine{03877\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{03878\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{03879\ }
\DoxyCodeLine{03880\ \ \ \textcolor{comment}{//\ Read\ the\ effects\ pointer.}}
\DoxyCodeLine{03881\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{03882\ }
\DoxyCodeLine{03883\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ <\ 2)\ \{}
\DoxyCodeLine{03884\ \ \ \ \ \mbox{\hyperlink{classBitMask}{DrawMask}}\ draw\_mask;}
\DoxyCodeLine{03885\ \ \ \ \ draw\_mask.set\_word(scan.get\_uint32());}
\DoxyCodeLine{03886\ }
\DoxyCodeLine{03887\ \ \ \ \ \textcolor{keywordflow}{if}\ (draw\_mask\ ==\ DrawMask::all\_off())\ \{}
\DoxyCodeLine{03888\ \ \ \ \ \ \ \textcolor{comment}{//\ Hidden.}}
\DoxyCodeLine{03889\ \ \ \ \ \ \ \_draw\_control\_mask\ =\ \_overall\_bit;}
\DoxyCodeLine{03890\ \ \ \ \ \ \ \_draw\_show\_mask\ =\ \string~\_overall\_bit;}
\DoxyCodeLine{03891\ }
\DoxyCodeLine{03892\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (draw\_mask\ ==\ DrawMask::all\_on())\ \{}
\DoxyCodeLine{03893\ \ \ \ \ \ \ \textcolor{comment}{//\ Normally\ visible.}}
\DoxyCodeLine{03894\ \ \ \ \ \ \ \_draw\_control\_mask\ =\ DrawMask::all\_off();}
\DoxyCodeLine{03895\ \ \ \ \ \ \ \_draw\_show\_mask\ =\ DrawMask::all\_on();}
\DoxyCodeLine{03896\ }
\DoxyCodeLine{03897\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03898\ \ \ \ \ \ \ \textcolor{comment}{//\ Some\ per-\/camera\ combination.}}
\DoxyCodeLine{03899\ \ \ \ \ \ \ draw\_mask\ \&=\ \string~\_overall\_bit;}
\DoxyCodeLine{03900\ \ \ \ \ \ \ \_draw\_control\_mask\ =\ \string~draw\_mask;}
\DoxyCodeLine{03901\ \ \ \ \ \ \ \_draw\_show\_mask\ =\ draw\_mask;}
\DoxyCodeLine{03902\ \ \ \ \ \}}
\DoxyCodeLine{03903\ }
\DoxyCodeLine{03904\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03905\ \ \ \ \ \_draw\_control\_mask.set\_word(scan.get\_uint32());}
\DoxyCodeLine{03906\ \ \ \ \ \_draw\_show\_mask.set\_word(scan.get\_uint32());}
\DoxyCodeLine{03907\ \ \ \}}
\DoxyCodeLine{03908\ }
\DoxyCodeLine{03909\ \ \ \_into\_collide\_mask.set\_word(scan.get\_uint32());}
\DoxyCodeLine{03910\ }
\DoxyCodeLine{03911\ \ \ \_bounds\_type\ =\ BoundingVolume::BT\_default;}
\DoxyCodeLine{03912\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 19)\ \{}
\DoxyCodeLine{03913\ \ \ \ \ \_bounds\_type\ =\ (BoundingVolume::BoundsType)scan.get\_uint8();}
\DoxyCodeLine{03914\ \ \ \}}
\DoxyCodeLine{03915\ }
\DoxyCodeLine{03916\ \ \ \textcolor{comment}{//\ Read\ in\ the\ tag\ list.}}
\DoxyCodeLine{03917\ \ \ \textcolor{keywordtype}{int}\ num\_tags\ =\ scan.get\_uint32();}
\DoxyCodeLine{03918\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_tags;\ i++)\ \{}
\DoxyCodeLine{03919\ \ \ \ \ \textcolor{keywordtype}{string}\ key\ =\ scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}();}
\DoxyCodeLine{03920\ \ \ \ \ \textcolor{keywordtype}{string}\ value\ =\ scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}();}
\DoxyCodeLine{03921\ \ \ \ \ \_tag\_data.store(key,\ value);}
\DoxyCodeLine{03922\ \ \ \}}
\DoxyCodeLine{03923\ }
\DoxyCodeLine{03924\ }
\DoxyCodeLine{03925\ \ \ fillin\_up\_list(*modify\_up(),\ \textcolor{stringliteral}{"{}up"{}},\ scan,\ manager);}
\DoxyCodeLine{03926\ \ \ fillin\_down\_list(*modify\_down(),\ \textcolor{stringliteral}{"{}down"{}},\ scan,\ manager);}
\DoxyCodeLine{03927\ \ \ fillin\_down\_list(*modify\_stashed(),\ \textcolor{stringliteral}{"{}stashed"{}},\ scan,\ manager);}
\DoxyCodeLine{03928\ \}}
\DoxyCodeLine{03929\ }
\DoxyCodeLine{03933\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03934\ write\_up\_list(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Up}}\ \&up\_list,}
\DoxyCodeLine{03935\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03936\ \textcolor{comment}{/*}}
\DoxyCodeLine{03937\ \textcolor{comment}{\ *\ When\ we\ write\ a\ PandaNode,\ we\ write\ out\ its\ complete\ list\ of\ child\ node}}
\DoxyCodeLine{03938\ \textcolor{comment}{\ *\ pointers,\ but\ we\ only\ write\ out\ the\ parent\ node\ pointers\ that\ have\ already}}
\DoxyCodeLine{03939\ \textcolor{comment}{\ *\ been\ added\ to\ the\ bam\ file\ by\ a\ previous\ write\ operation.\ \ This\ is\ a\ bit\ of}}
\DoxyCodeLine{03940\ \textcolor{comment}{\ *\ trickery\ that\ allows\ us\ to\ write\ out\ just\ a\ subgraph\ (instead\ of\ the}}
\DoxyCodeLine{03941\ \textcolor{comment}{\ *\ complete\ graph)\ when\ we\ write\ out\ an\ arbitrary\ node\ in\ the\ graph,\ yet\ also}}
\DoxyCodeLine{03942\ \textcolor{comment}{\ *\ allows\ us\ to\ keep\ nodes\ completely\ in\ sync\ when\ we\ use\ the\ bam\ format\ for}}
\DoxyCodeLine{03943\ \textcolor{comment}{\ *\ streaming\ scene\ graph\ operations\ over\ the\ network.}}
\DoxyCodeLine{03944\ \textcolor{comment}{\ */}}
\DoxyCodeLine{03945\ }
\DoxyCodeLine{03946\ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ 0;}
\DoxyCodeLine{03947\ \ \ Up::const\_iterator\ ui;}
\DoxyCodeLine{03948\ \ \ \textcolor{keywordflow}{for}\ (ui\ =\ up\_list.begin();\ ui\ !=\ up\_list.end();\ ++ui)\ \{}
\DoxyCodeLine{03949\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ (*ui).get\_parent();}
\DoxyCodeLine{03950\ \ \ \ \ \textcolor{keywordflow}{if}\ (manager-\/>has\_object(parent\_node))\ \{}
\DoxyCodeLine{03951\ \ \ \ \ \ \ num\_parents++;}
\DoxyCodeLine{03952\ \ \ \ \ \}}
\DoxyCodeLine{03953\ \ \ \}}
\DoxyCodeLine{03954\ \ \ nassertv(num\_parents\ ==\ (\textcolor{keywordtype}{int})(uint16\_t)num\_parents);}
\DoxyCodeLine{03955\ \ \ dg.add\_uint16(num\_parents);}
\DoxyCodeLine{03956\ \ \ \textcolor{keywordflow}{for}\ (ui\ =\ up\_list.begin();\ ui\ !=\ up\_list.end();\ ++ui)\ \{}
\DoxyCodeLine{03957\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ (*ui).get\_parent();}
\DoxyCodeLine{03958\ \ \ \ \ \textcolor{keywordflow}{if}\ (manager-\/>has\_object(parent\_node))\ \{}
\DoxyCodeLine{03959\ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ parent\_node);}
\DoxyCodeLine{03960\ \ \ \ \ \}}
\DoxyCodeLine{03961\ \ \ \}}
\DoxyCodeLine{03962\ \}}
\DoxyCodeLine{03963\ }
\DoxyCodeLine{03967\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03968\ write\_down\_list(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Down}}\ \&down\_list,}
\DoxyCodeLine{03969\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03970\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ down\_list.size();}
\DoxyCodeLine{03971\ \ \ nassertv(num\_children\ ==\ (\textcolor{keywordtype}{int})(uint16\_t)num\_children);}
\DoxyCodeLine{03972\ \ \ dg.add\_uint16(num\_children);}
\DoxyCodeLine{03973\ }
\DoxyCodeLine{03974\ \ \ \textcolor{comment}{//\ Should\ we\ smarten\ up\ the\ writing\ of\ the\ sort\ number?\ \ Most\ of\ the\ time}}
\DoxyCodeLine{03975\ \ \ \textcolor{comment}{//\ these\ will\ all\ be\ zero.}}
\DoxyCodeLine{03976\ \ \ Down::const\_iterator\ di;}
\DoxyCodeLine{03977\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ down\_list.begin();\ di\ !=\ down\_list.end();\ ++di)\ \{}
\DoxyCodeLine{03978\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ (*di).get\_child();}
\DoxyCodeLine{03979\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ (*di).get\_sort();}
\DoxyCodeLine{03980\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a634bd4eb8e9b33ffde91a27c02f80467}{write\_pointer}}(dg,\ child\_node);}
\DoxyCodeLine{03981\ \ \ \ \ dg.add\_int32(sort);}
\DoxyCodeLine{03982\ \ \ \}}
\DoxyCodeLine{03983\ \}}
\DoxyCodeLine{03984\ }
\DoxyCodeLine{03988\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{03989\ update\_up\_list(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Up}}\ \&up\_list,\ \mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03990\ \ \ Up::const\_iterator\ ui;}
\DoxyCodeLine{03991\ \ \ \textcolor{keywordflow}{for}\ (ui\ =\ up\_list.begin();\ ui\ !=\ up\_list.end();\ ++ui)\ \{}
\DoxyCodeLine{03992\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ (*ui).get\_parent();}
\DoxyCodeLine{03993\ \ \ \ \ \textcolor{keywordflow}{if}\ (manager-\/>has\_object(parent\_node))\ \{}
\DoxyCodeLine{03994\ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a32f116d6443b307888b8d477c0c45277}{consider\_update}}(parent\_node);}
\DoxyCodeLine{03995\ \ \ \ \ \}}
\DoxyCodeLine{03996\ \ \ \}}
\DoxyCodeLine{03997\ \}}
\DoxyCodeLine{03998\ }
\DoxyCodeLine{04002\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{04003\ update\_down\_list(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Down}}\ \&down\_list,\ \mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{04004\ \ \ Down::const\_iterator\ di;}
\DoxyCodeLine{04005\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ down\_list.begin();\ di\ !=\ down\_list.end();\ ++di)\ \{}
\DoxyCodeLine{04006\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ (*di).get\_child();}
\DoxyCodeLine{04007\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a32f116d6443b307888b8d477c0c45277}{consider\_update}}(child\_node);}
\DoxyCodeLine{04008\ \ \ \}}
\DoxyCodeLine{04009\ \}}
\DoxyCodeLine{04010\ }
\DoxyCodeLine{04014\ \textcolor{keywordtype}{int}\ PandaNode::CData::}
\DoxyCodeLine{04015\ complete\_up\_list(\mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Up}}\ \&up\_list,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&tag,}
\DoxyCodeLine{04016\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{04017\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ 0;}
\DoxyCodeLine{04018\ }
\DoxyCodeLine{04019\ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ manager-\/>\mbox{\hyperlink{classBamReader_a2eed6914e03be304c6cf14ea291d97e6}{get\_int\_tag}}(tag);}
\DoxyCodeLine{04020\ \ \ Up\ new\_up\_list(PandaNode::get\_class\_type());}
\DoxyCodeLine{04021\ \ \ new\_up\_list.reserve(num\_parents);}
\DoxyCodeLine{04022\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_parents;\ i++)\ \{}
\DoxyCodeLine{04023\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *parent\_node\ =\ DCAST(\mbox{\hyperlink{classPandaNode}{PandaNode}},\ p\_list[pi++]);}
\DoxyCodeLine{04024\ \ \ \ \ UpConnection\ connection(parent\_node);}
\DoxyCodeLine{04025\ \ \ \ \ new\_up\_list.push\_back(connection);}
\DoxyCodeLine{04026\ \ \ \}}
\DoxyCodeLine{04027\ }
\DoxyCodeLine{04028\ \ \ \textcolor{comment}{//\ Now\ we\ should\ sort\ the\ list,\ since\ the\ sorting\ is\ based\ on\ pointer\ order,}}
\DoxyCodeLine{04029\ \ \ \textcolor{comment}{//\ which\ might\ be\ different\ from\ one\ session\ to\ the\ next.}}
\DoxyCodeLine{04030\ \ \ new\_up\_list.sort();}
\DoxyCodeLine{04031\ }
\DoxyCodeLine{04032\ \ \ \textcolor{comment}{//\ Make\ it\ permanent.}}
\DoxyCodeLine{04033\ \ \ up\_list\ =\ std::move(new\_up\_list);}
\DoxyCodeLine{04034\ }
\DoxyCodeLine{04035\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{04036\ \}}
\DoxyCodeLine{04037\ }
\DoxyCodeLine{04041\ \textcolor{keywordtype}{int}\ PandaNode::CData::}
\DoxyCodeLine{04042\ complete\_down\_list(\mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Down}}\ \&down\_list,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&tag,}
\DoxyCodeLine{04043\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ **p\_list,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{04044\ \ \ \textcolor{keywordtype}{int}\ pi\ =\ 0;}
\DoxyCodeLine{04045\ }
\DoxyCodeLine{04046\ \ \ BamReaderAuxDataDown\ *aux;}
\DoxyCodeLine{04047\ \ \ DCAST\_INTO\_R(aux,\ manager-\/>\mbox{\hyperlink{classBamReader_a731a71d6c4028513e2685a5f633692ab}{get\_aux\_tag}}(tag),\ pi);}
\DoxyCodeLine{04048\ }
\DoxyCodeLine{04049\ \ \ Down\ \&new\_down\_list\ =\ aux-\/>\_down\_list;}
\DoxyCodeLine{04050\ \ \ \textcolor{keywordflow}{for}\ (Down::iterator\ di\ =\ new\_down\_list.begin();}
\DoxyCodeLine{04051\ \ \ \ \ \ \ \ di\ !=\ new\_down\_list.end();}
\DoxyCodeLine{04052\ \ \ \ \ \ \ \ ++di)\ \{}
\DoxyCodeLine{04053\ \ \ \ \ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *child\_node\ =\ DCAST(\mbox{\hyperlink{classPandaNode}{PandaNode}},\ p\_list[pi++]);}
\DoxyCodeLine{04054\ \ \ \ \ (*di).set\_child(child\_node);}
\DoxyCodeLine{04055\ \ \ \}}
\DoxyCodeLine{04056\ }
\DoxyCodeLine{04057\ \ \ \textcolor{comment}{//\ Unlike\ the\ up\ list,\ we\ should\ *not*\ sort\ the\ down\ list.\ \ The\ down\ list\ is}}
\DoxyCodeLine{04058\ \ \ \textcolor{comment}{//\ stored\ in\ a\ specific\ order,\ not\ related\ to\ pointer\ order;\ and\ this\ order}}
\DoxyCodeLine{04059\ \ \ \textcolor{comment}{//\ should\ be\ preserved\ from\ one\ session\ to\ the\ next.}}
\DoxyCodeLine{04060\ }
\DoxyCodeLine{04061\ \ \ \textcolor{comment}{//\ Make\ it\ permanent.}}
\DoxyCodeLine{04062\ \ \ down\_list\ =\ std::move(new\_down\_list);}
\DoxyCodeLine{04063\ }
\DoxyCodeLine{04064\ \ \ \textcolor{keywordflow}{return}\ pi;}
\DoxyCodeLine{04065\ \}}
\DoxyCodeLine{04066\ }
\DoxyCodeLine{04071\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{04072\ fillin\_up\_list(\mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Up}}\ \&up\_list,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&tag,}
\DoxyCodeLine{04073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{04074\ \ \ \textcolor{keywordtype}{int}\ num\_parents\ =\ scan.get\_uint16();}
\DoxyCodeLine{04075\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_abd83f808114527e3b7b0a40cab0ca761}{set\_int\_tag}}(tag,\ num\_parents);}
\DoxyCodeLine{04076\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a10ea3ed8500e58d80ff4c58e4f1771cb}{read\_pointers}}(scan,\ num\_parents);}
\DoxyCodeLine{04077\ \}}
\DoxyCodeLine{04078\ }
\DoxyCodeLine{04083\ \textcolor{keywordtype}{void}\ PandaNode::CData::}
\DoxyCodeLine{04084\ fillin\_down\_list(\mbox{\hyperlink{classCopyOnWriteObj1}{PandaNode::Down}}\ \&down\_list,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&tag,}
\DoxyCodeLine{04085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{04086\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ scan.get\_uint16();}
\DoxyCodeLine{04087\ }
\DoxyCodeLine{04088\ \ \ \textcolor{comment}{//\ Create\ a\ temporary\ down\_list,\ with\ the\ right\ number\ of\ elements,\ but\ a}}
\DoxyCodeLine{04089\ \ \ \textcolor{comment}{//\ NULL\ value\ for\ each\ pointer\ (we'll\ fill\ in\ the\ pointers\ later).\ \ We\ need}}
\DoxyCodeLine{04090\ \ \ \textcolor{comment}{//\ to\ do\ this\ to\ associate\ the\ sort\ values\ with\ their\ pointers.}}
\DoxyCodeLine{04091\ \ \ Down\ new\_down\_list(PandaNode::get\_class\_type());}
\DoxyCodeLine{04092\ \ \ new\_down\_list.reserve(num\_children);}
\DoxyCodeLine{04093\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{04094\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ac0ecc0609d9c6de514145777b3336435}{read\_pointer}}(scan);}
\DoxyCodeLine{04095\ \ \ \ \ \textcolor{keywordtype}{int}\ sort\ =\ scan.get\_int32();}
\DoxyCodeLine{04096\ \ \ \ \ DownConnection\ connection(\textcolor{keyword}{nullptr},\ sort);}
\DoxyCodeLine{04097\ \ \ \ \ new\_down\_list.push\_back(connection);}
\DoxyCodeLine{04098\ \ \ \}}
\DoxyCodeLine{04099\ }
\DoxyCodeLine{04100\ \ \ \textcolor{comment}{//\ Now\ store\ the\ temporary\ down\_list\ in\ the\ BamReader,\ so\ we\ can\ get\ it}}
\DoxyCodeLine{04101\ \ \ \textcolor{comment}{//\ during\ the\ call\ to\ complete\_down\_list().}}
\DoxyCodeLine{04102\ \ \ PT(BamReaderAuxDataDown)\ aux\ =\ \textcolor{keyword}{new}\ BamReaderAuxDataDown;}
\DoxyCodeLine{04103\ \ \ aux-\/>\_down\_list.swap(new\_down\_list);}
\DoxyCodeLine{04104\ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a8aa3682ea4e1d6fb08f88fb3f65104d0}{set\_aux\_tag}}(tag,\ aux);}
\DoxyCodeLine{04105\ \}}
\DoxyCodeLine{04106\ }
\DoxyCodeLine{04111\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPandaNodePipelineReader_a44960a8d7170dfcee0af80854ade08d2}{PandaNodePipelineReader::}}}
\DoxyCodeLine{04112\ \mbox{\hyperlink{classPandaNodePipelineReader_a44960a8d7170dfcee0af80854ade08d2}{check\_cached}}(\textcolor{keywordtype}{bool}\ update\_bounds)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{04113\ \ \ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ last\_update\ =\ update\_bounds}
\DoxyCodeLine{04114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ?\ \_cdata-\/>\_last\_bounds\_update}
\DoxyCodeLine{04115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \_cdata-\/>\_last\_update;}
\DoxyCodeLine{04116\ }
\DoxyCodeLine{04117\ \ \ \textcolor{keywordflow}{if}\ (last\_update\ !=\ \_cdata-\/>\_next\_update)\ \{}
\DoxyCodeLine{04118\ \ \ \ \ \textcolor{comment}{//\ The\ cache\ is\ stale;\ it\ needs\ to\ be\ rebuilt.}}
\DoxyCodeLine{04119\ }
\DoxyCodeLine{04120\ \ \ \ \ \textcolor{comment}{//\ We'll\ need\ to\ get\ a\ fresh\ read\ pointer,\ since\ another\ thread\ might}}
\DoxyCodeLine{04121\ \ \ \ \ \textcolor{comment}{//\ already\ have\ modified\ the\ pointer\ on\ the\ object\ since\ we\ queried\ it.}}
\DoxyCodeLine{04122\ \textcolor{preprocessor}{\#ifdef\ DO\_PIPELINING}}
\DoxyCodeLine{04123\ \ \ \ \ node\_unref\_delete((\mbox{\hyperlink{classCycleData}{CycleData}}\ *)\_cdata);}
\DoxyCodeLine{04124\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DO\_PIPELINING}}
\DoxyCodeLine{04125\ \ \ \ \ ((\mbox{\hyperlink{classPandaNodePipelineReader}{PandaNodePipelineReader}}\ *)\textcolor{keyword}{this})-\/>\_cdata\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{04126\ \ \ \ \ \textcolor{keywordtype}{int}\ pipeline\_stage\ =\ \_current\_thread-\/>get\_pipeline\_stage();}
\DoxyCodeLine{04127\ \ \ \ \ \mbox{\hyperlink{classCycleDataLockedStageReader}{PandaNode::CDLockedStageReader}}\ fresh\_cdata(\_node-\/>\_cycler,\ pipeline\_stage,\ \_current\_thread);}
\DoxyCodeLine{04128\ \ \ \ \ \textcolor{keywordflow}{if}\ (fresh\_cdata-\/>\_last\_update\ ==\ fresh\_cdata-\/>\_next\_update\ \&\&}
\DoxyCodeLine{04129\ \ \ \ \ \ \ \ \ (!update\_bounds\ ||\ fresh\_cdata-\/>\_last\_bounds\_update\ ==\ fresh\_cdata-\/>\_next\_update))\ \{}
\DoxyCodeLine{04130\ \ \ \ \ \ \ \textcolor{comment}{//\ What\ luck,\ some\ other\ thread\ has\ already\ freshened\ the\ cache\ for\ us.}}
\DoxyCodeLine{04131\ \ \ \ \ \ \ \textcolor{comment}{//\ Save\ the\ new\ pointer,\ and\ let\ the\ lock\ release\ itself.}}
\DoxyCodeLine{04132\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_cdata\ !=\ (\textcolor{keyword}{const}\ PandaNode::CData\ *)fresh\_cdata)\ \{}
\DoxyCodeLine{04133\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNodePipelineReader}{PandaNodePipelineReader}}\ *)\textcolor{keyword}{this})-\/>\_cdata\ =\ fresh\_cdata;}
\DoxyCodeLine{04134\ \textcolor{preprocessor}{\#ifdef\ DO\_PIPELINING}}
\DoxyCodeLine{04135\ \ \ \ \ \ \ \ \ \_cdata-\/>node\_ref();}
\DoxyCodeLine{04136\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DO\_PIPELINING}}
\DoxyCodeLine{04137\ \ \ \ \ \ \ \}}
\DoxyCodeLine{04138\ }
\DoxyCodeLine{04139\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{04140\ \ \ \ \ \ \ \textcolor{comment}{//\ No,\ the\ cache\ is\ still\ stale.\ \ We\ have\ to\ do\ the\ work\ of\ freshening}}
\DoxyCodeLine{04141\ \ \ \ \ \ \ \textcolor{comment}{//\ it.}}
\DoxyCodeLine{04142\ \ \ \ \ \ \ \mbox{\hyperlink{classPStatTimer}{PStatTimer}}\ timer(PandaNode::\_update\_bounds\_pcollector);}
\DoxyCodeLine{04143\ \ \ \ \ \ \ \mbox{\hyperlink{classCycleDataStageWriter}{PandaNode::CDStageWriter}}\ cdataw\ =\ ((\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *)\_node)-\/>update\_cached(update\_bounds,\ pipeline\_stage,\ fresh\_cdata);}
\DoxyCodeLine{04144\ \ \ \ \ \ \ nassertv(cdataw-\/>\_last\_update\ ==\ cdataw-\/>\_next\_update);}
\DoxyCodeLine{04145\ \ \ \ \ \ \ \textcolor{comment}{//\ As\ above,\ we\ save\ the\ new\ pointer,\ and\ then\ let\ the\ lock\ release}}
\DoxyCodeLine{04146\ \ \ \ \ \ \ \textcolor{comment}{//\ itself.}}
\DoxyCodeLine{04147\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_cdata\ !=\ (\textcolor{keyword}{const}\ PandaNode::CData\ *)cdataw)\ \{}
\DoxyCodeLine{04148\ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{classPandaNodePipelineReader}{PandaNodePipelineReader}}\ *)\textcolor{keyword}{this})-\/>\_cdata\ =\ cdataw;}
\DoxyCodeLine{04149\ \textcolor{preprocessor}{\#ifdef\ DO\_PIPELINING}}
\DoxyCodeLine{04150\ \ \ \ \ \ \ \ \ \_cdata-\/>node\_ref();}
\DoxyCodeLine{04151\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ DO\_PIPELINING}}
\DoxyCodeLine{04152\ \ \ \ \ \ \ \}}
\DoxyCodeLine{04153\ \ \ \ \ \}}
\DoxyCodeLine{04154\ \ \ \}}
\DoxyCodeLine{04155\ }
\DoxyCodeLine{04156\ \ \ nassertv(\_cdata-\/>\_last\_update\ ==\ \_cdata-\/>\_next\_update);}
\DoxyCodeLine{04157\ \ \ nassertv(!update\_bounds\ ||\ \_cdata-\/>\_last\_bounds\_update\ ==\ \_cdata-\/>\_next\_update);}
\DoxyCodeLine{04158\ \}}

\end{DoxyCode}
