\doxysection{rigid\+Body\+Combiner.\+cxx}
\hypertarget{rigidBodyCombiner_8cxx_source}{}\label{rigidBodyCombiner_8cxx_source}\index{panda/src/grutil/rigidBodyCombiner.cxx@{panda/src/grutil/rigidBodyCombiner.cxx}}
\mbox{\hyperlink{rigidBodyCombiner_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{rigidBodyCombiner_8h}{rigidBodyCombiner.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nodePath_8h}{nodePath.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{modelNode_8h}{modelNode.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexData_8h}{geomVertexData.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexFormat_8h}{geomVertexFormat.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexArrayFormat_8h}{geomVertexArrayFormat.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexAnimationSpec_8h}{geomVertexAnimationSpec.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sceneGraphReducer_8h}{sceneGraphReducer.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{omniBoundingVolume_8h}{omniBoundingVolume.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullTraverserData_8h}{cullTraverserData.h}}"{}}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ RigidBodyCombiner::\_type\_handle;}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00032\ RigidBodyCombiner::}
\DoxyCodeLine{00033\ RigidBodyCombiner(\textcolor{keyword}{const}\ std::string\ \&name)\ :\ \mbox{\hyperlink{classPandaNode}{PandaNode}}(name)\ \{}
\DoxyCodeLine{00034\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \_internal\_root\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPandaNode}{PandaNode}}(name);}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ perform\ any\ additional\ culling\ once\ we\ get\ within\ the}}
\DoxyCodeLine{00039\ \ \ \textcolor{comment}{//\ RigidBodyCombiner.\ \ The\ internal\ Geom's\ bounding\ volume\ is\ not\ updated}}
\DoxyCodeLine{00040\ \ \ \textcolor{comment}{//\ and\ might\ not\ be\ accurate.\ \ However,\ the\ bounding\ volume\ of\ the}}
\DoxyCodeLine{00041\ \ \ \textcolor{comment}{//\ RigidBodyCombiner\ itself\ should\ be\ accurate,\ and\ this\ is\ sufficient.}}
\DoxyCodeLine{00042\ \ \ \_internal\_root-\/>set\_bounds(\textcolor{keyword}{new}\ \mbox{\hyperlink{classOmniBoundingVolume}{OmniBoundingVolume}});}
\DoxyCodeLine{00043\ \ \ \_internal\_root-\/>set\_final(\textcolor{keyword}{true});}
\DoxyCodeLine{00044\ \}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00049\ RigidBodyCombiner::}
\DoxyCodeLine{00050\ RigidBodyCombiner(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRigidBodyCombiner}{RigidBodyCombiner}}\ \&copy)\ :\ \mbox{\hyperlink{classPandaNode}{PandaNode}}(copy)\ \{}
\DoxyCodeLine{00051\ \ \ set\_cull\_callback();}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \_internal\_root\ =\ copy.\_internal\_root;}
\DoxyCodeLine{00054\ \ \ \_internal\_transforms\ =\ copy.\_internal\_transforms;}
\DoxyCodeLine{00055\ \}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00062\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classRigidBodyCombiner_a23a9c5fc7667c261f1d9a543eef8c560}{RigidBodyCombiner::}}}
\DoxyCodeLine{00063\ \mbox{\hyperlink{classRigidBodyCombiner_a23a9c5fc7667c261f1d9a543eef8c560}{make\_copy}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classRigidBodyCombiner}{RigidBodyCombiner}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00065\ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00084\ \textcolor{keywordtype}{void}\ RigidBodyCombiner::}
\DoxyCodeLine{00085\ collect()\ \{}
\DoxyCodeLine{00086\ \ \ \_internal\_root\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(get\_name());}
\DoxyCodeLine{00087\ \ \ \_internal\_transforms.clear();}
\DoxyCodeLine{00088\ \ \ \_vd\_table.clear();}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ Children\ cr\ =\ get\_children();}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ cr.get\_num\_children();}
\DoxyCodeLine{00092\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00093\ \ \ \ \ r\_collect(cr.get\_child(i),\ RenderState::make\_empty(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00094\ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \_vd\_table.clear();}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \mbox{\hyperlink{classSceneGraphReducer}{SceneGraphReducer}}\ gr;}
\DoxyCodeLine{00099\ \ \ gr.apply\_attribs(\_internal\_root);}
\DoxyCodeLine{00100\ \ \ gr.collect\_vertex\_data(\_internal\_root,\ \string~(SceneGraphReducer::CVD\_format\ |\ SceneGraphReducer::CVD\_name\ |\ SceneGraphReducer::CVD\_animation\_type));}
\DoxyCodeLine{00101\ \ \ gr.unify(\_internal\_root,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00102\ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00112\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \mbox{\hyperlink{classRigidBodyCombiner_a33894565b6a44ea739091332983c9914}{RigidBodyCombiner::}}}
\DoxyCodeLine{00113\ \mbox{\hyperlink{classRigidBodyCombiner_a33894565b6a44ea739091332983c9914}{get\_internal\_scene}}()\ \{}
\DoxyCodeLine{00114\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classNodePath}{NodePath}}(\_internal\_root);}
\DoxyCodeLine{00115\ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00135\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classRigidBodyCombiner_aa8b2171c67b6ba2d96d7f33f90a0e9f4}{RigidBodyCombiner::}}}
\DoxyCodeLine{00136\ \mbox{\hyperlink{classRigidBodyCombiner_aa8b2171c67b6ba2d96d7f33f90a0e9f4}{cull\_callback}}(\mbox{\hyperlink{classCullTraverser}{CullTraverser}}\ *trav,\ \mbox{\hyperlink{classCullTraverserData}{CullTraverserData}}\ \&data)\ \{}
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//\ Pretend\ that\ all\ of\ our\ transforms\ have\ been\ modified\ (since\ we\ don't}}
\DoxyCodeLine{00138\ \ \ \textcolor{comment}{//\ really\ know\ which\ ones\ have).}}
\DoxyCodeLine{00139\ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *current\_thread\ =\ Thread::get\_current\_thread();}
\DoxyCodeLine{00140\ \ \ Transforms::iterator\ ti;}
\DoxyCodeLine{00141\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_internal\_transforms.begin();}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ ti\ !=\ \_internal\_transforms.end();}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ ++ti)\ \{}
\DoxyCodeLine{00144\ \ \ \ \ (*ti)-\/>mark\_modified(current\_thread);}
\DoxyCodeLine{00145\ \ \ \}}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \textcolor{comment}{//\ Render\ the\ internal\ scene\ only-\/-\/this\ is\ the\ optimized\ scene.}}
\DoxyCodeLine{00148\ \ \ trav-\/>traverse\_down(data,\ \_internal\_root);}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ \ \ \textcolor{comment}{//\ Do\ not\ directly\ render\ the\ nodes\ beneath\ this\ node.}}
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00152\ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00159\ \textcolor{keywordtype}{void}\ RigidBodyCombiner::}
\DoxyCodeLine{00160\ r\_collect(\mbox{\hyperlink{classPandaNode}{PandaNode}}\ *node,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state,}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classVertexTransform}{VertexTransform}}\ *transform)\ \{}
\DoxyCodeLine{00162\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ next\_state\ =\ state-\/>compose(node-\/>get\_state());}
\DoxyCodeLine{00163\ \ \ CPT(\mbox{\hyperlink{classVertexTransform}{VertexTransform}})\ next\_transform\ =\ transform;}
\DoxyCodeLine{00164\ \ \ \textcolor{keywordflow}{if}\ (!node-\/>get\_transform()-\/>is\_identity()\ ||}
\DoxyCodeLine{00165\ \ \ \ \ \ \ (node-\/>is\_of\_type(ModelNode::get\_class\_type())\ \&\&}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ DCAST(\mbox{\hyperlink{classModelNode}{ModelNode}},\ node)-\/>get\_preserve\_transform()\ !=\ ModelNode::PT\_none))\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ This\ node\ has\ a\ transform\ we\ need\ to\ keep.}}
\DoxyCodeLine{00168\ \ \ \ \ PT(\mbox{\hyperlink{classNodeVertexTransform}{NodeVertexTransform}})\ new\_transform\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classNodeVertexTransform}{NodeVertexTransform}}(node,\ transform);}
\DoxyCodeLine{00169\ \ \ \ \ \_internal\_transforms.push\_back(new\_transform);}
\DoxyCodeLine{00170\ \ \ \ \ next\_transform\ =\ new\_transform.p();}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{if}\ (node-\/>\mbox{\hyperlink{classPandaNode_a1799fcdc4d1d62fbbbb63d4dedc1bdcf}{is\_geom\_node}}())\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *gnode\ =\ DCAST(\mbox{\hyperlink{classGeomNode}{GeomNode}},\ node);}
\DoxyCodeLine{00176\ \ \ \ \ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *root\_gnode\ =\ DCAST(\mbox{\hyperlink{classGeomNode}{GeomNode}},\ \_internal\_root);}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_geoms\ =\ gnode-\/>get\_num\_geoms();}
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_geoms;\ ++i)\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ gnode-\/>get\_geom(i)-\/>\mbox{\hyperlink{classGeomNode_a280099fb91e248c826a6bf4eff6975b6}{make\_copy}}();}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (next\_transform\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ geom-\/>set\_vertex\_data(convert\_vd(next\_transform,\ geom-\/>get\_vertex\_data()));}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00184\ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ gstate\ =\ next\_state-\/>compose(gnode-\/>get\_geom\_state(i));}
\DoxyCodeLine{00185\ \ \ \ \ \ \ root\_gnode-\/>\mbox{\hyperlink{classGeomNode_a18e924a32fc78e567f156bd3678a7057}{add\_geom}}(geom,\ gstate);}
\DoxyCodeLine{00186\ \ \ \ \ \}}
\DoxyCodeLine{00187\ \ \ \}}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ Children\ cr\ =\ node-\/>get\_children();}
\DoxyCodeLine{00190\ \ \ \textcolor{keywordtype}{int}\ num\_children\ =\ cr.get\_num\_children();}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_children;\ i++)\ \{}
\DoxyCodeLine{00192\ \ \ \ \ r\_collect(cr.get\_child(i),\ next\_state,\ next\_transform);}
\DoxyCodeLine{00193\ \ \ \}}
\DoxyCodeLine{00194\ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00200\ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ RigidBodyCombiner::}
\DoxyCodeLine{00201\ convert\_vd(\textcolor{keyword}{const}\ \mbox{\hyperlink{classVertexTransform}{VertexTransform}}\ *transform,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}\ *orig)\ \{}
\DoxyCodeLine{00202\ \ \ \textcolor{comment}{//\ First,\ unify\ this\ operation\ for\ unique\ transformdata\ combinations.\ \ If\ we}}
\DoxyCodeLine{00203\ \ \ \textcolor{comment}{//\ encounter\ a\ given\ GeomVertexData\ more\ than\ once\ under\ the\ same\ transform,}}
\DoxyCodeLine{00204\ \ \ \textcolor{comment}{//\ we\ should\ return\ exactly\ the\ same\ GeomVertexData.}}
\DoxyCodeLine{00205\ \ \ VDTable::iterator\ vdti\ =\ \_vd\_table.find(VDUnifier(transform,\ orig));}
\DoxyCodeLine{00206\ \ \ \textcolor{keywordflow}{if}\ (vdti\ !=\ \_vd\_table.end())\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{keywordflow}{return}\ (*vdti).second;}
\DoxyCodeLine{00208\ \ \ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ PT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ format\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}}(*orig-\/>get\_format());}
\DoxyCodeLine{00211\ \ \ \textcolor{keywordflow}{if}\ (!orig-\/>get\_format()-\/>has\_column(InternalName::get\_transform\_blend()))\ \{}
\DoxyCodeLine{00212\ \ \ \ \ PT(\mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}})\ af\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexArrayFormat}{GeomVertexArrayFormat}}();}
\DoxyCodeLine{00213\ \ \ \ \ af-\/>add\_column(InternalName::get\_transform\_blend(),\ 1,}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Geom::NT\_uint16,\ Geom::C\_index,\ 0,\ 2);}
\DoxyCodeLine{00215\ \ \ \ \ format-\/>add\_array(af);}
\DoxyCodeLine{00216\ \ \ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \mbox{\hyperlink{classGeomVertexAnimationSpec}{GeomVertexAnimationSpec}}\ spec;}
\DoxyCodeLine{00219\ \ \ spec.set\_panda();}
\DoxyCodeLine{00220\ \ \ format-\/>set\_animation(spec);}
\DoxyCodeLine{00221\ \ \ format-\/>maybe\_align\_columns\_for\_animation();}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00223\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ new\_format\ =\ GeomVertexFormat::register\_format(format);}
\DoxyCodeLine{00224\ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ converted\ =\ orig-\/>convert\_to(new\_format);}
\DoxyCodeLine{00225\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ new\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}(*converted);}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \textcolor{keywordflow}{if}\ (new\_data-\/>get\_transform\_blend\_table()\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ new\ table\ that\ has\ just\ the\ one\ blend:\ all\ vertices\ hard-\/}}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{comment}{//\ assigned\ to\ the\ indicated\ transform.}}
\DoxyCodeLine{00230\ \ \ \ \ PT(\mbox{\hyperlink{classTransformBlendTable}{TransformBlendTable}})\ new\_table\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTransformBlendTable}{TransformBlendTable}};}
\DoxyCodeLine{00231\ \ \ \ \ new\_table-\/>\mbox{\hyperlink{classTransformBlendTable_a927699235114e072f0b0c388cc9dcc80}{add\_blend}}(\mbox{\hyperlink{classTransformBlend}{TransformBlend}}(transform,\ 1.0f));}
\DoxyCodeLine{00232\ \ \ \ \ new\_table-\/>set\_rows(SparseArray::range(0,\ new\_data-\/>get\_num\_rows()));}
\DoxyCodeLine{00233\ \ \ \ \ new\_data-\/>set\_transform\_blend\_table(new\_table);}
\DoxyCodeLine{00234\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{comment}{//\ The\ GeomVertexData\ already\ has\ a\ TransformBlendTable.\ \ In\ this\ case,}}
\DoxyCodeLine{00236\ \ \ \ \ \textcolor{comment}{//\ we'll\ have\ to\ adjust\ it.\ \ TODO.}}
\DoxyCodeLine{00237\ \ \ \}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \textcolor{comment}{//\ Store\ the\ result\ for\ the\ next\ time.}}
\DoxyCodeLine{00240\ \ \ \_vd\_table[VDUnifier(transform,\ orig)]\ =\ new\_data;}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \textcolor{keywordflow}{return}\ new\_data;}
\DoxyCodeLine{00243\ \}}

\end{DoxyCode}
