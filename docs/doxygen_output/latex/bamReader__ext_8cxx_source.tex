\doxysection{bam\+Reader\+\_\+ext.\+cxx}
\hypertarget{bamReader__ext_8cxx_source}{}\label{bamReader__ext_8cxx_source}\index{panda/src/putil/bamReader\_ext.cxx@{panda/src/putil/bamReader\_ext.cxx}}
\mbox{\hyperlink{bamReader__ext_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader__ext_8h}{bamReader\_ext.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__putil_8h}{config\_putil.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pythonThread_8h}{pythonThread.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#ifdef\ HAVE\_PYTHON}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifndef\ CPPPARSER}}
\DoxyCodeLine{00021\ \textcolor{keyword}{extern}\ Dtool\_PyTypedObject\ Dtool\_BamReader;}
\DoxyCodeLine{00022\ \textcolor{keyword}{extern}\ Dtool\_PyTypedObject\ Dtool\_DatagramIterator;}
\DoxyCodeLine{00023\ \textcolor{keyword}{extern}\ Dtool\_PyTypedObject\ Dtool\_TypedWritable;}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ CPPPARSER}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{static}\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *factory\_callback(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\{}
\DoxyCodeLine{00030\ \ \ PyObject\ *func\ =\ (PyObject\ *)params.get\_user\_data();}
\DoxyCodeLine{00031\ \ \ nassertr(func\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00034\ \ \ \textcolor{comment}{//\ Use\ PyGILState\ to\ protect\ this\ asynchronous\ call.}}
\DoxyCodeLine{00035\ \ \ PyGILState\_STATE\ gstate;}
\DoxyCodeLine{00036\ \ \ gstate\ =\ PyGILState\_Ensure();}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \ \ \textcolor{comment}{//\ Extract\ the\ parameters\ we\ will\ pass\ to\ the\ Python\ function.}}
\DoxyCodeLine{00040\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00041\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00042\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ PyObject\ *py\_scan\ =\ DTool\_CreatePyInstance(\&scan,\ Dtool\_DatagramIterator,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00045\ \ \ PyObject\ *py\_manager\ =\ DTool\_CreatePyInstance(manager,\ Dtool\_BamReader,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00046\ \ \ PyObject\ *args\ =\ PyTuple\_Pack(2,\ py\_scan,\ py\_manager);}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \textcolor{comment}{//\ Now\ call\ the\ Python\ function.}}
\DoxyCodeLine{00049\ \ \ PyObject\ *result\ =\ PythonThread::call\_python\_func(func,\ args);}
\DoxyCodeLine{00050\ \ \ Py\_DECREF(args);}
\DoxyCodeLine{00051\ \ \ Py\_DECREF(py\_scan);}
\DoxyCodeLine{00052\ \ \ Py\_DECREF(py\_manager);}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00055\ \ \ \ \ util\_cat.error()}
\DoxyCodeLine{00056\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Exception\ occurred\ in\ Python\ factory\ function:\(\backslash\)n"{}};}
\DoxyCodeLine{00057\ \ \ \ \ PyErr\_Print();}
\DoxyCodeLine{00058\ \ \ \}}
\DoxyCodeLine{00059\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (result\ ==\ Py\_None)\ \{}
\DoxyCodeLine{00060\ \ \ \ \ util\_cat.error()}
\DoxyCodeLine{00061\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Python\ factory\ function\ returned\ None\(\backslash\)n"{}};}
\DoxyCodeLine{00062\ \ \ \ \ Py\_DECREF(result);}
\DoxyCodeLine{00063\ \ \ \ \ result\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00064\ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \textcolor{keywordtype}{void}\ *\textcolor{keywordtype}{object}\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{//\ Unwrap\ the\ returned\ TypedWritable\ object.}}
\DoxyCodeLine{00069\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00070\ \ \ \ \ Dtool\_Call\_ExtractThisPointer(result,\ Dtool\_TypedWritable,\ \&\textcolor{keywordtype}{object});}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ \ \ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *ptr\ =\ (\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *)\textcolor{keywordtype}{object};}
\DoxyCodeLine{00073\ \ \ \ \ \mbox{\hyperlink{classReferenceCount}{ReferenceCount}}\ *ref\_count\ =\ ptr-\/>\mbox{\hyperlink{classTypedWritable_a513f54c9a8a11960785d199393ef9e5a}{as\_reference\_count}}();}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordflow}{if}\ (ref\_count\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ Python\ pointer\ is\ the\ last\ reference\ to\ it,\ make\ sure\ that\ the}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{comment}{//\ object\ isn't\ destroyed.\ \ We\ do\ this\ by\ calling\ unref(),\ which}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{comment}{//\ decreases\ the\ reference\ count\ without\ destroying\ the\ object.}}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (Py\_REFCNT(result)\ <=\ 1)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ ref\_count-\/>unref();}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Tell\ the\ Python\ wrapper\ object\ that\ it\ shouldn't\ try\ to\ delete\ the}}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ object\ when\ it\ is\ destroyed.}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ ((Dtool\_PyInstDef\ *)result)-\/>\_memory\_rules\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ Py\_DECREF(result);}
\DoxyCodeLine{00086\ \ \ \ \ \}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (DtoolInstance\_TYPE(result)\ ==\ \&Dtool\_TypedWritable\ \&\&}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ !Py\_IS\_TYPE(result,\ Dtool\_GetPyTypeObject(\&Dtool\_TypedWritable)))\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \textcolor{comment}{//\ It\ is\ a\ custom\ subclass\ of\ TypedWritable,\ so\ we\ have\ to\ keep\ it}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \textcolor{comment}{//\ alive,\ and\ decrement\ it\ in\ finalize(),\ see\ typedWritable\_ext.cxx.}}
\DoxyCodeLine{00091\ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_a0c2e8dc5a794a4263139116b5b8dcb2d}{register\_finalize}}(ptr);}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{comment}{//\ Otherwise,\ we\ just\ decrement\ the\ Python\ reference\ count,\ but\ making}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \textcolor{comment}{//\ sure\ that\ the\ C++\ object\ is\ not\ getting\ deleted\ (yet)\ by\ this.}}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ mem\_rules\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00097\ \ \ \ \ \ \ std::swap(mem\_rules,\ ((Dtool\_PyInstDef\ *)result)-\/>\_memory\_rules);}
\DoxyCodeLine{00098\ \ \ \ \ \ \ Py\_DECREF(result);}
\DoxyCodeLine{00099\ \ \ \ \ \ \ std::swap(mem\_rules,\ ((Dtool\_PyInstDef\ *)result)-\/>\_memory\_rules);}
\DoxyCodeLine{00100\ \ \ \ \ \}}
\DoxyCodeLine{00101\ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00104\ \ \ PyGILState\_Release(gstate);}
\DoxyCodeLine{00105\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *)object;}
\DoxyCodeLine{00108\ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00113\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<BamReader>::}}}
\DoxyCodeLine{00114\ \mbox{\hyperlink{classExtension}{read\_object}}()\ \{}
\DoxyCodeLine{00115\ \ \ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *ptr;}
\DoxyCodeLine{00116\ \ \ \mbox{\hyperlink{classReferenceCount}{ReferenceCount}}\ *ref\_ptr;}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00119\ \ \ PyThreadState\ *\_save;}
\DoxyCodeLine{00120\ \ \ Py\_UNBLOCK\_THREADS}
\DoxyCodeLine{00121\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordtype}{bool}\ success\ =\ \_this-\/>read\_object(ptr,\ ref\_ptr);}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ !defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{00126\ \ \ Py\_BLOCK\_THREADS}
\DoxyCodeLine{00127\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ \textcolor{keywordflow}{if}\ (!success)\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_this-\/>is\_eof())\ \{}
\DoxyCodeLine{00131\ \ \ \ \ \ \ PyErr\_SetNone(PyExc\_EOFError);}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00135\ \ \ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \textcolor{keywordflow}{if}\ (ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordflow}{return}\ Py\_NewRef(Py\_None);}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \textcolor{keywordflow}{if}\ (ref\_ptr\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00142\ \ \ \ \ ref\_ptr-\/>ref();}
\DoxyCodeLine{00143\ \ \ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \ \ \textcolor{comment}{//\ Note\ that,\ unlike\ the\ regular\ bindings,\ we\ take\ ownership\ of\ the\ object}}
\DoxyCodeLine{00146\ \ \ \textcolor{comment}{//\ here\ even\ if\ it's\ not\ inheriting\ from\ ReferenceCount.}}
\DoxyCodeLine{00147\ \ \ \textcolor{keywordflow}{return}\ DTool\_CreatePyInstanceTyped((\textcolor{keywordtype}{void}\ *)ptr,\ Dtool\_TypedWritable,}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{true},\ \textcolor{keyword}{false},\ ptr-\/>get\_type\_index());}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00154\ PyObject\ *\mbox{\hyperlink{classExtension}{Extension<BamReader>::}}}
\DoxyCodeLine{00155\ \mbox{\hyperlink{classExtension}{get\_file\_version}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00156\ \ \ \textcolor{keywordflow}{return}\ Py\_BuildValue(\textcolor{stringliteral}{"{}(ii)"{}},\ \_this-\/>get\_file\_major\_ver(),}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_this-\/>get\_file\_minor\_ver());}
\DoxyCodeLine{00158\ \}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00165\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classExtension}{Extension<BamReader>::}}}
\DoxyCodeLine{00166\ \mbox{\hyperlink{classExtension}{register\_factory}}(\mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ handle,\ PyObject\ *func)\ \{}
\DoxyCodeLine{00167\ \ \ \textcolor{keywordflow}{if}\ (!PyCallable\_Check(func))\ \{}
\DoxyCodeLine{00168\ \ \ \ \ Dtool\_Raise\_TypeError(\textcolor{stringliteral}{"{}second\ argument\ to\ register\_factory\ must\ be\ callable"{}});}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \textcolor{keywordtype}{void}\ *user\_data\ =\ (\textcolor{keywordtype}{void}\ *)Py\_NewRef(func);}
\DoxyCodeLine{00173\ \ \ BamReader::get\_factory()-\/>register\_factory(handle,\ \&factory\_callback,\ user\_data);}
\DoxyCodeLine{00174\ \}}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00176\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
