\doxysection{collision\+Handler\+Gravity.\+cxx}
\hypertarget{collisionHandlerGravity_8cxx_source}{}\label{collisionHandlerGravity_8cxx_source}\index{panda/src/collide/collisionHandlerGravity.cxx@{panda/src/collide/collisionHandlerGravity.cxx}}
\mbox{\hyperlink{collisionHandlerGravity_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionHandlerGravity_8h}{collisionHandlerGravity.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionNode_8h}{collisionNode.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionEntry_8h}{collisionEntry.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__collide_8h}{config\_collide.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionPlane_8h}{collisionPlane.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{clockObject_8h}{clockObject.h}}"{}}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{using\ }std::cout;}
\DoxyCodeLine{00022\ \textcolor{keyword}{using\ }std::endl;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CollisionHandlerGravity::\_type\_handle;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ CollisionHandlerGravity::}
\DoxyCodeLine{00030\ CollisionHandlerGravity()\ \{}
\DoxyCodeLine{00031\ \ \ \_offset\ =\ 0.0f;}
\DoxyCodeLine{00032\ \ \ \_reach\ =\ 1.0f;}
\DoxyCodeLine{00033\ \ \ \_airborne\_height\ =\ 0.0f;}
\DoxyCodeLine{00034\ \ \ \_impact\_velocity\ =\ 0.0f;}
\DoxyCodeLine{00035\ \ \ \_gravity\ =\ 32.174;}
\DoxyCodeLine{00036\ \ \ \_current\_velocity\ =\ 0.0f;}
\DoxyCodeLine{00037\ \ \ \_max\_velocity\ =\ 400.0f;}
\DoxyCodeLine{00038\ \ \ \_contact\_normal\ =\ LVector3::zero();}
\DoxyCodeLine{00039\ \ \ \_legacy\_mode\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00045\ CollisionHandlerGravity::}
\DoxyCodeLine{00046\ \string~CollisionHandlerGravity()\ \{}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00052\ \textcolor{keywordtype}{void}\ CollisionHandlerGravity::}
\DoxyCodeLine{00053\ write\_datagram(\mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00054\ \ \ \mbox{\hyperlink{classCollisionHandlerEvent_addddd8ca79f6bde9a96778549a422be4}{CollisionHandlerPhysical::write\_datagram}}(dg);}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ dg.add\_float64(\_offset);}
\DoxyCodeLine{00057\ \ \ dg.add\_float64(\_reach);}
\DoxyCodeLine{00058\ \ \ dg.add\_float64(\_max\_velocity);}
\DoxyCodeLine{00059\ \ \ dg.add\_float64(\_gravity);}
\DoxyCodeLine{00060\ \ \ dg.add\_bool(\_legacy\_mode);}
\DoxyCodeLine{00061\ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00067\ \textcolor{keywordtype}{void}\ CollisionHandlerGravity::}
\DoxyCodeLine{00068\ read\_datagram(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan)\ \{}
\DoxyCodeLine{00069\ \ \ \mbox{\hyperlink{classCollisionHandlerEvent_ac1753e110e2ca02f71b5b9142b902cfb}{CollisionHandlerPhysical::read\_datagram}}(scan);}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \_offset\ =\ scan.get\_float64();}
\DoxyCodeLine{00072\ \ \ \_reach\ =\ scan.get\_float64();}
\DoxyCodeLine{00073\ \ \ \_max\_velocity\ =\ scan.get\_float64();}
\DoxyCodeLine{00074\ \ \ \_gravity\ =\ scan.get\_float64();}
\DoxyCodeLine{00075\ \ \ \_legacy\_mode\ =\ scan.get\_bool();}
\DoxyCodeLine{00076\ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#define\ OLD\_COLLISION\_HANDLER\_GRAVITY\ 0}}
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#if\ OLD\_COLLISION\_HANDLER\_GRAVITY}}
\DoxyCodeLine{00083\ PN\_stdfloat\ CollisionHandlerGravity::}
\DoxyCodeLine{00084\ set\_highest\_collision(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&target\_node\_path,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&from\_node\_path,\ \textcolor{keyword}{const}\ Entries\ \&entries)\ \{}
\DoxyCodeLine{00085\ \ \ \textcolor{comment}{//\ Get\ the\ maximum\ height\ for\ all\ collisions\ with\ this\ node.}}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordtype}{bool}\ got\_max\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00087\ \ \ PN\_stdfloat\ max\_height\ =\ 0.0f;}
\DoxyCodeLine{00088\ \ \ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *highest\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ Entries::const\_iterator\ ei;}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordflow}{for}\ (ei\ =\ entries.begin();\ ei\ !=\ entries.end();\ ++ei)\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *entry\ =\ (*ei);}
\DoxyCodeLine{00093\ \ \ \ \ nassertr(entry\ !=\ \textcolor{keyword}{nullptr},\ 0.0f);}
\DoxyCodeLine{00094\ \ \ \ \ nassertr(from\_node\_path\ ==\ entry-\/>get\_from\_node\_path(),\ 0.0f);}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{if}\ (entry-\/>has\_surface\_point())\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ LPoint3\ point\ =\ entry-\/>\mbox{\hyperlink{classCollisionEntry_a626b8c6dee24ccc67099e1a62e5c55f1}{get\_surface\_point}}(target\_node\_path);}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Intersection\ point\ detected\ at\ "{}}\ <<\ point\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \ \ \ \ PN\_stdfloat\ height\ =\ point[2];}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_max\ ||\ height\ >\ max\_height)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ got\_max\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ max\_height\ =\ height;}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ highest\ =\ entry;}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00109\ \ \ \ \ \}}
\DoxyCodeLine{00110\ \ \ \}}
\DoxyCodeLine{00111\ \ \ \textcolor{comment}{//\ \#*\#\_has\_contact\ =\ got\_max;}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\ \ \#if\ 0}}
\DoxyCodeLine{00114\ \ \ \ \ cout<<\textcolor{stringliteral}{"{}\(\backslash\)ncolliding\ with:\(\backslash\)n"{}};}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordflow}{for}\ (Colliding::const\_iterator\ i\ =\ \_current\_colliding.begin();\ i\ !=\ \_current\_colliding.end();\ ++i)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ (**i).write(cout,\ 2);}
\DoxyCodeLine{00117\ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ cout<<\textcolor{stringliteral}{"{}\(\backslash\)nhighest:\(\backslash\)n"{}};}
\DoxyCodeLine{00119\ \ \ \ \ highest-\/>write(cout,\ 2);}
\DoxyCodeLine{00120\ \ \ \ \ cout<<endl;}
\DoxyCodeLine{00121\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordflow}{if}\ (\_legacy\_mode)\ \{}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ We\ only\ collide\ with\ things\ we\ are\ impacting\ with.\ \ Remove\ the}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{//\ collisions:}}
\DoxyCodeLine{00126\ \ \ \ \ \_current\_colliding.clear();}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{comment}{//\ Add\ only\ the\ one\ that\ we're\ impacting\ with:}}
\DoxyCodeLine{00128\ \ \ \ \ \mbox{\hyperlink{classCollisionHandlerPhysical_a80296816bc47d6719ea327582edab2c3}{add\_entry}}(highest);}
\DoxyCodeLine{00129\ \ \ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{return}\ max\_height;}
\DoxyCodeLine{00132\ \}}
\DoxyCodeLine{00133\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00134\ PN\_stdfloat\ CollisionHandlerGravity::}
\DoxyCodeLine{00135\ set\_highest\_collision(\textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&target\_node\_path,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&from\_node\_path,\ \textcolor{keyword}{const}\ Entries\ \&entries)\ \{}
\DoxyCodeLine{00136\ \ \ \textcolor{comment}{//\ Get\ the\ maximum\ height\ for\ all\ collisions\ with\ this\ node.\ \ This\ is\ really}}
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//\ the\ distance\ to-\/the-\/ground,\ so\ it\ will\ be\ negative\ when\ the\ avatar\ is}}
\DoxyCodeLine{00138\ \ \ \textcolor{comment}{//\ above\ the\ ground.\ \ Larger\ values\ (less\ negative)\ are\ higher\ elevation}}
\DoxyCodeLine{00139\ \ \ \textcolor{comment}{//\ (assuming\ the\ avatar\ is\ right-\/side-\/up\ (or\ the\ ray\ is\ plumb)).}}
\DoxyCodeLine{00140\ \ \ \textcolor{keywordtype}{bool}\ got\_max\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00141\ \ \ \textcolor{keywordtype}{bool}\ got\_min\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00142\ \ \ PN\_stdfloat\ max\_height\ =\ 0.0f;}
\DoxyCodeLine{00143\ \ \ PN\_stdfloat\ min\_height\ =\ 0.0f;}
\DoxyCodeLine{00144\ \ \ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *highest\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00145\ \ \ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *lowest\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})>\ valid\_entries;}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ Entries::const\_iterator\ ei;}
\DoxyCodeLine{00150\ \ \ \textcolor{keywordflow}{for}\ (ei\ =\ entries.begin();\ ei\ !=\ entries.end();\ ++ei)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *entry\ =\ (*ei);}
\DoxyCodeLine{00152\ \ \ \ \ nassertr(entry\ !=\ \textcolor{keyword}{nullptr},\ 0.0f);}
\DoxyCodeLine{00153\ \ \ \ \ nassertr(from\_node\_path\ ==\ entry-\/>get\_from\_node\_path(),\ 0.0f);}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordflow}{if}\ (entry-\/>has\_surface\_point())\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ LPoint3\ point\ =\ entry-\/>\mbox{\hyperlink{classCollisionEntry_a626b8c6dee24ccc67099e1a62e5c55f1}{get\_surface\_point}}(target\_node\_path);}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Intersection\ point\ detected\ at\ "{}}\ <<\ point\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ PN\_stdfloat\ height\ =\ point[2];}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \textcolor{keywordflow}{if}(height\ <\ \_offset\ +\ \_reach)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ valid\_entries.push\_back(entry);}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_max\ ||\ height\ >\ max\_height)\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ got\_max\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ max\_height\ =\ height;}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ highest\ =\ entry;}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!got\_min\ ||\ height\ <\ min\_height)\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ got\_min\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ min\_height\ =\ height;}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ lowest\ =\ entry;}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00175\ \ \ \ \ \}}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordflow}{if}\ (!got\_max\ \&\&\ got\_min)\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{comment}{//\ We've\ fallen\ through\ the\ world,\ but\ we're\ also\ under\ some\ walkable}}
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{comment}{//\ geometry.\ \ Move\ us\ up\ to\ the\ lowest\ surface:}}
\DoxyCodeLine{00180\ \ \ \ \ got\_max\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00181\ \ \ \ \ max\_height\ =\ min\_height;}
\DoxyCodeLine{00182\ \ \ \ \ highest\ =\ lowest;}
\DoxyCodeLine{00183\ \ \ \ \ valid\_entries.push\_back(lowest);}
\DoxyCodeLine{00184\ \ \ \}}
\DoxyCodeLine{00185\ \ \ \textcolor{comment}{//\ \#*\#\_has\_contact\ =\ got\_max;}}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \textcolor{preprocessor}{\ \ \#if\ 0}}
\DoxyCodeLine{00188\ \ \ \ \ cout<<\textcolor{stringliteral}{"{}\(\backslash\)ncolliding\ with:\(\backslash\)n"{}};}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordflow}{for}\ (Colliding::const\_iterator\ i\ =\ \_current\_colliding.begin();\ i\ !=\ \_current\_colliding.end();\ ++i)\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ (**i).write(cout,\ 2);}
\DoxyCodeLine{00191\ \ \ \ \ \}}
\DoxyCodeLine{00192\ \ \ \ \ cout<<\textcolor{stringliteral}{"{}\(\backslash\)nhighest:\(\backslash\)n"{}};}
\DoxyCodeLine{00193\ \ \ \ \ highest-\/>write(cout,\ 2);}
\DoxyCodeLine{00194\ \ \ \ \ cout<<endl;}
\DoxyCodeLine{00195\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ \textcolor{comment}{//\ We\ only\ collide\ with\ things\ we\ are\ impacting\ with.\ \ Remove\ the}}
\DoxyCodeLine{00198\ \ \ \textcolor{comment}{//\ collisions:}}
\DoxyCodeLine{00199\ \ \ \_current\_colliding.clear();}
\DoxyCodeLine{00200\ \ \ \textcolor{keywordflow}{if}\ (\_legacy\_mode)\ \{}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{comment}{//\ Add\ only\ the\ one\ that\ we're\ impacting\ with:}}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{classCollisionHandlerPhysical_a80296816bc47d6719ea327582edab2c3}{add\_entry}}(highest);}
\DoxyCodeLine{00203\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{comment}{//\ Add\ all\ of\ them.}}
\DoxyCodeLine{00205\ \ \ \ \ \mbox{\hyperlink{classpvector}{pvector}}<PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})>::iterator\ vi;}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{keywordflow}{for}\ (vi\ =\ valid\_entries.begin();\ vi\ !=\ valid\_entries.end();\ ++vi)\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \mbox{\hyperlink{classCollisionHandlerPhysical_a80296816bc47d6719ea327582edab2c3}{add\_entry}}(*vi);}
\DoxyCodeLine{00208\ \ \ \ \ \}}
\DoxyCodeLine{00209\ \ \ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \ \ \textcolor{comment}{//\ Set\ the\ contact\ normal\ so\ that\ other\ code\ can\ make\ use\ of\ the\ surface}}
\DoxyCodeLine{00213\ \ \ \textcolor{comment}{//\ slope:}}
\DoxyCodeLine{00214\ \ \ \textcolor{keywordflow}{if}\ (highest-\/>get\_into()-\/>is\_of\_type(CollisionPlane::get\_class\_type()))\ \{}
\DoxyCodeLine{00215\ \textcolor{comment}{/*}}
\DoxyCodeLine{00216\ \textcolor{comment}{\ *\ This\ is\ asking:\ what\ is\ the\ normal\ of\ the\ plane\ that\ the\ avatar\ is}}
\DoxyCodeLine{00217\ \textcolor{comment}{\ *\ colliding\ with\ relative\ to\ the\ avatar.\ \ A\ positive\ y\ valye\ means\ the\ avatar}}
\DoxyCodeLine{00218\ \textcolor{comment}{\ *\ is\ facing\ downhill\ and\ a\ negative\ y\ value\ means\ the\ avatar\ is\ facing}}
\DoxyCodeLine{00219\ \textcolor{comment}{\ *\ uphill.\ \ \_contact\_normal\ =\ DCAST(CollisionPlane,}}
\DoxyCodeLine{00220\ \textcolor{comment}{\ *\ highest-\/>get\_into())-\/>get\_normal()\ *}}
\DoxyCodeLine{00221\ \textcolor{comment}{\ *\ from\_node\_path.get\_mat(highest-\/>get\_into\_node\_path());\ \_contact\_normal\ =}}
\DoxyCodeLine{00222\ \textcolor{comment}{\ *\ DCAST(CollisionPlane,\ highest-\/>get\_into())-\/>get\_normal();\ This\ is\ asking:}}
\DoxyCodeLine{00223\ \textcolor{comment}{\ *\ what\ is\ the\ normal\ of\ the\ avatar\ that\ the\ avatar\ is\ colliding\ with\ relative}}
\DoxyCodeLine{00224\ \textcolor{comment}{\ *\ to\ the\ plane.}}
\DoxyCodeLine{00225\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00226\ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ transform\ =\ highest-\/>get\_into\_node\_path().get\_transform(from\_node\_path);}
\DoxyCodeLine{00227\ \ \ \ \ \_contact\_normal\ =\ DCAST(\mbox{\hyperlink{classCollisionPlane}{CollisionPlane}},\ highest-\/>get\_into())-\/>get\_normal()\ *\ transform-\/>get\_mat();}
\DoxyCodeLine{00228\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \_contact\_normal\ =\ highest-\/>\mbox{\hyperlink{classCollisionEntry_a6dbe263b412fccfb03273dcf5f349104}{get\_surface\_normal}}(from\_node\_path);}
\DoxyCodeLine{00230\ \ \ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \textcolor{keywordflow}{return}\ max\_height;}
\DoxyCodeLine{00233\ \}}
\DoxyCodeLine{00234\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00244\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCollisionHandlerGravity_a9109b3d715365280e2d63a9cc65e2b43}{CollisionHandlerGravity::}}}
\DoxyCodeLine{00245\ \mbox{\hyperlink{classCollisionHandlerGravity_a9109b3d715365280e2d63a9cc65e2b43}{handle\_entries}}()\ \{}
\DoxyCodeLine{00246\ \ \ \textcolor{keywordtype}{bool}\ okflag\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \ \ FromEntries::const\_iterator\ fi;}
\DoxyCodeLine{00249\ \ \ \textcolor{keywordflow}{for}\ (fi\ =\ \_from\_entries.begin();\ fi\ !=\ \_from\_entries.end();\ ++fi)\ \{}
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classNodePath}{NodePath}}\ \&from\_node\_path\ =\ (*fi).first;}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classpvector}{Entries}}\ \&entries\ =\ (*fi).second;}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \ \ Colliders::iterator\ ci;}
\DoxyCodeLine{00254\ \ \ \ \ ci\ =\ \_colliders.find(from\_node\_path);}
\DoxyCodeLine{00255\ \ \ \ \ \textcolor{keywordflow}{if}\ (ci\ ==\ \_colliders.end())\ \{}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \textcolor{comment}{//\ Hmm,\ someone\ added\ a\ CollisionNode\ to\ a\ traverser\ and\ gave\ it\ this}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \textcolor{comment}{//\ CollisionHandler\ pointer-\/-\/but\ they\ didn't\ tell\ us\ about\ the\ node.}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ collide\_cat.error()}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ <<\ get\_type()\ <<\ \textcolor{stringliteral}{"{}\ doesn't\ know\ about\ "{}}}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ <<\ from\_node\_path\ <<\ \textcolor{stringliteral}{"{},\ disabling.\(\backslash\)n"{}};}
\DoxyCodeLine{00261\ \ \ \ \ \ \ okflag\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00262\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \mbox{\hyperlink{classCollisionHandlerPhysical_1_1ColliderDef}{ColliderDef}}\ \&def\ =\ (*ci).second;}
\DoxyCodeLine{00264\ \ \ \ \ \ \ PN\_stdfloat\ max\_height\ =\ set\_highest\_collision(def.\_target,\ from\_node\_path,\ entries);}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ set\ our\ height\ accordingly.}}
\DoxyCodeLine{00267\ \textcolor{preprocessor}{\ \ \ \ \ \ \#if\ OLD\_COLLISION\_HANDLER\_GRAVITY}}
\DoxyCodeLine{00268\ \ \ \ \ \ \ PN\_stdfloat\ adjust\ =\ max\_height\ +\ \_offset;}
\DoxyCodeLine{00269\ \textcolor{preprocessor}{\ \ \ \ \ \ \#else}}
\DoxyCodeLine{00270\ \ \ \ \ \ \ PN\_stdfloat\ adjust\ =\ max\_height\ +\ \_offset;}
\DoxyCodeLine{00271\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_current\_velocity\ >\ 0.0f\ ||\ !IS\_THRESHOLD\_ZERO(adjust,\ 0.001))\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Adjusting\ height\ by\ "{}}\ <<\ adjust\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_current\_velocity\ >\ 0.0f\ ||\ adjust)\ \{}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...we\ have\ a\ vertical\ thrust,\ ...or\ the\ node\ is\ above\ the\ floor,}}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ so\ it\ is\ airborne.}}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ dt\ =\ ClockObject::get\_global\_clock()-\/>get\_dt();}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Fyi,\ the\ sign\ of\ \_gravity\ is\ reversed.\ \ I\ think\ it\ makes\ the}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ get\_*()\ set\_*()\ more\ intuitive\ to\ do\ it\ this\ way.}}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ gravity\_adjust\ =\ \_current\_velocity\ *\ dt\ +\ 0.5\ *\ -\/\_gravity\ *\ dt\ *\ dt;}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (adjust\ >\ 0.0f)\ \{}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...the\ node\ is\ under\ the\ floor,\ so\ it\ has\ landed.\ \ Keep\ the}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ adjust\ to\ bring\ us\ up\ to\ the\ ground\ and\ then\ add\ the}}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gravity\_adjust\ to\ get\ us\ airborne:}}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \ \ \ \ adjust\ +=\ std::max((PN\_stdfloat)0.0,\ gravity\_adjust);}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...the\ node\ is\ above\ the\ floor,\ so\ it\ is\ airborne.}}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \ \ adjust\ =\ std::max(adjust,\ gravity\_adjust);}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \_current\_velocity\ -\/=\ \_gravity\ *\ dt;}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Record\ the\ airborne\ height\ in\ case\ someone\ else\ needs\ it:}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \_airborne\_height\ =\ -\/(max\_height\ +\ \_offset)\ +\ adjust;}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ assert(\_airborne\_height\ >=\ -\/0.001f);}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_airborne\_height\ <\ 0.001f\ \&\&\ \_current\_velocity\ <\ 0.001f)\ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...the\ node\ is\ under\ the\ floor,\ so\ it\ has\ landed.}}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \_impact\_velocity\ =\ \_current\_velocity;}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ These\ values\ are\ used\ by\ is\_on\_ground().}}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \_current\_velocity\ =\ \_airborne\_height\ =\ 0.0f;}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_legacy\_mode)\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...we're\ airborne.}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \_current\_colliding.clear();}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ trans\ =\ def.\_target.get\_transform();}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ LVecBase3\ pos\ =\ trans-\/>get\_pos();}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ pos[2]\ +=\ adjust;}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ def.\_target.set\_transform(trans-\/>set\_pos(pos));}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ def.updated\_transform();}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ apply\_linear\_force(def,\ LVector3(0.0f,\ 0.0f,\ adjust));}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \_impact\_velocity\ =\ \_current\_velocity;}}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \_current\_velocity\ =\ \_airborne\_height\ =\ 0.0f;}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_spam())\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ collide\_cat.spam()}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Leaving\ height\ unchanged.\(\backslash\)n"{}};}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00325\ \ \ \ \ \}}
\DoxyCodeLine{00326\ \ \ \}}
\DoxyCodeLine{00327\ }
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{return}\ okflag;}
\DoxyCodeLine{00329\ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00334\ \textcolor{keywordtype}{void}\ CollisionHandlerGravity::}
\DoxyCodeLine{00335\ apply\_linear\_force(ColliderDef\ \&def,\ \textcolor{keyword}{const}\ LVector3\ \&force)\ \{}
\DoxyCodeLine{00336\ \}}

\end{DoxyCode}
