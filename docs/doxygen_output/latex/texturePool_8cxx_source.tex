\doxysection{texture\+Pool.\+cxx}
\hypertarget{texturePool_8cxx_source}{}\label{texturePool_8cxx_source}\index{panda/src/gobj/texturePool.cxx@{panda/src/gobj/texturePool.cxx}}
\mbox{\hyperlink{texturePool_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texturePool_8h}{texturePool.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__putil_8h}{config\_putil.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__express_8h}{config\_express.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{string__utils_8h}{string\_utils.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamCache_8h}{bamCache.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamCacheRecord_8h}{bamCacheRecord.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeRegistry_8h}{pnmFileTypeRegistry.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{texturePoolFilter_8h}{texturePoolFilter.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{configVariableList_8h}{configVariableList.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{load__dso_8h}{load\_dso.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mutexHolder_8h}{mutexHolder.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dcast_8h}{dcast.h}}"{}}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ <algorithm>}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#ifdef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ <emscripten.h>}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00038\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00039\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \mbox{\hyperlink{classTexturePool}{TexturePool}}\ *TexturePool::\_global\_ptr;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00047\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{00048\ write(ostream\ \&out)\ \{}
\DoxyCodeLine{00049\ \ \ get\_global\_ptr()-\/>ns\_list\_contents(out);}
\DoxyCodeLine{00050\ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00058\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classTexturePool_a7e6bbf6870f83b1fedf7a484684167dc}{TexturePool::}}}
\DoxyCodeLine{00059\ \mbox{\hyperlink{classTexturePool_a7e6bbf6870f83b1fedf7a484684167dc}{register\_texture\_type}}(MakeTextureFunc\ *func,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&extensions)\ \{}
\DoxyCodeLine{00060\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ vector\_string\ words;}
\DoxyCodeLine{00063\ \ \ \mbox{\hyperlink{string__utils_8cxx_a67cbdf41c41ef284b3d1579cefca761f}{extract\_words}}(\mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(extensions),\ words);}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ vector\_string::const\_iterator\ wi;}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordflow}{for}\ (wi\ =\ words.begin();\ wi\ !=\ words.end();\ ++wi)\ \{}
\DoxyCodeLine{00067\ \ \ \ \ \_type\_registry[*wi]\ =\ func;}
\DoxyCodeLine{00068\ \ \ \}}
\DoxyCodeLine{00069\ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00075\ \textcolor{keywordtype}{bool}\ TexturePool::}
\DoxyCodeLine{00076\ ns\_register\_filter(\mbox{\hyperlink{classTexturePoolFilter}{TexturePoolFilter}}\ *tex\_filter)\ \{}
\DoxyCodeLine{00077\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \textcolor{comment}{//\ Make\ sure\ we\ haven't\ already\ registered\ this\ filter.}}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (std::find(\_filter\_registry.begin(),\ \_filter\_registry.end(),\ tex\_filter)\ !=\ \_filter\_registry.end())\ \{}
\DoxyCodeLine{00081\ \ \ \ \ gobj\_cat-\/>warning()}
\DoxyCodeLine{00082\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempted\ to\ register\ texture\ filter\ "{}}\ <<\ *tex\_filter}
\DoxyCodeLine{00083\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ more\ than\ once.\(\backslash\)n"{}};}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00085\ \ \ \}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ gobj\_cat.info()}
\DoxyCodeLine{00088\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Registering\ Texture\ filter\ "{}}\ <<\ *tex\_filter\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00089\ \ \ \_filter\_registry.push\_back(tex\_filter);}
\DoxyCodeLine{00090\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00091\ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00096\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{00097\ ns\_clear\_filters()\ \{}
\DoxyCodeLine{00098\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \_filter\_registry.clear();}
\DoxyCodeLine{00101\ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00107\ \textcolor{keywordtype}{bool}\ TexturePool::}
\DoxyCodeLine{00108\ ns\_is\_filter\_registered(\mbox{\hyperlink{classTexturePoolFilter}{TexturePoolFilter}}\ *tex\_filter)\ \{}
\DoxyCodeLine{00109\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \textcolor{keywordflow}{return}\ std::find(\_filter\_registry.begin(),\ \_filter\_registry.end(),\ tex\_filter)\ !=\ \_filter\_registry.end();}
\DoxyCodeLine{00112\ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00117\ \textcolor{keywordtype}{bool}\ TexturePool::}
\DoxyCodeLine{00118\ ns\_unregister\_filter(\mbox{\hyperlink{classTexturePoolFilter}{TexturePoolFilter}}\ *tex\_filter)\ \{}
\DoxyCodeLine{00119\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ FilterRegistry::iterator\ fi\ =\ std::find(\_filter\_registry.begin(),\ \_filter\_registry.end(),\ tex\_filter);}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordflow}{if}\ (fi\ ==\ \_filter\_registry.end())\ \{}
\DoxyCodeLine{00124\ \ \ \ \ gobj\_cat.warning()}
\DoxyCodeLine{00125\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Attempted\ to\ unregister\ texture\ filter\ "{}}\ <<\ *tex\_filter}
\DoxyCodeLine{00126\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ which\ was\ not\ registered.\(\backslash\)n"{}};}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00128\ \ \ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ gobj\_cat.info()}
\DoxyCodeLine{00131\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unregistering\ Texture\ filter\ "{}}\ <<\ *tex\_filter\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00132\ \ \ \_filter\_registry.erase(fi);}
\DoxyCodeLine{00133\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00134\ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00139\ \textcolor{keywordtype}{size\_t}\ TexturePool::}
\DoxyCodeLine{00140\ get\_num\_filters()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00141\ \ \ \textcolor{keywordflow}{return}\ \_filter\_registry.size();}
\DoxyCodeLine{00142\ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00147\ \mbox{\hyperlink{classTexturePoolFilter}{TexturePoolFilter}}\ *TexturePool::}
\DoxyCodeLine{00148\ get\_filter(\textcolor{keywordtype}{size\_t}\ i)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \textcolor{keywordflow}{if}\ (i\ >=\ 0\ \&\&\ i\ <\ \_filter\_registry.size())\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordflow}{return}\ \_filter\_registry[i];}
\DoxyCodeLine{00153\ \ \ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00156\ \}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00163\ TexturePool::MakeTextureFunc\ *\mbox{\hyperlink{classTexturePool_ad849aca6b8ab4f4da471f39edc01fa96}{TexturePool::}}}
\DoxyCodeLine{00164\ \mbox{\hyperlink{classTexturePool_ad849aca6b8ab4f4da471f39edc01fa96}{get\_texture\_type}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&extension)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00165\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \textcolor{keywordtype}{string}\ c\ =\ \mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(extension);}
\DoxyCodeLine{00168\ \ \ TypeRegistry::const\_iterator\ ti;}
\DoxyCodeLine{00169\ \ \ ti\ =\ \_type\_registry.find(c);}
\DoxyCodeLine{00170\ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_type\_registry.end())\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keywordflow}{return}\ (*ti).second;}
\DoxyCodeLine{00172\ \ \ \}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{comment}{//\ Check\ the\ PNM\ type\ registry.}}
\DoxyCodeLine{00175\ \ \ \mbox{\hyperlink{classPNMFileTypeRegistry}{PNMFileTypeRegistry}}\ *pnm\_reg\ =\ \mbox{\hyperlink{classPNMFileTypeRegistry_a83617b215ff0b0482e86e463b43f22cf}{PNMFileTypeRegistry::get\_global\_ptr}}();}
\DoxyCodeLine{00176\ \ \ \mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type\ =\ pnm\_reg-\/>\mbox{\hyperlink{classPNMFileTypeRegistry_af6acaa26376aeef1a4da1e874ab3a104}{get\_type\_from\_extension}}(c);}
\DoxyCodeLine{00177\ \ \ \textcolor{keywordflow}{if}\ (type\ !=\ \textcolor{keyword}{nullptr}\ ||\ c\ ==\ \textcolor{stringliteral}{"{}txo"{}}\ ||\ c\ ==\ \textcolor{stringliteral}{"{}dds"{}}\ ||\ c\ ==\ \textcolor{stringliteral}{"{}ktx"{}})\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ known\ image\ type;\ create\ an\ ordinary\ Texture.}}
\DoxyCodeLine{00179\ \ \ \ \ ((\mbox{\hyperlink{classTexturePool}{TexturePool}}\ *)\textcolor{keyword}{this})-\/>\_type\_registry[c]\ =\ Texture::make\_texture;}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{keywordflow}{return}\ Texture::make\_texture;}
\DoxyCodeLine{00181\ \ \ \}}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{comment}{//\ This\ is\ an\ unknown\ texture\ type.}}
\DoxyCodeLine{00184\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00185\ \}}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00192\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classTexturePool_aa3c4db259613ab294ea7d36d0fc85297}{TexturePool::}}}
\DoxyCodeLine{00193\ \mbox{\hyperlink{classTexturePool_aa3c4db259613ab294ea7d36d0fc85297}{write\_texture\_types}}(ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00194\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \ \ \textcolor{comment}{//\ These\ are\ supported\ out\ of\ the\ box.}}
\DoxyCodeLine{00197\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}Texture\ Object\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .txo\(\backslash\)n"{}};}
\DoxyCodeLine{00198\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}DirectDraw\ Surface\ \ \ \ \ \ \ \ \ \ \ \ \ \ .dds\(\backslash\)n"{}};}
\DoxyCodeLine{00199\ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ \textcolor{stringliteral}{"{}Khronos\ Texture\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .ktx\(\backslash\)n"{}};}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \mbox{\hyperlink{classPNMFileTypeRegistry}{PNMFileTypeRegistry}}\ *pnm\_reg\ =\ \mbox{\hyperlink{classPNMFileTypeRegistry_a83617b215ff0b0482e86e463b43f22cf}{PNMFileTypeRegistry::get\_global\_ptr}}();}
\DoxyCodeLine{00202\ \ \ pnm\_reg-\/>\mbox{\hyperlink{classPNMFileTypeRegistry_aba99f27878b68ffa5dd1ca741bf155a9}{write}}(out,\ indent\_level);}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \ \ \textcolor{comment}{//\ Also\ output\ any\ of\ the\ additional\ texture\ types,\ that\ aren't\ strictly}}
\DoxyCodeLine{00205\ \ \ \textcolor{comment}{//\ images\ (these\ are\ typically\ video\ textures).}}
\DoxyCodeLine{00206\ \ \ TypeRegistry::const\_iterator\ ti;}
\DoxyCodeLine{00207\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_type\_registry.begin();\ ti\ !=\ \_type\_registry.end();\ ++ti)\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordtype}{string}\ extension\ =\ (*ti).first;}
\DoxyCodeLine{00209\ \ \ \ \ MakeTextureFunc\ *func\ =\ (*ti).second;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordflow}{if}\ (pnm\_reg-\/>\mbox{\hyperlink{classPNMFileTypeRegistry_af6acaa26376aeef1a4da1e874ab3a104}{get\_type\_from\_extension}}(extension)\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00212\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex\ =\ func();}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ name\ =\ tex-\/>get\_type().get\_name();}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ indent\_level)\ <<\ name;}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \mbox{\hyperlink{indent_8cxx_a20c026b79ac844b38fcd02e70a7497d1}{indent}}(out,\ std::max(30\ -\/\ (\textcolor{keywordtype}{int})name.length(),\ 0))}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ ."{}}\ <<\ extension\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00217\ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \}}
\DoxyCodeLine{00219\ \}}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00225\ \mbox{\hyperlink{classTexturePool}{TexturePool}}\ *TexturePool::}
\DoxyCodeLine{00226\ get\_global\_ptr()\ \{}
\DoxyCodeLine{00227\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTexturePool}{TexturePool}};}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ call\ this\ here,\ not\ in\ the\ constructor,\ so\ that\ the}}
\DoxyCodeLine{00231\ \ \ \ \ \textcolor{comment}{//\ \_global\_ptr\ is\ safely\ assigned\ by\ the\ time\ the\ filters\ begin\ to\ load.}}
\DoxyCodeLine{00232\ \ \ \ \ \_global\_ptr-\/>load\_filters();}
\DoxyCodeLine{00233\ \ \ \}}
\DoxyCodeLine{00234\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00235\ \}}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00241\ TexturePool::}
\DoxyCodeLine{00242\ TexturePool()\ \{}
\DoxyCodeLine{00243\ \ \ \mbox{\hyperlink{classConfigVariableFilename}{ConfigVariableFilename}}\ fake\_texture\_image}
\DoxyCodeLine{00244\ \ \ \ \ (\textcolor{stringliteral}{"{}fake-\/texture-\/image"{}},\ \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{00245\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}Set\ this\ to\ enable\ a\ speedy-\/load\ mode\ in\ which\ you\ don't\ care\ "{}}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}what\ the\ world\ looks\ like,\ you\ just\ want\ it\ to\ load\ in\ minimal\ "{}}}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}time.\ \ This\ causes\ all\ texture\ loads\ via\ the\ TexturePool\ to\ use\ "{}}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}the\ same\ texture\ file,\ which\ will\ presumably\ only\ be\ loaded\ "{}}}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}once."{}}));}
\DoxyCodeLine{00250\ \ \ \_fake\_texture\_image\ =\ fake\_texture\_image;}
\DoxyCodeLine{00251\ \}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00256\ \textcolor{keywordtype}{bool}\ TexturePool::}
\DoxyCodeLine{00257\ ns\_has\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename)\ \{}
\DoxyCodeLine{00258\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ LookupKey\ key;}
\DoxyCodeLine{00261\ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ \textcolor{keyword}{false},\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}());}
\DoxyCodeLine{00262\ }
\DoxyCodeLine{00263\ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00264\ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00265\ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00268\ \ \ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ \textcolor{comment}{//\ It\ might\ still\ have\ been\ loaded\ with\ non-\/standard\ settings.}}
\DoxyCodeLine{00271\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti-\/>first.\_fullpath\ ==\ key.\_fullpath)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00274\ \ \ \ \ \}}
\DoxyCodeLine{00275\ \ \ \}}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00278\ \}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00283\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00284\ ns\_get\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps)\ \{}
\DoxyCodeLine{00286\ \ \ LookupKey\ key;}
\DoxyCodeLine{00287\ \ \ key.\_primary\_file\_num\_channels\ =\ primary\_file\_num\_channels;}
\DoxyCodeLine{00288\ \ \ \{}
\DoxyCodeLine{00289\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00290\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}());}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00293\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00297\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00299\ \ \ \ \ \}}
\DoxyCodeLine{00300\ \ \ \}}
\DoxyCodeLine{00301\ }
\DoxyCodeLine{00302\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00303\ \}}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00308\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00309\ ns\_get\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_alpha\_filename,}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ alpha\_file\_channel,}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps)\ \{}
\DoxyCodeLine{00314\ \ \ LookupKey\ key;}
\DoxyCodeLine{00315\ \ \ key.\_primary\_file\_num\_channels\ =\ primary\_file\_num\_channels;}
\DoxyCodeLine{00316\ \ \ key.\_alpha\_file\_channel\ =\ alpha\_file\_channel;}
\DoxyCodeLine{00317\ \ \ \{}
\DoxyCodeLine{00318\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00319\ \ \ \ \ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ options;}
\DoxyCodeLine{00320\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00321\ \ \ \ \ resolve\_filename(key.\_alpha\_fullpath,\ orig\_alpha\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00323\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00324\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00328\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00330\ \ \ \ \ \}}
\DoxyCodeLine{00331\ \ \ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00334\ \}}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00339\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00340\ ns\_load\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ LookupKey\ key(Texture::TT\_2d\_texture,\ primary\_file\_num\_channels,\ 0,\ options,\ sampler);}
\DoxyCodeLine{00344\ \ \ \{}
\DoxyCodeLine{00345\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00346\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00349\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00350\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00353\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00355\ \ \ \ \ \}}
\DoxyCodeLine{00356\ \ \ \}}
\DoxyCodeLine{00357\ }
\DoxyCodeLine{00358\ \ \ \textcolor{comment}{//\ The\ texture\ was\ not\ found\ in\ the\ pool.}}
\DoxyCodeLine{00359\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00360\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record;}
\DoxyCodeLine{00361\ \ \ \textcolor{keywordtype}{bool}\ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00362\ \ \ \textcolor{keywordtype}{bool}\ use\_filters\ =\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_no\_filters)\ ==\ 0;}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \ \ \textcolor{comment}{//\ Can\ one\ of\ our\ texture\ filters\ supply\ the\ texture?}}
\DoxyCodeLine{00365\ \ \ \textcolor{keywordflow}{if}\ (use\_filters)\ \{}
\DoxyCodeLine{00366\ \ \ \ \ tex\ =\ pre\_load(orig\_filename,\ \mbox{\hyperlink{classFilename}{Filename}}(),\ primary\_file\_num\_channels,\ 0,}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ read\_mipmaps,\ options);}
\DoxyCodeLine{00368\ \ \ \}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache\ =\ BamCache::get\_global\_ptr();}
\DoxyCodeLine{00371\ \ \ \textcolor{keywordtype}{bool}\ compressed\_cache\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00372\ \ \ try\_load\_cache(tex,\ cache,\ key.\_fullpath,\ record,\ compressed\_cache\_record,}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options);}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ neither\ in\ the\ pool,\ nor\ found\ in\ the\ on-\/disk\ cache;\ it}}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{comment}{//\ needs\ to\ be\ loaded\ from\ its\ source\ image(s).}}
\DoxyCodeLine{00378\ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{00379\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Loading\ texture\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \ \ \ \ \textcolor{keywordtype}{string}\ ext\ =\ \mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(key.\_fullpath.get\_extension());}
\DoxyCodeLine{00382\ \ \ \ \ \textcolor{keywordflow}{if}\ (ext\ ==\ \textcolor{stringliteral}{"{}txo"{}}\ ||\ ext\ ==\ \textcolor{stringliteral}{"{}bam"{}})\ \{}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \textcolor{comment}{//\ Assume\ this\ is\ a\ txo\ file,\ which\ might\ conceivably\ contain\ a\ movie}}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \textcolor{comment}{//\ file\ or\ some\ other\ subclass\ of\ Texture.\ \ In\ that\ case,\ use}}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \textcolor{comment}{//\ make\_from\_txo()\ to\ load\ it\ instead\ of\ read().}}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ \ \ \ \ key.\_fullpath.set\_binary();}
\DoxyCodeLine{00389\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classVirtualFile}{VirtualFile}})\ file\ =\ vfs-\/>get\_file(key.\_fullpath);}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (file\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ such\ file.}}
\DoxyCodeLine{00392\ \ \ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ find\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Reading\ texture\ object\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \ \ \ \ \ \ istream\ *in\ =\ file-\/>open\_read\_file(\textcolor{keyword}{true});}
\DoxyCodeLine{00403\ \ \ \ \ \ \ tex\ =\ Texture::make\_from\_txo(*in,\ key.\_fullpath);}
\DoxyCodeLine{00404\ \ \ \ \ \ \ vfs-\/>close\_read\_file(in);}
\DoxyCodeLine{00405\ }
\DoxyCodeLine{00406\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00409\ \ \ \ \ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00410\ \ \ \ \ \ \ tex-\/>clear\_alpha\_fullpath();}
\DoxyCodeLine{00411\ \ \ \ \ \ \ tex-\/>set\_keep\_ram\_image(\textcolor{keyword}{false});}
\DoxyCodeLine{00412\ }
\DoxyCodeLine{00413\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ it\ the\ conventional\ way.}}
\DoxyCodeLine{00415\ \ \ \ \ \ \ tex\ =\ ns\_make\_texture(ext);}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>read(key.\_fullpath,\ \mbox{\hyperlink{classFilename}{Filename}}(),\ primary\_file\_num\_channels,\ 0,}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ \textcolor{keyword}{false},\ read\_mipmaps,\ record,\ options))\ \{}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ not\ found\ or\ could\ not\ be\ read.}}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ report\_texture\_unreadable(key.\_fullpath);}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00422\ \ \ \ \ \}}
\DoxyCodeLine{00423\ }
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{keywordflow}{if}\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload\_simple)\ \{}
\DoxyCodeLine{00425\ \ \ \ \ \ \ tex-\/>generate\_simple\_ram\_image();}
\DoxyCodeLine{00426\ \ \ \ \ \}}
\DoxyCodeLine{00427\ }
\DoxyCodeLine{00428\ \ \ \ \ store\_record\ =\ (record\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00429\ \ \ \}}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00431\ \ \ \textcolor{keywordflow}{if}\ (cache-\/>get\_cache\_compressed\_textures()\ \&\&\ tex-\/>has\_compression())\ \{}
\DoxyCodeLine{00432\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SQUISH}}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00434\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ driver\_compress\_textures;}
\DoxyCodeLine{00436\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SQUISH}}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{if}\ (needs\_driver\_compression)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ the\ uncompressed\ version;\ we'll\ save\ the}}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \textcolor{comment}{//\ compressed\ version\ when\ it\ becomes\ available.}}
\DoxyCodeLine{00440\ \ \ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!compressed\_cache\_record)\ \{}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ tex-\/>set\_post\_load\_store\_cache(\textcolor{keyword}{true});}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00444\ \ \ \ \ \}}
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00446\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ this\ texture.}}
\DoxyCodeLine{00448\ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00449\ \ \ \}}
\DoxyCodeLine{00450\ }
\DoxyCodeLine{00451\ \ \ \textcolor{comment}{//\ Set\ the\ original\ filename,\ before\ we\ searched\ along\ the\ path.}}
\DoxyCodeLine{00452\ \ \ nassertr(tex\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00453\ \ \ tex-\/>set\_filename(orig\_filename);}
\DoxyCodeLine{00454\ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00455\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ \ \ \{}
\DoxyCodeLine{00458\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00459\ }
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ again-\/-\/someone\ may\ have\ just\ loaded\ this\ texture\ in\ another}}
\DoxyCodeLine{00461\ \ \ \ \ \textcolor{comment}{//\ thread.}}
\DoxyCodeLine{00462\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00463\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00464\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00467\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00469\ \ \ \ \ \}}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00471\ \ \ \ \ \_textures[std::move(key)]\ =\ tex;}
\DoxyCodeLine{00472\ \ \ \}}
\DoxyCodeLine{00473\ }
\DoxyCodeLine{00474\ \ \ \textcolor{keywordflow}{if}\ (store\_record\ \&\&\ tex-\/>is\_cacheable())\ \{}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ on-\/disk\ cache\ record\ for\ next\ time.}}
\DoxyCodeLine{00476\ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{00477\ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{00478\ \ \ \}}
\DoxyCodeLine{00479\ }
\DoxyCodeLine{00480\ \ \ \textcolor{keywordflow}{if}\ (!(options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload))\ \{}
\DoxyCodeLine{00481\ \ \ \ \ \textcolor{comment}{//\ And\ now\ drop\ the\ RAM\ until\ we\ need\ it.}}
\DoxyCodeLine{00482\ \ \ \ \ tex-\/>clear\_ram\_image();}
\DoxyCodeLine{00483\ \ \ \}}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00486\ }
\DoxyCodeLine{00487\ \ \ \textcolor{comment}{//\ Finally,\ apply\ any\ post-\/loading\ texture\ filters.}}
\DoxyCodeLine{00488\ \ \ \textcolor{keywordflow}{if}\ (use\_filters)\ \{}
\DoxyCodeLine{00489\ \ \ \ \ tex\ =\ post\_load(tex);}
\DoxyCodeLine{00490\ \ \ \}}
\DoxyCodeLine{00491\ \ \ apply\_texture\_attributes(tex,\ options,\ sampler);}
\DoxyCodeLine{00492\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00493\ \}}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00498\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00499\ ns\_load\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_alpha\_filename,}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ alpha\_file\_channel,}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{if}\ (!\_fake\_texture\_image.empty())\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keywordflow}{return}\ ns\_load\_texture(\_fake\_texture\_image,\ primary\_file\_num\_channels,}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ read\_mipmaps,\ options,\ sampler);}
\DoxyCodeLine{00507\ \ \ \}}
\DoxyCodeLine{00508\ }
\DoxyCodeLine{00509\ \ \ LookupKey\ key(Texture::TT\_2d\_texture,\ primary\_file\_num\_channels,\ alpha\_file\_channel,\ options,\ sampler);}
\DoxyCodeLine{00510\ \ \ \{}
\DoxyCodeLine{00511\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00512\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00513\ \ \ \ \ resolve\_filename(key.\_alpha\_fullpath,\ orig\_alpha\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00516\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00517\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00520\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00522\ \ \ \ \ \}}
\DoxyCodeLine{00523\ \ \ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00526\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record;}
\DoxyCodeLine{00527\ \ \ \textcolor{keywordtype}{bool}\ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00528\ \ \ \textcolor{keywordtype}{bool}\ use\_filters\ =\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_no\_filters)\ ==\ 0;}
\DoxyCodeLine{00529\ }
\DoxyCodeLine{00530\ \ \ \textcolor{comment}{//\ Can\ one\ of\ our\ texture\ filters\ supply\ the\ texture?}}
\DoxyCodeLine{00531\ \ \ \textcolor{keywordflow}{if}\ (use\_filters)\ \{}
\DoxyCodeLine{00532\ \ \ \ \ tex\ =\ pre\_load(orig\_filename,\ orig\_alpha\_filename,\ primary\_file\_num\_channels,}
\DoxyCodeLine{00533\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ alpha\_file\_channel,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00534\ \ \ \}}
\DoxyCodeLine{00535\ }
\DoxyCodeLine{00536\ \ \ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache\ =\ BamCache::get\_global\_ptr();}
\DoxyCodeLine{00537\ \ \ \textcolor{keywordtype}{bool}\ compressed\_cache\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00538\ \ \ try\_load\_cache(tex,\ cache,\ key.\_fullpath,\ record,\ compressed\_cache\_record,}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options);}
\DoxyCodeLine{00540\ }
\DoxyCodeLine{00541\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ neither\ in\ the\ pool,\ nor\ found\ in\ the\ on-\/disk\ cache;\ it}}
\DoxyCodeLine{00543\ \ \ \ \ \textcolor{comment}{//\ needs\ to\ be\ loaded\ from\ its\ source\ image(s).}}
\DoxyCodeLine{00544\ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{00545\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Loading\ texture\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\ and\ alpha\ component\ "{}}}
\DoxyCodeLine{00546\ \ \ \ \ \ \ <<\ key.\_alpha\_fullpath\ <<\ std::endl;}
\DoxyCodeLine{00547\ \ \ \ \ tex\ =\ ns\_make\_texture(key.\_fullpath.get\_extension());}
\DoxyCodeLine{00548\ \ \ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>read(key.\_fullpath,\ key.\_alpha\_fullpath,\ primary\_file\_num\_channels,}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ alpha\_file\_channel,\ 0,\ 0,\ \textcolor{keyword}{false},\ read\_mipmaps,\ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options))\ \{}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ not\ found\ or\ could\ not\ be\ read.}}
\DoxyCodeLine{00552\ \ \ \ \ \ \ report\_texture\_unreadable(key.\_fullpath);}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00554\ \ \ \ \ \}}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ \ \ \ \ \textcolor{keywordflow}{if}\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload\_simple)\ \{}
\DoxyCodeLine{00557\ \ \ \ \ \ \ tex-\/>generate\_simple\_ram\_image();}
\DoxyCodeLine{00558\ \ \ \ \ \}}
\DoxyCodeLine{00559\ }
\DoxyCodeLine{00560\ \ \ \ \ store\_record\ =\ (record\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00561\ \ \ \}}
\DoxyCodeLine{00562\ }
\DoxyCodeLine{00563\ \ \ \textcolor{keywordflow}{if}\ (cache-\/>get\_cache\_compressed\_textures()\ \&\&\ tex-\/>has\_compression())\ \{}
\DoxyCodeLine{00564\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SQUISH}}
\DoxyCodeLine{00565\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00566\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00567\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ driver\_compress\_textures;}
\DoxyCodeLine{00568\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SQUISH}}
\DoxyCodeLine{00569\ \ \ \ \ \textcolor{keywordflow}{if}\ (needs\_driver\_compression)\ \{}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ the\ uncompressed\ version;\ we'll\ save\ the}}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \textcolor{comment}{//\ compressed\ version\ when\ it\ becomes\ available.}}
\DoxyCodeLine{00572\ \ \ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!compressed\_cache\_record)\ \{}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ tex-\/>set\_post\_load\_store\_cache(\textcolor{keyword}{true});}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00576\ \ \ \ \ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{00579\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ this\ texture.}}
\DoxyCodeLine{00580\ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00581\ \ \ \}}
\DoxyCodeLine{00582\ }
\DoxyCodeLine{00583\ \ \ \textcolor{comment}{//\ Set\ the\ original\ filenames,\ before\ we\ searched\ along\ the\ path.}}
\DoxyCodeLine{00584\ \ \ nassertr(tex\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00585\ \ \ tex-\/>set\_filename(orig\_filename);}
\DoxyCodeLine{00586\ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00587\ \ \ tex-\/>set\_alpha\_filename(orig\_alpha\_filename);}
\DoxyCodeLine{00588\ \ \ tex-\/>set\_alpha\_fullpath(key.\_alpha\_fullpath);}
\DoxyCodeLine{00589\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \ \ \{}
\DoxyCodeLine{00592\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00593\ }
\DoxyCodeLine{00594\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ again.}}
\DoxyCodeLine{00595\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00596\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00597\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00600\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00602\ \ \ \ \ \}}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \ \ \ \ \_textures[std::move(key)]\ =\ tex;}
\DoxyCodeLine{00605\ \ \ \}}
\DoxyCodeLine{00606\ }
\DoxyCodeLine{00607\ \ \ \textcolor{keywordflow}{if}\ (store\_record\ \&\&\ tex-\/>is\_cacheable())\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ on-\/disk\ cache\ record\ for\ next\ time.}}
\DoxyCodeLine{00609\ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{00610\ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{00611\ \ \ \}}
\DoxyCodeLine{00612\ }
\DoxyCodeLine{00613\ \ \ \textcolor{keywordflow}{if}\ (!(options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload))\ \{}
\DoxyCodeLine{00614\ \ \ \ \ \textcolor{comment}{//\ And\ now\ drop\ the\ RAM\ until\ we\ need\ it.}}
\DoxyCodeLine{00615\ \ \ \ \ tex-\/>clear\_ram\_image();}
\DoxyCodeLine{00616\ \ \ \}}
\DoxyCodeLine{00617\ }
\DoxyCodeLine{00618\ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00619\ }
\DoxyCodeLine{00620\ \ \ \textcolor{comment}{//\ Finally,\ apply\ any\ post-\/loading\ texture\ filters.}}
\DoxyCodeLine{00621\ \ \ \textcolor{keywordflow}{if}\ (use\_filters)\ \{}
\DoxyCodeLine{00622\ \ \ \ \ tex\ =\ post\_load(tex);}
\DoxyCodeLine{00623\ \ \ \}}
\DoxyCodeLine{00624\ \ \ apply\_texture\_attributes(tex,\ options,\ sampler);}
\DoxyCodeLine{00625\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00626\ \}}
\DoxyCodeLine{00627\ }
\DoxyCodeLine{00631\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00632\ ns\_load\_3d\_texture(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename\_pattern,}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00634\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ orig\_filename(filename\_pattern);}
\DoxyCodeLine{00635\ \ \ orig\_filename.set\_pattern(\textcolor{keyword}{true});}
\DoxyCodeLine{00636\ }
\DoxyCodeLine{00637\ \ \ LookupKey\ key(Texture::TT\_3d\_texture,\ 0,\ 0,\ options,\ sampler);}
\DoxyCodeLine{00638\ \ \ \{}
\DoxyCodeLine{00639\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00640\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00642\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00643\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00644\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00647\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00649\ \ \ \ \ \}}
\DoxyCodeLine{00650\ \ \ \}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00653\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record;}
\DoxyCodeLine{00654\ \ \ \textcolor{keywordtype}{bool}\ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00655\ }
\DoxyCodeLine{00656\ \ \ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache\ =\ BamCache::get\_global\_ptr();}
\DoxyCodeLine{00657\ \ \ \textcolor{keywordtype}{bool}\ compressed\_cache\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00658\ \ \ try\_load\_cache(tex,\ cache,\ key.\_fullpath,\ record,\ compressed\_cache\_record,}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options);}
\DoxyCodeLine{00660\ }
\DoxyCodeLine{00661\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00662\ \ \ \ \ \ \ tex-\/>get\_texture\_type()\ !=\ Texture::TT\_3d\_texture)\ \{}
\DoxyCodeLine{00663\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ neither\ in\ the\ pool,\ nor\ found\ in\ the\ on-\/disk\ cache;\ it}}
\DoxyCodeLine{00664\ \ \ \ \ \textcolor{comment}{//\ needs\ to\ be\ loaded\ from\ its\ source\ image(s).}}
\DoxyCodeLine{00665\ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{00666\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Loading\ 3-\/d\ texture\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00667\ \ \ \ \ tex\ =\ ns\_make\_texture(key.\_fullpath.get\_extension());}
\DoxyCodeLine{00668\ \ \ \ \ tex-\/>setup\_3d\_texture();}
\DoxyCodeLine{00669\ \ \ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>read(key.\_fullpath,\ 0,\ 0,\ \textcolor{keyword}{true},\ read\_mipmaps,\ options))\ \{}
\DoxyCodeLine{00670\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ not\ found\ or\ could\ not\ be\ read.}}
\DoxyCodeLine{00671\ \ \ \ \ \ \ report\_texture\_unreadable(key.\_fullpath);}
\DoxyCodeLine{00672\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00673\ \ \ \ \ \}}
\DoxyCodeLine{00674\ \ \ \ \ store\_record\ =\ (record\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00675\ \ \ \}}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00677\ \ \ \textcolor{keywordflow}{if}\ (cache-\/>get\_cache\_compressed\_textures()\ \&\&\ tex-\/>has\_compression())\ \{}
\DoxyCodeLine{00678\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SQUISH}}
\DoxyCodeLine{00679\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00680\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00681\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ driver\_compress\_textures;}
\DoxyCodeLine{00682\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SQUISH}}
\DoxyCodeLine{00683\ \ \ \ \ \textcolor{keywordflow}{if}\ (needs\_driver\_compression)\ \{}
\DoxyCodeLine{00684\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ the\ uncompressed\ version;\ we'll\ save\ the}}
\DoxyCodeLine{00685\ \ \ \ \ \ \ \textcolor{comment}{//\ compressed\ version\ when\ it\ becomes\ available.}}
\DoxyCodeLine{00686\ \ \ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00687\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!compressed\_cache\_record)\ \{}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \ \ tex-\/>set\_post\_load\_store\_cache(\textcolor{keyword}{true});}
\DoxyCodeLine{00689\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00690\ \ \ \ \ \}}
\DoxyCodeLine{00691\ }
\DoxyCodeLine{00692\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{00693\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ this\ texture.}}
\DoxyCodeLine{00694\ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00695\ \ \ \}}
\DoxyCodeLine{00696\ }
\DoxyCodeLine{00697\ \ \ \textcolor{comment}{//\ Set\ the\ original\ filename,\ before\ we\ searched\ along\ the\ path.}}
\DoxyCodeLine{00698\ \ \ nassertr(tex\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00699\ \ \ tex-\/>set\_filename(filename\_pattern);}
\DoxyCodeLine{00700\ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00701\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{00702\ }
\DoxyCodeLine{00703\ \ \ \{}
\DoxyCodeLine{00704\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00705\ }
\DoxyCodeLine{00706\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ again.}}
\DoxyCodeLine{00707\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00708\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00709\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00710\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00712\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00714\ \ \ \ \ \}}
\DoxyCodeLine{00715\ }
\DoxyCodeLine{00716\ \ \ \ \ \_textures[std::move(key)]\ =\ tex;}
\DoxyCodeLine{00717\ \ \ \}}
\DoxyCodeLine{00718\ }
\DoxyCodeLine{00719\ \ \ \textcolor{keywordflow}{if}\ (store\_record\ \&\&\ tex-\/>is\_cacheable())\ \{}
\DoxyCodeLine{00720\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ on-\/disk\ cache\ record\ for\ next\ time.}}
\DoxyCodeLine{00721\ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{00722\ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{00723\ \ \ \}}
\DoxyCodeLine{00724\ }
\DoxyCodeLine{00725\ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00726\ \ \ apply\_texture\_attributes(tex,\ options,\ sampler);}
\DoxyCodeLine{00727\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00728\ \}}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00733\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00734\ ns\_load\_2d\_texture\_array(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename\_pattern,}
\DoxyCodeLine{00735\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00736\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ orig\_filename(filename\_pattern);}
\DoxyCodeLine{00737\ \ \ orig\_filename.set\_pattern(\textcolor{keyword}{true});}
\DoxyCodeLine{00738\ }
\DoxyCodeLine{00739\ \ \ LookupKey\ key(Texture::TT\_2d\_texture\_array,\ 0,\ 0,\ options,\ sampler);}
\DoxyCodeLine{00740\ \ \ \{}
\DoxyCodeLine{00741\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00742\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00743\ }
\DoxyCodeLine{00744\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00745\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00746\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00747\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00748\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00749\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00751\ \ \ \ \ \}}
\DoxyCodeLine{00752\ \ \ \}}
\DoxyCodeLine{00753\ }
\DoxyCodeLine{00754\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00755\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record;}
\DoxyCodeLine{00756\ \ \ \textcolor{keywordtype}{bool}\ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00757\ }
\DoxyCodeLine{00758\ \ \ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache\ =\ BamCache::get\_global\_ptr();}
\DoxyCodeLine{00759\ \ \ \textcolor{keywordtype}{bool}\ compressed\_cache\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00760\ \ \ try\_load\_cache(tex,\ cache,\ key.\_fullpath,\ record,\ compressed\_cache\_record,}
\DoxyCodeLine{00761\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options);}
\DoxyCodeLine{00762\ }
\DoxyCodeLine{00763\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00764\ \ \ \ \ \ \ tex-\/>get\_texture\_type()\ !=\ Texture::TT\_2d\_texture\_array)\ \{}
\DoxyCodeLine{00765\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ neither\ in\ the\ pool,\ nor\ found\ in\ the\ on-\/disk\ cache;\ it}}
\DoxyCodeLine{00766\ \ \ \ \ \textcolor{comment}{//\ needs\ to\ be\ loaded\ from\ its\ source\ image(s).}}
\DoxyCodeLine{00767\ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{00768\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Loading\ 2-\/d\ texture\ array\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00769\ \ \ \ \ tex\ =\ ns\_make\_texture(key.\_fullpath.get\_extension());}
\DoxyCodeLine{00770\ \ \ \ \ tex-\/>setup\_2d\_texture\_array();}
\DoxyCodeLine{00771\ \ \ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>read(key.\_fullpath,\ 0,\ 0,\ \textcolor{keyword}{true},\ read\_mipmaps,\ options))\ \{}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ not\ found\ or\ could\ not\ be\ read.}}
\DoxyCodeLine{00773\ \ \ \ \ \ \ report\_texture\_unreadable(key.\_fullpath);}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00775\ \ \ \ \ \}}
\DoxyCodeLine{00776\ \ \ \ \ store\_record\ =\ (record\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00777\ \ \ \}}
\DoxyCodeLine{00778\ }
\DoxyCodeLine{00779\ \ \ \textcolor{keywordflow}{if}\ (cache-\/>get\_cache\_compressed\_textures()\ \&\&\ tex-\/>has\_compression())\ \{}
\DoxyCodeLine{00780\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SQUISH}}
\DoxyCodeLine{00781\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00782\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00783\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ driver\_compress\_textures;}
\DoxyCodeLine{00784\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SQUISH}}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{keywordflow}{if}\ (needs\_driver\_compression)\ \{}
\DoxyCodeLine{00786\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ the\ uncompressed\ version;\ we'll\ save\ the}}
\DoxyCodeLine{00787\ \ \ \ \ \ \ \textcolor{comment}{//\ compressed\ version\ when\ it\ becomes\ available.}}
\DoxyCodeLine{00788\ \ \ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00789\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!compressed\_cache\_record)\ \{}
\DoxyCodeLine{00790\ \ \ \ \ \ \ \ \ tex-\/>set\_post\_load\_store\_cache(\textcolor{keyword}{true});}
\DoxyCodeLine{00791\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00792\ \ \ \ \ \}}
\DoxyCodeLine{00793\ }
\DoxyCodeLine{00794\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{00795\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ this\ texture.}}
\DoxyCodeLine{00796\ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00797\ \ \ \}}
\DoxyCodeLine{00798\ }
\DoxyCodeLine{00799\ \ \ \textcolor{comment}{//\ Set\ the\ original\ filename,\ before\ we\ searched\ along\ the\ path.}}
\DoxyCodeLine{00800\ \ \ nassertr(tex\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00801\ \ \ tex-\/>set\_filename(filename\_pattern);}
\DoxyCodeLine{00802\ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00803\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{00804\ }
\DoxyCodeLine{00805\ \ \ \{}
\DoxyCodeLine{00806\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00807\ }
\DoxyCodeLine{00808\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ again.}}
\DoxyCodeLine{00809\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00810\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00811\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00812\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00813\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00814\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00815\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00816\ \ \ \ \ \}}
\DoxyCodeLine{00817\ }
\DoxyCodeLine{00818\ \ \ \ \ \_textures[std::move(key)]\ =\ tex;}
\DoxyCodeLine{00819\ \ \ \}}
\DoxyCodeLine{00820\ }
\DoxyCodeLine{00821\ \ \ \textcolor{keywordflow}{if}\ (store\_record\ \&\&\ tex-\/>is\_cacheable())\ \{}
\DoxyCodeLine{00822\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ on-\/disk\ cache\ record\ for\ next\ time.}}
\DoxyCodeLine{00823\ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{00824\ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{00825\ \ \ \}}
\DoxyCodeLine{00826\ }
\DoxyCodeLine{00827\ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00828\ \ \ apply\_texture\_attributes(tex,\ options,\ sampler);}
\DoxyCodeLine{00829\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00830\ \}}
\DoxyCodeLine{00831\ }
\DoxyCodeLine{00835\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00836\ ns\_load\_cube\_map(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename\_pattern,\ \textcolor{keywordtype}{bool}\ read\_mipmaps,}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00838\ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ orig\_filename(filename\_pattern);}
\DoxyCodeLine{00839\ \ \ orig\_filename.set\_pattern(\textcolor{keyword}{true});}
\DoxyCodeLine{00840\ }
\DoxyCodeLine{00841\ \ \ LookupKey\ key(Texture::TT\_cube\_map,\ 0,\ 0,\ options,\ sampler);}
\DoxyCodeLine{00842\ \ \ \{}
\DoxyCodeLine{00843\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00844\ \ \ \ \ resolve\_filename(key.\_fullpath,\ orig\_filename,\ read\_mipmaps,\ options);}
\DoxyCodeLine{00845\ }
\DoxyCodeLine{00846\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00847\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00848\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00849\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00850\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00851\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00852\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00853\ \ \ \ \ \}}
\DoxyCodeLine{00854\ \ \ \}}
\DoxyCodeLine{00855\ }
\DoxyCodeLine{00856\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{00857\ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ record;}
\DoxyCodeLine{00858\ \ \ \textcolor{keywordtype}{bool}\ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00859\ }
\DoxyCodeLine{00860\ \ \ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache\ =\ BamCache::get\_global\_ptr();}
\DoxyCodeLine{00861\ \ \ \textcolor{keywordtype}{bool}\ compressed\_cache\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00862\ \ \ try\_load\_cache(tex,\ cache,\ key.\_fullpath,\ record,\ compressed\_cache\_record,}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ options);}
\DoxyCodeLine{00864\ }
\DoxyCodeLine{00865\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00866\ \ \ \ \ \ \ tex-\/>get\_texture\_type()\ !=\ Texture::TT\_cube\_map)\ \{}
\DoxyCodeLine{00867\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ neither\ in\ the\ pool,\ nor\ found\ in\ the\ on-\/disk\ cache;\ it}}
\DoxyCodeLine{00868\ \ \ \ \ \textcolor{comment}{//\ needs\ to\ be\ loaded\ from\ its\ source\ image(s).}}
\DoxyCodeLine{00869\ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{00870\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Loading\ cube\ map\ texture\ "{}}\ <<\ key.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00871\ \ \ \ \ tex\ =\ ns\_make\_texture(key.\_fullpath.get\_extension());}
\DoxyCodeLine{00872\ \ \ \ \ tex-\/>setup\_cube\_map();}
\DoxyCodeLine{00873\ \ \ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>read(key.\_fullpath,\ 0,\ 0,\ \textcolor{keyword}{true},\ read\_mipmaps,\ options))\ \{}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ not\ found\ or\ could\ not\ be\ read.}}
\DoxyCodeLine{00875\ \ \ \ \ \ \ report\_texture\_unreadable(key.\_fullpath);}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00877\ \ \ \ \ \}}
\DoxyCodeLine{00878\ \ \ \ \ store\_record\ =\ (record\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00879\ \ \ \}}
\DoxyCodeLine{00880\ }
\DoxyCodeLine{00881\ \ \ \textcolor{keywordflow}{if}\ (cache-\/>get\_cache\_compressed\_textures()\ \&\&\ tex-\/>has\_compression())\ \{}
\DoxyCodeLine{00882\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SQUISH}}
\DoxyCodeLine{00883\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00884\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00885\ \ \ \ \ \textcolor{keywordtype}{bool}\ needs\_driver\_compression\ =\ driver\_compress\_textures;}
\DoxyCodeLine{00886\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ HAVE\_SQUISH}}
\DoxyCodeLine{00887\ \ \ \ \ \textcolor{keywordflow}{if}\ (needs\_driver\_compression)\ \{}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ the\ uncompressed\ version;\ we'll\ save\ the}}
\DoxyCodeLine{00889\ \ \ \ \ \ \ \textcolor{comment}{//\ compressed\ version\ when\ it\ becomes\ available.}}
\DoxyCodeLine{00890\ \ \ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!compressed\_cache\_record)\ \{}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \ \ tex-\/>set\_post\_load\_store\_cache(\textcolor{keyword}{true});}
\DoxyCodeLine{00893\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00894\ \ \ \ \ \}}
\DoxyCodeLine{00895\ }
\DoxyCodeLine{00896\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{00897\ \ \ \ \ \textcolor{comment}{//\ We\ don't\ want\ to\ save\ this\ texture.}}
\DoxyCodeLine{00898\ \ \ \ \ store\_record\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00899\ \ \ \}}
\DoxyCodeLine{00900\ }
\DoxyCodeLine{00901\ \ \ \textcolor{comment}{//\ Set\ the\ original\ filename,\ before\ we\ searched\ along\ the\ path.}}
\DoxyCodeLine{00902\ \ \ nassertr(tex\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00903\ \ \ tex-\/>set\_filename(filename\_pattern);}
\DoxyCodeLine{00904\ \ \ tex-\/>set\_fullpath(key.\_fullpath);}
\DoxyCodeLine{00905\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{00906\ }
\DoxyCodeLine{00907\ \ \ \{}
\DoxyCodeLine{00908\ \ \ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00909\ }
\DoxyCodeLine{00910\ \ \ \ \ \textcolor{comment}{//\ Now\ look\ again.}}
\DoxyCodeLine{00911\ \ \ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{00912\ \ \ \ \ ti\ =\ \_textures.find(key);}
\DoxyCodeLine{00913\ \ \ \ \ \textcolor{keywordflow}{if}\ (ti\ !=\ \_textures.end())\ \{}
\DoxyCodeLine{00914\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ was\ previously\ loaded.}}
\DoxyCodeLine{00915\ \ \ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{00916\ \ \ \ \ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00918\ \ \ \ \ \}}
\DoxyCodeLine{00919\ }
\DoxyCodeLine{00920\ \ \ \ \ \_textures[std::move(key)]\ =\ tex;}
\DoxyCodeLine{00921\ \ \ \}}
\DoxyCodeLine{00922\ }
\DoxyCodeLine{00923\ \ \ \textcolor{keywordflow}{if}\ (store\_record\ \&\&\ tex-\/>is\_cacheable())\ \{}
\DoxyCodeLine{00924\ \ \ \ \ \textcolor{comment}{//\ Store\ the\ on-\/disk\ cache\ record\ for\ next\ time.}}
\DoxyCodeLine{00925\ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{00926\ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{00927\ \ \ \}}
\DoxyCodeLine{00928\ }
\DoxyCodeLine{00929\ \ \ nassertr(!tex-\/>get\_fullpath().empty(),\ tex);}
\DoxyCodeLine{00930\ \ \ apply\_texture\_attributes(tex,\ options,\ sampler);}
\DoxyCodeLine{00931\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{00932\ \}}
\DoxyCodeLine{00933\ }
\DoxyCodeLine{00937\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00938\ ns\_get\_normalization\_cube\_map(\textcolor{keywordtype}{int}\ size)\ \{}
\DoxyCodeLine{00939\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00941\ \ \ \textcolor{keywordflow}{if}\ (\_normalization\_cube\_map\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00942\ \ \ \ \ \_normalization\_cube\_map\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTexture}{Texture}}(\textcolor{stringliteral}{"{}normalization\_cube\_map"{}});}
\DoxyCodeLine{00943\ \ \ \}}
\DoxyCodeLine{00944\ \ \ \textcolor{keywordflow}{if}\ (\_normalization\_cube\_map-\/>get\_x\_size()\ <\ size\ ||}
\DoxyCodeLine{00945\ \ \ \ \ \ \ \_normalization\_cube\_map-\/>get\_texture\_type()\ !=\ Texture::TT\_cube\_map)\ \{}
\DoxyCodeLine{00946\ \ \ \ \ \_normalization\_cube\_map-\/>generate\_normalization\_cube\_map(size);}
\DoxyCodeLine{00947\ \ \ \}}
\DoxyCodeLine{00948\ }
\DoxyCodeLine{00949\ \ \ \textcolor{keywordflow}{return}\ \_normalization\_cube\_map;}
\DoxyCodeLine{00950\ \}}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00956\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{00957\ apply\_texture\_attributes(\mbox{\hyperlink{classTexture}{Texture}}\ *tex,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classSamplerState}{SamplerState}}\ \&sampler)\ \{}
\DoxyCodeLine{00958\ \ \ \textcolor{keywordtype}{int}\ format\ =\ options.get\_texture\_format();}
\DoxyCodeLine{00959\ \ \ \textcolor{keywordflow}{if}\ (format\ !=\ 0)\ \{}
\DoxyCodeLine{00960\ \ \ \ \ tex-\/>set\_format((Texture::Format)format);}
\DoxyCodeLine{00961\ \ \ \}}
\DoxyCodeLine{00962\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_force\_srgb)\ \{}
\DoxyCodeLine{00963\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_components\ =\ tex-\/>get\_num\_components();}
\DoxyCodeLine{00964\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_components\ ==\ 1)\ \{}
\DoxyCodeLine{00965\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classTexture_adab479f28ca4194cf345d375e45f026b}{Texture::has\_alpha}}(tex-\/>get\_format()))\ \{}
\DoxyCodeLine{00966\ \ \ \ \ \ \ \ \ tex-\/>set\_format(Texture::F\_sluminance);}
\DoxyCodeLine{00967\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00968\ \ \ \ \ \}}
\DoxyCodeLine{00969\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_components\ ==\ 2\ \&\&\ \mbox{\hyperlink{classTexture_adab479f28ca4194cf345d375e45f026b}{Texture::has\_alpha}}(tex-\/>get\_format()))\ \{}
\DoxyCodeLine{00970\ \ \ \ \ \ \ tex-\/>set\_format(Texture::F\_sluminance\_alpha);}
\DoxyCodeLine{00971\ \ \ \ \ \}}
\DoxyCodeLine{00972\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_components\ ==\ 3)\ \{}
\DoxyCodeLine{00973\ \ \ \ \ \ \ tex-\/>set\_format(Texture::F\_srgb);}
\DoxyCodeLine{00974\ \ \ \ \ \}}
\DoxyCodeLine{00975\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (num\_components\ ==\ 4)\ \{}
\DoxyCodeLine{00976\ \ \ \ \ \ \ tex-\/>set\_format(Texture::F\_srgb\_alpha);}
\DoxyCodeLine{00977\ \ \ \ \ \}}
\DoxyCodeLine{00978\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00979\ \ \ \ \ \ \ gobj\_cat.warning()}
\DoxyCodeLine{00980\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ enable\ sRGB\ format\ on\ texture\ "{}}\ <<\ tex-\/>get\_name()}
\DoxyCodeLine{00981\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ with\ specified\ format\ "{}}\ <<\ tex-\/>get\_format()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00982\ \ \ \ \ \}}
\DoxyCodeLine{00983\ \ \ \}}
\DoxyCodeLine{00984\ \ \ \textcolor{keywordtype}{int}\ compression\ =\ options.get\_texture\_compression();}
\DoxyCodeLine{00985\ \ \ \textcolor{keywordflow}{if}\ (compression\ !=\ 0)\ \{}
\DoxyCodeLine{00986\ \ \ \ \ tex-\/>set\_compression((Texture::CompressionMode)compression);}
\DoxyCodeLine{00987\ \ \ \}}
\DoxyCodeLine{00988\ \ \ \textcolor{keywordtype}{int}\ quality\ =\ options.get\_texture\_quality();}
\DoxyCodeLine{00989\ \ \ \textcolor{keywordflow}{if}\ (quality\ !=\ 0)\ \{}
\DoxyCodeLine{00990\ \ \ \ \ tex-\/>set\_quality\_level((Texture::QualityLevel)quality);}
\DoxyCodeLine{00991\ \ \ \}}
\DoxyCodeLine{00992\ \ \ tex-\/>set\_default\_sampler(sampler);}
\DoxyCodeLine{00993\ \}}
\DoxyCodeLine{00994\ }
\DoxyCodeLine{00998\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{00999\ ns\_get\_alpha\_scale\_map()\ \{}
\DoxyCodeLine{01000\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01001\ }
\DoxyCodeLine{01002\ \ \ \textcolor{keywordflow}{if}\ (\_alpha\_scale\_map\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01003\ \ \ \ \ \_alpha\_scale\_map\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTexture}{Texture}}(\textcolor{stringliteral}{"{}alpha\_scale\_map"{}});}
\DoxyCodeLine{01004\ \ \ \ \ \_alpha\_scale\_map-\/>generate\_alpha\_scale\_map();}
\DoxyCodeLine{01005\ \ \ \}}
\DoxyCodeLine{01006\ }
\DoxyCodeLine{01007\ \ \ \textcolor{keywordflow}{return}\ \_alpha\_scale\_map;}
\DoxyCodeLine{01008\ \}}
\DoxyCodeLine{01009\ }
\DoxyCodeLine{01013\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01014\ ns\_add\_texture(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ \{}
\DoxyCodeLine{01015\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ keep\ =\ tex;}
\DoxyCodeLine{01016\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01017\ }
\DoxyCodeLine{01018\ \ \ \textcolor{keywordflow}{if}\ (!tex-\/>\_texture\_pool\_key.empty())\ \{}
\DoxyCodeLine{01019\ \ \ \ \ ns\_release\_texture(tex);}
\DoxyCodeLine{01020\ \ \ \}}
\DoxyCodeLine{01021\ }
\DoxyCodeLine{01022\ \ \ \mbox{\hyperlink{classCycleDataReader}{Texture::CDReader}}\ tex\_cdata(tex-\/>\_cycler);}
\DoxyCodeLine{01023\ \ \ \textcolor{keywordflow}{if}\ (tex\_cdata-\/>\_fullpath.empty())\ \{}
\DoxyCodeLine{01024\ \ \ \ \ gobj\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Attempt\ to\ call\ add\_texture()\ on\ an\ unnamed\ texture.\(\backslash\)n"{}};}
\DoxyCodeLine{01025\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01026\ \ \ \}}
\DoxyCodeLine{01027\ }
\DoxyCodeLine{01028\ \ \ LookupKey\ key;}
\DoxyCodeLine{01029\ \ \ key.\_fullpath\ =\ tex\_cdata-\/>\_fullpath;}
\DoxyCodeLine{01030\ \ \ key.\_alpha\_fullpath\ =\ tex\_cdata-\/>\_alpha\_fullpath;}
\DoxyCodeLine{01031\ \ \ key.\_alpha\_file\_channel\ =\ tex\_cdata-\/>\_alpha\_file\_channel;}
\DoxyCodeLine{01032\ \ \ key.\_texture\_type\ =\ tex\_cdata-\/>\_texture\_type;}
\DoxyCodeLine{01033\ }
\DoxyCodeLine{01034\ \ \ \textcolor{comment}{//\ We\ blow\ away\ whatever\ texture\ was\ there\ previously,\ if\ any.}}
\DoxyCodeLine{01035\ \ \ tex-\/>\_texture\_pool\_key\ =\ key.\_fullpath;}
\DoxyCodeLine{01036\ \ \ \_textures[key]\ =\ tex;}
\DoxyCodeLine{01037\ \}}
\DoxyCodeLine{01038\ }
\DoxyCodeLine{01042\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01043\ ns\_release\_texture(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ \{}
\DoxyCodeLine{01044\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01045\ }
\DoxyCodeLine{01046\ \ \ Textures::iterator\ ti;}
\DoxyCodeLine{01047\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01048\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ (*ti).second)\ \{}
\DoxyCodeLine{01049\ \ \ \ \ \ \ \_textures.erase(ti);}
\DoxyCodeLine{01050\ \ \ \ \ \ \ tex-\/>\_texture\_pool\_key\ =\ string();}
\DoxyCodeLine{01051\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01052\ \ \ \ \ \}}
\DoxyCodeLine{01053\ \ \ \}}
\DoxyCodeLine{01054\ }
\DoxyCodeLine{01055\ \ \ \textcolor{comment}{//\ Blow\ away\ the\ cache\ of\ resolved\ relative\ filenames.}}
\DoxyCodeLine{01056\ \ \ \_relpath\_lookup.clear();}
\DoxyCodeLine{01057\ \}}
\DoxyCodeLine{01058\ }
\DoxyCodeLine{01062\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01063\ ns\_release\_all\_textures()\ \{}
\DoxyCodeLine{01064\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01065\ }
\DoxyCodeLine{01066\ \ \ Textures::iterator\ ti;}
\DoxyCodeLine{01067\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01068\ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{01069\ \ \ \ \ tex-\/>\_texture\_pool\_key\ =\ string();}
\DoxyCodeLine{01070\ \ \ \}}
\DoxyCodeLine{01071\ }
\DoxyCodeLine{01072\ \ \ \_textures.clear();}
\DoxyCodeLine{01073\ \ \ \_normalization\_cube\_map\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01074\ }
\DoxyCodeLine{01075\ \ \ \textcolor{comment}{//\ Blow\ away\ the\ cache\ of\ resolved\ relative\ filenames.}}
\DoxyCodeLine{01076\ \ \ \_relpath\_lookup.clear();}
\DoxyCodeLine{01077\ }
\DoxyCodeLine{01078\ \textcolor{preprocessor}{\#ifdef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{01079\ \ \ \textcolor{comment}{//\ Also\ empty\ the\ emscripten\ preload\ cache.}}
\DoxyCodeLine{01080\ \ \ EM\_ASM(\{}
\DoxyCodeLine{01081\ \ \ \ \ \textcolor{keywordflow}{if}\ (Module[\textcolor{stringliteral}{"{}preloadedImages"{}}])\ \{}
\DoxyCodeLine{01082\ \ \ \ \ \ \ Module[\textcolor{stringliteral}{"{}preloadedImages"{}}]\ =\ \{\};}
\DoxyCodeLine{01083\ \ \ \ \ \}}
\DoxyCodeLine{01084\ \ \ \});}
\DoxyCodeLine{01085\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01086\ \}}
\DoxyCodeLine{01087\ }
\DoxyCodeLine{01091\ \textcolor{keywordtype}{int}\ TexturePool::}
\DoxyCodeLine{01092\ ns\_garbage\_collect()\ \{}
\DoxyCodeLine{01093\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01094\ }
\DoxyCodeLine{01095\ \ \ \textcolor{keywordtype}{int}\ num\_released\ =\ 0;}
\DoxyCodeLine{01096\ \ \ Textures\ new\_set;}
\DoxyCodeLine{01097\ }
\DoxyCodeLine{01098\ \ \ Textures::iterator\ ti;}
\DoxyCodeLine{01099\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01100\ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{01101\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{01102\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01103\ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01104\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Releasing\ "{}}\ <<\ (*ti).first.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01105\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01106\ \ \ \ \ \ \ ++num\_released;}
\DoxyCodeLine{01107\ \ \ \ \ \ \ tex-\/>\_texture\_pool\_key\ =\ string();}
\DoxyCodeLine{01108\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01109\ \ \ \ \ \ \ new\_set.insert(new\_set.end(),\ *ti);}
\DoxyCodeLine{01110\ \ \ \ \ \}}
\DoxyCodeLine{01111\ \ \ \}}
\DoxyCodeLine{01112\ }
\DoxyCodeLine{01113\ \ \ \_textures.swap(new\_set);}
\DoxyCodeLine{01114\ }
\DoxyCodeLine{01115\ \ \ \textcolor{keywordflow}{if}\ (\_normalization\_cube\_map\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{01116\ \ \ \ \ \ \ \_normalization\_cube\_map-\/>get\_ref\_count()\ ==\ 1)\ \{}
\DoxyCodeLine{01117\ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01118\ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01119\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Releasing\ normalization\ cube\ map\(\backslash\)n"{}};}
\DoxyCodeLine{01120\ \ \ \ \ \}}
\DoxyCodeLine{01121\ \ \ \ \ ++num\_released;}
\DoxyCodeLine{01122\ \ \ \ \ \_normalization\_cube\_map\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01123\ \ \ \}}
\DoxyCodeLine{01124\ }
\DoxyCodeLine{01125\ \ \ \textcolor{keywordflow}{return}\ num\_released;}
\DoxyCodeLine{01126\ \}}
\DoxyCodeLine{01127\ }
\DoxyCodeLine{01131\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01132\ ns\_list\_contents(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01133\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01134\ }
\DoxyCodeLine{01135\ \ \ \textcolor{keywordtype}{int}\ total\_size;}
\DoxyCodeLine{01136\ \ \ \textcolor{keywordtype}{int}\ total\_ram\_size;}
\DoxyCodeLine{01137\ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{01138\ }
\DoxyCodeLine{01139\ \ \ out\ <<\ \textcolor{stringliteral}{"{}texture\ pool\ contents:\(\backslash\)n"{}};}
\DoxyCodeLine{01140\ }
\DoxyCodeLine{01141\ \ \ total\_size\ =\ 0;}
\DoxyCodeLine{01142\ \ \ total\_ram\_size\ =\ 0;}
\DoxyCodeLine{01143\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01144\ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{01145\ \ \ \ \ out\ <<\ (*ti).first.\_fullpath\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01146\ \ \ \ \ out\ <<\ \textcolor{stringliteral}{"{}\ \ (count\ =\ "{}}\ <<\ tex-\/>get\_ref\_count()}
\DoxyCodeLine{01147\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ ram\ \ =\ "{}}\ <<\ tex-\/>get\_ram\_image\_size()}
\DoxyCodeLine{01148\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ size\ =\ "{}}\ <<\ tex-\/>get\_ram\_page\_size()}
\DoxyCodeLine{01149\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ w\ =\ "{}}\ <<\ tex-\/>get\_x\_size()}
\DoxyCodeLine{01150\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ h\ =\ "{}}\ <<\ tex-\/>get\_y\_size()}
\DoxyCodeLine{01151\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{01152\ \ \ \ \ nassertv(tex-\/>\_texture\_pool\_key\ ==\ (*ti).first.\_fullpath);}
\DoxyCodeLine{01153\ \ \ \ \ total\_ram\_size\ +=\ tex-\/>get\_ram\_image\_size();}
\DoxyCodeLine{01154\ \ \ \ \ total\_size\ +=\ tex-\/>get\_ram\_page\_size();}
\DoxyCodeLine{01155\ \ \ \}}
\DoxyCodeLine{01156\ }
\DoxyCodeLine{01157\ \ \ out\ <<\ \textcolor{stringliteral}{"{}total\ number\ of\ textures:\ "{}}\ <<\ \_textures.size()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01158\ \ \ out\ <<\ \textcolor{stringliteral}{"{}texture\ pool\ ram\ :\ "{}}\ <<\ total\_ram\_size\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01159\ \ \ out\ <<\ \textcolor{stringliteral}{"{}texture\ pool\ size:\ "{}}\ <<\ total\_size\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01160\ \ \ out\ <<\ \textcolor{stringliteral}{"{}texture\ pool\ size\ -\/\ texture\ pool\ ram:\ "{}}\ <<\ total\_size\ -\/\ total\_ram\_size\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01161\ \}}
\DoxyCodeLine{01162\ }
\DoxyCodeLine{01166\ \mbox{\hyperlink{classTexture}{Texture}}\ *TexturePool::}
\DoxyCodeLine{01167\ ns\_find\_texture(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01168\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01169\ \ \ \mbox{\hyperlink{classGlobPattern}{GlobPattern}}\ glob(name);}
\DoxyCodeLine{01170\ }
\DoxyCodeLine{01171\ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{01172\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01173\ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{01174\ \ \ \ \ \textcolor{keywordflow}{if}\ (glob.matches(tex-\/>get\_name()))\ \{}
\DoxyCodeLine{01175\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{01176\ \ \ \ \ \}}
\DoxyCodeLine{01177\ \ \ \}}
\DoxyCodeLine{01178\ }
\DoxyCodeLine{01179\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01180\ \}}
\DoxyCodeLine{01181\ }
\DoxyCodeLine{01185\ \mbox{\hyperlink{classTextureCollection}{TextureCollection}}\ TexturePool::}
\DoxyCodeLine{01186\ ns\_find\_all\_textures(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&name)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01187\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{01188\ \ \ \mbox{\hyperlink{classTextureCollection}{TextureCollection}}\ result;}
\DoxyCodeLine{01189\ \ \ \mbox{\hyperlink{classGlobPattern}{GlobPattern}}\ glob(name);}
\DoxyCodeLine{01190\ }
\DoxyCodeLine{01191\ \ \ Textures::const\_iterator\ ti;}
\DoxyCodeLine{01192\ \ \ \textcolor{keywordflow}{for}\ (ti\ =\ \_textures.begin();\ ti\ !=\ \_textures.end();\ ++ti)\ \{}
\DoxyCodeLine{01193\ \ \ \ \ \mbox{\hyperlink{classTexture}{Texture}}\ *tex\ =\ (*ti).second;}
\DoxyCodeLine{01194\ \ \ \ \ \textcolor{keywordflow}{if}\ (glob.matches(tex-\/>get\_name()))\ \{}
\DoxyCodeLine{01195\ \ \ \ \ \ \ result.add\_texture(tex);}
\DoxyCodeLine{01196\ \ \ \ \ \}}
\DoxyCodeLine{01197\ \ \ \}}
\DoxyCodeLine{01198\ }
\DoxyCodeLine{01199\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01200\ \}}
\DoxyCodeLine{01201\ }
\DoxyCodeLine{01207\ PT(\mbox{\hyperlink{classTexture}{Texture}})\ TexturePool::}
\DoxyCodeLine{01208\ ns\_make\_texture(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&extension)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01209\ \ \ MakeTextureFunc\ *func\ =\ \mbox{\hyperlink{classTexturePool_ad849aca6b8ab4f4da471f39edc01fa96}{get\_texture\_type}}(extension);}
\DoxyCodeLine{01210\ \ \ \textcolor{keywordflow}{if}\ (func\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01211\ \ \ \ \ \textcolor{keywordflow}{return}\ func();}
\DoxyCodeLine{01212\ \ \ \}}
\DoxyCodeLine{01213\ }
\DoxyCodeLine{01214\ \ \ \textcolor{comment}{//\ We\ don't\ know\ what\ kind\ of\ file\ type\ this\ is;\ return\ an\ ordinary\ Texture}}
\DoxyCodeLine{01215\ \ \ \textcolor{comment}{//\ in\ case\ it's\ an\ image\ file\ with\ no\ extension.}}
\DoxyCodeLine{01216\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTexture}{Texture}};}
\DoxyCodeLine{01217\ \}}
\DoxyCodeLine{01218\ }
\DoxyCodeLine{01224\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01225\ resolve\_filename(\mbox{\hyperlink{classFilename}{Filename}}\ \&new\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,}
\DoxyCodeLine{01226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options)\ \{}
\DoxyCodeLine{01227\ \ \ \textcolor{keywordflow}{if}\ (!\_fake\_texture\_image.empty())\ \{}
\DoxyCodeLine{01228\ \ \ \ \ new\_filename\ =\ \_fake\_texture\_image;}
\DoxyCodeLine{01229\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01230\ \ \ \}}
\DoxyCodeLine{01231\ }
\DoxyCodeLine{01232\ \ \ RelpathLookup::iterator\ rpi\ =\ \_relpath\_lookup.find(orig\_filename);}
\DoxyCodeLine{01233\ \ \ \textcolor{keywordflow}{if}\ (rpi\ !=\ \_relpath\_lookup.end())\ \{}
\DoxyCodeLine{01234\ \ \ \ \ new\_filename\ =\ (*rpi).second;}
\DoxyCodeLine{01235\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01236\ \ \ \}}
\DoxyCodeLine{01237\ }
\DoxyCodeLine{01238\ \ \ new\_filename\ =\ orig\_filename;}
\DoxyCodeLine{01239\ \ \ \textcolor{keywordflow}{if}\ (read\_mipmaps\ ||\ (options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_multiview))\ \{}
\DoxyCodeLine{01240\ \ \ \ \ new\_filename.set\_pattern(\textcolor{keyword}{true});}
\DoxyCodeLine{01241\ \ \ \}}
\DoxyCodeLine{01242\ }
\DoxyCodeLine{01243\ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{01244\ \ \ vfs-\/>resolve\_filename(new\_filename,\ get\_model\_path());}
\DoxyCodeLine{01245\ }
\DoxyCodeLine{01246\ \ \ \_relpath\_lookup[orig\_filename]\ =\ new\_filename;}
\DoxyCodeLine{01247\ \}}
\DoxyCodeLine{01248\ }
\DoxyCodeLine{01252\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01253\ try\_load\_cache(PT(\mbox{\hyperlink{classTexture}{Texture}})\ \&tex,\ \mbox{\hyperlink{classBamCache}{BamCache}}\ *cache,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,}
\DoxyCodeLine{01254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PT(\mbox{\hyperlink{classBamCacheRecord}{BamCacheRecord}})\ \&record,\ \textcolor{keywordtype}{bool}\ \&compressed\_cache\_record,}
\DoxyCodeLine{01255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options)\ \{}
\DoxyCodeLine{01256\ \ \ \textcolor{keywordflow}{if}\ (tex\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01257\ \ \ \ \ \textcolor{comment}{//\ The\ texture\ was\ not\ supplied\ by\ a\ texture\ filter.\ \ See\ if\ it\ can\ be}}
\DoxyCodeLine{01258\ \ \ \ \ \textcolor{comment}{//\ found\ in\ the\ on-\/disk\ cache,\ if\ it\ is\ active.}}
\DoxyCodeLine{01259\ \ \ \ \ \textcolor{keywordflow}{if}\ ((cache-\/>get\_cache\_textures()\ ||\ cache-\/>get\_cache\_compressed\_textures())\ \&\&\ !textures\_header\_only)\ \{}
\DoxyCodeLine{01260\ }
\DoxyCodeLine{01261\ \ \ \ \ \ \ \textcolor{comment}{//\ Call\ ns\_make\_texture()\ on\ the\ file\ extension\ and\ create\ a\ dummy}}
\DoxyCodeLine{01262\ \ \ \ \ \ \ \textcolor{comment}{//\ texture\ object\ we\ can\ call\ ensure\_loaded\_type()\ on.\ \ We\ don't\ need\ to}}
\DoxyCodeLine{01263\ \ \ \ \ \ \ \textcolor{comment}{//\ keep\ this\ object\ around\ after\ this\ call,\ since\ we'll\ be\ creating\ a}}
\DoxyCodeLine{01264\ \ \ \ \ \ \ \textcolor{comment}{//\ new\ one\ below.\ \ I\ know\ this\ is\ a\ bit\ hacky.}}
\DoxyCodeLine{01265\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ ext\ =\ \mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(filename.get\_extension());}
\DoxyCodeLine{01266\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ dummy\ =\ ns\_make\_texture(ext);}
\DoxyCodeLine{01267\ \ \ \ \ \ \ dummy-\/>ensure\_loader\_type(filename);}
\DoxyCodeLine{01268\ \ \ \ \ \ \ dummy.clear();}
\DoxyCodeLine{01269\ }
\DoxyCodeLine{01270\ \ \ \ \ \ \ record\ =\ cache-\/>lookup(filename,\ \textcolor{stringliteral}{"{}txo"{}});}
\DoxyCodeLine{01271\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (record\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01272\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (record-\/>has\_data())\ \{}
\DoxyCodeLine{01273\ \ \ \ \ \ \ \ \ \ \ tex\ =\ DCAST(\mbox{\hyperlink{classTexture}{Texture}},\ record-\/>get\_data());}
\DoxyCodeLine{01274\ \ \ \ \ \ \ \ \ \ \ compressed\_cache\_record\ =\ (tex-\/>get\_ram\_image\_compression()\ !=\ Texture::CM\_off);}
\DoxyCodeLine{01275\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ x\_size\ =\ tex-\/>get\_orig\_file\_x\_size();}
\DoxyCodeLine{01276\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ y\_size\ =\ tex-\/>get\_orig\_file\_y\_size();}
\DoxyCodeLine{01277\ \ \ \ \ \ \ \ \ \ \ tex-\/>adjust\_this\_size(x\_size,\ y\_size,\ filename.get\_basename(),\ \textcolor{keyword}{true});}
\DoxyCodeLine{01278\ }
\DoxyCodeLine{01279\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures()\ \&\&\ !compressed\_cache\_record)\ \{}
\DoxyCodeLine{01280\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We're\ not\ supposed\ to\ be\ caching\ uncompressed\ textures.}}
\DoxyCodeLine{01281\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01282\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01283\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Not\ caching\ uncompressed\ texture\ "{}}\ <<\ *tex\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01284\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01285\ \ \ \ \ \ \ \ \ \ \ \ \ tex\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01286\ \ \ \ \ \ \ \ \ \ \ \ \ record\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01287\ }
\DoxyCodeLine{01288\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (x\_size\ !=\ tex-\/>get\_x\_size()\ ||}
\DoxyCodeLine{01289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ y\_size\ !=\ tex-\/>get\_y\_size())\ \{}
\DoxyCodeLine{01290\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ cached\ texture\ no\ longer\ matches\ our\ expected\ size\ (the}}
\DoxyCodeLine{01291\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ resizing\ config\ variables\ must\ have\ changed).\ We'll\ have\ to}}
\DoxyCodeLine{01292\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ reload\ the\ texture\ from\ its\ original\ file\ so\ we\ can\ rebuild\ the}}
\DoxyCodeLine{01293\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cache.}}
\DoxyCodeLine{01294\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01296\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cached\ texture\ "{}}\ <<\ *tex\ <<\ \textcolor{stringliteral}{"{}\ has\ size\ "{}}}
\DoxyCodeLine{01297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ tex-\/>get\_x\_size()\ <<\ \textcolor{stringliteral}{"{}\ x\ "{}}\ <<\ tex-\/>get\_y\_size()}
\DoxyCodeLine{01298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ instead\ of\ "{}}\ <<\ x\_size\ <<\ \textcolor{stringliteral}{"{}\ x\ "{}}\ <<\ y\_size}
\DoxyCodeLine{01299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{};\ dropping\ cache.\(\backslash\)n"{}};}
\DoxyCodeLine{01300\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01301\ \ \ \ \ \ \ \ \ \ \ \ \ tex\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01302\ }
\DoxyCodeLine{01303\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!tex-\/>has\_compression()\ \&\&\ tex-\/>get\_ram\_image\_compression()\ !=\ Texture::CM\_off)\ \{}
\DoxyCodeLine{01304\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ shouldn't\ be\ compressed,\ but\ it\ is.\ \ Go\ reload\ it.}}
\DoxyCodeLine{01305\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01307\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cached\ texture\ "{}}\ <<\ *tex}
\DoxyCodeLine{01308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ is\ compressed\ in\ cache;\ dropping\ cache.\(\backslash\)n"{}};}
\DoxyCodeLine{01309\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01310\ \ \ \ \ \ \ \ \ \ \ \ \ tex\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01311\ }
\DoxyCodeLine{01312\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01313\ \ \ \ \ \ \ \ \ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{01314\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Texture\ "{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\ found\ in\ disk\ cache.\(\backslash\)n"{}};}
\DoxyCodeLine{01315\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload\_simple)\ \&\&}
\DoxyCodeLine{01316\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ !tex-\/>has\_simple\_ram\_image())\ \{}
\DoxyCodeLine{01317\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tex-\/>\mbox{\hyperlink{classTexture_ae38bbedf84e17f81d7d8e5bd053dce24}{generate\_simple\_ram\_image}}();}
\DoxyCodeLine{01318\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01319\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(options.get\_texture\_flags()\ \&\ LoaderOptions::TF\_preload))\ \{}
\DoxyCodeLine{01320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ But\ drop\ the\ RAM\ until\ we\ need\ it.}}
\DoxyCodeLine{01321\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tex-\/>clear\_ram\_image();}
\DoxyCodeLine{01322\ }
\DoxyCodeLine{01323\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01324\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ was\_compressed\ =\ (tex-\/>get\_ram\_image\_compression()\ !=\ Texture::CM\_off);}
\DoxyCodeLine{01325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (tex-\/>\mbox{\hyperlink{classTexture_a998478f0a9e72cb493d1d4f83e2f3867}{consider\_auto\_process\_ram\_image}}(tex-\/>uses\_mipmaps(),\ \textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{01326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_compressed\ =\ (tex-\/>get\_ram\_image\_compression()\ !=\ Texture::CM\_off);}
\DoxyCodeLine{01327\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!was\_compressed\ \&\&\ is\_compressed\ \&\&}
\DoxyCodeLine{01328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache-\/>get\_cache\_compressed\_textures())\ \{}
\DoxyCodeLine{01329\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We've\ re-\/compressed\ the\ image\ after\ loading\ it\ from\ the}}
\DoxyCodeLine{01330\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cache.\ \ To\ keep\ the\ cache\ current,\ rewrite\ it\ to\ the}}
\DoxyCodeLine{01331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cache\ now,\ in\ its\ newly\ compressed\ form.}}
\DoxyCodeLine{01332\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ record-\/>set\_data(tex);}
\DoxyCodeLine{01333\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cache-\/>store(record);}
\DoxyCodeLine{01334\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ compressed\_cache\_record\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01335\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01336\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01337\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01338\ \ \ \ \ \ \ \ \ \ \ \ \ tex-\/>set\_keep\_ram\_image(\textcolor{keyword}{false});}
\DoxyCodeLine{01339\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01340\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!cache-\/>get\_cache\_textures())\ \{}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ texture\ has\ no\ actual\ record,\ and\ therefore\ no\ compressed}}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ record\ (yet).\ \ And\ we're\ not\ supposed\ to\ be\ caching}}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ uncompressed\ textures.}}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{01346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{01347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Not\ caching\ uncompressed\ texture\(\backslash\)n"{}};}
\DoxyCodeLine{01348\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01349\ \ \ \ \ \ \ \ \ \ \ \ \ record\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01350\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01351\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01352\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01353\ \ \ \ \ \}}
\DoxyCodeLine{01354\ \ \ \}}
\DoxyCodeLine{01355\ \}}
\DoxyCodeLine{01356\ }
\DoxyCodeLine{01360\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01361\ report\_texture\_unreadable(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01362\ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{01363\ \ \ \textcolor{keywordtype}{bool}\ has\_hash\ =\ (filename.get\_fullpath().find(\textcolor{charliteral}{'\#'})\ !=\ string::npos);}
\DoxyCodeLine{01364\ \ \ \textcolor{keywordflow}{if}\ (!has\_hash\ \&\&\ !vfs-\/>exists(filename))\ \{}
\DoxyCodeLine{01365\ \ \ \ \ \textcolor{keywordflow}{if}\ (filename.is\_local())\ \{}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ file\ doesn't\ exist,\ and\ it\ wasn't\ fully-\/qualified-\/-\/therefore,\ it}}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \textcolor{comment}{//\ wasn't\ found\ along\ either\ search\ path.}}
\DoxyCodeLine{01368\ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01369\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ find\ texture\ \(\backslash\)"{}"{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}"{}}}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ on\ model-\/path\ "{}}\ <<\ get\_model\_path()\ <<\textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01371\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01372\ \ \ \ \ \ \ \textcolor{comment}{//\ A\ fully-\/specified\ filename\ is\ not\ searched\ along\ the\ path,\ so\ don't}}
\DoxyCodeLine{01373\ \ \ \ \ \ \ \textcolor{comment}{//\ mislead\ the\ user\ with\ the\ error\ message.}}
\DoxyCodeLine{01374\ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01375\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Texture\ \(\backslash\)"{}"{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}\ does\ not\ exist.\(\backslash\)n"{}};}
\DoxyCodeLine{01376\ \ \ \ \ \}}
\DoxyCodeLine{01377\ }
\DoxyCodeLine{01378\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01379\ \ \ \ \ \textcolor{comment}{//\ The\ file\ exists,\ but\ it\ couldn't\ be\ read\ for\ some\ reason.}}
\DoxyCodeLine{01380\ \ \ \ \ \textcolor{keywordflow}{if}\ (!has\_hash)\ \{}
\DoxyCodeLine{01381\ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01382\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Texture\ \(\backslash\)"{}"{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}\ exists\ but\ cannot\ be\ read.\(\backslash\)n"{}};}
\DoxyCodeLine{01383\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01384\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ filename\ contains\ a\ hash,\ we'll\ be\ noncommittal\ about\ whether}}
\DoxyCodeLine{01385\ \ \ \ \ \ \ \textcolor{comment}{//\ it\ exists\ or\ not.}}
\DoxyCodeLine{01386\ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01387\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Texture\ \(\backslash\)"{}"{}}\ <<\ filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}\ cannot\ be\ read.\(\backslash\)n"{}};}
\DoxyCodeLine{01388\ \ \ \ \ \}}
\DoxyCodeLine{01389\ }
\DoxyCodeLine{01390\ \ \ \ \ \textcolor{comment}{//\ Maybe\ the\ filename\ extension\ is\ unknown.}}
\DoxyCodeLine{01391\ \ \ \ \ MakeTextureFunc\ *func\ =\ \mbox{\hyperlink{classTexturePool_ad849aca6b8ab4f4da471f39edc01fa96}{get\_texture\_type}}(filename.get\_extension());}
\DoxyCodeLine{01392\ \ \ \ \ \textcolor{keywordflow}{if}\ (func\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01393\ \ \ \ \ \ \ gobj\_cat.error()}
\DoxyCodeLine{01394\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Texture\ extension\ \(\backslash\)"{}"{}}\ <<\ filename.get\_extension()}
\DoxyCodeLine{01395\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)"{}\ is\ unknown.\ \ Supported\ texture\ types:\(\backslash\)n"{}};}
\DoxyCodeLine{01396\ \ \ \ \ \ \ \mbox{\hyperlink{classTexturePool_aa3c4db259613ab294ea7d36d0fc85297}{write\_texture\_types}}(gobj\_cat.error(\textcolor{keyword}{false}),\ 2);}
\DoxyCodeLine{01397\ \ \ \ \ \}}
\DoxyCodeLine{01398\ \ \ \}}
\DoxyCodeLine{01399\ \}}
\DoxyCodeLine{01400\ }
\DoxyCodeLine{01406\ PT(\mbox{\hyperlink{classTexture}{Texture}})\ TexturePool::}
\DoxyCodeLine{01407\ pre\_load(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_filename,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&orig\_alpha\_filename,}
\DoxyCodeLine{01408\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ primary\_file\_num\_channels,\ \textcolor{keywordtype}{int}\ alpha\_file\_channel,}
\DoxyCodeLine{01409\ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ read\_mipmaps,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLoaderOptions}{LoaderOptions}}\ \&options)\ \{}
\DoxyCodeLine{01410\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ tex;}
\DoxyCodeLine{01411\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{01412\ }
\DoxyCodeLine{01413\ \ \ FilterRegistry::iterator\ fi;}
\DoxyCodeLine{01414\ \ \ \textcolor{keywordflow}{for}\ (fi\ =\ \_filter\_registry.begin();}
\DoxyCodeLine{01415\ \ \ \ \ \ \ \ fi\ !=\ \_filter\_registry.end();}
\DoxyCodeLine{01416\ \ \ \ \ \ \ \ ++fi)\ \{}
\DoxyCodeLine{01417\ \ \ \ \ tex\ =\ (*fi)-\/>pre\_load(orig\_filename,\ orig\_alpha\_filename,}
\DoxyCodeLine{01418\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ primary\_file\_num\_channels,\ alpha\_file\_channel,}
\DoxyCodeLine{01419\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ read\_mipmaps,\ options);}
\DoxyCodeLine{01420\ \ \ \ \ \textcolor{keywordflow}{if}\ (tex\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01421\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{01422\ \ \ \ \ \}}
\DoxyCodeLine{01423\ \ \ \}}
\DoxyCodeLine{01424\ }
\DoxyCodeLine{01425\ \ \ \textcolor{keywordflow}{return}\ tex;}
\DoxyCodeLine{01426\ \}}
\DoxyCodeLine{01427\ }
\DoxyCodeLine{01431\ PT(\mbox{\hyperlink{classTexture}{Texture}})\ TexturePool::}
\DoxyCodeLine{01432\ post\_load(\mbox{\hyperlink{classTexture}{Texture}}\ *tex)\ \{}
\DoxyCodeLine{01433\ \ \ PT(\mbox{\hyperlink{classTexture}{Texture}})\ result\ =\ tex;}
\DoxyCodeLine{01434\ }
\DoxyCodeLine{01435\ \ \ \mbox{\hyperlink{classMutexHolder}{MutexHolder}}\ holder(\_filter\_lock);}
\DoxyCodeLine{01436\ }
\DoxyCodeLine{01437\ \ \ FilterRegistry::iterator\ fi;}
\DoxyCodeLine{01438\ \ \ \textcolor{keywordflow}{for}\ (fi\ =\ \_filter\_registry.begin();}
\DoxyCodeLine{01439\ \ \ \ \ \ \ \ fi\ !=\ \_filter\_registry.end();}
\DoxyCodeLine{01440\ \ \ \ \ \ \ \ ++fi)\ \{}
\DoxyCodeLine{01441\ \ \ \ \ result\ =\ (*fi)-\/>post\_load(result);}
\DoxyCodeLine{01442\ \ \ \}}
\DoxyCodeLine{01443\ }
\DoxyCodeLine{01444\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01445\ \}}
\DoxyCodeLine{01446\ }
\DoxyCodeLine{01447\ }
\DoxyCodeLine{01451\ \textcolor{keywordtype}{void}\ TexturePool::}
\DoxyCodeLine{01452\ load\_filters()\ \{}
\DoxyCodeLine{01453\ \ \ \mbox{\hyperlink{classConfigVariableList}{ConfigVariableList}}\ texture\_filter}
\DoxyCodeLine{01454\ \ \ \ \ (\textcolor{stringliteral}{"{}texture-\/filter"{}},}
\DoxyCodeLine{01455\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}Names\ one\ or\ more\ external\ libraries\ that\ should\ be\ loaded\ for\ the\ "{}}}
\DoxyCodeLine{01456\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}purposes\ of\ performing\ texture\ filtering.\ \ This\ variable\ may\ be\ repeated\ several\ "{}}}
\DoxyCodeLine{01457\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}times.\ \ As\ in\ load-\/display,\ the\ actual\ library\ filename\ is\ derived\ by\ "{}}}
\DoxyCodeLine{01458\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}prefixing\ 'lib'\ to\ the\ specified\ name."{}}));}
\DoxyCodeLine{01459\ }
\DoxyCodeLine{01460\ \ \ \textcolor{keywordtype}{int}\ num\_aux\ =\ texture\_filter.get\_num\_unique\_values();}
\DoxyCodeLine{01461\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_aux;\ i++)\ \{}
\DoxyCodeLine{01462\ \ \ \ \ \textcolor{keywordtype}{string}\ name\ =\ texture\_filter.get\_unique\_value(i);}
\DoxyCodeLine{01463\ }
\DoxyCodeLine{01464\ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ dlname\ =\ Filename::dso\_filename(\textcolor{stringliteral}{"{}lib"{}}\ +\ name\ +\ \textcolor{stringliteral}{"{}.so"{}});}
\DoxyCodeLine{01465\ \ \ \ \ gobj\_cat-\/>info()}
\DoxyCodeLine{01466\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}loading\ texture\ filter:\ "{}}\ <<\ dlname.\mbox{\hyperlink{classFilename_a5965a823b0fda63742c59103e8b447dd}{to\_os\_specific}}()\ <<\ std::endl;}
\DoxyCodeLine{01467\ \ \ \ \ \textcolor{keywordtype}{void}\ *tmp\ =\ load\_dso(get\_plugin\_path().get\_value(),\ dlname);}
\DoxyCodeLine{01468\ \ \ \ \ \textcolor{keywordflow}{if}\ (tmp\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01469\ \ \ \ \ \ \ gobj\_cat.info()}
\DoxyCodeLine{01470\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ load:\ "{}}\ <<\ load\_dso\_error()\ <<\ std::endl;}
\DoxyCodeLine{01471\ \ \ \ \ \}}
\DoxyCodeLine{01472\ \ \ \}}
\DoxyCodeLine{01473\ \}}

\end{DoxyCode}
