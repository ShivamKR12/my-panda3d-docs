\doxysection{x\+Input\+Device.\+cxx}
\hypertarget{xInputDevice_8cxx_source}{}\label{xInputDevice_8cxx_source}\index{panda/src/device/xInputDevice.cxx@{panda/src/device/xInputDevice.cxx}}
\mbox{\hyperlink{xInputDevice_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{xInputDevice_8h}{xInputDevice.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)\ \&\&\ !defined(CPPPARSER)}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{gamepadButton_8h}{gamepadButton.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{inputDeviceManager_8h}{inputDeviceManager.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{string__utils_8h}{string\_utils.h}}"{}}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ <xinput.h>}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <cfgmgr32.h>}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#ifndef\ XUSER\_MAX\_COUNT}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#define\ XUSER\_MAX\_COUNT\ 4}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_CAPS\_FFB\_SUPPORTED}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#define\ XINPUT\_CAPS\_FFB\_SUPPORTED\ 0x0001}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_CAPS\_NO\_NAVIGATION}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ XINPUT\_CAPS\_NO\_NAVIGATION\ 0x0010}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#ifndef\ BATTERY\_DEVTYPE\_GAMEPAD}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#define\ BATTERY\_DEVTYPE\_GAMEPAD\ 0x00}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_WHEEL}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_WHEEL\ 0x02}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_ARCADE\_STICK}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_ARCADE\_STICK\ 0x03}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_FLIGHT\_STICK}}
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_FLIGHT\_STICK\ 0x04}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_DANCE\_PAD}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_DANCE\_PAD\ 0x05}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_GUITAR}}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_GUITAR\ 0x06}}
\DoxyCodeLine{00054\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#ifndef\ XINPUT\_DEVSUBTYPE\_DRUM\_KIT}}
\DoxyCodeLine{00056\ \textcolor{preprocessor}{\#define\ XINPUT\_DEVSUBTYPE\_DRUM\_KIT\ 0x08}}
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#ifndef\ BATTERY\_TYPE\_DISCONNECTED}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#define\ BATTERY\_TYPE\_DISCONNECTED\ 0x00}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#ifndef\ BATTERY\_TYPE\_WIRED}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#define\ BATTERY\_TYPE\_WIRED\ 0x01}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \textcolor{preprocessor}{\#ifndef\ BATTERY\_LEVEL\_FULL}}
\DoxyCodeLine{00068\ \textcolor{preprocessor}{\#define\ BATTERY\_LEVEL\_FULL\ 0x03}}
\DoxyCodeLine{00069\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \textcolor{comment}{//\ With\ MingW32\ this\ raises\ the\ error:}}
\DoxyCodeLine{00072\ \textcolor{comment}{//\ Redefinition\ of\ '\_XINPUT\_BATTERY\_INFORMATION'}}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#if\ defined(\_MSC\_VER)\ \&\&\ \_WIN32\_WINNT\ <\ 0x0602}}
\DoxyCodeLine{00074\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\_XINPUT\_BATTERY\_INFORMATION\ \{}
\DoxyCodeLine{00075\ \ \ BYTE\ BatteryType;}
\DoxyCodeLine{00076\ \ \ BYTE\ BatteryLevel;}
\DoxyCodeLine{00077\ \}\ XINPUT\_BATTERY\_INFORMATION;}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \textcolor{comment}{//\ Undocumented,\ I\ figured\ out\ how\ this\ looks\ by\ trial\ and\ error.}}
\DoxyCodeLine{00081\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\_XINPUT\_BUSINFO\ \{}
\DoxyCodeLine{00082\ \ \ WORD\ VendorID;}
\DoxyCodeLine{00083\ \ \ WORD\ ProductID;}
\DoxyCodeLine{00084\ \ \ WORD\ RevisionID;}
\DoxyCodeLine{00085\ \ \ WORD\ Unknown1;\ \textcolor{comment}{//\ Unknown\ -\/\ padding?}}
\DoxyCodeLine{00086\ \ \ DWORD\ InstanceID;}
\DoxyCodeLine{00087\ \ \ DWORD\ Unknown2;}
\DoxyCodeLine{00088\ \ \ WORD\ Unknown3;}
\DoxyCodeLine{00089\ \}\ XINPUT\_BUSINFO;}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\_XINPUT\_CAPABILITIES\_EX\ \{}
\DoxyCodeLine{00092\ \ \ BYTE\ Type;}
\DoxyCodeLine{00093\ \ \ BYTE\ SubType;}
\DoxyCodeLine{00094\ \ \ WORD\ Flags;}
\DoxyCodeLine{00095\ \ \ XINPUT\_GAMEPAD\ Gamepad;}
\DoxyCodeLine{00096\ \ \ XINPUT\_VIBRATION\ Vibration;}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \textcolor{comment}{//\ The\ following\ fields\ are\ undocumented.}}
\DoxyCodeLine{00099\ \ \ WORD\ VendorID;}
\DoxyCodeLine{00100\ \ \ WORD\ ProductID;}
\DoxyCodeLine{00101\ \ \ WORD\ RevisionID;}
\DoxyCodeLine{00102\ \ \ WORD\ Unknown1;}
\DoxyCodeLine{00103\ \ \ WORD\ Unknown2;}
\DoxyCodeLine{00104\ \}\ XINPUT\_CAPABILITIES\_EX;}
\DoxyCodeLine{00105\ }
\DoxyCodeLine{00106\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputGetState)(DWORD,\ XINPUT\_STATE\ *);}
\DoxyCodeLine{00107\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputSetState)(DWORD,\ XINPUT\_VIBRATION\ *);}
\DoxyCodeLine{00108\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputGetCapabilities)(DWORD,\ DWORD,\ XINPUT\_CAPABILITIES\ *);}
\DoxyCodeLine{00109\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputGetCapabilitiesEx)(DWORD,\ DWORD,\ DWORD,\ XINPUT\_CAPABILITIES\_EX\ *);}
\DoxyCodeLine{00110\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputGetBatteryInformation)(DWORD,\ BYTE,\ XINPUT\_BATTERY\_INFORMATION\ *);}
\DoxyCodeLine{00111\ \textcolor{keyword}{typedef}\ DWORD\ (WINAPI\ *pXInputGetBaseBusInformation)(DWORD,\ XINPUT\_BUSINFO\ *);}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{keyword}{static}\ pXInputGetState\ get\_state\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00114\ \textcolor{keyword}{static}\ pXInputSetState\ set\_state\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00115\ \textcolor{keyword}{static}\ pXInputGetCapabilities\ get\_capabilities\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00116\ \textcolor{keyword}{static}\ pXInputGetCapabilitiesEx\ get\_capabilities\_ex\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00117\ \textcolor{keyword}{static}\ pXInputGetBatteryInformation\ get\_battery\_information\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00118\ \textcolor{keyword}{static}\ pXInputGetBaseBusInformation\ get\_base\_bus\_information\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \textcolor{keywordtype}{bool}\ XInputDevice::\_initialized\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00125\ XInputDevice::}
\DoxyCodeLine{00126\ XInputDevice(DWORD\ user\_index)\ :}
\DoxyCodeLine{00127\ \ \ \_index(user\_index),}
\DoxyCodeLine{00128\ \ \ \_last\_packet(-\/1),}
\DoxyCodeLine{00129\ \ \ \_last\_buttons(0)\ \{}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ nassertv(user\_index\ >=\ 0\ \&\&\ user\_index\ <\ XUSER\_MAX\_COUNT);}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \_axes.resize(6);}
\DoxyCodeLine{00134\ \ \ \_buttons.resize(16);}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00140\ XInputDevice::}
\DoxyCodeLine{00141\ \string~XInputDevice()\ \{}
\DoxyCodeLine{00142\ \ \ do\_set\_vibration(0,\ 0);}
\DoxyCodeLine{00143\ \}}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00149\ \textcolor{keywordtype}{bool}\ XInputDevice::}
\DoxyCodeLine{00150\ check\_arrival(\textcolor{keyword}{const}\ RID\_DEVICE\_INFO\ \&info,\ DEVINST\ inst,}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\ \&name,\ \textcolor{keyword}{const}\ std::string\ \&manufacturer)\ \{}
\DoxyCodeLine{00152\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00153\ \ \ \textcolor{keywordflow}{if}\ (\_is\_connected)\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00155\ \ \ \}}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00157\ \ \ \textcolor{keywordflow}{if}\ (!\_initialized)\ \{}
\DoxyCodeLine{00158\ \ \ \ \ nassertr\_always(init\_xinput(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00159\ \ \ \}}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ XINPUT\_CAPABILITIES\_EX\ caps\ =\ \{0\};}
\DoxyCodeLine{00162\ \ \ XINPUT\_STATE\ state;}
\DoxyCodeLine{00163\ \ \ \textcolor{keywordflow}{if}\ ((get\_capabilities\_ex\ \&\&\ get\_capabilities\_ex(1,\ \_index,\ 0,\ \&caps)\ !=\ ERROR\_SUCCESS)\ \&\&}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ get\_capabilities(\_index,\ 0,\ (XINPUT\_CAPABILITIES\ *)\&caps)\ !=\ ERROR\_SUCCESS)\ \{}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00166\ \ \ \}}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \textcolor{keywordflow}{if}\ (get\_state(\_index,\ \&state)\ !=\ ERROR\_SUCCESS)\ \{}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \textcolor{comment}{//\ Extra\ check\ for\ VID/PID\ if\ we\ have\ it,\ just\ to\ be\ sure.}}
\DoxyCodeLine{00173\ \ \ \textcolor{keywordflow}{if}\ ((caps.VendorID\ !=\ 0\ \&\&\ caps.VendorID\ !=\ info.hid.dwVendorId)\ ||}
\DoxyCodeLine{00174\ \ \ \ \ \ \ (caps.ProductID\ !=\ 0\ \&\&\ caps.ProductID\ !=\ info.hid.dwProductId))\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \textcolor{comment}{//\ Yes,\ take\ the\ name\ and\ manufacturer.}}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{if}\ (!name.empty())\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \_name\ =\ name;}
\DoxyCodeLine{00181\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \_name\ =\ \textcolor{stringliteral}{"{}XInput\ Device\ \#"{}};}
\DoxyCodeLine{00183\ \ \ \ \ \_name\ +=\ format\_string(\_index\ +\ 1);}
\DoxyCodeLine{00184\ \ \ \}}
\DoxyCodeLine{00185\ \ \ \_manufacturer\ =\ manufacturer;}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \textcolor{keywordflow}{if}\ (inst\ \&\&\ caps.ProductID\ ==\ 0\ \&\&\ caps.RevisionID\ !=\ 0)\ \{}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{comment}{//\ XInput\ does\ not\ report\ a\ product\ ID\ for\ the\ Xbox\ 360\ wireless\ adapter.}}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{comment}{//\ Instead,\ we\ check\ that\ the\ RevisionID\ matches.}}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordtype}{char}\ buffer[4096];}
\DoxyCodeLine{00191\ \ \ \ \ ULONG\ buflen\ =\ \textcolor{keyword}{sizeof}(buffer);}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{keywordflow}{if}\ (CM\_Get\_DevNode\_Registry\_Property(inst,\ CM\_DRP\_HARDWAREID,\ 0,\ buffer,\ \&buflen,\ 0)\ ==\ CR\_SUCCESS)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \ \ std::string\ ids(buffer,\ buflen);}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ revstr[16];}
\DoxyCodeLine{00195\ \ \ \ \ \ \ sprintf(revstr,\ \textcolor{stringliteral}{"{}REV\_\%04x"{}},\ caps.RevisionID);}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (ids.find(revstr)\ ==\ std::string::npos)\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00199\ \ \ \ \ \}}
\DoxyCodeLine{00200\ \ \ \}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \_is\_connected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00203\ \ \ init\_device(caps,\ state);}
\DoxyCodeLine{00204\ \ \ \_vendor\_id\ =\ info.hid.dwVendorId;}
\DoxyCodeLine{00205\ \ \ \_product\_id\ =\ info.hid.dwProductId;}
\DoxyCodeLine{00206\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00207\ \}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00214\ \textcolor{keywordtype}{void}\ XInputDevice::}
\DoxyCodeLine{00215\ detect(\mbox{\hyperlink{classInputDeviceManager}{InputDeviceManager}}\ *mgr)\ \{}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{if}\ (!\_initialized)\ \{}
\DoxyCodeLine{00217\ \ \ \ \ nassertv\_always(init\_xinput());}
\DoxyCodeLine{00218\ \ \ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \ \ \textcolor{keywordtype}{bool}\ connected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \ \ XINPUT\_CAPABILITIES\_EX\ caps\ =\ \{0\};}
\DoxyCodeLine{00223\ \ \ XINPUT\_STATE\ state;}
\DoxyCodeLine{00224\ \ \ \textcolor{keywordflow}{if}\ (((get\_capabilities\_ex\ \&\&\ get\_capabilities\_ex(1,\ \_index,\ 0,\ \&caps)\ ==\ ERROR\_SUCCESS)\ ||}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ get\_capabilities(\_index,\ 0,\ (XINPUT\_CAPABILITIES\ *)\&caps)\ ==\ ERROR\_SUCCESS)\ \&\&}
\DoxyCodeLine{00226\ \ \ \ \ \ \ get\_state(\_index,\ \&state)\ ==\ ERROR\_SUCCESS)\ \{}
\DoxyCodeLine{00227\ \ \ \ \ connected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00228\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00229\ \ \ \ \ connected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00230\ \ \ \}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00233\ \ \ \textcolor{keywordflow}{if}\ (connected\ ==\ \_is\_connected)\ \{}
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{comment}{//\ Nothing\ changed.}}
\DoxyCodeLine{00235\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00236\ \ \ \}}
\DoxyCodeLine{00237\ \ \ \_is\_connected\ =\ connected;}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \textcolor{keywordflow}{if}\ (connected)\ \{}
\DoxyCodeLine{00240\ \ \ \ \ \_name\ =\ \textcolor{stringliteral}{"{}XInput\ Device\ \#"{}};}
\DoxyCodeLine{00241\ \ \ \ \ \_name\ +=\ format\_string(\_index\ +\ 1);}
\DoxyCodeLine{00242\ \ \ \ \ \_vendor\_id\ =\ caps.VendorID;}
\DoxyCodeLine{00243\ \ \ \ \ \_product\_id\ =\ caps.ProductID;}
\DoxyCodeLine{00244\ \ \ \ \ init\_device(caps,\ state);}
\DoxyCodeLine{00245\ \ \ \ \ mgr-\/>\mbox{\hyperlink{classInputDeviceManager_a18ba08ba79d70eeec582d36f736ee3e9}{add\_device}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00246\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00247\ \ \ \ \ mgr-\/>\mbox{\hyperlink{classInputDeviceManager_a88b9e72485abcc388e461d4855d460b1}{remove\_device}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00248\ \ \ \}}
\DoxyCodeLine{00249\ \}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00254\ \textcolor{keywordtype}{bool}\ XInputDevice::}
\DoxyCodeLine{00255\ init\_xinput()\ \{}
\DoxyCodeLine{00256\ \ \ \textcolor{keywordflow}{if}\ (\_initialized)\ \{}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00258\ \ \ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00261\ \ \ \ \ device\_cat.debug()\ <<\ \textcolor{stringliteral}{"{}Initializing\ XInput\ library.\(\backslash\)n"{}};}
\DoxyCodeLine{00262\ \ \ \}}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ \ \ \_initialized\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00265\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *dll\_name\ =\ \textcolor{stringliteral}{"{}Xinput1\_4.dll"{}};}
\DoxyCodeLine{00266\ \ \ HMODULE\ \textcolor{keyword}{module}\ =\ LoadLibraryA(dll\_name);}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \textcolor{comment}{//\ If\ we\ didn't\ find\ XInput\ 1.4,\ fall\ back\ to\ the\ older\ 1.3\ version.}}
\DoxyCodeLine{00269\ \ \ \textcolor{keywordflow}{if}\ (!module)\ \{}
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \ \ device\_cat.debug()}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Xinput1\_4.dll\ not\ found,\ falling\ back\ to\ Xinput1\_3.dll\(\backslash\)n"{}};}
\DoxyCodeLine{00273\ \ \ \ \ \}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \ \ dll\_name\ =\ \textcolor{stringliteral}{"{}Xinput1\_3.dll"{}};}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{keyword}{module}\ =\ LoadLibraryA(dll\_name);}
\DoxyCodeLine{00277\ \ \ \}}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \textcolor{keywordflow}{if}\ (module)\ \{}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keywordflow}{if}\ (device\_cat.is\_debug())\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \ \ device\_cat.debug()}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Successfully\ loaded\ "{}}\ <<\ dll\_name\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00283\ \ \ \ \ \}}
\DoxyCodeLine{00284\ }
\DoxyCodeLine{00285\ \ \ \ \ \textcolor{comment}{//\ Undocumented\ version\ (XInputGetStateEx)\ that\ includes\ a}}
\DoxyCodeLine{00286\ \ \ \ \ \textcolor{comment}{//\ state\ bit\ for\ the\ guide\ button.}}
\DoxyCodeLine{00287\ \ \ \ \ get\_state\ =\ (pXInputGetState)GetProcAddress(module,\ MAKEINTRESOURCE(100));}
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00289\ \ \ \ \ \ \ get\_state\ =\ (pXInputGetState)GetProcAddress(module,\ \textcolor{stringliteral}{"{}XInputGetState"{}});}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ device\_cat.error()}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ find\ function\ XInputGetState\ in\ "{}}\ <<\ dll\_name\ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00295\ \ \ \ \ \}}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ \ \ \ \ set\_state\ =\ (pXInputSetState)GetProcAddress(module,\ \textcolor{stringliteral}{"{}XInputSetState"{}});}
\DoxyCodeLine{00298\ \ \ \ \ \textcolor{keywordflow}{if}\ (set\_state\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \ \ device\_cat.error()}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ find\ function\ XInputSetState\ in\ "{}}\ <<\ dll\_name\ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00302\ \ \ \ \ \}}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00304\ \ \ \ \ get\_capabilities\ =\ (pXInputGetCapabilities)GetProcAddress(module,\ \textcolor{stringliteral}{"{}XInputGetCapabilities"{}});}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_capabilities\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ device\_cat.error()}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ find\ function\ XInputGetCapabilities\ in\ "{}}\ <<\ dll\_name\ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00309\ \ \ \ \ \}}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00311\ \ \ \ \ get\_battery\_information\ =\ (pXInputGetBatteryInformation)GetProcAddress(module,\ \textcolor{stringliteral}{"{}XInputGetBatteryInformation"{}});}
\DoxyCodeLine{00312\ \ \ \ \ get\_base\_bus\_information\ =\ (pXInputGetBaseBusInformation)GetProcAddress(module,\ MAKEINTRESOURCE(104));}
\DoxyCodeLine{00313\ \ \ \ \ get\_capabilities\_ex\ =\ (pXInputGetCapabilitiesEx)GetProcAddress(module,\ MAKEINTRESOURCE(108));}
\DoxyCodeLine{00314\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00315\ \ \ \}}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ device\_cat.error()}
\DoxyCodeLine{00318\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Failed\ to\ load\ Xinput1\_4.dll\ or\ Xinput1\_3.dll.\(\backslash\)n"{}};}
\DoxyCodeLine{00319\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00320\ \}}
\DoxyCodeLine{00321\ }
\DoxyCodeLine{00326\ \textcolor{keywordtype}{void}\ XInputDevice::}
\DoxyCodeLine{00327\ init\_device(\textcolor{keyword}{const}\ XINPUT\_CAPABILITIES\_EX\ \&caps,\ \textcolor{keyword}{const}\ XINPUT\_STATE\ \&state)\ \{}
\DoxyCodeLine{00328\ \ \ nassertv(\_initialized);}
\DoxyCodeLine{00329\ \ \ \textcolor{comment}{//\ It\ seems\ that\ the\ Xbox\ One\ controller\ is\ reported\ as\ having\ a\ DevType\ of}}
\DoxyCodeLine{00330\ \ \ \textcolor{comment}{//\ zero,\ at\ least\ when\ I\ tested\ in\ with\ XInput\ 1.3\ on\ Windows\ 7.}}
\DoxyCodeLine{00331\ \ \ \textcolor{comment}{//if\ (caps.Type\ ==\ XINPUT\_DEVTYPE\_GAMEPAD)\ \{}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ \ \ \textcolor{comment}{//\ For\ subtypes\ and\ mappings,\ see\ this\ page:}}
\DoxyCodeLine{00334\ \ \ \textcolor{comment}{//\ https://msdn.microsoft.com/en-\/us/library/windows/desktop/hh405050.aspx}}
\DoxyCodeLine{00335\ \ \ \textcolor{keywordflow}{switch}\ (caps.SubType)\ \{}
\DoxyCodeLine{00336\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00337\ \ \ \textcolor{keywordflow}{case}\ XINPUT\_DEVSUBTYPE\_GAMEPAD:}
\DoxyCodeLine{00338\ \ \ \ \ \_device\_class\ =\ DeviceClass::GAMEPAD;}
\DoxyCodeLine{00339\ \ \ \ \ \_axes[0].axis\ =\ Axis::LEFT\_TRIGGER;}
\DoxyCodeLine{00340\ \ \ \ \ \_axes[1].axis\ =\ Axis::RIGHT\_TRIGGER;}
\DoxyCodeLine{00341\ \ \ \ \ \_axes[2].axis\ =\ Axis::LEFT\_X;}
\DoxyCodeLine{00342\ \ \ \ \ \_axes[3].axis\ =\ Axis::LEFT\_Y;}
\DoxyCodeLine{00343\ \ \ \ \ \_axes[4].axis\ =\ Axis::RIGHT\_X;}
\DoxyCodeLine{00344\ \ \ \ \ \_axes[5].axis\ =\ Axis::RIGHT\_Y;}
\DoxyCodeLine{00345\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ \textcolor{keywordflow}{case}\ XINPUT\_DEVSUBTYPE\_WHEEL:}
\DoxyCodeLine{00348\ \ \ \ \ \_device\_class\ =\ DeviceClass::STEERING\_WHEEL;}
\DoxyCodeLine{00349\ \ \ \ \ \_axes[0].axis\ =\ Axis::BRAKE;}
\DoxyCodeLine{00350\ \ \ \ \ \_axes[1].axis\ =\ Axis::ACCELERATOR;}
\DoxyCodeLine{00351\ \ \ \ \ \_axes[2].axis\ =\ Axis::WHEEL;}
\DoxyCodeLine{00352\ \ \ \ \ \_axes[3].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00353\ \ \ \ \ \_axes[4].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00354\ \ \ \ \ \_axes[5].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00356\ }
\DoxyCodeLine{00357\ \ \ \textcolor{keywordflow}{case}\ XINPUT\_DEVSUBTYPE\_FLIGHT\_STICK:}
\DoxyCodeLine{00358\ \ \ \ \ \_device\_class\ =\ DeviceClass::FLIGHT\_STICK;}
\DoxyCodeLine{00359\ \ \ \ \ \_axes[0].axis\ =\ Axis::YAW;}
\DoxyCodeLine{00360\ \ \ \ \ \_axes[1].axis\ =\ Axis::THROTTLE;}
\DoxyCodeLine{00361\ \ \ \ \ \_axes[2].axis\ =\ Axis::ROLL;}
\DoxyCodeLine{00362\ \ \ \ \ \_axes[3].axis\ =\ Axis::PITCH;}
\DoxyCodeLine{00363\ \ \ \ \ \_axes[4].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00364\ \ \ \ \ \_axes[5].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00366\ }
\DoxyCodeLine{00367\ \ \ \textcolor{keywordflow}{case}\ XINPUT\_DEVSUBTYPE\_DANCE\_PAD:}
\DoxyCodeLine{00368\ \ \ \ \ \_device\_class\ =\ DeviceClass::DANCE\_PAD;}
\DoxyCodeLine{00369\ \ \ \ \ \_axes[0].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00370\ \ \ \ \ \_axes[1].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00371\ \ \ \ \ \_axes[2].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00372\ \ \ \ \ \_axes[3].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00373\ \ \ \ \ \_axes[4].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00374\ \ \ \ \ \_axes[5].axis\ =\ Axis::NONE;}
\DoxyCodeLine{00375\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00376\ \ \ \}}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00378\ \ \ \_axes[0].\_scale\ =\ 1.0\ /\ 255.0;}
\DoxyCodeLine{00379\ \ \ \_axes[1].\_scale\ =\ 1.0\ /\ 255.0;}
\DoxyCodeLine{00380\ \ \ \_axes[2].\_scale\ =\ 1.0\ /\ 32767.5;}
\DoxyCodeLine{00381\ \ \ \_axes[3].\_scale\ =\ 1.0\ /\ 32767.5;}
\DoxyCodeLine{00382\ \ \ \_axes[4].\_scale\ =\ 1.0\ /\ 32767.5;}
\DoxyCodeLine{00383\ \ \ \_axes[5].\_scale\ =\ 1.0\ /\ 32767.5;}
\DoxyCodeLine{00384\ }
\DoxyCodeLine{00385\ \ \ \_axes[2].\_bias\ =\ 0.5\ /\ 32767.5;}
\DoxyCodeLine{00386\ \ \ \_axes[3].\_bias\ =\ 0.5\ /\ 32767.5;}
\DoxyCodeLine{00387\ \ \ \_axes[4].\_bias\ =\ 0.5\ /\ 32767.5;}
\DoxyCodeLine{00388\ \ \ \_axes[5].\_bias\ =\ 0.5\ /\ 32767.5;}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \ \ \textcolor{keywordflow}{if}\ (caps.Flags\ \&\ XINPUT\_CAPS\_NO\_NAVIGATION)\ \{}
\DoxyCodeLine{00391\ \ \ \ \ \_buttons[0].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00392\ \ \ \ \ \_buttons[1].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00393\ \ \ \ \ \_buttons[2].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00394\ \ \ \ \ \_buttons[3].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00395\ \ \ \ \ \_buttons[4].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00396\ \ \ \ \ \_buttons[5].handle\ =\ ButtonHandle::none();}
\DoxyCodeLine{00397\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00398\ \ \ \ \ \_buttons[0].handle\ =\ GamepadButton::dpad\_up();}
\DoxyCodeLine{00399\ \ \ \ \ \_buttons[1].handle\ =\ GamepadButton::dpad\_down();}
\DoxyCodeLine{00400\ \ \ \ \ \_buttons[2].handle\ =\ GamepadButton::dpad\_left();}
\DoxyCodeLine{00401\ \ \ \ \ \_buttons[3].handle\ =\ GamepadButton::dpad\_right();}
\DoxyCodeLine{00402\ \ \ \ \ \_buttons[4].handle\ =\ GamepadButton::start();}
\DoxyCodeLine{00403\ \ \ \ \ \_buttons[5].handle\ =\ GamepadButton::back();}
\DoxyCodeLine{00404\ \ \ \}}
\DoxyCodeLine{00405\ \ \ \_buttons[6].handle\ =\ GamepadButton::lstick();}
\DoxyCodeLine{00406\ \ \ \_buttons[7].handle\ =\ GamepadButton::rstick();}
\DoxyCodeLine{00407\ \ \ \_buttons[8].handle\ =\ GamepadButton::lshoulder();}
\DoxyCodeLine{00408\ \ \ \_buttons[9].handle\ =\ GamepadButton::rshoulder();}
\DoxyCodeLine{00409\ \ \ \_buttons[10].handle\ =\ GamepadButton::guide();}
\DoxyCodeLine{00410\ \ \ \_buttons[11].handle\ =\ GamepadButton::face\_a();}
\DoxyCodeLine{00411\ \ \ \_buttons[12].handle\ =\ GamepadButton::face\_b();}
\DoxyCodeLine{00412\ \ \ \_buttons[13].handle\ =\ GamepadButton::face\_x();}
\DoxyCodeLine{00413\ \ \ \_buttons[14].handle\ =\ GamepadButton::face\_y();}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \textcolor{keywordflow}{if}\ (caps.Vibration.wLeftMotorSpeed\ !=\ 0\ ||}
\DoxyCodeLine{00416\ \ \ \ \ \ \ caps.Vibration.wRightMotorSpeed\ !=\ 0)\ \{}
\DoxyCodeLine{00417\ \ \ \ \ enable\_feature(Feature::VIBRATION);}
\DoxyCodeLine{00418\ \ \ \}}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \textcolor{keywordflow}{if}\ (get\_battery\_information\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00421\ \ \ \ \ XINPUT\_BATTERY\_INFORMATION\ batt;}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_battery\_information(\_index,\ BATTERY\_DEVTYPE\_GAMEPAD,\ \&batt)\ ==\ ERROR\_SUCCESS)\ \{}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (batt.BatteryType\ !=\ BATTERY\_TYPE\_DISCONNECTED\ \&\&}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ \ \ batt.BatteryType\ !=\ BATTERY\_TYPE\_WIRED)\ \{}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ device\ has\ a\ battery.\ \ Report\ the\ battery\ level.}}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ enable\_feature(Feature::BATTERY);}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \_battery\_data.level\ =\ batt.BatteryLevel;}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ \_battery\_data.max\_level\ =\ BATTERY\_LEVEL\_FULL;}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00430\ \ \ \ \ \}}
\DoxyCodeLine{00431\ \ \ \}}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \ \ WORD\ buttons\ =\ state.Gamepad.wButtons;}
\DoxyCodeLine{00434\ \ \ WORD\ mask\ =\ 1;}
\DoxyCodeLine{00435\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 16;\ ++i)\ \{}
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{comment}{//\ Set\ the\ state\ without\ triggering\ a\ button\ event.}}
\DoxyCodeLine{00437\ \ \ \ \ \_buttons[i].\_state\ =\ (buttons\ \&\ mask)\ ?\ S\_down\ :\ S\_up;}
\DoxyCodeLine{00438\ \ \ \ \ mask\ <<=\ 1;}
\DoxyCodeLine{00439\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ 10)\ \{}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \textcolor{comment}{//\ XInput\ skips\ 0x0800.}}
\DoxyCodeLine{00441\ \ \ \ \ \ \ mask\ <<=\ 1;}
\DoxyCodeLine{00442\ \ \ \ \ \}}
\DoxyCodeLine{00443\ \ \ \}}
\DoxyCodeLine{00444\ }
\DoxyCodeLine{00445\ \ \ axis\_changed(0,\ state.Gamepad.bLeftTrigger);}
\DoxyCodeLine{00446\ \ \ axis\_changed(1,\ state.Gamepad.bRightTrigger);}
\DoxyCodeLine{00447\ \ \ axis\_changed(2,\ state.Gamepad.sThumbLX);}
\DoxyCodeLine{00448\ \ \ axis\_changed(3,\ state.Gamepad.sThumbLY);}
\DoxyCodeLine{00449\ \ \ axis\_changed(4,\ state.Gamepad.sThumbRX);}
\DoxyCodeLine{00450\ \ \ axis\_changed(5,\ state.Gamepad.sThumbRY);}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \_last\_buttons\ =\ buttons;}
\DoxyCodeLine{00453\ \ \ \_last\_packet\ =\ state.dwPacketNumber;}
\DoxyCodeLine{00454\ \}}
\DoxyCodeLine{00455\ }
\DoxyCodeLine{00461\ \textcolor{keywordtype}{void}\ XInputDevice::}
\DoxyCodeLine{00462\ do\_set\_vibration(\textcolor{keywordtype}{double}\ strong,\ \textcolor{keywordtype}{double}\ weak)\ \{}
\DoxyCodeLine{00463\ \ \ nassertv\_always(\_is\_connected);}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00465\ \ \ XINPUT\_VIBRATION\ vibration;}
\DoxyCodeLine{00466\ \ \ vibration.wLeftMotorSpeed\ =\ strong\ *\ 0xffff;}
\DoxyCodeLine{00467\ \ \ vibration.wRightMotorSpeed\ =\ weak\ *\ 0xffff;}
\DoxyCodeLine{00468\ \ \ set\_state(\_index,\ \&vibration);}
\DoxyCodeLine{00469\ \}}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00476\ \textcolor{keywordtype}{void}\ XInputDevice::}
\DoxyCodeLine{00477\ do\_poll()\ \{}
\DoxyCodeLine{00478\ \ \ \textcolor{comment}{//\ Not\ sure\ why\ someone\ would\ call\ this\ on\ a\ disconnected\ device.}}
\DoxyCodeLine{00479\ \ \ \textcolor{keywordflow}{if}\ (!\_is\_connected)\ \{}
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00481\ \ \ \}}
\DoxyCodeLine{00482\ }
\DoxyCodeLine{00483\ \ \ XINPUT\_STATE\ state;}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ \textcolor{keywordflow}{if}\ (get\_state(\_index,\ \&state)\ !=\ ERROR\_SUCCESS)\ \{}
\DoxyCodeLine{00486\ \ \ \ \ \textcolor{comment}{//\ Device\ was\ disconnected.}}
\DoxyCodeLine{00487\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_is\_connected)\ \{}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \_is\_connected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \mbox{\hyperlink{classInputDeviceManager}{InputDeviceManager}}\ *mgr\ =\ InputDeviceManager::get\_global\_ptr();}
\DoxyCodeLine{00490\ \ \ \ \ \ \ mgr-\/>\mbox{\hyperlink{classInputDeviceManager_a88b9e72485abcc388e461d4855d460b1}{remove\_device}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00491\ \ \ \ \ \}}
\DoxyCodeLine{00492\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00493\ \ \ \}}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00495\ \ \ \textcolor{keywordflow}{if}\ (state.dwPacketNumber\ ==\ \_last\_packet)\ \{}
\DoxyCodeLine{00496\ \ \ \ \ \textcolor{comment}{//\ No\ change\ since\ last\ time\ we\ asked.}}
\DoxyCodeLine{00497\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00498\ \ \ \}}
\DoxyCodeLine{00499\ }
\DoxyCodeLine{00500\ \ \ \textcolor{comment}{//\ Did\ any\ buttons\ change\ state?}}
\DoxyCodeLine{00501\ \ \ WORD\ changed\_buttons\ =\ \_last\_buttons\ \string^\ state.Gamepad.wButtons;}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ WORD\ mask\ =\ 1;}
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 16;\ ++i)\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keywordflow}{if}\ (changed\_buttons\ \&\ mask)\ \{}
\DoxyCodeLine{00506\ \ \ \ \ \ \ button\_changed(i,\ (state.Gamepad.wButtons\ \&\ mask)\ !=\ 0);}
\DoxyCodeLine{00507\ \ \ \ \ \}}
\DoxyCodeLine{00508\ \ \ \ \ mask\ <<=\ 1;}
\DoxyCodeLine{00509\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ 10)\ \{}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \textcolor{comment}{//\ XInput\ skips\ 0x0800.}}
\DoxyCodeLine{00511\ \ \ \ \ \ \ mask\ <<=\ 1;}
\DoxyCodeLine{00512\ \ \ \ \ \}}
\DoxyCodeLine{00513\ \ \ \}}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ axis\_changed(0,\ state.Gamepad.bLeftTrigger);}
\DoxyCodeLine{00516\ \ \ axis\_changed(1,\ state.Gamepad.bRightTrigger);}
\DoxyCodeLine{00517\ \ \ axis\_changed(2,\ state.Gamepad.sThumbLX);}
\DoxyCodeLine{00518\ \ \ axis\_changed(3,\ state.Gamepad.sThumbLY);}
\DoxyCodeLine{00519\ \ \ axis\_changed(4,\ state.Gamepad.sThumbRX);}
\DoxyCodeLine{00520\ \ \ axis\_changed(5,\ state.Gamepad.sThumbRY);}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ \ \ \_last\_buttons\ =\ state.Gamepad.wButtons;}
\DoxyCodeLine{00523\ \ \ \_last\_packet\ =\ state.dwPacketNumber;}
\DoxyCodeLine{00524\ \}}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ \_WIN32}}

\end{DoxyCode}
