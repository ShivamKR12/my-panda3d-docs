\doxysection{standard\+Munger.\+cxx}
\hypertarget{standardMunger_8cxx_source}{}\label{standardMunger_8cxx_source}\index{panda/src/display/standardMunger.cxx@{panda/src/display/standardMunger.cxx}}
\mbox{\hyperlink{standardMunger_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{standardMunger_8h}{standardMunger.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{displayRegion_8h}{displayRegion.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsStateGuardian_8h}{graphicsStateGuardian.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightAttrib_8h}{lightAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{materialAttrib_8h}{materialAttrib.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ StandardMunger::\_type\_handle;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00031\ \mbox{\hyperlink{classStandardMunger_abe9fb95987ffc1386b991884acb72046}{StandardMunger::}}}
\DoxyCodeLine{00032\ \mbox{\hyperlink{classStandardMunger_abe9fb95987ffc1386b991884acb72046}{StandardMunger}}(\mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state,}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_components,}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StandardMunger::NumericType\ numeric\_type,}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StandardMunger::Contents\ contents)\ :}
\DoxyCodeLine{00036\ \ \ \mbox{\hyperlink{classStateMunger}{StateMunger}}(gsg),}
\DoxyCodeLine{00037\ \ \ \_num\_components(num\_components),}
\DoxyCodeLine{00038\ \ \ \_numeric\_type(numeric\_type),}
\DoxyCodeLine{00039\ \ \ \_contents(contents),}
\DoxyCodeLine{00040\ \ \ \_auto\_shader(false),}
\DoxyCodeLine{00041\ \ \ \_shader\_skinning(false),}
\DoxyCodeLine{00042\ \ \ \_remove\_material(false),}
\DoxyCodeLine{00043\ \ \ \_munge\_color(false),}
\DoxyCodeLine{00044\ \ \ \_munge\_color\_scale(false)}
\DoxyCodeLine{00045\ \{}
\DoxyCodeLine{00046\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classShaderAttrib}{ShaderAttrib}}\ *shader\_attrib;}
\DoxyCodeLine{00047\ \ \ state-\/>get\_attrib\_def(shader\_attrib);}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#ifdef\ HAVE\_CG}}
\DoxyCodeLine{00049\ \ \ \_auto\_shader\ =\ shader\_attrib-\/>auto\_shader();}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordflow}{if}\ (shader\_attrib-\/>get\_flag(ShaderAttrib::F\_hardware\_skinning))\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \_shader\_skinning\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00053\ \ \ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \textcolor{keywordflow}{if}\ (!get\_gsg()-\/>get\_runtime\_color\_scale()\ \&\&\ !\_auto\_shader\ \&\&}
\DoxyCodeLine{00056\ \ \ \ \ \ \ shader\_attrib-\/>get\_shader()\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{comment}{//\ We\ might\ need\ to\ munge\ the\ colors.}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classColorAttrib}{ColorAttrib}}\ *color\_attrib;}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classColorScaleAttrib}{ColorScaleAttrib}}\ *color\_scale\_attrib;}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keywordflow}{if}\ (state-\/>get\_attrib(color\_attrib)\ \&\&}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ color\_attrib-\/>get\_color\_type()\ !=\ ColorAttrib::T\_vertex)\ \{}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \ \ \textcolor{comment}{//\ In\ this\ case,\ we\ don't\ need\ to\ munge\ anything\ as\ we\ can\ apply\ the}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \textcolor{comment}{//\ color\ and\ color\ scale\ via\ glColor4f.}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (state-\/>get\_attrib(color\_scale\_attrib)\ \&\&}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ color\_scale\_attrib-\/>has\_scale())\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \_color\_scale\ =\ color\_scale\_attrib-\/>get\_scale();}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTextureAttrib}{TextureAttrib}}\ *tex\_attrib\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classTextureAttrib}{TextureAttrib}}\ *)}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ state-\/>get\_attrib(TextureAttrib::get\_class\_slot());}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ GSG\ says\ it\ can't\ cheat\ this\ RGB\ or\ alpha\ scale,\ we\ have\ to}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{comment}{//\ apply\ the\ color\ scale\ directly.}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((color\_scale\_attrib-\/>has\_rgb\_scale()\ \&\&\ !get\_gsg()-\/>get\_color\_scale\_via\_lighting())\ ||}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ (color\_scale\_attrib-\/>has\_alpha\_scale()\ \&\&\ !get\_gsg()-\/>get\_alpha\_scale\_via\_texture(tex\_attrib)))\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \_munge\_color\_scale\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \_should\_munge\_state\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \ \ \textcolor{comment}{//\ Known\ bug:\ if\ there\ is\ a\ material\ on\ an\ object\ that\ would\ obscure\ the}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \textcolor{comment}{//\ effect\ of\ color\_scale,\ we\ scale\ the\ lighting\ anyway,\ thus\ applying}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \textcolor{comment}{//\ the\ effect\ even\ if\ it\ should\ be\ obscured.\ \ It\ doesn't\ seem\ worth\ the}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \textcolor{comment}{//\ effort\ to\ detect\ this\ contrived\ situation\ and\ handle\ it\ correctly.}}
\DoxyCodeLine{00086\ \ \ \ \ \}}
\DoxyCodeLine{00087\ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \textcolor{comment}{//\ If\ we\ have\ no\ lights\ but\ do\ have\ a\ material,\ we\ will\ need\ to\ remove\ it\ so}}
\DoxyCodeLine{00090\ \ \ \textcolor{comment}{//\ that\ it\ won't\ appear\ when\ we\ enable\ color\ scale\ via\ lighting.}}
\DoxyCodeLine{00091\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classLightAttrib}{LightAttrib}}\ *light\_attrib;}
\DoxyCodeLine{00092\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classMaterialAttrib}{MaterialAttrib}}\ *material\_attrib;}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{if}\ (get\_gsg()-\/>get\_color\_scale\_via\_lighting()\ \&\&}
\DoxyCodeLine{00094\ \ \ \ \ \ \ (!state-\/>get\_attrib(light\_attrib)\ ||\ !light\_attrib-\/>has\_any\_on\_light())\ \&\&}
\DoxyCodeLine{00095\ \ \ \ \ \ \ state-\/>get\_attrib(material\_attrib)\ \&\&}
\DoxyCodeLine{00096\ \ \ \ \ \ \ material\_attrib-\/>get\_material()\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00097\ \ \ \ \ \ \ shader\_attrib-\/>get\_shader()\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \_remove\_material\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00099\ \ \ \ \ \_should\_munge\_state\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00100\ \ \ \}}
\DoxyCodeLine{00101\ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00106\ StandardMunger::}
\DoxyCodeLine{00107\ \string~StandardMunger()\ \{}
\DoxyCodeLine{00108\ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00113\ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ StandardMunger::}
\DoxyCodeLine{00114\ munge\_data\_impl(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}\ *data)\ \{}
\DoxyCodeLine{00115\ \ \ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ new\_data\ =\ data;}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ new\_data\ =\ new\_data-\/>set\_color(\_color,\ \_num\_components,\ \_numeric\_type,}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_contents);}
\DoxyCodeLine{00120\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00121\ \ \ \ \ new\_data\ =\ new\_data-\/>scale\_color(\_color\_scale,\ \_num\_components,}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_numeric\_type,\ \_contents);}
\DoxyCodeLine{00123\ \ \ \}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \mbox{\hyperlink{classGeomVertexAnimationSpec}{GeomVertexAnimationSpec}}\ animation\ =\ new\_data-\/>get\_format()-\/>get\_animation();}
\DoxyCodeLine{00126\ \ \ \textcolor{keywordflow}{if}\ ((\_shader\_skinning\ \&\&\ animation.get\_animation\_type()\ !=\ AT\_none)\ ||}
\DoxyCodeLine{00127\ \ \ \ \ \ \ (\_auto\_shader\ \&\&\ hardware\_animated\_vertices\ \&\&}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ !basic\_shaders\_only\ \&\&\ animation.get\_animation\_type()\ ==\ AT\_panda))\ \{}
\DoxyCodeLine{00129\ \ \ \ \ animation.set\_hardware(4,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (hardware\_animated\_vertices\ \&\&}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ animation.get\_animation\_type()\ ==\ AT\_panda\ \&\&}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_data-\/>get\_slider\_table()\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{comment}{//\ Maybe\ we\ can\ animate\ the\ vertices\ with\ hardware.}}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classTransformBlendTable}{TransformBlendTable}}\ *table\ =\ new\_data-\/>get\_transform\_blend\_table();}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordflow}{if}\ (table\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ table-\/>get\_num\_transforms()\ !=\ 0\ \&\&}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ table-\/>get\_max\_simultaneous\_transforms()\ <=}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ get\_gsg()-\/>get\_max\_vertex\_transforms())\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (matrix\_palette\ \&\&}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \ \ table-\/>get\_num\_transforms()\ <=\ get\_gsg()-\/>get\_max\_vertex\_transform\_indices())\ \{}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (table-\/>get\_num\_transforms()\ ==\ table-\/>get\_max\_simultaneous\_transforms())\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ support\ an\ indexed\ palette,\ but\ since\ that\ won't\ save\ us}}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ any\ per-\/vertex\ blends,\ go\ ahead\ and\ do\ a\ plain\ old\ nonindexed}}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ table\ instead.}}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ animation.set\_hardware(table-\/>get\_num\_transforms(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can\ support\ an\ indexed\ palette,\ and\ that\ means\ we\ can\ reduce}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ number\ of\ blends\ we\ have\ to\ specify\ for\ each\ vertex.}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ animation.set\_hardware(table-\/>get\_max\_simultaneous\_transforms(),\ \textcolor{keyword}{true});}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (table-\/>get\_num\_transforms()\ <=}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_gsg()-\/>get\_max\_vertex\_transforms())\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ can't\ support\ an\ indexed\ palette,\ but\ we\ have\ few\ enough}}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ transforms\ that\ we\ can\ do\ a\ nonindexed\ table.}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ animation.set\_hardware(table-\/>get\_num\_transforms(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ orig\_format\ =\ new\_data-\/>get\_format();}
\DoxyCodeLine{00165\ \ \ CPT(\mbox{\hyperlink{classGeomVertexFormat}{GeomVertexFormat}})\ new\_format\ =\ munge\_format(orig\_format,\ animation);}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \textcolor{keywordflow}{if}\ (new\_format\ ==\ orig\_format)\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ Trivial\ case.}}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_data;}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \textcolor{keywordflow}{return}\ new\_data-\/>convert\_to(new\_format);}
\DoxyCodeLine{00173\ \}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00178\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classStandardMunger_a62d7cb1069f5943038358631f6c48b88}{StandardMunger::}}}
\DoxyCodeLine{00179\ \mbox{\hyperlink{classStandardMunger_a62d7cb1069f5943038358631f6c48b88}{munge\_geom\_impl}}(CPT(\mbox{\hyperlink{classGeom}{Geom}})\ \&geom,\ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ \&vertex\_data,}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classThread}{Thread}}\ *)\ \{}
\DoxyCodeLine{00181\ \ \ \textcolor{keywordtype}{int}\ supported\_geom\_rendering\ =\ get\_gsg()-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ac3b0236a6eac1287693b34b5bd10b474}{get\_supported\_geom\_rendering}}();}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{keywordtype}{int}\ unsupported\_bits\ =\ geom-\/>get\_geom\_rendering()\ \&\ \string~supported\_geom\_rendering;}
\DoxyCodeLine{00184\ \ \ \textcolor{keywordflow}{if}\ (unsupported\_bits\ !=\ 0)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{comment}{//\ Even\ beyond\ munging\ the\ vertex\ format,\ we\ have\ to\ convert\ the\ Geom}}
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{comment}{//\ itself\ into\ a\ new\ primitive\ type\ the\ GSG\ can\ render\ directly.\ \ If\ we}}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{comment}{//\ don't\ support\ a\ strip\ cut\ index,\ it\ might\ be\ faster\ to\ just\ decompose}}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{comment}{//\ it\ rather\ than\ draw\ them\ one\ by\ one.}}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_composite\_bits)\ !=\ 0\ ||}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ (unsupported\_bits\ \&\ Geom::GR\_strip\_cut\_index)\ !=\ 0)\ \{}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ decomposes\ everything\ in\ the\ primitive,\ so\ that\ if\ (for}}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \textcolor{comment}{//\ instance)\ the\ primitive\ contained\ both\ strips\ and\ fans,\ but\ the\ GSG}}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \textcolor{comment}{//\ didn't\ support\ fans,\ it\ would\ decompose\ the\ strips\ too.\ \ To\ handle}}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \textcolor{comment}{//\ this\ correctly,\ we'd\ need\ a\ separate\ decompose\_fans()\ and}}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \textcolor{comment}{//\ decompose\_strips()\ call;\ but\ for\ now,\ we'll\ just\ say\ it's\ good}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \textcolor{comment}{//\ enough.\ \ In\ practice,\ we\ don't\ have\ any\ GSG's\ that\ can\ support\ strips}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \textcolor{comment}{//\ without\ also\ supporting\ fans.}}
\DoxyCodeLine{00199\ \ \ \ \ \ \ geom\ =\ geom-\/>decompose();}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \ \ \ \ \textcolor{comment}{//\ Decomposing\ might\ produce\ an\ indexed\ Geom,\ so\ re-\/check\ the}}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{comment}{//\ unsupported\ bits.}}
\DoxyCodeLine{00203\ \ \ \ \ \ \ unsupported\_bits\ =\ geom-\/>get\_geom\_rendering()\ \&\ \string~supported\_geom\_rendering;}
\DoxyCodeLine{00204\ \ \ \ \ \}}
\DoxyCodeLine{00205\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_shade\_model\_bits)\ !=\ 0)\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \textcolor{comment}{//\ Rotate\ the\ vertices\ to\ account\ for\ different\ shade-\/model\ expectations}}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \textcolor{comment}{//\ (e.g.\ \ SM\_flat\_last\_vertex\ to\ SM\_flat\_first\_vertex)}}
\DoxyCodeLine{00208\ \ \ \ \ \ \ geom\ =\ geom-\/>rotate();}
\DoxyCodeLine{00209\ \ \ \ \ \}}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_indexed\_bits)\ !=\ 0)\ \{}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \textcolor{comment}{//\ Convert\ indexed\ geometry\ to\ nonindexed\ geometry.}}
\DoxyCodeLine{00212\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ new\_geom\ =\ geom-\/>\mbox{\hyperlink{classGeom_ad68cf1d48a12ff5468ae0f2486e7a4b4}{make\_copy}}();}
\DoxyCodeLine{00213\ \ \ \ \ \ \ new\_geom-\/>\mbox{\hyperlink{classGeom_ae054b8c6ed5519f982d798c85d00c668}{set\_vertex\_data}}(vertex\_data);}
\DoxyCodeLine{00214\ \ \ \ \ \ \ new\_geom-\/>make\_nonindexed(\textcolor{keyword}{false});}
\DoxyCodeLine{00215\ \ \ \ \ \ \ geom\ =\ new\_geom;}
\DoxyCodeLine{00216\ \ \ \ \ \ \ vertex\_data\ =\ new\_geom-\/>get\_vertex\_data();}
\DoxyCodeLine{00217\ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \}}
\DoxyCodeLine{00219\ \}}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00224\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classStandardMunger_afa5be877984533621248d477fd0283ad}{StandardMunger::}}}
\DoxyCodeLine{00225\ \mbox{\hyperlink{classStandardMunger_afa5be877984533621248d477fd0283ad}{premunge\_geom\_impl}}(CPT(\mbox{\hyperlink{classGeom}{Geom}})\ \&geom,\ CPT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ \&vertex\_data)\ \{}
\DoxyCodeLine{00226\ \ \ \textcolor{keywordtype}{int}\ supported\_geom\_rendering\ =\ get\_gsg()-\/>\mbox{\hyperlink{classGraphicsStateGuardian_ac3b0236a6eac1287693b34b5bd10b474}{get\_supported\_geom\_rendering}}();}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00228\ \ \ \textcolor{keywordtype}{int}\ unsupported\_bits\ =\ geom-\/>get\_geom\_rendering()\ \&\ \string~supported\_geom\_rendering;}
\DoxyCodeLine{00229\ \ \ \textcolor{keywordflow}{if}\ (unsupported\_bits\ !=\ 0)\ \{}
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{comment}{//\ Even\ beyond\ munging\ the\ vertex\ format,\ we\ have\ to\ convert\ the\ Geom}}
\DoxyCodeLine{00231\ \ \ \ \ \textcolor{comment}{//\ itself\ into\ a\ new\ primitive\ type\ the\ GSG\ can\ render\ directly.\ \ If\ we}}
\DoxyCodeLine{00232\ \ \ \ \ \textcolor{comment}{//\ don't\ support\ a\ strip\ cut\ index,\ it\ might\ be\ faster\ to\ just\ decompose}}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{comment}{//\ it\ rather\ than\ draw\ them\ one\ by\ one.}}
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_composite\_bits)\ !=\ 0\ ||}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ (unsupported\_bits\ \&\ Geom::GR\_strip\_cut\_index)\ !=\ 0)\ \{}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ decomposes\ everything\ in\ the\ primitive,\ so\ that\ if\ (for}}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \textcolor{comment}{//\ instance)\ the\ primitive\ contained\ both\ strips\ and\ fans,\ but\ the\ GSG}}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \textcolor{comment}{//\ didn't\ support\ fans,\ it\ would\ decompose\ the\ strips\ too.\ \ To\ handle}}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \textcolor{comment}{//\ this\ correctly,\ we'd\ need\ a\ separate\ decompose\_fans()\ and}}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \textcolor{comment}{//\ decompose\_strips()\ call;\ but\ for\ now,\ we'll\ just\ say\ it's\ good}}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \textcolor{comment}{//\ enough.\ \ In\ practice,\ we\ don't\ have\ any\ GSG's\ that\ can\ support\ strips}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \textcolor{comment}{//\ without\ also\ supporting\ fans.}}
\DoxyCodeLine{00244\ \ \ \ \ \ \ geom\ =\ geom-\/>decompose();}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \ \ \ \ \textcolor{comment}{//\ Decomposing\ might\ produce\ an\ indexed\ Geom,\ so\ re-\/check\ the}}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \textcolor{comment}{//\ unsupported\ bits.}}
\DoxyCodeLine{00248\ \ \ \ \ \ \ unsupported\_bits\ =\ geom-\/>get\_geom\_rendering()\ \&\ \string~supported\_geom\_rendering;}
\DoxyCodeLine{00249\ \ \ \ \ \}}
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_shade\_model\_bits)\ !=\ 0)\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \textcolor{comment}{//\ Rotate\ the\ vertices\ to\ account\ for\ different\ shade-\/model\ expectations}}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \textcolor{comment}{//\ (e.g.\ \ SM\_flat\_last\_vertex\ to\ SM\_flat\_first\_vertex)}}
\DoxyCodeLine{00253\ \ \ \ \ \ \ geom\ =\ geom-\/>rotate();}
\DoxyCodeLine{00254\ \ \ \ \ \}}
\DoxyCodeLine{00255\ \ \ \ \ \textcolor{keywordflow}{if}\ ((unsupported\_bits\ \&\ Geom::GR\_indexed\_bits)\ !=\ 0)\ \{}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \textcolor{comment}{//\ Convert\ indexed\ geometry\ to\ nonindexed\ geometry.}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ new\_geom\ =\ geom-\/>\mbox{\hyperlink{classGeom_ad68cf1d48a12ff5468ae0f2486e7a4b4}{make\_copy}}();}
\DoxyCodeLine{00258\ \ \ \ \ \ \ new\_geom-\/>\mbox{\hyperlink{classGeom_ae054b8c6ed5519f982d798c85d00c668}{set\_vertex\_data}}(vertex\_data);}
\DoxyCodeLine{00259\ \ \ \ \ \ \ new\_geom-\/>make\_nonindexed(\textcolor{keyword}{false});}
\DoxyCodeLine{00260\ \ \ \ \ \ \ geom\ =\ new\_geom;}
\DoxyCodeLine{00261\ \ \ \ \ \ \ vertex\_data\ =\ new\_geom-\/>get\_vertex\_data();}
\DoxyCodeLine{00262\ \ \ \ \ \}}
\DoxyCodeLine{00263\ \ \ \}}
\DoxyCodeLine{00264\ \}}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00271\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classStandardMunger_ab576e6a2d439cb2790982c27309a6ac1}{StandardMunger::}}}
\DoxyCodeLine{00272\ \mbox{\hyperlink{classStandardMunger_ab576e6a2d439cb2790982c27309a6ac1}{compare\_to\_impl}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00273\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classStandardMunger}{StandardMunger}}\ *om\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classStandardMunger}{StandardMunger}}\ *)other;}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\ !=\ om-\/>\_munge\_color)\ \{}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_munge\_color\ -\/\ (int)om-\/>\_munge\_color;}
\DoxyCodeLine{00277\ \ \ \}}
\DoxyCodeLine{00278\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale\ !=\ om-\/>\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_munge\_color\_scale\ -\/\ (int)om-\/>\_munge\_color\_scale;}
\DoxyCodeLine{00280\ \ \ \}}
\DoxyCodeLine{00281\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color)\ \{}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordtype}{int}\ compare\ =\ \_color.compare\_to(om-\/>\_color);}
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00285\ \ \ \ \ \}}
\DoxyCodeLine{00286\ \ \ \}}
\DoxyCodeLine{00287\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{keywordtype}{int}\ compare\ =\ \_color\_scale.compare\_to(om-\/>\_color\_scale);}
\DoxyCodeLine{00289\ \ \ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00291\ \ \ \ \ \}}
\DoxyCodeLine{00292\ \ \ \}}
\DoxyCodeLine{00293\ \ \ \textcolor{keywordflow}{if}\ (\_shader\_skinning\ !=\ om-\/>\_shader\_skinning)\ \{}
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_shader\_skinning\ -\/\ (int)om-\/>\_shader\_skinning;}
\DoxyCodeLine{00295\ \ \ \}}
\DoxyCodeLine{00296\ \ \ \textcolor{keywordflow}{if}\ (\_auto\_shader\ !=\ om-\/>\_auto\_shader)\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_auto\_shader\ -\/\ (int)om-\/>\_auto\_shader;}
\DoxyCodeLine{00298\ \ \ \}}
\DoxyCodeLine{00299\ \ \ \textcolor{keywordflow}{if}\ (\_remove\_material\ !=\ om-\/>\_remove\_material)\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_remove\_material\ -\/\ (int)om-\/>\_remove\_material;}
\DoxyCodeLine{00301\ \ \ \}}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00303\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classGeomMunger_a08cc48a352adfc29adf729cdc2bd78e3}{StateMunger::compare\_to\_impl}}(other);}
\DoxyCodeLine{00304\ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00312\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classStandardMunger_a2e3cbc4646d2bacec9ec4f6ca724c50a}{StandardMunger::}}}
\DoxyCodeLine{00313\ \mbox{\hyperlink{classStandardMunger_a2e3cbc4646d2bacec9ec4f6ca724c50a}{geom\_compare\_to\_impl}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classGeomMunger}{GeomMunger}}\ *other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00314\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classStandardMunger}{StandardMunger}}\ *om\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classStandardMunger}{StandardMunger}}\ *)other;}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\ !=\ om-\/>\_munge\_color)\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_munge\_color\ -\/\ (int)om-\/>\_munge\_color;}
\DoxyCodeLine{00318\ \ \ \}}
\DoxyCodeLine{00319\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale\ !=\ om-\/>\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_munge\_color\_scale\ -\/\ (int)om-\/>\_munge\_color\_scale;}
\DoxyCodeLine{00321\ \ \ \}}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color)\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordtype}{int}\ compare\ =\ \_color.compare\_to(om-\/>\_color);}
\DoxyCodeLine{00324\ \ \ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00326\ \ \ \ \ \}}
\DoxyCodeLine{00327\ \ \ \}}
\DoxyCodeLine{00328\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \textcolor{keywordtype}{int}\ compare\ =\ \_color\_scale.compare\_to(om-\/>\_color\_scale);}
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keywordflow}{if}\ (compare\ !=\ 0)\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ compare;}
\DoxyCodeLine{00332\ \ \ \ \ \}}
\DoxyCodeLine{00333\ \ \ \}}
\DoxyCodeLine{00334\ \ \ \textcolor{keywordflow}{if}\ (\_shader\_skinning\ !=\ om-\/>\_shader\_skinning)\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})\_shader\_skinning\ -\/\ (int)om-\/>\_shader\_skinning;}
\DoxyCodeLine{00336\ \ \ \}}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00338\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classGeomMunger_ae18d632da14b4e08f7789fd4d8517310}{StateMunger::geom\_compare\_to\_impl}}(other);}
\DoxyCodeLine{00339\ \}}
\DoxyCodeLine{00340\ }
\DoxyCodeLine{00344\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ StandardMunger::}
\DoxyCodeLine{00345\ munge\_state\_impl(\textcolor{keyword}{const}\ \mbox{\hyperlink{classRenderState}{RenderState}}\ *state)\ \{}
\DoxyCodeLine{00346\ \ \ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ munged\_state\ =\ state;}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \textcolor{keywordflow}{if}\ (\_munge\_color)\ \{}
\DoxyCodeLine{00349\ \ \ \ \ munged\_state\ =\ munged\_state-\/>remove\_attrib(ColorAttrib::get\_class\_slot());}
\DoxyCodeLine{00350\ \ \ \ \ munged\_state\ =\ munged\_state-\/>remove\_attrib(ColorScaleAttrib::get\_class\_slot());}
\DoxyCodeLine{00351\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_munge\_color\_scale)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ munged\_state\ =\ munged\_state-\/>remove\_attrib(ColorScaleAttrib::get\_class\_slot());}
\DoxyCodeLine{00353\ \ \ \}}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00355\ \ \ \textcolor{keywordflow}{if}\ (\_remove\_material)\ \{}
\DoxyCodeLine{00356\ \ \ \ \ munged\_state\ =\ munged\_state-\/>remove\_attrib(MaterialAttrib::get\_class\_slot());}
\DoxyCodeLine{00357\ \ \ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{return}\ munged\_state;}
\DoxyCodeLine{00360\ \}}

\end{DoxyCode}
