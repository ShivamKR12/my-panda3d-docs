\doxysection{light\+Lens\+Node.\+cxx}
\hypertarget{lightLensNode_8cxx_source}{}\label{lightLensNode_8cxx_source}\index{panda/src/pgraphnodes/lightLensNode.cxx@{panda/src/pgraphnodes/lightLensNode.cxx}}
\mbox{\hyperlink{lightLensNode_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightLensNode_8h}{lightLensNode.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{renderState_8h}{renderState.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cullFaceAttrib_8h}{cullFaceAttrib.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{colorWriteAttrib_8h}{colorWriteAttrib.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{lightAttrib_8h}{lightAttrib.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{graphicsStateGuardianBase_8h}{graphicsStateGuardianBase.h}}"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ LightLensNode::\_type\_handle;}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00030\ LightLensNode::}
\DoxyCodeLine{00031\ LightLensNode(\textcolor{keyword}{const}\ std::string\ \&name,\ \mbox{\hyperlink{classLens}{Lens}}\ *lens)\ :}
\DoxyCodeLine{00032\ \ \ \mbox{\hyperlink{classCamera}{Camera}}(name,\ lens),}
\DoxyCodeLine{00033\ \ \ \_has\_specular\_color(false),}
\DoxyCodeLine{00034\ \ \ \_used\_by\_auto\_shader(false),}
\DoxyCodeLine{00035\ \ \ \_attrib\_count(0)}
\DoxyCodeLine{00036\ \{}
\DoxyCodeLine{00037\ \ \ set\_active(\textcolor{keyword}{false});}
\DoxyCodeLine{00038\ \ \ \_shadow\_caster\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00039\ \ \ \_sb\_size.set(512,\ 512);}
\DoxyCodeLine{00040\ \ \ \_sb\_sort\ =\ -\/10;}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \textcolor{comment}{//\ Backface\ culling\ helps\ eliminating\ artifacts.}}
\DoxyCodeLine{00043\ \ \ \textcolor{keyword}{static}\ CPT(\mbox{\hyperlink{classRenderState}{RenderState}})\ default\_initial\_state\ =}
\DoxyCodeLine{00044\ \ \ \ \ RenderState::make(}
\DoxyCodeLine{00045\ \ \ \ \ \ \ CullFaceAttrib::make\_reverse(),}
\DoxyCodeLine{00046\ \ \ \ \ \ \ ColorWriteAttrib::make(ColorWriteAttrib::C\_off)}
\DoxyCodeLine{00047\ \ \ \ \ )-\/>set\_attrib(LightAttrib::make\_all\_off(),\ RenderState::get\_max\_priority());}
\DoxyCodeLine{00048\ \ \ set\_initial\_state(default\_initial\_state);}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ LightLensNode::}
\DoxyCodeLine{00055\ \string~LightLensNode()\ \{}
\DoxyCodeLine{00056\ \ \ set\_active(\textcolor{keyword}{false});}
\DoxyCodeLine{00057\ \ \ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{clear\_shadow\_buffers}}();}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \textcolor{comment}{//\ If\ this\ triggers,\ the\ number\ of\ attrib\_ref()\ didn't\ match\ the\ number\ of}}
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ attrib\_unref()\ calls,\ probably\ indicating\ a\ bug\ in\ LightAttrib.}}
\DoxyCodeLine{00061\ \ \ nassertv(AtomicAdjust::get(\_attrib\_count)\ ==\ 0);}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00067\ LightLensNode::}
\DoxyCodeLine{00068\ LightLensNode(\textcolor{keyword}{const}\ \mbox{\hyperlink{classLightLensNode}{LightLensNode}}\ \&copy)\ :}
\DoxyCodeLine{00069\ \ \ \mbox{\hyperlink{classLight}{Light}}(copy),}
\DoxyCodeLine{00070\ \ \ \mbox{\hyperlink{classCamera}{Camera}}(copy),}
\DoxyCodeLine{00071\ \ \ \_sb\_size(copy.\_sb\_size),}
\DoxyCodeLine{00072\ \ \ \_shadow\_caster(copy.\_shadow\_caster),}
\DoxyCodeLine{00073\ \ \ \_has\_specular\_color(copy.\_has\_specular\_color),}
\DoxyCodeLine{00074\ \ \ \_sb\_sort(-\/10),}
\DoxyCodeLine{00075\ \ \ \_used\_by\_auto\_shader(false),}
\DoxyCodeLine{00076\ \ \ \_attrib\_count(0)}
\DoxyCodeLine{00077\ \{}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_caster)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ setup\_shadow\_map();}
\DoxyCodeLine{00080\ \ \ \}}
\DoxyCodeLine{00081\ \}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00089\ \textcolor{keywordtype}{void}\ LightLensNode::}
\DoxyCodeLine{00090\ set\_shadow\_caster(\textcolor{keywordtype}{bool}\ caster)\ \{}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_caster\ \&\&\ !caster)\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{clear\_shadow\_buffers}}();}
\DoxyCodeLine{00093\ \ \ \}}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_caster\ !=\ caster\ \&\&\ \_used\_by\_auto\_shader)\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ any\ shaders\ using\ this\ light\ are\ regenerated.}}
\DoxyCodeLine{00096\ \ \ \ \ GraphicsStateGuardianBase::mark\_rehash\_generated\_shaders();}
\DoxyCodeLine{00097\ \ \ \}}
\DoxyCodeLine{00098\ \ \ \_shadow\_caster\ =\ caster;}
\DoxyCodeLine{00099\ \ \ set\_active(caster);}
\DoxyCodeLine{00100\ \ \ \textcolor{keywordflow}{if}\ (caster)\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \mbox{\hyperlink{classLightLensNode_ab5116d8539b7076096424b1a418e5aba}{setup\_shadow\_map}}();}
\DoxyCodeLine{00102\ \ \ \}}
\DoxyCodeLine{00103\ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00111\ \textcolor{keywordtype}{void}\ LightLensNode::}
\DoxyCodeLine{00112\ set\_shadow\_caster(\textcolor{keywordtype}{bool}\ caster,\ \textcolor{keywordtype}{int}\ buffer\_xsize,\ \textcolor{keywordtype}{int}\ buffer\_ysize,\ \textcolor{keywordtype}{int}\ buffer\_sort)\ \{}
\DoxyCodeLine{00113\ \ \ \textcolor{keywordflow}{if}\ ((\_shadow\_caster\ \&\&\ !caster)\ ||\ buffer\_xsize\ !=\ \_sb\_size[0]\ ||\ buffer\_ysize\ !=\ \_sb\_size[1])\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{clear\_shadow\_buffers}}();}
\DoxyCodeLine{00115\ \ \ \}}
\DoxyCodeLine{00116\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_caster\ !=\ caster\ \&\&\ \_used\_by\_auto\_shader)\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ any\ shaders\ using\ this\ light\ are\ regenerated.}}
\DoxyCodeLine{00118\ \ \ \ \ GraphicsStateGuardianBase::mark\_rehash\_generated\_shaders();}
\DoxyCodeLine{00119\ \ \ \}}
\DoxyCodeLine{00120\ \ \ \_shadow\_caster\ =\ caster;}
\DoxyCodeLine{00121\ \ \ \_sb\_size.set(buffer\_xsize,\ buffer\_ysize);}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordflow}{if}\ (buffer\_sort\ !=\ \_sb\_sort)\ \{}
\DoxyCodeLine{00124\ \ \ \ \ ShadowBuffers::iterator\ it;}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordflow}{for}(it\ =\ \_sbuffers.begin();\ it\ !=\ \_sbuffers.end();\ ++it)\ \{}
\DoxyCodeLine{00126\ \ \ \ \ \ \ (*it).second-\/>set\_sort(buffer\_sort);}
\DoxyCodeLine{00127\ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \ \ \_sb\_sort\ =\ buffer\_sort;}
\DoxyCodeLine{00129\ \ \ \}}
\DoxyCodeLine{00130\ \ \ set\_active(caster);}
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{if}\ (caster)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \mbox{\hyperlink{classLightLensNode_ab5116d8539b7076096424b1a418e5aba}{setup\_shadow\_map}}();}
\DoxyCodeLine{00133\ \ \ \}}
\DoxyCodeLine{00134\ \}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00140\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{LightLensNode::}}}
\DoxyCodeLine{00141\ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{clear\_shadow\_buffers}}()\ \{}
\DoxyCodeLine{00142\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_map)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{comment}{//\ Clear\ it\ to\ all\ ones,\ so\ that\ any\ shaders\ that\ might\ still\ be\ using}}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ it\ will\ see\ the\ shadows\ being\ disabled.}}
\DoxyCodeLine{00145\ \ \ \ \ \_shadow\_map-\/>clear\_image();}
\DoxyCodeLine{00146\ \ \ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ ShadowBuffers::iterator\ it;}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{for}(it\ =\ \_sbuffers.begin();\ it\ !=\ \_sbuffers.end();\ ++it)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ (*it).first-\/>remove\_window((*it).second);}
\DoxyCodeLine{00151\ \ \ \}}
\DoxyCodeLine{00152\ \ \ \_sbuffers.clear();}
\DoxyCodeLine{00153\ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00158\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_ab5116d8539b7076096424b1a418e5aba}{LightLensNode::}}}
\DoxyCodeLine{00159\ \mbox{\hyperlink{classLightLensNode_ab5116d8539b7076096424b1a418e5aba}{setup\_shadow\_map}}()\ \{}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_map\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \_shadow\_map-\/>get\_x\_size()\ ==\ \_sb\_size[0]\ \&\&}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \_shadow\_map-\/>get\_y\_size()\ ==\ \_sb\_size[1])\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{comment}{//\ Nothing\ to\ do.}}
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00165\ \ \ \}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \textcolor{keywordflow}{if}\ (\_shadow\_map\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \_shadow\_map\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classTexture}{Texture}}(get\_name());}
\DoxyCodeLine{00169\ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \_shadow\_map-\/>setup\_2d\_texture(\_sb\_size[0],\ \_sb\_size[1],\ Texture::T\_unsigned\_byte,\ Texture::F\_depth\_component);}
\DoxyCodeLine{00172\ \ \ \_shadow\_map-\/>set\_clear\_color(LColor(1));}
\DoxyCodeLine{00173\ \ \ \_shadow\_map-\/>set\_wrap\_u(SamplerState::WM\_border\_color);}
\DoxyCodeLine{00174\ \ \ \_shadow\_map-\/>set\_wrap\_v(SamplerState::WM\_border\_color);}
\DoxyCodeLine{00175\ \ \ \_shadow\_map-\/>set\_border\_color(LColor(1));}
\DoxyCodeLine{00176\ \ \ \_shadow\_map-\/>set\_minfilter(SamplerState::FT\_shadow);}
\DoxyCodeLine{00177\ \ \ \_shadow\_map-\/>set\_magfilter(SamplerState::FT\_shadow);}
\DoxyCodeLine{00178\ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00183\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_abb267a251e5b76800287e908d248c682}{LightLensNode::}}}
\DoxyCodeLine{00184\ \mbox{\hyperlink{classLightLensNode_abb267a251e5b76800287e908d248c682}{attrib\_ref}}()\ \{}
\DoxyCodeLine{00185\ \ \ AtomicAdjust::inc(\_attrib\_count);}
\DoxyCodeLine{00186\ \}}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00191\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_a5ec29e85f957e6e63923925727e9086c}{LightLensNode::}}}
\DoxyCodeLine{00192\ \mbox{\hyperlink{classLightLensNode_a5ec29e85f957e6e63923925727e9086c}{attrib\_unref}}()\ \{}
\DoxyCodeLine{00193\ \ \ \textcolor{comment}{//\ When\ it\ is\ removed\ from\ the\ last\ LightAttrib,\ destroy\ the\ shadow\ buffers.}}
\DoxyCodeLine{00194\ \ \ \textcolor{comment}{//\ This\ is\ necessary\ to\ break\ the\ circular\ reference\ that\ the\ buffer\ holds}}
\DoxyCodeLine{00195\ \ \ \textcolor{comment}{//\ on\ this\ node,\ via\ the\ display\ region's\ camera.}}
\DoxyCodeLine{00196\ \ \ \textcolor{keywordflow}{if}\ (!AtomicAdjust::dec(\_attrib\_count))\ \{}
\DoxyCodeLine{00197\ \ \ \ \ \mbox{\hyperlink{classLightLensNode_a7fb9528fd86b605b279ecfd84bbf2712}{clear\_shadow\_buffers}}();}
\DoxyCodeLine{00198\ \ \ \}}
\DoxyCodeLine{00199\ \}}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00204\ \mbox{\hyperlink{classPandaNode}{PandaNode}}\ *\mbox{\hyperlink{classLightLensNode_a72d73590d494451fa6c4fb15bfad4336}{LightLensNode::}}}
\DoxyCodeLine{00205\ \mbox{\hyperlink{classLightLensNode_a72d73590d494451fa6c4fb15bfad4336}{as\_node}}()\ \{}
\DoxyCodeLine{00206\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00207\ \}}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00213\ \mbox{\hyperlink{classLight}{Light}}\ *\mbox{\hyperlink{classLightLensNode_ab25eee52a9959723f57325666df5d768}{LightLensNode::}}}
\DoxyCodeLine{00214\ \mbox{\hyperlink{classLightLensNode_ab25eee52a9959723f57325666df5d768}{as\_light}}()\ \{}
\DoxyCodeLine{00215\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{this};}
\DoxyCodeLine{00216\ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00221\ \textcolor{keywordtype}{void}\ LightLensNode::}
\DoxyCodeLine{00222\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00223\ \ \ LensNode::output(out);}
\DoxyCodeLine{00224\ \}}
\DoxyCodeLine{00225\ }
\DoxyCodeLine{00229\ \textcolor{keywordtype}{void}\ LightLensNode::}
\DoxyCodeLine{00230\ write(std::ostream\ \&out,\ \textcolor{keywordtype}{int}\ indent\_level)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00231\ \ \ LensNode::write(out,\ indent\_level);}
\DoxyCodeLine{00232\ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00238\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_a9375ae74db7e0c61849489cf122c47ca}{LightLensNode::}}}
\DoxyCodeLine{00239\ \mbox{\hyperlink{classLightLensNode_a9375ae74db7e0c61849489cf122c47ca}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00240\ \ \ \mbox{\hyperlink{classCamera_a8cf886cc65f32cb09a80e4aa693e8b69}{Camera::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00241\ \ \ \mbox{\hyperlink{classLight_a3f0a4539ddc437f9a4aa758332ab8d8a}{Light::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \ \ dg.add\_bool(\_shadow\_caster);}
\DoxyCodeLine{00244\ \ \ dg.add\_int32(\_sb\_size[0]);}
\DoxyCodeLine{00245\ \ \ dg.add\_int32(\_sb\_size[1]);}
\DoxyCodeLine{00246\ \ \ dg.add\_int32(\_sb\_sort);}
\DoxyCodeLine{00247\ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00253\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLightLensNode_a0b67a0d0ecbd9770b7794a05d393b4ca}{LightLensNode::}}}
\DoxyCodeLine{00254\ \mbox{\hyperlink{classLightLensNode_a0b67a0d0ecbd9770b7794a05d393b4ca}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00255\ \ \ \mbox{\hyperlink{classCamera_a9dcd535d0c5a167e099646a477e253b4}{Camera::fillin}}(scan,\ manager);}
\DoxyCodeLine{00256\ \ \ \mbox{\hyperlink{classLight_ad59407a4013a87a130f2e52d8ed93997}{Light::fillin}}(scan,\ manager);}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00258\ \ \ \textcolor{keywordtype}{bool}\ shadow\_caster\ =\ scan.get\_bool();}
\DoxyCodeLine{00259\ \ \ \textcolor{keywordtype}{int}\ sb\_xsize\ =\ scan.get\_int32();}
\DoxyCodeLine{00260\ \ \ \textcolor{keywordtype}{int}\ sb\_ysize\ =\ scan.get\_int32();}
\DoxyCodeLine{00261\ \ \ \textcolor{keywordtype}{int}\ sb\_sort\ =\ scan.get\_int32();}
\DoxyCodeLine{00262\ \ \ set\_shadow\_caster(shadow\_caster,\ sb\_xsize,\ sb\_ysize,\ sb\_sort);}
\DoxyCodeLine{00263\ \}}

\end{DoxyCode}
