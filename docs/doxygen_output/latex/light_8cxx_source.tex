\doxysection{light.\+cxx}
\hypertarget{light_8cxx_source}{}\label{light_8cxx_source}\index{panda/src/pgraph/light.cxx@{panda/src/pgraph/light.cxx}}
\mbox{\hyperlink{light_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{light_8h}{light.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \mbox{\hyperlink{classUpdateSeq}{UpdateSeq}}\ Light::\_sort\_seq;}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ Light::\_type\_handle;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00028\ \mbox{\hyperlink{classCycleData}{CycleData}}\ *Light::CData::}
\DoxyCodeLine{00029\ make\_copy()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00030\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ CData(*\textcolor{keyword}{this});}
\DoxyCodeLine{00031\ \}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00037\ \textcolor{keywordtype}{void}\ Light::CData::}
\DoxyCodeLine{00038\ write\_datagram(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00039\ \ \ \_color.write\_datagram(dg);}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00046\ \textcolor{keywordtype}{void}\ Light::CData::}
\DoxyCodeLine{00047\ fillin(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *)\ \{}
\DoxyCodeLine{00048\ \ \ \_color.read\_datagram(scan);}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ Light::}
\DoxyCodeLine{00055\ \string~Light()\ \{}
\DoxyCodeLine{00056\ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00062\ \textcolor{keywordtype}{bool}\ Light::}
\DoxyCodeLine{00063\ is\_ambient\_light()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00065\ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00076\ \textcolor{keywordtype}{void}\ Light::}
\DoxyCodeLine{00077\ set\_color\_temperature(PN\_stdfloat\ temperature)\ \{}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{if}\ (\_has\_color\_temperature\ \&\&\ \_color\_temperature\ ==\ temperature)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00080\ \ \ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \_has\_color\_temperature\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00083\ \ \ \_color\_temperature\ =\ temperature;}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \textcolor{comment}{//\ Recalculate\ the\ color.}}
\DoxyCodeLine{00086\ \ \ PN\_stdfloat\ x,\ y;}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{if}\ (temperature\ ==\ 6500)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ sRGB\ D65\ white\ point.}}
\DoxyCodeLine{00090\ \ \ \ \ x\ =\ 0.31271;}
\DoxyCodeLine{00091\ \ \ \ \ y\ =\ 0.32902;}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00094\ \ \ \ \ PN\_stdfloat\ mm\ =\ 1000.0\ /\ temperature;}
\DoxyCodeLine{00095\ \ \ \ \ PN\_stdfloat\ mm2\ =\ mm\ *\ mm;}
\DoxyCodeLine{00096\ \ \ \ \ PN\_stdfloat\ mm3\ =\ mm2\ *\ mm;}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keywordflow}{if}\ (temperature\ <\ 4000)\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ x\ =\ -\/0.2661239\ *\ mm3\ -\/\ 0.2343580\ *\ mm2\ +\ 0.8776956\ *\ mm\ +\ 0.179910;}
\DoxyCodeLine{00100\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \ \ x\ =\ -\/3.0258469\ *\ mm3\ +\ 2.1070379\ *\ mm2\ +\ 0.2226347\ *\ mm\ +\ 0.240390;}
\DoxyCodeLine{00102\ \ \ \ \ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ PN\_stdfloat\ x2\ =\ x\ *\ x;}
\DoxyCodeLine{00105\ \ \ \ \ PN\_stdfloat\ x3\ =\ x2\ *\ x;}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordflow}{if}\ (temperature\ <\ 2222)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ y\ =\ -\/1.1063814\ *\ x3\ -\/\ 1.34811020\ *\ x2\ +\ 2.18555832\ *\ x\ -\/\ 0.20219683;}
\DoxyCodeLine{00108\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (temperature\ <\ 4000)\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ y\ =\ -\/0.9549476\ *\ x3\ -\/\ 1.37418593\ *\ x2\ +\ 2.09137015\ *\ x\ -\/\ 0.16748867;}
\DoxyCodeLine{00110\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \ \ y\ =\ \ 3.0817580\ *\ x3\ -\/\ 5.87338670\ *\ x2\ +\ 3.75112997\ *\ x\ -\/\ 0.37001483;}
\DoxyCodeLine{00112\ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \textcolor{comment}{//\ xyY\ to\ XYZ,\ assuming\ Y=1.}}
\DoxyCodeLine{00116\ \ \ LVecBase3\ xyz(x\ /\ y,\ 1,\ (1\ -\/\ x\ -\/\ y)\ /\ y);}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \textcolor{comment}{//\ Convert\ XYZ\ to\ linearized\ sRGB.}}
\DoxyCodeLine{00119\ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{static}\ LMatrix3\ xyz\_to\_rgb(}
\DoxyCodeLine{00120\ \ \ \ \ 3.2406255,\ -\/0.9689307,\ 0.0557101,}
\DoxyCodeLine{00121\ \ \ \ \ -\/1.537208,\ 1.8757561,\ -\/0.2040211,}
\DoxyCodeLine{00122\ \ \ \ \ -\/0.4986286,\ 0.0415175,\ 1.0569959);}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ LColor\ \mbox{\hyperlink{structcolor}{color}}(xyz\_to\_rgb.xform(xyz),\ 1);}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ CDWriter\ cdata(\_cycler);}
\DoxyCodeLine{00127\ \ \ cdata-\/>\_color\ =\ \mbox{\hyperlink{structcolor}{color}};}
\DoxyCodeLine{00128\ \ \ cdata-\/>\_viz\_geom\_stale\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00136\ PN\_stdfloat\ Light::}
\DoxyCodeLine{00137\ get\_exponent()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00138\ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00145\ \textcolor{keyword}{const}\ LColor\ \&Light::}
\DoxyCodeLine{00146\ get\_specular\_color()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00147\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ LColor\ white(1,\ 1,\ 1,\ 1);}
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{return}\ white;}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00156\ \textcolor{keyword}{const}\ LVecBase3\ \&Light::}
\DoxyCodeLine{00157\ get\_attenuation()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00158\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ LVecBase3\ no\_atten(1,\ 0,\ 0);}
\DoxyCodeLine{00159\ \ \ \textcolor{keywordflow}{return}\ no\_atten;}
\DoxyCodeLine{00160\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00165\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLight_a6a3d2cf9f7cf89c89e51b1adf814ec82}{Light::}}}
\DoxyCodeLine{00166\ \mbox{\hyperlink{classLight_a6a3d2cf9f7cf89c89e51b1adf814ec82}{attrib\_ref}}()\ \{}
\DoxyCodeLine{00167\ \}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00172\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLight_ae010fdd974ea227f0aecf223d57ed4d3}{Light::}}}
\DoxyCodeLine{00173\ \mbox{\hyperlink{classLight_ae010fdd974ea227f0aecf223d57ed4d3}{attrib\_unref}}()\ \{}
\DoxyCodeLine{00174\ \}}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00188\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classLight_a034816e0c15ca32edb162df8677f3ff6}{Light::}}}
\DoxyCodeLine{00189\ \mbox{\hyperlink{classLight_a034816e0c15ca32edb162df8677f3ff6}{get\_vector\_to\_light}}(LVector3\ \&,\ \textcolor{keyword}{const}\ LPoint3\ \&,\ \textcolor{keyword}{const}\ LMatrix4\ \&)\ \{}
\DoxyCodeLine{00190\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00191\ \}}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00198\ \mbox{\hyperlink{classGeomNode}{GeomNode}}\ *\mbox{\hyperlink{classLight_af5c9d509ddafffaae5cfea3f3d1966c7}{Light::}}}
\DoxyCodeLine{00199\ \mbox{\hyperlink{classLight_af5c9d509ddafffaae5cfea3f3d1966c7}{get\_viz}}()\ \{}
\DoxyCodeLine{00200\ \ \ \mbox{\hyperlink{classCycleDataLockedReader}{CDLockedReader}}\ cdata(\_cycler);}
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{if}\ (cdata-\/>\_viz\_geom\_stale)\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{classCycleDataWriter}{CDWriter}}\ cdata\_w(\_cycler,\ cdata);}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00204\ \ \ \ \ cdata\_w-\/>\_viz\_geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomNode}{GeomNode}}(\textcolor{stringliteral}{"{}viz"{}});}
\DoxyCodeLine{00205\ \ \ \ \ \mbox{\hyperlink{classLight_a2fc89dca4c5b21a8b52deae02cf29e90}{fill\_viz\_geom}}(cdata\_w-\/>\_viz\_geom);}
\DoxyCodeLine{00206\ \ \ \ \ cdata\_w-\/>\_viz\_geom\_stale\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00207\ \ \ \}}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordflow}{return}\ cdata-\/>\_viz\_geom;}
\DoxyCodeLine{00209\ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00215\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLight_a2fc89dca4c5b21a8b52deae02cf29e90}{Light::}}}
\DoxyCodeLine{00216\ \mbox{\hyperlink{classLight_a2fc89dca4c5b21a8b52deae02cf29e90}{fill\_viz\_geom}}(\mbox{\hyperlink{classGeomNode}{GeomNode}}\ *)\ \{}
\DoxyCodeLine{00217\ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00223\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLight_a3f0a4539ddc437f9a4aa758332ab8d8a}{Light::}}}
\DoxyCodeLine{00224\ \mbox{\hyperlink{classLight_a3f0a4539ddc437f9a4aa758332ab8d8a}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 39)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ dg.add\_bool(\_has\_color\_temperature);}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_has\_color\_temperature)\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \ \ dg.add\_stdfloat(\_color\_temperature);}
\DoxyCodeLine{00229\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00230\ \ \ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{00231\ \ \ \ \ \}}
\DoxyCodeLine{00232\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00233\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamWriter_a4a957fdbd6f508ee3029a41a794030cd}{write\_cdata}}(dg,\ \_cycler);}
\DoxyCodeLine{00234\ \ \ \}}
\DoxyCodeLine{00235\ \ \ dg.add\_int32(\_priority);}
\DoxyCodeLine{00236\ \}}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00242\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classLight_ad59407a4013a87a130f2e52d8ed93997}{Light::}}}
\DoxyCodeLine{00243\ \mbox{\hyperlink{classLight_ad59407a4013a87a130f2e52d8ed93997}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00244\ \ \ \textcolor{keywordflow}{if}\ (manager-\/>get\_file\_minor\_ver()\ >=\ 39)\ \{}
\DoxyCodeLine{00245\ \ \ \ \ \_has\_color\_temperature\ =\ scan.get\_bool();}
\DoxyCodeLine{00246\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \_has\_color\_temperature\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00248\ \ \ \}}
\DoxyCodeLine{00249\ \ \ \textcolor{keywordflow}{if}\ (\_has\_color\_temperature)\ \{}
\DoxyCodeLine{00250\ \ \ \ \ set\_color\_temperature(scan.get\_stdfloat());}
\DoxyCodeLine{00251\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00252\ \ \ \ \ manager-\/>\mbox{\hyperlink{classBamReader_ae63d90cd5d2c87fe3159f6b5d6d9fe10}{read\_cdata}}(scan,\ \_cycler);}
\DoxyCodeLine{00253\ \ \ \}}
\DoxyCodeLine{00254\ \ \ \_priority\ =\ scan.get\_int32();}
\DoxyCodeLine{00255\ \}}

\end{DoxyCode}
