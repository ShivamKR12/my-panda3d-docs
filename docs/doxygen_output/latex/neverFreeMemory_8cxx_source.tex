\doxysection{never\+Free\+Memory.\+cxx}
\hypertarget{neverFreeMemory_8cxx_source}{}\label{neverFreeMemory_8cxx_source}\index{dtool/src/dtoolbase/neverFreeMemory.cxx@{dtool/src/dtoolbase/neverFreeMemory.cxx}}
\mbox{\hyperlink{neverFreeMemory_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{neverFreeMemory_8h}{neverFreeMemory.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{atomicAdjust_8h}{atomicAdjust.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{memoryHook_8h}{memoryHook.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \mbox{\hyperlink{classNeverFreeMemory}{NeverFreeMemory}}\ *\ TVOLATILE\ NeverFreeMemory::\_global\_ptr;}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{comment}{//\ If\ a\ page\ has\ fewer\ than\ this\ many\ bytes\ remaining,\ never\ mind\ about\ it.}}
\DoxyCodeLine{00021\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ min\_page\_remaining\_size\ =\ 16;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{comment}{//\ We\ always\ allocate\ at\ least\ this\ many\ bytes\ at\ a\ time.}}
\DoxyCodeLine{00024\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ min\_page\_size\ =\ 128\ *\ 1024;\ \ \textcolor{comment}{//\ 128K}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00029\ NeverFreeMemory::}
\DoxyCodeLine{00030\ NeverFreeMemory()\ \{}
\DoxyCodeLine{00031\ \ \ \_total\_alloc\ =\ 0;}
\DoxyCodeLine{00032\ \ \ \_total\_used\ =\ 0;}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00038\ \textcolor{keywordtype}{void}\ *NeverFreeMemory::}
\DoxyCodeLine{00039\ ns\_alloc(\textcolor{keywordtype}{size\_t}\ size)\ \{}
\DoxyCodeLine{00040\ \ \ \_lock.lock();}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \textcolor{comment}{//NB:\ we\ no\ longer\ do\ alignment\ here.\ \ The\ only\ class\ that\ uses\ this\ is}}
\DoxyCodeLine{00043\ \ \ \textcolor{comment}{//\ DeletedBufferChain,\ and\ we\ can\ do\ the\ alignment\ potentially\ more}}
\DoxyCodeLine{00044\ \ \ \textcolor{comment}{//\ efficiently\ there\ since\ we\ don't\ end\ up\ overallocating\ as\ much.}}
\DoxyCodeLine{00045\ \ \ \_total\_used\ +=\ size;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \textcolor{comment}{//\ Look\ for\ a\ page\ that\ has\ sufficient\ space\ remaining.}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ Pages::iterator\ pi\ =\ \_pages.lower\_bound(Page(\textcolor{keyword}{nullptr},\ size));}
\DoxyCodeLine{00050\ \ \ \textcolor{keywordflow}{if}\ (pi\ !=\ \_pages.end())\ \{}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{comment}{//\ Here's\ a\ page\ with\ enough\ remaining\ space.}}
\DoxyCodeLine{00052\ \ \ \ \ Page\ page\ =\ (*pi);}
\DoxyCodeLine{00053\ \ \ \ \ \_pages.erase(pi);}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordtype}{void}\ *result\ =\ page.alloc(size);}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordflow}{if}\ (page.\_remaining\ >=\ min\_page\_remaining\_size)\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \_pages.insert(page);}
\DoxyCodeLine{00057\ \ \ \ \ \}}
\DoxyCodeLine{00058\ \ \ \ \ \_lock.unlock();}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00060\ \ \ \}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \textcolor{comment}{//\ We\ have\ to\ allocate\ a\ new\ page.\ \ Allocate\ at\ least\ min\_page\_size\ bytes,}}
\DoxyCodeLine{00063\ \ \ \textcolor{comment}{//\ and\ then\ round\ that\ up\ to\ the\ next\ \_page\_size\ bytes.}}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordtype}{size\_t}\ needed\_size\ =\ std::max(size,\ min\_page\_size);}
\DoxyCodeLine{00065\ \ \ needed\_size\ =\ memory\_hook-\/>round\_up\_to\_page\_size(needed\_size);}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordtype}{void}\ *start\ =\ memory\_hook-\/>\mbox{\hyperlink{classMemoryHook_a1bf6209c089890e81f127b4f1f429cb8}{mmap\_alloc}}(needed\_size,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00067\ \ \ \_total\_alloc\ +=\ needed\_size;}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ Page\ page(start,\ needed\_size);}
\DoxyCodeLine{00070\ \ \ \textcolor{keywordtype}{void}\ *result\ =\ page.alloc(size);}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{if}\ (page.\_remaining\ >=\ min\_page\_remaining\_size)\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \_pages.insert(page);}
\DoxyCodeLine{00073\ \ \ \}}
\DoxyCodeLine{00074\ \ \ \_lock.unlock();}
\DoxyCodeLine{00075\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00076\ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00081\ \textcolor{keywordtype}{void}\ NeverFreeMemory::}
\DoxyCodeLine{00082\ make\_global\_ptr()\ \{}
\DoxyCodeLine{00083\ \ \ \mbox{\hyperlink{classNeverFreeMemory}{NeverFreeMemory}}\ *ptr\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classNeverFreeMemory}{NeverFreeMemory}};}
\DoxyCodeLine{00084\ \ \ \textcolor{keywordtype}{void}\ *result\ =\ AtomicAdjust::compare\_and\_exchange\_ptr}
\DoxyCodeLine{00085\ \ \ \ \ ((\textcolor{keywordtype}{void}\ *\ TVOLATILE\ \&)\_global\_ptr,\ \textcolor{keyword}{nullptr},\ (\textcolor{keywordtype}{void}\ *)ptr);}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{//\ Someone\ else\ got\ there\ first.}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keyword}{delete}\ ptr;}
\DoxyCodeLine{00089\ \ \ \}}
\DoxyCodeLine{00090\ \}}

\end{DoxyCode}
