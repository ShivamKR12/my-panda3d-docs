\doxysection{p\+Stat\+Thread\+Data.\+cxx}
\hypertarget{pStatThreadData_8cxx_source}{}\label{pStatThreadData_8cxx_source}\index{pandatool/src/pstatserver/pStatThreadData.cxx@{pandatool/src/pstatserver/pStatThreadData.cxx}}
\mbox{\hyperlink{pStatThreadData_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatThreadData_8h}{pStatThreadData.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatFrameData_8h}{pStatFrameData.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatCollectorDef_8h}{pStatCollectorDef.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pstatclient_8h}{config\_pstatclient.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ PStatThreadData::\_null\_frame;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00026\ PStatThreadData::}
\DoxyCodeLine{00027\ PStatThreadData(\textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatClientData}{PStatClientData}}\ *client\_data)\ :}
\DoxyCodeLine{00028\ \ \ \_client\_data(client\_data)}
\DoxyCodeLine{00029\ \{}
\DoxyCodeLine{00030\ \ \ \_first\_frame\_number\ =\ 0;}
\DoxyCodeLine{00031\ \ \ \_history\ =\ pstats\_history;}
\DoxyCodeLine{00032\ \ \ \_computed\_elapsed\_frames\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00038\ PStatThreadData::}
\DoxyCodeLine{00039\ \string~PStatThreadData()\ \{}
\DoxyCodeLine{00040\ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00045\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatThreadData_a69bcce3d1e7df55590225f42c70d815c}{PStatThreadData::}}}
\DoxyCodeLine{00046\ \mbox{\hyperlink{classPStatThreadData_a69bcce3d1e7df55590225f42c70d815c}{get\_latest\_frame\_number}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00047\ \ \ nassertr(!\_frames.empty(),\ 0);}
\DoxyCodeLine{00048\ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ +\ \_frames.size()\ -\/\ 1;}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatThreadData_a89dad002af95b70bc102133dba62210c}{PStatThreadData::}}}
\DoxyCodeLine{00055\ \mbox{\hyperlink{classPStatThreadData_a89dad002af95b70bc102133dba62210c}{get\_oldest\_frame\_number}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00056\ \ \ nassertr(!\_frames.empty(),\ 0);}
\DoxyCodeLine{00057\ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number;}
\DoxyCodeLine{00058\ \}}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00064\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPStatThreadData_a4a22d1791dc1b5a468ba25810709e2bc}{PStatThreadData::}}}
\DoxyCodeLine{00065\ \mbox{\hyperlink{classPStatThreadData_a4a22d1791dc1b5a468ba25810709e2bc}{has\_frame}}(\textcolor{keywordtype}{int}\ frame\_number)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordtype}{int}\ rel\_frame\ =\ frame\_number\ -\/\ \_first\_frame\_number;}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{keywordflow}{return}\ (rel\_frame\ >=\ 0\ \&\&\ rel\_frame\ <\ (\textcolor{keywordtype}{int})\_frames.size()\ \&\&}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \_frames[rel\_frame]\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00070\ \}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00077\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ \&\mbox{\hyperlink{classPStatThreadData_a5530a369c1f4400afdbbb2659cdd99f2}{PStatThreadData::}}}
\DoxyCodeLine{00078\ \mbox{\hyperlink{classPStatThreadData_a5530a369c1f4400afdbbb2659cdd99f2}{get\_frame}}(\textcolor{keywordtype}{int}\ frame\_number)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordtype}{int}\ rel\_frame\ =\ frame\_number\ -\/\ \_first\_frame\_number;}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ \_frames.size();}
\DoxyCodeLine{00081\ \ \ \textcolor{keywordflow}{if}\ (rel\_frame\ >=\ num\_frames)\ \{}
\DoxyCodeLine{00082\ \ \ \ \ rel\_frame\ =\ num\_frames\ -\/\ 1;}
\DoxyCodeLine{00083\ \ \ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \textcolor{keywordflow}{while}\ (rel\_frame\ >=\ 0\ \&\&\ \_frames[rel\_frame]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00086\ \ \ \ \ rel\_frame-\/-\/;}
\DoxyCodeLine{00087\ \ \ \}}
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{if}\ (rel\_frame\ <\ 0)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ No\ frame\ data\ that\ old.\ \ Return\ the\ oldest\ frame\ we've\ got.}}
\DoxyCodeLine{00090\ \ \ \ \ rel\_frame\ =\ 0;}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordflow}{while}\ (rel\_frame\ <\ num\_frames\ \&\&}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \_frames[rel\_frame]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \ \ rel\_frame++;}
\DoxyCodeLine{00094\ \ \ \ \ \}}
\DoxyCodeLine{00095\ \ \ \}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{if}\ (rel\_frame\ >=\ 0\ \&\&\ rel\_frame\ <\ num\_frames)\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\ =\ \_frames[rel\_frame];}
\DoxyCodeLine{00099\ \ \ \ \ nassertr(frame\ !=\ \textcolor{keyword}{nullptr},\ \_null\_frame);}
\DoxyCodeLine{00100\ \ \ \ \ nassertr(frame-\/>get\_start()\ >=\ 0.0,\ \_null\_frame);}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordflow}{return}\ *frame;}
\DoxyCodeLine{00102\ \ \ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ nassertr(\_null\_frame.get\_start()\ >=\ 0.0,\ \_null\_frame);}
\DoxyCodeLine{00105\ \ \ \textcolor{keywordflow}{return}\ \_null\_frame;}
\DoxyCodeLine{00106\ \}}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00112\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classPStatThreadData_a9dd41835add72398add7542b6f7bfef4}{PStatThreadData::}}}
\DoxyCodeLine{00113\ \mbox{\hyperlink{classPStatThreadData_a9dd41835add72398add7542b6f7bfef4}{get\_latest\_time}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00114\ \ \ nassertr(!\_frames.empty(),\ 0.0);}
\DoxyCodeLine{00115\ \ \ \textcolor{keywordflow}{return}\ \_frames.back()-\/>get\_start();}
\DoxyCodeLine{00116\ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00122\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classPStatThreadData_af37182bf2f0e24c160e6c0ddb9cd3e74}{PStatThreadData::}}}
\DoxyCodeLine{00123\ \mbox{\hyperlink{classPStatThreadData_af37182bf2f0e24c160e6c0ddb9cd3e74}{get\_oldest\_time}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00124\ \ \ nassertr(!\_frames.empty(),\ 0.0);}
\DoxyCodeLine{00125\ \ \ \textcolor{keywordflow}{return}\ \_frames.front()-\/>get\_start();}
\DoxyCodeLine{00126\ \}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00132\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ \&\mbox{\hyperlink{classPStatThreadData_a3c32ff6a08fcef34b5dfd722a9b2c352}{PStatThreadData::}}}
\DoxyCodeLine{00133\ \mbox{\hyperlink{classPStatThreadData_a3c32ff6a08fcef34b5dfd722a9b2c352}{get\_frame\_at\_time}}(\textcolor{keywordtype}{double}\ time)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00134\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classPStatThreadData_a5530a369c1f4400afdbbb2659cdd99f2}{get\_frame}}(\mbox{\hyperlink{classPStatThreadData_a149189c2de6805b486c1e0381fde3e1a}{get\_frame\_number\_at\_time}}(time));}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00145\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatThreadData_a149189c2de6805b486c1e0381fde3e1a}{PStatThreadData::}}}
\DoxyCodeLine{00146\ \mbox{\hyperlink{classPStatThreadData_a149189c2de6805b486c1e0381fde3e1a}{get\_frame\_number\_at\_time}}(\textcolor{keywordtype}{double}\ time,\ \textcolor{keywordtype}{int}\ hint)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00147\ \ \ hint\ -\/=\ \_first\_frame\_number;}
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{if}\ (hint\ >=\ 0\ \&\&\ hint\ <\ (\textcolor{keywordtype}{int})\_frames.size())\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_frames[hint]\ !=\ \textcolor{keyword}{nullptr}\ \&\&}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \_frames[hint]-\/>get\_start()\ <=\ time)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ hint\ might\ be\ right.\ \ Scan\ forward\ from\ there.}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i\ =\ hint\ +\ 1;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (i\ <\ (\textcolor{keywordtype}{int})\_frames.size()\ \&\&}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ (\_frames[i]\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_frames[i]-\/>get\_start()\ <=\ time))\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_frames[i]\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ hint\ =\ i;}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ ++i;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ +\ hint;}
\DoxyCodeLine{00162\ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \textcolor{comment}{//\ The\ hint\ is\ wrong,\ we\ have\ to\ search\ the\ entire\ set.}}
\DoxyCodeLine{00166\ \ \ \textcolor{keywordtype}{int}\ first\_i\ =\ 0;}
\DoxyCodeLine{00167\ \ \ \textcolor{keywordtype}{int}\ last\_i\ =\ \_frames.size()\ -\/\ 1;}
\DoxyCodeLine{00168\ \ \ \textcolor{keywordflow}{while}\ (first\_i\ <\ last\_i\ \&\&\ \_frames[first\_i]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00169\ \ \ \ \ ++first\_i;}
\DoxyCodeLine{00170\ \ \ \}}
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{while}\ (first\_i\ <\ last\_i\ \&\&\ \_frames[last\_i]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00172\ \ \ \ \ -\/-\/last\_i;}
\DoxyCodeLine{00173\ \ \ \}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \textcolor{keywordflow}{if}\ (first\_i\ >=\ last\_i)\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{comment}{//\ There\ are\ no\ frames.}}
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ -\/\ 1;}
\DoxyCodeLine{00178\ \ \ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \textcolor{comment}{//\ Take\ a\ guess\ by\ interpolating\ based\ on\ the\ first\ and\ last\ frame\ times.}}
\DoxyCodeLine{00181\ \ \ \textcolor{keywordtype}{double}\ first\ =\ \_frames[first\_i]-\/>get\_start();}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{if}\ (time\ <\ first)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ -\/\ 1;}
\DoxyCodeLine{00184\ \ \ \}}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \textcolor{keywordtype}{double}\ last\ =\ \_frames[last\_i]-\/>get\_start();}
\DoxyCodeLine{00187\ \ \ \textcolor{keywordtype}{double}\ t\ =\ (time\ -\/\ first)\ /\ (last\ -\/\ first);}
\DoxyCodeLine{00188\ \ \ hint\ =\ std::max(0,\ (\textcolor{keywordtype}{int})(t\ *\ (last\_i\ -\/\ first\_i)))\ +\ first\_i;}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ Find\ a\ frame\ around\ the\ guess\ that\ has\ data.}}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{if}\ (\_frames[hint]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{keywordflow}{if}\ (hint\ <=\ first\_i)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \ \ hint\ =\ first\_i;}
\DoxyCodeLine{00194\ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \textcolor{comment}{//\ Skip\ backward\ until\ we\ find\ a\ frame\ with\ data.}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ -\/-\/hint;}
\DoxyCodeLine{00198\ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (\_frames[hint]\ ==\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00199\ \ \ \}}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{if}\ (\_frames[hint]-\/>get\_start()\ <=\ time)\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \textcolor{comment}{//\ Search\ forward.}}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ hint\ +\ 1;\ i\ <\ (int)\_frames.size();\ ++i)\ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\ =\ \_frames[i];}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (frame-\/>get\_start()\ <=\ time)\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ hint\ =\ i;}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00212\ \ \ \ \ \}}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ +\ hint;}
\DoxyCodeLine{00214\ \ \ \}}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \textcolor{comment}{//\ Search\ backward.}}
\DoxyCodeLine{00217\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ hint\ -\/\ 1;\ i\ >=\ 0;\ -\/-\/i)\ \{}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\ =\ \_frames[i];}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ frame-\/>get\_start()\ <=\ time)\ \{}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ +\ i;}
\DoxyCodeLine{00221\ \ \ \ \ \}}
\DoxyCodeLine{00222\ \ \ \}}
\DoxyCodeLine{00223\ }
\DoxyCodeLine{00224\ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ -\/\ 1;}
\DoxyCodeLine{00225\ \}}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00231\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPStatThreadData_a0a4458a0def6d94a3619372211685693}{PStatThreadData::}}}
\DoxyCodeLine{00232\ \mbox{\hyperlink{classPStatThreadData_a0a4458a0def6d94a3619372211685693}{get\_frame\_number\_after}}(\textcolor{keywordtype}{double}\ time,\ \textcolor{keywordtype}{int}\ start\_at)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00233\ \ \ \textcolor{keywordtype}{int}\ i\ =\ std::max(0,\ start\_at\ -\/\ \_first\_frame\_number);}
\DoxyCodeLine{00234\ \ \ \textcolor{keywordtype}{double}\ end\ =\ \mbox{\hyperlink{classPStatThreadData_a5530a369c1f4400afdbbb2659cdd99f2}{get\_frame}}(i).get\_end();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \textcolor{keywordflow}{while}\ (end\ <\ time)\ \{}
\DoxyCodeLine{00237\ \ \ \ \ ++i;}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordflow}{if}\ ((\textcolor{keywordtype}{size\_t})i\ >=\ \_frames.size())\ \{}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00240\ \ \ \ \ \}}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_frames[i]\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00242\ \ \ \ \ \ \ end\ =\ \_frames[i]-\/>get\_end();}
\DoxyCodeLine{00243\ \ \ \ \ \}}
\DoxyCodeLine{00244\ \ \ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{return}\ \_first\_frame\_number\ +\ i;}
\DoxyCodeLine{00247\ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00252\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ \&\mbox{\hyperlink{classPStatThreadData_a418fd8083999201fe9601b35e607999c}{PStatThreadData::}}}
\DoxyCodeLine{00253\ \mbox{\hyperlink{classPStatThreadData_a418fd8083999201fe9601b35e607999c}{get\_latest\_frame}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00254\ \ \ nassertr(!\_frames.empty(),\ \_null\_frame);}
\DoxyCodeLine{00255\ \ \ \textcolor{keywordflow}{return}\ *\_frames.back();}
\DoxyCodeLine{00256\ \}}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00264\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPStatThreadData_a09571e52d93d6302fc86a6b0615f94a8}{PStatThreadData::}}}
\DoxyCodeLine{00265\ \mbox{\hyperlink{classPStatThreadData_a09571e52d93d6302fc86a6b0615f94a8}{get\_elapsed\_frames}}(\textcolor{keywordtype}{int}\ \&then\_i,\ \textcolor{keywordtype}{int}\ \&now\_i)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00266\ \ \ \textcolor{keywordflow}{if}\ (!\_computed\_elapsed\_frames)\ \{}
\DoxyCodeLine{00267\ \ \ \ \ compute\_elapsed\_frames();}
\DoxyCodeLine{00268\ \ \ \}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \ \ now\_i\ =\ \_now\_i;}
\DoxyCodeLine{00271\ \ \ then\_i\ =\ \_then\_i;}
\DoxyCodeLine{00272\ \ \ \textcolor{keywordflow}{return}\ \_got\_elapsed\_frames;}
\DoxyCodeLine{00273\ \}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00279\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classPStatThreadData_a36bd71263c50a364e3f44627ec9c4606}{PStatThreadData::}}}
\DoxyCodeLine{00280\ \mbox{\hyperlink{classPStatThreadData_a36bd71263c50a364e3f44627ec9c4606}{get\_frame\_rate}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00281\ \ \ \textcolor{keywordtype}{int}\ then\_i,\ now\_i;}
\DoxyCodeLine{00282\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classPStatThreadData_a09571e52d93d6302fc86a6b0615f94a8}{get\_elapsed\_frames}}(then\_i,\ now\_i))\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \textcolor{keywordflow}{return}\ 0.0f;}
\DoxyCodeLine{00284\ \ \ \}}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \textcolor{keywordtype}{int}\ num\_frames\ =\ now\_i\ -\/\ then\_i\ +\ 1;}
\DoxyCodeLine{00287\ \ \ \textcolor{keywordtype}{double}\ now\ =\ \_frames[now\_i\ -\/\ \_first\_frame\_number]-\/>get\_end();}
\DoxyCodeLine{00288\ \ \ \textcolor{keywordtype}{double}\ elapsed\_time\ =\ (now\ -\/\ \_frames[then\_i\ -\/\ \_first\_frame\_number]-\/>get\_start());}
\DoxyCodeLine{00289\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{double})num\_frames\ /\ elapsed\_time;}
\DoxyCodeLine{00290\ \}}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00298\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatThreadData_a08f9d98b978524842e60752b1f2f974a}{PStatThreadData::}}}
\DoxyCodeLine{00299\ \mbox{\hyperlink{classPStatThreadData_a08f9d98b978524842e60752b1f2f974a}{set\_history}}(\textcolor{keywordtype}{double}\ time)\ \{}
\DoxyCodeLine{00300\ \ \ \_history\ =\ time;}
\DoxyCodeLine{00301\ \}}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00308\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{classPStatThreadData_a30b9dd1a975b8700d1d32abd18ae0991}{PStatThreadData::}}}
\DoxyCodeLine{00309\ \mbox{\hyperlink{classPStatThreadData_a30b9dd1a975b8700d1d32abd18ae0991}{get\_history}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00310\ \ \ \textcolor{keywordflow}{return}\ \_history;}
\DoxyCodeLine{00311\ \}}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00318\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{PStatThreadData::}}}
\DoxyCodeLine{00319\ \mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{prune\_history}}(\textcolor{keywordtype}{double}\ time)\ \{}
\DoxyCodeLine{00320\ \ \ \textcolor{keywordtype}{double}\ oldest\_allowable\_time\ =\ time\ -\/\ \_history;}
\DoxyCodeLine{00321\ \ \ \textcolor{keywordflow}{while}\ (!\_frames.empty()\ \&\&}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ (\_frames.front()\ ==\ \textcolor{keyword}{nullptr}\ ||}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \_frames.front()-\/>is\_time\_empty()\ ||}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \_frames.front()-\/>get\_start()\ <\ oldest\_allowable\_time))\ \{}
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{keyword}{delete}\ \_frames.front();}
\DoxyCodeLine{00326\ \ \ \ \ \_frames.pop\_front();}
\DoxyCodeLine{00327\ \ \ \ \ \_first\_frame\_number++;}
\DoxyCodeLine{00328\ \ \ \}}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \textcolor{keywordflow}{return}\ \_frames.empty();}
\DoxyCodeLine{00331\ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00341\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatThreadData_ab9db768a7880e19ce7c3aaf61e73095c}{PStatThreadData::}}}
\DoxyCodeLine{00342\ \mbox{\hyperlink{classPStatThreadData_ab9db768a7880e19ce7c3aaf61e73095c}{record\_new\_frame}}(\textcolor{keywordtype}{int}\ frame\_number,\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\_data)\ \{}
\DoxyCodeLine{00343\ \ \ nassertv(frame\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00344\ \ \ nassertv(!frame\_data-\/>is\_empty());}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \textcolor{comment}{//\ First,\ remove\ all\ the\ old\ frames\ that\ fall\ outside\ of\ our\ history\ window.}}
\DoxyCodeLine{00347\ \ \ \textcolor{comment}{//\ Then,\ add\ enough\ empty\ frame\ definitions\ to\ account\ for\ the\ latest\ frame}}
\DoxyCodeLine{00348\ \ \ \textcolor{comment}{//\ number.\ \ This\ might\ involve\ some\ skips,\ since\ we\ don't\ guarantee\ that\ we}}
\DoxyCodeLine{00349\ \ \ \textcolor{comment}{//\ get\ all\ the\ frames\ in\ order\ or\ even\ at\ all.}}
\DoxyCodeLine{00350\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classPStatThreadData_a5d9c3b9cd3d129bf776a1fbfc702a3cf}{prune\_history}}(frame\_data-\/>get\_start()))\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \_first\_frame\_number\ =\ frame\_number;}
\DoxyCodeLine{00352\ \ \ \ \ \_frames.push\_back(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00353\ \ \ \}}
\DoxyCodeLine{00354\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keywordflow}{while}\ (\_first\_frame\_number\ +\ (\textcolor{keywordtype}{int})\_frames.size()\ <=\ frame\_number)\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \_frames.push\_back(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00357\ \ \ \ \ \}}
\DoxyCodeLine{00358\ \ \ \}}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ \ \ \textcolor{keywordtype}{int}\ index\ =\ frame\_number\ -\/\ \_first\_frame\_number;}
\DoxyCodeLine{00361\ }
\DoxyCodeLine{00362\ \ \ \textcolor{comment}{//\ It's\ possible\ to\ receive\ frames\ out\ of\ order.}}
\DoxyCodeLine{00363\ \ \ \textcolor{keywordflow}{while}\ (index\ <\ 0)\ \{}
\DoxyCodeLine{00364\ \ \ \ \ \_frames.push\_front(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00365\ \ \ \ \ ++index;}
\DoxyCodeLine{00366\ \ \ \ \ -\/-\/\_first\_frame\_number;}
\DoxyCodeLine{00367\ \ \ \}}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \ \ nassertv(index\ >=\ 0\ \&\&\ index\ <\ (\textcolor{keywordtype}{int})\_frames.size());}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \ \ \textcolor{keywordflow}{if}\ (\_frames[index]\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00372\ \ \ \ \ nout\ <<\ \textcolor{stringliteral}{"{}Got\ repeated\ frame\ data\ for\ frame\ "{}}\ <<\ frame\_number\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00373\ \ \ \ \ \textcolor{keyword}{delete}\ \_frames[index];}
\DoxyCodeLine{00374\ \ \ \}}
\DoxyCodeLine{00375\ }
\DoxyCodeLine{00376\ \ \ \_frames[index]\ =\ frame\_data;}
\DoxyCodeLine{00377\ \ \ \_computed\_elapsed\_frames\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00383\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatThreadData_aed6960153cb7d5ef0178eb4427ffa7f0}{PStatThreadData::}}}
\DoxyCodeLine{00384\ \mbox{\hyperlink{classPStatThreadData_aed6960153cb7d5ef0178eb4427ffa7f0}{write\_datagram}}(\mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00385\ \ \ \textcolor{keywordtype}{int}\ frame\_number\ =\ \_first\_frame\_number;}
\DoxyCodeLine{00386\ }
\DoxyCodeLine{00387\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\_data\ :\ \_frames)\ \{}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\_data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \ \ dg.add\_int32(frame\_number);}
\DoxyCodeLine{00390\ \ \ \ \ \ \ frame\_data-\/>write\_datagram(dg);}
\DoxyCodeLine{00391\ \ \ \ \ \}}
\DoxyCodeLine{00392\ \ \ \ \ ++frame\_number;}
\DoxyCodeLine{00393\ \ \ \}}
\DoxyCodeLine{00394\ \ \ dg.add\_int32(-\/1);}
\DoxyCodeLine{00395\ \}}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00400\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classPStatThreadData_a26d792e563920012c6ff35ff9a6e04cd}{PStatThreadData::}}}
\DoxyCodeLine{00401\ \mbox{\hyperlink{classPStatThreadData_a26d792e563920012c6ff35ff9a6e04cd}{read\_datagram}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classPStatClientVersion}{PStatClientVersion}}\ *version)\ \{}
\DoxyCodeLine{00402\ \ \ \textcolor{keywordtype}{int}\ frame\_number;}
\DoxyCodeLine{00403\ \ \ \textcolor{keywordflow}{while}\ ((frame\_number\ =\ scan.get\_int32())\ !=\ -\/1)\ \{}
\DoxyCodeLine{00404\ \ \ \ \ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\_data\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}};}
\DoxyCodeLine{00405\ \ \ \ \ frame\_data-\/>\mbox{\hyperlink{classPStatFrameData_a1249a652b0766c18b6a5a9aadaf19b3c}{read\_datagram}}(scan,\ version);}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \ \ \ \ \mbox{\hyperlink{classPStatThreadData_ab9db768a7880e19ce7c3aaf61e73095c}{record\_new\_frame}}(frame\_number,\ frame\_data);}
\DoxyCodeLine{00408\ \ \ \}}
\DoxyCodeLine{00409\ }
\DoxyCodeLine{00410\ \ \ compute\_elapsed\_frames();}
\DoxyCodeLine{00411\ \}}
\DoxyCodeLine{00412\ }
\DoxyCodeLine{00416\ \textcolor{keywordtype}{void}\ PStatThreadData::}
\DoxyCodeLine{00417\ compute\_elapsed\_frames()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00418\ \ \ \textcolor{keywordflow}{if}\ (\_frames.empty())\ \{}
\DoxyCodeLine{00419\ \ \ \ \ \textcolor{comment}{//\ No\ frames\ in\ the\ data\ at\ all.}}
\DoxyCodeLine{00420\ \ \ \ \ \_got\_elapsed\_frames\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00421\ \ \ \}}
\DoxyCodeLine{00422\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00423\ \ \ \ \ \_now\_i\ =\ \_frames.size()\ -\/\ 1;}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{keywordflow}{while}\ (\_now\_i\ >\ 0\ \&\&\ \_frames[\_now\_i]\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \_now\_i-\/-\/;}
\DoxyCodeLine{00426\ \ \ \ \ \}}
\DoxyCodeLine{00427\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_now\_i\ <\ 0)\ \{}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ frames\ have\ any\ real\ data.}}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \_got\_elapsed\_frames\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00430\ \ \ \ \ \}}
\DoxyCodeLine{00431\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00432\ \ \ \ \ \ \ nassertv(\_frames[\_now\_i]\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00433\ }
\DoxyCodeLine{00434\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ now\ =\ \_frames[\_now\_i]-\/>get\_end();}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ then\ =\ now\ -\/\ pstats\_average\_time;}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ old\_i\ =\ \_now\_i;}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \_then\_i\ =\ \_now\_i;}
\DoxyCodeLine{00439\ }
\DoxyCodeLine{00440\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (old\_i\ >=\ 0)\ \{}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classPStatFrameData}{PStatFrameData}}\ *frame\ =\ \_frames[old\_i];}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (frame-\/>get\_start()\ >\ then)\ \{}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \ \ \ \ \_then\_i\ =\ old\_i;}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ old\_i-\/-\/;}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \ \ \ \ nassertv(\_then\_i\ >=\ 0);}
\DoxyCodeLine{00453\ \ \ \ \ \ \ nassertv(\_frames[\_then\_i]\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \_got\_elapsed\_frames\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00455\ }
\DoxyCodeLine{00456\ \ \ \ \ \ \ \_now\_i\ +=\ \_first\_frame\_number;}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \_then\_i\ +=\ \_first\_frame\_number;}
\DoxyCodeLine{00458\ \ \ \ \ \}}
\DoxyCodeLine{00459\ \ \ \}}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \ \ \_computed\_elapsed\_frames\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00462\ \}}

\end{DoxyCode}
