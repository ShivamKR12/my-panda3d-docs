\doxysection{http\+Client\+\_\+emscripten.\+cxx}
\hypertarget{httpClient__emscripten_8cxx_source}{}\label{httpClient__emscripten_8cxx_source}\index{panda/src/downloader/httpClient\_emscripten.cxx@{panda/src/downloader/httpClient\_emscripten.cxx}}
\mbox{\hyperlink{httpClient__emscripten_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpClient__emscripten_8h}{httpClient\_emscripten.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpChannel_8h}{httpChannel.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__downloader_8h}{config\_downloader.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpBasicAuthorization_8h}{httpBasicAuthorization.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpDigestAuthorization_8h}{httpDigestAuthorization.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifdef\ \_\_EMSCRIPTEN\_\_}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ <emscripten/em\_asm.h>}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ PT(HTTPClient)\ HTTPClient::\_global\_ptr;}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00031\ HTTPClient::}
\DoxyCodeLine{00032\ HTTPClient()\ \{}
\DoxyCodeLine{00033\ \ \ \mbox{\hyperlink{classConfigVariableList}{ConfigVariableList}}\ http\_username}
\DoxyCodeLine{00034\ \ \ \ \ (\textcolor{stringliteral}{"{}http-\/username"{}},}
\DoxyCodeLine{00035\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}Adds\ one\ or\ more\ username/password\ pairs\ to\ all\ HTTP\ clients.\ \ The\ client\ "{}}}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}will\ present\ this\ username/password\ when\ asked\ to\ authenticate\ a\ request\ "{}}}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}for\ a\ particular\ server\ and/or\ realm.\ \ The\ username\ is\ of\ the\ form\ "{}}}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}server:realm:username:password,\ where\ either\ or\ both\ of\ server\ and\ "{}}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}realm\ may\ be\ empty,\ or\ just\ realm:username:password\ or\ username:password.\ \ "{}}}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}If\ the\ server\ or\ realm\ is\ empty,\ they\ will\ match\ anything."{}}));}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \{}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{comment}{//\ Also\ load\ in\ the\ general\ usernames.}}
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_unique\_values\ =\ http\_username.get\_num\_unique\_values();}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_unique\_values;\ i++)\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ username\ =\ http\_username.get\_unique\_value(i);}
\DoxyCodeLine{00047\ \ \ \ \ \ \ add\_http\_username(username);}
\DoxyCodeLine{00048\ \ \ \ \ \}}
\DoxyCodeLine{00049\ \ \ \}}
\DoxyCodeLine{00050\ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00061\ \textcolor{keywordtype}{void}\ HTTPClient::}
\DoxyCodeLine{00062\ set\_username(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&server,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&realm,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&username)\ \{}
\DoxyCodeLine{00063\ \ \ \textcolor{keywordtype}{string}\ key\ =\ server\ +\ \textcolor{stringliteral}{"{}:"{}}\ +\ realm;}
\DoxyCodeLine{00064\ \ \ \textcolor{keywordflow}{if}\ (username.empty())\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \_usernames.erase(key);}
\DoxyCodeLine{00066\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00067\ \ \ \ \ \_usernames[key]\ =\ username;}
\DoxyCodeLine{00068\ \ \ \}}
\DoxyCodeLine{00069\ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00075\ \textcolor{keywordtype}{string}\ HTTPClient::}
\DoxyCodeLine{00076\ get\_username(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&server,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&realm)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00077\ \ \ \textcolor{keywordtype}{string}\ key\ =\ server\ +\ \textcolor{stringliteral}{"{}:"{}}\ +\ realm;}
\DoxyCodeLine{00078\ \ \ Usernames::const\_iterator\ ui;}
\DoxyCodeLine{00079\ \ \ ui\ =\ \_usernames.find(key);}
\DoxyCodeLine{00080\ \ \ \textcolor{keywordflow}{if}\ (ui\ !=\ \_usernames.end())\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{keywordflow}{return}\ (*ui).second;}
\DoxyCodeLine{00082\ \ \ \}}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordflow}{return}\ string();}
\DoxyCodeLine{00084\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00090\ \textcolor{keywordtype}{void}\ HTTPClient::}
\DoxyCodeLine{00091\ set\_cookie(\textcolor{keyword}{const}\ HTTPCookie\ \&cookie)\ \{}
\DoxyCodeLine{00092\ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}}\ stream;}
\DoxyCodeLine{00093\ \ \ stream\ <<\ cookie;}
\DoxyCodeLine{00094\ \ \ std::string\ str\ =\ stream.str();}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ EM\_ASM(\{}
\DoxyCodeLine{00097\ \ \ \ \ document.cookie\ =\ UTF8ToString(\$0);}
\DoxyCodeLine{00098\ \ \ \},\ str.c\_str());}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00106\ \textcolor{keywordtype}{bool}\ HTTPClient::}
\DoxyCodeLine{00107\ clear\_cookie(\textcolor{keyword}{const}\ HTTPCookie\ \&cookie)\ \{}
\DoxyCodeLine{00108\ \ \ HTTPCookie\ expired;}
\DoxyCodeLine{00109\ \ \ expired.set\_name(cookie.get\_name());}
\DoxyCodeLine{00110\ \ \ expired.set\_path(cookie.get\_path());}
\DoxyCodeLine{00111\ \ \ expired.set\_domain(cookie.get\_domain());}
\DoxyCodeLine{00112\ \ \ expired.set\_expires(\mbox{\hyperlink{classHTTPDate}{HTTPDate}}((time\_t)0));}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}}\ stream;}
\DoxyCodeLine{00115\ \ \ stream\ <<\ expired;}
\DoxyCodeLine{00116\ \ \ std::string\ str\ =\ stream.str();}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{bool})EM\_ASM\_INT(\{}
\DoxyCodeLine{00119\ \ \ \ \ var\ set\ =\ UTF8ToString(\$0);}
\DoxyCodeLine{00120\ \ \ \ \ var\ old\ =\ document.cookie;}
\DoxyCodeLine{00121\ \ \ \ \ document.cookie\ =\ set;}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keywordflow}{return}\ (document.cookie\ !==\ old);}
\DoxyCodeLine{00123\ \ \ \},\ str.c\_str());}
\DoxyCodeLine{00124\ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00129\ \textcolor{keywordtype}{void}\ HTTPClient::}
\DoxyCodeLine{00130\ clear\_all\_cookies()\ \{}
\DoxyCodeLine{00131\ \ \ \textcolor{comment}{//\ NB.\ This\ is\ imperfect,\ and\ won't\ clear\ cookies\ with\ other\ domains\ or\ paths.}}
\DoxyCodeLine{00132\ \ \ EM\_ASM(\{}
\DoxyCodeLine{00133\ \ \ \ \ var\ cookies\ =\ document.cookie.split(\textcolor{stringliteral}{"{};"{}});}
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{keywordflow}{for}\ (var\ i\ =\ 0;\ i\ <\ cookies.length;\ ++i)\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \ \ var\ name\ =\ cookies[i].split(\textcolor{stringliteral}{"{}="{}},\ 1)[0];}
\DoxyCodeLine{00136\ \ \ \ \ \ \ document.cookie\ =\ name\ +\ \textcolor{stringliteral}{"{}=;expires=Thu,\ 01\ Jan\ 1970\ 00:00:00\ GMT"{}};}
\DoxyCodeLine{00137\ \ \ \ \ \}}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ cookies\ =\ document.cookie.split(\textcolor{stringliteral}{"{};"{}});}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keywordflow}{for}\ (var\ i\ =\ 0;\ i\ <\ cookies.length;\ ++i)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \ \ var\ name\ =\ cookies[i].split(\textcolor{stringliteral}{"{}="{}},\ 1)[0];}
\DoxyCodeLine{00142\ \ \ \ \ \ \ document.cookie\ =\ name\ +\ \textcolor{stringliteral}{"{}=;path=/;expires=Thu,\ 01\ Jan\ 1970\ 00:00:00\ GMT"{}};}
\DoxyCodeLine{00143\ \ \ \ \ \}}
\DoxyCodeLine{00144\ \ \ \});}
\DoxyCodeLine{00145\ \}}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00151\ \textcolor{comment}{//bool\ HTTPClient::}}
\DoxyCodeLine{00152\ \textcolor{comment}{//has\_cookie(const\ HTTPCookie\ \&cookie)\ const\ \{}}
\DoxyCodeLine{00153\ \textcolor{comment}{//\}}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00159\ \textcolor{comment}{//HTTPCookie\ HTTPClient::}}
\DoxyCodeLine{00160\ \textcolor{comment}{//get\_cookie(const\ HTTPCookie\ \&cookie)\ const\ \{}}
\DoxyCodeLine{00161\ \textcolor{comment}{//\ \ return\ HTTPCookie();}}
\DoxyCodeLine{00162\ \textcolor{comment}{//\}}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00169\ \textcolor{keywordtype}{void}\ HTTPClient::}
\DoxyCodeLine{00170\ write\_cookies(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00171\ \ \ \textcolor{keywordtype}{char}\ *str\ =\ (\textcolor{keywordtype}{char}\ *)EM\_ASM\_INT(\{}
\DoxyCodeLine{00172\ \ \ \ \ var\ str\ =\ document.cookie.replace(/;\ ?/g,\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00173\ \ \ \ \ var\ len\ =\ lengthBytesUTF8(str)\ +\ 1;}
\DoxyCodeLine{00174\ \ \ \ \ var\ buffer\ =\ \_malloc(len);}
\DoxyCodeLine{00175\ \ \ \ \ stringToUTF8(str,\ buffer,\ len);}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{keywordflow}{return}\ buffer;}
\DoxyCodeLine{00177\ \ \ \});}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ out\ <<\ str\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00180\ \ \ free(str);}
\DoxyCodeLine{00181\ \}}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00193\ PT(HTTPChannel)\ HTTPClient::}
\DoxyCodeLine{00194\ make\_channel(\textcolor{keywordtype}{bool}\ persistent\_connection)\ \{}
\DoxyCodeLine{00195\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ HTTPChannel(\textcolor{keyword}{this});}
\DoxyCodeLine{00196\ \}}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00204\ PT(HTTPChannel)\ HTTPClient::}
\DoxyCodeLine{00205\ post\_form(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&body)\ \{}
\DoxyCodeLine{00206\ \ \ PT(HTTPChannel)\ doc\ =\ \textcolor{keyword}{new}\ HTTPChannel(\textcolor{keyword}{this});}
\DoxyCodeLine{00207\ \ \ doc-\/>post\_form(url,\ body);}
\DoxyCodeLine{00208\ \ \ \textcolor{keywordflow}{return}\ doc;}
\DoxyCodeLine{00209\ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00216\ PT(HTTPChannel)\ HTTPClient::}
\DoxyCodeLine{00217\ get\_document(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url)\ \{}
\DoxyCodeLine{00218\ \ \ PT(HTTPChannel)\ doc\ =\ \textcolor{keyword}{new}\ HTTPChannel(\textcolor{keyword}{this});}
\DoxyCodeLine{00219\ \ \ doc-\/>get\_document(url);}
\DoxyCodeLine{00220\ \ \ \textcolor{keywordflow}{return}\ doc;}
\DoxyCodeLine{00221\ \}}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00229\ PT(HTTPChannel)\ HTTPClient::}
\DoxyCodeLine{00230\ get\_header(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url)\ \{}
\DoxyCodeLine{00231\ \ \ PT(HTTPChannel)\ doc\ =\ \textcolor{keyword}{new}\ HTTPChannel(\textcolor{keyword}{this});}
\DoxyCodeLine{00232\ \ \ doc-\/>get\_header(url);}
\DoxyCodeLine{00233\ \ \ \textcolor{keywordflow}{return}\ doc;}
\DoxyCodeLine{00234\ \}}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00239\ HTTPClient\ *HTTPClient::}
\DoxyCodeLine{00240\ get\_global\_ptr()\ \{}
\DoxyCodeLine{00241\ \ \ \textcolor{keywordflow}{if}\ (\_global\_ptr\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00242\ \ \ \ \ \_global\_ptr\ =\ \textcolor{keyword}{new}\ HTTPClient;}
\DoxyCodeLine{00243\ \ \ \}}
\DoxyCodeLine{00244\ \ \ \textcolor{keywordflow}{return}\ \_global\_ptr;}
\DoxyCodeLine{00245\ \}}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00252\ \textcolor{keywordtype}{void}\ HTTPClient::}
\DoxyCodeLine{00253\ add\_http\_username(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&http\_username)\ \{}
\DoxyCodeLine{00254\ \ \ \textcolor{keywordtype}{size\_t}\ c1\ =\ http\_username.find(\textcolor{charliteral}{':'});}
\DoxyCodeLine{00255\ \ \ \textcolor{keywordflow}{if}\ (c1\ !=\ string::npos)\ \{}
\DoxyCodeLine{00256\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ c2\ =\ http\_username.find(\textcolor{charliteral}{':'},\ c1\ +\ 1);}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{if}\ (c2\ !=\ string::npos)\ \{}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ c3\ =\ http\_username.find(\textcolor{charliteral}{':'},\ c2\ +\ 1);}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c3\ !=\ string::npos)\ \{}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ c4\ =\ http\_username.find(\textcolor{charliteral}{':'},\ c3\ +\ 1);}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c4\ !=\ string::npos)\ \{}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Oops,\ we\ have\ five?\ \ Problem.}}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ http-\/username\ "{}}\ <<\ http\_username\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Ok,\ we\ have\ four.}}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ \ set\_username(http\_username.substr(0,\ c1),}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ http\_username.substr(c1\ +\ 1,\ c2\ -\/\ (c1\ +\ 1)),}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ http\_username.substr(c2\ +\ 1));}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ only\ three.}}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ set\_username(\textcolor{keywordtype}{string}(),}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ http\_username.substr(0,\ c1),}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ http\_username.substr(c1\ +\ 1));}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00279\ \ \ \ \ \}}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ only\ two.}}
\DoxyCodeLine{00282\ \ \ \ \ \ \ set\_username(\textcolor{keywordtype}{string}(),\ \textcolor{keywordtype}{string}(),\ http\_username);}
\DoxyCodeLine{00283\ \ \ \ \ \}}
\DoxyCodeLine{00284\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \textcolor{comment}{//\ We\ have\ only\ one?\ \ Problem.}}
\DoxyCodeLine{00286\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00287\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ http-\/username\ "{}}\ <<\ http\_username\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00288\ \ \ \}}
\DoxyCodeLine{00289\ \}}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00294\ \textcolor{keywordtype}{string}\ HTTPClient::}
\DoxyCodeLine{00295\ select\_username(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&realm)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00296\ \ \ \textcolor{keywordtype}{string}\ username;}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \textcolor{comment}{//\ Look\ in\ several\ places\ in\ order\ to\ find\ the\ matching\ username.}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \textcolor{comment}{//\ Fist,\ if\ there's\ a\ username\ on\ the\ URL,\ that\ always\ wins\ (except\ when\ we}}
\DoxyCodeLine{00301\ \ \ \textcolor{comment}{//\ are\ looking\ for\ a\ proxy\ username).}}
\DoxyCodeLine{00302\ \ \ \textcolor{keywordflow}{if}\ (url.has\_username())\ \{}
\DoxyCodeLine{00303\ \ \ \ \ username\ =\ url.get\_username();}
\DoxyCodeLine{00304\ \ \ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \ \ \textcolor{comment}{//\ Otherwise,\ start\ looking\ on\ the\ HTTPClient.}}
\DoxyCodeLine{00307\ \ \ \textcolor{keywordflow}{if}\ (username.empty())\ \{}
\DoxyCodeLine{00308\ \ \ \ \ \textcolor{comment}{//\ Try\ the\ specific\ serverrealm.}}
\DoxyCodeLine{00309\ \ \ \ \ username\ =\ get\_username(url.get\_server(),\ realm);}
\DoxyCodeLine{00310\ \ \ \}}
\DoxyCodeLine{00311\ \ \ \textcolor{keywordflow}{if}\ (username.empty())\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{comment}{//\ Then,\ try\ the\ specific\ serverany\ realm.}}
\DoxyCodeLine{00313\ \ \ \ \ username\ =\ get\_username(url.get\_server(),\ \textcolor{keywordtype}{string}());}
\DoxyCodeLine{00314\ \ \ \}}
\DoxyCodeLine{00315\ \ \ \textcolor{keywordflow}{if}\ (username.empty())\ \{}
\DoxyCodeLine{00316\ \ \ \ \ \textcolor{comment}{//\ Then,\ try\ any\ server\ with\ this\ realm.}}
\DoxyCodeLine{00317\ \ \ \ \ username\ =\ get\_username(\textcolor{keywordtype}{string}(),\ realm);}
\DoxyCodeLine{00318\ \ \ \}}
\DoxyCodeLine{00319\ \ \ \textcolor{keywordflow}{if}\ (username.empty())\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \textcolor{comment}{//\ Then,\ take\ the\ general\ password.}}
\DoxyCodeLine{00321\ \ \ \ \ username\ =\ get\_username(\textcolor{keywordtype}{string}(),\ \textcolor{keywordtype}{string}());}
\DoxyCodeLine{00322\ \ \ \}}
\DoxyCodeLine{00323\ }
\DoxyCodeLine{00324\ \ \ \textcolor{keywordflow}{return}\ username;}
\DoxyCodeLine{00325\ \}}
\DoxyCodeLine{00326\ }
\DoxyCodeLine{00331\ HTTPAuthorization\ *HTTPClient::}
\DoxyCodeLine{00332\ select\_auth(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&last\_realm)\ \{}
\DoxyCodeLine{00333\ \ \ Domains\ \&domains\ =\ \_www\_domains;}
\DoxyCodeLine{00334\ \ \ std::string\ canon\ =\ HTTPAuthorization::get\_canonical\_url(url).get\_url();}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \ \ \textcolor{comment}{//\ Look\ for\ the\ longest\ domain\ string\ that\ is\ a\ prefix\ of\ our\ canonical\ URL.}}
\DoxyCodeLine{00337\ \ \ \textcolor{comment}{//\ We\ have\ to\ make\ a\ linear\ scan\ through\ the\ list.}}
\DoxyCodeLine{00338\ \ \ Domains::const\_iterator\ best\_di\ =\ domains.end();}
\DoxyCodeLine{00339\ \ \ \textcolor{keywordtype}{size\_t}\ longest\_length\ =\ 0;}
\DoxyCodeLine{00340\ \ \ Domains::const\_iterator\ di;}
\DoxyCodeLine{00341\ \ \ \textcolor{keywordflow}{for}\ (di\ =\ domains.begin();\ di\ !=\ domains.end();\ ++di)\ \{}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&domain\ =\ (*di).first;}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ length\ =\ domain.length();}
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{keywordflow}{if}\ (domain\ ==\ canon.substr(0,\ length))\ \{}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ domain\ string\ matches.\ \ Is\ it\ the\ longest?}}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (length\ >\ longest\_length)\ \{}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ best\_di\ =\ di;}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ longest\_length\ =\ length;}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00350\ \ \ \ \ \}}
\DoxyCodeLine{00351\ \ \ \}}
\DoxyCodeLine{00352\ }
\DoxyCodeLine{00353\ \ \ \textcolor{keywordflow}{if}\ (best\_di\ !=\ domains.end())\ \{}
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{comment}{//\ Ok,\ we\ found\ a\ matching\ domain.\ \ Use\ it.}}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Choosing\ domain\ "{}}\ <<\ (*best\_di).first\ <<\ \textcolor{stringliteral}{"{}\ for\ "{}}\ <<\ url\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00358\ \ \ \ \ \}}
\DoxyCodeLine{00359\ \ \ \ \ \textcolor{keyword}{const}\ Realms\ \&realms\ =\ (*best\_di).second.\_realms;}
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{comment}{//\ First,\ try\ our\ last\ realm.}}
\DoxyCodeLine{00361\ \ \ \ \ Realms::const\_iterator\ ri;}
\DoxyCodeLine{00362\ \ \ \ \ ri\ =\ realms.find(last\_realm);}
\DoxyCodeLine{00363\ \ \ \ \ \textcolor{keywordflow}{if}\ (ri\ !=\ realms.end())\ \{}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (*ri).second;}
\DoxyCodeLine{00365\ \ \ \ \ \}}
\DoxyCodeLine{00366\ }
\DoxyCodeLine{00367\ \ \ \ \ \textcolor{keywordflow}{if}\ (!realms.empty())\ \{}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \textcolor{comment}{//\ Oh\ well,\ just\ return\ the\ first\ realm.}}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (*realms.begin()).second;}
\DoxyCodeLine{00370\ \ \ \ \ \}}
\DoxyCodeLine{00371\ \ \ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \ \ \textcolor{comment}{//\ No\ matching\ domains.}}
\DoxyCodeLine{00374\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00375\ \}}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00383\ PT(HTTPAuthorization)\ HTTPClient::}
\DoxyCodeLine{00384\ generate\_auth(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&url,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&challenge)\ \{}
\DoxyCodeLine{00385\ \ \ HTTPAuthorization::AuthenticationSchemes\ schemes;}
\DoxyCodeLine{00386\ \ \ HTTPAuthorization::parse\_authentication\_schemes(schemes,\ challenge);}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ PT(HTTPAuthorization)\ auth;}
\DoxyCodeLine{00389\ \ \ HTTPAuthorization::AuthenticationSchemes::iterator\ si;}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ si\ =\ schemes.find(\textcolor{stringliteral}{"{}digest"{}});}
\DoxyCodeLine{00392\ \ \ \textcolor{keywordflow}{if}\ (si\ !=\ schemes.end())\ \{}
\DoxyCodeLine{00393\ \ \ \ \ auth\ =\ \textcolor{keyword}{new}\ HTTPDigestAuthorization((*si).second,\ url,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00394\ \ \ \}}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \textcolor{keywordflow}{if}\ (auth\ ==\ \textcolor{keyword}{nullptr}\ ||\ !auth-\/>is\_valid())\ \{}
\DoxyCodeLine{00397\ \ \ \ \ si\ =\ schemes.find(\textcolor{stringliteral}{"{}basic"{}});}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{keywordflow}{if}\ (si\ !=\ schemes.end())\ \{}
\DoxyCodeLine{00399\ \ \ \ \ \ \ auth\ =\ \textcolor{keyword}{new}\ HTTPBasicAuthorization((*si).second,\ url,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00400\ \ \ \ \ \}}
\DoxyCodeLine{00401\ \ \ \}}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00403\ \ \ \textcolor{keywordflow}{if}\ (auth\ ==\ \textcolor{keyword}{nullptr}\ ||\ !auth-\/>is\_valid())\ \{}
\DoxyCodeLine{00404\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{00405\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Don't\ know\ how\ to\ use\ any\ of\ the\ server's\ available\ authorization\ schemes:\(\backslash\)n"{}};}
\DoxyCodeLine{00406\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ schemes.begin();\ si\ !=\ schemes.end();\ ++si)\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ downloader\_cat.warning()\ <<\ (*si).first\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00408\ \ \ \ \ \}}
\DoxyCodeLine{00409\ \ \ \}}
\DoxyCodeLine{00410\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00411\ \ \ \ \ \textcolor{comment}{//\ Now\ that\ we've\ got\ an\ authorization,\ store\ it\ under\ under\ each\ of\ its}}
\DoxyCodeLine{00412\ \ \ \ \ \textcolor{comment}{//\ suggested\ domains\ for\ future\ use.}}
\DoxyCodeLine{00413\ \ \ \ \ Domains\ \&domains\ =\ \_www\_domains;}
\DoxyCodeLine{00414\ \ \ \ \ \textcolor{keyword}{const}\ vector\_string\ \&domain\ =\ auth-\/>get\_domain();}
\DoxyCodeLine{00415\ \ \ \ \ vector\_string::const\_iterator\ si;}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ domain.begin();\ si\ !=\ domain.end();\ ++si)\ \{}
\DoxyCodeLine{00417\ \ \ \ \ \ \ domains[(*si)].\_realms[auth-\/>get\_realm()]\ =\ auth;}
\DoxyCodeLine{00418\ \ \ \ \ \}}
\DoxyCodeLine{00419\ \ \ \}}
\DoxyCodeLine{00420\ }
\DoxyCodeLine{00421\ \ \ \textcolor{keywordflow}{return}\ auth;}
\DoxyCodeLine{00422\ \}}
\DoxyCodeLine{00423\ }
\DoxyCodeLine{00424\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ \_\_EMSCRIPTEN\_\_}}

\end{DoxyCode}
