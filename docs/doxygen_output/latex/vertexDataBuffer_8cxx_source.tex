\doxysection{vertex\+Data\+Buffer.\+cxx}
\hypertarget{vertexDataBuffer_8cxx_source}{}\label{vertexDataBuffer_8cxx_source}\index{panda/src/gobj/vertexDataBuffer.cxx@{panda/src/gobj/vertexDataBuffer.cxx}}
\mbox{\hyperlink{vertexDataBuffer_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{vertexDataBuffer_8h}{vertexDataBuffer.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__gobj_8h}{config\_gobj.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pStatTimer_8h}{pStatTimer.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ VertexDataBuffer::\_type\_handle;}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00023\ \textcolor{keywordtype}{void}\ VertexDataBuffer::}
\DoxyCodeLine{00024\ operator\ =\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classVertexDataBuffer}{VertexDataBuffer}}\ \&copy)\ \{}
\DoxyCodeLine{00025\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00026\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder2(copy.\_lock);}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \textcolor{keywordflow}{if}\ (\_resident\_data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00029\ \ \ \ \ nassertv(\_reserved\_size\ !=\ 0);}
\DoxyCodeLine{00030\ \ \ \ \ get\_class\_type().\mbox{\hyperlink{classTypeHandle_a532dfc7c439beb0aadb5ed26781b35c8}{deallocate\_array}}(\_resident\_data);}
\DoxyCodeLine{00031\ \ \ \ \ \_resident\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00032\ \ \ \}}
\DoxyCodeLine{00033\ \ \ \textcolor{keywordflow}{if}\ (copy.\_resident\_data\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ copy.\_size\ !=\ 0)\ \{}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{//\ We\ only\ allocate\ \_size\ bytes,\ not\ the\ full\ \_reserved\_size\ allocated\ by}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{comment}{//\ the\ original\ copy.}}
\DoxyCodeLine{00036\ \ \ \ \ \_resident\_data\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)get\_class\_type().\mbox{\hyperlink{classTypeHandle_ae7476081f780a4321a4ae0010a0c1a7d}{allocate\_array}}(copy.\_size);}
\DoxyCodeLine{00037\ \ \ \ \ memcpy(\_resident\_data,\ copy.\_resident\_data,\ copy.\_size);}
\DoxyCodeLine{00038\ \ \ \}}
\DoxyCodeLine{00039\ \ \ \_size\ =\ copy.\_size;}
\DoxyCodeLine{00040\ \ \ \_reserved\_size\ =\ copy.\_size;}
\DoxyCodeLine{00041\ \ \ \_block\ =\ copy.\_block;}
\DoxyCodeLine{00042\ \ \ nassertv(\_reserved\_size\ >=\ \_size);}
\DoxyCodeLine{00043\ \}}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00048\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classVertexDataBuffer_a67dd636c8067920cff246de6704c0511}{VertexDataBuffer::}}}
\DoxyCodeLine{00049\ \mbox{\hyperlink{classVertexDataBuffer_a67dd636c8067920cff246de6704c0511}{swap}}(\mbox{\hyperlink{classVertexDataBuffer}{VertexDataBuffer}}\ \&other)\ \{}
\DoxyCodeLine{00050\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder(\_lock);}
\DoxyCodeLine{00051\ \ \ \mbox{\hyperlink{classLightMutexHolder}{LightMutexHolder}}\ holder2(other.\_lock);}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *resident\_data\ =\ \_resident\_data;}
\DoxyCodeLine{00054\ \ \ \textcolor{keywordtype}{size\_t}\ size\ =\ \_size;}
\DoxyCodeLine{00055\ \ \ \textcolor{keywordtype}{size\_t}\ reserved\_size\ =\ \_reserved\_size;}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \ \ \_block.swap(other.\_block);}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \_resident\_data\ =\ other.\_resident\_data;}
\DoxyCodeLine{00060\ \ \ \_size\ =\ other.\_size;}
\DoxyCodeLine{00061\ \ \ \_reserved\_size\ =\ other.\_reserved\_size;}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ other.\_resident\_data\ =\ resident\_data;}
\DoxyCodeLine{00064\ \ \ other.\_size\ =\ size;}
\DoxyCodeLine{00065\ \ \ other.\_reserved\_size\ =\ reserved\_size;}
\DoxyCodeLine{00066\ \ \ nassertv(\_reserved\_size\ >=\ \_size);}
\DoxyCodeLine{00067\ \}}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00076\ \textcolor{keywordtype}{void}\ VertexDataBuffer::}
\DoxyCodeLine{00077\ do\_clean\_realloc(\textcolor{keywordtype}{size\_t}\ reserved\_size)\ \{}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{if}\ (reserved\_size\ !=\ \_reserved\_size)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordflow}{if}\ (reserved\_size\ ==\ 0\ ||\ \_size\ ==\ 0)\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \ \ do\_unclean\_realloc(reserved\_size);}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00082\ \ \ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ <<\ \textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}.clean\_realloc("{}}\ <<\ reserved\_size\ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{00087\ \ \ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{comment}{//\ Page\ in\ if\ we're\ currently\ paged\ out.}}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_reserved\_size\ !=\ 0\ \&\&\ \_resident\_data\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ do\_page\_in();}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_reserved\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ nassertv(\_resident\_data\ ==\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \_resident\_data\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)get\_class\_type().\mbox{\hyperlink{classTypeHandle_ae7476081f780a4321a4ae0010a0c1a7d}{allocate\_array}}(reserved\_size);}
\DoxyCodeLine{00097\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ nassertv(\_resident\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \_resident\_data\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)get\_class\_type().\mbox{\hyperlink{classTypeHandle_ac9146f32b539675b1c955517cd9cb1d4}{reallocate\_array}}(\_resident\_data,\ reserved\_size);}
\DoxyCodeLine{00100\ \ \ \ \ \}}
\DoxyCodeLine{00101\ \ \ \ \ nassertv(\_resident\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00102\ \ \ \ \ \_reserved\_size\ =\ reserved\_size;}
\DoxyCodeLine{00103\ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \_size\ =\ std::min(\_size,\ \_reserved\_size);}
\DoxyCodeLine{00106\ \}}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00114\ \textcolor{keywordtype}{void}\ VertexDataBuffer::}
\DoxyCodeLine{00115\ do\_unclean\_realloc(\textcolor{keywordtype}{size\_t}\ reserved\_size)\ \{}
\DoxyCodeLine{00116\ \ \ \textcolor{keywordflow}{if}\ (reserved\_size\ !=\ \_reserved\_size\ ||\ \_resident\_data\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordflow}{if}\ (gobj\_cat.is\_debug())\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ gobj\_cat.debug()}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ <<\ \textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}.unclean\_realloc("{}}\ <<\ reserved\_size\ <<\ \textcolor{stringliteral}{"{})\(\backslash\)n"{}};}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ paged\ out,\ discard\ the\ page.}}
\DoxyCodeLine{00123\ \ \ \ \ \_block\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_resident\_data\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00126\ \ \ \ \ \ \ nassertv(\_reserved\_size\ !=\ 0);}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ get\_class\_type().\mbox{\hyperlink{classTypeHandle_a532dfc7c439beb0aadb5ed26781b35c8}{deallocate\_array}}(\_resident\_data);}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \_resident\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \_reserved\_size\ =\ 0;}
\DoxyCodeLine{00131\ \ \ \ \ \}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordflow}{if}\ (reserved\_size\ !=\ 0)\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ nassertv(\_resident\_data\ ==\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \_resident\_data\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)get\_class\_type().\mbox{\hyperlink{classTypeHandle_ae7476081f780a4321a4ae0010a0c1a7d}{allocate\_array}}(reserved\_size);}
\DoxyCodeLine{00136\ \ \ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ \_reserved\_size\ =\ reserved\_size;}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \_size\ =\ 0;}
\DoxyCodeLine{00142\ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00152\ \textcolor{keywordtype}{void}\ VertexDataBuffer::}
\DoxyCodeLine{00153\ do\_page\_out(\mbox{\hyperlink{classVertexDataBook}{VertexDataBook}}\ \&book)\ \{}
\DoxyCodeLine{00154\ \ \ \textcolor{keywordflow}{if}\ (\_block\ !=\ \textcolor{keyword}{nullptr}\ ||\ \_reserved\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{comment}{//\ We're\ already\ paged\ out.}}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00157\ \ \ \}}
\DoxyCodeLine{00158\ \ \ nassertv(\_resident\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{if}\ (\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{comment}{//\ It's\ an\ empty\ buffer.\ \ Just\ deallocate\ it;\ don't\ bother\ to\ create\ a}}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ block.}}
\DoxyCodeLine{00163\ \ \ \ \ get\_class\_type().\mbox{\hyperlink{classTypeHandle_a532dfc7c439beb0aadb5ed26781b35c8}{deallocate\_array}}(\_resident\_data);}
\DoxyCodeLine{00164\ \ \ \ \ \_resident\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00165\ \ \ \ \ \_reserved\_size\ =\ 0;}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ It's\ a\ nonempty\ buffer,\ so\ write\ \_size\ bytes\ (but\ not\ the\ full}}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{comment}{//\ \_reserved\_size\ bytes)\ to\ a\ block.}}
\DoxyCodeLine{00170\ \ \ \ \ \_block\ =\ book.alloc(\_size);}
\DoxyCodeLine{00171\ \ \ \ \ nassertv(\_block\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *pointer\ =\ \_block-\/>get\_pointer(\textcolor{keyword}{true});}
\DoxyCodeLine{00173\ \ \ \ \ nassertv(pointer\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00174\ \ \ \ \ memcpy(pointer,\ \_resident\_data,\ \_size);}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00176\ \ \ \ \ get\_class\_type().\mbox{\hyperlink{classTypeHandle_a532dfc7c439beb0aadb5ed26781b35c8}{deallocate\_array}}(\_resident\_data);}
\DoxyCodeLine{00177\ \ \ \ \ \_resident\_data\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \_reserved\_size\ =\ \_size;}
\DoxyCodeLine{00180\ \ \ \}}
\DoxyCodeLine{00181\ \ \ nassertv(\_reserved\_size\ >=\ \_size);}
\DoxyCodeLine{00182\ \}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00190\ \textcolor{keywordtype}{void}\ VertexDataBuffer::}
\DoxyCodeLine{00191\ do\_page\_in()\ \{}
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{if}\ (\_resident\_data\ !=\ \textcolor{keyword}{nullptr}\ ||\ \_reserved\_size\ ==\ 0)\ \{}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{//\ We're\ already\ paged\ in.}}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00195\ \ \ \}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \ \ nassertv(\_block\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00198\ \ \ nassertv(\_reserved\_size\ ==\ \_size);}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \_resident\_data\ =\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *)get\_class\_type().\mbox{\hyperlink{classTypeHandle_ae7476081f780a4321a4ae0010a0c1a7d}{allocate\_array}}(\_size);}
\DoxyCodeLine{00201\ \ \ nassertv(\_resident\_data\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ memcpy(\_resident\_data,\ \_block-\/>get\_pointer(\textcolor{keyword}{true}),\ \_size);}
\DoxyCodeLine{00204\ \}}

\end{DoxyCode}
