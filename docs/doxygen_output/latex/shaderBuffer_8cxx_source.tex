\doxysection{shader\+Buffer.\+cxx}
\hypertarget{shaderBuffer_8cxx_source}{}\label{shaderBuffer_8cxx_source}\index{panda/src/gobj/shaderBuffer.cxx@{panda/src/gobj/shaderBuffer.cxx}}
\mbox{\hyperlink{shaderBuffer_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{shaderBuffer_8h}{shaderBuffer.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{preparedGraphicsObjects_8h}{preparedGraphicsObjects.h}}"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ ShaderBuffer::\_type\_handle;}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00022\ ShaderBuffer::}
\DoxyCodeLine{00023\ \string~ShaderBuffer()\ \{}
\DoxyCodeLine{00024\ \ \ \mbox{\hyperlink{classShaderBuffer_abc17b85e48cd6f37ad3f89646d86920b}{release\_all}}();}
\DoxyCodeLine{00025\ \}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00030\ \textcolor{keywordtype}{void}\ ShaderBuffer::}
\DoxyCodeLine{00031\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00032\ \ \ out\ <<\ \textcolor{stringliteral}{"{}buffer\ "{}}\ <<\ get\_name()\ <<\ \textcolor{stringliteral}{"{},\ "{}}\ <<\ \_data\_size\_bytes\ <<\ \textcolor{stringliteral}{"{}B,\ "{}}\ <<\ \_usage\_hint;}
\DoxyCodeLine{00033\ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00043\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classShaderBuffer_a81aa24bb98712ad55c9db017e8d8ad1e}{ShaderBuffer::}}}
\DoxyCodeLine{00044\ \mbox{\hyperlink{classShaderBuffer_a81aa24bb98712ad55c9db017e8d8ad1e}{prepare}}(\mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects)\ \{}
\DoxyCodeLine{00045\ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_afb7ec2bae9d28c4c0548ec609eeb8e51}{enqueue\_shader\_buffer}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00046\ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00052\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classShaderBuffer_a06f7fc4ec97b18994b35497c03867008}{ShaderBuffer::}}}
\DoxyCodeLine{00053\ \mbox{\hyperlink{classShaderBuffer_a06f7fc4ec97b18994b35497c03867008}{is\_prepared}}(\mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00054\ \ \ \textcolor{keywordflow}{if}\ (\_contexts\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00056\ \ \ \}}
\DoxyCodeLine{00057\ \ \ Contexts::const\_iterator\ ci;}
\DoxyCodeLine{00058\ \ \ ci\ =\ \_contexts-\/>find(prepared\_objects);}
\DoxyCodeLine{00059\ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ \_contexts-\/>end())\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ \ \ \textcolor{keywordflow}{return}\ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_a524e4abd51279265c34df3c2213d6726}{is\_shader\_buffer\_queued}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00063\ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00076\ \mbox{\hyperlink{classBufferContext}{BufferContext}}\ *\mbox{\hyperlink{classShaderBuffer_a35c85b0c7210167362566f4468f9b4c4}{ShaderBuffer::}}}
\DoxyCodeLine{00077\ \mbox{\hyperlink{classShaderBuffer_a35c85b0c7210167362566f4468f9b4c4}{prepare\_now}}(\mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects,}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classGraphicsStateGuardianBase}{GraphicsStateGuardianBase}}\ *gsg)\ \{}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordflow}{if}\ (\_contexts\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00080\ \ \ \ \ Contexts::const\_iterator\ ci;}
\DoxyCodeLine{00081\ \ \ \ \ ci\ =\ \_contexts-\/>find(prepared\_objects);}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ \_contexts-\/>end())\ \{}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (*ci).second;}
\DoxyCodeLine{00084\ \ \ \ \ \}}
\DoxyCodeLine{00085\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \_contexts\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classpmap}{Contexts}};}
\DoxyCodeLine{00087\ \ \ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \mbox{\hyperlink{classBufferContext}{BufferContext}}\ *vbc\ =\ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_ae12ac6231b3b0635344d226536aa05a7}{prepare\_shader\_buffer\_now}}(\textcolor{keyword}{this},\ gsg);}
\DoxyCodeLine{00090\ \ \ \textcolor{keywordflow}{if}\ (vbc\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00091\ \ \ \ \ (*\_contexts)[prepared\_objects]\ =\ vbc;}
\DoxyCodeLine{00092\ \ \ \}}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_contexts-\/>empty())\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keyword}{delete}\ \_contexts;}
\DoxyCodeLine{00095\ \ \ \ \ \_contexts\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00096\ \ \ \}}
\DoxyCodeLine{00097\ \ \ \textcolor{keywordflow}{return}\ vbc;}
\DoxyCodeLine{00098\ \}}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00104\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classShaderBuffer_a133d7d1cc17d41067f90208811c2fa83}{ShaderBuffer::}}}
\DoxyCodeLine{00105\ \mbox{\hyperlink{classShaderBuffer_a133d7d1cc17d41067f90208811c2fa83}{release}}(\mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects)\ \{}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{if}\ (\_contexts\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00107\ \ \ \ \ Contexts::iterator\ ci;}
\DoxyCodeLine{00108\ \ \ \ \ ci\ =\ \_contexts-\/>find(prepared\_objects);}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ \_contexts-\/>end())\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \mbox{\hyperlink{classBufferContext}{BufferContext}}\ *vbc\ =\ (*ci).second;}
\DoxyCodeLine{00111\ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_a6880461c92f69406e37e4257d3f24c88}{release\_shader\_buffer}}(vbc);}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00113\ \ \ \ \ \}}
\DoxyCodeLine{00114\ \ \ \}}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \textcolor{comment}{//\ Maybe\ it\ wasn't\ prepared\ yet,\ but\ it's\ about\ to\ be.}}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{return}\ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_ac0e3898509b4b30d463edd780a18d693}{dequeue\_shader\_buffer}}(\textcolor{keyword}{this});}
\DoxyCodeLine{00118\ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00124\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classShaderBuffer_abc17b85e48cd6f37ad3f89646d86920b}{ShaderBuffer::}}}
\DoxyCodeLine{00125\ \mbox{\hyperlink{classShaderBuffer_abc17b85e48cd6f37ad3f89646d86920b}{release\_all}}()\ \{}
\DoxyCodeLine{00126\ \ \ \textcolor{keywordtype}{int}\ num\_freed\ =\ 0;}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \textcolor{keywordflow}{if}\ (\_contexts\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{comment}{//\ We\ have\ to\ traverse\ a\ copy\ of\ the\ \_contexts\ list,\ because\ the}}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{comment}{//\ PreparedGraphicsObjects\ object\ will\ call\ clear\_prepared()\ in\ response}}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{comment}{//\ to\ each\ release\_shader\_buffer(),\ and\ we\ don't\ want\ to\ be\ modifying\ the}}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{comment}{//\ \_contexts\ list\ while\ we're\ traversing\ it.}}
\DoxyCodeLine{00133\ \ \ \ \ \mbox{\hyperlink{classpmap}{Contexts}}\ temp\ =\ *\_contexts;}
\DoxyCodeLine{00134\ \ \ \ \ num\_freed\ =\ (int)\_contexts-\/>size();}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \ \ \ \ Contexts::const\_iterator\ ci;}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{for}\ (ci\ =\ temp.begin();\ ci\ !=\ temp.end();\ ++ci)\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects\ =\ (*ci).first;}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \mbox{\hyperlink{classBufferContext}{BufferContext}}\ *vbc\ =\ (*ci).second;}
\DoxyCodeLine{00140\ \ \ \ \ \ \ prepared\_objects-\/>\mbox{\hyperlink{classPreparedGraphicsObjects_a6880461c92f69406e37e4257d3f24c88}{release\_shader\_buffer}}(vbc);}
\DoxyCodeLine{00141\ \ \ \ \ \}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{comment}{//\ Now\ that\ we've\ called\ release\_shader\_buffer()\ on\ every\ known\ context,}}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ the\ \_contexts\ list\ should\ have\ completely\ emptied\ itself.}}
\DoxyCodeLine{00145\ \ \ \ \ nassertr(\_contexts\ ==\ \textcolor{keyword}{nullptr},\ num\_freed);}
\DoxyCodeLine{00146\ \ \ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \textcolor{keywordflow}{return}\ num\_freed;}
\DoxyCodeLine{00149\ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00157\ \textcolor{keywordtype}{void}\ ShaderBuffer::}
\DoxyCodeLine{00158\ clear\_prepared(\mbox{\hyperlink{classPreparedGraphicsObjects}{PreparedGraphicsObjects}}\ *prepared\_objects)\ \{}
\DoxyCodeLine{00159\ \ \ nassertv(\_contexts\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ Contexts::iterator\ ci;}
\DoxyCodeLine{00162\ \ \ ci\ =\ \_contexts-\/>find(prepared\_objects);}
\DoxyCodeLine{00163\ \ \ \textcolor{keywordflow}{if}\ (ci\ !=\ \_contexts-\/>end())\ \{}
\DoxyCodeLine{00164\ \ \ \ \ \_contexts-\/>erase(ci);}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_contexts-\/>empty())\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ \_contexts;}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \_contexts\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00168\ \ \ \ \ \}}
\DoxyCodeLine{00169\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{comment}{//\ If\ this\ assertion\ fails,\ clear\_prepared()\ was\ given\ a\ prepared\_objects}}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{comment}{//\ which\ the\ data\ array\ didn't\ know\ about.}}
\DoxyCodeLine{00172\ \ \ \ \ nassert\_raise(\textcolor{stringliteral}{"{}unknown\ PreparedGraphicsObjects"{}});}
\DoxyCodeLine{00173\ \ \ \}}
\DoxyCodeLine{00174\ \}}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00179\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classShaderBuffer_a4bc059487508310d077706eb0653bea4}{ShaderBuffer::}}}
\DoxyCodeLine{00180\ \mbox{\hyperlink{classShaderBuffer_a4bc059487508310d077706eb0653bea4}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{00181\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classShaderBuffer_a84462ccf9e31ba60888e0d51f83f310a}{make\_from\_bam}});}
\DoxyCodeLine{00182\ \}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00188\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classShaderBuffer_a2c3c74b68711c1e986d5af6ed60d599e}{ShaderBuffer::}}}
\DoxyCodeLine{00189\ \mbox{\hyperlink{classShaderBuffer_a2c3c74b68711c1e986d5af6ed60d599e}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{00190\ \ \ dg.add\_string(get\_name());}
\DoxyCodeLine{00191\ \ \ dg.add\_uint64(\_data\_size\_bytes);}
\DoxyCodeLine{00192\ \ \ dg.add\_uint8(\_usage\_hint);}
\DoxyCodeLine{00193\ \ \ dg.add\_bool(!\_initial\_data.empty());}
\DoxyCodeLine{00194\ \ \ dg.append\_data(\_initial\_data.data(),\ \_initial\_data.size());}
\DoxyCodeLine{00195\ \}}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00202\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classShaderBuffer_a84462ccf9e31ba60888e0d51f83f310a}{ShaderBuffer::}}}
\DoxyCodeLine{00203\ \mbox{\hyperlink{classShaderBuffer_a84462ccf9e31ba60888e0d51f83f310a}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00204\ \ \ \mbox{\hyperlink{classShaderBuffer}{ShaderBuffer}}\ *param\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classShaderBuffer}{ShaderBuffer}};}
\DoxyCodeLine{00205\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{00206\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{00209\ \ \ param-\/>fillin(scan,\ manager);}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \textcolor{keywordflow}{return}\ param;}
\DoxyCodeLine{00212\ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00218\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classShaderBuffer_a902d821e7c1d4d80e5773da868ed883a}{ShaderBuffer::}}}
\DoxyCodeLine{00219\ \mbox{\hyperlink{classShaderBuffer_a902d821e7c1d4d80e5773da868ed883a}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{00220\ \ \ set\_name(scan.\mbox{\hyperlink{classDatagramIterator_aa5b2810c1b772f83e744fed70bb313ea}{get\_string}}());}
\DoxyCodeLine{00221\ \ \ \_data\_size\_bytes\ =\ scan.get\_uint64();}
\DoxyCodeLine{00222\ \ \ \_usage\_hint\ =\ (UsageHint)scan.get\_uint8();}
\DoxyCodeLine{00223\ }
\DoxyCodeLine{00224\ \ \ \textcolor{keywordflow}{if}\ (scan.get\_bool()\ \&\&\ \_data\_size\_bytes\ >\ 0)\ \{}
\DoxyCodeLine{00225\ \ \ \ \ nassertv\_always(\_data\_size\_bytes\ <=\ scan.get\_remaining\_size());}
\DoxyCodeLine{00226\ \ \ \ \ \_initial\_data.resize((\_data\_size\_bytes\ +\ 15u)\ \&\ \string~15u);}
\DoxyCodeLine{00227\ \ \ \ \ scan.\mbox{\hyperlink{classDatagramIterator_a6422ef5992636dae0cd634b6cf9fec32}{extract\_bytes}}(\&\_initial\_data[0],\ \_data\_size\_bytes);}
\DoxyCodeLine{00228\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \_initial\_data.clear();}
\DoxyCodeLine{00230\ \ \ \}}
\DoxyCodeLine{00231\ \}}

\end{DoxyCode}
