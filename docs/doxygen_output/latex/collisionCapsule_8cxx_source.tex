\doxysection{collision\+Capsule.\+cxx}
\hypertarget{collisionCapsule_8cxx_source}{}\label{collisionCapsule_8cxx_source}\index{panda/src/collide/collisionCapsule.cxx@{panda/src/collide/collisionCapsule.cxx}}
\mbox{\hyperlink{collisionCapsule_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionCapsule_8h}{collisionCapsule.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionBox_8h}{collisionBox.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSphere_8h}{collisionSphere.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionLine_8h}{collisionLine.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionRay_8h}{collisionRay.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionSegment_8h}{collisionSegment.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionHandler_8h}{collisionHandler.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionEntry_8h}{collisionEntry.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{collisionParabola_8h}{collisionParabola.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__collide_8h}{config\_collide.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{look__at_8h}{look\_at.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomNode_8h}{geomNode.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geometricBoundingVolume_8h}{geometricBoundingVolume.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagram_8h}{datagram.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{datagramIterator_8h}{datagramIterator.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamWriter_8h}{bamWriter.h}}"{}}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cmath_8h}{cmath.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{transformState_8h}{transformState.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geom_8h}{geom.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomTristrips_8h}{geomTristrips.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{geomVertexWriter_8h}{geomVertexWriter.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{boundingSphere_8h}{boundingSphere.h}}"{}}}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionCapsule::\_volume\_pcollector(\textcolor{stringliteral}{"{}Collision\ Volumes:CollisionCapsule"{}});}
\DoxyCodeLine{00040\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ CollisionCapsule::\_test\_pcollector(\textcolor{stringliteral}{"{}Collision\ Tests:CollisionCapsule"{}});}
\DoxyCodeLine{00041\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CollisionCapsule::\_type\_handle;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00046\ \mbox{\hyperlink{classCollisionSolid}{CollisionSolid}}\ *CollisionCapsule::}
\DoxyCodeLine{00047\ make\_copy()\ \{}
\DoxyCodeLine{00048\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}(*\textcolor{keyword}{this});}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00055\ test\_intersection(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordflow}{return}\ entry.get\_into()-\/>test\_intersection\_from\_capsule(entry);}
\DoxyCodeLine{00057\ \}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00062\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{00063\ xform(\textcolor{keyword}{const}\ LMatrix4\ \&mat)\ \{}
\DoxyCodeLine{00064\ \ \ \_a\ =\ \_a\ *\ mat;}
\DoxyCodeLine{00065\ \ \ \_b\ =\ \_b\ *\ mat;}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \textcolor{comment}{//\ This\ is\ a\ little\ cheesy\ and\ fails\ miserably\ in\ the\ presence\ of\ a\ non-\/}}
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{//\ uniform\ scale.}}
\DoxyCodeLine{00069\ \ \ LVector3\ radius\_v\ =\ LVector3(\_radius,\ 0.0f,\ 0.0f)\ *\ mat;}
\DoxyCodeLine{00070\ \ \ \_radius\ =\ length(radius\_v);}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ recalc\_internals();}
\DoxyCodeLine{00073\ \ \ CollisionSolid::xform(mat);}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00081\ LPoint3\ CollisionCapsule::}
\DoxyCodeLine{00082\ get\_collision\_origin()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00083\ \ \ \textcolor{keywordflow}{return}\ get\_point\_a();}
\DoxyCodeLine{00084\ \}}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00090\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionCapsule_ac5bb3aa3e33d71df0dfb04a4cb53cdac}{CollisionCapsule::}}}
\DoxyCodeLine{00091\ \mbox{\hyperlink{classCollisionCapsule_ac5bb3aa3e33d71df0dfb04a4cb53cdac}{get\_volume\_pcollector}}()\ \{}
\DoxyCodeLine{00092\ \ \ \textcolor{keywordflow}{return}\ \_volume\_pcollector;}
\DoxyCodeLine{00093\ \}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00099\ \mbox{\hyperlink{classPStatCollector}{PStatCollector}}\ \&\mbox{\hyperlink{classCollisionCapsule_a1a473356fc1e8c5268ba0e4992d502a0}{CollisionCapsule::}}}
\DoxyCodeLine{00100\ \mbox{\hyperlink{classCollisionCapsule_a1a473356fc1e8c5268ba0e4992d502a0}{get\_test\_pcollector}}()\ \{}
\DoxyCodeLine{00101\ \ \ \textcolor{keywordflow}{return}\ \_test\_pcollector;}
\DoxyCodeLine{00102\ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00107\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{00108\ output(std::ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00109\ \ \ out\ <<\ \textcolor{stringliteral}{"{}capsule,\ a\ ("{}}\ <<\ \_a\ <<\ \textcolor{stringliteral}{"{}),\ b\ ("{}}\ <<\ \_b\ <<\ \textcolor{stringliteral}{"{}),\ r\ "{}}\ <<\ \_radius;}
\DoxyCodeLine{00110\ \}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00115\ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ CollisionCapsule::}
\DoxyCodeLine{00116\ compute\_internal\_bounds()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00117\ \ \ PT(\mbox{\hyperlink{classBoundingVolume}{BoundingVolume}})\ bound\ =\ CollisionSolid::compute\_internal\_bounds();}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \textcolor{keywordflow}{if}\ (bound-\/>is\_of\_type(GeometricBoundingVolume::get\_class\_type()))\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \mbox{\hyperlink{classGeometricBoundingVolume}{GeometricBoundingVolume}}\ *gbound;}
\DoxyCodeLine{00121\ \ \ \ \ DCAST\_INTO\_R(gbound,\ bound,\ bound);}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \ \ LVector3\ vec\ =\ (\_b\ -\/\ \_a);}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordflow}{if}\ (vec.normalize())\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ bounding\ volume\ includes\ both\ endpoints,\ plus\ a\ little\ bit\ more}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \textcolor{comment}{//\ to\ include\ the\ radius\ in\ both\ directions.}}
\DoxyCodeLine{00127\ \ \ \ \ \ \ LPoint3\ points[2];}
\DoxyCodeLine{00128\ \ \ \ \ \ \ points[0]\ =\ \_a\ -\/\ vec\ *\ \_radius;}
\DoxyCodeLine{00129\ \ \ \ \ \ \ points[1]\ =\ \_b\ +\ vec\ *\ \_radius;}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ \ \ gbound-\/>around(points,\ points\ +\ 2);}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \textcolor{comment}{//\ Both\ endpoints\ are\ coincident;\ therefore,\ the\ bounding\ volume\ is\ a}}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \textcolor{comment}{//\ sphere.}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \mbox{\hyperlink{classBoundingSphere}{BoundingSphere}}\ sphere(\_a,\ \_radius);}
\DoxyCodeLine{00137\ \ \ \ \ \ \ gbound-\/>extend\_by(\&sphere);}
\DoxyCodeLine{00138\ \ \ \ \ \}}
\DoxyCodeLine{00139\ \ \ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \textcolor{keywordflow}{return}\ bound;}
\DoxyCodeLine{00142\ \}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00147\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00148\ test\_intersection\_from\_box(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00149\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionBox}{CollisionBox}}\ *box;}
\DoxyCodeLine{00150\ \ \ DCAST\_INTO\_R(box,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \textcolor{keyword}{const}\ LMatrix4\ wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00153\ \ \ \textcolor{keyword}{const}\ LMatrix4\ inv\_wrt\_mat\ =\ entry.get\_inv\_wrt\_mat();}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \textcolor{comment}{//\ We\ find\ the\ closest\ point\ on\ the\ box\ to\ the\ line}}
\DoxyCodeLine{00156\ \ \ \textcolor{comment}{//\ segment\ defined\ by\ the\ endpoints\ of\ the\ capsule.\ To\ do}}
\DoxyCodeLine{00157\ \ \ \textcolor{comment}{//\ this,\ convert\ the\ capsule\ into\ the\ box's\ coordinate\ space.}}
\DoxyCodeLine{00158\ \ \ LPoint3\ box\_min\ =\ box-\/>get\_min();}
\DoxyCodeLine{00159\ \ \ LPoint3\ box\_max\ =\ box-\/>get\_max();}
\DoxyCodeLine{00160\ \ \ LPoint3\ a\ =\ \_a\ *\ inv\_wrt\_mat;}
\DoxyCodeLine{00161\ \ \ LPoint3\ b\ =\ \_b\ *\ inv\_wrt\_mat;}
\DoxyCodeLine{00162\ \ \ LVector3\ delta\ =\ b\ -\/\ a;}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \textcolor{keywordtype}{double}\ min\_dist\ =\ DBL\_MAX;}
\DoxyCodeLine{00165\ \ \ PN\_stdfloat\ t;}
\DoxyCodeLine{00166\ \ \ LPoint3\ closest\_point;}
\DoxyCodeLine{00167\ \ \ \textcolor{comment}{//\ Iterate\ through\ the\ 6\ planes\ of\ the\ box}}
\DoxyCodeLine{00168\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 6;\ i++)\ \{}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{if}\ (!box-\/>get\_plane(i).intersects\_line(t,\ a,\ delta))\ \{}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00171\ \ \ \ \ \}}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ >\ 1.0)\ t\ =\ 1.0;}
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ <\ 0.0)\ t\ =\ 0.0;}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordflow}{if}\ (t\ ==\ min\_dist)\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00175\ \ \ \ \ LPoint3\ intersection\_point\ =\ a\ +\ delta\ *\ t;}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{comment}{//\ Find\ the\ closest\ point\ on\ the\ box\ to\ the\ intersection\ point}}
\DoxyCodeLine{00177\ \ \ \ \ LPoint3\ p\ =\ intersection\_point.fmax(box\_min).fmin(box\_max);}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{double}\ dist\ =\ (p\ -\/\ intersection\_point).length\_squared();}
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{keywordflow}{if}\ (dist\ <\ min\_dist)\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \ \ min\_dist\ =\ dist;}
\DoxyCodeLine{00181\ \ \ \ \ \ \ closest\_point\ =\ p;}
\DoxyCodeLine{00182\ \ \ \ \ \}}
\DoxyCodeLine{00183\ \ \ \}}
\DoxyCodeLine{00184\ \ \ \textcolor{comment}{//\ Convert\ the\ closest\ point\ to\ the\ capsule's\ coordinate}}
\DoxyCodeLine{00185\ \ \ \textcolor{comment}{//\ space\ where\ the\ capsule\ is\ aligned\ with\ the\ y\ axis.}}
\DoxyCodeLine{00186\ \ \ closest\_point\ =\ closest\_point\ *\ wrt\_mat\ *\ \_inv\_mat;}
\DoxyCodeLine{00187\ \ \ a\ =\ \_a\ *\ \_inv\_mat;}
\DoxyCodeLine{00188\ \ \ b\ =\ \_b\ *\ \_inv\_mat;}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ Find\ the\ closest\ point\ on\ the\ line\ segment}}
\DoxyCodeLine{00191\ \ \ LPoint3\ point\_on\_segment;}
\DoxyCodeLine{00192\ \ \ point\_on\_segment[0]\ =\ a[0];}
\DoxyCodeLine{00193\ \ \ point\_on\_segment[2]\ =\ a[2];}
\DoxyCodeLine{00194\ \ \ \textcolor{keywordflow}{if}\ (closest\_point[1]\ <\ std::min(a[1],\ b[1]))\ \{}
\DoxyCodeLine{00195\ \ \ \ \ point\_on\_segment[1]\ =\ std::min(a[1],\ b[1]);}
\DoxyCodeLine{00196\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (closest\_point[1]\ >\ std::max(a[1],\ b[1]))\ \{}
\DoxyCodeLine{00197\ \ \ \ \ point\_on\_segment[1]\ =\ std::max(a[1],\ b[1]);}
\DoxyCodeLine{00198\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00199\ \ \ \ \ point\_on\_segment[1]\ =\ closest\_point[1];}
\DoxyCodeLine{00200\ \ \ \}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{if}\ ((closest\_point\ -\/\ point\_on\_segment).length\_squared()\ >\ \_radius\ *\ \_radius)\ \{}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00204\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00205\ \ \ \}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00208\ \ \ LVector3\ normal;}
\DoxyCodeLine{00209\ \ \ \textcolor{keywordflow}{if}\ (point\_on\_segment\ ==\ closest\_point)\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{comment}{//\ If\ the\ box\ directly\ intersects\ the\ line\ segment,\ use}}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{comment}{//\ the\ box's\ center\ to\ determine\ the\ surface\ normal.}}
\DoxyCodeLine{00212\ \ \ \ \ normal\ =\ (box-\/>get\_center()\ *\ wrt\_mat\ *\ \_inv\_mat)\ -\/\ point\_on\_segment;}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{keywordflow}{if}\ (closest\_point\ !=\ a\ \&\&\ closest\_point\ !=\ b)\ normal[1]\ =\ 0;}
\DoxyCodeLine{00214\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00215\ \ \ \ \ normal\ =\ (closest\_point\ -\/\ point\_on\_segment);}
\DoxyCodeLine{00216\ \ \ \}}
\DoxyCodeLine{00217\ \ \ normal.normalize();}
\DoxyCodeLine{00218\ \ \ LPoint3\ surface\_point\ =\ point\_on\_segment\ +\ normal\ *\ \_radius;}
\DoxyCodeLine{00219\ \ \ new\_entry-\/>set\_interior\_point(\_mat.xform\_point(closest\_point));}
\DoxyCodeLine{00220\ \ \ new\_entry-\/>set\_surface\_point(\_mat.xform\_point(surface\_point));}
\DoxyCodeLine{00221\ \ \ new\_entry-\/>set\_surface\_normal(\_mat.xform\_vec(normal));}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00223\ \}}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00228\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00229\ test\_intersection\_from\_sphere(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00230\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSphere}{CollisionSphere}}\ *sphere;}
\DoxyCodeLine{00231\ \ \ DCAST\_INTO\_R(sphere,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_space\ =\ entry.get\_wrt\_space();}
\DoxyCodeLine{00234\ \ \ CPT(\mbox{\hyperlink{classTransformState}{TransformState}})\ wrt\_prev\_space\ =\ entry.get\_wrt\_prev\_space();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ wrt\_space-\/>get\_mat();}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ LPoint3\ from\_a\ =\ sphere-\/>get\_center()\ *\ wrt\_mat;}
\DoxyCodeLine{00239\ \ \ LPoint3\ from\_b\ =\ from\_a;}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \ \ LPoint3\ contact\_point;}
\DoxyCodeLine{00242\ \ \ PN\_stdfloat\ actual\_t\ =\ 0.0f;}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ \textcolor{keywordflow}{if}\ (wrt\_prev\_space\ !=\ wrt\_space)\ \{}
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{comment}{//\ If\ the\ sphere\ is\ moving\ relative\ to\ the\ capsule,\ it\ becomes\ a\ capsule\ itself.}}
\DoxyCodeLine{00246\ \ \ \ \ from\_a\ =\ sphere-\/>get\_center()\ *\ wrt\_prev\_space-\/>get\_mat();}
\DoxyCodeLine{00247\ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00252\ \ \ \ \ LVector3(sphere-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00253\ \ \ PN\_stdfloat\ from\_radius\ =\ length(from\_radius\_v);}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00255\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00256\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_line(t1,\ t2,\ from\_a,\ from\_direction,\ from\_radius))\ \{}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00259\ \ \ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0\ ||\ t1\ >\ 1.0)\ \{}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ segment\ or\ after}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ the\ end\ of\ the\ segment.}}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00265\ \ \ \}}
\DoxyCodeLine{00266\ }
\DoxyCodeLine{00267\ \ \ \textcolor{comment}{//\ doubles,\ not\ floats,\ to\ satisfy\ min\ and\ max\ templates.}}
\DoxyCodeLine{00268\ \ \ actual\_t\ =\ std::min(1.0,\ std::max(0.0,\ t1));}
\DoxyCodeLine{00269\ \ \ contact\_point\ =\ from\_a\ +\ actual\_t\ *\ (from\_b\ -\/\ from\_a);}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00272\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00273\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00275\ \ \ \}}
\DoxyCodeLine{00276\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \ \ LPoint3\ into\_intersection\_point;}
\DoxyCodeLine{00279\ \ \ \textcolor{keywordflow}{if}\ (t2\ >\ 1.0)\ \{}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{comment}{//\ Point\ b\ is\ within\ the\ capsule.\ \ The\ first\ intersection\ point\ is\ point\ b}}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{comment}{//\ itself.}}
\DoxyCodeLine{00282\ \ \ \ \ into\_intersection\_point\ =\ from\_b;}
\DoxyCodeLine{00283\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{comment}{//\ Point\ b\ is\ outside\ the\ capsule,\ and\ point\ a\ is\ either\ inside\ the\ capsule\ or}}
\DoxyCodeLine{00285\ \ \ \ \ \textcolor{comment}{//\ beyond\ it.\ \ The\ first\ intersection\ point\ is\ at\ t2.}}
\DoxyCodeLine{00286\ \ \ \ \ into\_intersection\_point\ =\ from\_a\ +\ t2\ *\ from\_direction;}
\DoxyCodeLine{00287\ \ \ \}}
\DoxyCodeLine{00288\ \ \ set\_intersection\_point(new\_entry,\ into\_intersection\_point,\ from\_radius);}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ LPoint3\ fake\_contact\_point;}
\DoxyCodeLine{00291\ \ \ LVector3\ contact\_normal;}
\DoxyCodeLine{00292\ \ \ calculate\_surface\_point\_and\_normal(contact\_point,}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ from\_radius,}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fake\_contact\_point,}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ contact\_normal);}
\DoxyCodeLine{00296\ \ \ new\_entry-\/>set\_contact\_pos(contact\_point);}
\DoxyCodeLine{00297\ \ \ new\_entry-\/>set\_contact\_normal(contact\_normal);}
\DoxyCodeLine{00298\ \ \ new\_entry-\/>set\_t(actual\_t);}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00301\ \}}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00306\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00307\ test\_intersection\_from\_line(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00308\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionLine}{CollisionLine}}\ *line;}
\DoxyCodeLine{00309\ \ \ DCAST\_INTO\_R(line,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00310\ }
\DoxyCodeLine{00311\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00313\ \ \ LPoint3\ from\_origin\ =\ line-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00314\ \ \ LVector3\ from\_direction\ =\ line-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00317\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_line(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00318\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00320\ \ \ \}}
\DoxyCodeLine{00321\ }
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00323\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00324\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00325\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00326\ \ \ \}}
\DoxyCodeLine{00327\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \ \ LPoint3\ into\_intersection\_point\ =\ from\_origin\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00330\ \ \ set\_intersection\_point(new\_entry,\ into\_intersection\_point,\ 0.0);}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ line-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00333\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00334\ }
\DoxyCodeLine{00335\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00336\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ *\ \_inv\_mat;}
\DoxyCodeLine{00337\ \ \ \ \ \textcolor{keywordflow}{if}\ (normal[1]\ >\ \_length)\ \{}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ top\ endcap.}}
\DoxyCodeLine{00339\ \ \ \ \ \ \ normal[1]\ -\/=\ \_length;}
\DoxyCodeLine{00340\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (normal[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ cylinder\ body.}}
\DoxyCodeLine{00342\ \ \ \ \ \ \ normal[1]\ =\ 0;}
\DoxyCodeLine{00343\ \ \ \ \ \}}
\DoxyCodeLine{00344\ \ \ \ \ normal\ =\ normalize(normal\ *\ \_mat);}
\DoxyCodeLine{00345\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00346\ \ \ \}}
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00349\ \}}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00354\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00355\ test\_intersection\_from\_ray(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00356\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionRay}{CollisionRay}}\ *ray;}
\DoxyCodeLine{00357\ \ \ DCAST\_INTO\_R(ray,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ LPoint3\ from\_origin\ =\ ray-\/>get\_origin()\ *\ wrt\_mat;}
\DoxyCodeLine{00362\ \ \ LVector3\ from\_direction\ =\ ray-\/>get\_direction()\ *\ wrt\_mat;}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00365\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_line(t1,\ t2,\ from\_origin,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00367\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00368\ \ \ \}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0)\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ ray.}}
\DoxyCodeLine{00372\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00373\ \ \ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00376\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00377\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00378\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00379\ \ \ \}}
\DoxyCodeLine{00380\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ LPoint3\ into\_intersection\_point;}
\DoxyCodeLine{00383\ \ \ \textcolor{keywordflow}{if}\ (t1\ <\ 0.0)\ \{}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ within\ the\ capsule.\ \ The\ first\ intersection\ point\ is\ point\ a}}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{comment}{//\ itself.}}
\DoxyCodeLine{00386\ \ \ \ \ into\_intersection\_point\ =\ from\_origin;}
\DoxyCodeLine{00387\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ outside\ the\ capsule.\ \ The\ first\ intersection\ point\ is\ at\ t1.}}
\DoxyCodeLine{00389\ \ \ \ \ into\_intersection\_point\ =\ from\_origin\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00390\ \ \ \}}
\DoxyCodeLine{00391\ \ \ set\_intersection\_point(new\_entry,\ into\_intersection\_point,\ 0.0);}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ ray-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00394\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00397\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ *\ \_inv\_mat;}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{keywordflow}{if}\ (normal[1]\ >\ \_length)\ \{}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ top\ endcap.}}
\DoxyCodeLine{00400\ \ \ \ \ \ \ normal[1]\ -\/=\ \_length;}
\DoxyCodeLine{00401\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (normal[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{00402\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ cylinder\ body.}}
\DoxyCodeLine{00403\ \ \ \ \ \ \ normal[1]\ =\ 0;}
\DoxyCodeLine{00404\ \ \ \ \ \}}
\DoxyCodeLine{00405\ \ \ \ \ normal\ =\ normalize(normal\ *\ \_mat);}
\DoxyCodeLine{00406\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00407\ \ \ \}}
\DoxyCodeLine{00408\ }
\DoxyCodeLine{00409\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00410\ \}}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00415\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00416\ test\_intersection\_from\_segment(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00417\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionSegment}{CollisionSegment}}\ *segment;}
\DoxyCodeLine{00418\ \ \ DCAST\_INTO\_R(segment,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ LPoint3\ from\_a\ =\ segment-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00423\ \ \ LPoint3\ from\_b\ =\ segment-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00424\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ \textcolor{keywordtype}{double}\ t1,\ t2;}
\DoxyCodeLine{00427\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_line(t1,\ t2,\ from\_a,\ from\_direction,\ 0.0f))\ \{}
\DoxyCodeLine{00428\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00429\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00430\ \ \ \}}
\DoxyCodeLine{00431\ }
\DoxyCodeLine{00432\ \ \ \textcolor{keywordflow}{if}\ (t2\ <\ 0.0\ ||\ t1\ >\ 1.0)\ \{}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ Both\ intersection\ points\ are\ before\ the\ start\ of\ the\ segment\ or\ after}}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{comment}{//\ the\ end\ of\ the\ segment.}}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00436\ \ \ \}}
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00439\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00440\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00441\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00442\ \ \ \}}
\DoxyCodeLine{00443\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00444\ }
\DoxyCodeLine{00445\ \ \ LPoint3\ into\_intersection\_point;}
\DoxyCodeLine{00446\ \ \ \textcolor{keywordflow}{if}\ (t1\ <\ 0.0)\ \{}
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ within\ the\ capsule.\ \ The\ first\ intersection\ point\ is\ point\ a}}
\DoxyCodeLine{00448\ \ \ \ \ \textcolor{comment}{//\ itself.}}
\DoxyCodeLine{00449\ \ \ \ \ into\_intersection\_point\ =\ from\_a;}
\DoxyCodeLine{00450\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00451\ \ \ \ \ \textcolor{comment}{//\ Point\ a\ is\ outside\ the\ capsule,\ and\ point\ b\ is\ either\ inside\ the\ capsule\ or}}
\DoxyCodeLine{00452\ \ \ \ \ \textcolor{comment}{//\ beyond\ it.\ \ The\ first\ intersection\ point\ is\ at\ t1.}}
\DoxyCodeLine{00453\ \ \ \ \ into\_intersection\_point\ =\ from\_a\ +\ t1\ *\ from\_direction;}
\DoxyCodeLine{00454\ \ \ \}}
\DoxyCodeLine{00455\ \ \ set\_intersection\_point(new\_entry,\ into\_intersection\_point,\ 0.0);}
\DoxyCodeLine{00456\ }
\DoxyCodeLine{00457\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ segment-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00458\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00459\ }
\DoxyCodeLine{00460\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00461\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ *\ \_inv\_mat;}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{keywordflow}{if}\ (normal[1]\ >\ \_length)\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ top\ endcap.}}
\DoxyCodeLine{00464\ \ \ \ \ \ \ normal[1]\ -\/=\ \_length;}
\DoxyCodeLine{00465\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (normal[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ cylinder\ body.}}
\DoxyCodeLine{00467\ \ \ \ \ \ \ normal[1]\ =\ 0;}
\DoxyCodeLine{00468\ \ \ \ \ \}}
\DoxyCodeLine{00469\ \ \ \ \ normal\ =\ normalize(normal\ *\ \_mat);}
\DoxyCodeLine{00470\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00471\ \ \ \}}
\DoxyCodeLine{00472\ }
\DoxyCodeLine{00473\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00474\ \}}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00479\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00480\ test\_intersection\_from\_capsule(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00481\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}\ *capsule;}
\DoxyCodeLine{00482\ \ \ DCAST\_INTO\_R(capsule,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \ \ LPoint3\ into\_a\ =\ \_a;}
\DoxyCodeLine{00485\ \ \ LVector3\ into\_direction\ =\ \_b\ -\/\ into\_a;}
\DoxyCodeLine{00486\ }
\DoxyCodeLine{00487\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \ \ LPoint3\ from\_a\ =\ capsule-\/>get\_point\_a()\ *\ wrt\_mat;}
\DoxyCodeLine{00490\ \ \ LPoint3\ from\_b\ =\ capsule-\/>get\_point\_b()\ *\ wrt\_mat;}
\DoxyCodeLine{00491\ \ \ LVector3\ from\_direction\ =\ from\_b\ -\/\ from\_a;}
\DoxyCodeLine{00492\ }
\DoxyCodeLine{00493\ \ \ LVector3\ from\_radius\_v\ =}
\DoxyCodeLine{00494\ \ \ \ \ LVector3(capsule-\/>get\_radius(),\ 0.0f,\ 0.0f)\ *\ wrt\_mat;}
\DoxyCodeLine{00495\ \ \ PN\_stdfloat\ from\_radius\ =\ length(from\_radius\_v);}
\DoxyCodeLine{00496\ }
\DoxyCodeLine{00497\ \ \ \textcolor{comment}{//\ Determine\ the\ points\ on\ each\ segment\ with\ the\ smallest\ distance\ between.}}
\DoxyCodeLine{00498\ \ \ \textcolor{keywordtype}{double}\ into\_t,\ from\_t;}
\DoxyCodeLine{00499\ \ \ calc\_closest\_segment\_points(into\_t,\ from\_t,}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ into\_a,\ into\_direction,}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ from\_a,\ from\_direction);}
\DoxyCodeLine{00502\ \ \ LPoint3\ into\_closest\ =\ into\_a\ +\ into\_direction\ *\ into\_t;}
\DoxyCodeLine{00503\ \ \ LPoint3\ from\_closest\ =\ from\_a\ +\ from\_direction\ *\ from\_t;}
\DoxyCodeLine{00504\ }
\DoxyCodeLine{00505\ \ \ \textcolor{comment}{//\ If\ the\ distance\ is\ greater\ than\ the\ sum\ of\ capsule\ radii,\ the\ test\ fails.}}
\DoxyCodeLine{00506\ \ \ LVector3\ closest\_vec\ =\ from\_closest\ -\/\ into\_closest;}
\DoxyCodeLine{00507\ \ \ PN\_stdfloat\ distance\ =\ closest\_vec.length();}
\DoxyCodeLine{00508\ \ \ \textcolor{keywordflow}{if}\ (distance\ >\ \_radius\ +\ from\_radius)\ \{}
\DoxyCodeLine{00509\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00510\ \ \ \}}
\DoxyCodeLine{00511\ }
\DoxyCodeLine{00512\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00513\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00514\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00515\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00516\ \ \ \}}
\DoxyCodeLine{00517\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \ \ \textcolor{keywordflow}{if}\ (distance\ !=\ 0)\ \{}
\DoxyCodeLine{00520\ \ \ \ \ \textcolor{comment}{//\ This\ is\ the\ most\ common\ case,\ where\ the\ line\ segments\ don't\ touch}}
\DoxyCodeLine{00521\ \ \ \ \ \textcolor{comment}{//\ exactly.\ \ We\ point\ the\ normal\ along\ the\ vector\ of\ the\ closest\ distance.}}
\DoxyCodeLine{00522\ \ \ \ \ LVector3\ surface\_normal\ =\ closest\_vec\ *\ (1.0\ /\ distance);}
\DoxyCodeLine{00523\ }
\DoxyCodeLine{00524\ \ \ \ \ new\_entry-\/>set\_surface\_point(into\_closest\ +\ surface\_normal\ *\ \_radius);}
\DoxyCodeLine{00525\ \ \ \ \ new\_entry-\/>set\_interior\_point(from\_closest\ -\/\ surface\_normal\ *\ from\_radius);}
\DoxyCodeLine{00526\ }
\DoxyCodeLine{00527\ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ capsule-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00529\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (distance\ !=\ 0)\ \{}
\DoxyCodeLine{00530\ \ \ \ \ \ \ new\_entry-\/>set\_surface\_normal(surface\_normal);}
\DoxyCodeLine{00531\ \ \ \ \ \}}
\DoxyCodeLine{00532\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00533\ \ \ \ \ \textcolor{comment}{//\ The\ rare\ case\ of\ the\ line\ segments\ touching\ exactly.}}
\DoxyCodeLine{00534\ \ \ \ \ set\_intersection\_point(new\_entry,\ into\_closest,\ 0);}
\DoxyCodeLine{00535\ \ \ \}}
\DoxyCodeLine{00536\ }
\DoxyCodeLine{00537\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00538\ \}}
\DoxyCodeLine{00539\ }
\DoxyCodeLine{00543\ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ CollisionCapsule::}
\DoxyCodeLine{00544\ test\_intersection\_from\_parabola(\textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ \&entry)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00545\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classCollisionParabola}{CollisionParabola}}\ *parabola;}
\DoxyCodeLine{00546\ \ \ DCAST\_INTO\_R(parabola,\ entry.get\_from(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00547\ }
\DoxyCodeLine{00548\ \ \ \textcolor{keyword}{const}\ LMatrix4\ \&wrt\_mat\ =\ entry.get\_wrt\_mat();}
\DoxyCodeLine{00549\ }
\DoxyCodeLine{00550\ \ \ \textcolor{comment}{//\ Convert\ the\ parabola\ into\ local\ coordinate\ space.}}
\DoxyCodeLine{00551\ \ \ LParabola\ local\_p(parabola-\/>get\_parabola());}
\DoxyCodeLine{00552\ \ \ local\_p.xform(wrt\_mat);}
\DoxyCodeLine{00553\ }
\DoxyCodeLine{00554\ \ \ \textcolor{keywordtype}{double}\ t;}
\DoxyCodeLine{00555\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_parabola(t,\ local\_p,\ parabola-\/>get\_t1(),\ parabola-\/>get\_t2(),}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t1()),}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ local\_p.calc\_point(parabola-\/>get\_t2())))\ \{}
\DoxyCodeLine{00558\ \ \ \ \ \textcolor{comment}{//\ No\ intersection.}}
\DoxyCodeLine{00559\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00560\ \ \ \}}
\DoxyCodeLine{00561\ }
\DoxyCodeLine{00562\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00563\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00564\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}intersection\ detected\ from\ "{}}\ <<\ entry.get\_from\_node\_path()}
\DoxyCodeLine{00565\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ into\ "{}}\ <<\ entry.get\_into\_node\_path()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00566\ \ \ \}}
\DoxyCodeLine{00567\ \ \ PT(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}})\ new\_entry\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}(entry);}
\DoxyCodeLine{00568\ }
\DoxyCodeLine{00569\ \ \ LPoint3\ into\_intersection\_point\ =\ local\_p.calc\_point(t);}
\DoxyCodeLine{00570\ \ \ set\_intersection\_point(new\_entry,\ into\_intersection\_point,\ 0.0);}
\DoxyCodeLine{00571\ }
\DoxyCodeLine{00572\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ parabola-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{00573\ \ \ \ \ new\_entry-\/>set\_surface\_normal(get\_effective\_normal());}
\DoxyCodeLine{00574\ }
\DoxyCodeLine{00575\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00576\ \ \ \ \ LVector3\ normal\ =\ into\_intersection\_point\ *\ \_inv\_mat;}
\DoxyCodeLine{00577\ \ \ \ \ \textcolor{keywordflow}{if}\ (normal[1]\ >\ \_length)\ \{}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ top\ endcap.}}
\DoxyCodeLine{00579\ \ \ \ \ \ \ normal[1]\ -\/=\ \_length;}
\DoxyCodeLine{00580\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (normal[1]\ >\ 0.0f)\ \{}
\DoxyCodeLine{00581\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ cylinder\ body.}}
\DoxyCodeLine{00582\ \ \ \ \ \ \ normal[1]\ =\ 0;}
\DoxyCodeLine{00583\ \ \ \ \ \}}
\DoxyCodeLine{00584\ \ \ \ \ normal\ =\ normalize(normal\ *\ \_mat);}
\DoxyCodeLine{00585\ \ \ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{00586\ \ \ \}}
\DoxyCodeLine{00587\ }
\DoxyCodeLine{00588\ \ \ \textcolor{keywordflow}{return}\ new\_entry;}
\DoxyCodeLine{00589\ \}}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00595\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionCapsule_a0ecb257926cf7ea17ce7e93996390999}{CollisionCapsule::}}}
\DoxyCodeLine{00596\ \mbox{\hyperlink{classCollisionCapsule_a0ecb257926cf7ea17ce7e93996390999}{fill\_viz\_geom}}()\ \{}
\DoxyCodeLine{00597\ \ \ \textcolor{keywordflow}{if}\ (collide\_cat.is\_debug())\ \{}
\DoxyCodeLine{00598\ \ \ \ \ collide\_cat.debug()}
\DoxyCodeLine{00599\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Recomputing\ viz\ for\ "{}}\ <<\ *\textcolor{keyword}{this}\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00600\ \ \ \}}
\DoxyCodeLine{00601\ }
\DoxyCodeLine{00602\ \ \ \textcolor{comment}{//\ Generate\ the\ vertices\ such\ that\ we\ draw\ a\ capsule\ with\ one\ endpoint\ at\ (0,}}
\DoxyCodeLine{00603\ \ \ \textcolor{comment}{//\ 0,\ 0),\ and\ another\ at\ (0,\ length,\ 0).\ \ Then\ we'll\ rotate\ and\ translate\ it}}
\DoxyCodeLine{00604\ \ \ \textcolor{comment}{//\ into\ place\ with\ the\ appropriate\ look\_at\ matrix.}}
\DoxyCodeLine{00605\ \ \ LVector3\ direction\ =\ (\_b\ -\/\ \_a);}
\DoxyCodeLine{00606\ \ \ PN\_stdfloat\ length\ =\ direction.length();}
\DoxyCodeLine{00607\ }
\DoxyCodeLine{00608\ \ \ PT(\mbox{\hyperlink{classGeomVertexData}{GeomVertexData}})\ vdata\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomVertexData}{GeomVertexData}}}
\DoxyCodeLine{00609\ \ \ \ \ (\textcolor{stringliteral}{"{}collision"{}},\ GeomVertexFormat::get\_v3(),}
\DoxyCodeLine{00610\ \ \ \ \ \ Geom::UH\_static);}
\DoxyCodeLine{00611\ \ \ \mbox{\hyperlink{classGeomVertexWriter}{GeomVertexWriter}}\ vertex(vdata,\ InternalName::get\_vertex());}
\DoxyCodeLine{00612\ }
\DoxyCodeLine{00613\ \ \ PT(\mbox{\hyperlink{classGeomTristrips}{GeomTristrips}})\ strip\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeomTristrips}{GeomTristrips}}(Geom::UH\_static);}
\DoxyCodeLine{00614\ \ \ \textcolor{comment}{//\ Generate\ the\ first\ endcap.}}
\DoxyCodeLine{00615\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_slices\ =\ 8;}
\DoxyCodeLine{00616\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_rings\ =\ 4;}
\DoxyCodeLine{00617\ \ \ \textcolor{keywordtype}{int}\ ri,\ si;}
\DoxyCodeLine{00618\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ 0;\ ri\ <\ num\_rings;\ ri++)\ \{}
\DoxyCodeLine{00619\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <=\ num\_slices;\ si++)\ \{}
\DoxyCodeLine{00620\ \ \ \ \ \ \ vertex.add\_data3(calc\_sphere1\_vertex(ri,\ si,\ num\_rings,\ num\_slices));}
\DoxyCodeLine{00621\ \ \ \ \ \ \ vertex.add\_data3(calc\_sphere1\_vertex(ri\ +\ 1,\ si,\ num\_rings,\ num\_slices));}
\DoxyCodeLine{00622\ \ \ \ \ \}}
\DoxyCodeLine{00623\ \ \ \ \ strip-\/>add\_next\_vertices((num\_slices\ +\ 1)\ *\ 2);}
\DoxyCodeLine{00624\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00625\ \ \ \}}
\DoxyCodeLine{00626\ }
\DoxyCodeLine{00627\ \ \ \textcolor{comment}{//\ Now\ the\ cylinder\ sides.}}
\DoxyCodeLine{00628\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <=\ num\_slices;\ si++)\ \{}
\DoxyCodeLine{00629\ \ \ \ \ vertex.add\_data3(calc\_sphere1\_vertex(num\_rings,\ si,\ num\_rings,\ num\_slices));}
\DoxyCodeLine{00630\ \ \ \ \ vertex.add\_data3(calc\_sphere2\_vertex(num\_rings,\ si,\ num\_rings,\ num\_slices,}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ length));}
\DoxyCodeLine{00632\ \ \ \}}
\DoxyCodeLine{00633\ \ \ strip-\/>add\_next\_vertices((num\_slices\ +\ 1)\ *\ 2);}
\DoxyCodeLine{00634\ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00635\ }
\DoxyCodeLine{00636\ \ \ \textcolor{comment}{//\ And\ the\ second\ endcap.}}
\DoxyCodeLine{00637\ \ \ \textcolor{keywordflow}{for}\ (ri\ =\ num\_rings\ -\/\ 1;\ ri\ >=\ 0;\ ri-\/-\/)\ \{}
\DoxyCodeLine{00638\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ 0;\ si\ <=\ num\_slices;\ si++)\ \{}
\DoxyCodeLine{00639\ \ \ \ \ \ \ vertex.add\_data3(calc\_sphere2\_vertex(ri\ +\ 1,\ si,\ num\_rings,\ num\_slices,\ length));}
\DoxyCodeLine{00640\ \ \ \ \ \ \ vertex.add\_data3(calc\_sphere2\_vertex(ri,\ si,\ num\_rings,\ num\_slices,\ length));}
\DoxyCodeLine{00641\ \ \ \ \ \}}
\DoxyCodeLine{00642\ \ \ \ \ strip-\/>add\_next\_vertices((num\_slices\ +\ 1)\ *\ 2);}
\DoxyCodeLine{00643\ \ \ \ \ strip-\/>close\_primitive();}
\DoxyCodeLine{00644\ \ \ \}}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00646\ \ \ PT(\mbox{\hyperlink{classGeom}{Geom}})\ geom\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classGeom}{Geom}}(vdata);}
\DoxyCodeLine{00647\ \ \ geom-\/>add\_primitive(strip);}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \ \ \textcolor{comment}{//\ Now\ transform\ the\ vertices\ to\ their\ actual\ location.}}
\DoxyCodeLine{00650\ \ \ LMatrix4\ mat;}
\DoxyCodeLine{00651\ \ \ \mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}}(mat,\ direction,\ LVector3(0.0f,\ 0.0f,\ 1.0f),\ CS\_zup\_right);}
\DoxyCodeLine{00652\ \ \ mat.set\_row(3,\ \_a);}
\DoxyCodeLine{00653\ \ \ geom-\/>transform\_vertices(mat);}
\DoxyCodeLine{00654\ }
\DoxyCodeLine{00655\ \ \ \_viz\_geom-\/>add\_geom(geom,\ get\_solid\_viz\_state());}
\DoxyCodeLine{00656\ \ \ \_bounds\_viz\_geom-\/>add\_geom(geom,\ get\_solid\_bounds\_viz\_state());}
\DoxyCodeLine{00657\ \}}
\DoxyCodeLine{00658\ }
\DoxyCodeLine{00663\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{00664\ recalc\_internals()\ \{}
\DoxyCodeLine{00665\ \ \ LVector3\ direction\ =\ (\_b\ -\/\ \_a);}
\DoxyCodeLine{00666\ \ \ \_length\ =\ direction.length();}
\DoxyCodeLine{00667\ }
\DoxyCodeLine{00668\ \ \ \mbox{\hyperlink{look__at__src_8cxx_a4e167e03dc5f1fd42ee705272d9a47a9}{look\_at}}(\_mat,\ direction,\ LVector3(0.0f,\ 0.0f,\ 1.0f),\ CS\_zup\_right);}
\DoxyCodeLine{00669\ \ \ \_mat.set\_row(3,\ \_a);}
\DoxyCodeLine{00670\ \ \ \_inv\_mat.invert\_from(\_mat);}
\DoxyCodeLine{00671\ }
\DoxyCodeLine{00672\ \ \ mark\_viz\_stale();}
\DoxyCodeLine{00673\ \ \ mark\_internal\_bounds\_stale();}
\DoxyCodeLine{00674\ \}}
\DoxyCodeLine{00675\ }
\DoxyCodeLine{00680\ LVertex\ CollisionCapsule::}
\DoxyCodeLine{00681\ calc\_sphere1\_vertex(\textcolor{keywordtype}{int}\ ri,\ \textcolor{keywordtype}{int}\ si,\ \textcolor{keywordtype}{int}\ num\_rings,\ \textcolor{keywordtype}{int}\ num\_slices)\ \{}
\DoxyCodeLine{00682\ \ \ PN\_stdfloat\ r\ =\ (PN\_stdfloat)ri\ /\ (PN\_stdfloat)num\_rings;}
\DoxyCodeLine{00683\ \ \ PN\_stdfloat\ s\ =\ (PN\_stdfloat)si\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00684\ }
\DoxyCodeLine{00685\ \ \ \textcolor{comment}{//\ Find\ the\ point\ on\ the\ rim,\ based\ on\ the\ slice.}}
\DoxyCodeLine{00686\ \ \ PN\_stdfloat\ theta\ =\ s\ *\ 2.0f\ *\ MathNumbers::pi;}
\DoxyCodeLine{00687\ \ \ PN\_stdfloat\ x\_rim\ =\ ccos(theta);}
\DoxyCodeLine{00688\ \ \ PN\_stdfloat\ z\_rim\ =\ csin(theta);}
\DoxyCodeLine{00689\ }
\DoxyCodeLine{00690\ \ \ \textcolor{comment}{//\ Now\ pull\ that\ point\ in\ towards\ the\ pole,\ based\ on\ the\ ring.}}
\DoxyCodeLine{00691\ \ \ PN\_stdfloat\ phi\ =\ r\ *\ 0.5f\ *\ MathNumbers::pi;}
\DoxyCodeLine{00692\ \ \ PN\_stdfloat\ to\_pole\ =\ csin(phi);}
\DoxyCodeLine{00693\ }
\DoxyCodeLine{00694\ \ \ PN\_stdfloat\ x\ =\ \_radius\ *\ x\_rim\ *\ to\_pole;}
\DoxyCodeLine{00695\ \ \ PN\_stdfloat\ y\ =\ -\/\_radius\ *\ ccos(phi);}
\DoxyCodeLine{00696\ \ \ PN\_stdfloat\ z\ =\ \_radius\ *\ z\_rim\ *\ to\_pole;}
\DoxyCodeLine{00697\ }
\DoxyCodeLine{00698\ \ \ \textcolor{keywordflow}{return}\ LVertex(x,\ y,\ z);}
\DoxyCodeLine{00699\ \}}
\DoxyCodeLine{00700\ }
\DoxyCodeLine{00705\ LVertex\ CollisionCapsule::}
\DoxyCodeLine{00706\ calc\_sphere2\_vertex(\textcolor{keywordtype}{int}\ ri,\ \textcolor{keywordtype}{int}\ si,\ \textcolor{keywordtype}{int}\ num\_rings,\ \textcolor{keywordtype}{int}\ num\_slices,}
\DoxyCodeLine{00707\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ length)\ \{}
\DoxyCodeLine{00708\ \ \ PN\_stdfloat\ r\ =\ (PN\_stdfloat)ri\ /\ (PN\_stdfloat)num\_rings;}
\DoxyCodeLine{00709\ \ \ PN\_stdfloat\ s\ =\ (PN\_stdfloat)si\ /\ (PN\_stdfloat)num\_slices;}
\DoxyCodeLine{00710\ }
\DoxyCodeLine{00711\ \ \ \textcolor{comment}{//\ Find\ the\ point\ on\ the\ rim,\ based\ on\ the\ slice.}}
\DoxyCodeLine{00712\ \ \ PN\_stdfloat\ theta\ =\ s\ *\ 2.0f\ *\ MathNumbers::pi;}
\DoxyCodeLine{00713\ \ \ PN\_stdfloat\ x\_rim\ =\ ccos(theta);}
\DoxyCodeLine{00714\ \ \ PN\_stdfloat\ z\_rim\ =\ csin(theta);}
\DoxyCodeLine{00715\ }
\DoxyCodeLine{00716\ \ \ \textcolor{comment}{//\ Now\ pull\ that\ point\ in\ towards\ the\ pole,\ based\ on\ the\ ring.}}
\DoxyCodeLine{00717\ \ \ PN\_stdfloat\ phi\ =\ r\ *\ 0.5f\ *\ MathNumbers::pi;}
\DoxyCodeLine{00718\ \ \ PN\_stdfloat\ to\_pole\ =\ csin(phi);}
\DoxyCodeLine{00719\ }
\DoxyCodeLine{00720\ \ \ PN\_stdfloat\ x\ =\ \_radius\ *\ x\_rim\ *\ to\_pole;}
\DoxyCodeLine{00721\ \ \ PN\_stdfloat\ y\ =\ length\ +\ \_radius\ *\ ccos(phi);}
\DoxyCodeLine{00722\ \ \ PN\_stdfloat\ z\ =\ \_radius\ *\ z\_rim\ *\ to\_pole;}
\DoxyCodeLine{00723\ }
\DoxyCodeLine{00724\ \ \ \textcolor{keywordflow}{return}\ LVertex(x,\ y,\ z);}
\DoxyCodeLine{00725\ \}}
\DoxyCodeLine{00726\ }
\DoxyCodeLine{00731\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{00732\ calc\_closest\_segment\_points(\textcolor{keywordtype}{double}\ \&t1,\ \textcolor{keywordtype}{double}\ \&t2,}
\DoxyCodeLine{00733\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&from1,\ \textcolor{keyword}{const}\ LVector3\ \&delta1,}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&from2,\ \textcolor{keyword}{const}\ LVector3\ \&delta2)\ \{}
\DoxyCodeLine{00735\ \ \ \textcolor{comment}{//\ Copyright\ 2001\ softSurfer,\ 2012\ Dan\ Sunday}}
\DoxyCodeLine{00736\ \ \ \textcolor{comment}{//\ This\ code\ may\ be\ freely\ used,\ distributed\ and\ modified\ for\ any\ purpose}}
\DoxyCodeLine{00737\ \ \ \textcolor{comment}{//\ providing\ that\ this\ copyright\ notice\ is\ included\ with\ it.}}
\DoxyCodeLine{00738\ \ \ \textcolor{comment}{//\ SoftSurfer\ makes\ no\ warranty\ for\ this\ code,\ and\ cannot\ be\ held}}
\DoxyCodeLine{00739\ \ \ \textcolor{comment}{//\ liable\ for\ any\ real\ or\ imagined\ damage\ resulting\ from\ its\ use.}}
\DoxyCodeLine{00740\ \ \ \textcolor{comment}{//\ Users\ of\ this\ code\ must\ verify\ correctness\ for\ their\ application.}}
\DoxyCodeLine{00741\ \ \ LVector3\ w\ =\ from1\ -\/\ from2;}
\DoxyCodeLine{00742\ \ \ PN\_stdfloat\ a\ =\ delta1.dot(delta1);\ \textcolor{comment}{//\ always\ >=\ 0}}
\DoxyCodeLine{00743\ \ \ PN\_stdfloat\ b\ =\ delta1.dot(delta2);}
\DoxyCodeLine{00744\ \ \ PN\_stdfloat\ c\ =\ delta2.dot(delta2);\ \textcolor{comment}{//\ always\ >=\ 0}}
\DoxyCodeLine{00745\ \ \ PN\_stdfloat\ d\ =\ delta1.dot(w);}
\DoxyCodeLine{00746\ \ \ PN\_stdfloat\ e\ =\ delta2.dot(w);}
\DoxyCodeLine{00747\ \ \ PN\_stdfloat\ D\ =\ a\ *\ c\ -\/\ b\ *\ b;\ \textcolor{comment}{//\ always\ >=\ 0}}
\DoxyCodeLine{00748\ \ \ PN\_stdfloat\ sN,\ sD\ =\ D;}
\DoxyCodeLine{00749\ \ \ PN\_stdfloat\ tN,\ tD\ =\ D;}
\DoxyCodeLine{00750\ }
\DoxyCodeLine{00751\ \ \ \textcolor{comment}{//\ compute\ the\ line\ parameters\ of\ the\ two\ closest\ points}}
\DoxyCodeLine{00752\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(D))\ \{\ \textcolor{comment}{//\ the\ lines\ are\ almost\ parallel}}
\DoxyCodeLine{00753\ \ \ \ \ sN\ =\ 0.0;\ \textcolor{comment}{//\ force\ using\ point\ P0\ on\ segment\ S1}}
\DoxyCodeLine{00754\ \ \ \ \ sD\ =\ 1.0;\ \textcolor{comment}{//\ to\ prevent\ possible\ division\ by\ 0.0\ later}}
\DoxyCodeLine{00755\ \ \ \ \ tN\ =\ e;}
\DoxyCodeLine{00756\ \ \ \ \ tD\ =\ c;}
\DoxyCodeLine{00757\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00758\ \ \ \ \ \textcolor{comment}{//\ get\ the\ closest\ points\ on\ the\ infinite\ lines}}
\DoxyCodeLine{00759\ \ \ \ \ sN\ =\ (b*e\ -\/\ c*d);}
\DoxyCodeLine{00760\ \ \ \ \ tN\ =\ (a*e\ -\/\ b*d);}
\DoxyCodeLine{00761\ \ \ \ \ \textcolor{keywordflow}{if}\ (sN\ <\ 0.0)\ \{\ \textcolor{comment}{//\ sc\ <\ 0\ =>\ the\ s=0\ edge\ is\ visible}}
\DoxyCodeLine{00762\ \ \ \ \ \ \ sN\ =\ 0.0;}
\DoxyCodeLine{00763\ \ \ \ \ \ \ tN\ =\ e;}
\DoxyCodeLine{00764\ \ \ \ \ \ \ tD\ =\ c;}
\DoxyCodeLine{00765\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (sN\ >\ sD)\ \{\ \textcolor{comment}{//\ sc\ >\ 1\ \ =>\ the\ s=1\ edge\ is\ visible}}
\DoxyCodeLine{00766\ \ \ \ \ \ \ sN\ =\ sD;}
\DoxyCodeLine{00767\ \ \ \ \ \ \ tN\ =\ e\ +\ b;}
\DoxyCodeLine{00768\ \ \ \ \ \ \ tD\ =\ c;}
\DoxyCodeLine{00769\ \ \ \ \ \}}
\DoxyCodeLine{00770\ \ \ \}}
\DoxyCodeLine{00771\ }
\DoxyCodeLine{00772\ \ \ \textcolor{keywordflow}{if}\ (tN\ <\ 0.0)\ \{\ \textcolor{comment}{//\ tc\ <\ 0\ =>\ the\ t=0\ edge\ is\ visible}}
\DoxyCodeLine{00773\ \ \ \ \ tN\ =\ 0.0;}
\DoxyCodeLine{00774\ \ \ \ \ \textcolor{comment}{//\ recompute\ sc\ for\ this\ edge}}
\DoxyCodeLine{00775\ \ \ \ \ \textcolor{keywordflow}{if}\ (-\/d\ <\ 0.0)\ \{}
\DoxyCodeLine{00776\ \ \ \ \ \ \ sN\ =\ 0.0;}
\DoxyCodeLine{00777\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (-\/d\ >\ a)\ \{}
\DoxyCodeLine{00778\ \ \ \ \ \ \ sN\ =\ sD;}
\DoxyCodeLine{00779\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00780\ \ \ \ \ \ \ sN\ =\ -\/d;}
\DoxyCodeLine{00781\ \ \ \ \ \ \ sD\ =\ a;}
\DoxyCodeLine{00782\ \ \ \ \ \}}
\DoxyCodeLine{00783\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (tN\ >\ tD)\ \{\ \textcolor{comment}{//\ tc\ >\ 1\ \ =>\ the\ t=1\ edge\ is\ visible}}
\DoxyCodeLine{00784\ \ \ \ \ tN\ =\ tD;}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{comment}{//\ recompute\ sc\ for\ this\ edge}}
\DoxyCodeLine{00786\ \ \ \ \ \textcolor{keywordflow}{if}\ ((-\/d\ +\ b)\ <\ 0.0)\ \{}
\DoxyCodeLine{00787\ \ \ \ \ \ \ sN\ =\ 0;}
\DoxyCodeLine{00788\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ ((-\/d\ +\ b)\ >\ a)\ \{}
\DoxyCodeLine{00789\ \ \ \ \ \ \ sN\ =\ sD;}
\DoxyCodeLine{00790\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00791\ \ \ \ \ \ \ sN\ =\ (-\/d\ +\ \ b);}
\DoxyCodeLine{00792\ \ \ \ \ \ \ sD\ =\ a;}
\DoxyCodeLine{00793\ \ \ \ \ \}}
\DoxyCodeLine{00794\ \ \ \}}
\DoxyCodeLine{00795\ }
\DoxyCodeLine{00796\ \ \ \textcolor{comment}{//\ finally\ do\ the\ division\ to\ get\ sc\ and\ tc}}
\DoxyCodeLine{00797\ \ \ t1\ =\ (IS\_NEARLY\_ZERO(sN)\ ?\ 0.0\ :\ sN\ /\ sD);}
\DoxyCodeLine{00798\ \ \ t2\ =\ (IS\_NEARLY\_ZERO(tN)\ ?\ 0.0\ :\ tN\ /\ tD);}
\DoxyCodeLine{00799\ \}}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00809\ \textcolor{keywordtype}{bool}\ CollisionCapsule::}
\DoxyCodeLine{00810\ intersects\_line(\textcolor{keywordtype}{double}\ \&t1,\ \textcolor{keywordtype}{double}\ \&t2,}
\DoxyCodeLine{00811\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&from0,\ \textcolor{keyword}{const}\ LVector3\ \&delta0,}
\DoxyCodeLine{00812\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ inflate\_radius)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00813\ \ \ \textcolor{comment}{//\ Convert\ the\ line\ into\ our\ canonical\ coordinate\ space:\ the\ capsule\ is\ aligned}}
\DoxyCodeLine{00814\ \ \ \textcolor{comment}{//\ with\ the\ y\ axis.}}
\DoxyCodeLine{00815\ \ \ LPoint3\ from\ =\ from0\ *\ \_inv\_mat;}
\DoxyCodeLine{00816\ \ \ LVector3\ delta\ =\ delta0\ *\ \_inv\_mat;}
\DoxyCodeLine{00817\ }
\DoxyCodeLine{00818\ \ \ PN\_stdfloat\ radius\ =\ \_radius\ +\ inflate\_radius;}
\DoxyCodeLine{00819\ }
\DoxyCodeLine{00820\ \ \ \textcolor{comment}{//\ Now\ project\ the\ line\ into\ the\ X-\/Z\ plane\ to\ test\ for\ intersection\ with\ a}}
\DoxyCodeLine{00821\ \ \ \textcolor{comment}{//\ 2-\/d\ circle\ around\ the\ origin.\ \ The\ equation\ for\ this\ is\ very\ similar\ to}}
\DoxyCodeLine{00822\ \ \ \textcolor{comment}{//\ the\ formula\ for\ the\ intersection\ of\ a\ line\ with\ a\ sphere;\ see}}
\DoxyCodeLine{00823\ \ \ \textcolor{comment}{//\ CollisionSphere::intersects\_line()\ for\ the\ complete\ derivation.\ \ It's\ a}}
\DoxyCodeLine{00824\ \ \ \textcolor{comment}{//\ little\ bit\ simpler\ because\ the\ circle\ is\ centered\ on\ the\ origin.}}
\DoxyCodeLine{00825\ \ \ LVector2\ from2(from[0],\ from[2]);}
\DoxyCodeLine{00826\ \ \ LVector2\ delta2(delta[0],\ delta[2]);}
\DoxyCodeLine{00827\ }
\DoxyCodeLine{00828\ \ \ \textcolor{keywordtype}{double}\ A\ =\ dot(delta2,\ delta2);}
\DoxyCodeLine{00829\ }
\DoxyCodeLine{00830\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(A))\ \{}
\DoxyCodeLine{00831\ \ \ \ \ \textcolor{comment}{//\ If\ the\ delta2\ is\ 0,\ the\ line\ is\ perpendicular\ to\ the\ X-\/Z\ plane.\ \ The}}
\DoxyCodeLine{00832\ \ \ \ \ \textcolor{comment}{//\ whole\ line\ intersects\ with\ the\ infinite\ cylinder\ if\ the\ point\ is\ within}}
\DoxyCodeLine{00833\ \ \ \ \ \textcolor{comment}{//\ the\ circle.}}
\DoxyCodeLine{00834\ \ \ \ \ \textcolor{keywordflow}{if}\ (from2.dot(from2)\ >\ radius\ *\ radius)\ \{}
\DoxyCodeLine{00835\ \ \ \ \ \ \ \textcolor{comment}{//\ Nope,\ the\ 2-\/d\ point\ is\ outside\ the\ circle,\ so\ no\ intersection.}}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00837\ \ \ \ \ \}}
\DoxyCodeLine{00838\ }
\DoxyCodeLine{00839\ \ \ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(delta[1]))\ \{}
\DoxyCodeLine{00840\ \ \ \ \ \ \ \textcolor{comment}{//\ Actually,\ the\ whole\ delta\ vector\ is\ 0,\ so\ the\ line\ is\ just\ a\ point.}}
\DoxyCodeLine{00841\ \ \ \ \ \ \ \textcolor{comment}{//\ In\ this\ case,\ (since\ we\ have\ already\ shown\ the\ point\ is\ within\ the}}
\DoxyCodeLine{00842\ \ \ \ \ \ \ \textcolor{comment}{//\ infinite\ cylinder),\ we\ intersect\ if\ and\ only\ if\ the\ three-\/dimensional}}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \textcolor{comment}{//\ point\ is\ between\ the\ endcaps.}}
\DoxyCodeLine{00844\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (from[1]\ <\ -\/radius\ ||\ from[1]\ >\ \_length\ +\ radius)\ \{}
\DoxyCodeLine{00845\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Way\ out.}}
\DoxyCodeLine{00846\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00847\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00848\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (from[1]\ <\ 0.0f)\ \{}
\DoxyCodeLine{00849\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Possibly\ within\ the\ first\ endcap.}}
\DoxyCodeLine{00850\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (from.dot(from)\ >\ radius\ *\ radius)\ \{}
\DoxyCodeLine{00851\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00852\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00853\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (from[1]\ >\ \_length)\ \{}
\DoxyCodeLine{00854\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Possibly\ within\ the\ second\ endcap.}}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ from[1]\ -\/=\ \_length;}
\DoxyCodeLine{00856\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (from.dot(from)\ >\ radius\ *\ radius)\ \{}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00858\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00859\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00860\ }
\DoxyCodeLine{00861\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ capsule!}}
\DoxyCodeLine{00862\ \ \ \ \ \ \ t1\ =\ t2\ =\ 0.0;}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00864\ \ \ \ \ \}}
\DoxyCodeLine{00865\ }
\DoxyCodeLine{00866\ \ \ \ \ \textcolor{comment}{//\ The\ 2-\/d\ point\ is\ within\ the\ circle,\ so\ compute\ our\ intersection\ points}}
\DoxyCodeLine{00867\ \ \ \ \ \textcolor{comment}{//\ to\ include\ the\ entire\ vertical\ slice\ of\ the\ cylinder.}}
\DoxyCodeLine{00868\ \ \ \ \ t1\ =\ (-\/radius\ -\/\ from[1])\ /\ delta[1];}
\DoxyCodeLine{00869\ \ \ \ \ t2\ =\ (\_length\ +\ radius\ -\/\ from[1])\ /\ delta[1];}
\DoxyCodeLine{00870\ }
\DoxyCodeLine{00871\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00872\ \ \ \ \ \textcolor{comment}{//\ The\ line\ is\ not\ perpendicular\ to\ the\ X-\/Z\ plane,\ so\ its\ projection\ into}}
\DoxyCodeLine{00873\ \ \ \ \ \textcolor{comment}{//\ the\ plane\ is\ 2-\/d\ line.\ \ Test\ that\ 2-\/d\ line\ for\ intersection\ with\ the}}
\DoxyCodeLine{00874\ \ \ \ \ \textcolor{comment}{//\ circular\ projection\ of\ the\ cylinder.}}
\DoxyCodeLine{00875\ }
\DoxyCodeLine{00876\ \ \ \ \ \textcolor{keywordtype}{double}\ B\ =\ 2.0f\ *\ dot(delta2,\ from2);}
\DoxyCodeLine{00877\ \ \ \ \ \textcolor{keywordtype}{double}\ fc\_d2\ =\ dot(from2,\ from2);}
\DoxyCodeLine{00878\ \ \ \ \ \textcolor{keywordtype}{double}\ C\ =\ fc\_d2\ -\/\ radius\ *\ radius;}
\DoxyCodeLine{00879\ }
\DoxyCodeLine{00880\ \ \ \ \ \textcolor{keywordtype}{double}\ radical\ =\ B*B\ -\/\ 4.0*A*C;}
\DoxyCodeLine{00881\ }
\DoxyCodeLine{00882\ \ \ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(radical))\ \{}
\DoxyCodeLine{00883\ \ \ \ \ \ \ \textcolor{comment}{//\ Tangent.}}
\DoxyCodeLine{00884\ \ \ \ \ \ \ t1\ =\ t2\ =\ -\/B\ /\ (2.0*A);}
\DoxyCodeLine{00885\ }
\DoxyCodeLine{00886\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (radical\ <\ 0.0)\ \{}
\DoxyCodeLine{00887\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ real\ roots:\ no\ intersection\ with\ the\ line.}}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00889\ }
\DoxyCodeLine{00890\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ reciprocal\_2A\ =\ 1.0\ /\ (2.0\ *\ A);}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ sqrt\_radical\ =\ sqrtf(radical);}
\DoxyCodeLine{00893\ \ \ \ \ \ \ t1\ =\ (\ -\/B\ -\/\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00894\ \ \ \ \ \ \ t2\ =\ (\ -\/B\ +\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00895\ \ \ \ \ \}}
\DoxyCodeLine{00896\ \ \ \}}
\DoxyCodeLine{00897\ }
\DoxyCodeLine{00898\ \ \ \textcolor{comment}{//\ Now\ we\ need\ to\ verify\ that\ the\ intersection\ points\ fall\ within\ the\ length}}
\DoxyCodeLine{00899\ \ \ \textcolor{comment}{//\ of\ the\ cylinder.}}
\DoxyCodeLine{00900\ \ \ PN\_stdfloat\ t1\_y\ =\ from[1]\ +\ t1\ *\ delta[1];}
\DoxyCodeLine{00901\ \ \ PN\_stdfloat\ t2\_y\ =\ from[1]\ +\ t2\ *\ delta[1];}
\DoxyCodeLine{00902\ }
\DoxyCodeLine{00903\ \ \ \textcolor{keywordflow}{if}\ (t1\_y\ <\ -\/radius\ \&\&\ t2\_y\ <\ -\/radius)\ \{}
\DoxyCodeLine{00904\ \ \ \ \ \textcolor{comment}{//\ Both\ points\ are\ way\ off\ the\ bottom\ of\ the\ capsule;\ no\ intersection.}}
\DoxyCodeLine{00905\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00906\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1\_y\ >\ \_length\ +\ radius\ \&\&\ t2\_y\ >\ \_length\ +\ radius)\ \{}
\DoxyCodeLine{00907\ \ \ \ \ \textcolor{comment}{//\ Both\ points\ are\ way\ off\ the\ top\ of\ the\ capsule;\ no\ intersection.}}
\DoxyCodeLine{00908\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00909\ \ \ \}}
\DoxyCodeLine{00910\ }
\DoxyCodeLine{00911\ \ \ \textcolor{keywordflow}{if}\ (t1\_y\ <\ 0.0f)\ \{}
\DoxyCodeLine{00912\ \ \ \ \ \textcolor{comment}{//\ The\ starting\ point\ is\ off\ the\ bottom\ of\ the\ capsule.\ \ Test\ the\ line}}
\DoxyCodeLine{00913\ \ \ \ \ \textcolor{comment}{//\ against\ the\ first\ endcap.}}
\DoxyCodeLine{00914\ \ \ \ \ \textcolor{keywordtype}{double}\ t1a,\ t2a;}
\DoxyCodeLine{00915\ \ \ \ \ \textcolor{keywordflow}{if}\ (!sphere\_intersects\_line(t1a,\ t2a,\ 0.0f,\ from,\ delta,\ radius))\ \{}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ intersection\ with\ the\ endcap,\ there\ can't\ be\ an}}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \textcolor{comment}{//\ intersection\ with\ the\ cylinder.}}
\DoxyCodeLine{00918\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00919\ \ \ \ \ \}}
\DoxyCodeLine{00920\ \ \ \ \ t1\ =\ t1a;}
\DoxyCodeLine{00921\ }
\DoxyCodeLine{00922\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t1\_y\ >\ \_length)\ \{}
\DoxyCodeLine{00923\ \ \ \ \ \textcolor{comment}{//\ The\ starting\ point\ is\ off\ the\ top\ of\ the\ capsule.\ \ Test\ the\ line\ against}}
\DoxyCodeLine{00924\ \ \ \ \ \textcolor{comment}{//\ the\ second\ endcap.}}
\DoxyCodeLine{00925\ \ \ \ \ \textcolor{keywordtype}{double}\ t1b,\ t2b;}
\DoxyCodeLine{00926\ \ \ \ \ \textcolor{keywordflow}{if}\ (!sphere\_intersects\_line(t1b,\ t2b,\ \_length,\ from,\ delta,\ radius))\ \{}
\DoxyCodeLine{00927\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ intersection\ with\ the\ endcap,\ there\ can't\ be\ an}}
\DoxyCodeLine{00928\ \ \ \ \ \ \ \textcolor{comment}{//\ intersection\ with\ the\ cylinder.}}
\DoxyCodeLine{00929\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00930\ \ \ \ \ \}}
\DoxyCodeLine{00931\ \ \ \ \ t1\ =\ t1b;}
\DoxyCodeLine{00932\ \ \ \}}
\DoxyCodeLine{00933\ }
\DoxyCodeLine{00934\ \ \ \textcolor{keywordflow}{if}\ (t2\_y\ <\ 0.0f)\ \{}
\DoxyCodeLine{00935\ \ \ \ \ \textcolor{comment}{//\ The\ ending\ point\ is\ off\ the\ bottom\ of\ the\ capsule.\ \ Test\ the\ line\ against}}
\DoxyCodeLine{00936\ \ \ \ \ \textcolor{comment}{//\ the\ first\ endcap.}}
\DoxyCodeLine{00937\ \ \ \ \ \textcolor{keywordtype}{double}\ t1a,\ t2a;}
\DoxyCodeLine{00938\ \ \ \ \ \textcolor{keywordflow}{if}\ (!sphere\_intersects\_line(t1a,\ t2a,\ 0.0f,\ from,\ delta,\ radius))\ \{}
\DoxyCodeLine{00939\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ intersection\ with\ the\ endcap,\ there\ can't\ be\ an}}
\DoxyCodeLine{00940\ \ \ \ \ \ \ \textcolor{comment}{//\ intersection\ with\ the\ cylinder.}}
\DoxyCodeLine{00941\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00942\ \ \ \ \ \}}
\DoxyCodeLine{00943\ \ \ \ \ t2\ =\ t2a;}
\DoxyCodeLine{00944\ }
\DoxyCodeLine{00945\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (t2\_y\ >\ \_length)\ \{}
\DoxyCodeLine{00946\ \ \ \ \ \textcolor{comment}{//\ The\ ending\ point\ is\ off\ the\ top\ of\ the\ capsule.\ \ Test\ the\ line\ against\ the}}
\DoxyCodeLine{00947\ \ \ \ \ \textcolor{comment}{//\ second\ endcap.}}
\DoxyCodeLine{00948\ \ \ \ \ \textcolor{keywordtype}{double}\ t1b,\ t2b;}
\DoxyCodeLine{00949\ \ \ \ \ \textcolor{keywordflow}{if}\ (!sphere\_intersects\_line(t1b,\ t2b,\ \_length,\ from,\ delta,\ radius))\ \{}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ there's\ no\ intersection\ with\ the\ endcap,\ there\ can't\ be\ an}}
\DoxyCodeLine{00951\ \ \ \ \ \ \ \textcolor{comment}{//\ intersection\ with\ the\ cylinder.}}
\DoxyCodeLine{00952\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00953\ \ \ \ \ \}}
\DoxyCodeLine{00954\ \ \ \ \ t2\ =\ t2b;}
\DoxyCodeLine{00955\ \ \ \}}
\DoxyCodeLine{00956\ }
\DoxyCodeLine{00957\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00958\ \}}
\DoxyCodeLine{00959\ }
\DoxyCodeLine{00965\ \textcolor{keywordtype}{bool}\ CollisionCapsule::}
\DoxyCodeLine{00966\ sphere\_intersects\_line(\textcolor{keywordtype}{double}\ \&t1,\ \textcolor{keywordtype}{double}\ \&t2,\ PN\_stdfloat\ center\_y,}
\DoxyCodeLine{00967\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&from,\ \textcolor{keyword}{const}\ LVector3\ \&delta,}
\DoxyCodeLine{00968\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ PN\_stdfloat\ radius)\ \{}
\DoxyCodeLine{00969\ \ \ \textcolor{comment}{//\ See\ CollisionSphere::intersects\_line()\ for\ a\ derivation\ of\ the\ formula}}
\DoxyCodeLine{00970\ \ \ \textcolor{comment}{//\ here.}}
\DoxyCodeLine{00971\ \ \ \textcolor{keywordtype}{double}\ A\ =\ dot(delta,\ delta);}
\DoxyCodeLine{00972\ }
\DoxyCodeLine{00973\ \ \ nassertr(A\ !=\ 0.0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00974\ }
\DoxyCodeLine{00975\ \ \ LVector3\ fc\ =\ from;}
\DoxyCodeLine{00976\ \ \ fc[1]\ -\/=\ center\_y;}
\DoxyCodeLine{00977\ \ \ \textcolor{keywordtype}{double}\ B\ =\ 2.0f*\ dot(delta,\ fc);}
\DoxyCodeLine{00978\ \ \ \textcolor{keywordtype}{double}\ fc\_d2\ =\ dot(fc,\ fc);}
\DoxyCodeLine{00979\ \ \ \textcolor{keywordtype}{double}\ C\ =\ fc\_d2\ -\/\ radius\ *\ radius;}
\DoxyCodeLine{00980\ }
\DoxyCodeLine{00981\ \ \ \textcolor{keywordtype}{double}\ radical\ =\ B*B\ -\/\ 4.0*A*C;}
\DoxyCodeLine{00982\ }
\DoxyCodeLine{00983\ \ \ \textcolor{keywordflow}{if}\ (IS\_NEARLY\_ZERO(radical))\ \{}
\DoxyCodeLine{00984\ \ \ \ \ \textcolor{comment}{//\ Tangent.}}
\DoxyCodeLine{00985\ \ \ \ \ t1\ =\ t2\ =\ -\/B\ /\ (2.0\ *\ A);}
\DoxyCodeLine{00986\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00987\ }
\DoxyCodeLine{00988\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (radical\ <\ 0.0)\ \{}
\DoxyCodeLine{00989\ \ \ \ \ \textcolor{comment}{//\ No\ real\ roots:\ no\ intersection\ with\ the\ line.}}
\DoxyCodeLine{00990\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00991\ \ \ \}}
\DoxyCodeLine{00992\ }
\DoxyCodeLine{00993\ \ \ \textcolor{keywordtype}{double}\ reciprocal\_2A\ =\ 1.0\ /\ (2.0\ *\ A);}
\DoxyCodeLine{00994\ \ \ \textcolor{keywordtype}{double}\ sqrt\_radical\ =\ sqrtf(radical);}
\DoxyCodeLine{00995\ \ \ t1\ =\ (\ -\/B\ -\/\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00996\ \ \ t2\ =\ (\ -\/B\ +\ sqrt\_radical\ )\ *\ reciprocal\_2A;}
\DoxyCodeLine{00997\ }
\DoxyCodeLine{00998\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00999\ \}}
\DoxyCodeLine{01000\ }
\DoxyCodeLine{01009\ \textcolor{keywordtype}{bool}\ CollisionCapsule::}
\DoxyCodeLine{01010\ intersects\_parabola(\textcolor{keywordtype}{double}\ \&t,\ \textcolor{keyword}{const}\ LParabola\ \&parabola,}
\DoxyCodeLine{01011\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ t1,\ \textcolor{keywordtype}{double}\ t2,}
\DoxyCodeLine{01012\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&p1,\ \textcolor{keyword}{const}\ LPoint3\ \&p2)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01013\ \ \ \textcolor{comment}{//\ I\ don't\ even\ want\ to\ think\ about\ the\ math\ to\ do\ this\ calculation\ directly}}
\DoxyCodeLine{01014\ \ \ \textcolor{comment}{//\ -\/-\/it's\ even\ worse\ than\ sphere-\/parabola.\ \ So\ I'll\ use\ the\ recursive}}
\DoxyCodeLine{01015\ \ \ \textcolor{comment}{//\ subdivision\ solution\ again,\ just\ like\ I\ did\ for\ sphere-\/parabola.}}
\DoxyCodeLine{01016\ }
\DoxyCodeLine{01017\ \ \ \textcolor{comment}{//\ First,\ see\ if\ the\ line\ segment\ (p1\ -\/\ p2)\ comes\ sufficiently\ close\ to\ the}}
\DoxyCodeLine{01018\ \ \ \textcolor{comment}{//\ parabola.\ \ Do\ this\ by\ computing\ the\ parametric\ intervening\ point\ and}}
\DoxyCodeLine{01019\ \ \ \textcolor{comment}{//\ comparing\ its\ distance\ from\ the\ linear\ intervening\ point.}}
\DoxyCodeLine{01020\ \ \ \textcolor{keywordtype}{double}\ tmid\ =\ (t1\ +\ t2)\ *\ 0.5;}
\DoxyCodeLine{01021\ }
\DoxyCodeLine{01022\ \ \ \textcolor{keywordflow}{if}\ (tmid\ !=\ t1\ \&\&\ tmid\ !=\ t2)\ \{}
\DoxyCodeLine{01023\ \ \ \ \ LPoint3\ pmid\ =\ parabola.calc\_point(tmid);}
\DoxyCodeLine{01024\ \ \ \ \ LPoint3\ pmid2\ =\ (p1\ +\ p2)\ *\ 0.5f;}
\DoxyCodeLine{01025\ }
\DoxyCodeLine{01026\ \ \ \ \ \textcolor{keywordflow}{if}\ ((pmid\ -\/\ pmid2).length\_squared()\ >\ 0.001f)\ \{}
\DoxyCodeLine{01027\ \ \ \ \ \ \ \textcolor{comment}{//\ Subdivide.}}
\DoxyCodeLine{01028\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (intersects\_parabola(t,\ parabola,\ t1,\ tmid,\ p1,\ pmid))\ \{}
\DoxyCodeLine{01029\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01030\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01031\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ intersects\_parabola(t,\ parabola,\ tmid,\ t2,\ pmid,\ p2);}
\DoxyCodeLine{01032\ \ \ \ \ \}}
\DoxyCodeLine{01033\ \ \ \}}
\DoxyCodeLine{01034\ }
\DoxyCodeLine{01035\ \ \ \textcolor{comment}{//\ The\ line\ segment\ is\ sufficiently\ close;\ compare\ the\ segment\ itself.}}
\DoxyCodeLine{01036\ \ \ \textcolor{keywordtype}{double}\ t1a,\ t2a;}
\DoxyCodeLine{01037\ \ \ \textcolor{keywordflow}{if}\ (!intersects\_line(t1a,\ t2a,\ p1,\ p2\ -\/\ p1,\ 0.0f))\ \{}
\DoxyCodeLine{01038\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01039\ \ \ \}}
\DoxyCodeLine{01040\ }
\DoxyCodeLine{01041\ \ \ \textcolor{keywordflow}{if}\ (t2a\ <\ 0.0\ ||\ t1a\ >\ 1.0)\ \{}
\DoxyCodeLine{01042\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01043\ \ \ \}}
\DoxyCodeLine{01044\ }
\DoxyCodeLine{01045\ \ \ t\ =\ std::max(t1a,\ 0.0);}
\DoxyCodeLine{01046\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01047\ \}}
\DoxyCodeLine{01048\ }
\DoxyCodeLine{01054\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{01055\ calculate\_surface\_point\_and\_normal(\textcolor{keyword}{const}\ LPoint3\ \&surface\_point,}
\DoxyCodeLine{01056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ extra\_radius,}
\DoxyCodeLine{01057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LPoint3\ \&result\_point,}
\DoxyCodeLine{01058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LVector3\ \&result\_normal)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01059\ \ \ \textcolor{comment}{//\ Convert\ the\ point\ into\ our\ canonical\ space\ for\ analysis.}}
\DoxyCodeLine{01060\ \ \ LPoint3\ point\ =\ surface\_point\ *\ \_inv\_mat;}
\DoxyCodeLine{01061\ \ \ LVector3\ normal;}
\DoxyCodeLine{01062\ }
\DoxyCodeLine{01063\ \ \ \textcolor{keywordflow}{if}\ (point[1]\ <=\ 0.0)\ \{}
\DoxyCodeLine{01064\ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ on\ the\ first\ endcap.}}
\DoxyCodeLine{01065\ \ \ \ \ normal\ =\ point;}
\DoxyCodeLine{01066\ \ \ \ \ \textcolor{keywordflow}{if}\ (!normal.normalize())\ \{}
\DoxyCodeLine{01067\ \ \ \ \ \ \ normal.set(0.0,\ -\/1.0,\ 0.0);}
\DoxyCodeLine{01068\ \ \ \ \ \}}
\DoxyCodeLine{01069\ \ \ \ \ point\ =\ normal\ *\ \_radius;}
\DoxyCodeLine{01070\ }
\DoxyCodeLine{01071\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (point[1]\ >=\ \_length)\ \{}
\DoxyCodeLine{01072\ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ on\ the\ second\ endcap.}}
\DoxyCodeLine{01073\ \ \ \ \ normal.set(point[0],\ point[1]\ -\/\ \_length,\ point[2]);}
\DoxyCodeLine{01074\ \ \ \ \ \textcolor{keywordflow}{if}\ (!normal.normalize())\ \{}
\DoxyCodeLine{01075\ \ \ \ \ \ \ normal.set(0.0,\ 1.0,\ 0.0);}
\DoxyCodeLine{01076\ \ \ \ \ \}}
\DoxyCodeLine{01077\ \ \ \ \ point\ =\ normal\ *\ \_radius;}
\DoxyCodeLine{01078\ \ \ \ \ point[1]\ +=\ \_length;}
\DoxyCodeLine{01079\ }
\DoxyCodeLine{01080\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01081\ \ \ \ \ \textcolor{comment}{//\ The\ point\ is\ within\ the\ cylinder\ part.}}
\DoxyCodeLine{01082\ \ \ \ \ LVector2d\ normal2d(point[0],\ point[2]);}
\DoxyCodeLine{01083\ \ \ \ \ \textcolor{keywordflow}{if}\ (!normal2d.normalize())\ \{}
\DoxyCodeLine{01084\ \ \ \ \ \ \ normal2d.set(0.0,\ 1.0);}
\DoxyCodeLine{01085\ \ \ \ \ \}}
\DoxyCodeLine{01086\ \ \ \ \ normal.set(normal2d[0],\ 0.0,\ normal2d[1]);}
\DoxyCodeLine{01087\ \ \ \ \ point.set(normal[0]\ *\ \_radius,\ point[1],\ normal[2]\ *\ \_radius);}
\DoxyCodeLine{01088\ \ \ \}}
\DoxyCodeLine{01089\ }
\DoxyCodeLine{01090\ \ \ \textcolor{comment}{//\ Now\ convert\ the\ point\ and\ normal\ back\ into\ real\ space.}}
\DoxyCodeLine{01091\ \ \ result\_point\ =\ point\ *\ \_mat;}
\DoxyCodeLine{01092\ \ \ result\_normal\ =\ normal\ *\ \_mat;}
\DoxyCodeLine{01093\ \}}
\DoxyCodeLine{01094\ }
\DoxyCodeLine{01100\ \textcolor{keywordtype}{void}\ CollisionCapsule::}
\DoxyCodeLine{01101\ set\_intersection\_point(\mbox{\hyperlink{classCollisionEntry}{CollisionEntry}}\ *new\_entry,}
\DoxyCodeLine{01102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ LPoint3\ \&into\_intersection\_point,}
\DoxyCodeLine{01103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ extra\_radius)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01104\ \ \ LPoint3\ point;}
\DoxyCodeLine{01105\ \ \ LVector3\ normal;}
\DoxyCodeLine{01106\ }
\DoxyCodeLine{01107\ \ \ calculate\_surface\_point\_and\_normal(into\_intersection\_point,}
\DoxyCodeLine{01108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ extra\_radius,}
\DoxyCodeLine{01109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ point,}
\DoxyCodeLine{01110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ normal);}
\DoxyCodeLine{01111\ }
\DoxyCodeLine{01112\ \ \ \textcolor{keywordflow}{if}\ (has\_effective\_normal()\ \&\&\ new\_entry-\/>get\_from()-\/>get\_respect\_effective\_normal())\ \{}
\DoxyCodeLine{01113\ \ \ \ \ normal\ =\ get\_effective\_normal();}
\DoxyCodeLine{01114\ \ \ \}}
\DoxyCodeLine{01115\ }
\DoxyCodeLine{01116\ \ \ new\_entry-\/>set\_surface\_normal(normal);}
\DoxyCodeLine{01117\ \ \ new\_entry-\/>set\_surface\_point(point);}
\DoxyCodeLine{01118\ \ \ \textcolor{comment}{//\ Also\ adjust\ the\ original\ point\ into\ the\ capsule\ by\ the\ amount\ of}}
\DoxyCodeLine{01119\ \ \ \textcolor{comment}{//\ extra\_radius,\ which\ should\ put\ it\ on\ the\ surface\ of\ the\ capsule\ if\ our}}
\DoxyCodeLine{01120\ \ \ \textcolor{comment}{//\ collision\ was\ tangential.}}
\DoxyCodeLine{01121\ \ \ new\_entry-\/>set\_interior\_point(into\_intersection\_point\ -\/\ normal\ *\ extra\_radius);}
\DoxyCodeLine{01122\ \}}
\DoxyCodeLine{01123\ }
\DoxyCodeLine{01127\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionCapsule_ab4c375be638ea7fcb497cd671f6e99c7}{CollisionCapsule::}}}
\DoxyCodeLine{01128\ \mbox{\hyperlink{classCollisionCapsule_ab4c375be638ea7fcb497cd671f6e99c7}{register\_with\_read\_factory}}()\ \{}
\DoxyCodeLine{01129\ \ \ BamReader::get\_factory()-\/>register\_factory(get\_class\_type(),\ \mbox{\hyperlink{classCollisionCapsule_a6e0b39c262013f14db2a5cb92a78381c}{make\_from\_bam}});}
\DoxyCodeLine{01130\ \}}
\DoxyCodeLine{01131\ }
\DoxyCodeLine{01136\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionCapsule_a434e7c899437761cac2fd1368d26325e}{CollisionCapsule::}}}
\DoxyCodeLine{01137\ \mbox{\hyperlink{classCollisionCapsule_a434e7c899437761cac2fd1368d26325e}{write\_datagram}}(\mbox{\hyperlink{classBamWriter}{BamWriter}}\ *manager,\ \mbox{\hyperlink{classDatagram}{Datagram}}\ \&dg)\ \{}
\DoxyCodeLine{01138\ \ \ \mbox{\hyperlink{classCollisionSolid_a0d50fe1dbd0400d255a1b86f09fca42d}{CollisionSolid::write\_datagram}}(manager,\ dg);}
\DoxyCodeLine{01139\ \ \ \_a.write\_datagram(dg);}
\DoxyCodeLine{01140\ \ \ \_b.write\_datagram(dg);}
\DoxyCodeLine{01141\ \ \ dg.add\_stdfloat(\_radius);}
\DoxyCodeLine{01142\ \}}
\DoxyCodeLine{01143\ }
\DoxyCodeLine{01149\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *\mbox{\hyperlink{classCollisionCapsule_a6e0b39c262013f14db2a5cb92a78381c}{CollisionCapsule::}}}
\DoxyCodeLine{01150\ \mbox{\hyperlink{classCollisionCapsule_a6e0b39c262013f14db2a5cb92a78381c}{make\_from\_bam}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{01151\ \ \ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}\ *node\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classCollisionCapsule}{CollisionCapsule}}();}
\DoxyCodeLine{01152\ \ \ \mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ scan;}
\DoxyCodeLine{01153\ \ \ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager;}
\DoxyCodeLine{01154\ }
\DoxyCodeLine{01155\ \ \ parse\_params(params,\ scan,\ manager);}
\DoxyCodeLine{01156\ \ \ node-\/>\mbox{\hyperlink{classCollisionCapsule_ab7b1c3dd377a268cffef659272d7f474}{fillin}}(scan,\ manager);}
\DoxyCodeLine{01157\ }
\DoxyCodeLine{01158\ \ \ \textcolor{keywordflow}{return}\ node;}
\DoxyCodeLine{01159\ \}}
\DoxyCodeLine{01160\ }
\DoxyCodeLine{01165\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCollisionCapsule_ab7b1c3dd377a268cffef659272d7f474}{CollisionCapsule::}}}
\DoxyCodeLine{01166\ \mbox{\hyperlink{classCollisionCapsule_ab7b1c3dd377a268cffef659272d7f474}{fillin}}(\mbox{\hyperlink{classDatagramIterator}{DatagramIterator}}\ \&scan,\ \mbox{\hyperlink{classBamReader}{BamReader}}\ *manager)\ \{}
\DoxyCodeLine{01167\ \ \ \mbox{\hyperlink{classCollisionSolid_abb24c87297214818d7ddd2fbb1875c61}{CollisionSolid::fillin}}(scan,\ manager);}
\DoxyCodeLine{01168\ \ \ \_a.read\_datagram(scan);}
\DoxyCodeLine{01169\ \ \ \_b.read\_datagram(scan);}
\DoxyCodeLine{01170\ \ \ \_radius\ =\ scan.get\_stdfloat();}
\DoxyCodeLine{01171\ \ \ recalc\_internals();}
\DoxyCodeLine{01172\ \}}

\end{DoxyCode}
