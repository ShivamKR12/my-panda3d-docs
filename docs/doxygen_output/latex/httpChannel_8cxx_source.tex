\doxysection{http\+Channel.\+cxx}
\hypertarget{httpChannel_8cxx_source}{}\label{httpChannel_8cxx_source}\index{panda/src/downloader/httpChannel.cxx@{panda/src/downloader/httpChannel.cxx}}
\mbox{\hyperlink{httpChannel_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpChannel_8h}{httpChannel.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpClient_8h}{httpClient.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{httpCookie_8h}{httpCookie.h}}"{}}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bioStream_8h}{bioStream.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{chunkedStream_8h}{chunkedStream.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{identityStream_8h}{identityStream.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__downloader_8h}{config\_downloader.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileSystem_8h}{virtualFileSystem.h}}"{}}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{virtualFileMountHTTP_8h}{virtualFileMountHTTP.h}}"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ramfile_8h}{ramfile.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{globPattern_8h}{globPattern.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{string__utils_8h}{string\_utils.h}}"{}}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{zStream_8h}{zStream.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#ifdef\ HAVE\_OPENSSL}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{openSSLWrapper_8h}{openSSLWrapper.h}}"{}}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#ifdef\ \_WIN32}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\ \ \#include\ <winsock2.h>}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\ \ \#include\ <\mbox{\hyperlink{windows_8h}{windows.h}}>}\ \ \textcolor{comment}{//\ for\ select()}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\ \ \#undef\ X509\_NAME}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ \_WIN32}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00044\ \textcolor{keyword}{using\ }std::min;}
\DoxyCodeLine{00045\ \textcolor{keyword}{using\ }std::ostream;}
\DoxyCodeLine{00046\ \textcolor{keyword}{using\ }\mbox{\hyperlink{classstd_1_1ostringstream}{std::ostringstream}};}
\DoxyCodeLine{00047\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ HTTPChannel::\_type\_handle;}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#define\ \_NOTIFY\_HTTP\_CHANNEL\_ID\ \ \ "{}["{}\ <<\ this\ <<\ "{}]\ "{}}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00056\ HTTPChannel::}
\DoxyCodeLine{00057\ HTTPChannel(HTTPClient\ *client)\ :}
\DoxyCodeLine{00058\ \ \ \_client(client)}
\DoxyCodeLine{00059\ \{}
\DoxyCodeLine{00060\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00061\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00062\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00063\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}created.\(\backslash\)n"{}};}
\DoxyCodeLine{00064\ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \mbox{\hyperlink{classConfigVariableDouble}{ConfigVariableDouble}}\ extra\_ssl\_handshake\_time}
\DoxyCodeLine{00067\ \ \ \ \ (\textcolor{stringliteral}{"{}extra-\/ssl-\/handshake-\/time"{}},\ 0.0,}
\DoxyCodeLine{00068\ \ \ \ \ \ PRC\_DESC(\textcolor{stringliteral}{"{}This\ specifies\ how\ much\ extra\ time\ to\ try\ to\ establish"{}}}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}the\ ssl\ handshake\ before\ we\ bail."{}}));}
\DoxyCodeLine{00070\ \ \ \_extra\_ssl\_handshake\_time\ =\ extra\_ssl\_handshake\_time;}
\DoxyCodeLine{00071\ \ \ \_proxy\_next\_index\ =\ 0;}
\DoxyCodeLine{00072\ \ \ \_persistent\_connection\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00073\ \ \ \_allow\_proxy\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00074\ \ \ \_proxy\_tunnel\ =\ http\_proxy\_tunnel;}
\DoxyCodeLine{00075\ \ \ \_connect\_timeout\ =\ http\_connect\_timeout;}
\DoxyCodeLine{00076\ \ \ \_http\_timeout\ =\ http\_timeout;}
\DoxyCodeLine{00077\ \ \ \_skip\_body\_size\ =\ http\_skip\_body\_size;}
\DoxyCodeLine{00078\ \ \ \_idle\_timeout\ =\ http\_idle\_timeout;}
\DoxyCodeLine{00079\ \ \ \_blocking\_connect\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00080\ \ \ \_download\_throttle\ =\ download\_throttle;}
\DoxyCodeLine{00081\ \ \ \_max\_bytes\_per\_second\ =\ downloader\_byte\_rate;}
\DoxyCodeLine{00082\ \ \ \_seconds\_per\_update\ =\ downloader\_frequency;}
\DoxyCodeLine{00083\ \ \ \_max\_updates\_per\_second\ =\ 1.0f\ /\ \_seconds\_per\_update;}
\DoxyCodeLine{00084\ \ \ \_bytes\_per\_update\ =\ int(\_max\_bytes\_per\_second\ *\ \_seconds\_per\_update);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \textcolor{comment}{//\ \_nonblocking\ is\ true\ if\ the\ socket\ is\ actually\ in\ non-\/blocking\ mode.}}
\DoxyCodeLine{00087\ \ \ \_nonblocking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \textcolor{comment}{//\ \_wanted\_nonblocking\ is\ true\ if\ the\ user\ specifically\ requested\ one\ of\ the}}
\DoxyCodeLine{00090\ \ \ \textcolor{comment}{//\ non-\/blocking\ interfaces.\ \ It\ is\ false\ if\ the\ socket\ is\ only\ incidentally}}
\DoxyCodeLine{00091\ \ \ \textcolor{comment}{//\ non-\/blocking\ (for\ instance,\ because\ SIMPLE\_THREADS\ is\ on).}}
\DoxyCodeLine{00092\ \ \ \_wanted\_nonblocking\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \_want\_ssl\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00095\ \ \ \_proxy\_serves\_document\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00096\ \ \ \_proxy\_tunnel\_now\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00097\ \ \ \_first\_byte\_requested\ =\ 0;}
\DoxyCodeLine{00098\ \ \ \_last\_byte\_requested\ =\ 0;}
\DoxyCodeLine{00099\ \ \ \_first\_byte\_delivered\ =\ 0;}
\DoxyCodeLine{00100\ \ \ \_last\_byte\_delivered\ =\ 0;}
\DoxyCodeLine{00101\ \ \ \_read\_index\ =\ 0;}
\DoxyCodeLine{00102\ \ \ \_expected\_file\_size\ =\ 0;}
\DoxyCodeLine{00103\ \ \ \_file\_size\ =\ 0;}
\DoxyCodeLine{00104\ \ \ \_transfer\_file\_size\ =\ 0;}
\DoxyCodeLine{00105\ \ \ \_got\_expected\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00106\ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00107\ \ \ \_got\_transfer\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00108\ \ \ \_bytes\_downloaded\ =\ 0;}
\DoxyCodeLine{00109\ \ \ \_bytes\_requested\ =\ 0;}
\DoxyCodeLine{00110\ \ \ \_status\_entry\ =\ StatusEntry();}
\DoxyCodeLine{00111\ \ \ \_response\_type\ =\ RT\_none;}
\DoxyCodeLine{00112\ \ \ \_http\_version\ =\ \_client-\/>get\_http\_version();}
\DoxyCodeLine{00113\ \ \ \_http\_version\_string\ =\ \_client-\/>get\_http\_version\_string();}
\DoxyCodeLine{00114\ \ \ \_content\_type\ =\ \textcolor{stringliteral}{"{}application/x-\/www-\/form-\/urlencoded"{}};}
\DoxyCodeLine{00115\ \ \ \_state\ =\ S\_new;}
\DoxyCodeLine{00116\ \ \ \_done\_state\ =\ S\_new;}
\DoxyCodeLine{00117\ \ \ \_started\_download\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00118\ \ \ \_sent\_so\_far\ =\ 0;}
\DoxyCodeLine{00119\ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00120\ \ \ \_body\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00121\ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00122\ \ \ \_sbio\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00123\ \ \ \_cipher\_list\ =\ \_client-\/>get\_cipher\_list();}
\DoxyCodeLine{00124\ \ \ \_last\_status\_code\ =\ 0;}
\DoxyCodeLine{00125\ \ \ \_last\_run\_time\ =\ 0.0f;}
\DoxyCodeLine{00126\ \ \ \_download\_dest\ =\ DD\_none;}
\DoxyCodeLine{00127\ \ \ \_download\_to\_ramfile\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00128\ \ \ \_download\_to\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00134\ HTTPChannel::}
\DoxyCodeLine{00135\ \string~HTTPChannel()\ \{}
\DoxyCodeLine{00136\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00137\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00138\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00139\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}destroyed.\(\backslash\)n"{}};}
\DoxyCodeLine{00140\ \ \ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ close\_connection();}
\DoxyCodeLine{00143\ \ \ reset\_download\_to();}
\DoxyCodeLine{00144\ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00150\ \textcolor{keywordtype}{string}\ HTTPChannel::}
\DoxyCodeLine{00151\ get\_status\_string()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00152\ \ \ \textcolor{keywordflow}{switch}\ (\_status\_entry.\_status\_code)\ \{}
\DoxyCodeLine{00153\ \ \ \textcolor{keywordflow}{case}\ SC\_incomplete:}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Connection\ in\ progress"{}};}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \ \ \textcolor{keywordflow}{case}\ SC\_internal\_error:}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Internal\ error"{}};}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \textcolor{keywordflow}{case}\ SC\_no\_connection:}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}No\ connection"{}};}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \ \ \textcolor{keywordflow}{case}\ SC\_timeout:}
\DoxyCodeLine{00163\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Timeout\ on\ connection"{}};}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \textcolor{keywordflow}{case}\ SC\_lost\_connection:}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Lost\ connection"{}};}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \textcolor{keywordflow}{case}\ SC\_non\_http\_response:}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Non-\/HTTP\ response"{}};}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{case}\ SC\_invalid\_http:}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Could\ not\ understand\ HTTP\ response"{}};}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{case}\ SC\_socks\_invalid\_version:}
\DoxyCodeLine{00175\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Unsupported\ SOCKS\ version"{}};}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \textcolor{keywordflow}{case}\ SC\_socks\_no\_acceptable\_login\_method:}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}No\ acceptable\ SOCKS\ login\ method"{}};}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \textcolor{keywordflow}{case}\ SC\_socks\_refused:}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}SOCKS\ proxy\ refused\ connection"{}};}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{keywordflow}{case}\ SC\_socks\_no\_connection:}
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}SOCKS\ proxy\ unable\ to\ connect"{}};}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \textcolor{keywordflow}{case}\ SC\_ssl\_internal\_failure:}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}SSL\ internal\ failure"{}};}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \ \ \textcolor{keywordflow}{case}\ SC\_ssl\_no\_handshake:}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}No\ SSL\ handshake"{}};}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ \ \ \textcolor{keywordflow}{case}\ SC\_http\_error\_watermark:}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{//\ This\ shouldn't\ be\ triggered.}}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Internal\ error"{}};}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \ \ \textcolor{keywordflow}{case}\ SC\_ssl\_invalid\_server\_certificate:}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}SSL\ invalid\ server\ certificate"{}};}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{case}\ SC\_ssl\_unexpected\_server:}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Unexpected\ SSL\ server"{}};}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \ \ \textcolor{keywordflow}{case}\ SC\_download\_open\_error:}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Error\ opening\ file"{}};}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \textcolor{keywordflow}{case}\ SC\_download\_write\_error:}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Error\ writing\ to\ disk"{}};}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \textcolor{keywordflow}{case}\ SC\_download\_invalid\_range:}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Invalid\ subrange\ requested"{}};}
\DoxyCodeLine{00210\ \ \ \}}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \ \ \textcolor{keywordflow}{return}\ \_status\_entry.\_status\_string;}
\DoxyCodeLine{00213\ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00219\ \textcolor{keywordtype}{string}\ HTTPChannel::}
\DoxyCodeLine{00220\ get\_header\_value(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&key)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00221\ \ \ Headers::const\_iterator\ hi\ =\ \_headers.find(\mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(key));}
\DoxyCodeLine{00222\ \ \ \textcolor{keywordflow}{if}\ (hi\ !=\ \_headers.end())\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{keywordflow}{return}\ (*hi).second;}
\DoxyCodeLine{00224\ \ \ \}}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{return}\ string();}
\DoxyCodeLine{00226\ \}}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00233\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00234\ will\_close\_connection()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00235\ \ \ \textcolor{keywordflow}{if}\ (get\_http\_version()\ <\ HTTPEnum::HV\_11)\ \{}
\DoxyCodeLine{00236\ \ \ \ \ \textcolor{comment}{//\ pre-\/HTTP\ 1.1\ always\ closes.}}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00238\ \ \ \}}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00240\ \ \ \textcolor{keywordtype}{string}\ connection\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Connection"{}});}
\DoxyCodeLine{00241\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(connection)\ ==\ \textcolor{stringliteral}{"{}close"{}})\ \{}
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ The\ server\ says\ it\ will\ close.}}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00244\ \ \ \}}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keywordflow}{if}\ (connection.empty()\ \&\&\ !get\_persistent\_connection())\ \{}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{comment}{//\ The\ server\ didn't\ say,\ but\ we\ asked\ it\ to\ close.}}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00249\ \ \ \}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ \textcolor{comment}{//\ Assume\ the\ server\ will\ keep\ it\ open.}}
\DoxyCodeLine{00252\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00253\ \}}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00266\ std::streamsize\ HTTPChannel::}
\DoxyCodeLine{00267\ get\_file\_size()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00268\ \ \ \textcolor{keywordflow}{if}\ (\_got\_file\_size)\ \{}
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordflow}{return}\ \_file\_size;}
\DoxyCodeLine{00270\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_got\_transfer\_file\_size)\ \{}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{keywordflow}{return}\ \_transfer\_file\_size;}
\DoxyCodeLine{00272\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_got\_expected\_file\_size)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \textcolor{keywordflow}{return}\ \_expected\_file\_size;}
\DoxyCodeLine{00274\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00276\ \ \ \}}
\DoxyCodeLine{00277\ \}}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00283\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{00284\ write\_headers(ostream\ \&out)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00285\ \ \ Headers::const\_iterator\ hi;}
\DoxyCodeLine{00286\ \ \ \textcolor{keywordflow}{for}\ (hi\ =\ \_headers.begin();\ hi\ !=\ \_headers.end();\ ++hi)\ \{}
\DoxyCodeLine{00287\ \ \ \ \ out\ <<\ (*hi).first\ <<\ \textcolor{stringliteral}{"{}:\ "{}}\ <<\ (*hi).second\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00288\ \ \ \}}
\DoxyCodeLine{00289\ \}}
\DoxyCodeLine{00290\ }
\DoxyCodeLine{00301\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00302\ run()\ \{}
\DoxyCodeLine{00303\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00304\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00305\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00306\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}run().\(\backslash\)n"{}};}
\DoxyCodeLine{00307\ \ \ \}}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ \_done\_state\ ||\ \_state\ ==\ S\_failure)\ \{}
\DoxyCodeLine{00310\ \ \ \ \ clear\_extra\_headers();}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordflow}{if}\ (!reached\_done\_state())\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00313\ \ \ \ \ \}}
\DoxyCodeLine{00314\ \ \ \}}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \textcolor{keywordflow}{if}\ (\_started\_download)\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_wanted\_nonblocking\ \&\&\ \_download\_throttle)\ \{}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ now\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ elapsed\ =\ now\ -\/\ \_last\_run\_time;}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (elapsed\ <\ \_seconds\_per\_update)\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Come\ back\ later.}}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ thread\_yield();}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_potential\_updates\ =\ (int)(elapsed\ /\ \_seconds\_per\_update);}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \_last\_run\_time\ =\ now;}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \_bytes\_requested\ +=\ \_bytes\_per\_update\ *\ num\_potential\_updates;}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}elapsed\ =\ "{}}\ <<\ elapsed\ <<\ \textcolor{stringliteral}{"{}\ num\_potential\_updates\ =\ "{}}}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ <<\ num\_potential\_updates\ <<\ \textcolor{stringliteral}{"{}\ bytes\_requested\ =\ "{}}}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \ \ <<\ \_bytes\_requested\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00335\ \ \ \ \ \}}
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ \ \ \ \ \textcolor{keywordtype}{bool}\ repeat\_later\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00338\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_download\_dest)\ \{}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{keywordflow}{case}\ DD\_none:}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \textcolor{comment}{//\ We're\ done.}}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{keywordflow}{case}\ DD\_file:}
\DoxyCodeLine{00344\ \ \ \ \ \ \ repeat\_later\ =\ run\_download\_to\_file();}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{keywordflow}{case}\ DD\_ram:}
\DoxyCodeLine{00348\ \ \ \ \ \ \ repeat\_later\ =\ run\_download\_to\_ram();}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{keywordflow}{case}\ DD\_stream:}
\DoxyCodeLine{00352\ \ \ \ \ \ \ repeat\_later\ =\ run\_download\_to\_stream();}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00354\ \ \ \ \ \}}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keywordflow}{if}\ (repeat\_later)\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \ \ thread\_yield();}
\DoxyCodeLine{00357\ \ \ \ \ \}}
\DoxyCodeLine{00358\ \ \ \ \ \textcolor{keywordflow}{return}\ repeat\_later;}
\DoxyCodeLine{00359\ \ \ \}}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00362\ \textcolor{comment}{\ \ if\ (downloader\_cat.is\_spam())\ \{}}
\DoxyCodeLine{00363\ \textcolor{comment}{\ \ \ \ downloader\_cat.spam()}}
\DoxyCodeLine{00364\ \textcolor{comment}{\ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}}
\DoxyCodeLine{00365\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{}begin\ run(),\ \_state\ =\ "{}\ <<\ \_state\ <<\ "{},\ \_done\_state\ =\ "{}}}
\DoxyCodeLine{00366\ \textcolor{comment}{\ \ \ \ \ \ <<\ \_done\_state\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{00367\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00368\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00370\ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ \_done\_state)\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \textcolor{keywordflow}{return}\ reached\_done\_state();}
\DoxyCodeLine{00372\ \ \ \}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00374\ \ \ \textcolor{keywordtype}{bool}\ repeat\_later;}
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{comment}{//\ If\ we're\ in\ a\ state\ that\ expects\ to\ have\ a\ connection\ already\ (that\ is,}}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{comment}{//\ any\ state\ other\ that\ S\_try\_next\_proxy),\ then\ reestablish\ the\ connection}}
\DoxyCodeLine{00378\ \ \ \ \ \textcolor{comment}{//\ if\ it\ has\ been\ dropped.}}
\DoxyCodeLine{00379\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio.is\_null()\ \&\&\ \_state\ !=\ S\_try\_next\_proxy)\ \{}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_connect\_count\ >\ http\_max\_connect\_count)\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Too\ many\ connection\ attempts;\ just\ give\ up.\ \ We\ should\ never}}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ trigger\ this\ failsafe,\ since\ the\ code\ in\ each\ individual\ case\ has}}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ similar\ logic\ to\ prevent\ more\ than\ two\ consecutive\ lost}}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ connections.}}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Too\ many\ lost\ connections,\ giving\ up.\(\backslash\)n"{}};}
\DoxyCodeLine{00388\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_lost\_connection;}
\DoxyCodeLine{00389\ \ \ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{00390\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00391\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \ \ \ \ \ \ \textcolor{comment}{//\ No\ connection.\ \ Attempt\ to\ establish\ one.}}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ url;}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_proxy.empty())\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ url\ =\ \_request.get\_url();}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ url\ =\ \_proxy;}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \_bio\ =\ \textcolor{keyword}{new}\ BioPtr(url);}
\DoxyCodeLine{00401\ \ \ \ \ \ \ \_source\ =\ \textcolor{keyword}{new}\ BioStreamPtr(\textcolor{keyword}{new}\ BioStream(\_bio));}
\DoxyCodeLine{00402\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_nonblocking)\ \{}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ \_bio-\/>set\_nbio(\textcolor{keyword}{true});}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00405\ }
\DoxyCodeLine{00406\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_connect\_count\ >\ 0)\ \{}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Reconnecting\ to\ "{}}\ <<\ \_bio-\/>get\_server\_name()\ <<\ \textcolor{stringliteral}{"{}\ port\ "{}}}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_bio-\/>get\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Connecting\ to\ "{}}\ <<\ \_bio-\/>get\_server\_name()\ <<\ \textcolor{stringliteral}{"{}\ port\ "{}}}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_bio-\/>get\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \ \ \ \ \_state\ =\ S\_connecting;}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \_started\_connecting\_time\ =}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \_connect\_count++;}
\DoxyCodeLine{00424\ \ \ \ \ \}}
\DoxyCodeLine{00425\ }
\DoxyCodeLine{00426\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00427\ \textcolor{comment}{\ \ \ \ if\ (downloader\_cat.is\_spam())\ \{}}
\DoxyCodeLine{00428\ \textcolor{comment}{\ \ \ \ \ \ downloader\_cat.spam()}}
\DoxyCodeLine{00429\ \textcolor{comment}{\ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}}
\DoxyCodeLine{00430\ \textcolor{comment}{\ \ \ \ \ \ \ \ <<\ "{}continue\ run(),\ \_state\ =\ "{}\ <<\ \_state\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{00431\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00432\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00433\ }
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_state)\ \{}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_try\_next\_proxy:}
\DoxyCodeLine{00436\ \ \ \ \ \ \ repeat\_later\ =\ run\_try\_next\_proxy();}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00439\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_connecting:}
\DoxyCodeLine{00440\ \ \ \ \ \ \ repeat\_later\ =\ run\_connecting();}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00442\ }
\DoxyCodeLine{00443\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_connecting\_wait:}
\DoxyCodeLine{00444\ \ \ \ \ \ \ repeat\_later\ =\ run\_connecting\_wait();}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_http\_proxy\_ready:}
\DoxyCodeLine{00448\ \ \ \ \ \ \ repeat\_later\ =\ run\_http\_proxy\_ready();}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00450\ }
\DoxyCodeLine{00451\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_http\_proxy\_request\_sent:}
\DoxyCodeLine{00452\ \ \ \ \ \ \ repeat\_later\ =\ run\_http\_proxy\_request\_sent();}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00454\ }
\DoxyCodeLine{00455\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_http\_proxy\_reading\_header:}
\DoxyCodeLine{00456\ \ \ \ \ \ \ repeat\_later\ =\ run\_http\_proxy\_reading\_header();}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_socks\_proxy\_greet:}
\DoxyCodeLine{00460\ \ \ \ \ \ \ repeat\_later\ =\ run\_socks\_proxy\_greet();}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00462\ }
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_socks\_proxy\_greet\_reply:}
\DoxyCodeLine{00464\ \ \ \ \ \ \ repeat\_later\ =\ run\_socks\_proxy\_greet\_reply();}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00466\ }
\DoxyCodeLine{00467\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_socks\_proxy\_connect:}
\DoxyCodeLine{00468\ \ \ \ \ \ \ repeat\_later\ =\ run\_socks\_proxy\_connect();}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00471\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_socks\_proxy\_connect\_reply:}
\DoxyCodeLine{00472\ \ \ \ \ \ \ repeat\_later\ =\ run\_socks\_proxy\_connect\_reply();}
\DoxyCodeLine{00473\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_setup\_ssl:}
\DoxyCodeLine{00476\ \ \ \ \ \ \ repeat\_later\ =\ run\_setup\_ssl();}
\DoxyCodeLine{00477\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00478\ }
\DoxyCodeLine{00479\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_ssl\_handshake:}
\DoxyCodeLine{00480\ \ \ \ \ \ \ repeat\_later\ =\ run\_ssl\_handshake();}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00482\ }
\DoxyCodeLine{00483\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_ready:}
\DoxyCodeLine{00484\ \ \ \ \ \ \ repeat\_later\ =\ run\_ready();}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00486\ }
\DoxyCodeLine{00487\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_request\_sent:}
\DoxyCodeLine{00488\ \ \ \ \ \ \ repeat\_later\ =\ run\_request\_sent();}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00490\ }
\DoxyCodeLine{00491\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_reading\_header:}
\DoxyCodeLine{00492\ \ \ \ \ \ \ repeat\_later\ =\ run\_reading\_header();}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00495\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_start\_direct\_file\_read:}
\DoxyCodeLine{00496\ \ \ \ \ \ \ repeat\_later\ =\ run\_start\_direct\_file\_read();}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00498\ }
\DoxyCodeLine{00499\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_read\_header:}
\DoxyCodeLine{00500\ \ \ \ \ \ \ repeat\_later\ =\ run\_read\_header();}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_begin\_body:}
\DoxyCodeLine{00504\ \ \ \ \ \ \ repeat\_later\ =\ run\_begin\_body();}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_reading\_body:}
\DoxyCodeLine{00508\ \ \ \ \ \ \ repeat\_later\ =\ run\_reading\_body();}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_read\_body:}
\DoxyCodeLine{00512\ \ \ \ \ \ \ repeat\_later\ =\ run\_read\_body();}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00514\ }
\DoxyCodeLine{00515\ \ \ \ \ \textcolor{keywordflow}{case}\ S\_read\_trailer:}
\DoxyCodeLine{00516\ \ \ \ \ \ \ repeat\_later\ =\ run\_read\_trailer();}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00520\ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unhandled\ state\ "{}}\ <<\ \_state\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00524\ \ \ \ \ \}}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ \_done\_state\ ||\ \_state\ ==\ S\_failure)\ \{}
\DoxyCodeLine{00527\ \ \ \ \ \ \ clear\_extra\_headers();}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \textcolor{comment}{//\ We've\ reached\ our\ terminal\ state.}}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ reached\_done\_state();}
\DoxyCodeLine{00530\ \ \ \ \ \}}
\DoxyCodeLine{00531\ \ \ \ \ thread\_consider\_yield();}
\DoxyCodeLine{00532\ \ \ \}\ \textcolor{keywordflow}{while}\ (!repeat\_later\ ||\ \_bio.is\_null());}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00535\ \textcolor{comment}{\ \ if\ (downloader\_cat.is\_spam())\ \{}}
\DoxyCodeLine{00536\ \textcolor{comment}{\ \ \ \ downloader\_cat.spam()}}
\DoxyCodeLine{00537\ \textcolor{comment}{\ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}}
\DoxyCodeLine{00538\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{}later\ run(),\ \_state\ =\ "{}\ <<\ \_state}}
\DoxyCodeLine{00539\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{},\ \_done\_state\ =\ "{}\ <<\ \_done\_state\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{00540\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00541\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00542\ }
\DoxyCodeLine{00543\ \ \ thread\_yield();}
\DoxyCodeLine{00544\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00545\ \}}
\DoxyCodeLine{00546\ }
\DoxyCodeLine{00560\ std::istream\ *HTTPChannel::}
\DoxyCodeLine{00561\ open\_read\_body()\ \{}
\DoxyCodeLine{00562\ \ \ reset\_body\_stream();}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \ \ \textcolor{keywordflow}{if}\ ((\_state\ !=\ S\_read\_header\ \&\&\ \_state\ !=\ S\_begin\_body)\ ||\ \_source.is\_null())\ \{}
\DoxyCodeLine{00565\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00566\ \ \ \}}
\DoxyCodeLine{00567\ }
\DoxyCodeLine{00568\ \ \ \textcolor{keywordtype}{string}\ transfer\_coding\ =\ \mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(get\_header\_value(\textcolor{stringliteral}{"{}Transfer-\/Encoding"{}}));}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ std::istream\ *result;}
\DoxyCodeLine{00571\ \ \ \textcolor{keywordflow}{if}\ (transfer\_coding\ ==\ \textcolor{stringliteral}{"{}chunked"{}})\ \{}
\DoxyCodeLine{00572\ \ \ \ \ \textcolor{comment}{//\ "{}chunked"{}\ transfer\ encoding.\ \ This\ means\ we\ will\ have\ to\ decode\ the}}
\DoxyCodeLine{00573\ \ \ \ \ \textcolor{comment}{//\ length\ of\ the\ file\ as\ we\ read\ it\ in\ chunks.\ \ The\ IChunkedStream\ does}}
\DoxyCodeLine{00574\ \ \ \ \ \textcolor{comment}{//\ this.}}
\DoxyCodeLine{00575\ \ \ \ \ \_state\ =\ S\_reading\_body;}
\DoxyCodeLine{00576\ \ \ \ \ \_read\_index++;}
\DoxyCodeLine{00577\ \ \ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{new}\ IChunkedStream(\_source,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00578\ }
\DoxyCodeLine{00579\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00580\ \ \ \ \ \textcolor{comment}{//\ If\ the\ transfer\ encoding\ is\ anything\ else,\ assume\ "{}identity"{}.\ This\ is}}
\DoxyCodeLine{00581\ \ \ \ \ \textcolor{comment}{//\ just\ the\ literal\ characters\ following\ the\ header,\ up\ until\ \_file\_size}}
\DoxyCodeLine{00582\ \ \ \ \ \textcolor{comment}{//\ bytes\ have\ been\ read\ (if\ content-\/length\ was\ specified),\ or\ till\ end\ of}}
\DoxyCodeLine{00583\ \ \ \ \ \textcolor{comment}{//\ file\ otherwise.}}
\DoxyCodeLine{00584\ \ \ \ \ \_state\ =\ S\_reading\_body;}
\DoxyCodeLine{00585\ \ \ \ \ \_read\_index++;}
\DoxyCodeLine{00586\ \ \ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{new}\ IIdentityStream(\_source,\ \textcolor{keyword}{this},\ \_got\_file\_size,\ \_file\_size);}
\DoxyCodeLine{00587\ \ \ \}}
\DoxyCodeLine{00588\ \ \ result\ =\ \_body\_socket\_stream;}
\DoxyCodeLine{00589\ }
\DoxyCodeLine{00590\ \ \ \textcolor{keywordtype}{string}\ content\_encoding\ =\ \mbox{\hyperlink{string__utils_8cxx_a3101bc0142a49d9d11ad3f8cac766a2d}{trim}}(get\_header\_value(\textcolor{stringliteral}{"{}Content-\/Encoding"{}}));}
\DoxyCodeLine{00591\ \ \ \textcolor{keywordflow}{if}\ (!content\_encoding.empty())\ \{}
\DoxyCodeLine{00592\ \ \ \ \ vector\_string\ content\_encodings;}
\DoxyCodeLine{00593\ \ \ \ \ \mbox{\hyperlink{string__utils_8cxx_afcc82a47a52a95f3b9f10cbd16a8f575}{tokenize}}(\mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(content\_encoding),\ content\_encodings,\ \textcolor{stringliteral}{"{},"{}});}
\DoxyCodeLine{00594\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&encoding\ :\ content\_encodings)\ \{}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ trimmed\ =\ \mbox{\hyperlink{string__utils_8cxx_a3101bc0142a49d9d11ad3f8cac766a2d}{trim}}(encoding);}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (trimmed\ ==\ \textcolor{stringliteral}{"{}identity"{}})\ \{}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00599\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (trimmed\ ==\ \textcolor{stringliteral}{"{}gzip"{}}\ ||\ trimmed\ ==\ \textcolor{stringliteral}{"{}deflate"{}}\ ||\ trimmed\ ==\ \textcolor{stringliteral}{"{}x-\/gzip"{}})\ \{}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ "{}deflate"{}\ actually\ includes\ zlib\ header,\ which\ is\ accepted\ as\ well}}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ result\ =\ \textcolor{keyword}{new}\ IDecompressStream(result,\ \textcolor{keyword}{true},\ -\/1,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00603\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00604\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Content-\/Encoding\ not\ supported:\ "{}}\ <<\ trimmed\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ result;}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ \_body\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00614\ \ \ \ \ \}}
\DoxyCodeLine{00615\ \ \ \}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \ \ \_body\_stream\ =\ result;}
\DoxyCodeLine{00618\ \ \ \_body\_socket\_stream-\/>\_channel\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00619\ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00620\ }
\DoxyCodeLine{00621\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00622\ \}}
\DoxyCodeLine{00623\ }
\DoxyCodeLine{00630\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{00631\ close\_read\_body(istream\ *stream)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00632\ \ \ \textcolor{keywordflow}{if}\ (stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00633\ \ \ \ \ \textcolor{comment}{//\ For\ some\ reason-\/-\/compiler\ bug\ in\ gcc\ 3.2?-\/-\/explicitly\ deleting\ the}}
\DoxyCodeLine{00634\ \ \ \ \ \textcolor{comment}{//\ stream\ pointer\ does\ not\ call\ the\ appropriate\ global\ delete\ function;}}
\DoxyCodeLine{00635\ \ \ \ \ \textcolor{comment}{//\ instead\ apparently\ calling\ the\ system\ delete\ function.\ \ So\ we\ call\ the}}
\DoxyCodeLine{00636\ \ \ \ \ \textcolor{comment}{//\ delete\ function\ by\ hand\ instead.}}
\DoxyCodeLine{00637\ \textcolor{preprocessor}{\#if\ !defined(USE\_MEMORY\_NOWRAPPERS)\ \&\&\ defined(REDEFINE\_GLOBAL\_OPERATOR\_NEW)}}
\DoxyCodeLine{00638\ \ \ \ \ stream-\/>\string~istream();}
\DoxyCodeLine{00639\ \ \ \ \ (*global\_operator\_delete)(stream);}
\DoxyCodeLine{00640\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00641\ \ \ \ \ \textcolor{keyword}{delete}\ stream;}
\DoxyCodeLine{00642\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00643\ \ \ \}}
\DoxyCodeLine{00644\ \}}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00670\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00671\ download\_to\_file(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFilename}{Filename}}\ \&filename,\ \textcolor{keywordtype}{bool}\ subdocument\_resumes)\ \{}
\DoxyCodeLine{00672\ \ \ reset\_download\_to();}
\DoxyCodeLine{00673\ \ \ \_download\_to\_filename\ =\ filename;}
\DoxyCodeLine{00674\ \ \ \_download\_to\_filename.set\_binary();}
\DoxyCodeLine{00675\ \ \ \_subdocument\_resumes\ =\ subdocument\_resumes;}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00677\ \ \ \_download\_dest\ =\ DD\_file;}
\DoxyCodeLine{00678\ }
\DoxyCodeLine{00679\ \ \ \textcolor{keywordflow}{if}\ (\_wanted\_nonblocking\ \&\&\ \_state\ !=\ S\_read\_header)\ \{}
\DoxyCodeLine{00680\ \ \ \ \ \textcolor{comment}{//\ In\ nonblocking\ mode,\ we\ can't\ start\ the\ download\ yet;\ that\ will\ be\ done}}
\DoxyCodeLine{00681\ \ \ \ \ \textcolor{comment}{//\ later\ as\ run()\ is\ called.}}
\DoxyCodeLine{00682\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00683\ \ \ \}}
\DoxyCodeLine{00684\ }
\DoxyCodeLine{00685\ \ \ \textcolor{comment}{//\ In\ normal,\ blocking\ mode,\ go\ ahead\ and\ do\ the\ download.}}
\DoxyCodeLine{00686\ \ \ \textcolor{keywordflow}{if}\ (!open\_download\_file())\ \{}
\DoxyCodeLine{00687\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{00688\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00689\ \ \ \}}
\DoxyCodeLine{00690\ }
\DoxyCodeLine{00691\ \ \ \textcolor{keywordflow}{while}\ (run())\ \{}
\DoxyCodeLine{00692\ \ \ \}}
\DoxyCodeLine{00693\ \ \ \textcolor{keywordflow}{return}\ is\_download\_complete()\ \&\&\ is\_valid();}
\DoxyCodeLine{00694\ \}}
\DoxyCodeLine{00695\ }
\DoxyCodeLine{00719\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00720\ download\_to\_ram(\mbox{\hyperlink{classRamfile}{Ramfile}}\ *ramfile,\ \textcolor{keywordtype}{bool}\ subdocument\_resumes)\ \{}
\DoxyCodeLine{00721\ \ \ nassertr(ramfile\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{00722\ \ \ reset\_download\_to();}
\DoxyCodeLine{00723\ \ \ ramfile-\/>\_pos\ =\ 0;}
\DoxyCodeLine{00724\ \ \ \_download\_to\_ramfile\ =\ ramfile;}
\DoxyCodeLine{00725\ \ \ \_download\_dest\ =\ DD\_ram;}
\DoxyCodeLine{00726\ \ \ \_subdocument\_resumes\ =\ (subdocument\_resumes\ \&\&\ \_first\_byte\_delivered\ !=\ 0);}
\DoxyCodeLine{00727\ }
\DoxyCodeLine{00728\ \ \ \textcolor{keywordflow}{if}\ (\_wanted\_nonblocking\ \&\&\ \_state\ !=\ S\_read\_header)\ \{}
\DoxyCodeLine{00729\ \ \ \ \ \textcolor{comment}{//\ In\ nonblocking\ mode,\ we\ can't\ start\ the\ download\ yet;\ that\ will\ be\ done}}
\DoxyCodeLine{00730\ \ \ \ \ \textcolor{comment}{//\ later\ as\ run()\ is\ called.}}
\DoxyCodeLine{00731\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00732\ \ \ \}}
\DoxyCodeLine{00733\ }
\DoxyCodeLine{00734\ \ \ \textcolor{comment}{//\ In\ normal,\ blocking\ mode,\ go\ ahead\ and\ do\ the\ download.}}
\DoxyCodeLine{00735\ \ \ \textcolor{keywordflow}{if}\ (!open\_download\_file())\ \{}
\DoxyCodeLine{00736\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{00737\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00738\ \ \ \}}
\DoxyCodeLine{00739\ }
\DoxyCodeLine{00740\ \ \ \textcolor{keywordflow}{while}\ (run())\ \{}
\DoxyCodeLine{00741\ \ \ \}}
\DoxyCodeLine{00742\ \ \ \textcolor{keywordflow}{return}\ is\_download\_complete()\ \&\&\ is\_valid();}
\DoxyCodeLine{00743\ \}}
\DoxyCodeLine{00744\ }
\DoxyCodeLine{00769\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00770\ download\_to\_stream(ostream\ *strm,\ \textcolor{keywordtype}{bool}\ subdocument\_resumes)\ \{}
\DoxyCodeLine{00771\ \ \ reset\_download\_to();}
\DoxyCodeLine{00772\ \ \ \_download\_to\_stream\ =\ strm;}
\DoxyCodeLine{00773\ \ \ \_download\_to\_stream-\/>clear();}
\DoxyCodeLine{00774\ \ \ \_subdocument\_resumes\ =\ subdocument\_resumes;}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \ \ \_download\_dest\ =\ DD\_stream;}
\DoxyCodeLine{00777\ }
\DoxyCodeLine{00778\ \ \ \textcolor{keywordflow}{if}\ (\_wanted\_nonblocking\ \&\&\ \_state\ !=\ S\_read\_header)\ \{}
\DoxyCodeLine{00779\ \ \ \ \ \textcolor{comment}{//\ In\ nonblocking\ mode,\ we\ can't\ start\ the\ download\ yet;\ that\ will\ be\ done}}
\DoxyCodeLine{00780\ \ \ \ \ \textcolor{comment}{//\ later\ as\ run()\ is\ called.}}
\DoxyCodeLine{00781\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00782\ \ \ \}}
\DoxyCodeLine{00783\ }
\DoxyCodeLine{00784\ \ \ \textcolor{comment}{//\ In\ normal,\ blocking\ mode,\ go\ ahead\ and\ do\ the\ download.}}
\DoxyCodeLine{00785\ \ \ \textcolor{keywordflow}{if}\ (!open\_download\_file())\ \{}
\DoxyCodeLine{00786\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{00787\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00788\ \ \ \}}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \ \ \textcolor{keywordflow}{while}\ (run())\ \{}
\DoxyCodeLine{00791\ \ \ \}}
\DoxyCodeLine{00792\ \ \ \textcolor{keywordflow}{return}\ is\_download\_complete()\ \&\&\ is\_valid();}
\DoxyCodeLine{00793\ \}}
\DoxyCodeLine{00794\ }
\DoxyCodeLine{00803\ SocketStream\ *HTTPChannel::}
\DoxyCodeLine{00804\ get\_connection()\ \{}
\DoxyCodeLine{00805\ \ \ \textcolor{keywordflow}{if}\ (!is\_connection\_ready())\ \{}
\DoxyCodeLine{00806\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00807\ \ \ \}}
\DoxyCodeLine{00808\ }
\DoxyCodeLine{00809\ \ \ BioStream\ *stream\ =\ \_source-\/>get\_stream();}
\DoxyCodeLine{00810\ \ \ \_source-\/>set\_stream(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00811\ }
\DoxyCodeLine{00812\ \ \ \textcolor{comment}{//\ We're\ now\ passing\ ownership\ of\ the\ connection\ to\ the\ caller.}}
\DoxyCodeLine{00813\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00814\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00815\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00816\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}passing\ ownership\ of\ connection\ to\ caller.\(\backslash\)n"{}};}
\DoxyCodeLine{00817\ \ \ \}}
\DoxyCodeLine{00818\ \ \ reset\_to\_new();}
\DoxyCodeLine{00819\ }
\DoxyCodeLine{00820\ \ \ \textcolor{keywordflow}{return}\ stream;}
\DoxyCodeLine{00821\ \}}
\DoxyCodeLine{00822\ }
\DoxyCodeLine{00826\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{00827\ body\_stream\_destructs(ISocketStream\ *stream)\ \{}
\DoxyCodeLine{00828\ \ \ \textcolor{keywordflow}{if}\ (stream\ ==\ \_body\_socket\_stream)\ \{}
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ S\_reading\_body)\ \{}
\DoxyCodeLine{00830\ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_body\_socket\_stream-\/>get\_read\_state())\ \{}
\DoxyCodeLine{00831\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ISocketStream::RS\_complete:}
\DoxyCodeLine{00832\ \ \ \ \ \ \ \ \ finished\_body(\textcolor{keyword}{false});}
\DoxyCodeLine{00833\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00834\ }
\DoxyCodeLine{00835\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ ISocketStream::RS\_error:}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \ \ \_state\ =\ HTTPChannel::S\_failure;}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ HTTPChannel::SC\_lost\_connection;}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00839\ }
\DoxyCodeLine{00840\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00841\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00842\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00843\ \ \ \ \ \}}
\DoxyCodeLine{00844\ }
\DoxyCodeLine{00845\ \ \ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00846\ \ \ \ \ \_body\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00847\ \ \ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00848\ \ \ \}}
\DoxyCodeLine{00849\ \}}
\DoxyCodeLine{00850\ }
\DoxyCodeLine{00851\ }
\DoxyCodeLine{00856\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00857\ reached\_done\_state()\ \{}
\DoxyCodeLine{00858\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00859\ \textcolor{comment}{\ \ if\ (downloader\_cat.is\_spam())\ \{}}
\DoxyCodeLine{00860\ \textcolor{comment}{\ \ \ \ downloader\_cat.spam()}}
\DoxyCodeLine{00861\ \textcolor{comment}{\ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}}
\DoxyCodeLine{00862\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{}terminating\ run(),\ \_state\ =\ "{}\ <<\ \_state}}
\DoxyCodeLine{00863\ \textcolor{comment}{\ \ \ \ \ \ <<\ "{},\ \_done\_state\ =\ "{}\ <<\ \_done\_state\ <<\ "{}\(\backslash\)n"{};}}
\DoxyCodeLine{00864\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00865\ \textcolor{comment}{\ \ */}}
\DoxyCodeLine{00866\ }
\DoxyCodeLine{00867\ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ S\_failure)\ \{}
\DoxyCodeLine{00868\ \ \ \ \ \textcolor{comment}{//\ We\ had\ to\ give\ up.\ \ Each\ proxy\ we\ tried,\ in\ sequence,\ failed.\ \ But}}
\DoxyCodeLine{00869\ \ \ \ \ \textcolor{comment}{//\ maybe\ the\ last\ attempt\ didn't\ give\ us\ the\ most\ informative\ response;\ go}}
\DoxyCodeLine{00870\ \ \ \ \ \textcolor{comment}{//\ back\ and\ find\ the\ best\ one.}}
\DoxyCodeLine{00871\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_status\_list.empty())\ \{}
\DoxyCodeLine{00872\ \ \ \ \ \ \ \_status\_list.push\_back(\_status\_entry);}
\DoxyCodeLine{00873\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00875\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Reexamining\ failure\ responses.\(\backslash\)n"{}};}
\DoxyCodeLine{00877\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00878\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ best\_i\ =\ 0;}
\DoxyCodeLine{00879\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00880\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00881\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00882\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ 0\ <<\ \textcolor{stringliteral}{"{}.\ "{}}\ <<\ \_status\_list[0].\_status\_code\ <<\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{00883\ \ \ \ \ \ \ \ \ \ \ <<\ \_status\_list[0].\_status\_string\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00884\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00885\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 1;\ i\ <\ \_status\_list.size();\ i++)\ \{}
\DoxyCodeLine{00886\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00887\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00889\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ i\ <<\ \textcolor{stringliteral}{"{}.\ "{}}\ <<\ \_status\_list[i].\_status\_code\ <<\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{00890\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_status\_list[i].\_status\_string\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (more\_useful\_status\_code(\_status\_list[i].\_status\_code,}
\DoxyCodeLine{00893\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_status\_list[best\_i].\_status\_code))\ \{}
\DoxyCodeLine{00894\ \ \ \ \ \ \ \ \ \ \ best\_i\ =\ i;}
\DoxyCodeLine{00895\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00896\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00897\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00898\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00899\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00900\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}chose\ index\ "{}}\ <<\ best\_i\ <<\ \textcolor{stringliteral}{"{},\ above.\(\backslash\)n"{}};}
\DoxyCodeLine{00901\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00902\ \ \ \ \ \ \ \_status\_entry\ =\ \_status\_list[best\_i];}
\DoxyCodeLine{00903\ \ \ \ \ \ \ \_status\_list.clear();}
\DoxyCodeLine{00904\ \ \ \ \ \}}
\DoxyCodeLine{00905\ }
\DoxyCodeLine{00906\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00907\ \ \ \}}
\DoxyCodeLine{00908\ }
\DoxyCodeLine{00909\ \ \ \textcolor{comment}{//\ We\ don't\ need\ the\ list\ of\ previous\ failures\ any\ more-\/-\/we've\ connected.}}
\DoxyCodeLine{00910\ \ \ \_status\_list.clear();}
\DoxyCodeLine{00911\ }
\DoxyCodeLine{00912\ \ \ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_none)\ \{}
\DoxyCodeLine{00913\ \ \ \ \ \textcolor{comment}{//\ All\ done.}}
\DoxyCodeLine{00914\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00915\ }
\DoxyCodeLine{00916\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00917\ \ \ \ \ \textcolor{comment}{//\ Oops,\ we\ have\ to\ download\ the\ body\ now.}}
\DoxyCodeLine{00918\ \ \ \ \ open\_read\_body();}
\DoxyCodeLine{00919\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_body\_stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00920\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00921\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00922\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00923\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ download\ body:\ "{}}\ <<\ \_request.get\_url()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00924\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00925\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00926\ }
\DoxyCodeLine{00927\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00928\ \ \ \ \ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00929\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state\ !=\ S\_reading\_body)\ \{}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \ \ reset\_body\_stream();}
\DoxyCodeLine{00931\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00932\ \ \ \ \ \ \ \_started\_download\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00933\ }
\DoxyCodeLine{00934\ \ \ \ \ \ \ \_done\_state\ =\ S\_read\_trailer;}
\DoxyCodeLine{00935\ \ \ \ \ \ \ \_last\_run\_time\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{00936\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00937\ \ \ \ \ \}}
\DoxyCodeLine{00938\ \ \ \}}
\DoxyCodeLine{00939\ \}}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00946\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00947\ run\_try\_next\_proxy()\ \{}
\DoxyCodeLine{00948\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_next\_index\ <\ \_proxies.size())\ \{}
\DoxyCodeLine{00949\ \ \ \ \ \textcolor{comment}{//\ Record\ the\ previous\ proxy's\ status\ entry,\ so\ we\ can\ come\ back\ to\ it}}
\DoxyCodeLine{00950\ \ \ \ \ \textcolor{comment}{//\ later\ if\ we\ get\ nonsense\ from\ the\ remaining\ proxies.}}
\DoxyCodeLine{00951\ \ \ \ \ \_status\_list.push\_back(\_status\_entry);}
\DoxyCodeLine{00952\ \ \ \ \ \_status\_entry\ =\ StatusEntry();}
\DoxyCodeLine{00953\ }
\DoxyCodeLine{00954\ \ \ \ \ \textcolor{comment}{//\ Now\ try\ the\ next\ proxy\ in\ sequence.}}
\DoxyCodeLine{00955\ \ \ \ \ \_proxy\ =\ \_proxies[\_proxy\_next\_index];}
\DoxyCodeLine{00956\ \ \ \ \ \_proxy\_auth\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00957\ \ \ \ \ \_proxy\_next\_index++;}
\DoxyCodeLine{00958\ \ \ \ \ close\_connection();}
\DoxyCodeLine{00959\ \ \ \ \ reconsider\_proxy();}
\DoxyCodeLine{00960\ \ \ \ \ \_state\ =\ S\_connecting;}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00963\ \ \ \}}
\DoxyCodeLine{00964\ }
\DoxyCodeLine{00965\ \ \ \textcolor{comment}{//\ No\ more\ proxies\ to\ try,\ or\ we're\ not\ using\ a\ proxy.}}
\DoxyCodeLine{00966\ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{00967\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00968\ \}}
\DoxyCodeLine{00969\ }
\DoxyCodeLine{00974\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{00975\ run\_connecting()\ \{}
\DoxyCodeLine{00976\ \ \ \_status\_entry\ =\ StatusEntry();}
\DoxyCodeLine{00977\ }
\DoxyCodeLine{00978\ \ \ \textcolor{keywordflow}{if}\ (!\_bio-\/>connect())\ \{}
\DoxyCodeLine{00979\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio-\/>should\_retry())\ \{}
\DoxyCodeLine{00980\ \ \ \ \ \ \ \_state\ =\ S\_connecting\_wait;}
\DoxyCodeLine{00981\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00982\ \ \ \ \ \}}
\DoxyCodeLine{00983\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{00984\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00985\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ connect\ to\ "{}}\ <<\ \_bio-\/>get\_server\_name()\ <<\ \textcolor{stringliteral}{"{}\ port\ "{}}}
\DoxyCodeLine{00986\ \ \ \ \ \ \ <<\ \_bio-\/>get\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00987\ \ \ \ \ OpenSSLWrapper::get\_global\_ptr()-\/>notify\_ssl\_errors();}
\DoxyCodeLine{00988\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_no\_connection;}
\DoxyCodeLine{00989\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{00990\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00991\ \ \ \}}
\DoxyCodeLine{00992\ }
\DoxyCodeLine{00993\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{00994\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{00995\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{00996\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Connected\ to\ "{}}\ <<\ \_bio-\/>get\_server\_name()\ <<\ \textcolor{stringliteral}{"{}\ port\ "{}}}
\DoxyCodeLine{00997\ \ \ \ \ \ \ <<\ \_bio-\/>get\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00998\ \ \ \}}
\DoxyCodeLine{00999\ }
\DoxyCodeLine{01000\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_tunnel\_now)\ \{}
\DoxyCodeLine{01001\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_proxy.get\_scheme()\ ==\ \textcolor{stringliteral}{"{}socks"{}})\ \{}
\DoxyCodeLine{01002\ \ \ \ \ \ \ \_state\ =\ S\_socks\_proxy\_greet;}
\DoxyCodeLine{01003\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01004\ \ \ \ \ \ \ \_state\ =\ S\_http\_proxy\_ready;}
\DoxyCodeLine{01005\ \ \ \ \ \}}
\DoxyCodeLine{01006\ }
\DoxyCodeLine{01007\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01008\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_want\_ssl)\ \{}
\DoxyCodeLine{01009\ \ \ \ \ \ \ \_state\ =\ S\_setup\_ssl;}
\DoxyCodeLine{01010\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01011\ \ \ \ \ \ \ \_state\ =\ S\_ready;}
\DoxyCodeLine{01012\ \ \ \ \ \}}
\DoxyCodeLine{01013\ \ \ \}}
\DoxyCodeLine{01014\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01015\ \}}
\DoxyCodeLine{01016\ }
\DoxyCodeLine{01022\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01023\ run\_connecting\_wait()\ \{}
\DoxyCodeLine{01024\ \ \ \textcolor{keywordtype}{int}\ fd\ =\ -\/1;}
\DoxyCodeLine{01025\ \ \ BIO\_get\_fd(*\_bio,\ \&fd);}
\DoxyCodeLine{01026\ \ \ \textcolor{keywordflow}{if}\ (fd\ <\ 0)\ \{}
\DoxyCodeLine{01027\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01028\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01029\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}nonblocking\ socket\ BIO\ has\ no\ file\ descriptor.\(\backslash\)n"{}};}
\DoxyCodeLine{01030\ \ \ \ \ \textcolor{comment}{//\ This\ shouldn't\ be\ possible.}}
\DoxyCodeLine{01031\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_internal\_error;}
\DoxyCodeLine{01032\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01033\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01034\ \ \ \}}
\DoxyCodeLine{01035\ }
\DoxyCodeLine{01036\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01037\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01038\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01039\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}waiting\ to\ connect\ to\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{01040\ \ \ \}}
\DoxyCodeLine{01041\ \ \ \mbox{\hyperlink{structfd__set}{fd\_set}}\ wset;}
\DoxyCodeLine{01042\ \ \ FD\_ZERO(\&wset);}
\DoxyCodeLine{01043\ \ \ FD\_SET(fd,\ \&wset);}
\DoxyCodeLine{01044\ \ \ \textcolor{keyword}{struct\ }timeval\ tv;}
\DoxyCodeLine{01045\ \ \ \textcolor{keywordflow}{if}\ (get\_blocking\_connect())\ \{}
\DoxyCodeLine{01046\ \ \ \ \ \textcolor{comment}{//\ Since\ we'll\ be\ blocking\ on\ this\ connect,\ fill\ in\ the\ timeout\ into\ the}}
\DoxyCodeLine{01047\ \ \ \ \ \textcolor{comment}{//\ structure.}}
\DoxyCodeLine{01048\ \ \ \ \ tv.tv\_sec\ =\ (int)\_connect\_timeout;}
\DoxyCodeLine{01049\ \ \ \ \ tv.tv\_usec\ =\ (int)((\_connect\_timeout\ -\/\ tv.tv\_sec)\ *\ 1000000.0);}
\DoxyCodeLine{01050\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01051\ \ \ \ \ \textcolor{comment}{//\ We\ won't\ block\ on\ this\ connect,\ so\ select()\ for\ 0\ time.}}
\DoxyCodeLine{01052\ \ \ \ \ tv.tv\_sec\ =\ 0;}
\DoxyCodeLine{01053\ \ \ \ \ tv.tv\_usec\ =\ 0;}
\DoxyCodeLine{01054\ \ \ \}}
\DoxyCodeLine{01055\ \ \ \textcolor{keywordtype}{int}\ errcode\ =\ select(fd\ +\ 1,\ \textcolor{keyword}{nullptr},\ \&wset,\ \textcolor{keyword}{nullptr},\ \&tv);}
\DoxyCodeLine{01056\ \ \ \textcolor{keywordflow}{if}\ (errcode\ <\ 0)\ \{}
\DoxyCodeLine{01057\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01058\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01059\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Error\ in\ select.\(\backslash\)n"{}};}
\DoxyCodeLine{01060\ \ \ \ \ \textcolor{comment}{//\ This\ shouldn't\ be\ possible.}}
\DoxyCodeLine{01061\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_internal\_error;}
\DoxyCodeLine{01062\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01063\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01064\ \ \ \}}
\DoxyCodeLine{01065\ }
\DoxyCodeLine{01066\ \ \ \textcolor{keywordflow}{if}\ (errcode\ ==\ 0)\ \{}
\DoxyCodeLine{01067\ \ \ \ \ \textcolor{comment}{//\ Nothing's\ happened\ so\ far;\ come\ back\ later.}}
\DoxyCodeLine{01068\ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_blocking\_connect()\ ||}
\DoxyCodeLine{01069\ \ \ \ \ \ \ \ \ (TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/}
\DoxyCodeLine{01070\ \ \ \ \ \ \ \ \ \ \_started\_connecting\_time\ >\ get\_connect\_timeout()))\ \{}
\DoxyCodeLine{01071\ \ \ \ \ \ \ \textcolor{comment}{//\ Time\ to\ give\ up.}}
\DoxyCodeLine{01072\ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01073\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01074\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Timeout\ connecting\ to\ "{}}}
\DoxyCodeLine{01075\ \ \ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{01076\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ for\ "{}}\ <<\ \_request.get\_url()}
\DoxyCodeLine{01077\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{01078\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_timeout;}
\DoxyCodeLine{01079\ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01080\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01081\ \ \ \ \ \}}
\DoxyCodeLine{01082\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01083\ \ \ \}}
\DoxyCodeLine{01084\ }
\DoxyCodeLine{01085\ \ \ \textcolor{comment}{//\ The\ socket\ is\ now\ ready\ for\ writing.}}
\DoxyCodeLine{01086\ \ \ \_state\ =\ S\_connecting;}
\DoxyCodeLine{01087\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01088\ \}}
\DoxyCodeLine{01089\ }
\DoxyCodeLine{01090\ }
\DoxyCodeLine{01096\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01097\ run\_http\_proxy\_ready()\ \{}
\DoxyCodeLine{01098\ \ \ \textcolor{comment}{//\ If\ there's\ a\ request\ to\ be\ sent\ to\ the\ proxy,\ send\ it\ now.}}
\DoxyCodeLine{01099\ \ \ nassertr(!\_proxy\_request\_text.empty(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{01100\ \ \ \textcolor{keywordflow}{if}\ (!server\_send(\_proxy\_request\_text,\ \textcolor{keyword}{false}))\ \{}
\DoxyCodeLine{01101\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01102\ \ \ \}}
\DoxyCodeLine{01103\ }
\DoxyCodeLine{01104\ \ \ \textcolor{comment}{//\ All\ done\ sending\ request.}}
\DoxyCodeLine{01105\ \ \ \_state\ =\ S\_http\_proxy\_request\_sent;}
\DoxyCodeLine{01106\ \ \ \_sent\_request\_time\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{01107\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01108\ \}}
\DoxyCodeLine{01109\ }
\DoxyCodeLine{01116\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01117\ run\_http\_proxy\_request\_sent()\ \{}
\DoxyCodeLine{01118\ \ \ \textcolor{comment}{//\ Wait\ for\ the\ first\ line\ to\ come\ back\ from\ the\ server.}}
\DoxyCodeLine{01119\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{01120\ \ \ \textcolor{keywordflow}{if}\ (!server\_getline\_failsafe(line))\ \{}
\DoxyCodeLine{01121\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01122\ \ \ \}}
\DoxyCodeLine{01123\ }
\DoxyCodeLine{01124\ \ \ \textcolor{comment}{//\ Skip\ unexpected\ blank\ lines.\ \ We're\ just\ being\ generous\ here.}}
\DoxyCodeLine{01125\ \ \ \textcolor{keywordflow}{while}\ (line.empty())\ \{}
\DoxyCodeLine{01126\ \ \ \ \ \textcolor{keywordflow}{if}\ (!server\_getline\_failsafe(line))\ \{}
\DoxyCodeLine{01127\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01128\ \ \ \ \ \}}
\DoxyCodeLine{01129\ \ \ \}}
\DoxyCodeLine{01130\ }
\DoxyCodeLine{01131\ \ \ \textcolor{keywordflow}{if}\ (!parse\_http\_response(line))\ \{}
\DoxyCodeLine{01132\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01133\ \ \ \}}
\DoxyCodeLine{01134\ }
\DoxyCodeLine{01135\ \ \ \_state\ =\ S\_http\_proxy\_reading\_header;}
\DoxyCodeLine{01136\ \ \ \_current\_field\_name\ =\ string();}
\DoxyCodeLine{01137\ \ \ \_current\_field\_value\ =\ string();}
\DoxyCodeLine{01138\ \ \ \_headers.clear();}
\DoxyCodeLine{01139\ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01140\ \ \ \_got\_transfer\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01141\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01142\ \}}
\DoxyCodeLine{01143\ }
\DoxyCodeLine{01148\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01149\ run\_http\_proxy\_reading\_header()\ \{}
\DoxyCodeLine{01150\ \ \ \textcolor{keywordflow}{if}\ (parse\_http\_header())\ \{}
\DoxyCodeLine{01151\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01152\ \ \ \}}
\DoxyCodeLine{01153\ }
\DoxyCodeLine{01154\ \ \ \_redirect\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Location"{}});}
\DoxyCodeLine{01155\ \ \ \textcolor{comment}{//\ We\ can\ take\ the\ proxy's\ word\ for\ it\ that\ this\ is\ the\ actual\ URL\ for\ the}}
\DoxyCodeLine{01156\ \ \ \textcolor{comment}{//\ redirect.}}
\DoxyCodeLine{01157\ }
\DoxyCodeLine{01158\ \ \ \_server\_response\_has\_no\_body\ =}
\DoxyCodeLine{01159\ \ \ \ \ (get\_status\_code()\ /\ 100\ ==\ 1\ ||}
\DoxyCodeLine{01160\ \ \ \ \ \ get\_status\_code()\ ==\ 204\ ||}
\DoxyCodeLine{01161\ \ \ \ \ \ get\_status\_code()\ ==\ 304);}
\DoxyCodeLine{01162\ }
\DoxyCodeLine{01163\ \ \ \textcolor{keywordtype}{int}\ last\_status\ =\ \_last\_status\_code;}
\DoxyCodeLine{01164\ \ \ \_last\_status\_code\ =\ get\_status\_code();}
\DoxyCodeLine{01165\ }
\DoxyCodeLine{01166\ \ \ \textcolor{keywordflow}{if}\ (get\_status\_code()\ ==\ 407\ \&\&\ last\_status\ !=\ 407\ \&\&\ !\_proxy.empty())\ \{}
\DoxyCodeLine{01167\ \ \ \ \ \textcolor{comment}{//\ 407:\ not\ authorized\ to\ proxy.\ \ Try\ to\ get\ the\ authorization.}}
\DoxyCodeLine{01168\ \ \ \ \ \textcolor{keywordtype}{string}\ authenticate\_request\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Proxy-\/Authenticate"{}});}
\DoxyCodeLine{01169\ \ \ \ \ \_proxy\_auth\ =\ \_client-\/>generate\_auth(\_proxy,\ \textcolor{keyword}{true},\ authenticate\_request);}
\DoxyCodeLine{01170\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_auth\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01171\ \ \ \ \ \ \ \_proxy\_realm\ =\ \_proxy\_auth-\/>get\_realm();}
\DoxyCodeLine{01172\ \ \ \ \ \ \ \_proxy\_username\ =\ \_client-\/>select\_username(\_proxy,\ \textcolor{keyword}{true},\ \_proxy\_realm);}
\DoxyCodeLine{01173\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_proxy\_username.empty())\ \{}
\DoxyCodeLine{01174\ \ \ \ \ \ \ \ \ make\_proxy\_request\_text();}
\DoxyCodeLine{01175\ }
\DoxyCodeLine{01176\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Roll\ the\ state\ forward\ to\ force\ a\ new\ request.}}
\DoxyCodeLine{01177\ \ \ \ \ \ \ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{01178\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01179\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01180\ \ \ \ \ \}}
\DoxyCodeLine{01181\ \ \ \}}
\DoxyCodeLine{01182\ }
\DoxyCodeLine{01183\ \ \ \textcolor{keywordflow}{if}\ (!is\_valid())\ \{}
\DoxyCodeLine{01184\ \ \ \ \ \textcolor{comment}{//\ Proxy\ wouldn't\ open\ connection.}}
\DoxyCodeLine{01185\ }
\DoxyCodeLine{01186\ \ \ \ \ \textcolor{comment}{//\ Change\ some\ of\ the\ status\ codes\ a\ proxy\ might\ return\ to\ differentiate}}
\DoxyCodeLine{01187\ \ \ \ \ \textcolor{comment}{//\ them\ from\ similar\ status\ codes\ the\ destination\ server\ might\ have}}
\DoxyCodeLine{01188\ \ \ \ \ \textcolor{comment}{//\ returned.}}
\DoxyCodeLine{01189\ \ \ \ \ \textcolor{keywordflow}{if}\ (get\_status\_code()\ !=\ 407)\ \{}
\DoxyCodeLine{01190\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ +=\ 1000;}
\DoxyCodeLine{01191\ \ \ \ \ \}}
\DoxyCodeLine{01192\ }
\DoxyCodeLine{01193\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01194\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01195\ \ \ \}}
\DoxyCodeLine{01196\ }
\DoxyCodeLine{01197\ \ \ \textcolor{comment}{//\ Now\ we\ have\ a\ tunnel\ opened\ through\ the\ proxy.}}
\DoxyCodeLine{01198\ \ \ make\_request\_text();}
\DoxyCodeLine{01199\ }
\DoxyCodeLine{01200\ \ \ \textcolor{keywordflow}{if}\ (\_want\_ssl)\ \{}
\DoxyCodeLine{01201\ \ \ \ \ \_state\ =\ S\_setup\_ssl;}
\DoxyCodeLine{01202\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01203\ \ \ \ \ \_state\ =\ S\_ready;}
\DoxyCodeLine{01204\ \ \ \}}
\DoxyCodeLine{01205\ }
\DoxyCodeLine{01206\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01207\ \}}
\DoxyCodeLine{01208\ }
\DoxyCodeLine{01213\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01214\ run\_socks\_proxy\_greet()\ \{}
\DoxyCodeLine{01215\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ socks\_greeting[]\ =\ \{}
\DoxyCodeLine{01216\ \ \ \ \ 0x05,\ \textcolor{comment}{//\ Socks\ version\ 5}}
\DoxyCodeLine{01217\ \ \ \ \ 0x01,\ \textcolor{comment}{//\ Number\ of\ supported\ login\ methods}}
\DoxyCodeLine{01218\ \ \ \ \ 0x00,\ \textcolor{comment}{//\ Login\ method\ 0:\ no\ authentication}}
\DoxyCodeLine{01219\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{01220\ \textcolor{comment}{\ \ \ \ 0x01,\ //\ Login\ method\ 1:\ GSSAPI}}
\DoxyCodeLine{01221\ \textcolor{comment}{\ \ \ \ 0x02\ \ //\ Login\ method\ 2:\ username/password}}
\DoxyCodeLine{01222\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{01223\ \ \ \};}
\DoxyCodeLine{01224\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ socks\_greeting\_len\ =\ \textcolor{keyword}{sizeof}(socks\_greeting);}
\DoxyCodeLine{01225\ \ \ \textcolor{keywordflow}{if}\ (!server\_send(\textcolor{keywordtype}{string}(socks\_greeting,\ socks\_greeting\_len),\ \textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{01226\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01227\ \ \ \}}
\DoxyCodeLine{01228\ \ \ \_sent\_request\_time\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{01229\ }
\DoxyCodeLine{01230\ \ \ \textcolor{comment}{//\ All\ done\ sending\ request.}}
\DoxyCodeLine{01231\ \ \ \_state\ =\ S\_socks\_proxy\_greet\_reply;}
\DoxyCodeLine{01232\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01233\ \}}
\DoxyCodeLine{01234\ }
\DoxyCodeLine{01238\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01239\ run\_socks\_proxy\_greet\_reply()\ \{}
\DoxyCodeLine{01240\ \ \ \textcolor{keywordtype}{string}\ reply;}
\DoxyCodeLine{01241\ }
\DoxyCodeLine{01242\ \ \ \textcolor{comment}{//\ Get\ the\ two-\/byte\ reply\ from\ the\ SOCKS\ server.}}
\DoxyCodeLine{01243\ \ \ \textcolor{keywordflow}{if}\ (!server\_get\_failsafe(reply,\ 2))\ \{}
\DoxyCodeLine{01244\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01245\ \ \ \}}
\DoxyCodeLine{01246\ }
\DoxyCodeLine{01247\ \ \ \textcolor{keywordflow}{if}\ (reply[0]\ !=\ 0x05)\ \{}
\DoxyCodeLine{01248\ \ \ \ \ \textcolor{comment}{//\ We\ only\ speak\ Socks5.}}
\DoxyCodeLine{01249\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01250\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01251\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Rejecting\ Socks\ version\ "{}}\ <<\ (int)reply[0]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01252\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_invalid\_version;}
\DoxyCodeLine{01253\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01254\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01255\ \ \ \}}
\DoxyCodeLine{01256\ }
\DoxyCodeLine{01257\ \ \ \textcolor{keywordflow}{if}\ (reply[1]\ ==\ (\textcolor{keywordtype}{char})0xff)\ \{}
\DoxyCodeLine{01258\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01259\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01260\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Socks\ server\ does\ not\ accept\ our\ available\ login\ methods.\(\backslash\)n"{}};}
\DoxyCodeLine{01261\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_no\_acceptable\_login\_method;}
\DoxyCodeLine{01262\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01263\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01264\ \ \ \}}
\DoxyCodeLine{01265\ }
\DoxyCodeLine{01266\ \ \ \textcolor{keywordflow}{if}\ (reply[1]\ ==\ 0x00)\ \{}
\DoxyCodeLine{01267\ \ \ \ \ \textcolor{comment}{//\ No\ login\ method\ required.\ \ Proceed\ directly\ to\ the\ connect\ message.}}
\DoxyCodeLine{01268\ \ \ \ \ \_state\ =\ S\_socks\_proxy\_connect;}
\DoxyCodeLine{01269\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01270\ \ \ \}}
\DoxyCodeLine{01271\ }
\DoxyCodeLine{01272\ \ \ \textcolor{comment}{//\ The\ server\ accepted\ a\ login\ method\ we\ didn't\ offer!}}
\DoxyCodeLine{01273\ \ \ downloader\_cat.info()}
\DoxyCodeLine{01274\ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01275\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Socks\ server\ accepted\ unrequested\ login\ method\ "{}}}
\DoxyCodeLine{01276\ \ \ \ \ <<\ (int)reply[1]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01277\ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_no\_acceptable\_login\_method;}
\DoxyCodeLine{01278\ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01279\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01280\ \}}
\DoxyCodeLine{01281\ }
\DoxyCodeLine{01285\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01286\ run\_socks\_proxy\_connect()\ \{}
\DoxyCodeLine{01287\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ socks\_connect[]\ =\ \{}
\DoxyCodeLine{01288\ \ \ \ \ 0x05,\ \textcolor{comment}{//\ Socks\ version\ 5}}
\DoxyCodeLine{01289\ \ \ \ \ 0x01,\ \textcolor{comment}{//\ Command\ 1:\ connect}}
\DoxyCodeLine{01290\ \ \ \ \ 0x00,\ \textcolor{comment}{//\ reserved}}
\DoxyCodeLine{01291\ \ \ \ \ 0x03,\ \textcolor{comment}{//\ DNS\ name}}
\DoxyCodeLine{01292\ \ \ \};}
\DoxyCodeLine{01293\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ socks\_connect\_len\ =\ \textcolor{keyword}{sizeof}(socks\_connect);}
\DoxyCodeLine{01294\ }
\DoxyCodeLine{01295\ \ \ \textcolor{keywordtype}{string}\ hostname\ =\ \_request.get\_url().get\_server();}
\DoxyCodeLine{01296\ \ \ \textcolor{keywordtype}{int}\ port\ =\ \_request.get\_url().get\_port();}
\DoxyCodeLine{01297\ }
\DoxyCodeLine{01298\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01299\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01300\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01301\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Requesting\ SOCKS5\ connection\ to\ "{}}}
\DoxyCodeLine{01302\ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01303\ \ \ \}}
\DoxyCodeLine{01304\ }
\DoxyCodeLine{01305\ \ \ \textcolor{keywordtype}{string}\ connect\ =}
\DoxyCodeLine{01306\ \ \ \ \ string(socks\_connect,\ socks\_connect\_len)\ +}
\DoxyCodeLine{01307\ \ \ \ \ string(1,\ (\textcolor{keywordtype}{char})hostname.length())\ +}
\DoxyCodeLine{01308\ \ \ \ \ hostname\ +}
\DoxyCodeLine{01309\ \ \ \ \ string(1,\ (\textcolor{keywordtype}{char})((port\ >>\ 8)\ \&\ 0xff))\ +}
\DoxyCodeLine{01310\ \ \ \ \ string(1,\ (\textcolor{keywordtype}{char})(port\ \&\ 0xff));}
\DoxyCodeLine{01311\ }
\DoxyCodeLine{01312\ \ \ \textcolor{keywordflow}{if}\ (!server\_send(connect,\ \textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{01313\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01314\ \ \ \}}
\DoxyCodeLine{01315\ \ \ \_sent\_request\_time\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{01316\ }
\DoxyCodeLine{01317\ \ \ \_state\ =\ S\_socks\_proxy\_connect\_reply;}
\DoxyCodeLine{01318\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01319\ \}}
\DoxyCodeLine{01320\ }
\DoxyCodeLine{01324\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01325\ run\_socks\_proxy\_connect\_reply()\ \{}
\DoxyCodeLine{01326\ \ \ \textcolor{keywordtype}{string}\ reply;}
\DoxyCodeLine{01327\ }
\DoxyCodeLine{01328\ \ \ \textcolor{comment}{//\ Get\ the\ first\ two\ bytes\ of\ the\ connect\ reply.}}
\DoxyCodeLine{01329\ \ \ \textcolor{keywordflow}{if}\ (!server\_get\_failsafe(reply,\ 2))\ \{}
\DoxyCodeLine{01330\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01331\ \ \ \}}
\DoxyCodeLine{01332\ }
\DoxyCodeLine{01333\ \ \ \textcolor{keywordflow}{if}\ (reply[0]\ !=\ 0x05)\ \{}
\DoxyCodeLine{01334\ \ \ \ \ \textcolor{comment}{//\ We\ only\ speak\ Socks5.}}
\DoxyCodeLine{01335\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01336\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01337\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Rejecting\ Socks\ version\ "{}}\ <<\ (int)reply[0]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01338\ \ \ \ \ close\_connection();\ \ \textcolor{comment}{//\ connection\ is\ now\ bad.}}
\DoxyCodeLine{01339\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_invalid\_version;}
\DoxyCodeLine{01340\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01341\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01342\ \ \ \}}
\DoxyCodeLine{01343\ }
\DoxyCodeLine{01344\ \ \ \textcolor{keywordflow}{if}\ (reply[1]\ !=\ 0x00)\ \{}
\DoxyCodeLine{01345\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01346\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01347\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Connection\ refused,\ SOCKS\ code\ "{}}\ <<\ (int)reply[1]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01348\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{01349\ \textcolor{comment}{\ \ \ \ \ \ Socks\ error\ codes\ (from\ RFC1928):}}
\DoxyCodeLine{01350\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'00'\ succeeded}}
\DoxyCodeLine{01351\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'01'\ general\ SOCKS\ server\ failure}}
\DoxyCodeLine{01352\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'02'\ connection\ not\ allowed\ by\ ruleset}}
\DoxyCodeLine{01353\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'03'\ Network\ unreachable}}
\DoxyCodeLine{01354\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'04'\ Host\ unreachable}}
\DoxyCodeLine{01355\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'05'\ Connection\ refused}}
\DoxyCodeLine{01356\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'06'\ TTL\ expired}}
\DoxyCodeLine{01357\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'07'\ Command\ not\ supported}}
\DoxyCodeLine{01358\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'08'\ Address\ type\ not\ supported}}
\DoxyCodeLine{01359\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ o\ \ X'09'\ to\ X'FF'\ unassigned}}
\DoxyCodeLine{01360\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{01361\ }
\DoxyCodeLine{01362\ \ \ \ \ \textcolor{keywordflow}{switch}\ (reply[1])\ \{}
\DoxyCodeLine{01363\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x03:}
\DoxyCodeLine{01364\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x04:}
\DoxyCodeLine{01365\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x05:}
\DoxyCodeLine{01366\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x06:}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \textcolor{comment}{//\ These\ generally\ mean\ the\ same\ thing:\ the\ SOCKS\ proxy\ tried,\ but}}
\DoxyCodeLine{01368\ \ \ \ \ \ \ \textcolor{comment}{//\ couldn't\ reach\ the\ host.}}
\DoxyCodeLine{01369\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_no\_connection;}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01371\ }
\DoxyCodeLine{01372\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01373\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_refused;}
\DoxyCodeLine{01374\ \ \ \ \ \}}
\DoxyCodeLine{01375\ }
\DoxyCodeLine{01376\ \ \ \ \ close\_connection();\ \ \textcolor{comment}{//\ connection\ is\ now\ bad.}}
\DoxyCodeLine{01377\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01378\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01379\ \ \ \}}
\DoxyCodeLine{01380\ }
\DoxyCodeLine{01381\ \ \ \textcolor{comment}{//\ Now\ put\ those\ bytes\ back,\ and\ get\ five\ bytes\ of\ the\ reply.}}
\DoxyCodeLine{01382\ \ \ \_working\_get\ =\ reply;}
\DoxyCodeLine{01383\ \ \ \textcolor{keywordflow}{if}\ (!server\_get\_failsafe(reply,\ 5))\ \{}
\DoxyCodeLine{01384\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01385\ \ \ \}}
\DoxyCodeLine{01386\ }
\DoxyCodeLine{01387\ \ \ \textcolor{comment}{//\ Figure\ out\ how\ many\ bytes\ total\ we\ will\ expect\ for\ the\ reply.}}
\DoxyCodeLine{01388\ \ \ \textcolor{keywordtype}{int}\ total\_bytes\ =\ 6;}
\DoxyCodeLine{01389\ }
\DoxyCodeLine{01390\ \ \ \textcolor{keywordflow}{switch}\ (reply[3])\ \{}
\DoxyCodeLine{01391\ \ \ \textcolor{keywordflow}{case}\ 0x01:\ \ \textcolor{comment}{//\ IPv4}}
\DoxyCodeLine{01392\ \ \ \ \ total\_bytes\ +=\ 4;}
\DoxyCodeLine{01393\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01394\ }
\DoxyCodeLine{01395\ \ \ \textcolor{keywordflow}{case}\ 0x03:\ \ \textcolor{comment}{//\ DNS}}
\DoxyCodeLine{01396\ \ \ \ \ total\_bytes\ +=\ (\textcolor{keywordtype}{unsigned}\ int)reply[4];}
\DoxyCodeLine{01397\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01398\ }
\DoxyCodeLine{01399\ \ \ \textcolor{keywordflow}{case}\ 0x04:\ \ \textcolor{comment}{//\ IPv6}}
\DoxyCodeLine{01400\ \ \ \ \ total\_bytes\ +=\ 16;}
\DoxyCodeLine{01401\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01402\ }
\DoxyCodeLine{01403\ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01404\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01405\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01406\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unsupported\ SOCKS\ address\ type:\ "{}}\ <<\ (int)reply[3]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01407\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_socks\_invalid\_version;}
\DoxyCodeLine{01408\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01409\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01410\ \ \ \}}
\DoxyCodeLine{01411\ }
\DoxyCodeLine{01412\ \ \ \textcolor{comment}{//\ Now\ put\ back\ the\ bytes\ we've\ read\ so\ far,\ and\ get\ the\ rest\ of\ them.}}
\DoxyCodeLine{01413\ \ \ \_working\_get\ =\ reply;}
\DoxyCodeLine{01414\ \ \ \textcolor{keywordflow}{if}\ (!server\_get\_failsafe(reply,\ total\_bytes))\ \{}
\DoxyCodeLine{01415\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01416\ \ \ \}}
\DoxyCodeLine{01417\ }
\DoxyCodeLine{01418\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01419\ \ \ \ \ \textcolor{comment}{//\ Finally,\ we\ can\ decode\ the\ whole\ thing.}}
\DoxyCodeLine{01420\ \ \ \ \ \textcolor{keywordtype}{string}\ connect\_host;}
\DoxyCodeLine{01421\ }
\DoxyCodeLine{01422\ \ \ \ \ \textcolor{keywordflow}{switch}\ (reply[3])\ \{}
\DoxyCodeLine{01423\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x01:\ \ \textcolor{comment}{//\ IPv4}}
\DoxyCodeLine{01424\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01425\ \ \ \ \ \ \ \ \ ostringstream\ strm;}
\DoxyCodeLine{01426\ \ \ \ \ \ \ \ \ strm\ <<\ (\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[4]\ <<\ \textcolor{stringliteral}{"{}."{}}}
\DoxyCodeLine{01427\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ (\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[5]\ <<\ \textcolor{stringliteral}{"{}."{}}}
\DoxyCodeLine{01428\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ (\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[6]\ <<\ \textcolor{stringliteral}{"{}."{}}}
\DoxyCodeLine{01429\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ (\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[7];}
\DoxyCodeLine{01430\ \ \ \ \ \ \ \ \ connect\_host\ =\ strm.str();}
\DoxyCodeLine{01431\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01432\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01433\ }
\DoxyCodeLine{01434\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x03:\ \ \textcolor{comment}{//\ DNS}}
\DoxyCodeLine{01435\ \ \ \ \ \ \ connect\_host\ =\ string(\&reply[5],\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int})reply[4]);}
\DoxyCodeLine{01436\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01437\ }
\DoxyCodeLine{01438\ \ \ \ \ \textcolor{keywordflow}{case}\ 0x04:\ \ \textcolor{comment}{//\ IPv6}}
\DoxyCodeLine{01439\ \ \ \ \ \ \ \{}
\DoxyCodeLine{01440\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ buf[48];}
\DoxyCodeLine{01441\ \ \ \ \ \ \ \ \ sprintf(buf,\ \textcolor{stringliteral}{"{}[\%02hhx\%02hhx:\%02hhx\%02hhx:\%02hhx\%02hhx:\%02hhx\%02hhx"{}}}
\DoxyCodeLine{01442\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}:\%02hhx\%02hhx:\%02hhx\%02hhx:\%02hhx\%02hhx:\%02hhx\%02hhx]"{}},}
\DoxyCodeLine{01443\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ reply[4],\ reply[5],\ reply[6],\ reply[7],\ reply[8],\ reply[9],}
\DoxyCodeLine{01444\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ reply[10],\ reply[11],\ reply[12],\ reply[13],\ reply[14],}
\DoxyCodeLine{01445\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ reply[15],\ reply[16],\ reply[17],\ reply[18],\ reply[19]);}
\DoxyCodeLine{01446\ \ \ \ \ \ \ \ \ total\_bytes\ +=\ 16;}
\DoxyCodeLine{01447\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01448\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01449\ \ \ \ \ \}}
\DoxyCodeLine{01450\ }
\DoxyCodeLine{01451\ \ \ \ \ \textcolor{keywordtype}{int}\ connect\_port\ =}
\DoxyCodeLine{01452\ \ \ \ \ \ \ (((\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[total\_bytes\ -\/\ 2])\ <<\ 8)\ |}
\DoxyCodeLine{01453\ \ \ \ \ \ \ ((\textcolor{keywordtype}{unsigned}\ int)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char})reply[total\_bytes\ -\/\ 1]);}
\DoxyCodeLine{01454\ }
\DoxyCodeLine{01455\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01456\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01457\ \ \ \ \ \ \ <<\ \_proxy\ <<\ \textcolor{stringliteral}{"{}\ directed\ us\ to\ "{}}\ <<\ connect\_host\ <<\ \textcolor{stringliteral}{"{}:"{}}}
\DoxyCodeLine{01458\ \ \ \ \ \ \ <<\ connect\_port\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01459\ \ \ \}}
\DoxyCodeLine{01460\ }
\DoxyCodeLine{01461\ \ \ \textcolor{keywordflow}{if}\ (\_want\_ssl)\ \{}
\DoxyCodeLine{01462\ \ \ \ \ \_state\ =\ S\_setup\_ssl;}
\DoxyCodeLine{01463\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01464\ \ \ \ \ \_state\ =\ S\_ready;}
\DoxyCodeLine{01465\ \ \ \}}
\DoxyCodeLine{01466\ }
\DoxyCodeLine{01467\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01468\ \}}
\DoxyCodeLine{01469\ }
\DoxyCodeLine{01474\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01475\ run\_setup\_ssl()\ \{}
\DoxyCodeLine{01476\ \ \ \_sbio\ =\ BIO\_new\_ssl(\_client-\/>get\_ssl\_ctx(),\ \textcolor{keyword}{true});}
\DoxyCodeLine{01477\ \ \ BIO\_push(\_sbio,\ *\_bio);}
\DoxyCodeLine{01478\ }
\DoxyCodeLine{01479\ \ \ SSL\ *ssl\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01480\ \ \ BIO\_get\_ssl(\_sbio,\ \&ssl);}
\DoxyCodeLine{01481\ \ \ nassertr(ssl\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{01482\ }
\DoxyCodeLine{01483\ \ \ \textcolor{comment}{//\ We\ only\ take\ one\ word\ at\ a\ time\ from\ the\ \_cipher\_list.\ \ If\ that}}
\DoxyCodeLine{01484\ \ \ \textcolor{comment}{//\ connection\ fails,\ then\ we\ take\ the\ next\ word.}}
\DoxyCodeLine{01485\ \ \ \textcolor{keywordtype}{string}\ cipher\_list\ =\ \_cipher\_list;}
\DoxyCodeLine{01486\ \ \ \textcolor{keywordflow}{if}\ (!cipher\_list.empty())\ \{}
\DoxyCodeLine{01487\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ space\ =\ cipher\_list.find(\textcolor{stringliteral}{"{}\ "{}});}
\DoxyCodeLine{01488\ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ !=\ string::npos)\ \{}
\DoxyCodeLine{01489\ \ \ \ \ \ \ cipher\_list\ =\ cipher\_list.substr(0,\ space);}
\DoxyCodeLine{01490\ \ \ \ \ \}}
\DoxyCodeLine{01491\ \ \ \}}
\DoxyCodeLine{01492\ }
\DoxyCodeLine{01493\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01494\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01495\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01496\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Setting\ ssl-\/cipher-\/list\ '"{}}\ <<\ cipher\_list\ <<\ \textcolor{stringliteral}{"{}'\(\backslash\)n"{}};}
\DoxyCodeLine{01497\ \ \ \}}
\DoxyCodeLine{01498\ \ \ \textcolor{keywordtype}{int}\ result\ =\ SSL\_set\_cipher\_list(ssl,\ cipher\_list.c\_str());}
\DoxyCodeLine{01499\ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ 0)\ \{}
\DoxyCodeLine{01500\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{01501\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01502\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ cipher\ list:\ '"{}}\ <<\ cipher\_list\ <<\ \textcolor{stringliteral}{"{}'\(\backslash\)n"{}};}
\DoxyCodeLine{01503\ \ \ \ \ OpenSSLWrapper::get\_global\_ptr()-\/>notify\_ssl\_errors();}
\DoxyCodeLine{01504\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_ssl\_internal\_failure;}
\DoxyCodeLine{01505\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01506\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01507\ \ \ \}}
\DoxyCodeLine{01508\ }
\DoxyCodeLine{01509\ \ \ \textcolor{keywordtype}{string}\ hostname\ =\ \_request.get\_url().get\_server();}
\DoxyCodeLine{01510\ \ \ result\ =\ SSL\_set\_tlsext\_host\_name(ssl,\ hostname.c\_str());}
\DoxyCodeLine{01511\ \ \ \textcolor{keywordflow}{if}\ (result\ ==\ 0)\ \{}
\DoxyCodeLine{01512\ \ \ \ \ downloader\_cat.error()}
\DoxyCodeLine{01513\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01514\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ set\ TLS\ SNI\ hostname\ to\ '"{}}\ <<\ hostname\ <<\ \textcolor{stringliteral}{"{}'\(\backslash\)n"{}};}
\DoxyCodeLine{01515\ \ \ \}}
\DoxyCodeLine{01516\ }
\DoxyCodeLine{01517\ \textcolor{comment}{/*}}
\DoxyCodeLine{01518\ \textcolor{comment}{\ *\ It\ would\ be\ nice\ to\ use\ something\ like\ SSL\_set\_client\_cert\_cb()\ here\ to\ set}}
\DoxyCodeLine{01519\ \textcolor{comment}{\ *\ a\ callback\ to\ provide\ the\ certificate\ should\ it\ be\ requested,\ or\ even\ to}}
\DoxyCodeLine{01520\ \textcolor{comment}{\ *\ potentially\ provide\ any\ of\ a\ number\ of\ certificates\ according\ to\ the}}
\DoxyCodeLine{01521\ \textcolor{comment}{\ *\ server's\ CA\ presented,\ but\ that\ interface\ as\ provided\ by\ OpenSSL\ is\ broken}}
\DoxyCodeLine{01522\ \textcolor{comment}{\ *\ since\ there's\ no\ way\ to\ pass\ additional\ data\ to\ the\ callback\ function\ (and}}
\DoxyCodeLine{01523\ \textcolor{comment}{\ *\ hence\ no\ way\ to\ tie\ it\ back\ to\ the\ HTTPChannel\ object,\ other\ than\ by}}
\DoxyCodeLine{01524\ \textcolor{comment}{\ *\ building\ a\ messy\ mapping\ of\ SSL\ pointers\ back\ to\ HTTPChannel\ pointers).}}
\DoxyCodeLine{01525\ \textcolor{comment}{\ */}}
\DoxyCodeLine{01526\ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>load\_client\_certificate())\ \{}
\DoxyCodeLine{01527\ \ \ \ \ SSL\_use\_certificate(ssl,\ \_client-\/>\_client\_certificate\_pub);}
\DoxyCodeLine{01528\ \ \ \ \ SSL\_use\_PrivateKey(ssl,\ \_client-\/>\_client\_certificate\_priv);}
\DoxyCodeLine{01529\ \ \ \ \ \textcolor{keywordflow}{if}\ (!SSL\_check\_private\_key(ssl))\ \{}
\DoxyCodeLine{01530\ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01531\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01532\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Client\ private\ key\ does\ not\ match\ public\ key!\(\backslash\)n"{}};}
\DoxyCodeLine{01533\ \ \ \ \ \}}
\DoxyCodeLine{01534\ \ \ \}}
\DoxyCodeLine{01535\ }
\DoxyCodeLine{01536\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01537\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01538\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01539\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}SSL\ Ciphers\ available:\(\backslash\)n"{}};}
\DoxyCodeLine{01540\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *name;}
\DoxyCodeLine{01541\ \ \ \ \ \textcolor{keywordtype}{int}\ pri\ =\ 0;}
\DoxyCodeLine{01542\ \ \ \ \ name\ =\ SSL\_get\_cipher\_list(ssl,\ pri);}
\DoxyCodeLine{01543\ \ \ \ \ \textcolor{keywordflow}{while}\ (name\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01544\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01545\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01546\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ "{}}\ <<\ pri\ +\ 1\ <<\ \textcolor{stringliteral}{"{}.\ "{}}\ <<\ name\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01547\ \ \ \ \ \ \ pri++;}
\DoxyCodeLine{01548\ \ \ \ \ \ \ name\ =\ SSL\_get\_cipher\_list(ssl,\ pri);}
\DoxyCodeLine{01549\ \ \ \ \ \}}
\DoxyCodeLine{01550\ \ \ \}}
\DoxyCodeLine{01551\ }
\DoxyCodeLine{01552\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01553\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01554\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01555\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}performing\ SSL\ handshake\(\backslash\)n"{}};}
\DoxyCodeLine{01556\ \ \ \}}
\DoxyCodeLine{01557\ \ \ \_state\ =\ S\_ssl\_handshake;}
\DoxyCodeLine{01558\ }
\DoxyCodeLine{01559\ \ \ \textcolor{comment}{//\ We\ start\ the\ connect\ timer\ over\ again\ when\ we\ reach\ the\ SSL\ handshake.}}
\DoxyCodeLine{01560\ \ \ \_started\_connecting\_time\ =}
\DoxyCodeLine{01561\ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{01562\ }
\DoxyCodeLine{01563\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01564\ \}}
\DoxyCodeLine{01565\ }
\DoxyCodeLine{01570\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01571\ run\_ssl\_handshake()\ \{}
\DoxyCodeLine{01572\ \ \ \textcolor{keywordflow}{if}\ (BIO\_do\_handshake(\_sbio)\ <=\ 0)\ \{}
\DoxyCodeLine{01573\ \ \ \ \ \textcolor{keywordflow}{if}\ (BIO\_should\_retry(\_sbio))\ \{}
\DoxyCodeLine{01574\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ elapsed\ =}
\DoxyCodeLine{01575\ \ \ \ \ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/}
\DoxyCodeLine{01576\ \ \ \ \ \ \ \ \ \_started\_connecting\_time;}
\DoxyCodeLine{01577\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (elapsed\ <=\ get\_connect\_timeout()\ +\ \_extra\_ssl\_handshake\_time)\ \{}
\DoxyCodeLine{01578\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Keep\ trying.}}
\DoxyCodeLine{01579\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01580\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01581\ \ \ \ \ \ \ \textcolor{comment}{//\ Time\ to\ give\ up\ on\ the\ handshake.}}
\DoxyCodeLine{01582\ \ \ \ \ \}}
\DoxyCodeLine{01583\ }
\DoxyCodeLine{01584\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01585\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01586\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ establish\ SSL\ handshake\ with\ "{}}}
\DoxyCodeLine{01587\ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01588\ \ \ \ \ OpenSSLWrapper::get\_global\_ptr()-\/>notify\_ssl\_errors();}
\DoxyCodeLine{01589\ }
\DoxyCodeLine{01590\ \ \ \ \ \textcolor{comment}{//\ It\ seems\ to\ be\ an\ error\ to\ free\ sbio\ at\ this\ point;\ perhaps\ it's}}
\DoxyCodeLine{01591\ \ \ \ \ \textcolor{comment}{//\ already\ been\ freed?}}
\DoxyCodeLine{01592\ }
\DoxyCodeLine{01593\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_cipher\_list.empty())\ \{}
\DoxyCodeLine{01594\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ we've\ got\ another\ cipher\ to\ try,\ do\ so.}}
\DoxyCodeLine{01595\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ space\ =\ \_cipher\_list.find(\textcolor{stringliteral}{"{}\ "{}});}
\DoxyCodeLine{01596\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (space\ !=\ string::npos)\ \{}
\DoxyCodeLine{01597\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (space\ <\ \_cipher\_list.length()\ \&\&\ \_cipher\_list[space]\ ==\ \textcolor{charliteral}{'\ '})\ \{}
\DoxyCodeLine{01598\ \ \ \ \ \ \ \ \ \ \ ++space;}
\DoxyCodeLine{01599\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01600\ \ \ \ \ \ \ \ \ \_cipher\_list\ =\ \_cipher\_list.substr(space);}
\DoxyCodeLine{01601\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_cipher\_list.empty())\ \{}
\DoxyCodeLine{01602\ \ \ \ \ \ \ \ \ \ \ close\_connection();}
\DoxyCodeLine{01603\ \ \ \ \ \ \ \ \ \ \ reconsider\_proxy();}
\DoxyCodeLine{01604\ \ \ \ \ \ \ \ \ \ \ \_state\ =\ S\_connecting;}
\DoxyCodeLine{01605\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01606\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01607\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01608\ \ \ \ \ \}}
\DoxyCodeLine{01609\ }
\DoxyCodeLine{01610\ \ \ \ \ \textcolor{comment}{//\ All\ done\ trying\ ciphers;\ they\ all\ failed.}}
\DoxyCodeLine{01611\ \ \ \ \ \_cipher\_list\ =\ \_client-\/>get\_cipher\_list();}
\DoxyCodeLine{01612\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_ssl\_no\_handshake;}
\DoxyCodeLine{01613\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01614\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01615\ \ \ \}}
\DoxyCodeLine{01616\ }
\DoxyCodeLine{01617\ \ \ SSL\ *ssl\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01618\ \ \ BIO\_get\_ssl(\_sbio,\ \&ssl);}
\DoxyCodeLine{01619\ \ \ nassertr(ssl\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{01620\ }
\DoxyCodeLine{01621\ \ \ \textcolor{keywordflow}{if}\ (!\_nonblocking)\ \{}
\DoxyCodeLine{01622\ \ \ \ \ SSL\_set\_mode(ssl,\ SSL\_MODE\_AUTO\_RETRY);}
\DoxyCodeLine{01623\ \ \ \}}
\DoxyCodeLine{01624\ }
\DoxyCodeLine{01625\ \ \ \textcolor{keyword}{const}\ SSL\_CIPHER\ *cipher\ =\ SSL\_get\_current\_cipher(ssl);}
\DoxyCodeLine{01626\ \ \ \textcolor{keywordflow}{if}\ (cipher\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01627\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01628\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01629\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}No\ current\ cipher\ on\ SSL\ connection.\(\backslash\)n"{}};}
\DoxyCodeLine{01630\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01631\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01632\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01633\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01634\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Using\ cipher\ "{}}\ <<\ SSL\_CIPHER\_get\_name((SSL\_CIPHER\ *)\ cipher)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01635\ \ \ \ \ \}}
\DoxyCodeLine{01636\ \ \ \}}
\DoxyCodeLine{01637\ }
\DoxyCodeLine{01638\ \ \ \textcolor{comment}{//\ Now\ that\ we've\ made\ an\ SSL\ handshake,\ we\ can\ use\ the\ SSL\ bio\ to\ do\ all\ of}}
\DoxyCodeLine{01639\ \ \ \textcolor{comment}{//\ our\ communication\ henceforth.}}
\DoxyCodeLine{01640\ \ \ \_bio-\/>set\_bio(\_sbio);}
\DoxyCodeLine{01641\ \ \ \_sbio\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01642\ }
\DoxyCodeLine{01643\ \ \ X509\ *cert\ =\ SSL\_get\_peer\_certificate(ssl);}
\DoxyCodeLine{01644\ \ \ \textcolor{keywordflow}{if}\ (cert\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01645\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01646\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01647\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}No\ certificate\ was\ presented\ by\ server.\(\backslash\)n"{}};}
\DoxyCodeLine{01648\ }
\DoxyCodeLine{01649\ \ \ \ \ \textcolor{comment}{//\ This\ shouldn't\ be\ possible,\ per\ the\ SSL\ specs.}}
\DoxyCodeLine{01650\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_ssl\_invalid\_server\_certificate;}
\DoxyCodeLine{01651\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01652\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01653\ \ \ \}}
\DoxyCodeLine{01654\ }
\DoxyCodeLine{01655\ \ \ X509\_NAME\ *subject\ =\ X509\_get\_subject\_name(cert);}
\DoxyCodeLine{01656\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01657\ \ \ \ \ \textcolor{keywordtype}{string}\ org\_name\ =\ get\_x509\_name\_component(subject,\ NID\_organizationName);}
\DoxyCodeLine{01658\ \ \ \ \ \textcolor{keywordtype}{string}\ org\_unit\_name\ =\ get\_x509\_name\_component(subject,\ NID\_organizationalUnitName);}
\DoxyCodeLine{01659\ \ \ \ \ \textcolor{keywordtype}{string}\ common\_name\ =\ get\_x509\_name\_component(subject,\ NID\_commonName);}
\DoxyCodeLine{01660\ }
\DoxyCodeLine{01661\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01662\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01663\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Server\ is\ "{}}\ <<\ common\_name\ <<\ \textcolor{stringliteral}{"{}\ from\ "{}}\ <<\ org\_unit\_name}
\DoxyCodeLine{01664\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ /\ "{}}\ <<\ org\_name\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01665\ }
\DoxyCodeLine{01666\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{01667\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{01668\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01669\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Received\ certificate\ from\ server:\(\backslash\)n"{}}\ <<\ std::flush;}
\DoxyCodeLine{01670\ \ \ \ \ \ \ X509\_print\_fp(stderr,\ cert);}
\DoxyCodeLine{01671\ \ \ \ \ \ \ fflush(stderr);}
\DoxyCodeLine{01672\ \ \ \ \ \}}
\DoxyCodeLine{01673\ \ \ \}}
\DoxyCodeLine{01674\ }
\DoxyCodeLine{01675\ \ \ \textcolor{keywordtype}{bool}\ cert\_preapproved\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01676\ \ \ \textcolor{keywordtype}{bool}\ cert\_name\_preapproved\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01677\ \ \ check\_preapproved\_server\_certificate(cert,\ cert\_preapproved,\ cert\_name\_preapproved);}
\DoxyCodeLine{01678\ }
\DoxyCodeLine{01679\ \ \ \textcolor{comment}{//\ Now\ verify\ the\ server\ certificate\ is\ valid.}}
\DoxyCodeLine{01680\ \ \ \textcolor{keywordtype}{long}\ verify\_result\ =\ SSL\_get\_verify\_result(ssl);}
\DoxyCodeLine{01681\ \ \ \textcolor{keywordtype}{bool}\ cert\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01682\ }
\DoxyCodeLine{01683\ \ \ \textcolor{keywordflow}{if}\ (verify\_result\ ==\ X509\_V\_ERR\_CERT\_HAS\_EXPIRED)\ \{}
\DoxyCodeLine{01684\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01685\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01686\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Expired\ certificate\ from\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01687\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_verify\_ssl()\ ==\ HTTPClient::VS\_normal\ \&\&\ !cert\_preapproved)\ \{}
\DoxyCodeLine{01688\ \ \ \ \ \ \ cert\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01689\ \ \ \ \ \}}
\DoxyCodeLine{01690\ }
\DoxyCodeLine{01691\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (verify\_result\ ==\ X509\_V\_ERR\_CERT\_NOT\_YET\_VALID)\ \{}
\DoxyCodeLine{01692\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01693\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01694\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Premature\ certificate\ from\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01695\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_verify\_ssl()\ ==\ HTTPClient::VS\_normal\ \&\&\ !cert\_preapproved)\ \{}
\DoxyCodeLine{01696\ \ \ \ \ \ \ cert\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01697\ \ \ \ \ \}}
\DoxyCodeLine{01698\ }
\DoxyCodeLine{01699\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (verify\_result\ ==\ X509\_V\_ERR\_DEPTH\_ZERO\_SELF\_SIGNED\_CERT\ ||}
\DoxyCodeLine{01700\ \ \ \ \ \ \ \ \ \ \ \ \ \ verify\_result\ ==\ X509\_V\_ERR\_SELF\_SIGNED\_CERT\_IN\_CHAIN)\ \{}
\DoxyCodeLine{01701\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01702\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01703\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Self-\/signed\ certificate\ from\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01704\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_verify\_ssl()\ !=\ HTTPClient::VS\_no\_verify\ \&\&\ !cert\_preapproved)\ \{}
\DoxyCodeLine{01705\ \ \ \ \ \ \ cert\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01706\ \ \ \ \ \}}
\DoxyCodeLine{01707\ }
\DoxyCodeLine{01708\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (verify\_result\ !=\ X509\_V\_OK)\ \{}
\DoxyCodeLine{01709\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01710\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01711\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ verify\ identity\ of\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{01712\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ verify\ error\ code\ "{}}\ <<\ verify\_result\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01713\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_verify\_ssl()\ !=\ HTTPClient::VS\_no\_verify\ \&\&\ !cert\_preapproved)\ \{}
\DoxyCodeLine{01714\ \ \ \ \ \ \ cert\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01715\ \ \ \ \ \}}
\DoxyCodeLine{01716\ \ \ \}}
\DoxyCodeLine{01717\ }
\DoxyCodeLine{01718\ \ \ \textcolor{keywordflow}{if}\ (!cert\_valid)\ \{}
\DoxyCodeLine{01719\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_ssl\_invalid\_server\_certificate;}
\DoxyCodeLine{01720\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01721\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01722\ \ \ \}}
\DoxyCodeLine{01723\ }
\DoxyCodeLine{01724\ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_verify\_ssl()\ !=\ HTTPClient::VS\_no\_verify\ \&\&\ !cert\_name\_preapproved)\ \{}
\DoxyCodeLine{01725\ \ \ \ \ \textcolor{comment}{//\ Check\ that\ the\ server\ is\ someone\ we\ expected\ to\ be\ talking\ to.}}
\DoxyCodeLine{01726\ \ \ \ \ \textcolor{keywordflow}{if}\ (!validate\_server\_name(cert))\ \{}
\DoxyCodeLine{01727\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_ssl\_unexpected\_server;}
\DoxyCodeLine{01728\ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01729\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01730\ \ \ \ \ \}}
\DoxyCodeLine{01731\ \ \ \}}
\DoxyCodeLine{01732\ }
\DoxyCodeLine{01733\ \ \ X509\_free(cert);}
\DoxyCodeLine{01734\ }
\DoxyCodeLine{01735\ \ \ \_state\ =\ S\_ready;}
\DoxyCodeLine{01736\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01737\ \}}
\DoxyCodeLine{01738\ }
\DoxyCodeLine{01747\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01748\ run\_ready()\ \{}
\DoxyCodeLine{01749\ \ \ \textcolor{comment}{//\ If\ there's\ a\ request\ to\ be\ sent\ upstream,\ send\ it\ now.}}
\DoxyCodeLine{01750\ \ \ \textcolor{keywordflow}{if}\ (!\_request\_text.empty())\ \{}
\DoxyCodeLine{01751\ \ \ \ \textcolor{keywordflow}{if}\ (!server\_send(\_request\_text,\ \textcolor{keyword}{false}))\ \{}
\DoxyCodeLine{01752\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01753\ \ \ \ \ \}}
\DoxyCodeLine{01754\ \ \ \}}
\DoxyCodeLine{01755\ }
\DoxyCodeLine{01756\ \ \ \textcolor{comment}{//\ All\ done\ sending\ request.}}
\DoxyCodeLine{01757\ \ \ \_state\ =\ S\_request\_sent;}
\DoxyCodeLine{01758\ \ \ \_sent\_request\_time\ =\ TrueClock::get\_global\_ptr()-\/>get\_short\_time();}
\DoxyCodeLine{01759\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01760\ \}}
\DoxyCodeLine{01761\ }
\DoxyCodeLine{01766\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01767\ run\_request\_sent()\ \{}
\DoxyCodeLine{01768\ \ \ \textcolor{comment}{//\ Wait\ for\ the\ first\ line\ to\ come\ back\ from\ the\ server.}}
\DoxyCodeLine{01769\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{01770\ \ \ \textcolor{keywordflow}{if}\ (!server\_getline\_failsafe(line))\ \{}
\DoxyCodeLine{01771\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01772\ \ \ \}}
\DoxyCodeLine{01773\ }
\DoxyCodeLine{01774\ \ \ \textcolor{comment}{//\ Skip\ unexpected\ blank\ lines.\ \ We're\ just\ being\ generous\ here.}}
\DoxyCodeLine{01775\ \ \ \textcolor{keywordflow}{while}\ (line.empty())\ \{}
\DoxyCodeLine{01776\ \ \ \ \ \textcolor{keywordflow}{if}\ (!server\_getline\_failsafe(line))\ \{}
\DoxyCodeLine{01777\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01778\ \ \ \ \ \}}
\DoxyCodeLine{01779\ \ \ \}}
\DoxyCodeLine{01780\ }
\DoxyCodeLine{01781\ \ \ \textcolor{keywordflow}{if}\ (!parse\_http\_response(line))\ \{}
\DoxyCodeLine{01782\ \ \ \ \ \textcolor{comment}{//\ Not\ an\ HTTP\ response.\ \ \_state\ is\ already\ set\ appropriately.}}
\DoxyCodeLine{01783\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01784\ \ \ \}}
\DoxyCodeLine{01785\ }
\DoxyCodeLine{01786\ \ \ \_state\ =\ S\_reading\_header;}
\DoxyCodeLine{01787\ \ \ \_current\_field\_name\ =\ string();}
\DoxyCodeLine{01788\ \ \ \_current\_field\_value\ =\ string();}
\DoxyCodeLine{01789\ \ \ \_headers.clear();}
\DoxyCodeLine{01790\ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01791\ \ \ \_got\_transfer\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01792\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01793\ \}}
\DoxyCodeLine{01794\ }
\DoxyCodeLine{01800\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{01801\ run\_reading\_header()\ \{}
\DoxyCodeLine{01802\ \ \ \textcolor{keywordflow}{if}\ (parse\_http\_header())\ \{}
\DoxyCodeLine{01803\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio.is\_null())\ \{}
\DoxyCodeLine{01804\ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01805\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01806\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Connection\ lost\ while\ reading\ HTTP\ response.\(\backslash\)n"{}};}
\DoxyCodeLine{01807\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_response\_type\ ==\ RT\_http\_hangup)\ \{}
\DoxyCodeLine{01808\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ second\ hangup\ in\ a\ row.\ \ Give\ up.}}
\DoxyCodeLine{01809\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_lost\_connection;}
\DoxyCodeLine{01810\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01811\ }
\DoxyCodeLine{01812\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01813\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Try\ again,\ once.}}
\DoxyCodeLine{01814\ \ \ \ \ \ \ \ \ \_response\_type\ =\ RT\_http\_hangup;}
\DoxyCodeLine{01815\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01816\ }
\DoxyCodeLine{01817\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01818\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ elapsed\ =}
\DoxyCodeLine{01819\ \ \ \ \ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/}
\DoxyCodeLine{01820\ \ \ \ \ \ \ \ \ \_sent\_request\_time;}
\DoxyCodeLine{01821\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (elapsed\ >\ get\_http\_timeout())\ \{}
\DoxyCodeLine{01822\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Time\ to\ give\ up.}}
\DoxyCodeLine{01823\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{01824\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01825\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Timeout\ waiting\ for\ "{}}}
\DoxyCodeLine{01826\ \ \ \ \ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{01827\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ in\ run\_reading\_header\ ("{}}\ <<\ elapsed}
\DoxyCodeLine{01828\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ seconds\ elapsed).\(\backslash\)n"{}};}
\DoxyCodeLine{01829\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_timeout;}
\DoxyCodeLine{01830\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{01831\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01832\ \ \ \ \ \}}
\DoxyCodeLine{01833\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01834\ \ \ \}}
\DoxyCodeLine{01835\ \ \ \_response\_type\ =\ RT\_http\_complete;}
\DoxyCodeLine{01836\ }
\DoxyCodeLine{01837\ \ \ \textcolor{comment}{//\ Ok,\ we've\ established\ an\ HTTP\ connection\ to\ the\ server.\ \ Our\ extra\ send}}
\DoxyCodeLine{01838\ \ \ \textcolor{comment}{//\ headers\ have\ done\ their\ job;\ clear\ them\ for\ next\ time.}}
\DoxyCodeLine{01839\ \ \ clear\_extra\_headers();}
\DoxyCodeLine{01840\ }
\DoxyCodeLine{01841\ \ \ \_server\_response\_has\_no\_body\ =}
\DoxyCodeLine{01842\ \ \ \ \ (get\_status\_code()\ /\ 100\ ==\ 1\ ||}
\DoxyCodeLine{01843\ \ \ \ \ \ get\_status\_code()\ ==\ 204\ ||}
\DoxyCodeLine{01844\ \ \ \ \ \ get\_status\_code()\ ==\ 304\ ||}
\DoxyCodeLine{01845\ \ \ \ \ \ \_method\ ==\ HTTPEnum::M\_head);}
\DoxyCodeLine{01846\ }
\DoxyCodeLine{01847\ \ \ \textcolor{comment}{//\ Look\ for\ key\ properties\ in\ the\ header\ fields.}}
\DoxyCodeLine{01848\ \ \ \textcolor{keywordflow}{if}\ (get\_status\_code()\ ==\ 206)\ \{}
\DoxyCodeLine{01849\ \ \ \ \ \textcolor{keywordtype}{string}\ content\_range\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Content-\/Range"{}});}
\DoxyCodeLine{01850\ \ \ \ \ \textcolor{keywordflow}{if}\ (content\_range.empty())\ \{}
\DoxyCodeLine{01851\ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01852\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01853\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Got\ 206\ response\ without\ Content-\/Range\ header!\(\backslash\)n"{}};}
\DoxyCodeLine{01854\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_invalid\_http;}
\DoxyCodeLine{01855\ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01856\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01857\ }
\DoxyCodeLine{01858\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01859\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!parse\_content\_range(content\_range))\ \{}
\DoxyCodeLine{01860\ \ \ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{01861\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01862\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Couldn't\ parse\ Content-\/Range:\ "{}}\ <<\ content\_range\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01863\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_invalid\_http;}
\DoxyCodeLine{01864\ \ \ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{01865\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01866\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01867\ \ \ \ \ \}}
\DoxyCodeLine{01868\ }
\DoxyCodeLine{01869\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01870\ \ \ \ \ \_first\_byte\_delivered\ =\ 0;}
\DoxyCodeLine{01871\ \ \ \ \ \_last\_byte\_delivered\ =\ 0;}
\DoxyCodeLine{01872\ \ \ \}}
\DoxyCodeLine{01873\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{01874\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_requested\ !=\ 0\ ||\ \_last\_byte\_requested\ !=\ 0\ ||}
\DoxyCodeLine{01875\ \ \ \ \ \ \ \ \ \_first\_byte\_delivered\ !=\ 0\ ||\ \_last\_byte\_delivered\ !=\ 0)\ \{}
\DoxyCodeLine{01876\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{01877\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{01878\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Requested\ byte\ range\ "{}}\ <<\ \_first\_byte\_requested}
\DoxyCodeLine{01879\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ to\ "{}}\ <<\ \_last\_byte\_delivered}
\DoxyCodeLine{01880\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{};\ server\ delivers\ range\ "{}}\ <<\ \_first\_byte\_delivered}
\DoxyCodeLine{01881\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ to\ "{}}\ <<\ \_last\_byte\_delivered}
\DoxyCodeLine{01882\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{01883\ \ \ \ \ \}}
\DoxyCodeLine{01884\ \ \ \}}
\DoxyCodeLine{01885\ }
\DoxyCodeLine{01886\ \ \ \textcolor{comment}{//\ Set\ the\ \_document\_spec\ to\ reflect\ what\ we\ just\ retrieved.}}
\DoxyCodeLine{01887\ \ \ \_document\_spec\ =\ \mbox{\hyperlink{classDocumentSpec}{DocumentSpec}}(\_request.get\_url());}
\DoxyCodeLine{01888\ \ \ \textcolor{keywordtype}{string}\ tag\ =\ get\_header\_value(\textcolor{stringliteral}{"{}ETag"{}});}
\DoxyCodeLine{01889\ \ \ \textcolor{keywordflow}{if}\ (!tag.empty())\ \{}
\DoxyCodeLine{01890\ \ \ \ \ \_document\_spec.set\_tag(\mbox{\hyperlink{classHTTPEntityTag}{HTTPEntityTag}}(tag));}
\DoxyCodeLine{01891\ \ \ \}}
\DoxyCodeLine{01892\ \ \ \textcolor{keywordtype}{string}\ date\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Last-\/Modified"{}});}
\DoxyCodeLine{01893\ \ \ \textcolor{keywordflow}{if}\ (!date.empty())\ \{}
\DoxyCodeLine{01894\ \ \ \ \ \_document\_spec.set\_date(\mbox{\hyperlink{classHTTPDate}{HTTPDate}}(date));}
\DoxyCodeLine{01895\ \ \ \}}
\DoxyCodeLine{01896\ }
\DoxyCodeLine{01897\ \ \ \textcolor{comment}{//\ In\ case\ we've\ got\ a\ download\ in\ effect,\ now\ we\ know\ what\ the\ first\ byte}}
\DoxyCodeLine{01898\ \ \ \textcolor{comment}{//\ of\ the\ subdocument\ request\ will\ be,\ so\ we\ can\ open\ the\ file\ and\ position}}
\DoxyCodeLine{01899\ \ \ \textcolor{comment}{//\ it.}}
\DoxyCodeLine{01900\ \ \ \textcolor{keywordflow}{if}\ (\_server\_response\_has\_no\_body)\ \{}
\DoxyCodeLine{01901\ \ \ \ \ \textcolor{comment}{//\ Never\ mind\ on\ the\ download.}}
\DoxyCodeLine{01902\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{01903\ \ \ \}}
\DoxyCodeLine{01904\ }
\DoxyCodeLine{01905\ \ \ \textcolor{keywordflow}{if}\ (!open\_download\_file())\ \{}
\DoxyCodeLine{01906\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01907\ \ \ \}}
\DoxyCodeLine{01908\ }
\DoxyCodeLine{01909\ \ \ \_got\_expected\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01910\ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01911\ \ \ \_got\_transfer\_file\_size\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{01912\ }
\DoxyCodeLine{01913\ \ \ \textcolor{keywordtype}{string}\ content\_length\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Content-\/Length"{}});}
\DoxyCodeLine{01914\ \ \ \textcolor{keywordflow}{if}\ (!content\_length.empty())\ \{}
\DoxyCodeLine{01915\ \ \ \ \ \_file\_size\ =\ atoi(content\_length.c\_str());}
\DoxyCodeLine{01916\ \ \ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01917\ }
\DoxyCodeLine{01918\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (get\_status\_code()\ ==\ 206)\ \{}
\DoxyCodeLine{01919\ \ \ \ \ \textcolor{comment}{//\ Well,\ we\ didn't\ get\ a\ content-\/length\ from\ the\ server,\ but\ we\ can\ infer}}
\DoxyCodeLine{01920\ \ \ \ \ \textcolor{comment}{//\ the\ number\ of\ bytes\ based\ on\ the\ range\ we're\ given.}}
\DoxyCodeLine{01921\ \ \ \ \ \_file\_size\ =\ \_last\_byte\_delivered\ -\/\ \_first\_byte\_delivered\ +\ 1;}
\DoxyCodeLine{01922\ \ \ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01923\ \ \ \}}
\DoxyCodeLine{01924\ \ \ \_redirect\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Location"{}});}
\DoxyCodeLine{01925\ }
\DoxyCodeLine{01926\ \ \ \textcolor{comment}{//\ The\ server\ might\ have\ given\ us\ just\ a\ filename\ for\ the\ redirect.\ \ In\ that}}
\DoxyCodeLine{01927\ \ \ \textcolor{comment}{//\ case,\ it's\ relative\ to\ the\ same\ server.\ \ If\ it's\ a\ relative\ path,\ it's}}
\DoxyCodeLine{01928\ \ \ \textcolor{comment}{//\ relative\ to\ the\ same\ directory.}}
\DoxyCodeLine{01929\ \ \ \textcolor{keywordflow}{if}\ (\_redirect.has\_path()\ \&\&\ !\_redirect.has\_authority())\ \{}
\DoxyCodeLine{01930\ \ \ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ url\ =\ \_document\_spec.get\_url();}
\DoxyCodeLine{01931\ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ path\ =\ \_redirect.get\_path();}
\DoxyCodeLine{01932\ \ \ \ \ \textcolor{keywordflow}{if}\ (path.is\_local())\ \{}
\DoxyCodeLine{01933\ \ \ \ \ \ \ \mbox{\hyperlink{classFilename}{Filename}}\ rel\_to\ =\ \mbox{\hyperlink{classFilename}{Filename}}(url.get\_path()).get\_dirname();}
\DoxyCodeLine{01934\ \ \ \ \ \ \ \_redirect.set\_path(\mbox{\hyperlink{classFilename}{Filename}}(rel\_to,\ path));}
\DoxyCodeLine{01935\ \ \ \ \ \}}
\DoxyCodeLine{01936\ \ \ \ \ \_redirect.set\_scheme(url.get\_scheme());}
\DoxyCodeLine{01937\ \ \ \ \ \_redirect.set\_authority(url.get\_authority());}
\DoxyCodeLine{01938\ \ \ \}}
\DoxyCodeLine{01939\ }
\DoxyCodeLine{01940\ \ \ \_state\ =\ S\_read\_header;}
\DoxyCodeLine{01941\ }
\DoxyCodeLine{01942\ \ \ \textcolor{keywordflow}{if}\ (\_server\_response\_has\_no\_body\ \&\&\ will\_close\_connection())\ \{}
\DoxyCodeLine{01943\ \ \ \ \ \textcolor{comment}{//\ If\ the\ server\ said\ it\ will\ close\ the\ connection,\ we\ should\ close\ it}}
\DoxyCodeLine{01944\ \ \ \ \ \textcolor{comment}{//\ too.}}
\DoxyCodeLine{01945\ \ \ \ \ close\_connection();}
\DoxyCodeLine{01946\ \ \ \}}
\DoxyCodeLine{01947\ }
\DoxyCodeLine{01948\ \ \ \textcolor{comment}{//\ Handle\ automatic\ retries\ and\ redirects.}}
\DoxyCodeLine{01949\ \ \ \textcolor{keywordtype}{int}\ last\_status\ =\ \_last\_status\_code;}
\DoxyCodeLine{01950\ \ \ \_last\_status\_code\ =\ get\_status\_code();}
\DoxyCodeLine{01951\ }
\DoxyCodeLine{01952\ \ \ \textcolor{keywordflow}{if}\ (get\_status\_code()\ ==\ 407\ \&\&\ last\_status\ !=\ 407\ \&\&\ !\_proxy.empty())\ \{}
\DoxyCodeLine{01953\ \ \ \ \ \textcolor{comment}{//\ 407:\ not\ authorized\ to\ proxy.\ \ Try\ to\ get\ the\ authorization.}}
\DoxyCodeLine{01954\ \ \ \ \ \textcolor{keywordtype}{string}\ authenticate\_request\ =\ get\_header\_value(\textcolor{stringliteral}{"{}Proxy-\/Authenticate"{}});}
\DoxyCodeLine{01955\ \ \ \ \ \_proxy\_auth\ =}
\DoxyCodeLine{01956\ \ \ \ \ \ \ \_client-\/>generate\_auth(\_proxy,\ \textcolor{keyword}{true},\ authenticate\_request);}
\DoxyCodeLine{01957\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_auth\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01958\ \ \ \ \ \ \ \_proxy\_realm\ =\ \_proxy\_auth-\/>get\_realm();}
\DoxyCodeLine{01959\ \ \ \ \ \ \ \_proxy\_username\ =\ \_client-\/>select\_username(\_proxy,\ \textcolor{keyword}{true},\ \_proxy\_realm);}
\DoxyCodeLine{01960\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_proxy\_username.empty())\ \{}
\DoxyCodeLine{01961\ \ \ \ \ \ \ \ \ make\_request\_text();}
\DoxyCodeLine{01962\ }
\DoxyCodeLine{01963\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Roll\ the\ state\ forward\ to\ force\ a\ new\ request.}}
\DoxyCodeLine{01964\ \ \ \ \ \ \ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{01965\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01966\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01967\ \ \ \ \ \}}
\DoxyCodeLine{01968\ \ \ \}}
\DoxyCodeLine{01969\ }
\DoxyCodeLine{01970\ \ \ \textcolor{keywordflow}{if}\ (get\_status\_code()\ ==\ 401\ \&\&\ last\_status\ !=\ 401)\ \{}
\DoxyCodeLine{01971\ \ \ \ \ \textcolor{comment}{//\ 401:\ not\ authorized\ to\ remote\ server.\ \ Try\ to\ get\ the\ authorization.}}
\DoxyCodeLine{01972\ \ \ \ \ \textcolor{keywordtype}{string}\ authenticate\_request\ =\ get\_header\_value(\textcolor{stringliteral}{"{}WWW-\/Authenticate"{}});}
\DoxyCodeLine{01973\ \ \ \ \ \_www\_auth\ =\ \_client-\/>generate\_auth(\_request.get\_url(),\ \textcolor{keyword}{false},\ authenticate\_request);}
\DoxyCodeLine{01974\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_www\_auth\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01975\ \ \ \ \ \ \ \_www\_realm\ =\ \_www\_auth-\/>get\_realm();}
\DoxyCodeLine{01976\ \ \ \ \ \ \ \_www\_username\ =\ \_client-\/>select\_username(\_request.get\_url(),\ \textcolor{keyword}{false},\ \_www\_realm);}
\DoxyCodeLine{01977\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_www\_username.empty())\ \{}
\DoxyCodeLine{01978\ \ \ \ \ \ \ \ \ make\_request\_text();}
\DoxyCodeLine{01979\ }
\DoxyCodeLine{01980\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Roll\ the\ state\ forward\ to\ force\ a\ new\ request.}}
\DoxyCodeLine{01981\ \ \ \ \ \ \ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{01982\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01983\ \ \ \ \ \ \ \}}
\DoxyCodeLine{01984\ \ \ \ \ \}}
\DoxyCodeLine{01985\ \ \ \}}
\DoxyCodeLine{01986\ }
\DoxyCodeLine{01987\ \ \ \textcolor{keywordflow}{if}\ ((get\_status\_code()\ ==\ 300\ ||}
\DoxyCodeLine{01988\ \ \ \ \ \ \ \ get\_status\_code()\ ==\ 301\ ||}
\DoxyCodeLine{01989\ \ \ \ \ \ \ \ get\_status\_code()\ ==\ 302\ ||}
\DoxyCodeLine{01990\ \ \ \ \ \ \ \ get\_status\_code()\ ==\ 303\ ||}
\DoxyCodeLine{01991\ \ \ \ \ \ \ \ get\_status\_code()\ ==\ 307)\ \&\&\ !get\_redirect().empty())\ \{}
\DoxyCodeLine{01992\ \ \ \ \ \textcolor{comment}{//\ Redirect.\ \ Should\ we\ handle\ it\ automatically?}}
\DoxyCodeLine{01993\ }
\DoxyCodeLine{01994\ \ \ \ \ \textcolor{comment}{//\ According\ to\ the\ letter\ of\ RFC\ 2616,\ 301\ and\ 302\ responses\ to\ POST}}
\DoxyCodeLine{01995\ \ \ \ \ \textcolor{comment}{//\ requests\ must\ not\ be\ automatically\ redirected\ without\ confirmation\ by}}
\DoxyCodeLine{01996\ \ \ \ \ \textcolor{comment}{//\ the\ user.\ \ In\ reality,\ browsers\ do\ allow\ automatic\ redirection\ of\ these}}
\DoxyCodeLine{01997\ \ \ \ \ \textcolor{comment}{//\ responses,\ changing\ the\ POST\ to\ a\ GET,\ and\ we\ reproduce\ this\ behavior}}
\DoxyCodeLine{01998\ \ \ \ \ \textcolor{comment}{//\ here.}}
\DoxyCodeLine{01999\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_method\ ==\ HTTPEnum::M\_post)\ \{}
\DoxyCodeLine{02000\ \ \ \ \ \ \ \_method\ =\ HTTPEnum::M\_get;}
\DoxyCodeLine{02001\ \ \ \ \ \ \ \_body\ =\ string();}
\DoxyCodeLine{02002\ \ \ \ \ \}}
\DoxyCodeLine{02003\ }
\DoxyCodeLine{02004\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_method\ ==\ HTTPEnum::M\_get\ ||\ \_method\ ==\ HTTPEnum::M\_head)\ \{}
\DoxyCodeLine{02005\ \ \ \ \ \ \ \textcolor{comment}{//\ Sure!}}
\DoxyCodeLine{02006\ \ \ \ \ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ new\_url\ =\ get\_redirect();}
\DoxyCodeLine{02007\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (find(\_redirect\_trail.begin(),\ \_redirect\_trail.end(),}
\DoxyCodeLine{02008\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_url)\ !=\ \_redirect\_trail.end())\ \{}
\DoxyCodeLine{02009\ \ \ \ \ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{02010\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02011\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}cycle\ detected\ in\ redirect\ to\ "{}}\ <<\ new\_url\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02012\ }
\DoxyCodeLine{02013\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02014\ \ \ \ \ \ \ \ \ \_redirect\_trail.push\_back(new\_url);}
\DoxyCodeLine{02015\ }
\DoxyCodeLine{02016\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02017\ \ \ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02018\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02019\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}following\ redirect\ to\ "{}}\ <<\ new\_url\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02020\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02021\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.get\_url().has\_username())\ \{}
\DoxyCodeLine{02022\ \ \ \ \ \ \ \ \ \ \ new\_url.set\_username(\_request.get\_url().get\_username());}
\DoxyCodeLine{02023\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02024\ \ \ \ \ \ \ \ \ reset\_url(\_request.get\_url(),\ new\_url);}
\DoxyCodeLine{02025\ \ \ \ \ \ \ \ \ \_request.set\_url(new\_url);}
\DoxyCodeLine{02026\ \ \ \ \ \ \ \ \ \_want\_ssl\ =\ \_request.get\_url().is\_ssl();}
\DoxyCodeLine{02027\ \ \ \ \ \ \ \ \ reconsider\_proxy();}
\DoxyCodeLine{02028\ \ \ \ \ \ \ \ \ make\_header();}
\DoxyCodeLine{02029\ \ \ \ \ \ \ \ \ make\_request\_text();}
\DoxyCodeLine{02030\ }
\DoxyCodeLine{02031\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Roll\ the\ state\ forward\ to\ force\ a\ new\ request.}}
\DoxyCodeLine{02032\ \ \ \ \ \ \ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{02033\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02034\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02035\ \ \ \ \ \}}
\DoxyCodeLine{02036\ \ \ \}}
\DoxyCodeLine{02037\ }
\DoxyCodeLine{02038\ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ S\_read\_header\ \&\&}
\DoxyCodeLine{02039\ \ \ \ \ \ \ ((get\_status\_code()\ /\ 100)\ ==\ 4\ ||\ (get\_status\_code()\ /\ 100)\ ==\ 5)\ \&\&}
\DoxyCodeLine{02040\ \ \ \ \ \ \ \_proxy\_serves\_document\ \&\&\ \_proxy\_next\_index\ <\ \_proxies.size())\ \{}
\DoxyCodeLine{02041\ \ \ \ \ \textcolor{comment}{//\ If\ we\ were\ using\ a\ proxy\ (but\ not\ tunneling\ through\ the\ proxy)\ and\ we}}
\DoxyCodeLine{02042\ \ \ \ \ \textcolor{comment}{//\ got\ some\ kind\ of\ a\ server\ error,\ try\ the\ next\ proxy\ in\ sequence\ (if\ we}}
\DoxyCodeLine{02043\ \ \ \ \ \textcolor{comment}{//\ have\ one).\ \ This\ handles\ the\ case\ of\ a\ working\ proxy\ that\ cannot\ see}}
\DoxyCodeLine{02044\ \ \ \ \ \textcolor{comment}{//\ the\ host\ (and\ so\ returns\ 504\ or\ something\ along\ those\ lines).\ \ Some}}
\DoxyCodeLine{02045\ \ \ \ \ \textcolor{comment}{//\ proxies\ are\ so\ broken\ they\ return\ a\ 404\ in\ this\ case,\ so\ we\ have\ to}}
\DoxyCodeLine{02046\ \ \ \ \ \textcolor{comment}{//\ consider\ that\ along\ the\ same\ lines.}}
\DoxyCodeLine{02047\ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{02048\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02049\ \ \ \}}
\DoxyCodeLine{02050\ }
\DoxyCodeLine{02051\ \ \ \textcolor{comment}{//\ Otherwise,\ we're\ good\ to\ go.}}
\DoxyCodeLine{02052\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02053\ \}}
\DoxyCodeLine{02054\ }
\DoxyCodeLine{02059\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02060\ run\_start\_direct\_file\_read()\ \{}
\DoxyCodeLine{02061\ \ \ \_state\ =\ S\_read\_header;}
\DoxyCodeLine{02062\ \ \ \textcolor{keywordflow}{if}\ (!open\_download\_file())\ \{}
\DoxyCodeLine{02063\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02064\ \ \ \}}
\DoxyCodeLine{02065\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02066\ \}}
\DoxyCodeLine{02067\ }
\DoxyCodeLine{02080\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02081\ run\_read\_header()\ \{}
\DoxyCodeLine{02082\ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{02083\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02084\ \}}
\DoxyCodeLine{02085\ }
\DoxyCodeLine{02090\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02091\ run\_begin\_body()\ \{}
\DoxyCodeLine{02092\ \ \ \textcolor{keywordflow}{if}\ (will\_close\_connection())\ \{}
\DoxyCodeLine{02093\ \ \ \ \ \textcolor{comment}{//\ If\ the\ socket\ will\ close\ anyway,\ no\ point\ in\ skipping\ past\ the\ previous}}
\DoxyCodeLine{02094\ \ \ \ \ \textcolor{comment}{//\ body;\ just\ reset.}}
\DoxyCodeLine{02095\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02096\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02097\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02098\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ begin\ body;\ server\ would\ close\ anyway.\(\backslash\)n"{}};}
\DoxyCodeLine{02099\ \ \ \ \ \}}
\DoxyCodeLine{02100\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02101\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02102\ \ \ \}}
\DoxyCodeLine{02103\ }
\DoxyCodeLine{02104\ \ \ \textcolor{keywordflow}{if}\ (\_server\_response\_has\_no\_body)\ \{}
\DoxyCodeLine{02105\ \ \ \ \ \textcolor{comment}{//\ We\ have\ already\ "{}read"{}\ the\ nonexistent\ body.}}
\DoxyCodeLine{02106\ \ \ \ \ \_state\ =\ S\_read\_trailer;}
\DoxyCodeLine{02107\ }
\DoxyCodeLine{02108\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (get\_file\_size()\ >\ (\textcolor{keywordtype}{int})\_skip\_body\_size)\ \{}
\DoxyCodeLine{02109\ \ \ \ \ \textcolor{comment}{//\ If\ we\ know\ the\ size\ of\ the\ body\ we\ are\ about\ to\ skip\ and\ it's\ too}}
\DoxyCodeLine{02110\ \ \ \ \ \textcolor{comment}{//\ large,\ then\ don't\ bother\ skipping\ it-\/-\/just\ drop\ the\ connection\ and\ get}}
\DoxyCodeLine{02111\ \ \ \ \ \textcolor{comment}{//\ a\ new\ one.}}
\DoxyCodeLine{02112\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02113\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02114\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02115\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Dropping\ connection\ rather\ than\ skipping\ past\ "{}}}
\DoxyCodeLine{02116\ \ \ \ \ \ \ \ \ <<\ get\_file\_size()\ <<\ \textcolor{stringliteral}{"{}\ bytes.\(\backslash\)n"{}};}
\DoxyCodeLine{02117\ \ \ \ \ \}}
\DoxyCodeLine{02118\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02119\ }
\DoxyCodeLine{02120\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02121\ \ \ \ \ open\_read\_body();}
\DoxyCodeLine{02122\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_body\_stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02123\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02124\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02125\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02126\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Unable\ to\ skip\ body.\(\backslash\)n"{}};}
\DoxyCodeLine{02127\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02128\ \ \ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02129\ }
\DoxyCodeLine{02130\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02131\ \ \ \ \ \ \ \_owns\_body\_stream\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02132\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state\ !=\ S\_reading\_body)\ \{}
\DoxyCodeLine{02133\ \ \ \ \ \ \ \ \ reset\_body\_stream();}
\DoxyCodeLine{02134\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02135\ \ \ \ \ \}}
\DoxyCodeLine{02136\ \ \ \}}
\DoxyCodeLine{02137\ }
\DoxyCodeLine{02138\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02139\ \}}
\DoxyCodeLine{02140\ }
\DoxyCodeLine{02149\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02150\ run\_reading\_body()\ \{}
\DoxyCodeLine{02151\ \ \ \textcolor{keywordflow}{if}\ (will\_close\_connection())\ \{}
\DoxyCodeLine{02152\ \ \ \ \ \textcolor{comment}{//\ If\ the\ socket\ will\ close\ anyway,\ no\ point\ in\ skipping\ past\ the\ previous}}
\DoxyCodeLine{02153\ \ \ \ \ \textcolor{comment}{//\ body;\ just\ reset.}}
\DoxyCodeLine{02154\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02155\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02156\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02157\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ read\ body;\ server\ would\ close\ anyway.\(\backslash\)n"{}};}
\DoxyCodeLine{02158\ \ \ \ \ \}}
\DoxyCodeLine{02159\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02160\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02161\ \ \ \}}
\DoxyCodeLine{02162\ }
\DoxyCodeLine{02163\ \ \ \textcolor{comment}{//\ Skip\ the\ body\ we've\ already\ started.}}
\DoxyCodeLine{02164\ \ \ \textcolor{keywordflow}{if}\ (\_body\_stream\ ==\ \textcolor{keyword}{nullptr}\ ||\ !\_owns\_body\_stream)\ \{}
\DoxyCodeLine{02165\ \ \ \ \ \textcolor{comment}{//\ Whoops,\ we're\ not\ in\ skip-\/body\ mode.\ \ Better\ reset.}}
\DoxyCodeLine{02166\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02167\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02168\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02169\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting,\ not\ in\ skip-\/body\ mode.\(\backslash\)n"{}};}
\DoxyCodeLine{02170\ \ \ \ \ \}}
\DoxyCodeLine{02171\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02172\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02173\ \ \ \}}
\DoxyCodeLine{02174\ }
\DoxyCodeLine{02175\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{02176\ \ \ std::getline(*\_body\_stream,\ line);}
\DoxyCodeLine{02177\ \ \ \textcolor{keywordflow}{while}\ (!\_body\_stream-\/>fail()\ \&\&\ !\_body\_stream-\/>eof())\ \{}
\DoxyCodeLine{02178\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{02179\ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{02180\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02181\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}skip:\ "{}}\ <<\ line\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02182\ \ \ \ \ \}}
\DoxyCodeLine{02183\ \ \ \ \ std::getline(*\_body\_stream,\ line);}
\DoxyCodeLine{02184\ \ \ \}}
\DoxyCodeLine{02185\ }
\DoxyCodeLine{02186\ \ \ \textcolor{keywordflow}{if}\ (!\_body\_socket\_stream-\/>is\_closed())\ \{}
\DoxyCodeLine{02187\ \ \ \ \ \textcolor{comment}{//\ There's\ more\ to\ come\ later.}}
\DoxyCodeLine{02188\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02189\ \ \ \}}
\DoxyCodeLine{02190\ }
\DoxyCodeLine{02191\ \ \ reset\_body\_stream();}
\DoxyCodeLine{02192\ }
\DoxyCodeLine{02193\ \ \ \textcolor{comment}{//\ This\ should\ have\ been\ set\ by\ the\ call\ to\ finished\_body(),\ above.}}
\DoxyCodeLine{02194\ \ \ nassertr(\_state\ !=\ S\_reading\_body,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02195\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02196\ \}}
\DoxyCodeLine{02197\ }
\DoxyCodeLine{02207\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02208\ run\_read\_body()\ \{}
\DoxyCodeLine{02209\ \ \ \textcolor{keywordflow}{if}\ (will\_close\_connection())\ \{}
\DoxyCodeLine{02210\ \ \ \ \ \textcolor{comment}{//\ If\ the\ socket\ will\ close\ anyway,\ no\ point\ in\ skipping\ past\ the\ previous}}
\DoxyCodeLine{02211\ \ \ \ \ \textcolor{comment}{//\ body;\ just\ reset.}}
\DoxyCodeLine{02212\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02213\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02214\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02215\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ read\ body;\ server\ would\ close\ anyway.\(\backslash\)n"{}};}
\DoxyCodeLine{02216\ \ \ \ \ \}}
\DoxyCodeLine{02217\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02218\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02219\ \ \ \}}
\DoxyCodeLine{02220\ \ \ \textcolor{comment}{//\ Skip\ the\ trailer\ following\ the\ recently-\/read\ body.}}
\DoxyCodeLine{02221\ }
\DoxyCodeLine{02222\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{02223\ \ \ \textcolor{keywordflow}{if}\ (!server\_getline(line))\ \{}
\DoxyCodeLine{02224\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02225\ \ \ \}}
\DoxyCodeLine{02226\ \ \ \textcolor{keywordflow}{while}\ (!line.empty())\ \{}
\DoxyCodeLine{02227\ \ \ \ \ \textcolor{keywordflow}{if}\ (!server\_getline(line))\ \{}
\DoxyCodeLine{02228\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02229\ \ \ \ \ \}}
\DoxyCodeLine{02230\ \ \ \}}
\DoxyCodeLine{02231\ }
\DoxyCodeLine{02232\ \ \ \_state\ =\ S\_read\_trailer;}
\DoxyCodeLine{02233\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02234\ \}}
\DoxyCodeLine{02235\ }
\DoxyCodeLine{02240\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02241\ run\_read\_trailer()\ \{}
\DoxyCodeLine{02242\ \ \ \textcolor{keywordflow}{if}\ (will\_close\_connection())\ \{}
\DoxyCodeLine{02243\ \ \ \ \ \textcolor{comment}{//\ If\ the\ socket\ will\ close\ anyway,\ no\ point\ in\ skipping\ past\ the\ previous}}
\DoxyCodeLine{02244\ \ \ \ \ \textcolor{comment}{//\ body;\ just\ reset.}}
\DoxyCodeLine{02245\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02246\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02247\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02248\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ read\ trailer;\ server\ would\ close\ anyway.\(\backslash\)n"{}};}
\DoxyCodeLine{02249\ \ \ \ \ \}}
\DoxyCodeLine{02250\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02251\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02252\ \ \ \}}
\DoxyCodeLine{02253\ }
\DoxyCodeLine{02254\ \ \ \_state\ =\ S\_ready;}
\DoxyCodeLine{02255\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02256\ \}}
\DoxyCodeLine{02257\ }
\DoxyCodeLine{02262\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02263\ run\_download\_to\_file()\ \{}
\DoxyCodeLine{02264\ \ \ nassertr(\_body\_stream\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_owns\_body\_stream,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02265\ }
\DoxyCodeLine{02266\ \ \ \textcolor{keywordtype}{bool}\ do\_throttle\ =\ \_wanted\_nonblocking\ \&\&\ \_download\_throttle;}
\DoxyCodeLine{02267\ }
\DoxyCodeLine{02268\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ buffer\_size\ =\ 4096;}
\DoxyCodeLine{02269\ \ \ \textcolor{keywordtype}{char}\ buffer[buffer\_size];}
\DoxyCodeLine{02270\ }
\DoxyCodeLine{02271\ \ \ \textcolor{keywordtype}{size\_t}\ remaining\_this\_pass\ =\ buffer\_size;}
\DoxyCodeLine{02272\ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02273\ \ \ \ \ remaining\_this\_pass\ =\ \_bytes\_per\_update;}
\DoxyCodeLine{02274\ \ \ \}}
\DoxyCodeLine{02275\ }
\DoxyCodeLine{02276\ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02277\ \ \ \textcolor{keywordtype}{size\_t}\ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02278\ \ \ \textcolor{keywordflow}{while}\ (count\ !=\ 0)\ \{}
\DoxyCodeLine{02279\ \ \ \ \ \_download\_to\_stream-\/>write(buffer,\ count);}
\DoxyCodeLine{02280\ \ \ \ \ \_bytes\_downloaded\ +=\ count;}
\DoxyCodeLine{02281\ \ \ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02282\ \ \ \ \ \ \ nassertr(count\ <=\ remaining\_this\_pass,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02283\ \ \ \ \ \ \ remaining\_this\_pass\ -\/=\ count;}
\DoxyCodeLine{02284\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (remaining\_this\_pass\ ==\ 0)\ \{}
\DoxyCodeLine{02285\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ That's\ enough\ for\ now.}}
\DoxyCodeLine{02286\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02287\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02288\ \ \ \ \ \}}
\DoxyCodeLine{02289\ }
\DoxyCodeLine{02290\ \ \ \ \ thread\_consider\_yield();}
\DoxyCodeLine{02291\ \ \ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02292\ \ \ \ \ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02293\ \ \ \}}
\DoxyCodeLine{02294\ }
\DoxyCodeLine{02295\ \ \ \textcolor{keywordflow}{if}\ (\_download\_to\_stream-\/>fail())\ \{}
\DoxyCodeLine{02296\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{02297\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02298\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Error\ writing\ to\ "{}}\ <<\ \_download\_to\_filename\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02299\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_write\_error;}
\DoxyCodeLine{02300\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02301\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{02302\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02303\ \ \ \}}
\DoxyCodeLine{02304\ }
\DoxyCodeLine{02305\ \ \ \_download\_to\_stream-\/>flush();}
\DoxyCodeLine{02306\ }
\DoxyCodeLine{02307\ \ \ \textcolor{keywordflow}{if}\ (\_body\_socket\_stream-\/>is\_closed())\ \{}
\DoxyCodeLine{02308\ \ \ \ \ \textcolor{comment}{//\ Done.}}
\DoxyCodeLine{02309\ \ \ \ \ reset\_body\_stream();}
\DoxyCodeLine{02310\ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02311\ \ \ \ \ \_started\_download\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02312\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02313\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02314\ \ \ \ \ \textcolor{comment}{//\ More\ to\ come.}}
\DoxyCodeLine{02315\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02316\ \ \ \}}
\DoxyCodeLine{02317\ \}}
\DoxyCodeLine{02318\ }
\DoxyCodeLine{02323\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02324\ run\_download\_to\_ram()\ \{}
\DoxyCodeLine{02325\ \ \ nassertr(\_body\_stream\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_owns\_body\_stream,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02326\ \ \ nassertr(\_download\_to\_ramfile\ !=\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{false});}
\DoxyCodeLine{02327\ }
\DoxyCodeLine{02328\ \ \ \textcolor{keywordtype}{bool}\ do\_throttle\ =\ \_wanted\_nonblocking\ \&\&\ \_download\_throttle;}
\DoxyCodeLine{02329\ }
\DoxyCodeLine{02330\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ buffer\_size\ =\ 4096;}
\DoxyCodeLine{02331\ \ \ \textcolor{keywordtype}{char}\ buffer[buffer\_size];}
\DoxyCodeLine{02332\ }
\DoxyCodeLine{02333\ \ \ \textcolor{keywordtype}{size\_t}\ remaining\_this\_pass\ =\ buffer\_size;}
\DoxyCodeLine{02334\ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02335\ \ \ \ \ remaining\_this\_pass\ =\ \_bytes\_per\_update;}
\DoxyCodeLine{02336\ \ \ \}}
\DoxyCodeLine{02337\ }
\DoxyCodeLine{02338\ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02339\ \ \ \textcolor{keywordtype}{size\_t}\ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02340\ \ \ \textcolor{keywordflow}{while}\ (count\ !=\ 0)\ \{}
\DoxyCodeLine{02341\ \ \ \ \ \_download\_to\_ramfile-\/>\_data\ +=\ string(buffer,\ count);}
\DoxyCodeLine{02342\ \ \ \ \ \_bytes\_downloaded\ +=\ count;}
\DoxyCodeLine{02343\ \ \ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02344\ \ \ \ \ \ \ nassertr(count\ <=\ remaining\_this\_pass,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02345\ \ \ \ \ \ \ remaining\_this\_pass\ -\/=\ count;}
\DoxyCodeLine{02346\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (remaining\_this\_pass\ ==\ 0)\ \{}
\DoxyCodeLine{02347\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ That's\ enough\ for\ now.}}
\DoxyCodeLine{02348\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02349\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02350\ \ \ \ \ \}}
\DoxyCodeLine{02351\ }
\DoxyCodeLine{02352\ \ \ \ \ thread\_consider\_yield();}
\DoxyCodeLine{02353\ \ \ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02354\ \ \ \ \ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02355\ \ \ \}}
\DoxyCodeLine{02356\ }
\DoxyCodeLine{02357\ \ \ \textcolor{keywordflow}{if}\ (\_body\_socket\_stream-\/>is\_closed())\ \{}
\DoxyCodeLine{02358\ \ \ \ \ \textcolor{comment}{//\ Done.}}
\DoxyCodeLine{02359\ \ \ \ \ reset\_body\_stream();}
\DoxyCodeLine{02360\ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02361\ \ \ \ \ \_started\_download\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02362\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02363\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02364\ \ \ \ \ \textcolor{comment}{//\ More\ to\ come.}}
\DoxyCodeLine{02365\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02366\ \ \ \}}
\DoxyCodeLine{02367\ \}}
\DoxyCodeLine{02368\ }
\DoxyCodeLine{02373\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02374\ run\_download\_to\_stream()\ \{}
\DoxyCodeLine{02375\ \ \ nassertr(\_body\_stream\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ \_owns\_body\_stream,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02376\ }
\DoxyCodeLine{02377\ \ \ \textcolor{keywordtype}{bool}\ do\_throttle\ =\ \_wanted\_nonblocking\ \&\&\ \_download\_throttle;}
\DoxyCodeLine{02378\ }
\DoxyCodeLine{02379\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ buffer\_size\ =\ 4096;}
\DoxyCodeLine{02380\ \ \ \textcolor{keywordtype}{char}\ buffer[buffer\_size];}
\DoxyCodeLine{02381\ }
\DoxyCodeLine{02382\ \ \ \textcolor{keywordtype}{size\_t}\ remaining\_this\_pass\ =\ buffer\_size;}
\DoxyCodeLine{02383\ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02384\ \ \ \ \ remaining\_this\_pass\ =\ \_bytes\_per\_update;}
\DoxyCodeLine{02385\ \ \ \}}
\DoxyCodeLine{02386\ }
\DoxyCodeLine{02387\ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02388\ \ \ \textcolor{keywordtype}{size\_t}\ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02389\ \ \ \textcolor{keywordflow}{while}\ (count\ !=\ 0)\ \{}
\DoxyCodeLine{02390\ \ \ \ \ \_download\_to\_stream-\/>write(buffer,\ count);}
\DoxyCodeLine{02391\ \ \ \ \ \_bytes\_downloaded\ +=\ count;}
\DoxyCodeLine{02392\ \ \ \ \ \textcolor{keywordflow}{if}\ (do\_throttle)\ \{}
\DoxyCodeLine{02393\ \ \ \ \ \ \ nassertr(count\ <=\ remaining\_this\_pass,\ \textcolor{keyword}{false});}
\DoxyCodeLine{02394\ \ \ \ \ \ \ remaining\_this\_pass\ -\/=\ count;}
\DoxyCodeLine{02395\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (remaining\_this\_pass\ ==\ 0)\ \{}
\DoxyCodeLine{02396\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ That's\ enough\ for\ now.}}
\DoxyCodeLine{02397\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02398\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02399\ \ \ \ \ \}}
\DoxyCodeLine{02400\ }
\DoxyCodeLine{02401\ \ \ \ \ thread\_consider\_yield();}
\DoxyCodeLine{02402\ \ \ \ \ \_body\_stream-\/>read(buffer,\ min(buffer\_size,\ remaining\_this\_pass));}
\DoxyCodeLine{02403\ \ \ \ \ count\ =\ \_body\_stream-\/>gcount();}
\DoxyCodeLine{02404\ \ \ \}}
\DoxyCodeLine{02405\ }
\DoxyCodeLine{02406\ \ \ \textcolor{keywordflow}{if}\ (\_download\_to\_stream-\/>fail())\ \{}
\DoxyCodeLine{02407\ \ \ \ \ downloader\_cat.warning()}
\DoxyCodeLine{02408\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02409\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Error\ writing\ to\ stream\(\backslash\)n"{}};}
\DoxyCodeLine{02410\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_write\_error;}
\DoxyCodeLine{02411\ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02412\ \ \ \ \ reset\_download\_to();}
\DoxyCodeLine{02413\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02414\ \ \ \}}
\DoxyCodeLine{02415\ }
\DoxyCodeLine{02416\ \ \ \_download\_to\_stream-\/>flush();}
\DoxyCodeLine{02417\ }
\DoxyCodeLine{02418\ \ \ \textcolor{keywordflow}{if}\ (\_body\_socket\_stream-\/>is\_closed())\ \{}
\DoxyCodeLine{02419\ \ \ \ \ \textcolor{comment}{//\ Done.}}
\DoxyCodeLine{02420\ \ \ \ \ reset\_body\_stream();}
\DoxyCodeLine{02421\ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02422\ \ \ \ \ \_started\_download\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02423\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02424\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02425\ \ \ \ \ \textcolor{comment}{//\ More\ to\ come.}}
\DoxyCodeLine{02426\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02427\ \ \ \}}
\DoxyCodeLine{02428\ \}}
\DoxyCodeLine{02429\ }
\DoxyCodeLine{02430\ }
\DoxyCodeLine{02435\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{02436\ begin\_request(HTTPEnum::Method\ method,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classDocumentSpec}{DocumentSpec}}\ \&url,}
\DoxyCodeLine{02437\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&body,\ \textcolor{keywordtype}{bool}\ nonblocking,}
\DoxyCodeLine{02438\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ first\_byte,\ \textcolor{keywordtype}{size\_t}\ last\_byte)\ \{}
\DoxyCodeLine{02439\ }
\DoxyCodeLine{02440\ \ \ downloader\_cat.info()}
\DoxyCodeLine{02441\ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02442\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}begin\ "{}}\ <<\ method\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ url\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02443\ }
\DoxyCodeLine{02444\ \ \ reset\_for\_new\_request();}
\DoxyCodeLine{02445\ }
\DoxyCodeLine{02446\ \ \ \_wanted\_nonblocking\ =\ nonblocking;}
\DoxyCodeLine{02447\ \textcolor{preprocessor}{\#if\ defined(HAVE\_THREADS)\ \&\&\ defined(SIMPLE\_THREADS)}}
\DoxyCodeLine{02448\ \ \ \textcolor{comment}{//\ In\ the\ presence\ of\ SIMPLE\_THREADS,\ we\ always\ use\ non-\/blocking\ IO.\ \ We}}
\DoxyCodeLine{02449\ \ \ \textcolor{comment}{//\ simulate\ blocking\ by\ yielding\ the\ thread.}}
\DoxyCodeLine{02450\ \ \ nonblocking\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02451\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02452\ }
\DoxyCodeLine{02453\ \ \ \textcolor{comment}{//\ Get\ the\ set\ of\ proxies\ that\ are\ appropriate\ for\ this\ URL.}}
\DoxyCodeLine{02454\ \ \ \_proxies.clear();}
\DoxyCodeLine{02455\ \ \ \_proxy\_next\_index\ =\ 0;}
\DoxyCodeLine{02456\ \ \ \textcolor{keywordflow}{if}\ (get\_allow\_proxy())\ \{}
\DoxyCodeLine{02457\ \ \ \ \ \_client-\/>get\_proxies\_for\_url(url.get\_url(),\ \_proxies);}
\DoxyCodeLine{02458\ \ \ \}}
\DoxyCodeLine{02459\ }
\DoxyCodeLine{02460\ \ \ \textcolor{comment}{//\ If\ we\ still\ have\ a\ live\ connection\ to\ a\ proxy\ that\ is\ on\ the\ list,\ that}}
\DoxyCodeLine{02461\ \ \ \textcolor{comment}{//\ proxy\ should\ be\ moved\ immediately\ to\ the\ front\ of\ the\ list\ (to\ minimize}}
\DoxyCodeLine{02462\ \ \ \textcolor{comment}{//\ restarting\ connections\ unnecessarily).}}
\DoxyCodeLine{02463\ \ \ \textcolor{keywordflow}{if}\ (!\_bio.is\_null()\ \&\&\ !\_proxies.empty()\ \&\&\ !\_proxy.empty())\ \{}
\DoxyCodeLine{02464\ \ \ \ \ Proxies::iterator\ pi\ =\ find(\_proxies.begin(),\ \_proxies.end(),\ \_proxy);}
\DoxyCodeLine{02465\ \ \ \ \ \textcolor{keywordflow}{if}\ (pi\ !=\ \_proxies.end())\ \{}
\DoxyCodeLine{02466\ \ \ \ \ \ \ \_proxies.erase(pi);}
\DoxyCodeLine{02467\ \ \ \ \ \ \ \_proxies.insert(\_proxies.begin(),\ \_proxy);}
\DoxyCodeLine{02468\ \ \ \ \ \}}
\DoxyCodeLine{02469\ \ \ \}}
\DoxyCodeLine{02470\ }
\DoxyCodeLine{02471\ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ new\_proxy;}
\DoxyCodeLine{02472\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_next\_index\ <\ \_proxies.size())\ \{}
\DoxyCodeLine{02473\ \ \ \ \ new\_proxy\ =\ \_proxies[\_proxy\_next\_index];}
\DoxyCodeLine{02474\ \ \ \ \ \_proxy\_next\_index++;}
\DoxyCodeLine{02475\ \ \ \}}
\DoxyCodeLine{02476\ }
\DoxyCodeLine{02477\ \ \ \textcolor{comment}{//\ Changing\ the\ proxy\ is\ grounds\ for\ dropping\ the\ old\ connection,\ if\ any.}}
\DoxyCodeLine{02478\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\ !=\ new\_proxy)\ \{}
\DoxyCodeLine{02479\ \ \ \ \ \_proxy\ =\ new\_proxy;}
\DoxyCodeLine{02480\ \ \ \ \ \_proxy\_auth\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02481\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02482\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02483\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02484\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ change\ proxy\ to\ "{}}\ <<\ \_proxy\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02485\ \ \ \ \ \}}
\DoxyCodeLine{02486\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02487\ \ \ \}}
\DoxyCodeLine{02488\ }
\DoxyCodeLine{02489\ \ \ \textcolor{comment}{//\ Ditto\ with\ changing\ the\ nonblocking\ state.}}
\DoxyCodeLine{02490\ \ \ \textcolor{keywordflow}{if}\ (\_nonblocking\ !=\ nonblocking)\ \{}
\DoxyCodeLine{02491\ \ \ \ \ \_nonblocking\ =\ nonblocking;}
\DoxyCodeLine{02492\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02493\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02494\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02495\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ change\ nonblocking\ state\ to\ "{}}\ <<\ \_nonblocking\ <<\ \textcolor{stringliteral}{"{}.\(\backslash\)n"{}};}
\DoxyCodeLine{02496\ \ \ \ \ \}}
\DoxyCodeLine{02497\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02498\ \ \ \}}
\DoxyCodeLine{02499\ }
\DoxyCodeLine{02500\ \ \ reset\_url(\_request.get\_url(),\ url.get\_url());}
\DoxyCodeLine{02501\ \ \ \_request\ =\ url;}
\DoxyCodeLine{02502\ \ \ \_document\_spec\ =\ \mbox{\hyperlink{classDocumentSpec}{DocumentSpec}}();}
\DoxyCodeLine{02503\ \ \ \_method\ =\ method;}
\DoxyCodeLine{02504\ \ \ \_body\ =\ body;}
\DoxyCodeLine{02505\ }
\DoxyCodeLine{02506\ \ \ \textcolor{comment}{//\ An\ https-\/style\ request\ means\ we'll\ need\ to\ establish\ an\ SSL\ connection.}}
\DoxyCodeLine{02507\ \ \ \_want\_ssl\ =\ \_request.get\_url().is\_ssl();}
\DoxyCodeLine{02508\ }
\DoxyCodeLine{02509\ \ \ \_first\_byte\_requested\ =\ first\_byte;}
\DoxyCodeLine{02510\ \ \ \_last\_byte\_requested\ =\ last\_byte;}
\DoxyCodeLine{02511\ \ \ \_connect\_count\ =\ 0;}
\DoxyCodeLine{02512\ }
\DoxyCodeLine{02513\ \ \ reconsider\_proxy();}
\DoxyCodeLine{02514\ }
\DoxyCodeLine{02515\ \ \ \textcolor{comment}{//\ Reset\ from\ whatever\ previous\ request\ might\ still\ be\ pending.}}
\DoxyCodeLine{02516\ \ \ \textcolor{keywordflow}{if}\ (\_request.get\_url().get\_scheme()\ ==\ \textcolor{stringliteral}{"{}file"{}})\ \{}
\DoxyCodeLine{02517\ \ \ \ \ \textcolor{comment}{//\ A\ "{}file"{}\ URL\ just\ means\ we're\ reading\ a\ raw\ file.\ \ This\ only\ supports}}
\DoxyCodeLine{02518\ \ \ \ \ \textcolor{comment}{//\ actual\ disk\ files,\ not\ the\ VFS,\ because\ we\ use\ a\ BIO\_new\_file()}}
\DoxyCodeLine{02519\ \ \ \ \ \textcolor{comment}{//\ underneath\ this.}}
\DoxyCodeLine{02520\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02521\ \ \ \ \ \_bio\ =\ \textcolor{keyword}{new}\ BioPtr(\_request.get\_url());}
\DoxyCodeLine{02522\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio-\/>get\_bio()\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02523\ \ \ \ \ \ \ \textcolor{comment}{//\ Successfully\ opened\ the\ file.}}
\DoxyCodeLine{02524\ \ \ \ \ \ \ \_source\ =\ \textcolor{keyword}{new}\ BioStreamPtr(\textcolor{keyword}{new}\ BioStream(\_bio));}
\DoxyCodeLine{02525\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ 200;}
\DoxyCodeLine{02526\ \ \ \ \ \ \ \_state\ =\ S\_start\_direct\_file\_read;}
\DoxyCodeLine{02527\ }
\DoxyCodeLine{02528\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ file\ size.}}
\DoxyCodeLine{02529\ \ \ \ \ \ \ FILE\ *fp\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{02530\ \ \ \ \ \ \ BIO\_get\_fp(\_bio-\/>get\_bio(),\ \&fp);}
\DoxyCodeLine{02531\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fp\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02532\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fseek(fp,\ 0,\ SEEK\_END)\ ==\ 0)\ \{}
\DoxyCodeLine{02533\ \ \ \ \ \ \ \ \ \ \ \_file\_size\ =\ ftell(fp);}
\DoxyCodeLine{02534\ \ \ \ \ \ \ \ \ \ \ \_got\_file\_size\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02535\ \ \ \ \ \ \ \ \ \ \ fseek(fp,\ 0,\ SEEK\_SET);}
\DoxyCodeLine{02536\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02537\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02538\ }
\DoxyCodeLine{02539\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02540\ \ \ \ \ \ \ \textcolor{comment}{//\ Couldn't\ read\ the\ file.}}
\DoxyCodeLine{02541\ \ \ \ \ \ \ OpenSSLWrapper::get\_global\_ptr()-\/>notify\_ssl\_errors();}
\DoxyCodeLine{02542\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_no\_connection;}
\DoxyCodeLine{02543\ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02544\ \ \ \ \ \}}
\DoxyCodeLine{02545\ }
\DoxyCodeLine{02546\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02547\ \ \ \ \ \textcolor{comment}{//\ We're\ reading\ a\ normal\ network\ URL.}}
\DoxyCodeLine{02548\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_state\ ==\ S\_failure\ ||\ (\_state\ <\ S\_read\_header\ \&\&\ \_state\ !=\ S\_ready))\ \{}
\DoxyCodeLine{02549\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02550\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02551\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02552\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ clear\ previous\ request.\(\backslash\)n"{}};}
\DoxyCodeLine{02553\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02554\ \ \ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02555\ }
\DoxyCodeLine{02556\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/\ \_last\_run\_time\ >=\ \_idle\_timeout)\ \{}
\DoxyCodeLine{02557\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02558\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02559\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02560\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ old\ connection:\ "{}}}
\DoxyCodeLine{02561\ \ \ \ \ \ \ \ \ \ \ <<\ TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/\ \_last\_run\_time}
\DoxyCodeLine{02562\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ s\ old.\(\backslash\)n"{}};}
\DoxyCodeLine{02563\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02564\ \ \ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02565\ }
\DoxyCodeLine{02566\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_state\ ==\ S\_read\_header)\ \{}
\DoxyCodeLine{02567\ \ \ \ \ \ \ \textcolor{comment}{//\ Roll\ one\ step\ forwards\ to\ start\ skipping\ past\ the\ previous\ body.}}
\DoxyCodeLine{02568\ \ \ \ \ \ \ \_state\ =\ S\_begin\_body;}
\DoxyCodeLine{02569\ \ \ \ \ \}}
\DoxyCodeLine{02570\ \ \ \}}
\DoxyCodeLine{02571\ }
\DoxyCodeLine{02572\ \ \ \textcolor{keywordflow}{if}\ (\_method\ ==\ HTTPEnum::M\_connect)\ \{}
\DoxyCodeLine{02573\ \ \ \ \ \_done\_state\ =\ S\_ready;}
\DoxyCodeLine{02574\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02575\ \ \ \ \ \_done\_state\ =\ S\_read\_header;}
\DoxyCodeLine{02576\ \ \ \}}
\DoxyCodeLine{02577\ \}}
\DoxyCodeLine{02578\ }
\DoxyCodeLine{02585\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{02586\ reconsider\_proxy()\ \{}
\DoxyCodeLine{02587\ \ \ \_proxy\_tunnel\_now\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02588\ \ \ \_proxy\_serves\_document\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02589\ }
\DoxyCodeLine{02590\ \ \ \textcolor{keywordflow}{if}\ (!\_proxy.empty())\ \{}
\DoxyCodeLine{02591\ \ \ \ \ \textcolor{comment}{//\ If\ the\ user\ insists\ we\ always\ tunnel\ through\ a\ proxy,\ or\ if\ we're}}
\DoxyCodeLine{02592\ \ \ \ \ \textcolor{comment}{//\ opening\ an\ SSL\ connection,\ or\ the\ user\ has\ explicitly\ asked\ for\ a}}
\DoxyCodeLine{02593\ \ \ \ \ \textcolor{comment}{//\ direct\ connection\ of\ some\ kind,\ or\ if\ we\ have\ a\ SOCKS-\/style\ proxy;\ each}}
\DoxyCodeLine{02594\ \ \ \ \ \textcolor{comment}{//\ of\ these\ demands\ a\ tunnel\ through\ the\ proxy\ to\ speak\ directly\ to\ the}}
\DoxyCodeLine{02595\ \ \ \ \ \textcolor{comment}{//\ http\ server.}}
\DoxyCodeLine{02596\ \ \ \ \ \_proxy\_tunnel\_now\ =}
\DoxyCodeLine{02597\ \ \ \ \ \ \ (get\_proxy\_tunnel()\ ||\ \_want\_ssl\ ||}
\DoxyCodeLine{02598\ \ \ \ \ \ \ \ \_method\ ==\ HTTPEnum::M\_connect\ ||\ \_proxy.get\_scheme()\ ==\ \textcolor{stringliteral}{"{}socks"{}});}
\DoxyCodeLine{02599\ }
\DoxyCodeLine{02600\ \ \ \ \ \textcolor{comment}{//\ Otherwise\ (but\ we\ still\ have\ a\ proxy),\ then\ we\ ask\ the\ proxy\ to\ hand\ us}}
\DoxyCodeLine{02601\ \ \ \ \ \textcolor{comment}{//\ the\ document.}}
\DoxyCodeLine{02602\ \ \ \ \ \_proxy\_serves\_document\ =\ !\_proxy\_tunnel\_now;}
\DoxyCodeLine{02603\ \ \ \}}
\DoxyCodeLine{02604\ }
\DoxyCodeLine{02605\ \ \ make\_header();}
\DoxyCodeLine{02606\ \ \ make\_request\_text();}
\DoxyCodeLine{02607\ }
\DoxyCodeLine{02608\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_tunnel\_now)\ \{}
\DoxyCodeLine{02609\ \ \ \ \ \textcolor{comment}{//\ Maybe\ we\ need\ to\ tunnel\ through\ the\ proxy\ to\ connect\ to\ the\ server}}
\DoxyCodeLine{02610\ \ \ \ \ \textcolor{comment}{//\ directly.}}
\DoxyCodeLine{02611\ \ \ \ \ ostringstream\ request;}
\DoxyCodeLine{02612\ \ \ \ \ request}
\DoxyCodeLine{02613\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}CONNECT\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{02614\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ \_client-\/>get\_http\_version\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{02615\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_http\_version()\ >=\ HTTPEnum::HV\_11)\ \{}
\DoxyCodeLine{02616\ \ \ \ \ \ \ request}
\DoxyCodeLine{02617\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Host:\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{02618\ \ \ \ \ \}}
\DoxyCodeLine{02619\ \ \ \ \ \_proxy\_header\ =\ request.str();}
\DoxyCodeLine{02620\ \ \ \ \ make\_proxy\_request\_text();}
\DoxyCodeLine{02621\ }
\DoxyCodeLine{02622\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02623\ \ \ \ \ \_proxy\_header\ =\ string();}
\DoxyCodeLine{02624\ \ \ \ \ \_proxy\_request\_text\ =\ string();}
\DoxyCodeLine{02625\ \ \ \}}
\DoxyCodeLine{02626\ \}}
\DoxyCodeLine{02627\ }
\DoxyCodeLine{02628\ }
\DoxyCodeLine{02633\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{02634\ reset\_for\_new\_request()\ \{}
\DoxyCodeLine{02635\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{02636\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{02637\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02638\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}reset\_for\_new\_request.\(\backslash\)n"{}};}
\DoxyCodeLine{02639\ \ \ \}}
\DoxyCodeLine{02640\ }
\DoxyCodeLine{02641\ \ \ reset\_download\_to();}
\DoxyCodeLine{02642\ \ \ reset\_body\_stream();}
\DoxyCodeLine{02643\ }
\DoxyCodeLine{02644\ \ \ \_last\_status\_code\ =\ 0;}
\DoxyCodeLine{02645\ \ \ \_status\_entry\ =\ StatusEntry();}
\DoxyCodeLine{02646\ }
\DoxyCodeLine{02647\ \ \ \_response\_type\ =\ RT\_none;}
\DoxyCodeLine{02648\ \ \ \_redirect\_trail.clear();}
\DoxyCodeLine{02649\ \ \ \_bytes\_downloaded\ =\ 0;}
\DoxyCodeLine{02650\ \ \ \_bytes\_requested\ =\ 0;}
\DoxyCodeLine{02651\ \}}
\DoxyCodeLine{02652\ }
\DoxyCodeLine{02661\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{02662\ finished\_body(\textcolor{keywordtype}{bool}\ has\_trailer)\ \{}
\DoxyCodeLine{02663\ \ \ \textcolor{keywordflow}{if}\ (will\_close\_connection()\ \&\&\ \_download\_dest\ ==\ DD\_none)\ \{}
\DoxyCodeLine{02664\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02665\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02666\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02667\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ to\ finish\ body;\ server\ would\ close\ anyway.\(\backslash\)n"{}};}
\DoxyCodeLine{02668\ \ \ \ \ \}}
\DoxyCodeLine{02669\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02670\ }
\DoxyCodeLine{02671\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02672\ \ \ \ \ \textcolor{keywordflow}{if}\ (has\_trailer)\ \{}
\DoxyCodeLine{02673\ \ \ \ \ \ \ \_state\ =\ HTTPChannel::S\_read\_body;}
\DoxyCodeLine{02674\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02675\ \ \ \ \ \ \ \_state\ =\ HTTPChannel::S\_read\_trailer;}
\DoxyCodeLine{02676\ \ \ \ \ \}}
\DoxyCodeLine{02677\ \ \ \}}
\DoxyCodeLine{02678\ \}}
\DoxyCodeLine{02679\ }
\DoxyCodeLine{02688\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02689\ open\_download\_file()\ \{}
\DoxyCodeLine{02690\ \ \ \_subdocument\_resumes\ =\ (\_subdocument\_resumes\ \&\&\ \_first\_byte\_delivered\ !=\ 0);}
\DoxyCodeLine{02691\ }
\DoxyCodeLine{02692\ \ \ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_file)\ \{}
\DoxyCodeLine{02693\ \ \ \ \ \mbox{\hyperlink{classVirtualFileSystem}{VirtualFileSystem}}\ *vfs\ =\ VirtualFileSystem::get\_global\_ptr();}
\DoxyCodeLine{02694\ \ \ \ \ \_download\_to\_stream\ =\ vfs-\/>open\_write\_file(\_download\_to\_filename,\ \textcolor{keyword}{false},\ !\_subdocument\_resumes);}
\DoxyCodeLine{02695\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_download\_to\_stream\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{02696\ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02697\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02698\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ open\ "{}}\ <<\ \_download\_to\_filename\ <<\ \textcolor{stringliteral}{"{}\ for\ writing.\(\backslash\)n"{}};}
\DoxyCodeLine{02699\ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_open\_error;}
\DoxyCodeLine{02700\ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02701\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02702\ \ \ \ \ \}}
\DoxyCodeLine{02703\ \ \ \}}
\DoxyCodeLine{02704\ }
\DoxyCodeLine{02705\ \ \ \textcolor{keywordflow}{if}\ (\_subdocument\_resumes)\ \{}
\DoxyCodeLine{02706\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_file)\ \{}
\DoxyCodeLine{02707\ \ \ \ \ \ \ \textcolor{comment}{//\ Windows\ doesn't\ complain\ if\ you\ try\ to\ seek\ past\ the\ end\ of\ file-\/-\/it}}
\DoxyCodeLine{02708\ \ \ \ \ \ \ \textcolor{comment}{//\ happily\ appends\ enough\ zero\ bytes\ to\ make\ the\ difference.\ \ Blecch.}}
\DoxyCodeLine{02709\ \ \ \ \ \ \ \textcolor{comment}{//\ That\ means\ we\ need\ to\ get\ the\ file\ size\ first\ to\ check\ it\ ourselves.}}
\DoxyCodeLine{02710\ \ \ \ \ \ \ \_download\_to\_stream-\/>seekp(0,\ std::ios::end);}
\DoxyCodeLine{02711\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_delivered\ >\ (\textcolor{keywordtype}{size\_t})\_download\_to\_stream-\/>tellp())\ \{}
\DoxyCodeLine{02712\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02713\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02714\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ starting\ position\ of\ byte\ "{}}\ <<\ \_first\_byte\_delivered}
\DoxyCodeLine{02715\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ within\ "{}}\ <<\ \_download\_to\_filename\ <<\ \textcolor{stringliteral}{"{}\ (which\ has\ "{}}}
\DoxyCodeLine{02716\ \ \ \ \ \ \ \ \ \ \ <<\ \_download\_to\_stream-\/>tellp()\ <<\ \textcolor{stringliteral}{"{}\ bytes)\(\backslash\)n"{}};}
\DoxyCodeLine{02717\ \ \ \ \ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02718\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_invalid\_range;}
\DoxyCodeLine{02719\ \ \ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02720\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02721\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02722\ }
\DoxyCodeLine{02723\ \ \ \ \ \ \ \_download\_to\_stream-\/>seekp(\_first\_byte\_delivered);}
\DoxyCodeLine{02724\ }
\DoxyCodeLine{02725\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_ram)\ \{}
\DoxyCodeLine{02726\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_delivered\ >\ \_download\_to\_ramfile-\/>\_data.length())\ \{}
\DoxyCodeLine{02727\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02728\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02729\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ starting\ position\ of\ byte\ "{}}\ <<\ \_first\_byte\_delivered}
\DoxyCodeLine{02730\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ within\ Ramfile\ (which\ has\ "{}}}
\DoxyCodeLine{02731\ \ \ \ \ \ \ \ \ \ \ <<\ \_download\_to\_ramfile-\/>\_data.length()\ <<\ \textcolor{stringliteral}{"{}\ bytes)\(\backslash\)n"{}};}
\DoxyCodeLine{02732\ \ \ \ \ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02733\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_invalid\_range;}
\DoxyCodeLine{02734\ \ \ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02735\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02736\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02737\ }
\DoxyCodeLine{02738\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_delivered\ ==\ 0)\ \{}
\DoxyCodeLine{02739\ \ \ \ \ \ \ \ \ \_download\_to\_ramfile-\/>\_data\ =\ string();}
\DoxyCodeLine{02740\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02741\ \ \ \ \ \ \ \ \ \_download\_to\_ramfile-\/>\_data\ =}
\DoxyCodeLine{02742\ \ \ \ \ \ \ \ \ \ \ \_download\_to\_ramfile-\/>\_data.substr(0,\ \_first\_byte\_delivered);}
\DoxyCodeLine{02743\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02744\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_stream)\ \{}
\DoxyCodeLine{02745\ \ \ \ \ \ \ \textcolor{comment}{//\ Windows\ doesn't\ complain\ if\ you\ try\ to\ seek\ past\ the\ end\ of\ file-\/-\/it}}
\DoxyCodeLine{02746\ \ \ \ \ \ \ \textcolor{comment}{//\ happily\ appends\ enough\ zero\ bytes\ to\ make\ the\ difference.\ \ Blecch.}}
\DoxyCodeLine{02747\ \ \ \ \ \ \ \textcolor{comment}{//\ That\ means\ we\ need\ to\ get\ the\ file\ size\ first\ to\ check\ it\ ourselves.}}
\DoxyCodeLine{02748\ \ \ \ \ \ \ \_download\_to\_stream-\/>seekp(0,\ std::ios::end);}
\DoxyCodeLine{02749\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_delivered\ >\ (\textcolor{keywordtype}{size\_t})\_download\_to\_stream-\/>tellp())\ \{}
\DoxyCodeLine{02750\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02751\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02752\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Invalid\ starting\ position\ of\ byte\ "{}}\ <<\ \_first\_byte\_delivered}
\DoxyCodeLine{02753\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ within\ stream\ (which\ has\ "{}}}
\DoxyCodeLine{02754\ \ \ \ \ \ \ \ \ \ \ <<\ \_download\_to\_stream-\/>tellp()\ <<\ \textcolor{stringliteral}{"{}\ bytes)\(\backslash\)n"{}};}
\DoxyCodeLine{02755\ \ \ \ \ \ \ \ \ close\_download\_stream();}
\DoxyCodeLine{02756\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_download\_invalid\_range;}
\DoxyCodeLine{02757\ \ \ \ \ \ \ \ \ \_state\ =\ S\_failure;}
\DoxyCodeLine{02758\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02759\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02760\ }
\DoxyCodeLine{02761\ \ \ \ \ \ \ \_download\_to\_stream-\/>seekp(\_first\_byte\_delivered);}
\DoxyCodeLine{02762\ \ \ \ \ \}}
\DoxyCodeLine{02763\ }
\DoxyCodeLine{02764\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02765\ \ \ \ \ \textcolor{comment}{//\ If\ \_subdocument\_resumes\ is\ false,\ we\ should\ be\ sure\ to\ reset\ to\ the}}
\DoxyCodeLine{02766\ \ \ \ \ \textcolor{comment}{//\ beginning\ of\ the\ file,\ regardless\ of\ the\ value\ of}}
\DoxyCodeLine{02767\ \ \ \ \ \textcolor{comment}{//\ \_first\_byte\_delivered.}}
\DoxyCodeLine{02768\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_file\ ||\ \_download\_dest\ ==\ DD\_stream)\ \{}
\DoxyCodeLine{02769\ \ \ \ \ \ \ \_download\_to\_stream-\/>seekp(0);}
\DoxyCodeLine{02770\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_ram)\ \{}
\DoxyCodeLine{02771\ \ \ \ \ \ \ \_download\_to\_ramfile-\/>\_data\ =\ string();}
\DoxyCodeLine{02772\ \ \ \ \ \}}
\DoxyCodeLine{02773\ \ \ \}}
\DoxyCodeLine{02774\ }
\DoxyCodeLine{02775\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02776\ \}}
\DoxyCodeLine{02777\ }
\DoxyCodeLine{02778\ }
\DoxyCodeLine{02784\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02785\ server\_getline(\textcolor{keywordtype}{string}\ \&str)\ \{}
\DoxyCodeLine{02786\ \ \ nassertr(!\_source.is\_null(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{02787\ \ \ \textcolor{keywordtype}{int}\ ch\ =\ (*\_source)-\/>get();}
\DoxyCodeLine{02788\ \ \ \textcolor{keywordflow}{while}\ (ch\ !=\ EOF\ \&\&\ !(*\_source)-\/>fail())\ \{}
\DoxyCodeLine{02789\ \ \ \ \ \textcolor{keywordflow}{switch}\ (ch)\ \{}
\DoxyCodeLine{02790\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'\(\backslash\)n'}:}
\DoxyCodeLine{02791\ \ \ \ \ \ \ \textcolor{comment}{//\ end-\/of-\/line\ character,\ we're\ done.}}
\DoxyCodeLine{02792\ \ \ \ \ \ \ str\ =\ \_working\_get;}
\DoxyCodeLine{02793\ \ \ \ \ \ \ \_working\_get\ =\ string();}
\DoxyCodeLine{02794\ \ \ \ \ \ \ \{}
\DoxyCodeLine{02795\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Trim\ trailing\ whitespace.\ \ We're\ not\ required\ to\ do\ this\ per\ the}}
\DoxyCodeLine{02796\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ HTTP\ spec,\ but\ let's\ be\ generous.}}
\DoxyCodeLine{02797\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ str.length();}
\DoxyCodeLine{02798\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (p\ >\ 0\ \&\&\ isspace(str[p\ -\/\ 1]))\ \{}
\DoxyCodeLine{02799\ \ \ \ \ \ \ \ \ \ \ -\/-\/p;}
\DoxyCodeLine{02800\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02801\ \ \ \ \ \ \ \ \ str\ =\ str.substr(0,\ p);}
\DoxyCodeLine{02802\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02803\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{02804\ \ \ \ \ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{02805\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02806\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}recv:\ "{}}\ <<\ str\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02807\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02808\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02809\ }
\DoxyCodeLine{02810\ \ \ \ \ \textcolor{keywordflow}{case}\ \textcolor{charliteral}{'\(\backslash\)r'}:}
\DoxyCodeLine{02811\ \ \ \ \ \ \ \textcolor{comment}{//\ Ignore\ CR\ characters.}}
\DoxyCodeLine{02812\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02813\ }
\DoxyCodeLine{02814\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{02815\ \ \ \ \ \ \ \_working\_get\ +=\ (char)ch;}
\DoxyCodeLine{02816\ \ \ \ \ \}}
\DoxyCodeLine{02817\ \ \ \ \ ch\ =\ (*\_source)-\/>get();}
\DoxyCodeLine{02818\ \ \ \}}
\DoxyCodeLine{02819\ }
\DoxyCodeLine{02820\ \ \ check\_socket();}
\DoxyCodeLine{02821\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02822\ \}}
\DoxyCodeLine{02823\ }
\DoxyCodeLine{02829\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02830\ server\_getline\_failsafe(\textcolor{keywordtype}{string}\ \&str)\ \{}
\DoxyCodeLine{02831\ \ \ \textcolor{keywordflow}{if}\ (!server\_getline(str))\ \{}
\DoxyCodeLine{02832\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio.is\_null())\ \{}
\DoxyCodeLine{02833\ \ \ \ \ \ \ \textcolor{comment}{//\ Huh,\ the\ server\ hung\ up\ on\ us\ as\ soon\ as\ we\ tried\ to\ connect.}}
\DoxyCodeLine{02834\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_response\_type\ ==\ RT\_hangup)\ \{}
\DoxyCodeLine{02835\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ second\ immediate\ hangup\ in\ a\ row.\ \ Give\ up.}}
\DoxyCodeLine{02836\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_lost\_connection;}
\DoxyCodeLine{02837\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{02838\ }
\DoxyCodeLine{02839\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02840\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Try\ again,\ once.}}
\DoxyCodeLine{02841\ \ \ \ \ \ \ \ \ \_response\_type\ =\ RT\_hangup;}
\DoxyCodeLine{02842\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02843\ }
\DoxyCodeLine{02844\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02845\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ elapsed\ =}
\DoxyCodeLine{02846\ \ \ \ \ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/}
\DoxyCodeLine{02847\ \ \ \ \ \ \ \ \ \_sent\_request\_time;}
\DoxyCodeLine{02848\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (elapsed\ >\ get\_http\_timeout())\ \{}
\DoxyCodeLine{02849\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Time\ to\ give\ up.}}
\DoxyCodeLine{02850\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02851\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02852\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Timeout\ waiting\ for\ "{}}}
\DoxyCodeLine{02853\ \ \ \ \ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{02854\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ in\ server\_getline\_failsafe\ ("{}}\ <<\ elapsed}
\DoxyCodeLine{02855\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ seconds\ elapsed).\(\backslash\)n"{}};}
\DoxyCodeLine{02856\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_timeout;}
\DoxyCodeLine{02857\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{02858\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02859\ \ \ \ \ \}}
\DoxyCodeLine{02860\ }
\DoxyCodeLine{02861\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02862\ \ \ \}}
\DoxyCodeLine{02863\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02864\ \}}
\DoxyCodeLine{02865\ }
\DoxyCodeLine{02872\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02873\ server\_get(\textcolor{keywordtype}{string}\ \&str,\ \textcolor{keywordtype}{size\_t}\ num\_bytes)\ \{}
\DoxyCodeLine{02874\ \ \ nassertr(!\_source.is\_null(),\ \textcolor{keyword}{false});}
\DoxyCodeLine{02875\ \ \ \textcolor{keywordtype}{int}\ ch\ =\ (*\_source)-\/>get();}
\DoxyCodeLine{02876\ \ \ \textcolor{keywordflow}{while}\ (ch\ !=\ EOF\ \&\&\ !(*\_source)-\/>fail())\ \{}
\DoxyCodeLine{02877\ \ \ \ \ \_working\_get\ +=\ (char)ch;}
\DoxyCodeLine{02878\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_working\_get.length()\ >=\ num\_bytes)\ \{}
\DoxyCodeLine{02879\ \ \ \ \ \ \ str\ =\ \_working\_get;}
\DoxyCodeLine{02880\ \ \ \ \ \ \ \_working\_get\ =\ string();}
\DoxyCodeLine{02881\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02882\ \ \ \ \ \}}
\DoxyCodeLine{02883\ }
\DoxyCodeLine{02884\ \ \ \ \ ch\ =\ (*\_source)-\/>get();}
\DoxyCodeLine{02885\ \ \ \}}
\DoxyCodeLine{02886\ }
\DoxyCodeLine{02887\ \ \ check\_socket();}
\DoxyCodeLine{02888\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02889\ \}}
\DoxyCodeLine{02890\ }
\DoxyCodeLine{02896\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02897\ server\_get\_failsafe(\textcolor{keywordtype}{string}\ \&str,\ \textcolor{keywordtype}{size\_t}\ num\_bytes)\ \{}
\DoxyCodeLine{02898\ \ \ \textcolor{keywordflow}{if}\ (!server\_get(str,\ num\_bytes))\ \{}
\DoxyCodeLine{02899\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_bio.is\_null())\ \{}
\DoxyCodeLine{02900\ \ \ \ \ \ \ \textcolor{comment}{//\ Huh,\ the\ server\ hung\ up\ on\ us\ as\ soon\ as\ we\ tried\ to\ connect.}}
\DoxyCodeLine{02901\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_response\_type\ ==\ RT\_hangup)\ \{}
\DoxyCodeLine{02902\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ second\ immediate\ hangup\ in\ a\ row.\ \ Give\ up.}}
\DoxyCodeLine{02903\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_lost\_connection;}
\DoxyCodeLine{02904\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{02905\ }
\DoxyCodeLine{02906\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02907\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Try\ again,\ once.}}
\DoxyCodeLine{02908\ \ \ \ \ \ \ \ \ \_response\_type\ =\ RT\_hangup;}
\DoxyCodeLine{02909\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02910\ }
\DoxyCodeLine{02911\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{02912\ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ elapsed\ =}
\DoxyCodeLine{02913\ \ \ \ \ \ \ \ \ TrueClock::get\_global\_ptr()-\/>get\_short\_time()\ -\/}
\DoxyCodeLine{02914\ \ \ \ \ \ \ \ \ \_sent\_request\_time;}
\DoxyCodeLine{02915\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (elapsed\ >\ get\_http\_timeout())\ \{}
\DoxyCodeLine{02916\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Time\ to\ give\ up.}}
\DoxyCodeLine{02917\ \ \ \ \ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{02918\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02919\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Timeout\ waiting\ for\ "{}}}
\DoxyCodeLine{02920\ \ \ \ \ \ \ \ \ \ \ <<\ \_request.get\_url().get\_server\_and\_port()}
\DoxyCodeLine{02921\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ in\ server\_get\_failsafe\ ("{}}\ <<\ elapsed}
\DoxyCodeLine{02922\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ seconds\ elapsed).\(\backslash\)n"{}};}
\DoxyCodeLine{02923\ \ \ \ \ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_timeout;}
\DoxyCodeLine{02924\ \ \ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{02925\ \ \ \ \ \ \ \}}
\DoxyCodeLine{02926\ \ \ \ \ \}}
\DoxyCodeLine{02927\ }
\DoxyCodeLine{02928\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02929\ \ \ \}}
\DoxyCodeLine{02930\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02931\ \}}
\DoxyCodeLine{02932\ }
\DoxyCodeLine{02943\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02944\ server\_send(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&str,\ \textcolor{keywordtype}{bool}\ secret)\ \{}
\DoxyCodeLine{02945\ \ \ nassertr(str.length()\ >\ \_sent\_so\_far,\ \textcolor{keyword}{true});}
\DoxyCodeLine{02946\ }
\DoxyCodeLine{02947\ \ \ \textcolor{comment}{//\ Use\ the\ underlying\ BIO\ to\ write\ to\ the\ server,\ instead\ of\ the\ BIOStream,}}
\DoxyCodeLine{02948\ \ \ \textcolor{comment}{//\ which\ would\ insist\ on\ blocking\ (and\ might\ furthermore\ delay\ the\ send\ due}}
\DoxyCodeLine{02949\ \ \ \textcolor{comment}{//\ to\ collect-\/tcp\ mode\ being\ enabled).}}
\DoxyCodeLine{02950\ \ \ \textcolor{keywordtype}{size\_t}\ bytes\_to\_send\ =\ str.length()\ -\/\ \_sent\_so\_far;}
\DoxyCodeLine{02951\ \ \ \textcolor{keywordtype}{int}\ write\_count\ =}
\DoxyCodeLine{02952\ \ \ \ \ BIO\_write(*\_bio,\ str.data()\ +\ \_sent\_so\_far,\ bytes\_to\_send);}
\DoxyCodeLine{02953\ }
\DoxyCodeLine{02954\ \ \ \textcolor{keywordflow}{if}\ (write\_count\ <=\ 0)\ \{}
\DoxyCodeLine{02955\ \ \ \ \ \textcolor{keywordflow}{if}\ (BIO\_should\_retry(*\_bio))\ \{}
\DoxyCodeLine{02956\ \ \ \ \ \ \ \textcolor{comment}{//\ Temporary\ failure:\ the\ pipe\ is\ full.\ \ Wait\ till\ later.}}
\DoxyCodeLine{02957\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02958\ \ \ \ \ \}}
\DoxyCodeLine{02959\ \ \ \ \ \textcolor{comment}{//\ Oops,\ the\ connection\ has\ been\ closed!}}
\DoxyCodeLine{02960\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{02961\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{02962\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02963\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Lost\ connection\ to\ server\ unexpectedly\ during\ write.\(\backslash\)n"{}};}
\DoxyCodeLine{02964\ \ \ \ \ \}}
\DoxyCodeLine{02965\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{02966\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02967\ \ \ \}}
\DoxyCodeLine{02968\ }
\DoxyCodeLine{02969\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{02970\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{02971\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{02972\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}wrote\ "{}}\ <<\ write\_count\ <<\ \textcolor{stringliteral}{"{}\ bytes\ to\ "{}}\ <<\ \_bio\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{02973\ \ \ \}}
\DoxyCodeLine{02974\ }
\DoxyCodeLine{02975\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{02976\ \ \ \textcolor{keywordflow}{if}\ (!secret\ \&\&\ downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{02977\ \ \ \ \ show\_send(str.substr(0,\ write\_count));}
\DoxyCodeLine{02978\ \ \ \}}
\DoxyCodeLine{02979\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02980\ }
\DoxyCodeLine{02981\ \ \ \textcolor{keywordflow}{if}\ (write\_count\ <\ (\textcolor{keywordtype}{int})bytes\_to\_send)\ \{}
\DoxyCodeLine{02982\ \ \ \ \ \_sent\_so\_far\ +=\ write\_count;}
\DoxyCodeLine{02983\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02984\ \ \ \}}
\DoxyCodeLine{02985\ }
\DoxyCodeLine{02986\ \ \ \textcolor{comment}{//\ Buffer\ completely\ sent.}}
\DoxyCodeLine{02987\ \ \ \_sent\_so\_far\ =\ 0;}
\DoxyCodeLine{02988\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{02989\ \}}
\DoxyCodeLine{02990\ }
\DoxyCodeLine{02996\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{02997\ parse\_http\_response(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&line)\ \{}
\DoxyCodeLine{02998\ \ \ \textcolor{comment}{//\ The\ first\ line\ back\ should\ include\ the\ HTTP\ version\ and\ the\ result\ code.}}
\DoxyCodeLine{02999\ \ \ \textcolor{keywordflow}{if}\ (line.length()\ <\ 5\ ||\ line.substr(0,\ 5)\ !=\ \textcolor{keywordtype}{string}(\textcolor{stringliteral}{"{}HTTP/"{}}))\ \{}
\DoxyCodeLine{03000\ \ \ \ \ \textcolor{comment}{//\ Not\ an\ HTTP\ response.}}
\DoxyCodeLine{03001\ \ \ \ \ \_status\_entry.\_status\_code\ =\ SC\_non\_http\_response;}
\DoxyCodeLine{03002\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_response\_type\ ==\ RT\_non\_http)\ \{}
\DoxyCodeLine{03003\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ was\ our\ second\ non-\/HTTP\ response\ in\ a\ row.\ \ Give\ up.}}
\DoxyCodeLine{03004\ \ \ \ \ \ \ \_state\ =\ S\_try\_next\_proxy;}
\DoxyCodeLine{03005\ }
\DoxyCodeLine{03006\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03007\ \ \ \ \ \ \ \textcolor{comment}{//\ Maybe\ we\ were\ just\ in\ some\ bad\ state.\ \ Drop\ the\ connection\ and\ try}}
\DoxyCodeLine{03008\ \ \ \ \ \ \ \textcolor{comment}{//\ again,\ once.}}
\DoxyCodeLine{03009\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{03010\ \ \ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{03011\ \ \ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03012\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}got\ non-\/HTTP\ response,\ resetting.\(\backslash\)n"{}};}
\DoxyCodeLine{03013\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03014\ \ \ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{03015\ \ \ \ \ \ \ \_response\_type\ =\ RT\_non\_http;}
\DoxyCodeLine{03016\ \ \ \ \ \}}
\DoxyCodeLine{03017\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{03018\ \ \ \}}
\DoxyCodeLine{03019\ }
\DoxyCodeLine{03020\ \ \ \textcolor{comment}{//\ Split\ out\ the\ first\ line\ into\ its\ three\ components.}}
\DoxyCodeLine{03021\ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ 5;}
\DoxyCodeLine{03022\ \ \ \textcolor{keywordflow}{while}\ (p\ <\ line.length()\ \&\&\ !isspace(line[p]))\ \{}
\DoxyCodeLine{03023\ \ \ \ \ p++;}
\DoxyCodeLine{03024\ \ \ \}}
\DoxyCodeLine{03025\ \ \ \_http\_version\_string\ =\ line.substr(0,\ p);}
\DoxyCodeLine{03026\ \ \ \_http\_version\ =\ HTTPClient::parse\_http\_version\_string(\_http\_version\_string);}
\DoxyCodeLine{03027\ }
\DoxyCodeLine{03028\ \ \ \textcolor{keywordflow}{while}\ (p\ <\ line.length()\ \&\&\ isspace(line[p]))\ \{}
\DoxyCodeLine{03029\ \ \ \ \ p++;}
\DoxyCodeLine{03030\ \ \ \}}
\DoxyCodeLine{03031\ \ \ \textcolor{keywordtype}{size\_t}\ q\ =\ p;}
\DoxyCodeLine{03032\ \ \ \textcolor{keywordflow}{while}\ (q\ <\ line.length()\ \&\&\ !isspace(line[q]))\ \{}
\DoxyCodeLine{03033\ \ \ \ \ q++;}
\DoxyCodeLine{03034\ \ \ \}}
\DoxyCodeLine{03035\ \ \ \textcolor{keywordtype}{string}\ status\_code\ =\ line.substr(p,\ q\ -\/\ p);}
\DoxyCodeLine{03036\ \ \ \_status\_entry.\_status\_code\ =\ atoi(status\_code.c\_str());}
\DoxyCodeLine{03037\ }
\DoxyCodeLine{03038\ \ \ \textcolor{keywordflow}{while}\ (q\ <\ line.length()\ \&\&\ isspace(line[q]))\ \{}
\DoxyCodeLine{03039\ \ \ \ \ q++;}
\DoxyCodeLine{03040\ \ \ \}}
\DoxyCodeLine{03041\ \ \ \_status\_entry.\_status\_string\ =\ line.substr(q,\ line.length()\ -\/\ q);}
\DoxyCodeLine{03042\ }
\DoxyCodeLine{03043\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{03044\ \}}
\DoxyCodeLine{03045\ }
\DoxyCodeLine{03050\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{03051\ parse\_http\_header()\ \{}
\DoxyCodeLine{03052\ \ \ \textcolor{keywordtype}{string}\ line;}
\DoxyCodeLine{03053\ \ \ \textcolor{keywordflow}{if}\ (!server\_getline(line))\ \{}
\DoxyCodeLine{03054\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{03055\ \ \ \}}
\DoxyCodeLine{03056\ }
\DoxyCodeLine{03057\ \ \ \textcolor{keywordflow}{while}\ (!line.empty())\ \{}
\DoxyCodeLine{03058\ \ \ \ \ \textcolor{keywordflow}{if}\ (isspace(line[0]))\ \{}
\DoxyCodeLine{03059\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ line\ begins\ with\ a\ space,\ that\ continues\ the\ previous\ field.}}
\DoxyCodeLine{03060\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ 0;}
\DoxyCodeLine{03061\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (p\ <\ line.length()\ \&\&\ isspace(line[p]))\ \{}
\DoxyCodeLine{03062\ \ \ \ \ \ \ \ \ p++;}
\DoxyCodeLine{03063\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03064\ \ \ \ \ \ \ \_current\_field\_value\ +=\ line.substr(p\ -\/\ 1);}
\DoxyCodeLine{03065\ }
\DoxyCodeLine{03066\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03067\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ line\ does\ not\ begin\ with\ a\ space,\ that\ defines\ a\ new\ field.}}
\DoxyCodeLine{03068\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\_current\_field\_name.empty())\ \{}
\DoxyCodeLine{03069\ \ \ \ \ \ \ \ \ store\_header\_field(\_current\_field\_name,\ \_current\_field\_value);}
\DoxyCodeLine{03070\ \ \ \ \ \ \ \ \ \_current\_field\_value\ =\ string();}
\DoxyCodeLine{03071\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03072\ }
\DoxyCodeLine{03073\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ colon\ =\ line.find(\textcolor{charliteral}{':'});}
\DoxyCodeLine{03074\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (colon\ !=\ string::npos)\ \{}
\DoxyCodeLine{03075\ \ \ \ \ \ \ \ \ \_current\_field\_name\ =\ \mbox{\hyperlink{string__utils_8cxx_a8436b3aed06d4a4e245ab303cdf9637e}{downcase}}(line.substr(0,\ colon));}
\DoxyCodeLine{03076\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ colon\ +\ 1;}
\DoxyCodeLine{03077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (p\ <\ line.length()\ \&\&\ isspace(line[p]))\ \{}
\DoxyCodeLine{03078\ \ \ \ \ \ \ \ \ \ \ p++;}
\DoxyCodeLine{03079\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03080\ \ \ \ \ \ \ \ \ \_current\_field\_value\ =\ line.substr(p);}
\DoxyCodeLine{03081\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03082\ \ \ \ \ \}}
\DoxyCodeLine{03083\ }
\DoxyCodeLine{03084\ \ \ \ \ \textcolor{keywordflow}{if}\ (!server\_getline(line))\ \{}
\DoxyCodeLine{03085\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{03086\ \ \ \ \ \}}
\DoxyCodeLine{03087\ \ \ \}}
\DoxyCodeLine{03088\ }
\DoxyCodeLine{03089\ \ \ \textcolor{comment}{//\ After\ reading\ an\ empty\ line,\ we're\ done\ with\ the\ headers.}}
\DoxyCodeLine{03090\ \ \ \textcolor{keywordflow}{if}\ (!\_current\_field\_name.empty())\ \{}
\DoxyCodeLine{03091\ \ \ \ \ store\_header\_field(\_current\_field\_name,\ \_current\_field\_value);}
\DoxyCodeLine{03092\ \ \ \ \ \_current\_field\_value\ =\ string();}
\DoxyCodeLine{03093\ \ \ \}}
\DoxyCodeLine{03094\ }
\DoxyCodeLine{03095\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{03096\ \}}
\DoxyCodeLine{03097\ }
\DoxyCodeLine{03103\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{03104\ parse\_content\_range(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&content\_range)\ \{}
\DoxyCodeLine{03105\ \ \ \textcolor{comment}{//\ First,\ get\ the\ units\ indication.}}
\DoxyCodeLine{03106\ \ \ \textcolor{keywordtype}{size\_t}\ p\ =\ 0;}
\DoxyCodeLine{03107\ \ \ \textcolor{keywordflow}{while}\ (p\ <\ content\_range.length()\ \&\&\ !isspace(content\_range[p]))\ \{}
\DoxyCodeLine{03108\ \ \ \ \ p++;}
\DoxyCodeLine{03109\ \ \ \}}
\DoxyCodeLine{03110\ }
\DoxyCodeLine{03111\ \ \ \textcolor{keywordtype}{string}\ units\ =\ content\_range.substr(0,\ p);}
\DoxyCodeLine{03112\ \ \ \textcolor{keywordflow}{while}\ (p\ <\ content\_range.length()\ \&\&\ isspace(content\_range[p]))\ \{}
\DoxyCodeLine{03113\ \ \ \ \ p++;}
\DoxyCodeLine{03114\ \ \ \}}
\DoxyCodeLine{03115\ }
\DoxyCodeLine{03116\ \ \ \textcolor{keywordflow}{if}\ (units\ ==\ \textcolor{stringliteral}{"{}bytes"{}})\ \{}
\DoxyCodeLine{03117\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *c\_str\ =\ content\_range.c\_str();}
\DoxyCodeLine{03118\ \ \ \ \ \textcolor{keywordtype}{char}\ *endptr;}
\DoxyCodeLine{03119\ \ \ \ \ \textcolor{keywordflow}{if}\ (p\ <\ content\_range.length()\ \&\&\ isdigit(content\_range[p]))\ \{}
\DoxyCodeLine{03120\ \ \ \ \ \ \ \textcolor{keywordtype}{long}\ first\_byte\ =\ strtol(c\_str\ +\ p,\ \&endptr,\ 10);}
\DoxyCodeLine{03121\ \ \ \ \ \ \ p\ =\ endptr\ -\/\ c\_str;}
\DoxyCodeLine{03122\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (p\ <\ content\_range.length()\ \&\&\ content\_range[p]\ ==\ \textcolor{charliteral}{'-\/'})\ \{}
\DoxyCodeLine{03123\ \ \ \ \ \ \ \ \ p++;}
\DoxyCodeLine{03124\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (p\ <\ content\_range.length()\ \&\&\ isdigit(content\_range[p]))\ \{}
\DoxyCodeLine{03125\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{long}\ last\_byte\ =\ strtol(c\_str\ +\ p,\ \&endptr,\ 10);}
\DoxyCodeLine{03126\ \ \ \ \ \ \ \ \ \ \ p\ =\ endptr\ -\/\ c\_str;}
\DoxyCodeLine{03127\ }
\DoxyCodeLine{03128\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_byte\ >=\ first\_byte)\ \{}
\DoxyCodeLine{03129\ \ \ \ \ \ \ \ \ \ \ \ \ \_first\_byte\_delivered\ =\ first\_byte;}
\DoxyCodeLine{03130\ \ \ \ \ \ \ \ \ \ \ \ \ \_last\_byte\_delivered\ =\ last\_byte;}
\DoxyCodeLine{03131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{03132\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03133\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03134\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03135\ \ \ \ \ \}}
\DoxyCodeLine{03136\ \ \ \}}
\DoxyCodeLine{03137\ }
\DoxyCodeLine{03138\ \ \ \textcolor{comment}{//\ Invalid\ or\ unhandled\ response.}}
\DoxyCodeLine{03139\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{03140\ \}}
\DoxyCodeLine{03141\ }
\DoxyCodeLine{03142\ }
\DoxyCodeLine{03147\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03148\ check\_socket()\ \{}
\DoxyCodeLine{03149\ \ \ nassertv(!\_source.is\_null());}
\DoxyCodeLine{03150\ \ \ \textcolor{keywordflow}{if}\ ((*\_source)-\/>is\_closed())\ \{}
\DoxyCodeLine{03151\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{03152\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{03153\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03154\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Lost\ connection\ to\ server\ unexpectedly\ during\ read.\(\backslash\)n"{}};}
\DoxyCodeLine{03155\ \ \ \ \ \}}
\DoxyCodeLine{03156\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{03157\ \ \ \}}
\DoxyCodeLine{03158\ \}}
\DoxyCodeLine{03159\ }
\DoxyCodeLine{03160\ \textcolor{comment}{/*}}
\DoxyCodeLine{03161\ \textcolor{comment}{\ \ \ Certificate\ verify\ error\ codes:}}
\DoxyCodeLine{03162\ \textcolor{comment}{}}
\DoxyCodeLine{03163\ \textcolor{comment}{0\ X509\_V\_OK:\ ok}}
\DoxyCodeLine{03164\ \textcolor{comment}{}}
\DoxyCodeLine{03165\ \textcolor{comment}{\ \ \ \ the\ operation\ was\ successful.}}
\DoxyCodeLine{03166\ \textcolor{comment}{}}
\DoxyCodeLine{03167\ \textcolor{comment}{2\ X509\_V\_ERR\_UNABLE\_TO\_GET\_ISSUER\_CERT:\ unable\ to\ get\ issuer\ certificate}}
\DoxyCodeLine{03168\ \textcolor{comment}{}}
\DoxyCodeLine{03169\ \textcolor{comment}{\ \ \ \ the\ issuer\ certificate\ could\ not\ be\ found:\ this\ occurs\ if\ the}}
\DoxyCodeLine{03170\ \textcolor{comment}{\ \ \ \ issuer\ certificate\ of\ an\ untrusted\ certificate\ cannot\ be\ found.}}
\DoxyCodeLine{03171\ \textcolor{comment}{}}
\DoxyCodeLine{03172\ \textcolor{comment}{3\ X509\_V\_ERR\_UNABLE\_TO\_GET\_CRL\ unable\ to\ get\ certificate\ CRL}}
\DoxyCodeLine{03173\ \textcolor{comment}{}}
\DoxyCodeLine{03174\ \textcolor{comment}{\ \ \ \ the\ CRL\ of\ a\ certificate\ could\ not\ be\ found.\ Unused.}}
\DoxyCodeLine{03175\ \textcolor{comment}{}}
\DoxyCodeLine{03176\ \textcolor{comment}{4\ X509\_V\_ERR\_UNABLE\_TO\_DECRYPT\_CERT\_SIGNATURE:\ unable\ to\ decrypt}}
\DoxyCodeLine{03177\ \textcolor{comment}{certificate's\ signature}}
\DoxyCodeLine{03178\ \textcolor{comment}{}}
\DoxyCodeLine{03179\ \textcolor{comment}{\ \ \ \ the\ certificate\ signature\ could\ not\ be\ decrypted.\ This\ means\ that}}
\DoxyCodeLine{03180\ \textcolor{comment}{\ \ \ \ the\ actual\ signature\ value\ could\ not\ be\ determined\ rather\ than\ it}}
\DoxyCodeLine{03181\ \textcolor{comment}{\ \ \ \ not\ matching\ the\ expected\ value,\ this\ is\ only\ meaningful\ for\ RSA}}
\DoxyCodeLine{03182\ \textcolor{comment}{\ \ \ \ keys.}}
\DoxyCodeLine{03183\ \textcolor{comment}{}}
\DoxyCodeLine{03184\ \textcolor{comment}{5\ X509\_V\_ERR\_UNABLE\_TO\_DECRYPT\_CRL\_SIGNATURE:\ unable\ to\ decrypt\ CRL's\ signature}}
\DoxyCodeLine{03185\ \textcolor{comment}{}}
\DoxyCodeLine{03186\ \textcolor{comment}{\ \ \ \ the\ CRL\ signature\ could\ not\ be\ decrypted:\ this\ means\ that\ the}}
\DoxyCodeLine{03187\ \textcolor{comment}{\ \ \ \ actual\ signature\ value\ could\ not\ be\ determined\ rather\ than\ it\ not}}
\DoxyCodeLine{03188\ \textcolor{comment}{\ \ \ \ matching\ the\ expected\ value.\ Unused.}}
\DoxyCodeLine{03189\ \textcolor{comment}{}}
\DoxyCodeLine{03190\ \textcolor{comment}{6\ X509\_V\_ERR\_UNABLE\_TO\_DECODE\_ISSUER\_PUBLIC\_KEY:\ unable\ to\ decode}}
\DoxyCodeLine{03191\ \textcolor{comment}{issuer\ public\ key}}
\DoxyCodeLine{03192\ \textcolor{comment}{}}
\DoxyCodeLine{03193\ \textcolor{comment}{\ \ \ \ the\ public\ key\ in\ the\ certificate\ SubjectPublicKeyInfo\ could\ not}}
\DoxyCodeLine{03194\ \textcolor{comment}{\ \ \ \ be\ read.}}
\DoxyCodeLine{03195\ \textcolor{comment}{}}
\DoxyCodeLine{03196\ \textcolor{comment}{7\ X509\_V\_ERR\_CERT\_SIGNATURE\_FAILURE:\ certificate\ signature\ failure}}
\DoxyCodeLine{03197\ \textcolor{comment}{}}
\DoxyCodeLine{03198\ \textcolor{comment}{\ \ \ \ the\ signature\ of\ the\ certificate\ is\ invalid.}}
\DoxyCodeLine{03199\ \textcolor{comment}{}}
\DoxyCodeLine{03200\ \textcolor{comment}{8\ X509\_V\_ERR\_CRL\_SIGNATURE\_FAILURE:\ CRL\ signature\ failure}}
\DoxyCodeLine{03201\ \textcolor{comment}{}}
\DoxyCodeLine{03202\ \textcolor{comment}{\ \ \ \ the\ signature\ of\ the\ certificate\ is\ invalid.\ Unused.}}
\DoxyCodeLine{03203\ \textcolor{comment}{}}
\DoxyCodeLine{03204\ \textcolor{comment}{9\ X509\_V\_ERR\_CERT\_NOT\_YET\_VALID:\ certificate\ is\ not\ yet\ valid}}
\DoxyCodeLine{03205\ \textcolor{comment}{}}
\DoxyCodeLine{03206\ \textcolor{comment}{\ \ \ \ the\ certificate\ is\ not\ yet\ valid:\ the\ notBefore\ date\ is\ after\ the}}
\DoxyCodeLine{03207\ \textcolor{comment}{\ \ \ \ current\ time.}}
\DoxyCodeLine{03208\ \textcolor{comment}{}}
\DoxyCodeLine{03209\ \textcolor{comment}{10\ X509\_V\_ERR\_CERT\_HAS\_EXPIRED:\ certificate\ has\ expired}}
\DoxyCodeLine{03210\ \textcolor{comment}{}}
\DoxyCodeLine{03211\ \textcolor{comment}{\ \ \ \ the\ certificate\ has\ expired:\ that\ is\ the\ notAfter\ date\ is\ before}}
\DoxyCodeLine{03212\ \textcolor{comment}{\ \ \ \ the\ current\ time.}}
\DoxyCodeLine{03213\ \textcolor{comment}{}}
\DoxyCodeLine{03214\ \textcolor{comment}{11\ X509\_V\_ERR\_CRL\_NOT\_YET\_VALID:\ CRL\ is\ not\ yet\ valid}}
\DoxyCodeLine{03215\ \textcolor{comment}{}}
\DoxyCodeLine{03216\ \textcolor{comment}{\ \ \ \ the\ CRL\ is\ not\ yet\ valid.\ Unused.}}
\DoxyCodeLine{03217\ \textcolor{comment}{}}
\DoxyCodeLine{03218\ \textcolor{comment}{12\ X509\_V\_ERR\_CRL\_HAS\_EXPIRED:\ CRL\ has\ expired}}
\DoxyCodeLine{03219\ \textcolor{comment}{}}
\DoxyCodeLine{03220\ \textcolor{comment}{\ \ \ \ the\ CRL\ has\ expired.\ Unused.}}
\DoxyCodeLine{03221\ \textcolor{comment}{}}
\DoxyCodeLine{03222\ \textcolor{comment}{13\ X509\_V\_ERR\_ERROR\_IN\_CERT\_NOT\_BEFORE\_FIELD:\ format\ error\ in}}
\DoxyCodeLine{03223\ \textcolor{comment}{certificate's\ notBefore\ field}}
\DoxyCodeLine{03224\ \textcolor{comment}{}}
\DoxyCodeLine{03225\ \textcolor{comment}{\ \ \ \ the\ certificate\ notBefore\ field\ contains\ an\ invalid\ time.}}
\DoxyCodeLine{03226\ \textcolor{comment}{}}
\DoxyCodeLine{03227\ \textcolor{comment}{14\ X509\_V\_ERR\_ERROR\_IN\_CERT\_NOT\_AFTER\_FIELD:\ format\ error\ in}}
\DoxyCodeLine{03228\ \textcolor{comment}{certificate's\ notAfter\ field}}
\DoxyCodeLine{03229\ \textcolor{comment}{}}
\DoxyCodeLine{03230\ \textcolor{comment}{\ \ \ \ the\ certificate\ notAfter\ field\ contains\ an\ invalid\ time.}}
\DoxyCodeLine{03231\ \textcolor{comment}{}}
\DoxyCodeLine{03232\ \textcolor{comment}{15\ X509\_V\_ERR\_ERROR\_IN\_CRL\_LAST\_UPDATE\_FIELD:\ format\ error\ in\ CRL's}}
\DoxyCodeLine{03233\ \textcolor{comment}{lastUpdate\ field}}
\DoxyCodeLine{03234\ \textcolor{comment}{}}
\DoxyCodeLine{03235\ \textcolor{comment}{\ \ \ \ the\ CRL\ lastUpdate\ field\ contains\ an\ invalid\ time.\ Unused.}}
\DoxyCodeLine{03236\ \textcolor{comment}{}}
\DoxyCodeLine{03237\ \textcolor{comment}{16\ X509\_V\_ERR\_ERROR\_IN\_CRL\_NEXT\_UPDATE\_FIELD:\ format\ error\ in\ CRL's}}
\DoxyCodeLine{03238\ \textcolor{comment}{nextUpdate\ field}}
\DoxyCodeLine{03239\ \textcolor{comment}{}}
\DoxyCodeLine{03240\ \textcolor{comment}{\ \ \ \ the\ CRL\ nextUpdate\ field\ contains\ an\ invalid\ time.\ Unused.}}
\DoxyCodeLine{03241\ \textcolor{comment}{}}
\DoxyCodeLine{03242\ \textcolor{comment}{17\ X509\_V\_ERR\_OUT\_OF\_MEM:\ out\ of\ memory}}
\DoxyCodeLine{03243\ \textcolor{comment}{}}
\DoxyCodeLine{03244\ \textcolor{comment}{\ \ \ \ an\ error\ occurred\ trying\ to\ allocate\ memory.\ This\ should\ never}}
\DoxyCodeLine{03245\ \textcolor{comment}{\ \ \ \ happen.}}
\DoxyCodeLine{03246\ \textcolor{comment}{}}
\DoxyCodeLine{03247\ \textcolor{comment}{18\ X509\_V\_ERR\_DEPTH\_ZERO\_SELF\_SIGNED\_CERT:\ self\ signed\ certificate}}
\DoxyCodeLine{03248\ \textcolor{comment}{}}
\DoxyCodeLine{03249\ \textcolor{comment}{\ \ \ \ the\ passed\ certificate\ is\ self\ signed\ and\ the\ same\ certificate}}
\DoxyCodeLine{03250\ \textcolor{comment}{\ \ \ \ cannot\ be\ found\ in\ the\ list\ of\ trusted\ certificates.}}
\DoxyCodeLine{03251\ \textcolor{comment}{}}
\DoxyCodeLine{03252\ \textcolor{comment}{19\ X509\_V\_ERR\_SELF\_SIGNED\_CERT\_IN\_CHAIN:\ self\ signed\ certificate\ in}}
\DoxyCodeLine{03253\ \textcolor{comment}{certificate\ chain}}
\DoxyCodeLine{03254\ \textcolor{comment}{}}
\DoxyCodeLine{03255\ \textcolor{comment}{\ \ \ \ the\ certificate\ chain\ could\ be\ built\ up\ using\ the\ untrusted}}
\DoxyCodeLine{03256\ \textcolor{comment}{\ \ \ \ certificates\ but\ the\ root\ could\ not\ be\ found\ locally.}}
\DoxyCodeLine{03257\ \textcolor{comment}{}}
\DoxyCodeLine{03258\ \textcolor{comment}{20\ X509\_V\_ERR\_UNABLE\_TO\_GET\_ISSUER\_CERT\_LOCALLY:\ unable\ to\ get\ local}}
\DoxyCodeLine{03259\ \textcolor{comment}{issuer\ certificate}}
\DoxyCodeLine{03260\ \textcolor{comment}{}}
\DoxyCodeLine{03261\ \textcolor{comment}{\ \ \ \ the\ issuer\ certificate\ of\ a\ locally\ looked\ up\ certificate\ could}}
\DoxyCodeLine{03262\ \textcolor{comment}{\ \ \ \ not\ be\ found.\ This\ normally\ means\ the\ list\ of\ trusted\ certificates}}
\DoxyCodeLine{03263\ \textcolor{comment}{\ \ \ \ is\ not\ complete.}}
\DoxyCodeLine{03264\ \textcolor{comment}{}}
\DoxyCodeLine{03265\ \textcolor{comment}{21\ X509\_V\_ERR\_UNABLE\_TO\_VERIFY\_LEAF\_SIGNATURE:\ unable\ to\ verify\ the}}
\DoxyCodeLine{03266\ \textcolor{comment}{first\ certificate}}
\DoxyCodeLine{03267\ \textcolor{comment}{}}
\DoxyCodeLine{03268\ \textcolor{comment}{\ \ \ \ no\ signatures\ could\ be\ verified\ because\ the\ chain\ contains\ only}}
\DoxyCodeLine{03269\ \textcolor{comment}{\ \ \ \ one\ certificate\ and\ it\ is\ not\ self\ signed.}}
\DoxyCodeLine{03270\ \textcolor{comment}{}}
\DoxyCodeLine{03271\ \textcolor{comment}{22\ X509\_V\_ERR\_CERT\_CHAIN\_TOO\_LONG:\ certificate\ chain\ too\ long}}
\DoxyCodeLine{03272\ \textcolor{comment}{}}
\DoxyCodeLine{03273\ \textcolor{comment}{\ \ \ \ the\ certificate\ chain\ length\ is\ greater\ than\ the\ supplied\ maximum}}
\DoxyCodeLine{03274\ \textcolor{comment}{\ \ \ \ depth.\ Unused.}}
\DoxyCodeLine{03275\ \textcolor{comment}{}}
\DoxyCodeLine{03276\ \textcolor{comment}{23\ X509\_V\_ERR\_CERT\_REVOKED:\ certificate\ revoked}}
\DoxyCodeLine{03277\ \textcolor{comment}{}}
\DoxyCodeLine{03278\ \textcolor{comment}{\ \ \ \ the\ certificate\ has\ been\ revoked.\ Unused.}}
\DoxyCodeLine{03279\ \textcolor{comment}{}}
\DoxyCodeLine{03280\ \textcolor{comment}{24\ X509\_V\_ERR\_INVALID\_CA:\ invalid\ CA\ certificate}}
\DoxyCodeLine{03281\ \textcolor{comment}{}}
\DoxyCodeLine{03282\ \textcolor{comment}{\ \ \ \ a\ CA\ certificate\ is\ invalid.\ Either\ it\ is\ not\ a\ CA\ or\ its}}
\DoxyCodeLine{03283\ \textcolor{comment}{\ \ \ \ extensions\ are\ not\ consistent\ with\ the\ supplied\ purpose.}}
\DoxyCodeLine{03284\ \textcolor{comment}{}}
\DoxyCodeLine{03285\ \textcolor{comment}{25\ X509\_V\_ERR\_PATH\_LENGTH\_EXCEEDED:\ path\ length\ constraint\ exceeded}}
\DoxyCodeLine{03286\ \textcolor{comment}{}}
\DoxyCodeLine{03287\ \textcolor{comment}{\ \ \ \ the\ basicConstraints\ pathlength\ parameter\ has\ been\ exceeded.}}
\DoxyCodeLine{03288\ \textcolor{comment}{}}
\DoxyCodeLine{03289\ \textcolor{comment}{26\ X509\_V\_ERR\_INVALID\_PURPOSE:\ unsupported\ certificate\ purpose}}
\DoxyCodeLine{03290\ \textcolor{comment}{}}
\DoxyCodeLine{03291\ \textcolor{comment}{\ \ \ \ the\ supplied\ certificate\ cannot\ be\ used\ for\ the\ specified\ purpose.}}
\DoxyCodeLine{03292\ \textcolor{comment}{}}
\DoxyCodeLine{03293\ \textcolor{comment}{27\ X509\_V\_ERR\_CERT\_UNTRUSTED:\ certificate\ not\ trusted}}
\DoxyCodeLine{03294\ \textcolor{comment}{}}
\DoxyCodeLine{03295\ \textcolor{comment}{\ \ \ \ the\ root\ CA\ is\ not\ marked\ as\ trusted\ for\ the\ specified\ purpose.}}
\DoxyCodeLine{03296\ \textcolor{comment}{}}
\DoxyCodeLine{03297\ \textcolor{comment}{28\ X509\_V\_ERR\_CERT\_REJECTED:\ certificate\ rejected}}
\DoxyCodeLine{03298\ \textcolor{comment}{}}
\DoxyCodeLine{03299\ \textcolor{comment}{\ \ \ \ the\ root\ CA\ is\ marked\ to\ reject\ the\ specified\ purpose.}}
\DoxyCodeLine{03300\ \textcolor{comment}{}}
\DoxyCodeLine{03301\ \textcolor{comment}{29\ X509\_V\_ERR\_SUBJECT\_ISSUER\_MISMATCH:\ subject\ issuer\ mismatch}}
\DoxyCodeLine{03302\ \textcolor{comment}{}}
\DoxyCodeLine{03303\ \textcolor{comment}{\ \ \ \ the\ current\ candidate\ issuer\ certificate\ was\ rejected\ because\ its}}
\DoxyCodeLine{03304\ \textcolor{comment}{\ \ \ \ subject\ name\ did\ not\ match\ the\ issuer\ name\ of\ the\ current}}
\DoxyCodeLine{03305\ \textcolor{comment}{\ \ \ \ certificate.\ Only\ displayed\ when\ the\ -\/issuer\_checks\ option\ is\ set.}}
\DoxyCodeLine{03306\ \textcolor{comment}{}}
\DoxyCodeLine{03307\ \textcolor{comment}{30\ X509\_V\_ERR\_AKID\_SKID\_MISMATCH:\ authority\ and\ subject\ key\ identifier}}
\DoxyCodeLine{03308\ \textcolor{comment}{mismatch}}
\DoxyCodeLine{03309\ \textcolor{comment}{}}
\DoxyCodeLine{03310\ \textcolor{comment}{\ \ \ \ the\ current\ candidate\ issuer\ certificate\ was\ rejected\ because\ its}}
\DoxyCodeLine{03311\ \textcolor{comment}{\ \ \ \ subject\ key\ identifier\ was\ present\ and\ did\ not\ match\ the\ authority}}
\DoxyCodeLine{03312\ \textcolor{comment}{\ \ \ \ key\ identifier\ current\ certificate.\ Only\ displayed\ when\ the}}
\DoxyCodeLine{03313\ \textcolor{comment}{\ \ \ \ -\/issuer\_checks\ option\ is\ set.}}
\DoxyCodeLine{03314\ \textcolor{comment}{}}
\DoxyCodeLine{03315\ \textcolor{comment}{31\ X509\_V\_ERR\_AKID\_ISSUER\_SERIAL\_MISMATCH:\ authority\ and\ issuer\ serial}}
\DoxyCodeLine{03316\ \textcolor{comment}{number\ mismatch}}
\DoxyCodeLine{03317\ \textcolor{comment}{}}
\DoxyCodeLine{03318\ \textcolor{comment}{\ \ \ \ the\ current\ candidate\ issuer\ certificate\ was\ rejected\ because\ its}}
\DoxyCodeLine{03319\ \textcolor{comment}{\ \ \ \ issuer\ name\ and\ serial\ number\ was\ present\ and\ did\ not\ match\ the}}
\DoxyCodeLine{03320\ \textcolor{comment}{\ \ \ \ authority\ key\ identifier\ of\ the\ current\ certificate.\ Only}}
\DoxyCodeLine{03321\ \textcolor{comment}{\ \ \ \ displayed\ when\ the\ -\/issuer\_checks\ option\ is\ set.}}
\DoxyCodeLine{03322\ \textcolor{comment}{}}
\DoxyCodeLine{03323\ \textcolor{comment}{32\ X509\_V\_ERR\_KEYUSAGE\_NO\_CERTSIGN:key\ usage\ does\ not\ include}}
\DoxyCodeLine{03324\ \textcolor{comment}{certificate\ signing}}
\DoxyCodeLine{03325\ \textcolor{comment}{}}
\DoxyCodeLine{03326\ \textcolor{comment}{\ \ \ \ the\ current\ candidate\ issuer\ certificate\ was\ rejected\ because\ its}}
\DoxyCodeLine{03327\ \textcolor{comment}{\ \ \ \ keyUsage\ extension\ does\ not\ permit\ certificate\ signing.}}
\DoxyCodeLine{03328\ \textcolor{comment}{}}
\DoxyCodeLine{03329\ \textcolor{comment}{50\ X509\_V\_ERR\_APPLICATION\_VERIFICATION:\ application\ verification\ failure}}
\DoxyCodeLine{03330\ \textcolor{comment}{}}
\DoxyCodeLine{03331\ \textcolor{comment}{\ \ \ \ an\ application\ specific\ error.\ Unused.}}
\DoxyCodeLine{03332\ \textcolor{comment}{}}
\DoxyCodeLine{03333\ \textcolor{comment}{*/}}
\DoxyCodeLine{03334\ }
\DoxyCodeLine{03350\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03351\ check\_preapproved\_server\_certificate(X509\ *cert,\ \textcolor{keywordtype}{bool}\ \&cert\_preapproved,}
\DoxyCodeLine{03352\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \&cert\_name\_preapproved)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{03353\ \ \ \textcolor{keywordflow}{return}\ \_client-\/>check\_preapproved\_server\_certificate(\_request.get\_url(),}
\DoxyCodeLine{03354\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cert,\ cert\_preapproved,}
\DoxyCodeLine{03355\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cert\_name\_preapproved);}
\DoxyCodeLine{03356\ \}}
\DoxyCodeLine{03357\ }
\DoxyCodeLine{03362\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{03363\ validate\_server\_name(X509\ *cert)\ \{}
\DoxyCodeLine{03364\ \ \ \textcolor{keywordtype}{string}\ hostname\ =\ \_request.get\_url().get\_server();}
\DoxyCodeLine{03365\ }
\DoxyCodeLine{03366\ \ \ vector\_string\ cert\_names;}
\DoxyCodeLine{03367\ }
\DoxyCodeLine{03368\ \ \ \textcolor{comment}{//\ According\ to\ RFC\ 2818,\ we\ should\ check\ the\ DNS\ name(s)\ in\ the}}
\DoxyCodeLine{03369\ \ \ \textcolor{comment}{//\ subjectAltName\ extension\ first,\ if\ that\ extension\ exists.}}
\DoxyCodeLine{03370\ \ \ STACK\_OF(GENERAL\_NAME)\ *subject\_alt\_names\ =}
\DoxyCodeLine{03371\ \ \ \ \ (STACK\_OF(GENERAL\_NAME)\ *)X509\_get\_ext\_d2i(cert,\ NID\_subject\_alt\_name,\ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{03372\ \ \ \textcolor{keywordflow}{if}\ (subject\_alt\_names\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03373\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_alts\ =\ sk\_GENERAL\_NAME\_num(subject\_alt\_names);}
\DoxyCodeLine{03374\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_alts;\ ++i)\ \{}
\DoxyCodeLine{03375\ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ the\ ith\ alt\ name.}}
\DoxyCodeLine{03376\ \ \ \ \ \ \ \textcolor{keyword}{const}\ GENERAL\_NAME\ *alt\_name\ =}
\DoxyCodeLine{03377\ \ \ \ \ \ \ \ \ sk\_GENERAL\_NAME\_value(subject\_alt\_names,\ i);}
\DoxyCodeLine{03378\ }
\DoxyCodeLine{03379\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (alt\_name-\/>type\ ==\ GEN\_DNS)\ \{}
\DoxyCodeLine{03380\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *buffer\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03381\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ len\ =\ ASN1\_STRING\_to\_UTF8((\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}**)\&buffer,}
\DoxyCodeLine{03382\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ alt\_name-\/>d.ia5);}
\DoxyCodeLine{03383\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (len\ >\ 0)\ \{}
\DoxyCodeLine{03384\ \ \ \ \ \ \ \ \ \ \ cert\_names.push\_back(\textcolor{keywordtype}{string}(buffer,\ len));}
\DoxyCodeLine{03385\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03386\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (buffer\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03387\ \ \ \ \ \ \ \ \ \ \ OPENSSL\_free(buffer);}
\DoxyCodeLine{03388\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{03389\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03390\ \ \ \ \ \}}
\DoxyCodeLine{03391\ \ \ \}}
\DoxyCodeLine{03392\ }
\DoxyCodeLine{03393\ \ \ \textcolor{keywordflow}{if}\ (cert\_names.empty())\ \{}
\DoxyCodeLine{03394\ \ \ \ \ \textcolor{comment}{//\ If\ there\ were\ no\ DNS\ names,\ use\ the\ common\ name\ instead.}}
\DoxyCodeLine{03395\ }
\DoxyCodeLine{03396\ \ \ \ \ X509\_NAME\ *xname\ =\ X509\_get\_subject\_name(cert);}
\DoxyCodeLine{03397\ \ \ \ \ \textcolor{keywordflow}{if}\ (xname\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03398\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ common\_name\ =\ get\_x509\_name\_component(xname,\ NID\_commonName);}
\DoxyCodeLine{03399\ \ \ \ \ \ \ cert\_names.push\_back(common\_name);}
\DoxyCodeLine{03400\ \ \ \ \ \}}
\DoxyCodeLine{03401\ \ \ \}}
\DoxyCodeLine{03402\ }
\DoxyCodeLine{03403\ \ \ \textcolor{keywordflow}{if}\ (cert\_names.empty())\ \{}
\DoxyCodeLine{03404\ \ \ \ \ downloader\_cat.info()}
\DoxyCodeLine{03405\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03406\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Server\ certificate\ from\ "{}}\ <<\ hostname}
\DoxyCodeLine{03407\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ provides\ no\ name.\(\backslash\)n"{}};}
\DoxyCodeLine{03408\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{03409\ \ \ \}}
\DoxyCodeLine{03410\ }
\DoxyCodeLine{03411\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{03412\ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{03413\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03414\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Server\ certificate\ from\ "{}}\ <<\ hostname}
\DoxyCodeLine{03415\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ provides\ name(s):"{}};}
\DoxyCodeLine{03416\ \ \ \ \ vector\_string::const\_iterator\ si;}
\DoxyCodeLine{03417\ \ \ \ \ \textcolor{keywordflow}{for}\ (si\ =\ cert\_names.begin();\ si\ !=\ cert\_names.end();\ ++si)\ \{}
\DoxyCodeLine{03418\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cert\_name\ =\ (*si);}
\DoxyCodeLine{03419\ \ \ \ \ \ \ downloader\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03420\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ cert\_name;}
\DoxyCodeLine{03421\ \ \ \ \ \}}
\DoxyCodeLine{03422\ \ \ \ \ downloader\_cat.debug(\textcolor{keyword}{false})}
\DoxyCodeLine{03423\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03424\ \ \ \}}
\DoxyCodeLine{03425\ }
\DoxyCodeLine{03426\ \ \ \textcolor{comment}{//\ Now\ validate\ the\ names\ we\ found.\ \ If\ any\ of\ them\ matches,\ the\ cert}}
\DoxyCodeLine{03427\ \ \ \textcolor{comment}{//\ matches.}}
\DoxyCodeLine{03428\ \ \ vector\_string::const\_iterator\ si;}
\DoxyCodeLine{03429\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ cert\_names.begin();\ si\ !=\ cert\_names.end();\ ++si)\ \{}
\DoxyCodeLine{03430\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cert\_name\ =\ (*si);}
\DoxyCodeLine{03431\ }
\DoxyCodeLine{03432\ \ \ \ \ \textcolor{keywordflow}{if}\ (match\_cert\_name(cert\_name,\ hostname))\ \{}
\DoxyCodeLine{03433\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{03434\ \ \ \ \ \}}
\DoxyCodeLine{03435\ \ \ \}}
\DoxyCodeLine{03436\ }
\DoxyCodeLine{03437\ \ \ downloader\_cat.info()}
\DoxyCodeLine{03438\ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03439\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Server\ certificate\ from\ "{}}\ <<\ hostname}
\DoxyCodeLine{03440\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ provides\ wrong\ name(s):"{}};}
\DoxyCodeLine{03441\ \ \ \textcolor{keywordflow}{for}\ (si\ =\ cert\_names.begin();\ si\ !=\ cert\_names.end();\ ++si)\ \{}
\DoxyCodeLine{03442\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cert\_name\ =\ (*si);}
\DoxyCodeLine{03443\ \ \ \ \ downloader\_cat.info(\textcolor{keyword}{false})}
\DoxyCodeLine{03444\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ cert\_name;}
\DoxyCodeLine{03445\ \ \ \}}
\DoxyCodeLine{03446\ \ \ downloader\_cat.info(\textcolor{keyword}{false})}
\DoxyCodeLine{03447\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03448\ }
\DoxyCodeLine{03449\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{03450\ \}}
\DoxyCodeLine{03451\ }
\DoxyCodeLine{03456\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{03457\ match\_cert\_name(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&cert\_name,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&hostname)\ \{}
\DoxyCodeLine{03458\ \ \ \textcolor{comment}{//\ We\ use\ GlobPattern\ to\ match\ the\ name.\ \ This\ isn't\ quite\ consistent\ with}}
\DoxyCodeLine{03459\ \ \ \textcolor{comment}{//\ RFC2818,\ since\ it\ also\ accepts\ additional\ wildcard\ characters\ like\ "{}?"{}}}
\DoxyCodeLine{03460\ \ \ \textcolor{comment}{//\ and\ "{}[]"{},\ but\ I\ think\ it's\ close\ enough.}}
\DoxyCodeLine{03461\ }
\DoxyCodeLine{03462\ \ \ \mbox{\hyperlink{classGlobPattern}{GlobPattern}}\ pattern(cert\_name);}
\DoxyCodeLine{03463\ \ \ pattern.set\_case\_sensitive(\textcolor{keyword}{false});}
\DoxyCodeLine{03464\ \ \ pattern.set\_nomatch\_chars(\textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{03465\ \ \ \textcolor{keywordflow}{return}\ pattern.matches(hostname);}
\DoxyCodeLine{03466\ \}}
\DoxyCodeLine{03467\ }
\DoxyCodeLine{03472\ \textcolor{keywordtype}{string}\ HTTPChannel::}
\DoxyCodeLine{03473\ get\_x509\_name\_component(X509\_NAME\ *name,\ \textcolor{keywordtype}{int}\ nid)\ \{}
\DoxyCodeLine{03474\ \ \ ASN1\_OBJECT\ *obj\ =\ OBJ\_nid2obj(nid);}
\DoxyCodeLine{03475\ }
\DoxyCodeLine{03476\ \ \ \textcolor{keywordflow}{if}\ (obj\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03477\ \ \ \ \ \textcolor{comment}{//\ Unknown\ nid.\ \ See\ opensslobjects.h.}}
\DoxyCodeLine{03478\ \ \ \ \ \textcolor{keywordflow}{return}\ string();}
\DoxyCodeLine{03479\ \ \ \}}
\DoxyCodeLine{03480\ }
\DoxyCodeLine{03481\ \ \ \textcolor{keywordtype}{int}\ i\ =\ X509\_NAME\_get\_index\_by\_OBJ(name,\ obj,\ -\/1);}
\DoxyCodeLine{03482\ \ \ \textcolor{keywordflow}{if}\ (i\ <\ 0)\ \{}
\DoxyCodeLine{03483\ \ \ \ \ \textcolor{keywordflow}{return}\ string();}
\DoxyCodeLine{03484\ \ \ \}}
\DoxyCodeLine{03485\ }
\DoxyCodeLine{03486\ \ \ ASN1\_STRING\ *data\ =\ X509\_NAME\_ENTRY\_get\_data(X509\_NAME\_get\_entry(name,\ i));}
\DoxyCodeLine{03487\ \ \ \textcolor{keywordflow}{return}\ string((\textcolor{keywordtype}{char}\ *)data-\/>data,\ data-\/>length);}
\DoxyCodeLine{03488\ \}}
\DoxyCodeLine{03489\ }
\DoxyCodeLine{03495\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03496\ make\_header()\ \{}
\DoxyCodeLine{03497\ \ \ \_proxy\_auth\ =\ \_client-\/>select\_auth(\_proxy,\ \textcolor{keyword}{true},\ \_proxy\_realm);}
\DoxyCodeLine{03498\ \ \ \_proxy\_username\ =\ string();}
\DoxyCodeLine{03499\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_auth\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03500\ \ \ \ \ \_proxy\_realm\ =\ \_proxy\_auth-\/>get\_realm();}
\DoxyCodeLine{03501\ \ \ \ \ \_proxy\_username\ =\ \_client-\/>select\_username(\_proxy,\ \textcolor{keyword}{true},\ \_proxy\_realm);}
\DoxyCodeLine{03502\ \ \ \}}
\DoxyCodeLine{03503\ }
\DoxyCodeLine{03504\ \ \ \textcolor{keywordflow}{if}\ (\_method\ ==\ HTTPEnum::M\_connect)\ \{}
\DoxyCodeLine{03505\ \ \ \ \ \textcolor{comment}{//\ This\ method\ doesn't\ require\ an\ HTTP\ header\ at\ all;\ we'll\ just\ open\ a}}
\DoxyCodeLine{03506\ \ \ \ \ \textcolor{comment}{//\ plain\ connection.\ \ (Except\ when\ we're\ using\ a\ proxy;\ but\ in\ that\ case,}}
\DoxyCodeLine{03507\ \ \ \ \ \textcolor{comment}{//\ it's\ the\ proxy\_header\ we'll\ need,\ not\ the\ regular\ HTTP\ header.)}}
\DoxyCodeLine{03508\ \ \ \ \ \_header\ =\ string();}
\DoxyCodeLine{03509\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{03510\ \ \ \}}
\DoxyCodeLine{03511\ }
\DoxyCodeLine{03512\ \ \ \_www\_auth\ =\ \_client-\/>select\_auth(\_request.get\_url(),\ \textcolor{keyword}{false},\ \_www\_realm);}
\DoxyCodeLine{03513\ \ \ \_www\_username\ =\ string();}
\DoxyCodeLine{03514\ \ \ \textcolor{keywordflow}{if}\ (\_www\_auth\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03515\ \ \ \ \ \_www\_realm\ =\ \_www\_auth-\/>get\_realm();}
\DoxyCodeLine{03516\ \ \ \ \ \_www\_username\ =\ \_client-\/>select\_username(\_request.get\_url(),\ \textcolor{keyword}{false},\ \_www\_realm);}
\DoxyCodeLine{03517\ \ \ \}}
\DoxyCodeLine{03518\ }
\DoxyCodeLine{03519\ \ \ \textcolor{keywordtype}{string}\ request\_path;}
\DoxyCodeLine{03520\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_serves\_document)\ \{}
\DoxyCodeLine{03521\ \ \ \ \ \textcolor{comment}{//\ If\ we'll\ be\ asking\ the\ proxy\ for\ the\ document,\ we\ need\ its\ full\ URL-\/-\/}}
\DoxyCodeLine{03522\ \ \ \ \ \textcolor{comment}{//\ but\ we\ omit\ the\ username,\ which\ is\ information\ just\ for\ us.}}
\DoxyCodeLine{03523\ \ \ \ \ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ url\_no\_username\ =\ \_request.get\_url();}
\DoxyCodeLine{03524\ \ \ \ \ url\_no\_username.set\_username(\textcolor{keywordtype}{string}());}
\DoxyCodeLine{03525\ \ \ \ \ request\_path\ =\ url\_no\_username.get\_url();}
\DoxyCodeLine{03526\ }
\DoxyCodeLine{03527\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03528\ \ \ \ \ \textcolor{comment}{//\ If\ we'll\ be\ asking\ the\ server\ directly\ for\ the\ document,\ we\ just\ want}}
\DoxyCodeLine{03529\ \ \ \ \ \textcolor{comment}{//\ its\ path\ relative\ to\ the\ server.}}
\DoxyCodeLine{03530\ \ \ \ \ request\_path\ =\ \_request.get\_url().get\_path\_and\_query();}
\DoxyCodeLine{03531\ \ \ \}}
\DoxyCodeLine{03532\ }
\DoxyCodeLine{03533\ \ \ \textcolor{comment}{//\ HTTP\ syntax\ always\ requires\ something\ in\ the\ request\ path.\ \ If\ it\ is}}
\DoxyCodeLine{03534\ \ \ \textcolor{comment}{//\ empty,\ put\ in\ a\ star\ as\ a\ placeholder\ (OPTIONS,\ for\ instance,\ uses\ this).}}
\DoxyCodeLine{03535\ \ \ \textcolor{keywordflow}{if}\ (request\_path.empty())\ \{}
\DoxyCodeLine{03536\ \ \ \ \ request\_path\ =\ \textcolor{stringliteral}{"{}*"{}};}
\DoxyCodeLine{03537\ \ \ \}}
\DoxyCodeLine{03538\ }
\DoxyCodeLine{03539\ \ \ ostringstream\ stream;}
\DoxyCodeLine{03540\ }
\DoxyCodeLine{03541\ \ \ stream}
\DoxyCodeLine{03542\ \ \ \ \ <<\ \_method\ <<\ \textcolor{stringliteral}{"{}\ "{}}\ <<\ request\_path\ <<\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{03543\ \ \ \ \ <<\ \_client-\/>get\_http\_version\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03544\ }
\DoxyCodeLine{03545\ \ \ \textcolor{keywordflow}{if}\ (\_client-\/>get\_http\_version()\ >=\ HTTPEnum::HV\_11)\ \{}
\DoxyCodeLine{03546\ }
\DoxyCodeLine{03547\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.get\_url().has\_port()\ \&\&\ \_request.get\_url().is\_default\_port())\ \{}
\DoxyCodeLine{03548\ \ \ \ \ \ \ \textcolor{comment}{//\ It\ appears\ that\ some\ servers\ (notably\ gstatic.com)\ might\ return\ a\ 404}}
\DoxyCodeLine{03549\ \ \ \ \ \ \ \textcolor{comment}{//\ if\ you\ include\ an\ explicit\ port\ number\ in\ with\ the\ Host:\ header,\ even}}
\DoxyCodeLine{03550\ \ \ \ \ \ \ \textcolor{comment}{//\ if\ it\ is\ the\ default\ port.\ \ So,\ don't\ include\ the\ port\ number\ unless}}
\DoxyCodeLine{03551\ \ \ \ \ \ \ \textcolor{comment}{//\ we\ need\ to.}}
\DoxyCodeLine{03552\ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ server\ =\ \_request.get\_url().get\_server();}
\DoxyCodeLine{03553\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (server.find(\textcolor{charliteral}{':'})\ !=\ string::npos)\ \{}
\DoxyCodeLine{03554\ \ \ \ \ \ \ \ \ stream\ <<\ \textcolor{stringliteral}{"{}Host:\ ["{}}\ <<\ server\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{03555\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03556\ \ \ \ \ \ \ \ \ stream\ <<\ \textcolor{stringliteral}{"{}Host:\ "{}}\ <<\ server;}
\DoxyCodeLine{03557\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03558\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03559\ \ \ \ \ \ \ stream\ <<\ \textcolor{stringliteral}{"{}Host:\ "{}}\ <<\ \_request.get\_url().get\_server\_and\_port();}
\DoxyCodeLine{03560\ \ \ \ \ \}}
\DoxyCodeLine{03561\ \ \ \ \ stream\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03562\ \ \ \ \ \textcolor{keywordflow}{if}\ (!get\_persistent\_connection())\ \{}
\DoxyCodeLine{03563\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03564\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Connection:\ close\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03565\ \ \ \ \ \}}
\DoxyCodeLine{03566\ \ \ \}}
\DoxyCodeLine{03567\ }
\DoxyCodeLine{03568\ \ \ \textcolor{keywordflow}{if}\ (\_last\_byte\_requested\ !=\ 0)\ \{}
\DoxyCodeLine{03569\ \ \ \ \ stream}
\DoxyCodeLine{03570\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Range:\ bytes="{}}\ <<\ \_first\_byte\_requested\ <<\ \textcolor{stringliteral}{"{}-\/"{}}}
\DoxyCodeLine{03571\ \ \ \ \ \ \ <<\ \_last\_byte\_requested\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03572\ }
\DoxyCodeLine{03573\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_first\_byte\_requested\ !=\ 0)\ \{}
\DoxyCodeLine{03574\ \ \ \ \ stream}
\DoxyCodeLine{03575\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Range:\ bytes="{}}\ <<\ \_first\_byte\_requested\ <<\ \textcolor{stringliteral}{"{}-\/\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03576\ \ \ \}}
\DoxyCodeLine{03577\ }
\DoxyCodeLine{03578\ \ \ \textcolor{keywordflow}{switch}\ (\_request.get\_request\_mode())\ \{}
\DoxyCodeLine{03579\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::RM\_any:}
\DoxyCodeLine{03580\ \ \ \ \ \textcolor{comment}{//\ No\ particular\ request;\ give\ us\ any\ document\ that\ matches\ the\ URL.}}
\DoxyCodeLine{03581\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_first\_byte\_requested\ !=\ 0)\ \{}
\DoxyCodeLine{03582\ \ \ \ \ \ \ \textcolor{comment}{//\ Unless\ we're\ requesting\ a\ subrange,\ in\ which\ case\ if\ the\ exact}}
\DoxyCodeLine{03583\ \ \ \ \ \ \ \textcolor{comment}{//\ document\ matches,\ retrieve\ the\ subrange\ indicated;\ otherwise,}}
\DoxyCodeLine{03584\ \ \ \ \ \ \ \textcolor{comment}{//\ retrieve\ the\ entire\ document.}}
\DoxyCodeLine{03585\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_tag())\ \{}
\DoxyCodeLine{03586\ \ \ \ \ \ \ \ \ stream}
\DoxyCodeLine{03587\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Range:\ "{}}\ <<\ \_request.get\_tag().get\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03588\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\_request.has\_date())\ \{}
\DoxyCodeLine{03589\ \ \ \ \ \ \ \ \ stream}
\DoxyCodeLine{03590\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Range:\ "{}}\ <<\ \_request.get\_date().get\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03591\ \ \ \ \ \ \ \}}
\DoxyCodeLine{03592\ \ \ \ \ \}}
\DoxyCodeLine{03593\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03594\ }
\DoxyCodeLine{03595\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::RM\_equal:}
\DoxyCodeLine{03596\ \ \ \ \ \textcolor{comment}{//\ Give\ us\ only\ this\ particular\ version\ of\ the\ document,\ or\ nothing.}}
\DoxyCodeLine{03597\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_tag())\ \{}
\DoxyCodeLine{03598\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03599\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Match:\ "{}}\ <<\ \_request.get\_tag().get\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03600\ \ \ \ \ \}}
\DoxyCodeLine{03601\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_date())\ \{}
\DoxyCodeLine{03602\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03603\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Unmodified-\/Since:\ "{}}\ <<\ \_request.get\_date().get\_string()}
\DoxyCodeLine{03604\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03605\ \ \ \ \ \}}
\DoxyCodeLine{03606\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03607\ }
\DoxyCodeLine{03608\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::RM\_newer:}
\DoxyCodeLine{03609\ \ \ \ \ \textcolor{comment}{//\ Give\ us\ anything\ newer\ than\ this\ document,\ or\ nothing.}}
\DoxyCodeLine{03610\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_tag())\ \{}
\DoxyCodeLine{03611\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03612\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/None-\/Match:\ "{}}\ <<\ \_request.get\_tag().get\_string()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03613\ \ \ \ \ \}}
\DoxyCodeLine{03614\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_date())\ \{}
\DoxyCodeLine{03615\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03616\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Modified-\/Since:\ "{}}\ <<\ \_request.get\_date().get\_string()}
\DoxyCodeLine{03617\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03618\ \ \ \ \ \}}
\DoxyCodeLine{03619\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03620\ }
\DoxyCodeLine{03621\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::RM\_equal\_or\_newer:}
\DoxyCodeLine{03622\ \ \ \ \ \textcolor{comment}{//\ Just\ don't\ give\ us\ anything\ older.}}
\DoxyCodeLine{03623\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_request.has\_date())\ \{}
\DoxyCodeLine{03624\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ little\ unreliable:\ we\ ask\ for\ any\ document\ that's\ been}}
\DoxyCodeLine{03625\ \ \ \ \ \ \ \textcolor{comment}{//\ modified\ since\ one\ second\ before\ our\ last-\/modified-\/date.\ \ Who\ knows}}
\DoxyCodeLine{03626\ \ \ \ \ \ \ \textcolor{comment}{//\ whether\ the\ server\ will\ honor\ this\ properly.}}
\DoxyCodeLine{03627\ \ \ \ \ \ \ stream}
\DoxyCodeLine{03628\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}If-\/Modified-\/Since:\ "{}}\ <<\ (\_request.get\_date()\ -\/\ 1).get\_string()}
\DoxyCodeLine{03629\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03630\ \ \ \ \ \}}
\DoxyCodeLine{03631\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03632\ \ \ \}}
\DoxyCodeLine{03633\ }
\DoxyCodeLine{03634\ \ \ \textcolor{keywordflow}{switch}\ (\_request.get\_cache\_control())\ \{}
\DoxyCodeLine{03635\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::CC\_allow\_cache:}
\DoxyCodeLine{03636\ \ \ \ \ \textcolor{comment}{//\ Normal,\ caching\ behavior.}}
\DoxyCodeLine{03637\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03638\ }
\DoxyCodeLine{03639\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::CC\_revalidate:}
\DoxyCodeLine{03640\ \ \ \ \ \textcolor{comment}{//\ Request\ the\ server\ to\ revalidate\ its\ cache\ before\ returning\ it.}}
\DoxyCodeLine{03641\ \ \ \ \ stream}
\DoxyCodeLine{03642\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cache-\/Control:\ max-\/age=0\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03643\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03644\ }
\DoxyCodeLine{03645\ \ \ \textcolor{keywordflow}{case}\ DocumentSpec::CC\_no\_cache:}
\DoxyCodeLine{03646\ \ \ \ \ \textcolor{comment}{//\ Request\ the\ server\ to\ get\ a\ fresh\ copy\ regardless\ of\ its\ cache.}}
\DoxyCodeLine{03647\ \ \ \ \ stream}
\DoxyCodeLine{03648\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Cache-\/Control:\ no-\/cache\(\backslash\)r\(\backslash\)n"{}}}
\DoxyCodeLine{03649\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Pragma:\ no-\/cache\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03650\ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{03651\ \ \ \}}
\DoxyCodeLine{03652\ }
\DoxyCodeLine{03653\ \ \ \_client-\/>send\_cookies(stream,\ \_request.get\_url());}
\DoxyCodeLine{03654\ }
\DoxyCodeLine{03655\ \ \ \textcolor{keywordflow}{if}\ (!\_body.empty())\ \{}
\DoxyCodeLine{03656\ \ \ \ \ stream}
\DoxyCodeLine{03657\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Content-\/Type:\ "{}}\ <<\ \_content\_type\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}}}
\DoxyCodeLine{03658\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Content-\/Length:\ "{}}\ <<\ \_body.length()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03659\ \ \ \}}
\DoxyCodeLine{03660\ }
\DoxyCodeLine{03661\ \textcolor{preprocessor}{\#ifdef\ HAVE\_ZLIB}}
\DoxyCodeLine{03662\ \ \ stream}
\DoxyCodeLine{03663\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Accept-\/Encoding:\ gzip,\ deflate,\ identity\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03664\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{03665\ \ \ stream}
\DoxyCodeLine{03666\ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Accept-\/Encoding:\ identity\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03667\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{03668\ }
\DoxyCodeLine{03669\ \ \ \_header\ =\ stream.str();}
\DoxyCodeLine{03670\ \}}
\DoxyCodeLine{03671\ }
\DoxyCodeLine{03678\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03679\ make\_proxy\_request\_text()\ \{}
\DoxyCodeLine{03680\ \ \ \_proxy\_request\_text\ =\ \_proxy\_header;}
\DoxyCodeLine{03681\ }
\DoxyCodeLine{03682\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_auth\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ !\_proxy\_username.empty())\ \{}
\DoxyCodeLine{03683\ \ \ \ \ \_proxy\_request\_text\ +=\ \textcolor{stringliteral}{"{}Proxy-\/Authorization:\ "{}};}
\DoxyCodeLine{03684\ \ \ \ \ \_proxy\_request\_text\ +=}
\DoxyCodeLine{03685\ \ \ \ \ \ \ \_proxy\_auth-\/>generate(HTTPEnum::M\_connect,\ \_request.get\_url().get\_server\_and\_port(),}
\DoxyCodeLine{03686\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_proxy\_username,\ \_body);}
\DoxyCodeLine{03687\ \ \ \ \ \_proxy\_request\_text\ +=\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03688\ \ \ \}}
\DoxyCodeLine{03689\ }
\DoxyCodeLine{03690\ \ \ \_proxy\_request\_text\ +=\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03691\ \}}
\DoxyCodeLine{03692\ }
\DoxyCodeLine{03697\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03698\ make\_request\_text()\ \{}
\DoxyCodeLine{03699\ \ \ \_request\_text\ =\ \_header;}
\DoxyCodeLine{03700\ }
\DoxyCodeLine{03701\ \ \ \textcolor{keywordflow}{if}\ (\_proxy\_serves\_document\ \&\&}
\DoxyCodeLine{03702\ \ \ \ \ \ \ \_proxy\_auth\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ !\_proxy\_username.empty())\ \{}
\DoxyCodeLine{03703\ \ \ \ \ \_request\_text\ +=\ \textcolor{stringliteral}{"{}Proxy-\/Authorization:\ "{}};}
\DoxyCodeLine{03704\ \ \ \ \ \_request\_text\ +=}
\DoxyCodeLine{03705\ \ \ \ \ \ \ \_proxy\_auth-\/>generate(\_method,\ \_request.get\_url().get\_url(),\ \_proxy\_username,\ \_body);}
\DoxyCodeLine{03706\ \ \ \ \ \_request\_text\ +=\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03707\ \ \ \}}
\DoxyCodeLine{03708\ }
\DoxyCodeLine{03709\ \ \ \textcolor{keywordflow}{if}\ (\_www\_auth\ !=\ \textcolor{keyword}{nullptr}\ \&\&\ !\_www\_username.empty())\ \{}
\DoxyCodeLine{03710\ \ \ \ \ \textcolor{keywordtype}{string}\ authorization\ =}
\DoxyCodeLine{03711\ \ \ \ \ \_request\_text\ +=\ \textcolor{stringliteral}{"{}Authorization:\ "{}};}
\DoxyCodeLine{03712\ \ \ \ \ \_request\_text\ +=}
\DoxyCodeLine{03713\ \ \ \ \ \ \ \_www\_auth-\/>generate(\_method,\ \_request.get\_url().get\_path\_and\_query(),\ \_www\_username,\ \_body);}
\DoxyCodeLine{03714\ \ \ \ \ \_request\_text\ +=\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03715\ \ \ \}}
\DoxyCodeLine{03716\ }
\DoxyCodeLine{03717\ \ \ \_request\_text\ +=\ \_send\_extra\_headers;}
\DoxyCodeLine{03718\ \ \ \_request\_text\ +=\ \textcolor{stringliteral}{"{}\(\backslash\)r\(\backslash\)n"{}};}
\DoxyCodeLine{03719\ \ \ \_request\_text\ +=\ \_body;}
\DoxyCodeLine{03720\ \}}
\DoxyCodeLine{03721\ }
\DoxyCodeLine{03726\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03727\ reset\_url(\textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&old\_url,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classURLSpec}{URLSpec}}\ \&new\_url)\ \{}
\DoxyCodeLine{03728\ \ \ \textcolor{comment}{//\ If\ we\ change\ between\ http\ and\ https,\ we\ have\ to\ reset\ the\ connection}}
\DoxyCodeLine{03729\ \ \ \textcolor{comment}{//\ regardless\ of\ proxy.\ \ Otherwise,\ we\ have\ to\ drop\ the\ connection\ if\ the}}
\DoxyCodeLine{03730\ \ \ \textcolor{comment}{//\ server\ or\ port\ changes,\ unless\ we're\ communicating\ through\ a\ proxy.}}
\DoxyCodeLine{03731\ }
\DoxyCodeLine{03732\ \ \ \textcolor{keywordflow}{if}\ (new\_url.get\_scheme()\ !=\ old\_url.get\_scheme()\ ||}
\DoxyCodeLine{03733\ \ \ \ \ \ \ (\_proxy.empty()\ \&\&\ (new\_url.get\_server()\ !=\ old\_url.get\_server()\ ||}
\DoxyCodeLine{03734\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ new\_url.get\_port()\ !=\ old\_url.get\_port())))\ \{}
\DoxyCodeLine{03735\ \ \ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_debug())\ \{}
\DoxyCodeLine{03736\ \ \ \ \ \ \ downloader\_cat.debug()}
\DoxyCodeLine{03737\ \ \ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03738\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}resetting\ for\ new\ server\ "{}}}
\DoxyCodeLine{03739\ \ \ \ \ \ \ \ \ <<\ new\_url.get\_server\_and\_port()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03740\ \ \ \ \ \}}
\DoxyCodeLine{03741\ \ \ \ \ reset\_to\_new();}
\DoxyCodeLine{03742\ \ \ \}}
\DoxyCodeLine{03743\ \}}
\DoxyCodeLine{03744\ }
\DoxyCodeLine{03749\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03750\ store\_header\_field(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&field\_name,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&field\_value)\ \{}
\DoxyCodeLine{03751\ \ \ std::pair<Headers::iterator,\ bool>\ insert\_result\ =}
\DoxyCodeLine{03752\ \ \ \ \ \_headers.insert(Headers::value\_type(field\_name,\ field\_value));}
\DoxyCodeLine{03753\ }
\DoxyCodeLine{03754\ \ \ \textcolor{keywordflow}{if}\ (!insert\_result.second)\ \{}
\DoxyCodeLine{03755\ \ \ \ \ \textcolor{comment}{//\ It\ didn't\ insert;\ thus,\ the\ field\ already\ existed.\ \ Append\ the\ new}}
\DoxyCodeLine{03756\ \ \ \ \ \textcolor{comment}{//\ value.}}
\DoxyCodeLine{03757\ \ \ \ \ Headers::iterator\ hi\ =\ insert\_result.first;}
\DoxyCodeLine{03758\ \ \ \ \ (*hi).second\ +=\ \textcolor{stringliteral}{"{},\ "{}};}
\DoxyCodeLine{03759\ \ \ \ \ (*hi).second\ +=\ field\_value;}
\DoxyCodeLine{03760\ \ \ \}}
\DoxyCodeLine{03761\ }
\DoxyCodeLine{03762\ \ \ \textcolor{keywordflow}{if}\ (field\_name\ ==\ \textcolor{stringliteral}{"{}set-\/cookie"{}})\ \{}
\DoxyCodeLine{03763\ \ \ \ \ \_client-\/>set\_cookie(HTTPCookie(field\_value,\ \_request.get\_url()));}
\DoxyCodeLine{03764\ \ \ \}}
\DoxyCodeLine{03765\ \}}
\DoxyCodeLine{03766\ }
\DoxyCodeLine{03767\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{03771\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03772\ show\_send(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&message)\ \{}
\DoxyCodeLine{03773\ \ \ \textcolor{keywordtype}{size\_t}\ start\ =\ 0;}
\DoxyCodeLine{03774\ \ \ \textcolor{keywordtype}{size\_t}\ newline\ =\ message.find(\textcolor{charliteral}{'\(\backslash\)n'},\ start);}
\DoxyCodeLine{03775\ \ \ \textcolor{keywordflow}{while}\ (newline\ !=\ string::npos)\ \{}
\DoxyCodeLine{03776\ \ \ \ \ \textcolor{comment}{//\ Assume\ every\ \(\backslash\)n\ is\ preceded\ by\ a\ \(\backslash\)r.}}
\DoxyCodeLine{03777\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{03778\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}send:\ "{}}\ <<\ message.substr(start,\ newline\ -\/\ start\ -\/\ 1)\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{03779\ \ \ \ \ start\ =\ newline\ +\ 1;}
\DoxyCodeLine{03780\ \ \ \ \ newline\ =\ message.find(\textcolor{charliteral}{'\(\backslash\)n'},\ start);}
\DoxyCodeLine{03781\ \ \ \}}
\DoxyCodeLine{03782\ }
\DoxyCodeLine{03783\ \ \ \textcolor{keywordflow}{if}\ (start\ <\ message.length())\ \{}
\DoxyCodeLine{03784\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{03785\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}send:\ "{}}\ <<\ message.substr(start)\ <<\ \textcolor{stringliteral}{"{}\ (no\ newline)\(\backslash\)n"{}};}
\DoxyCodeLine{03786\ \ \ \}}
\DoxyCodeLine{03787\ \}}
\DoxyCodeLine{03788\ \textcolor{preprocessor}{\#endif\ \ \ }\textcolor{comment}{//\ NDEBUG}}
\DoxyCodeLine{03789\ }
\DoxyCodeLine{03794\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03795\ reset\_download\_to()\ \{}
\DoxyCodeLine{03796\ \ \ \_started\_download\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{03797\ \ \ close\_download\_stream();}
\DoxyCodeLine{03798\ \ \ \_download\_dest\ =\ DD\_none;}
\DoxyCodeLine{03799\ \}}
\DoxyCodeLine{03800\ }
\DoxyCodeLine{03805\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03806\ close\_download\_stream()\ \{}
\DoxyCodeLine{03807\ \ \ \textcolor{keywordflow}{if}\ (\_download\_to\_stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03808\ \ \ \ \ \_download\_to\_stream-\/>flush();}
\DoxyCodeLine{03809\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_download\_dest\ ==\ DD\_file)\ \{}
\DoxyCodeLine{03810\ \ \ \ \ \ \ VirtualFileSystem::close\_write\_file(\_download\_to\_stream);}
\DoxyCodeLine{03811\ \ \ \ \ \}}
\DoxyCodeLine{03812\ \ \ \}}
\DoxyCodeLine{03813\ \ \ \_download\_to\_ramfile\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03814\ \ \ \_download\_to\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03815\ \}}
\DoxyCodeLine{03816\ }
\DoxyCodeLine{03817\ }
\DoxyCodeLine{03821\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03822\ reset\_to\_new()\ \{}
\DoxyCodeLine{03823\ \ \ \textcolor{keywordflow}{if}\ (downloader\_cat.is\_spam())\ \{}
\DoxyCodeLine{03824\ \ \ \ \ downloader\_cat.spam()}
\DoxyCodeLine{03825\ \ \ \ \ \ \ <<\ \_NOTIFY\_HTTP\_CHANNEL\_ID}
\DoxyCodeLine{03826\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}reset\_to\_new.\(\backslash\)n"{}};}
\DoxyCodeLine{03827\ \ \ \}}
\DoxyCodeLine{03828\ }
\DoxyCodeLine{03829\ \ \ close\_connection();}
\DoxyCodeLine{03830\ \ \ \_state\ =\ S\_new;}
\DoxyCodeLine{03831\ \}}
\DoxyCodeLine{03832\ }
\DoxyCodeLine{03836\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03837\ reset\_body\_stream()\ \{}
\DoxyCodeLine{03838\ \ \ \textcolor{keywordflow}{if}\ (\_owns\_body\_stream)\ \{}
\DoxyCodeLine{03839\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_body\_stream\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{03840\ \ \ \ \ \ \ close\_read\_body(\_body\_stream);}
\DoxyCodeLine{03841\ \ \ \ \ \ \ nassertv(\_body\_stream\ ==\ \textcolor{keyword}{nullptr}\ \&\&\ !\_owns\_body\_stream);}
\DoxyCodeLine{03842\ \ \ \ \ \}}
\DoxyCodeLine{03843\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{03844\ \ \ \ \ \_body\_socket\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03845\ \ \ \ \ \_body\_stream\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{03846\ \ \ \}}
\DoxyCodeLine{03847\ \}}
\DoxyCodeLine{03848\ }
\DoxyCodeLine{03849\ }
\DoxyCodeLine{03853\ \textcolor{keywordtype}{void}\ HTTPChannel::}
\DoxyCodeLine{03854\ close\_connection()\ \{}
\DoxyCodeLine{03855\ \ \ reset\_body\_stream();}
\DoxyCodeLine{03856\ \ \ \_source.clear();}
\DoxyCodeLine{03857\ \ \ \_bio.clear();}
\DoxyCodeLine{03858\ \ \ \_working\_get\ =\ string();}
\DoxyCodeLine{03859\ \ \ \_sent\_so\_far\ =\ 0;}
\DoxyCodeLine{03860\ \ \ \_read\_index++;}
\DoxyCodeLine{03861\ \}}
\DoxyCodeLine{03862\ }
\DoxyCodeLine{03868\ \textcolor{keywordtype}{bool}\ HTTPChannel::}
\DoxyCodeLine{03869\ more\_useful\_status\_code(\textcolor{keywordtype}{int}\ a,\ \textcolor{keywordtype}{int}\ b)\ \{}
\DoxyCodeLine{03870\ \ \ \textcolor{keywordflow}{if}\ (a\ >=\ 100\ \&\&\ b\ >=\ 100)\ \{}
\DoxyCodeLine{03871\ \ \ \ \ \textcolor{comment}{//\ Both\ represent\ HTTP\ responses.\ \ Responses\ from\ a\ server\ (<\ 1000)\ are}}
\DoxyCodeLine{03872\ \ \ \ \ \textcolor{comment}{//\ better\ than\ those\ from\ a\ proxy;\ we\ take\ advantage\ of\ the\ fact\ that\ we}}
\DoxyCodeLine{03873\ \ \ \ \ \textcolor{comment}{//\ have\ already\ added\ 1000\ to\ proxy\ responses.\ \ Except\ for\ 407,\ so\ let's}}
\DoxyCodeLine{03874\ \ \ \ \ \textcolor{comment}{//\ fix\ that\ now.}}
\DoxyCodeLine{03875\ \ \ \ \ \textcolor{keywordflow}{if}\ (a\ ==\ 407)\ \{}
\DoxyCodeLine{03876\ \ \ \ \ \ \ a\ +=\ 1000;}
\DoxyCodeLine{03877\ \ \ \ \ \}}
\DoxyCodeLine{03878\ \ \ \ \ \textcolor{keywordflow}{if}\ (b\ ==\ 407)\ \{}
\DoxyCodeLine{03879\ \ \ \ \ \ \ b\ +=\ 1000;}
\DoxyCodeLine{03880\ \ \ \ \ \}}
\DoxyCodeLine{03881\ }
\DoxyCodeLine{03882\ \ \ \ \ \textcolor{comment}{//\ Now\ just\ check\ the\ series.}}
\DoxyCodeLine{03883\ \ \ \ \ \textcolor{keywordtype}{int}\ series\_a\ =\ (a\ /\ 100);}
\DoxyCodeLine{03884\ \ \ \ \ \textcolor{keywordtype}{int}\ series\_b\ =\ (b\ /\ 100);}
\DoxyCodeLine{03885\ }
\DoxyCodeLine{03886\ \ \ \ \ \textcolor{comment}{//\ In\ general,\ a\ lower\ series\ is\ a\ closer\ success.}}
\DoxyCodeLine{03887\ \ \ \ \ \textcolor{keywordflow}{return}\ (series\_a\ <\ series\_b);}
\DoxyCodeLine{03888\ \ \ \}}
\DoxyCodeLine{03889\ }
\DoxyCodeLine{03890\ \ \ \textcolor{keywordflow}{if}\ (a\ <\ 100\ \&\&\ b\ <\ 100)\ \{}
\DoxyCodeLine{03891\ \ \ \ \ \textcolor{comment}{//\ Both\ represent\ non-\/HTTP\ responses.\ \ Here\ a\ larger\ number\ is\ better.}}
\DoxyCodeLine{03892\ \ \ \ \ \textcolor{keywordflow}{return}\ (a\ >\ b);}
\DoxyCodeLine{03893\ \ \ \}}
\DoxyCodeLine{03894\ }
\DoxyCodeLine{03895\ \ \ \textcolor{keywordflow}{if}\ (a\ <\ 100)\ \{}
\DoxyCodeLine{03896\ \ \ \ \ \textcolor{comment}{//\ a\ is\ a\ non-\/HTTP\ response,\ while\ b\ is\ an\ HTTP\ response.\ \ HTTP\ is}}
\DoxyCodeLine{03897\ \ \ \ \ \textcolor{comment}{//\ generally,\ better,\ unless\ we\ exceeded\ SC\_http\_error\_watermark.}}
\DoxyCodeLine{03898\ \ \ \ \ \textcolor{keywordflow}{return}\ (a\ >\ SC\_http\_error\_watermark);}
\DoxyCodeLine{03899\ \ \ \}}
\DoxyCodeLine{03900\ }
\DoxyCodeLine{03901\ \ \ \textcolor{comment}{//\ Exactly\ the\ opposite\ case\ as\ above.}}
\DoxyCodeLine{03902\ \ \ \textcolor{keywordflow}{return}\ (b\ <\ SC\_http\_error\_watermark);}
\DoxyCodeLine{03903\ \}}
\DoxyCodeLine{03904\ }
\DoxyCodeLine{03905\ }
\DoxyCodeLine{03909\ ostream\ \&}
\DoxyCodeLine{03910\ operator\ <<\ (ostream\ \&out,\ HTTPChannel::State\ state)\ \{}
\DoxyCodeLine{03911\ \textcolor{preprocessor}{\#ifdef\ NDEBUG}}
\DoxyCodeLine{03912\ \ \ \textcolor{keywordflow}{return}\ out\ <<\ (int)state;}
\DoxyCodeLine{03913\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{03914\ \ \ \textcolor{keywordflow}{switch}\ (state)\ \{}
\DoxyCodeLine{03915\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_new:}
\DoxyCodeLine{03916\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}new"{}};}
\DoxyCodeLine{03917\ }
\DoxyCodeLine{03918\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_try\_next\_proxy:}
\DoxyCodeLine{03919\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}try\_next\_proxy"{}};}
\DoxyCodeLine{03920\ }
\DoxyCodeLine{03921\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_connecting:}
\DoxyCodeLine{03922\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}connecting"{}};}
\DoxyCodeLine{03923\ }
\DoxyCodeLine{03924\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_connecting\_wait:}
\DoxyCodeLine{03925\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}connecting\_wait"{}};}
\DoxyCodeLine{03926\ }
\DoxyCodeLine{03927\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_http\_proxy\_ready:}
\DoxyCodeLine{03928\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}http\_proxy\_ready"{}};}
\DoxyCodeLine{03929\ }
\DoxyCodeLine{03930\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_http\_proxy\_request\_sent:}
\DoxyCodeLine{03931\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}http\_proxy\_request\_sent"{}};}
\DoxyCodeLine{03932\ }
\DoxyCodeLine{03933\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_http\_proxy\_reading\_header:}
\DoxyCodeLine{03934\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}http\_proxy\_reading\_header"{}};}
\DoxyCodeLine{03935\ }
\DoxyCodeLine{03936\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_socks\_proxy\_greet:}
\DoxyCodeLine{03937\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}socks\_proxy\_greet"{}};}
\DoxyCodeLine{03938\ }
\DoxyCodeLine{03939\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_socks\_proxy\_greet\_reply:}
\DoxyCodeLine{03940\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}socks\_proxy\_greet\_reply"{}};}
\DoxyCodeLine{03941\ }
\DoxyCodeLine{03942\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_socks\_proxy\_connect:}
\DoxyCodeLine{03943\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}socks\_proxy\_connect"{}};}
\DoxyCodeLine{03944\ }
\DoxyCodeLine{03945\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_socks\_proxy\_connect\_reply:}
\DoxyCodeLine{03946\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}socks\_proxy\_connect\_reply"{}};}
\DoxyCodeLine{03947\ }
\DoxyCodeLine{03948\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_setup\_ssl:}
\DoxyCodeLine{03949\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}setup\_ssl"{}};}
\DoxyCodeLine{03950\ }
\DoxyCodeLine{03951\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_ssl\_handshake:}
\DoxyCodeLine{03952\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}ssl\_handshake"{}};}
\DoxyCodeLine{03953\ }
\DoxyCodeLine{03954\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_ready:}
\DoxyCodeLine{03955\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}ready"{}};}
\DoxyCodeLine{03956\ }
\DoxyCodeLine{03957\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_request\_sent:}
\DoxyCodeLine{03958\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}request\_sent"{}};}
\DoxyCodeLine{03959\ }
\DoxyCodeLine{03960\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_reading\_header:}
\DoxyCodeLine{03961\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}reading\_header"{}};}
\DoxyCodeLine{03962\ }
\DoxyCodeLine{03963\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_start\_direct\_file\_read:}
\DoxyCodeLine{03964\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}start\_direct\_file\_read"{}};}
\DoxyCodeLine{03965\ }
\DoxyCodeLine{03966\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_read\_header:}
\DoxyCodeLine{03967\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}read\_header"{}};}
\DoxyCodeLine{03968\ }
\DoxyCodeLine{03969\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_begin\_body:}
\DoxyCodeLine{03970\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}begin\_body"{}};}
\DoxyCodeLine{03971\ }
\DoxyCodeLine{03972\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_reading\_body:}
\DoxyCodeLine{03973\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}reading\_body"{}};}
\DoxyCodeLine{03974\ }
\DoxyCodeLine{03975\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_read\_body:}
\DoxyCodeLine{03976\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}read\_body"{}};}
\DoxyCodeLine{03977\ }
\DoxyCodeLine{03978\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_read\_trailer:}
\DoxyCodeLine{03979\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}read\_trailer"{}};}
\DoxyCodeLine{03980\ }
\DoxyCodeLine{03981\ \ \ \textcolor{keywordflow}{case}\ HTTPChannel::S\_failure:}
\DoxyCodeLine{03982\ \ \ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}failure"{}};}
\DoxyCodeLine{03983\ \ \ \}}
\DoxyCodeLine{03984\ }
\DoxyCodeLine{03985\ \ \ \textcolor{keywordflow}{return}\ out\ <<\ \textcolor{stringliteral}{"{}invalid\ state("{}}\ <<\ (int)state\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{03986\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ NDEBUG}}
\DoxyCodeLine{03987\ \}}
\DoxyCodeLine{03988\ }
\DoxyCodeLine{03989\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_OPENSSL}}

\end{DoxyCode}
