\doxysection{cocoa\+Graphics\+Pipe.\+mm}
\hypertarget{cocoaGraphicsPipe_8mm_source}{}\label{cocoaGraphicsPipe_8mm_source}\index{panda/src/cocoadisplay/cocoaGraphicsPipe.mm@{panda/src/cocoadisplay/cocoaGraphicsPipe.mm}}
\mbox{\hyperlink{cocoaGraphicsPipe_8mm}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{cocoaGraphicsPipe_8h}{cocoaGraphicsPipe.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__cocoadisplay_8h}{config\_cocoadisplay.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{displayInformation_8h}{displayInformation.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#import\ <Foundation/NSAutoreleasePool.h>}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#import\ <Foundation/NSArray.h>}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#import\ <Foundation/NSDictionary.h>}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#import\ <Foundation/NSThread.h>}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#import\ <AppKit/NSApplication.h>}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#import\ <AppKit/NSRunningApplication.h>}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#import\ <AppKit/NSScreen.h>}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ <mach-\/o/arch.h>}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ CocoaGraphicsPipe::\_type\_handle;}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00033\ \mbox{\hyperlink{classCocoaGraphicsPipe_a55b714b43e24702f59878b3243d6e752}{CocoaGraphicsPipe::}}}
\DoxyCodeLine{00034\ \mbox{\hyperlink{classCocoaGraphicsPipe_a55b714b43e24702f59878b3243d6e752}{CocoaGraphicsPipe}}(CGDirectDisplayID\ display)\ :\ \_display(display)\ \{}
\DoxyCodeLine{00035\ \ \ [[NSAutoreleasePool\ alloc]\ init];}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \ \ \textcolor{comment}{//\ Put\ Cocoa\ into\ thread-\/safe\ mode\ by\ spawning\ a\ thread\ which\ immediately}}
\DoxyCodeLine{00038\ \ \ \textcolor{comment}{//\ exits.}}
\DoxyCodeLine{00039\ \ \ NSThread*\ thread\ =\ [[NSThread\ alloc]\ init];}
\DoxyCodeLine{00040\ \ \ [thread\ start];}
\DoxyCodeLine{00041\ \ \ [thread\ autorelease];}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \textcolor{comment}{//\ If\ the\ application\ is\ dpi-\/aware,\ iterate\ over\ all\ the\ screens\ to\ find\ the}}
\DoxyCodeLine{00044\ \ \ \textcolor{comment}{//\ one\ with\ our\ display\ ID\ and\ get\ the\ backing\ scale\ factor\ to\ configure\ the}}
\DoxyCodeLine{00045\ \ \ \textcolor{comment}{//\ detected\ display\ zoom.\ Otherwise\ the\ detected\ display\ zoom\ keeps\ its}}
\DoxyCodeLine{00046\ \ \ \textcolor{comment}{//\ default\ value\ of\ 1.0}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \textcolor{keywordflow}{if}\ (dpi\_aware)\ \{}
\DoxyCodeLine{00049\ \ \ \ \ NSScreen\ *screen;}
\DoxyCodeLine{00050\ \ \ \ \ NSEnumerator\ *e\ =\ [[NSScreen\ screens]\ objectEnumerator];}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keywordflow}{while}\ (screen\ =\ (NSScreen\ *)\ [e\ nextObject])\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \ \ NSNumber\ *num\ =\ [[screen\ deviceDescription]\ objectForKey:\ \textcolor{stringliteral}{@"{}NSScreenNumber"{}}];}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_display\ ==\ (CGDirectDisplayID)\ [num\ longValue])\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ set\_detected\_display\_zoom([screen\ backingScaleFactor]);}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cocoadisplay\_cat.is\_debug())\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \ \ cocoadisplay\_cat.debug()}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Display\ zoom\ is\ "{}}\ <<\ [screen\ backingScaleFactor]\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00061\ \ \ \ \ \}}
\DoxyCodeLine{00062\ \ \ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \textcolor{comment}{//\ We\ used\ to\ also\ obtain\ the\ corresponding\ NSScreen\ here,\ but\ this\ causes}}
\DoxyCodeLine{00065\ \ \ \textcolor{comment}{//\ the\ application\ icon\ to\ start\ bouncing,\ which\ may\ be\ undesirable\ for}}
\DoxyCodeLine{00066\ \ \ \textcolor{comment}{//\ apps\ that\ will\ never\ open\ a\ window.}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{//\ Although\ the\ name\ of\ these\ functions\ mention\ pixels,\ they\ actually\ return}}
\DoxyCodeLine{00069\ \ \ \textcolor{comment}{//\ display\ points,\ we\ use\ the\ detected\ display\ zoom\ to\ transform\ the\ values}}
\DoxyCodeLine{00070\ \ \ \textcolor{comment}{//\ into\ pixels.}}
\DoxyCodeLine{00071\ \ \ \_display\_width\ =\ CGDisplayPixelsWide(\_display)\ *\ \_detected\_display\_zoom;}
\DoxyCodeLine{00072\ \ \ \_display\_height\ =\ CGDisplayPixelsHigh(\_display)\ *\ \_detected\_display\_zoom;}
\DoxyCodeLine{00073\ \ \ load\_display\_information();}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{keywordflow}{if}\ (cocoadisplay\_cat.is\_debug())\ \{}
\DoxyCodeLine{00076\ \ \ \ \ cocoadisplay\_cat.debug()}
\DoxyCodeLine{00077\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Creating\ CocoaGraphicsPipe\ for\ display\ ID\ "{}}\ <<\ \_display\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00078\ \ \ \}}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{comment}{//\ It\ takes\ a\ while\ to\ fire\ up\ the\ display\ link,\ so\ let's\ fire\ it\ up\ now\ if}}
\DoxyCodeLine{00081\ \ \ \textcolor{comment}{//\ we\ expect\ to\ need\ VSync.}}
\DoxyCodeLine{00082\ \ \ \textcolor{keywordflow}{if}\ (sync\_video)\ \{}
\DoxyCodeLine{00083\ \ \ \ \ uint32\_t\ counter;}
\DoxyCodeLine{00084\ \ \ \ \ \mbox{\hyperlink{classCocoaGraphicsPipe_aacdd92be3546b53bef3aa47ff3b5c5ba}{init\_vsync}}(counter);}
\DoxyCodeLine{00085\ \ \ \}}
\DoxyCodeLine{00086\ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00091\ \textcolor{keywordtype}{void}\ CocoaGraphicsPipe::}
\DoxyCodeLine{00092\ load\_display\_information()\ \{}
\DoxyCodeLine{00093\ \ \ \_display\_information-\/>\_vendor\_id\ =\ CGDisplayVendorNumber(\_display);}
\DoxyCodeLine{00094\ \ \ \textcolor{comment}{//\ \_display\_information-\/>\_device\_id\ =\ CGDisplayUnitNumber(\_display);}}
\DoxyCodeLine{00095\ \ \ \textcolor{comment}{//\ \_display\_information-\/>\_device\_id\ =\ CGDisplaySerialNumber(\_display);}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \textcolor{comment}{//\ Display\ modes}}
\DoxyCodeLine{00098\ \ \ CFDictionaryRef\ options\ =\ NULL;}
\DoxyCodeLine{00099\ \ \ \textcolor{keyword}{const}\ CFStringRef\ dictkeys[]\ =\ \{kCGDisplayShowDuplicateLowResolutionModes\};}
\DoxyCodeLine{00100\ \ \ \textcolor{keyword}{const}\ CFBooleanRef\ dictvalues[]\ =\ \{kCFBooleanTrue\};}
\DoxyCodeLine{00101\ \ \ options\ =\ CFDictionaryCreate(NULL,}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}\ **)dictkeys,}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}\ **)dictvalues,}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&kCFCopyStringDictionaryKeyCallBacks,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&kCFTypeDictionaryValueCallBacks);}
\DoxyCodeLine{00107\ \ \ \textcolor{keywordtype}{size\_t}\ num\_modes\ =\ 0;}
\DoxyCodeLine{00108\ \ \ int32\_t\ current\_mode\_id\ =\ -\/1;}
\DoxyCodeLine{00109\ \ \ CFArrayRef\ modes\ =\ CGDisplayCopyAllDisplayModes(\_display,\ options);}
\DoxyCodeLine{00110\ \ \ \textcolor{keywordflow}{if}\ (modes\ !=\ NULL)\ \{}
\DoxyCodeLine{00111\ \ \ \ \ num\_modes\ =\ CFArrayGetCount(modes);}
\DoxyCodeLine{00112\ \ \ \ \ \_display\_information-\/>\_total\_display\_modes\ =\ num\_modes;}
\DoxyCodeLine{00113\ \ \ \ \ \_display\_information-\/>\_display\_mode\_array\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{structDisplayMode}{DisplayMode}}[num\_modes];}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{comment}{//\ Get\ information\ about\ the\ current\ mode.}}
\DoxyCodeLine{00116\ \ \ \ \ CGDisplayModeRef\ mode\ =\ CGDisplayCopyDisplayMode(\_display);}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordflow}{if}\ (mode)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ current\_mode\_id\ =\ CGDisplayModeGetIODisplayModeID(mode);}
\DoxyCodeLine{00119\ \ \ \ \ \ \ CGDisplayModeRelease(mode);}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \}}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (options\ !=\ NULL)\ \{}
\DoxyCodeLine{00123\ \ \ \ \ CFRelease(options);}
\DoxyCodeLine{00124\ \ \ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00126\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ num\_modes;\ ++i)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ CGDisplayModeRef\ mode\ =\ (CGDisplayModeRef)\ CFArrayGetValueAtIndex(modes,\ i);}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{keywordflow}{if}\ (dpi\_aware)\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].width\ =\ CGDisplayModeGetPixelWidth(mode);}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].height\ =\ CGDisplayModeGetPixelHeight(mode);}
\DoxyCodeLine{00132\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].width\ =\ CGDisplayModeGetWidth(mode);}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].height\ =\ CGDisplayModeGetHeight(mode);}
\DoxyCodeLine{00135\ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].refresh\_rate\ =\ CGDisplayModeGetRefreshRate(mode);}
\DoxyCodeLine{00137\ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].fullscreen\_only\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{comment}{//\ Read\ number\ of\ bits\ per\ pixels\ from\ the\ pixel\ encoding}}
\DoxyCodeLine{00140\ \ \ \ \ CFStringRef\ encoding\ =\ CGDisplayModeCopyPixelEncoding(mode);}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{if}\ (CFStringCompare(encoding,\ CFSTR(kIO64BitDirectPixels),}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kCFCompareCaseInsensitive)\ ==\ kCFCompareEqualTo)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].bits\_per\_pixel\ =\ 64;}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00145\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (CFStringCompare(encoding,\ CFSTR(kIO32BitFloatPixels),}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kCFCompareCaseInsensitive)\ ==\ kCFCompareEqualTo)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].bits\_per\_pixel\ =\ 32;}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (CFStringCompare(encoding,\ CFSTR(kIO16BitFloatPixels),}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kCFCompareCaseInsensitive)\ ==\ kCFCompareEqualTo)\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].bits\_per\_pixel\ =\ 16;}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (CFStringCompare(encoding,\ CFSTR(IOYUV422Pixels),}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kCFCompareCaseInsensitive)\ ==\ kCFCompareEqualTo\ ||}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CFStringCompare(encoding,\ CFSTR(IO8BitOverlayPixels),}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ kCFCompareCaseInsensitive)\ ==\ kCFCompareEqualTo)\ \{}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].bits\_per\_pixel\ =\ 8;}
\DoxyCodeLine{00158\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ other\ possible\ pixel\ formats\ in\ IOKitIOGraphicsTypes.h\ have}}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \textcolor{comment}{//\ strings\ like\ "{}PPPP"{}\ or\ "{}-\/RRRRRGGGGGBBBBB"{},\ so\ the\ number\ of\ bits\ per}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \textcolor{comment}{//\ pixel\ can\ be\ deduced\ from\ the\ string\ length.\ \ Nifty!}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \_display\_information-\/>\_display\_mode\_array[i].bits\_per\_pixel\ =\ CFStringGetLength(encoding);}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_mode\_id\ >=\ 0\ \&\&\ current\_mode\_id\ ==\ CGDisplayModeGetIODisplayModeID(mode))\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \_display\_information-\/>\_current\_display\_mode\_index\ =\ i;}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00168\ \ \ \ \ \ \ \textcolor{comment}{//\ Stop\ checking}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ current\_mode\_id\ =\ -\/1;}
\DoxyCodeLine{00170\ \ \ \ \ \}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \ \ \ CFRelease(encoding);}
\DoxyCodeLine{00173\ \ \ \}}
\DoxyCodeLine{00174\ \ \ \textcolor{keywordflow}{if}\ (modes\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00175\ \ \ \ \ CFRelease(modes);}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \textcolor{comment}{//\ Get\ processor\ information}}
\DoxyCodeLine{00179\ \ \ \textcolor{keyword}{const}\ NXArchInfo\ *ainfo\ =\ NXGetLocalArchInfo();}
\DoxyCodeLine{00180\ \ \ \_display\_information-\/>\_cpu\_brand\_string.assign(ainfo-\/>description);}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{comment}{//\ Get\ version\ of\ Mac\ OS\ X}}
\DoxyCodeLine{00183\ \ \ SInt32\ major,\ minor,\ bugfix;}
\DoxyCodeLine{00184\ \ \ Gestalt(gestaltSystemVersionMajor,\ \&major);}
\DoxyCodeLine{00185\ \ \ Gestalt(gestaltSystemVersionMinor,\ \&minor);}
\DoxyCodeLine{00186\ \ \ Gestalt(gestaltSystemVersionBugFix,\ \&bugfix);}
\DoxyCodeLine{00187\ \ \ \_display\_information-\/>\_os\_version\_major\ =\ major;}
\DoxyCodeLine{00188\ \ \ \_display\_information-\/>\_os\_version\_minor\ =\ minor;}
\DoxyCodeLine{00189\ \ \ \_display\_information-\/>\_os\_version\_build\ =\ bugfix;}
\DoxyCodeLine{00190\ \}}
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00195\ CocoaGraphicsPipe::}
\DoxyCodeLine{00196\ \string~CocoaGraphicsPipe()\ \{}
\DoxyCodeLine{00197\ \ \ \textcolor{keywordflow}{if}\ (\_display\_link\ !=\ nil)\ \{}
\DoxyCodeLine{00198\ \ \ \ \ CVDisplayLinkRelease(\_display\_link);}
\DoxyCodeLine{00199\ \ \ \ \ \_display\_link\ =\ nil;}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{comment}{//\ Unblock\ any\ threads\ that\ may\ be\ waiting\ on\ the\ VSync\ counter.}}
\DoxyCodeLine{00202\ \ \ \ \ \_\_atomic\_fetch\_add(\&\_vsync\_counter,\ 1u,\ \_\_ATOMIC\_SEQ\_CST);}
\DoxyCodeLine{00203\ \ \ \ \ patomic\_notify\_all(\&\_vsync\_counter);}
\DoxyCodeLine{00204\ \ \ \}}
\DoxyCodeLine{00205\ \}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00212\ GraphicsPipe::PreferredWindowThread}
\DoxyCodeLine{00213\ \mbox{\hyperlink{classCocoaGraphicsPipe_a947caed9a22f45dd28c320e8c5a0cb70}{CocoaGraphicsPipe::get\_preferred\_window\_thread}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00214\ \ \ \textcolor{comment}{//\ The\ NSView\ and\ NSWindow\ classes\ are\ not\ completely\ thread-\/safe,\ they\ can}}
\DoxyCodeLine{00215\ \ \ \textcolor{comment}{//\ only\ be\ called\ from\ the\ main\ thread!}}
\DoxyCodeLine{00216\ \ \ \textcolor{keywordflow}{return}\ PWT\_app;}
\DoxyCodeLine{00217\ \}}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00225\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classCocoaGraphicsPipe_aacdd92be3546b53bef3aa47ff3b5c5ba}{CocoaGraphicsPipe::}}}
\DoxyCodeLine{00226\ \mbox{\hyperlink{classCocoaGraphicsPipe_aacdd92be3546b53bef3aa47ff3b5c5ba}{init\_vsync}}(uint32\_t\ \&counter)\ \{}
\DoxyCodeLine{00227\ \ \ \textcolor{keywordflow}{if}\ (\_display\_link\ !=\ nil)\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \textcolor{comment}{//\ Already\ set\ up.}}
\DoxyCodeLine{00229\ \ \ \ \ \_\_atomic\_load(\&\_vsync\_counter,\ \&counter,\ \_\_ATOMIC\_SEQ\_CST);}
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00231\ \ \ \}}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ counter\ =\ 0;}
\DoxyCodeLine{00234\ \ \ \_vsync\_counter\ =\ 0;}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ CVDisplayLinkRef\ display\_link;}
\DoxyCodeLine{00237\ \ \ CVReturn\ result\ =\ CVDisplayLinkCreateWithActiveCGDisplays(\&display\_link);}
\DoxyCodeLine{00238\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ kCVReturnSuccess)\ \{}
\DoxyCodeLine{00239\ \ \ \ \ cocoadisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ create\ CVDisplayLink.\(\backslash\)n"{}};}
\DoxyCodeLine{00240\ \ \ \ \ display\_link\ =\ nil;}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00242\ \ \ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ \ \ result\ =\ CVDisplayLinkSetCurrentCGDisplay(display\_link,\ \_display);}
\DoxyCodeLine{00245\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ kCVReturnSuccess)\ \{}
\DoxyCodeLine{00246\ \ \ \ \ cocoadisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ set\ CVDisplayLink's\ current\ display.\(\backslash\)n"{}};}
\DoxyCodeLine{00247\ \ \ \ \ CVDisplayLinkRelease(display\_link);}
\DoxyCodeLine{00248\ \ \ \ \ display\_link\ =\ nil;}
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00250\ \ \ \}}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ result\ =\ CVDisplayLinkSetOutputCallback(display\_link,\ \&display\_link\_cb,\ \textcolor{keyword}{this});}
\DoxyCodeLine{00253\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ kCVReturnSuccess)\ \{}
\DoxyCodeLine{00254\ \ \ \ \ cocoadisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ set\ CVDisplayLink\ output\ callback.\(\backslash\)n"{}};}
\DoxyCodeLine{00255\ \ \ \ \ CVDisplayLinkRelease(display\_link);}
\DoxyCodeLine{00256\ \ \ \ \ display\_link\ =\ nil;}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00258\ \ \ \}}
\DoxyCodeLine{00259\ }
\DoxyCodeLine{00260\ \ \ result\ =\ CVDisplayLinkStart(display\_link);}
\DoxyCodeLine{00261\ \ \ \textcolor{keywordflow}{if}\ (result\ !=\ kCVReturnSuccess)\ \{}
\DoxyCodeLine{00262\ \ \ \ \ cocoadisplay\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Failed\ to\ start\ the\ CVDisplayLink.\(\backslash\)n"{}};}
\DoxyCodeLine{00263\ \ \ \ \ CVDisplayLinkRelease(display\_link);}
\DoxyCodeLine{00264\ \ \ \ \ display\_link\ =\ nil;}
\DoxyCodeLine{00265\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00266\ \ \ \}}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \_display\_link\ =\ display\_link;}
\DoxyCodeLine{00269\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00270\ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00279\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classCocoaGraphicsPipe_adfedefbfd7c63a33dab14f6375e9b501}{CocoaGraphicsPipe::}}}
\DoxyCodeLine{00280\ \mbox{\hyperlink{classCocoaGraphicsPipe_adfedefbfd7c63a33dab14f6375e9b501}{wait\_vsync}}(uint32\_t\ \&counter,\ \textcolor{keywordtype}{bool}\ adaptive)\ \{}
\DoxyCodeLine{00281\ \ \ \textcolor{keywordflow}{if}\ (\_display\_link\ ==\ nil)\ \{}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00283\ \ \ \}}
\DoxyCodeLine{00284\ }
\DoxyCodeLine{00285\ \ \ \textcolor{comment}{//\ Use\ direct\ atomic\ operations\ since\ we\ need\ this\ to\ be\ thread-\/safe\ even}}
\DoxyCodeLine{00286\ \ \ \textcolor{comment}{//\ when\ compiling\ without\ thread\ support.}}
\DoxyCodeLine{00287\ \ \ uint32\_t\ current\_count\ =\ \_\_atomic\_load\_n(\&\_vsync\_counter,\ \_\_ATOMIC\_SEQ\_CST);}
\DoxyCodeLine{00288\ \ \ uint32\_t\ diff\ =\ current\_count\ -\/\ counter;}
\DoxyCodeLine{00289\ \ \ \textcolor{keywordflow}{if}\ (diff\ >\ 0)\ \{}
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordflow}{if}\ (cocoadisplay\_cat.is\_spam())\ \{}
\DoxyCodeLine{00291\ \ \ \ \ \ \ cocoadisplay\_cat.spam()}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Missed\ vertical\ blanking\ interval\ by\ "{}}\ <<\ diff\ <<\ \textcolor{stringliteral}{"{}\ frames.\(\backslash\)n"{}};}
\DoxyCodeLine{00293\ \ \ \ \ \}}
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordflow}{if}\ (adaptive)\ \{}
\DoxyCodeLine{00295\ \ \ \ \ \ \ counter\ =\ current\_count;}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00297\ \ \ \ \ \}}
\DoxyCodeLine{00298\ \ \ \}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \textcolor{comment}{//\ We\ only\ wait\ for\ the\ first\ window\ that\ gets\ flipped\ in\ a\ single\ frame,}}
\DoxyCodeLine{00301\ \ \ \textcolor{comment}{//\ otherwise\ we\ end\ up\ halving\ our\ FPS\ when\ we\ have\ multiple\ windows!}}
\DoxyCodeLine{00302\ \ \ \textcolor{keywordtype}{int}\ cur\_frame\ =\ ClockObject::get\_global\_clock()-\/>get\_frame\_count();}
\DoxyCodeLine{00303\ \ \ \textcolor{keywordflow}{if}\ (\_last\_wait\_frame.exchange(cur\_frame)\ ==\ cur\_frame)\ \{}
\DoxyCodeLine{00304\ \ \ \ \ counter\ =\ current\_count;}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00306\ \ \ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \ \ patomic\_wait(\&\_vsync\_counter,\ current\_count);}
\DoxyCodeLine{00309\ \ \ \_\_atomic\_load(\&\_vsync\_counter,\ \&counter,\ \_\_ATOMIC\_SEQ\_CST);}
\DoxyCodeLine{00310\ \}}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00316\ CVReturn\ CocoaGraphicsPipe::}
\DoxyCodeLine{00317\ display\_link\_cb(CVDisplayLinkRef\ link,\ \textcolor{keyword}{const}\ CVTimeStamp\ *now,}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ CVTimeStamp\ *output\_time,\ CVOptionFlags\ flags\_in,}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CVOptionFlags\ *flags\_out,\ \textcolor{keywordtype}{void}\ *context)\ \{}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \mbox{\hyperlink{classCocoaGraphicsPipe}{CocoaGraphicsPipe}}\ *pipe\ =\ (\mbox{\hyperlink{classCocoaGraphicsPipe}{CocoaGraphicsPipe}}\ *)context;}
\DoxyCodeLine{00322\ \ \ \_\_atomic\_fetch\_add(\&pipe-\/>\_vsync\_counter,\ 1u,\ \_\_ATOMIC\_SEQ\_CST);}
\DoxyCodeLine{00323\ \ \ patomic\_notify\_all(\&pipe-\/>\_vsync\_counter);}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \textcolor{keywordflow}{return}\ kCVReturnSuccess;}
\DoxyCodeLine{00326\ \}}

\end{DoxyCode}
