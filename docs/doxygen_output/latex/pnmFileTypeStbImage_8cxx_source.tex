\doxysection{pnm\+File\+Type\+Stb\+Image.\+cxx}
\hypertarget{pnmFileTypeStbImage_8cxx_source}{}\label{pnmFileTypeStbImage_8cxx_source}\index{panda/src/pnmimagetypes/pnmFileTypeStbImage.cxx@{panda/src/pnmimagetypes/pnmFileTypeStbImage.cxx}}
\mbox{\hyperlink{pnmFileTypeStbImage_8cxx}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeStbImage_8h}{pnmFileTypeStbImage.h}}"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifdef\ HAVE\_STB\_IMAGE}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{config__pnmimagetypes_8h}{config\_pnmimagetypes.h}}"{}}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{pnmFileTypeRegistry_8h}{pnmFileTypeRegistry.h}}"{}}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bamReader_8h}{bamReader.h}}"{}}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{comment}{//\ We\ use\ the\ public\ domain\ stb\_image\ library\ for\ loading\ images.\ \ Define\ the}}
\DoxyCodeLine{00023\ \textcolor{comment}{//\ stb\_image\ implementation.\ \ We\ only\ use\ it\ in\ this\ unit.}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#define\ STB\_IMAGE\_STATIC}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#define\ STB\_IMAGE\_IMPLEMENTATION}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{comment}{//\ Disable\ the\ stb\_image\ implementation\ of\ these\ formats\ if\ we\ already\ support}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ it\ through\ different\ loaders.}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#ifndef\ HAVE\_JPEG}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_JPEG}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#ifndef\ HAVE\_PNG}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_PNG}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#ifndef\ HAVE\_BMP}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_BMP}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#ifndef\ HAVE\_TGA}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_TGA}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SOFTIMAGE\_PIC}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_PIC}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#ifndef\ HAVE\_PNM}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_PNM}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{comment}{//\ These\ are\ always\ enabled\ because\ we\ don't\ support\ these\ via\ other\ means.}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_PSD}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_HDR}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#define\ STBI\_ONLY\_GIF}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#ifndef\ NDEBUG}}
\DoxyCodeLine{00054\ \textcolor{comment}{//\ Get\ friendlier\ error\ messages\ in\ development\ builds.}}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#define\ STBI\_FAILURE\_USERMSG}}
\DoxyCodeLine{00056\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{comment}{//\ We\ read\ via\ callbacks,\ so\ no\ need\ for\ stbi\_load\_from\_file.}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#define\ STBI\_NO\_STDIO}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#include\ "{}stb\_image.h"{}}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \textcolor{keyword}{using\ }std::ios;}
\DoxyCodeLine{00064\ \textcolor{keyword}{using\ }std::istream;}
\DoxyCodeLine{00065\ \textcolor{keyword}{using\ }std::string;}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *\textcolor{keyword}{const}\ stb\_extensions[]\ =\ \{}
\DoxyCodeLine{00068\ \ \ \textcolor{comment}{//\ Expose\ the\ extensions\ that\ we\ don't\ already\ expose\ through\ other\ loaders.}}
\DoxyCodeLine{00069\ \textcolor{preprocessor}{\#if\ !defined(HAVE\_JPEG)\ \&\&\ !defined(ANDROID)}}
\DoxyCodeLine{00070\ \ \ \textcolor{stringliteral}{"{}jpg"{}},\ \textcolor{stringliteral}{"{}jpeg"{}},}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00072\ \textcolor{preprocessor}{\#ifndef\ HAVE\_PNG}}
\DoxyCodeLine{00073\ \ \ \textcolor{stringliteral}{"{}png"{}},}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00075\ \textcolor{preprocessor}{\#ifndef\ HAVE\_BMP}}
\DoxyCodeLine{00076\ \ \ \textcolor{stringliteral}{"{}bmp"{}},}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#ifndef\ HAVE\_TGA}}
\DoxyCodeLine{00079\ \ \ \textcolor{stringliteral}{"{}tga"{}},}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#ifndef\ HAVE\_SOFTIMAGE\_PIC}}
\DoxyCodeLine{00082\ \ \ \textcolor{stringliteral}{"{}pic"{}},}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\#ifndef\ HAVE\_PNM}}
\DoxyCodeLine{00085\ \ \ \textcolor{stringliteral}{"{}ppm"{}},\ \textcolor{stringliteral}{"{}pgm"{}},}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//\ We\ don't\ have\ other\ loaders\ for\ these,\ so\ add\ them\ unconditionally.}}
\DoxyCodeLine{00089\ \ \ \textcolor{stringliteral}{"{}psd"{}},}
\DoxyCodeLine{00090\ \ \ \textcolor{stringliteral}{"{}hdr"{}},}
\DoxyCodeLine{00091\ \ \ \textcolor{stringliteral}{"{}gif"{}},}
\DoxyCodeLine{00092\ \};}
\DoxyCodeLine{00093\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_stb\_extensions\ =\ \textcolor{keyword}{sizeof}(stb\_extensions)\ /\ \textcolor{keyword}{sizeof}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *);}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \textcolor{comment}{//\ Callbacks\ to\ allow\ stb\_image\ to\ read\ from\ VFS.}}
\DoxyCodeLine{00096\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ cb\_read(\textcolor{keywordtype}{void}\ *user,\ \textcolor{keywordtype}{char}\ *data,\ \textcolor{keywordtype}{int}\ size)\ \{}
\DoxyCodeLine{00097\ \ \ istream\ *in\ =\ (istream\ *)user;}
\DoxyCodeLine{00098\ \ \ nassertr(in\ !=\ \textcolor{keyword}{nullptr},\ 0);}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ in-\/>read(data,\ size);}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \textcolor{keywordflow}{if}\ (in-\/>eof())\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{comment}{//\ Gracefully\ handle\ EOF.}}
\DoxyCodeLine{00104\ \ \ \ \ in-\/>clear(ios::eofbit);}
\DoxyCodeLine{00105\ \ \ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \textcolor{keywordflow}{return}\ (\textcolor{keywordtype}{int})in-\/>gcount();}
\DoxyCodeLine{00108\ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ cb\_skip(\textcolor{keywordtype}{void}\ *user,\ \textcolor{keywordtype}{int}\ n)\ \{}
\DoxyCodeLine{00111\ \ \ istream\ *in\ =\ (istream\ *)user;}
\DoxyCodeLine{00112\ \ \ nassertv(in\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ in-\/>seekg(n,\ ios::cur);}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \textcolor{comment}{//\ If\ we\ can't\ seek,\ move\ forward\ by\ ignoring\ bytes\ instead.}}
\DoxyCodeLine{00117\ \ \ \textcolor{keywordflow}{if}\ (in-\/>fail()\ \&\&\ n\ >\ 0)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ in-\/>clear();}
\DoxyCodeLine{00119\ \ \ \ \ in-\/>ignore(n);}
\DoxyCodeLine{00120\ \ \ \}}
\DoxyCodeLine{00121\ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ cb\_eof(\textcolor{keywordtype}{void}\ *user)\ \{}
\DoxyCodeLine{00124\ \ \ istream\ *in\ =\ (istream\ *)user;}
\DoxyCodeLine{00125\ \ \ nassertr(in\ !=\ \textcolor{keyword}{nullptr},\ 1);}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \textcolor{keywordflow}{return}\ in-\/>eof();}
\DoxyCodeLine{00128\ \}}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \textcolor{keyword}{static}\ \mbox{\hyperlink{structstbi__io__callbacks}{stbi\_io\_callbacks}}\ io\_callbacks\ =\ \{cb\_read,\ cb\_skip,\ cb\_eof\};}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00135\ \textcolor{keyword}{class\ }StbImageReader\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classPNMReader}{PNMReader}}\ \{}
\DoxyCodeLine{00136\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00137\ \ \ StbImageReader(\mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type,\ istream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,\ \textcolor{keywordtype}{string}\ magic\_number);}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPNMReader_a34acf9a526d3ffe9f6be1fc4617757ae}{is\_floating\_point}}();}
\DoxyCodeLine{00140\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classPNMReader_ae743bce38d7eb6a951a6291ecfa84269}{read\_pfm}}(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm);}
\DoxyCodeLine{00141\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classPNMReader_a244e28aedcd80a852259646cc20f6a4a}{read\_data}}(\mbox{\hyperlink{structpixel}{xel}}\ *array,\ xelval\ *alpha);}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00144\ \ \ \textcolor{keywordtype}{bool}\ \_is\_float;}
\DoxyCodeLine{00145\ \ \ stbi\_\_context\ \_context;}
\DoxyCodeLine{00146\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ \_buffer[1024];}
\DoxyCodeLine{00147\ \};}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \mbox{\hyperlink{classTypeHandle}{TypeHandle}}\ PNMFileTypeStbImage::\_type\_handle;}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00154\ PNMFileTypeStbImage::}
\DoxyCodeLine{00155\ PNMFileTypeStbImage()\ \{}
\DoxyCodeLine{00156\ \}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00161\ \textcolor{keywordtype}{string}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00162\ get\_name()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00163\ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}stb\_image"{}};}
\DoxyCodeLine{00164\ \}}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00170\ \textcolor{keywordtype}{int}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00171\ get\_num\_extensions()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00172\ \ \ \textcolor{keywordflow}{return}\ num\_stb\_extensions;}
\DoxyCodeLine{00173\ \}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00179\ \textcolor{keywordtype}{string}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00180\ get\_extension(\textcolor{keywordtype}{int}\ n)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00181\ \ \ nassertr(n\ >=\ 0\ \&\&\ n\ <\ num\_stb\_extensions,\ \textcolor{keywordtype}{string}());}
\DoxyCodeLine{00182\ \ \ \textcolor{keywordflow}{return}\ stb\_extensions[n];}
\DoxyCodeLine{00183\ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00189\ \textcolor{keywordtype}{bool}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00190\ has\_magic\_number()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00191\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00192\ \}}
\DoxyCodeLine{00193\ }
\DoxyCodeLine{00199\ \textcolor{keywordtype}{bool}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00200\ matches\_magic\_number(\textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&magic\_number)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00201\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00202\ \}}
\DoxyCodeLine{00203\ }
\DoxyCodeLine{00209\ \mbox{\hyperlink{classPNMReader}{PNMReader}}\ *PNMFileTypeStbImage::}
\DoxyCodeLine{00210\ make\_reader(istream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \&magic\_number)\ \{}
\DoxyCodeLine{00211\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ StbImageReader(\textcolor{keyword}{this},\ file,\ owns\_file,\ magic\_number);}
\DoxyCodeLine{00212\ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00217\ StbImageReader::}
\DoxyCodeLine{00218\ StbImageReader(\mbox{\hyperlink{classPNMFileType}{PNMFileType}}\ *type,\ istream\ *file,\ \textcolor{keywordtype}{bool}\ owns\_file,\ \textcolor{keywordtype}{string}\ magic\_number)\ :}
\DoxyCodeLine{00219\ \ \ \mbox{\hyperlink{classPNMReader}{PNMReader}}(type,\ file,\ owns\_file),}
\DoxyCodeLine{00220\ \ \ \_is\_float(false)}
\DoxyCodeLine{00221\ \{}
\DoxyCodeLine{00222\ \ \ \textcolor{comment}{//\ Prepare\ the\ stb\_image\ context.\ \ See\ stbi\_\_start\_callbacks.}}
\DoxyCodeLine{00223\ \ \ \_context.io.read\ =\ cb\_read;}
\DoxyCodeLine{00224\ \ \ \_context.io.skip\ =\ cb\_skip;}
\DoxyCodeLine{00225\ \ \ \_context.io.eof\ =\ cb\_eof;}
\DoxyCodeLine{00226\ \ \ \_context.io\_user\_data\ =\ (\textcolor{keywordtype}{void}\ *)file;}
\DoxyCodeLine{00227\ \ \ \_context.buflen\ =\ \textcolor{keyword}{sizeof}(\_context.buffer\_start);}
\DoxyCodeLine{00228\ \ \ \_context.read\_from\_callbacks\ =\ 1;}
\DoxyCodeLine{00229\ \ \ \_context.img\_buffer\ =\ \_buffer;}
\DoxyCodeLine{00230\ \ \ \_context.img\_buffer\_original\ =\ \_buffer;}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \ \ \textcolor{comment}{//\ Prepopulate\ it\ with\ the\ magic\ number\ we\ already\ read,\ then\ fill\ it\ up.}}
\DoxyCodeLine{00233\ \ \ \textcolor{comment}{//\ We\ need\ a\ big\ enough\ buffer\ so\ that\ we\ can\ read\ the\ image\ header.}}
\DoxyCodeLine{00234\ \ \ \textcolor{comment}{//\ If\ stb\_image\ runs\ out,\ it\ will\ switch\ to\ its\ own\ 128-\/byte\ buffer.}}
\DoxyCodeLine{00235\ \ \ memcpy(\_buffer,\ magic\_number.data(),\ magic\_number.size());}
\DoxyCodeLine{00236\ \ \ file-\/>read((\textcolor{keywordtype}{char}\ *)\_buffer\ +\ magic\_number.size(),\ \textcolor{keyword}{sizeof}(\_buffer)\ -\/\ magic\_number.size());}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \textcolor{keywordflow}{if}\ (file-\/>eof())\ \{}
\DoxyCodeLine{00239\ \ \ \ \ file-\/>clear(ios::eofbit);}
\DoxyCodeLine{00240\ \ \ \}}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \textcolor{keywordtype}{size\_t}\ length\ =\ file-\/>gcount()\ +\ magic\_number.size();}
\DoxyCodeLine{00243\ \ \ \_context.img\_buffer\_end\ =\ \_buffer\ +\ length;}
\DoxyCodeLine{00244\ \ \ \_context.img\_buffer\_original\_end\ =\ \_context.img\_buffer\_end;}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \textcolor{preprocessor}{\#ifndef\ STBI\_NO\_PNG}}
\DoxyCodeLine{00247\ \ \ stbi\_\_png\ png;}
\DoxyCodeLine{00248\ \ \ png.s\ =\ \&\_context;}
\DoxyCodeLine{00249\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \ \ \textcolor{comment}{//\ Invoke\ stbi\_info\ to\ read\ the\ image\ size\ and\ channel\ count.}}
\DoxyCodeLine{00252\ \ \ \textcolor{keywordflow}{if}\ (magic\_number[0]\ ==\ \textcolor{charliteral}{'\#'}\ \&\&\ magic\_number[1]\ ==\ \textcolor{charliteral}{'?'}\ \&\&}
\DoxyCodeLine{00253\ \ \ \ \ \ \ stbi\_\_hdr\_info(\&\_context,\ \&\_x\_size,\ \&\_y\_size,\ \&\_num\_channels))\ \{}
\DoxyCodeLine{00254\ \ \ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00255\ \ \ \ \ \_is\_float\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00257\ \textcolor{preprocessor}{\#ifndef\ STBI\_NO\_PNG}}
\DoxyCodeLine{00258\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (magic\_number[0]\ ==\ \textcolor{stringliteral}{'\(\backslash\)x89'}\ \&\&\ magic\_number[1]\ ==\ \textcolor{charliteral}{'P'}\ \&\&}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \ \ \ \ \ stbi\_\_png\_info\_raw(\&png,\ \&\_x\_size,\ \&\_y\_size,\ \&\_num\_channels))\ \{}
\DoxyCodeLine{00260\ \ \ \ \ \textcolor{comment}{//\ Detect\ the\ case\ of\ using\ PNGs\ so\ that\ we\ can\ determine\ whether\ to\ do\ a}}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ 16-\/bit\ load\ instead.}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{keywordflow}{if}\ (png.depth\ ==\ 16)\ \{}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \_maxval\ =\ 65535;}
\DoxyCodeLine{00264\ \ \ \ \ \}}
\DoxyCodeLine{00265\ \ \ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00266\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (stbi\_\_info\_main(\&\_context,\ \&\_x\_size,\ \&\_y\_size,\ \&\_num\_channels))\ \{}
\DoxyCodeLine{00269\ \ \ \ \ \_is\_valid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \_is\_valid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00273\ \ \ \ \ pnmimage\_cat.error()}
\DoxyCodeLine{00274\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}stb\_info\ failure:\ "{}}\ <<\ stbi\_failure\_reason()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00275\ \ \ \}}
\DoxyCodeLine{00276\ \}}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00283\ \textcolor{keywordtype}{bool}\ StbImageReader::}
\DoxyCodeLine{00284\ is\_floating\_point()\ \{}
\DoxyCodeLine{00285\ \ \ \textcolor{keywordflow}{return}\ \_is\_float;}
\DoxyCodeLine{00286\ \}}
\DoxyCodeLine{00287\ }
\DoxyCodeLine{00292\ \textcolor{keywordtype}{bool}\ StbImageReader::}
\DoxyCodeLine{00293\ read\_pfm(\mbox{\hyperlink{classPfmFile}{PfmFile}}\ \&pfm)\ \{}
\DoxyCodeLine{00294\ \ \ \textcolor{keywordflow}{if}\ (!is\_valid())\ \{}
\DoxyCodeLine{00295\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00296\ \ \ \}}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \textcolor{comment}{//\ Reposition\ the\ file\ at\ the\ beginning.}}
\DoxyCodeLine{00299\ \ \ \textcolor{keywordflow}{if}\ (\_context.img\_buffer\_end\ ==\ \_context.img\_buffer\_original\_end)\ \{}
\DoxyCodeLine{00300\ \ \ \ \ \textcolor{comment}{//\ All\ we\ need\ to\ do\ is\ rewind\ the\ buffer.}}
\DoxyCodeLine{00301\ \ \ \ \ stbi\_\_rewind(\&\_context);}
\DoxyCodeLine{00302\ }
\DoxyCodeLine{00303\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ reinitialize\ the\ context.}}
\DoxyCodeLine{00305\ \ \ \ \ \_file-\/>seekg(0,\ ios::beg);}
\DoxyCodeLine{00306\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_file-\/>tellg()\ !=\ (std::streampos)0)\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \ \ pnmimage\_cat.error()}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ reposition\ file\ pointer\ to\ the\ beginning.\(\backslash\)n"{}};}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00310\ \ \ \ \ \}}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00312\ \ \ \ \ stbi\_\_start\_callbacks(\&\_context,\ \&io\_callbacks,\ (\textcolor{keywordtype}{void}\ *)\_file);}
\DoxyCodeLine{00313\ \ \ \}}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ nassertr(\_num\_channels\ ==\ 3,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00317\ \ \ \textcolor{comment}{//\ This\ next\ bit\ is\ copied\ and\ pasted\ from\ stbi\_\_hdr\_load\ so\ that\ we\ can}}
\DoxyCodeLine{00318\ \ \ \textcolor{comment}{//\ avoid\ making\ an\ unnecessary\ extra\ copy\ of\ the\ data.}}
\DoxyCodeLine{00319\ \ \ \textcolor{keywordtype}{char}\ buffer[STBI\_\_HDR\_BUFLEN];}
\DoxyCodeLine{00320\ \ \ \textcolor{keywordtype}{char}\ *token;}
\DoxyCodeLine{00321\ \ \ \textcolor{keywordtype}{int}\ valid\ =\ 0;}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordtype}{int}\ width,\ height;}
\DoxyCodeLine{00323\ \ \ stbi\_uc\ *scanline;}
\DoxyCodeLine{00324\ \ \ \textcolor{keywordtype}{int}\ len;}
\DoxyCodeLine{00325\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ count,\ value;}
\DoxyCodeLine{00326\ \ \ \textcolor{keywordtype}{int}\ i,\ j,\ k,\ c1,\ c2,\ z;}
\DoxyCodeLine{00327\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *headerToken;}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \ \ \textcolor{comment}{//\ Check\ identifier}}
\DoxyCodeLine{00330\ \ \ headerToken\ =\ stbi\_\_hdr\_gettoken(\&\_context,\ buffer);}
\DoxyCodeLine{00331\ \ \ \textcolor{keywordflow}{if}\ (strcmp(headerToken,\ \textcolor{stringliteral}{"{}\#?RADIANCE"{}})\ !=\ 0\ \&\&\ strcmp(headerToken,\ \textcolor{stringliteral}{"{}\#?RGBE"{}})\ !=\ 0)\ \{}
\DoxyCodeLine{00332\ \ \ \ \ pnmimage\_cat.error()}
\DoxyCodeLine{00333\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Missing\ \#?RADIANCE\ or\ \#?RGBE\ header.\(\backslash\)n"{}};}
\DoxyCodeLine{00334\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00335\ \ \ \}}
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ \ \ \textcolor{comment}{//\ Parse\ header}}
\DoxyCodeLine{00338\ \ \ \textcolor{keywordflow}{for}(;;)\ \{}
\DoxyCodeLine{00339\ \ \ \ \ token\ =\ stbi\_\_hdr\_gettoken(\&\_context,\ buffer);}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{keywordflow}{if}\ (token[0]\ ==\ 0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{keywordflow}{if}\ (strcmp(token,\ \textcolor{stringliteral}{"{}FORMAT=32-\/bit\_rle\_rgbe"{}})\ ==\ 0)\ valid\ =\ 1;}
\DoxyCodeLine{00342\ \ \ \}}
\DoxyCodeLine{00343\ }
\DoxyCodeLine{00344\ \ \ \textcolor{keywordflow}{if}\ (!valid)\ \{}
\DoxyCodeLine{00345\ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Unsupported\ HDR\ format.\(\backslash\)n"{}};}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00347\ \ \ \}}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \ \ \textcolor{comment}{//\ Parse\ width\ and\ height}}
\DoxyCodeLine{00350\ \ \ \textcolor{comment}{//\ can't\ use\ sscanf()\ if\ we're\ not\ using\ stdio!}}
\DoxyCodeLine{00351\ \ \ token\ =\ stbi\_\_hdr\_gettoken(\&\_context,\ buffer);}
\DoxyCodeLine{00352\ \ \ \textcolor{keywordflow}{if}\ (strncmp(token,\ \textcolor{stringliteral}{"{}-\/Y\ "{}},\ 3))\ \{}
\DoxyCodeLine{00353\ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Unsupported\ HDR\ data\ layout.\(\backslash\)n"{}};}
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00355\ \ \ \}}
\DoxyCodeLine{00356\ \ \ token\ +=\ 3;}
\DoxyCodeLine{00357\ \ \ height\ =\ (int)\ strtol(token,\ \&token,\ 10);}
\DoxyCodeLine{00358\ \ \ \textcolor{keywordflow}{while}\ (*token\ ==\ \textcolor{charliteral}{'\ '})\ ++token;}
\DoxyCodeLine{00359\ \ \ \textcolor{keywordflow}{if}\ (strncmp(token,\ \textcolor{stringliteral}{"{}+X\ "{}},\ 3))\ \{}
\DoxyCodeLine{00360\ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Unsupported\ HDR\ data\ layout.\(\backslash\)n"{}};}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00362\ \ \ \}}
\DoxyCodeLine{00363\ \ \ token\ +=\ 3;}
\DoxyCodeLine{00364\ \ \ width\ =\ (int)\ strtol(token,\ \textcolor{keyword}{nullptr},\ 10);}
\DoxyCodeLine{00365\ }
\DoxyCodeLine{00366\ \ \ \textcolor{comment}{//\ Read\ data}}
\DoxyCodeLine{00367\ \ \ pfm.clear(width,\ height,\ 3);}
\DoxyCodeLine{00368\ \ \ vector\_float\ table;}
\DoxyCodeLine{00369\ \ \ pfm.swap\_table(table);}
\DoxyCodeLine{00370\ \ \ \textcolor{keywordtype}{float}\ *hdr\_data\ =\ (\textcolor{keywordtype}{float}\ *)\&table[0];}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ \textcolor{comment}{//\ Load\ image\ data}}
\DoxyCodeLine{00373\ \ \ \textcolor{comment}{//\ image\ data\ is\ stored\ as\ some\ number\ of\ sca}}
\DoxyCodeLine{00374\ \ \ \textcolor{keywordflow}{if}\ (width\ <\ 8\ ||\ width\ >=\ 32768)\ \{}
\DoxyCodeLine{00375\ \ \ \ \ \textcolor{comment}{//\ Read\ flat\ data}}
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ height;\ ++j)\ \{}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ width;\ ++i)\ \{}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \ \ stbi\_uc\ rgbe[4];}
\DoxyCodeLine{00379\ main\_decode\_loop:}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ stbi\_\_getn(\&\_context,\ rgbe,\ 4);}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ stbi\_\_hdr\_convert(hdr\_data\ +\ j\ *\ width\ *\ 3\ +\ i\ *\ 3,\ rgbe,\ 3);}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00383\ \ \ \ \ \}}
\DoxyCodeLine{00384\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{comment}{//\ Read\ RLE-\/encoded\ data}}
\DoxyCodeLine{00386\ \ \ \ \ scanline\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{for}\ (j\ =\ 0;\ j\ <\ height;\ ++j)\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \ \ c1\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00390\ \ \ \ \ \ \ c2\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00391\ \ \ \ \ \ \ len\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00392\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c1\ !=\ 2\ ||\ c2\ !=\ 2\ ||\ (len\ \&\ 0x80))\ \{}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ not\ run-\/length\ encoded,\ so\ we\ have\ to\ actually\ use\ THIS\ data\ as\ a\ decoded}}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ pixel\ (note\ this\ can't\ be\ a\ valid\ pixel-\/-\/one\ of\ RGB\ must\ be\ >=\ 128)}}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \ \ stbi\_uc\ rgbe[4];}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ rgbe[0]\ =\ (stbi\_uc)\ c1;}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ rgbe[1]\ =\ (stbi\_uc)\ c2;}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \ \ rgbe[2]\ =\ (stbi\_uc)\ len;}
\DoxyCodeLine{00399\ \ \ \ \ \ \ \ \ rgbe[3]\ =\ (stbi\_uc)\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00400\ \ \ \ \ \ \ \ \ stbi\_\_hdr\_convert(hdr\_data,\ rgbe,\ 3);}
\DoxyCodeLine{00401\ \ \ \ \ \ \ \ \ i\ =\ 1;}
\DoxyCodeLine{00402\ \ \ \ \ \ \ \ \ j\ =\ 0;}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ STBI\_FREE(scanline);}
\DoxyCodeLine{00404\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{goto}\ main\_decode\_loop;\ \textcolor{comment}{//\ yes,\ this\ makes\ no\ sense}}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00406\ \ \ \ \ \ \ len\ <<=\ 8;}
\DoxyCodeLine{00407\ \ \ \ \ \ \ len\ |=\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (len\ !=\ width)\ \{}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Corrupt\ HDR:\ invalid\ decoded\ scanline\ length.\(\backslash\)n"{}};}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ STBI\_FREE(scanline);}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (scanline\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ scanline\ =\ (stbi\_uc\ *)\ stbi\_\_malloc\_mad2(width,\ 4,\ 0);}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!scanline)\ \{}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Out\ of\ memory\ while\ reading\ HDR\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \ \ STBI\_FREE(hdr\_data);}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00421\ }
\DoxyCodeLine{00422\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (k\ =\ 0;\ k\ <\ 4;\ ++k)\ \{}
\DoxyCodeLine{00423\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ nleft;}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \ \ i\ =\ 0;}
\DoxyCodeLine{00425\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ ((nleft\ =\ width\ -\/\ i)\ >\ 0)\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \ \ count\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (count\ >\ 128)\ \{}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Run}}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ \ \ \ \ value\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \ \ \ \ \ \ count\ -\/=\ 128;}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (count\ >\ nleft)\ \{}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Bad\ RLE\ data\ in\ HDR\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ STBI\_FREE(scanline);}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (z\ =\ 0;\ z\ <\ count;\ ++z)\ \{}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scanline[i++\ *\ 4\ +\ k]\ =\ value;}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Dump}}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (count\ >\ nleft)\ \{}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pnmimage\_cat.error()\ <<\ \textcolor{stringliteral}{"{}Bad\ RLE\ data\ in\ HDR\ file.\(\backslash\)n"{}};}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ STBI\_FREE(scanline);}
\DoxyCodeLine{00444\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (z\ =\ 0;\ z\ <\ count;\ ++z)\ \{}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scanline[i++\ *\ 4\ +\ k]\ =\ stbi\_\_get8(\&\_context);}
\DoxyCodeLine{00448\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00449\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00450\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ width;\ ++i)\ \{}
\DoxyCodeLine{00453\ \ \ \ \ \ \ \ \ stbi\_\_hdr\_convert(hdr\_data+(j*width\ +\ i)*3,\ scanline\ +\ i*4,\ 3);}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00455\ \ \ \ \ \}}
\DoxyCodeLine{00456\ \ \ \ \ \textcolor{keywordflow}{if}\ (scanline)\ \{}
\DoxyCodeLine{00457\ \ \ \ \ \ \ STBI\_FREE(scanline);}
\DoxyCodeLine{00458\ \ \ \ \ \}}
\DoxyCodeLine{00459\ \ \ \}}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \ \ pfm.swap\_table(table);}
\DoxyCodeLine{00462\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00463\ \}}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00474\ \textcolor{keywordtype}{int}\ StbImageReader::}
\DoxyCodeLine{00475\ read\_data(\mbox{\hyperlink{structpixel}{xel}}\ *array,\ xelval\ *alpha)\ \{}
\DoxyCodeLine{00476\ \ \ \textcolor{keywordflow}{if}\ (!is\_valid())\ \{}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00478\ \ \ \}}
\DoxyCodeLine{00479\ }
\DoxyCodeLine{00480\ \ \ \textcolor{comment}{//\ Reposition\ the\ file\ at\ the\ beginning.}}
\DoxyCodeLine{00481\ \ \ \textcolor{keywordflow}{if}\ (\_context.img\_buffer\_end\ ==\ \_context.img\_buffer\_original\_end)\ \{}
\DoxyCodeLine{00482\ \ \ \ \ \textcolor{comment}{//\ All\ we\ need\ to\ do\ is\ rewind\ the\ buffer.}}
\DoxyCodeLine{00483\ \ \ \ \ stbi\_\_rewind(\&\_context);}
\DoxyCodeLine{00484\ }
\DoxyCodeLine{00485\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00486\ \ \ \ \ \textcolor{comment}{//\ We\ need\ to\ reinitialize\ the\ context.}}
\DoxyCodeLine{00487\ \ \ \ \ \_file-\/>seekg(0,\ ios::beg);}
\DoxyCodeLine{00488\ \ \ \ \ \textcolor{keywordflow}{if}\ (\_file-\/>tellg()\ !=\ (std::streampos)0)\ \{}
\DoxyCodeLine{00489\ \ \ \ \ \ \ pnmimage\_cat.error()}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Could\ not\ reposition\ file\ pointer\ to\ the\ beginning.\(\backslash\)n"{}};}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00492\ \ \ \ \ \}}
\DoxyCodeLine{00493\ }
\DoxyCodeLine{00494\ \ \ \ \ stbi\_\_start\_callbacks(\&\_context,\ \&io\_callbacks,\ (\textcolor{keywordtype}{void}\ *)\_file);}
\DoxyCodeLine{00495\ \ \ \}}
\DoxyCodeLine{00496\ }
\DoxyCodeLine{00497\ \ \ \textcolor{keywordtype}{int}\ cols\ =\ 0;}
\DoxyCodeLine{00498\ \ \ \textcolor{keywordtype}{int}\ rows\ =\ 0;}
\DoxyCodeLine{00499\ \ \ \textcolor{keywordtype}{int}\ comp\ =\ \_num\_channels;}
\DoxyCodeLine{00500\ \ \ \textcolor{keywordtype}{void}\ *data;}
\DoxyCodeLine{00501\ \ \ \textcolor{keywordflow}{if}\ (\_maxval\ !=\ 65535)\ \{}
\DoxyCodeLine{00502\ \ \ \ \ data\ =\ stbi\_\_load\_and\_postprocess\_8bit(\&\_context,\ \&cols,\ \&rows,\ \&comp,\ \_num\_channels);}
\DoxyCodeLine{00503\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00504\ \ \ \ \ data\ =\ stbi\_\_load\_and\_postprocess\_16bit(\&\_context,\ \&cols,\ \&rows,\ \&comp,\ \_num\_channels);}
\DoxyCodeLine{00505\ \ \ \}}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ \textcolor{keywordflow}{if}\ (data\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00508\ \ \ \ \ pnmimage\_cat.error()}
\DoxyCodeLine{00509\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}stbi\_load\ failure:\ "{}}\ <<\ stbi\_failure\_reason()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00510\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00511\ \ \ \}}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \ \ nassertr(cols\ ==\ \_x\_size,\ 0);}
\DoxyCodeLine{00514\ \ \ nassertr(comp\ ==\ \_num\_channels,\ 0);}
\DoxyCodeLine{00515\ }
\DoxyCodeLine{00516\ \ \ \textcolor{keywordtype}{size\_t}\ pixels\ =\ (size\_t)\_x\_size\ *\ (\textcolor{keywordtype}{size\_t})rows;}
\DoxyCodeLine{00517\ \ \ \textcolor{keywordflow}{if}\ (\_maxval\ !=\ 65535)\ \{}
\DoxyCodeLine{00518\ \ \ \ \ uint8\_t\ *ptr\ =\ (uint8\_t\ *)data;}
\DoxyCodeLine{00519\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_num\_channels)\ \{}
\DoxyCodeLine{00520\ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[i],\ ptr[i],\ ptr[i]);}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[0],\ ptr[0],\ ptr[0]);}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ alpha[i]\ =\ ptr[1];}
\DoxyCodeLine{00530\ \ \ \ \ \ \ \ \ ptr\ +=\ 2;}
\DoxyCodeLine{00531\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00532\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \ \ \ \ \textcolor{keywordflow}{case}\ 3:}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[0],\ ptr[1],\ ptr[2]);}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ ptr\ +=\ 3;}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00540\ }
\DoxyCodeLine{00541\ \ \ \ \ \textcolor{keywordflow}{case}\ 4:}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[0],\ ptr[1],\ ptr[2]);}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ alpha[i]\ =\ ptr[3];}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ ptr\ +=\ 4;}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00548\ \ \ \ \ \}}
\DoxyCodeLine{00549\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00550\ \ \ \ \ uint16\_t\ *ptr\ =\ (uint16\_t\ *)data;}
\DoxyCodeLine{00551\ \ \ \ \ \textcolor{keywordflow}{switch}\ (\_num\_channels)\ \{}
\DoxyCodeLine{00552\ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[i],\ ptr[i],\ ptr[i]);}
\DoxyCodeLine{00555\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00557\ }
\DoxyCodeLine{00558\ \ \ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[0],\ ptr[0],\ ptr[0]);}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ alpha[i]\ =\ ptr[1];}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ ptr\ +=\ 2;}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00565\ }
\DoxyCodeLine{00566\ \ \ \ \ \textcolor{keywordflow}{case}\ 3:}
\DoxyCodeLine{00567\ \ \ \ \ \ \ memcpy(array,\ ptr,\ pixels\ *\ \textcolor{keyword}{sizeof}(uint16\_t)\ *\ 3);}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ \ \ \textcolor{keywordflow}{case}\ 4:}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ pixels;\ ++i)\ \{}
\DoxyCodeLine{00572\ \ \ \ \ \ \ \ \ PPM\_ASSIGN(array[i],\ ptr[0],\ ptr[1],\ ptr[2]);}
\DoxyCodeLine{00573\ \ \ \ \ \ \ \ \ alpha[i]\ =\ ptr[3];}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ ptr\ +=\ 4;}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00577\ \ \ \ \ \}}
\DoxyCodeLine{00578\ \ \ \}}
\DoxyCodeLine{00579\ }
\DoxyCodeLine{00580\ \ \ stbi\_image\_free(data);}
\DoxyCodeLine{00581\ \ \ \textcolor{keywordflow}{return}\ rows;}
\DoxyCodeLine{00582\ \}}
\DoxyCodeLine{00583\ }
\DoxyCodeLine{00587\ \textcolor{keywordtype}{void}\ PNMFileTypeStbImage::}
\DoxyCodeLine{00588\ register\_with\_read\_factory()\ \{}
\DoxyCodeLine{00589\ \ \ BamReader::get\_factory()-\/>}
\DoxyCodeLine{00590\ \ \ \ \ register\_factory(get\_class\_type(),\ make\_from\_bam);}
\DoxyCodeLine{00591\ \}}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00601\ \mbox{\hyperlink{classTypedWritable}{TypedWritable}}\ *PNMFileTypeStbImage::}
\DoxyCodeLine{00602\ make\_from\_bam(\textcolor{keyword}{const}\ \mbox{\hyperlink{classFactoryParams}{FactoryParams}}\ \&params)\ \{}
\DoxyCodeLine{00603\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classPNMFileTypeRegistry_a83617b215ff0b0482e86e463b43f22cf}{PNMFileTypeRegistry::get\_global\_ptr}}()-\/>\mbox{\hyperlink{classPNMFileTypeRegistry_a77cfb63495edef614b8ebf0c0d501843}{get\_type\_by\_handle}}(get\_class\_type());}
\DoxyCodeLine{00604\ \}}
\DoxyCodeLine{00605\ }
\DoxyCodeLine{00606\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ HAVE\_STB\_IMAGE}}

\end{DoxyCode}
